[
    {
        "id": "8ea344595d9a442a",
        "type": "tab",
        "label": "Main",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "b5ae94617e862de8",
        "type": "tab",
        "label": "Systembruger data",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "41d1b8798efe7e15",
        "type": "subflow",
        "name": "PupController",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 220,
                "y": 440,
                "wires": [
                    {
                        "id": "5aa16189aff2b4c3"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1720,
                "y": 340,
                "wires": [
                    {
                        "id": "cb4ea3ccf7541c86",
                        "port": 1
                    }
                ]
            },
            {
                "x": 1920,
                "y": 440,
                "wires": [
                    {
                        "id": "5935cece6c345653",
                        "port": 1
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "4689d5530a08a735",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "fill": "#addb7b",
            "label": true
        },
        "nodes": [
            "6c9c15c3a64af0ef"
        ],
        "x": 2634,
        "y": 239,
        "w": 212,
        "h": 82
    },
    {
        "id": "7de50fe1369c94a7",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "fill": "#ffffbf",
            "label": true,
            "fill-opacity": "0.67"
        },
        "nodes": [
            "9ae5a9e08a7d7dc3",
            "64156b428449f87a",
            "8b4e8bc5facd8f90"
        ],
        "x": 574,
        "y": 139,
        "w": 322,
        "h": 122
    },
    {
        "id": "27007b43e1b2750d",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "fill": "#e3f3d3",
            "label": true,
            "fill-opacity": "0.67"
        },
        "nodes": [
            "99963e2324c780db",
            "33dd3ef7921a86d1",
            "4d958ad66bc2e40d",
            "99f176272982a073",
            "a0a742c5ef2820f9",
            "2c5bfa6b7a2613ab",
            "df4e89fda20fa7db",
            "6dfadfada71732b7",
            "c0efbe2a4fc25ff6"
        ],
        "x": 934,
        "y": 39,
        "w": 672,
        "h": 222
    },
    {
        "id": "669e09e244099963",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "stroke": "#777777",
            "label": true,
            "fill": "#bfdbef",
            "fill-opacity": "0.67"
        },
        "nodes": [
            "28d8ac05e7f0f65f",
            "bc7b13ac2323540b",
            "4003aad4b2b6a9c8",
            "fa861baf7265d3be",
            "8bc31d06862e8fe2",
            "d5a462980f4852cf",
            "07d87534c4e0bbea",
            "c931f08e3a54e2f2",
            "6558b47eb74e6c0c",
            "569d9f497b06babc",
            "144d6812d5213472",
            "6a7f540f9f08ded4",
            "bb143ed21df0febf",
            "07aa032e7944f93b",
            "15a1703b4a5286c7",
            "d97f7bbbe0210f54",
            "5e6c62c7505cca22",
            "90acc4726c72125a"
        ],
        "x": 634,
        "y": 299,
        "w": 1452,
        "h": 187
    },
    {
        "id": "9c4f3569ebca5f7b",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "fill": "#bfc7d7",
            "fill-opacity": "0.67",
            "label": true
        },
        "nodes": [
            "bc99d7022f61a990",
            "d183f106c2e11bce",
            "c2df29c07624e5e0",
            "c8857f0a61f8c92e",
            "0df1e3c807393a69",
            "573bc9a19cb2a144",
            "70ade91971d73d3b",
            "81a00971b2ea464e",
            "3691fee0bd5cd7bc",
            "5c03893a530479bb",
            "86c8180e0274bc8b",
            "402de4b110655edc",
            "172fe34eeccca8dd",
            "f7835ac1742b0168"
        ],
        "x": 694,
        "y": 519,
        "w": 1172,
        "h": 222
    },
    {
        "id": "becf3086d0307883",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 320,
        "y": 320,
        "wires": [
            [
                "e9617e47af67aef2"
            ]
        ]
    },
    {
        "id": "114ab13434d5aba2",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 1440,
        "y": 1940,
        "wires": [
            [
                "78a498d6a82a151b"
            ]
        ]
    },
    {
        "id": "d97f7bbbe0210f54",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "x": 940,
        "y": 460,
        "wires": [
            [
                "90acc4726c72125a"
            ]
        ]
    },
    {
        "id": "172fe34eeccca8dd",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "x": 1840,
        "y": 660,
        "wires": [
            [
                "c9e0c48929946d68"
            ]
        ]
    },
    {
        "id": "90acc4726c72125a",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "x": 1500,
        "y": 460,
        "wires": [
            [
                "4003aad4b2b6a9c8"
            ]
        ]
    },
    {
        "id": "a567f42879c1f449",
        "type": "mqtt-broker",
        "name": "",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "6e63b3c396c75d87",
        "type": "websocket-listener",
        "path": "/ws/pup",
        "wholemsg": "true"
    },
    {
        "id": "c1ae0d59916344e0",
        "type": "websocket-listener",
        "path": "ws/rules",
        "wholemsg": "false"
    },
    {
        "id": "13a90a014adf9bc5",
        "type": "websocket-listener",
        "path": "/ws/worklet",
        "wholemsg": "false"
    },
    {
        "id": "b93057423dbab117",
        "type": "http in",
        "z": "41d1b8798efe7e15",
        "name": "",
        "url": "/pup",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 160,
        "wires": [
            [
                "f38a2efe43edd64e"
            ]
        ]
    },
    {
        "id": "5c5841605bcac134",
        "type": "http response",
        "z": "41d1b8798efe7e15",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1130,
        "y": 160,
        "wires": []
    },
    {
        "id": "f8ccfed64d837464",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Set URL",
        "info": "",
        "x": 400,
        "y": 120,
        "wires": []
    },
    {
        "id": "5b841495c9c84c66",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Host website",
        "info": "",
        "x": 150,
        "y": 120,
        "wires": []
    },
    {
        "id": "f38a2efe43edd64e",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "url = /pup",
        "rules": [
            {
                "t": "set",
                "p": "url",
                "pt": "msg",
                "to": "pup",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 400,
        "y": 160,
        "wires": [
            [
                "e271c933dcfb52c5"
            ]
        ]
    },
    {
        "id": "8646ac73ab639fcd",
        "type": "http in",
        "z": "41d1b8798efe7e15",
        "name": "",
        "url": "/puprun",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 340,
        "wires": [
            [
                "0fa8b45a3aec3fd5"
            ]
        ]
    },
    {
        "id": "d68baf48942491dd",
        "type": "switch",
        "z": "41d1b8798efe7e15",
        "name": "browser == null?",
        "property": "pupController.browser",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 340,
        "wires": [
            [
                "274738f45a0d5d5a"
            ],
            [
                "1a32f920705bb1bc"
            ]
        ]
    },
    {
        "id": "274738f45a0d5d5a",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "pupController",
                "pt": "msg",
                "to": "{\t    \"pages\": [],\t    \"commands\": payload\t}",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "pupCount",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1120,
        "y": 320,
        "wires": [
            [
                "1a32f920705bb1bc"
            ]
        ]
    },
    {
        "id": "1a32f920705bb1bc",
        "type": "function",
        "z": "41d1b8798efe7e15",
        "name": "Initialize?",
        "func": "const pup = global.get('puppeteer');\n(async () => {\n\n    var commands = msg.pupController.commands;\n\n    for (let i = 0; i < commands.length; i++)\n    {\n        const e = commands[i];\n\n        if (msg.pupController.browser == null && e.action == \"launch\")\n        {\n            msg.pupController.browser = await pup.launch(e.parameters);\n            msg.pupController.browserWS = await msg.pupController.browser.wsEndpoint();\n            //await NewPage(e.name != null ? e.name : \"main\");\n            await AddInitialPage(e.name != null ? e.name : \"initial\");\n        }\n\n        else if(e.action == \"newtab\")\n            await NewPage(e.name);\n    }\n\n    if(msg.pupController.browser == null)\n    {\n        msg.pupController.browser = await pup.launch({});\n        msg.pupController.browserWS = await msg.pupController.browser.wsEndpoint();\n    }\n\n    msg.pupController.activePage = 0; //((await (msg.pupController.browser.pages()).length) - 1);\n    /*\n    {\n        \"page\": (await msg.pupController.browser.pages())[(await msg.pupController.browser.pages()).length - 1],\n        \"po\":msg.pupController.pages[msg.pupController.pages.length - 1]\n    }*/\n    node.send(msg);\n})();\n\nasync function NewPage(name) {\n    const newPage = await msg.pupController.browser.newPage();\n    const id = (await msg.pupController.browser.pages()).length - 1;\n    const url = await newPage.url();\n    msg.pupController.pages.push(\n        {\n            \"name\": name,\n            \"id\": id,\n            \"url\": url\n        });\n}\n\nasync function AddInitialPage(name = \"initial\")\n{\n    const page = (await msg.pupController.browser.pages())[0];\n    const url = await page.url();\n    msg.pupController.pages.push(\n        {\n            \"name\": name,\n            \"id\": 0,\n            \"url\": url\n        });\n}\n\n/*\nasync function LaunchBrowser(e)\n{\n    const browser = await pup.launch(e.parameters);\n    return browser.wsEndpoint();\n}\n*/",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1140,
        "y": 380,
        "wires": [
            [
                "580a9e3166314a22"
            ]
        ]
    },
    {
        "id": "580a9e3166314a22",
        "type": "function",
        "z": "41d1b8798efe7e15",
        "name": "Solo Controller",
        "func": "const pup = global.get('puppeteer');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\n\nvar actions = [];\n//var outputs = [];\nvar outputs = {};\n\nconst timeoutMs = 10000;\n\n(async () => {\n\n    const actionList = msg.payload;\n    var actionPerformed;\n\n    for (let i = 0; i < actionList.length; i++) {\n        \n        try {\n            const browser = await pup.connect({ \"browserWSEndpoint\": msg.pupController.browserWS })\n            const page = (await browser.pages())[msg.pupController.activePage];\n            //page.setDefaultNavigationTimeout(10000);\n\n            var ele = actionList[i];\n            const action = ele.action;\n\n            await page.waitForNetworkIdle();\n\n            switch (action)\n            {\n                case \"launch\":\n                case \"newtab\":\n                    break;\n\n                case \"goto\":\n                    if (ele.url != null)\n                        await page.goto(ele.url, { waitUntil: 'load', timeout: timeoutMs });\n                    else\n                        actionPerformed = ReportError(ele, \"Error: URL was lost\");\n                    break;\n\n                case \"click\":\n                    if(ele.isDownload == true || ele.isDownload == \"true\")\n                        setDownloadBehavior(page);\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    await page.click(ele.path, (ele.parameters != null ? ele.parameters : {}));\n                    if (ele.isDownload == true || ele.isDownload == \"true\")\n                        await page.waitForNetworkIdle();\n                    break;\n\n                case \"type\":\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    if (ele.clear == true || ele.clearInput == true || ele.clear == \"true\" || ele.clearInput == \"true\")\n                        await page.click(ele.path, { clickCount: 3 });\n                    await page.type(ele.path, ele.input);\n                    break;\n\n                case \"select\":\n                    let elemHandler = await page.$(ele.path);\n                    let properties = await elemHandler.getProperties();\n                    for (const property of properties.values()) {\n                        const element = property.asElement();\n                        if (element) {\n                            let hText = await element.getProperty(\"text\");\n                            let text = await hText.jsonValue();\n                            if (text === ele.input) {\n                                let hValue = await element.getProperty(\"value\");\n                                let value = await hValue.jsonValue();\n                                await page.select(ele.path, value); // or use 58730\n                                console.log(`Selected ${text} which is value ${value}.`);\n                            }\n                        }\n                    }\n/*\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    await page.select(ele.path, ele.input);*/\n                    break;\n\n\n                case \"get\":\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    var content = await page.$eval(ele.path, el => el.innerText);\n                    ele.output = actionList[i].output = content;\n                    break;\n\n                case \"wait\":\n                    if(ele.ms != null)\n                        await wait(ele.ms);\n                    break;\n\n                case \"close\":\n                    await browser.close();\n                    msg.pupController.browser = null;\n                    msg.pupController.pages = null;\n                    break;\n            }\n\n            ele.succesful = true;\n            actionPerformed = ReportAction(ele);\n            node.send([null, actionPerformed]);\n\n            //if(i == actionList.length-1 && action != \"close\")\n            //    await browser.close();\n            \n            \n        }\n        catch (e)\n        {\n            console.log(\"PupController error: \" + JSON.stringify(e));\n            //node.error(\"Error:\", e);\n            actionList[i].succesful = false;\n            actionPerformed = ReportError(actionList[i], e);\n            node.send([null, actionPerformed]);\n\n            /*if (i == actionList.length - 1 && actionList[i] != \"close\")\n                await pup.connect({ \"browserWSEndpoint\": msg.pupController.browserWS }).then(browser => browser.close());\n                //await browser.close();*/\n        }\n\n    }\n\n    msg.pupOutputs = outputs;\n    node.send([msg, null]);\n})();\n\nasync function wait(_ms)\n{\n    let promise = new Promise((resolve, reject) => {\n        setTimeout(() => resolve(\"done!\"), _ms)\n    });\n    let result = await promise; // wait until the promise resolves (*)\n    //alert(result); // \"done!\"\n}\n\nfunction ReportAction(a, s = true)\n{\n    var newAction;\n    actions.push(newAction = {\n        \"action\": a.action,\n        \"succesful\": s,\n        \"obj\": a\n    });\n\n    if(a.output != null)\n    {\n        var outputName = a.name;\n        var outputObj = a.obj;\n\n        if(outputObj != null && outputObj != \"\")\n        {\n            outputs[outputObj] = outputs[outputObj] == null ? {} : outputs[outputObj];\n            outputs[outputObj][outputName] = a.output;\n        }\n        else\n            outputs[outputName] = a.output;\n        /*\n        outputs.push({\n            \"name\": a.name,\n            \"value\": a.output\n        });*/\n    }\n    return newAction;\n}\n\nfunction ReportError(a, e)\n{\n    console.log(e);\n    var newAction;\n    actions.push(newAction = {\n        \"action\": a,\n        \"succesful\": false,\n        \"error\": e,\n        \"obj\": a\n    });\n    return newAction;\n}\n\nasync function setDownloadBehavior(page) {\n    const client = await page.target().createCDPSession();\n    await client.send('Page.setDownloadBehavior', {\n        behavior: 'allow',\n        downloadPath: downloadPath\n    });\n}\n\n\n\n\n\n\n/*\n(async () => {\n    if (msg.command.url != null)\n        try {\n            //const browser = await pup.connect({ \"browserWSEndpoint\": msg.pupController.browserWS })\n            const browser = await pup.connect({ \"browserWSEndpoint\": msg.browserWS })\n            //const page = (await browser.pages())[msg.pupController.activePage];\n            const page = (await browser.pages())[msg.activePage];\n\n            await page.waitForNetworkIdle();\n            await page.goto(msg.command.url);\n            msg.succesful = true;\n\n        }\n        catch (e) {\n            console.log(e);\n            msg.succesful = false;\n            msg.error = e;\n        }\n    else {\n        msg.succesful = false;\n        msg.error = \"Error: URL was null\";\n        console.log(msg.error);\n    }\n\n    node.send(msg);\n})();\n*/",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1340,
        "y": 360,
        "wires": [
            [
                "cb4ea3ccf7541c86",
                "668e1ae3f9c4ccf8"
            ],
            [
                "2fd098a8190ef089"
            ]
        ]
    },
    {
        "id": "fa696e728e31ff49",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Start flow from web",
        "info": "",
        "x": 170,
        "y": 300,
        "wires": []
    },
    {
        "id": "a0f636581c44be9d",
        "type": "debug",
        "z": "41d1b8798efe7e15",
        "name": "Command Executed",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1620,
        "y": 500,
        "wires": []
    },
    {
        "id": "69738f2e4dcc6f63",
        "type": "http response",
        "z": "41d1b8798efe7e15",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1750,
        "y": 300,
        "wires": []
    },
    {
        "id": "668e1ae3f9c4ccf8",
        "type": "debug",
        "z": "41d1b8798efe7e15",
        "name": "All Commands Executed",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1630,
        "y": 240,
        "wires": []
    },
    {
        "id": "2fd098a8190ef089",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "pupid",
                "pt": "msg",
                "to": "pupCount",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "pupCount",
                "pt": "flow",
                "to": "msg.pupid+1",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1600,
        "y": 420,
        "wires": [
            [
                "5935cece6c345653"
            ]
        ]
    },
    {
        "id": "8020507bdd5939ba",
        "type": "websocket out",
        "z": "41d1b8798efe7e15",
        "name": "",
        "server": "6e63b3c396c75d87",
        "client": "",
        "x": 1970,
        "y": 400,
        "wires": []
    },
    {
        "id": "9da2cdfaa3c63d2e",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Set JavaScript",
        "info": "",
        "x": 650,
        "y": 120,
        "wires": []
    },
    {
        "id": "3d490b929251bc8a",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Start flow from flow",
        "info": "",
        "x": 170,
        "y": 400,
        "wires": []
    },
    {
        "id": "8ce8fe7e4e9fd6a5",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Endpoint",
        "info": "",
        "x": 1140,
        "y": 120,
        "wires": []
    },
    {
        "id": "30cc309628e939bc",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Check instance",
        "info": "",
        "x": 900,
        "y": 300,
        "wires": []
    },
    {
        "id": "6553bd482e86e7cd",
        "type": "function",
        "z": "41d1b8798efe7e15",
        "name": "CSS Selector Parser",
        "func": "for (let i = 0; i < msg.payload.length; i++) {\n    const e = msg.payload[i];\n\n    if(e.element != null)\n        e.path = CreatePath(e.element);\n    //DebugElement(e.element);\n    \n}\n\nfunction DebugElement(element)\n{\n    msg.test.push(element);\n}\n\nfunction CreatePath(element)\n{\n    if(element.path != null)\n        element.path;\n\n    var path = element.type == null ? \"\" : element.type;\n\n    if(element.parent != null && element.within != null)\n        ReportError({\n            \"error\": \"Both parent and within values set for element\",\n            \"element\": element\n        });\n\n    if(element.class != null)\n        path = path + \".\" + element.class;\n\n        if (element.classContains != null)\n            path = path + \"[class*='\" + element.classContains + \"']\";\n\n        if (element.classStartsWith != null)\n            path = path + \"[class^='\" + element.classStartsWith + \"']\";\n\n    if (element.id != null)\n        path = path + \"[id='\" + element.id + \"']\";\n\n        if(element.idContains != null)\n            path = path + \"[id*='\" + element.idContains + \"']\";\n\n        if (element.idStartsWith != null)\n            path = path + \"[id^='\" + element.idStartsWith + \"']\";\n\n    if (element.name != null)\n        path = path + \"[name='\" + element.name + \"']\";\n\n    if (element.src != null)\n        path = path + \"[src='\" + element.src + \"']\";\n\n    if (element.innerHTML != null)\n        path = path + \"[innerHTML='\" + element.innerHTML + \"']\";\n\n    // Check parent + within\n\n    if(element.parent != null)\n        path = CreatePath(element.parent) + \" > \" + path;\n    \n    else if (element.within != null)\n        path = CreatePath(element.within) + \" \" + path;\n\n    return path;\n}\n\nfunction ReportError(error)\n{\n    msg.error = error;\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 340,
        "wires": [
            [
                "d68baf48942491dd"
            ]
        ]
    },
    {
        "id": "5b02768458131405",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Create CSS selectors",
        "info": "",
        "x": 680,
        "y": 300,
        "wires": []
    },
    {
        "id": "0fa8b45a3aec3fd5",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "isWebCommand = true",
        "rules": [
            {
                "t": "set",
                "p": "isWebCommand",
                "pt": "flow",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 380,
        "y": 340,
        "wires": [
            [
                "6553bd482e86e7cd"
            ]
        ]
    },
    {
        "id": "5aa16189aff2b4c3",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "isWebCommand = false",
        "rules": [
            {
                "t": "set",
                "p": "isWebCommand",
                "pt": "flow",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 390,
        "y": 440,
        "wires": [
            [
                "6553bd482e86e7cd"
            ]
        ]
    },
    {
        "id": "5935cece6c345653",
        "type": "switch",
        "z": "41d1b8798efe7e15",
        "name": "",
        "property": "isWebCommand",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "jsonata"
            },
            {
                "t": "eq",
                "v": "false",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1770,
        "y": 420,
        "wires": [
            [
                "8020507bdd5939ba"
            ],
            []
        ]
    },
    {
        "id": "cb4ea3ccf7541c86",
        "type": "switch",
        "z": "41d1b8798efe7e15",
        "name": "",
        "property": "isWebCommand",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "jsonata"
            },
            {
                "t": "eq",
                "v": "false",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1570,
        "y": 320,
        "wires": [
            [
                "69738f2e4dcc6f63"
            ],
            []
        ]
    },
    {
        "id": "9b6f2743d9f9c4c2",
        "type": "catch",
        "z": "41d1b8798efe7e15",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 200,
        "y": 660,
        "wires": [
            [
                "9eb94ead2cba83a2"
            ]
        ]
    },
    {
        "id": "9eb94ead2cba83a2",
        "type": "debug",
        "z": "41d1b8798efe7e15",
        "name": "PupError",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 340,
        "y": 660,
        "wires": []
    },
    {
        "id": "e271c933dcfb52c5",
        "type": "template",
        "z": "41d1b8798efe7e15",
        "name": "Script",
        "field": "payload.script",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "plain",
        "template": "/////////////\n/// #0 : Action definitions\n////////////\n\nfunction actionList() {\n    return [\n        {\n            \"action\": \"launch\",\n            \"parameters\":\n            {\n                \"headless\": false,\n                \"slowMo\": 50,\n                \"ignoreHTTPSErrors\": true,\n                \"defaultViewport\": null\n            }\n        },\n        {\n            \"action\": \"goto\",\n            \"url\": \"\"\n        },\n        {\n            \"action\": \"click\",\n            \"path\": \"\",\n            \"parameters\":\n            {\n                \"clickCount\": 1\n            }\n        },\n        {\n            \"action\": \"type\",\n            \"input\": \"\",\n            \"path\": \"\"\n        },\n        {\n            \"action\": \"select\",\n            \"path\": \"\",\n            \"input\": \"\"\n        },\n        {\n            \"action\": \"get\",\n            \"name\": \"\",\n            \"path\": \"\"\n        },\n        {\n            \"action\": \"wait\",\n            \"ms\": 1000\n        },\n        {\n            \"action\": \"close\"\n        }\n    ];\n};\n\n\n/////////////\n/// #1 : Start ()\n////////////\n\nconst commandList = document.querySelector(\".commandList\"),\n    controls = document.querySelector(\".controls\"),\n\n    cmdInput = document.querySelector(\".cmd\"),\n    textarea = document.querySelector('.textarea'),\n    lineNumbers = document.querySelector('.line-numbers');\n\nconst storageName = \"pupControl_JSON_commandGen\";\n\n// Define + get commands from SQLite\n\nlet commands = [];\n\ntry {\n    commands = JSON.parse(localStorage.getItem(storageName));\n}\ncatch {\n    console.log(\"Found command list, but corrupt:\\n\" + localStorage.getItem(storageName));\n}\n\nShowCommandList();\nUpdateJSON();\n\n// Create pseudo enum \"actionKeys\" -> usage to get full object: actionList()[actionKeys[\"launch\"]]\n\nlet _actionKeys = [];\nfor (let i = 0; i < actionList().length; i++)\n    _actionKeys[actionList()[i].action] = i;\n\nconst actionKeys = _actionKeys;\n\n// Function to create IDs for query selection of buttons\n\nfunction GetElementIdFromAction(actionObject) { return \"buttonAdd_\" + actionObject.action.replace(\" \", \"\"); }  // Example ID: buttonAdd_launch\n\n// Dynamically instantiate buttons for action objects\n\nfor (let i = 0; i < actionList().length; i++)\n    controls.innerHTML += `\n        <button class=\"button active\" id=\"${GetElementIdFromAction(actionList()[i])}\">${actionList()[i].action}</button>\n    `;\n\n// Dynamically create query selectors for action object buttons\n\nlet _buttonAdd = [];\nfor (let i = 0; i < actionList().length; i++)\n    _buttonAdd[actionList()[i].action] = document.querySelector(\".button#\" + GetElementIdFromAction(actionList()[i]));\n\nconst buttonAdd = _buttonAdd;\n\n// and add event listeners\n\nfor (let i = 0; i < actionList().length; i++)\n    buttonAdd[actionList()[i].action].addEventListener(\"click\", () => {\n        AddCommand(actionList()[i]);\n    });\n\n\n\n\n\n\n/////////////\n/// #2 : Data manipulation\n////////////\n\n///\n// Add command\n\nlet variableCount = 0;\nfunction AddCommand(actionObject) {\n\n    //console.log(\"Received action object: \\n\" + JSON.stringify(actionObject));\n\n    //console.log(\"Full action list: \" + JSON.stringify(actionList));\n\n    // Check if command is of valid type\n    if (!IsValidType(actionObject.action)) {\n        console.log(\"Failed to add command of unknown type `\" + actionObject.action + \"`\");\n        return;\n    }\n\n    // Check if a command array already exists, otherwise define it\n    commands = !commands ? [] : commands;\n\n    // Create initial command object\n    let clone = {}; // the new empty object\n\n    // let's copy all action properties into it\n    for (let key in actionObject) {\n        clone[key] = actionObject[key];\n    }\n    const command = clone;\n\n    // Push new command to list, and store JSON\n    commands.push(command);\n\n    StoreAndUpdateJSON();\n}\n\n// Function to check if type is valid\nfunction IsValidType(type) {\n    return !(actionKeys[type] == null);\n}\n\n// HTTP encode + add https if missing\nfunction ReturnUrl(url) {\n    var newUrl = encodeURIComponent(url);\n    if (!(url.includes(\"https://\") || url.includes(\"http://\")))\n        newUrl = \"https://\" + newUrl;\n    return newUrl;\n}\n\n// Selector generator from string\nfunction GenerateSelector(parameters) {\n    var multipleParameters = parameters.trim().split(' ');\n    var path = multipleParameters[0];\n    if (multipleParameters.length == 1)\n        return path;\n\n    for (let i = 1; i < multipleParameters.length; i++) {\n        let _c = multipleParameters[i];\n        var insideBrackets = _c.includes('[');\n\n        let attrSplit = _c.split('=');\n        if (!insideBrackets && attrSplit.length == 2) {\n            let attr = (_c.split('='))[0];\n            let value = (_c.split('='))[1];\n            path += '[' + attr + '=\"' + value + '\"]';\n        }\n        else\n            path += \" \" + _c;\n    }\n    return path;\n}\n\n// Receive update variable command from event\nfunction UpdateCommandVar(inputField) {\n\n    // Get ID of input field to determine which value to update\n    let id = inputField.id;\n    let s = id.split('_');\n\n    // Example ID: obj_attr\n    let _id = s[1];\n    var _attr = s[2];\n    if (s.length > 3)\n        _attr += \".\" + s[3];\n\n    UpdateCommandValue(_attr, inputField.value, _id);\n}\n\n// Update and store the change\nfunction UpdateCommandValue(attr, value, commandId) {\n\n    if (attr == \"path\")\n        value = GenerateSelector(value);\n\n    // Parse if float or int (ignore if \"path\" or \"input\")\n    if (attr != \"path\" && attr != \"\") //  <- HARD CODE :(\n    {\n        if (value.includes(\".\") || value.includes(\",\")) {\n            // Is float?\n            let _value = value.replace(\",\", \".\");\n            const parsed = parseFloat(_value);\n            if (!isNaN(parsed))\n                value = parsed;\n        }\n        else {\n            // Is int?\n            const parsed = parseInt(value);\n            if (!isNaN(parsed))\n                value = parsed;\n        }\n\n        // Parse if boolean or null\n        if (value === \"true\") value = true;\n        if (value === \"false\") value = false;\n        if (value === \"null\") value = null;\n    }\n\n\n    if (attr.includes('.')) {\n        let s = attr.split(\".\");\n\n        console.log(\"Updating attr \" + attr + \" from value \" + ((commands[commandId])[s[0]])[s[1]] + \" to value \" + value + \" (id: \" + commandId + \")\");\n\n        //if (((commands[commandId])[s[0]])[s[1]] != undefined)\n        ((commands[commandId])[s[0]])[s[1]] = value;\n\n\n    }\n    else {\n        console.log(\"Updating attr \" + attr + \" from value \" + (commands[commandId])[attr] + \" to value \" + value + \" (id: \" + commandId + \")\");\n\n        //if ((commands[commandId])[attr] != undefined)\n        (commands[commandId])[attr] = value;\n\n    }\n\n    StoreAndUpdateJSON();\n}\n\n// Additional functions\n\nfunction ClearAllCommands() {\n    commands.splice(0, commands.length);\n    StoreAndUpdateJSON();\n}\n\nfunction DeleteCommand(deleteId) {\n    commands.splice(deleteId, 1);\n    StoreAndUpdateJSON();\n}\n\nfunction CopyCommand(copyId) {\n    let command = commands[copyId];\n    commands.push(command);\n    StoreAndUpdateJSON();\n}\n\n///\n// STORE DATA / UPDATE JSON\n\nfunction StoreAndUpdateJSON(_text = null) {\n\n    // Function is used with _text parameter when called from textarea event listener\n    let text = UpdateJSON(_text);\n\n    if (text != null)\n        localStorage.setItem(storageName, text);\n\n    ShowCommandList();\n}\n\nfunction UpdateJSON(_text = null) {\n\n    var text = null;\n\n    if (_text == null) {\n        text = JSON.stringify(commands);\n        SetTextareaText(text);\n    }\n\n    else {\n\n        var _parsed = null;\n        try { _parsed = JSON.parse(_text) }\n        catch { }\n        //console.log(\"Updating JSON from textarea!\");\n        //console.log(_parsed);\n        if (_parsed != null) {\n            commands = _parsed;\n            text = JSON.stringify(commands);\n        }\n\n    }\n\n    SetTextareLineNumbers();\n    return text;\n}\n\n\n\n\n\n\n\n\n\n/////////////\n/// #3 : Visual manipulation\n////////////\n\nfunction ShowCommandList() {\n    let liTag = \"\";\n\n    // Check if command list exists and is populated\n    if (commands) {\n        commands.forEach((command, id) => {\n            liTag += PrintCommand(command, id);\n        });\n    }\n\n    // Base text - if no commands exists\n    commandList.innerHTML = liTag || `<span>Start by adding a <b>Launch</b> command</span>`;\n\n    // Add event listeners to all input fields in tasks\n    var inputFields = document.querySelectorAll('.task input');\n    for (var i = 0; i < inputFields.length; i++) {\n\n        // Update the command that has been changed on focusout, and resize input field to match content\n        inputFields[i].addEventListener('focusout', function (event) {\n            UpdateCommandVar(event.target);\n            ResizeInputToFit(event.target.id);\n        }, false);\n\n        inputFields[i].addEventListener('keyup', function (event) {\n            // Also resize on key-up\n            ResizeInputToFit(event.target.id);\n        }, false);\n\n        // Also resize immediately to match loaded content\n        ResizeInputToFit(inputFields[i].id);\n    }\n}\n\n// Show bulletin menu for each action in list (with copy / delete options)\nfunction ShowBulletinMenu(selectedTask) {\n    let menuDiv = selectedTask.parentElement.lastElementChild;\n    menuDiv.classList.add(\"show\");\n    document.addEventListener(\"click\", e => {\n        if (e.target.tagName != \"I\" || e.target != selectedTask)\n            menuDiv.classList.remove(\"show\");\n    });\n}\n\n///\n// PRINT COMMAND\n///\nfunction PrintCommand(command, id) {\n\n    var commandName = command.action == \"goto\" ? \"go to\" : command.action;\n\n    var returnStr = \"\";\n    returnStr += `\n                <li class=\"task\" id=\"task_${id}\">\n                <div>\n                    <div>\n                        <label for=\"${id}\">\n                            <p>${commandName}</p>\n                        </label>\n                    </div>`;\n\n    // Add input fields for each object variable\n    returnStr += AddInputFields(command, id);\n\n    returnStr += `\n                    <div>\n                    </div>\n                    <div class=\"filler\"></div>\n                    <div class=\"settings\">\n                        <i onclick=\"ShowBulletinMenu(this)\" class=\"uil uil-ellipsis-h\"></i>\n                        <ul class=\"bulletinMenu\">\n                            <li onclick='CopyCommand(${id})'><i class=\"uil uil-trash\"></i>Copy</li>\n                            <li onclick='DeleteCommand(${id})'><i class=\"uil uil-trash\"></i>Delete</li>\n                        </ul>\n                    </div>\n                </div>\n            </li>`;\n\n    return returnStr;\n}\n\n// Add input fields for each command variable\nfunction AddInputFields(command, id, previousKey = null) {\n    var returnStr = \"\";\n    for (const key in command) {\n        var keystr = key;\n        keystr = key.toLocaleLowerCase();\n\n        if (command[key] !== null && typeof command[key] === 'object') {\n            returnStr += \"<span>\" + key + \" {</span>\";\n            returnStr += AddInputFields(command[key], id, key);\n            returnStr += \"<span>}</span>\";\n        }\n\n        else if (keystr != \"action\") {\n            let inputID = \"commandInput_\" + id + \"_\" + (previousKey != null ? previousKey + \"_\" : \"\") + key;\n            //inputIDArray.push(inputID);\n            returnStr += `\n                    <div>\n                    ${keystr}\n                    <input id=\"${inputID}\" value='${command[key]}'/>\n                    </div>\n                        `;\n        }\n\n    }\n    return returnStr;\n}\n\n\nfunction ResizeInputToFit(id) {\n    let _inputField = document.querySelector((\"#\" + id));\n    let width = (40 + (_inputField.value.length * 7.35)) + \"px\";\n    document.querySelector((\"#\" + id)).setAttribute('style', 'width:' + width);\n}\n\nvar lastChar = '';\nvar isNewline = false;\nvar isInsideQuotations = false;\nfunction SetTextareaText(json) {\n    var text = \"\";\n    let count = json.length;\n    var level = 0;\n\n    for (let i = 0; i < count; i++) {\n        let char = json[i];\n\n        switch (char) {\n            case '{': case '[':\n                if (!isInsideQuotations && i != 0 && (json[i - 1] == ',' || json[i - 1] == ':')) text += \"\\n\";\n                if (!isInsideQuotations)\n                    for (let l = 0; l < level; l++)\n                        text += \"\\t\";\n                text += char;\n                if (!isInsideQuotations) {\n                    text += \"\\n\";\n                    level++;\n                    isNewline = true;\n                }\n                break;\n\n            case '}': case ']':\n                if (!isInsideQuotations) {\n                    text += \"\\n\";\n                    level--;\n                    for (let l = 0; l < level; l++)\n                        text += \"\\t\";\n                    isNewline = true;\n                }\n                text += char;\n                break;\n\n            case ',':\n                if (!isInsideQuotations)\n                    isNewline = true;\n                text += char;\n                break;\n\n            case ':':\n                text += char;\n                if (lastChar == \"\\\"\")\n                    text += \" \";\n                break;\n\n            case '\"':\n                isInsideQuotations = !isInsideQuotations;\n\n            default:\n                if (i != 0 && json[i - 1] == ',') { text += \"\\n\"; isNewline = true }\n                if (isNewline)\n                    for (let l = 0; l < level; l++)\n                        text += \"\\t\";\n                text += char;\n                isNewline = false;\n                break;\n        }\n\n        lastChar = char;\n    }\n\n    textarea.value = text;\n}\n\nfunction SetTextareLineNumbers() {\n    /*\n    const lineHeight = 21;\n    var taHeight = textarea.scrollHeight; // Get the scroll height of the textarea\n    const numberOfLines = Math.floor(taHeight/lineHeight);\n    */\n    const numberOfLines = textarea.value.split('\\n').length;\n    lineNumbers.innerHTML = Array(numberOfLines)\n        .fill('<span></span>')\n        .join('');\n}\n\n\n\n\n\n\n\n\n\n\n\n/////////////\n/// #4 : Communication (HTTP Request + Websockets)\n////////////\n\n///\n// HTTP post method (for testing flows using \"nr\"-command)\nasync function SendToNodeRed() {\n    if (commandList.length == 0)\n        return;\n\n    document.getElementById('task_0').classList.add(\"current\");\n\n    fetch('/puprun', {\n\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n        },\n        body: textarea.value\n\n    }).then(response => {\n        if (response.ok) {\n            response.json().then(json => {\n                console.log(json);\n            });\n        }\n    });\n}\n\n///\n// WEB SOCKET (node-red)\nvar ws;\nvar wsUri = \"ws:\";\nvar loc = window.location; //console.log(loc);\n\nif (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n// This needs to point to the web socket in the Node-RED flow\nwsUri += \"//\" + loc.host + loc.pathname.replace(\"pup\", \"ws/pup\");\n\nfunction wsConnect() {\n    console.log(\"Connecting to \", wsUri);\n    ws = new WebSocket(wsUri);\n    //var line = \"\";    // either uncomment this for a building list of messages\n    ws.onmessage = function (msg) {\n        var line = \"\";  // or uncomment this to overwrite the existing message\n\n        // parse the incoming message as a JSON object\n        var data = msg.data;\n        const obj = JSON.parse(data);\n\n        console.log(\"Received WS message ID: \" + obj.pupid);\n\n        // Remove bg from current command box (and set error if error was detected)\n        document.getElementById('task_' + obj.pupid).classList.remove(\"current\")\n        if (!obj.succesful)\n            document.getElementById('task_' + obj.pupid).classList.add(\"error\")\n\n        // Update next command box bg\n        let nextID = obj.pupid + 1;\n        if (commands.length > nextID)\n            document.getElementById('task_' + nextID).classList.add(\"current\");\n\n        //ws.send(JSON.stringify({data:data}));\n    }\n    ws.onopen = function () {\n        // update the status div with the connection status\n        console.log(\"Connected to WS\");\n    }\n    ws.onclose = function () {\n        // update the status div with the connection status\n        console.log(\"WS connection lost\");\n        // in case of lost connection tries to reconnect every 3 secs\n        setTimeout(wsConnect, 3000);\n    }\n}\nfunction PublishWsMessage(m) {\n    if (ws) { ws.send(m); }\n}\n\n\n\n\n\n\n\n\n\n/////////////\n/// #5 : Command line interface\n////////////\n\nfunction RunCommandLineAction(key) {\n    if (key != \"Enter\")\n        return;\n\n    var input = cmdInput.value;\n    input = input.toLowerCase();\n\n    const inputCommand = (input.split(' '))[0];\n\n    var clearInput = true;\n\n    switch (inputCommand) {\n        case \"clear\":\n            ClearAllCommands();\n            break;\n\n        case \"node-red\": case \"nr\":\n            SendToNodeRed();\n            break;\n\n        default:\n            console.log(\"Received unrecognized console command `\" + input + \"`\");\n            clearInput = false;\n            break;\n    }\n\n    if (clearInput)\n        cmdInput.value = \"\";\n}\n\n/*\nfunction AddCommandLineCommand(ic, i) {\n    const parameters = i.replace(ic, '').trim();\n    AddCommand(ic, parameters);\n\n    console.log(\"Received command `\" + ic + \"` with parameters `\" + parameters + \"`\");\n}\n\n*/\n\n\n\n\n\n\n\n/////////////\n/// #6 : Event listeners\n////////////\n\ntextarea.addEventListener('keyup', event => {\n    SetTextareLineNumbers();\n    StoreAndUpdateJSON(textarea.value);\n});\n\ntextarea.addEventListener('keydown', event => {\n    if (event.key === 'Tab') {\n        const start = textarea.selectionStart;\n        //const end = textarea.selectionEnd;\n\n        textarea.value = textarea.value.substring(0, start) + '\\t' + textarea.value.substring(start, textarea.value.length);\n\n        textarea.selectionEnd = start + 1;\n\n        event.preventDefault();\n    }\n});\n\ncmdInput.addEventListener('keyup', event => {\n    RunCommandLineAction(event.key);\n});\n\n/*\nwindow.onresize = SetTextareLineNumbers;\n*/",
        "x": 630,
        "y": 160,
        "wires": [
            [
                "c8f4a55e7618b7e2"
            ]
        ]
    },
    {
        "id": "a17c13f96787e2b4",
        "type": "template",
        "z": "41d1b8798efe7e15",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\" dir=\"ltr\">\n  <head>\n    <meta charset=\"utf-8\">  \n    <title>PupController</title>\n    <style>{{{payload.style}}}</style>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <!-- Iconscout Link For Icons -->\n    <link rel=\"stylesheet\" href=\"https://unicons.iconscout.com/release/v4.0.0/css/line.css\">\n  </head>\n  <body onload=\"wsConnect();\" onunload=\"ws.disconnect();\">\n\n    <div class=\"flex\">\n\n      <div class=\"containerLeft\">\n\n        <div class=\"menu\">\n\n          <div class=\"menupoints\">\n            <div>Documentation</div>\n            <div>GitHub</div>\n          </div>\n\n          <div class=\"controls\"></div>\n\n        </div>\n\n        <ul class=\"commandList\"></ul>\n\n      </div>\n      <div class=\"containerRight\">\n\n        <div class=\"editor\">\n          <div class=\"line-numbers\">\n            <span></span>\n          </div>\n          <textarea class=\"textarea\"></textarea>\n        </div><!-- /editor -->\n\n      </div><!-- /containerRight -->\n    </div><!-- /flex -->\n\n\n\n    <div class=\"commandLine\">\n      <span>></span><input class=\"cmd\" />\n    </div>\n\n\n<script>{{{payload.script}}}</script>\n\n  </body>\n</html>",
        "x": 970,
        "y": 160,
        "wires": [
            [
                "5c5841605bcac134"
            ]
        ]
    },
    {
        "id": "c8f4a55e7618b7e2",
        "type": "template",
        "z": "41d1b8798efe7e15",
        "name": "CSS",
        "field": "payload.style",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "/* Import Google Font - Poppins */\n@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');\n*{\nmargin: 0;\npadding: 0;\nbox-sizing: border-box;\nfont-family: 'Poppins', sans-serif;\ncolor:rgb(204, 204, 204)\n}\n*:focus\n{\noutline: none;\n}\nbody{\nwidth: 100%;\nheight: 100vh;\noverflow: hidden;\ndisplay: flex;\nalign-content: stretch;\nflex-direction: column;\n}\n.flex\n{\nwidth: 100%;\ndisplay: inline-flex;\nflex-grow: 1;\n}\n.containerLeft\n{\nwidth: 55%;\nbackground: #282b2f;\n/*box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);*/\n}\n.containerRight\n{\nheight: calc(100vh - 30px);\nwidth: 45%;\noverflow-y:auto;\nbackground-color: #1d2025;\nborder-left: 4px solid rgb(29, 31, 29);\n}\n\n/* BOTTOM CMD */\n.commandLine\n{\nline-height: 30px;\ncolor:darkslategray;\nwidth:100%;\nbackground-color: #0b0c0c;\npadding-left: 15px;\n}\n.cmd\n{\nwidth: calc(100% - 30px);\nheight: 100%;\nborder:0px;\nbackground-color: #0b0c0c;\npadding-left: 5px;\nfont-family: monospace;\nfont-size: 15px;\n}\n\n/* RIGHT CONTAINER - TEXT AREA\n.containerRight textarea\n{\nbackground: linear-gradient(135deg, #141618, #191c22);\npadding: 10px 20px;\nwidth:100%;\nheight:100vh;\nborder: 0px;\n} */\n.editor {\ndisplay: inline-flex;\nalign-content: stretch;\nline-height: 21px;\nfont-size: 12px;\nbackground: linear-gradient(135deg, #1a1c20, #1d2025);\nwidth:100%;\n}\n\n.textarea {\noverflow-wrap:break-word;\nwhite-space: pre-wrap;\nline-height: 21px;\n/*overflow-y: hidden;\nbackground: #282a3a;\nheight: 100vh;\ncolor: #FFF;*/\nmin-height: calc(100vh - 30px);\noverflow:hidden;\noutline: none;\nresize: none;\nfont-family: monospace;\nflex-grow: 1;\ncolor:rgb(214, 211, 211);\n\nbackground: linear-gradient(135deg, #141618, #191c22);\npadding: 10px 15px;\nborder: 0px;\n}\n.line-numbers {\npadding: 10px 0px;\nmargin-right: 10px;\nwidth: 35px;\ntext-align: right;\nflex-grow: 0;\n}\n\n.line-numbers span {\ncounter-increment: linenumber;\n}\n\n.line-numbers span::before {\ncontent: counter(linenumber);\ndisplay: block;\ncolor: darkslategray;\nfont-family: monospace;\n}\n\n\n\n\n/* LEFT CONTAINER - VISUAL EDITOR */\n.menu\n{\nbox-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);\nbackground: #282b2f;\nbackground: linear-gradient(135deg, rgb(29, 31, 29) 0%, rgb(22, 24, 24) 100%); /* #232626 */\n}\n.menu .menupoints\n{\nfont-size: 12px;\nline-height: 35px;\npadding-left: 12px;\ntext-transform: capitalize;\nbackground: linear-gradient(135deg, rgb(21, 22, 21) 0%, rgb(16, 17, 17) 100%);\n}\n.menupoints div\n{\ndisplay: inline-flex;\npadding: 0px 10px;\n}\n.menupoints div:hover\n{\nbackground: #232626;\ncursor: pointer;\n}\n\n.controls{\npadding: 7px 10px;\npadding-bottom: 14px;\ntext-align: left;\nmax-height: 61px;\noverflow-y: auto;\n}\n.controls div\n{\nfont-size: 12px;\ntext-transform: capitalize;\ncolor:darkslategray;\npadding-left: 3px;\n}\n.controls .button{\nborder: none;\nopacity: 0.4;\noutline: none;\ncolor: #fff;\ncursor: pointer;\nfont-size: 13px;\npadding: 8px 18px;\nmargin-top:4px;\nborder-radius: 3px;\nletter-spacing: 0.3px;\npointer-events: none;\ntransition: transform 0.25s ease;\nbackground: #344b48; /* 343c4b */\ntext-transform: capitalize;\n}\n.controls .button:not(:first-child)\n{\nmargin-left: 3px;\n}\n.button:hover\n{\nbackground: #4d6f6b;\n}\n.button.active{\nopacity: 1;\npointer-events: auto;\n}\n.button:active{\ntransform: scale(0.93);\n}\n\n\n\n\n.commandList\n{\npadding: 10px 8px;\nwidth:100%;\noverflow-y: auto;\nmax-height:calc(100vh - 126px);\nheight: 100%;\noverflow-x: hidden;\n/*background-color: darkslategray;*/\n}\n.commandList span\n{\npadding-left: 7px;\n}\n.commandList.overflow{\noverflow-y: auto;\n}\n*::-webkit-scrollbar{\nwidth: 5px;\n}\n*::-webkit-scrollbar-track{\nbackground: #3f4349;\nborder-radius: 25px;\n}\n*::-webkit-scrollbar-thumb{\nbackground: #6d6d6d;\nborder-radius: 25px;\n}\n\n\n.commandList .task\n{\nlist-style: none;\nfont-size: 15px;\n\nmargin-bottom: 5px;\nborder-radius: 5px;\n\nbox-shadow: 3px 3px 3px rgba(20, 20, 20, 0.05);\nbackground: linear-gradient(135deg, #32363a, #2d3135);\n}\n    .task.current\n    {\n        background: linear-gradient(135deg, #3f2f4f, #4a3859)!important;\n        /*background: linear-gradient(135deg, #99597d, #804b67)!important;*/\n    }\n    .task.error\n    {\n        background: linear-gradient(135deg, #6e4a48, #6b4a46)!important;\n        /*background: linear-gradient(135deg, #9c5c5c, #854e4e)!important;*/\n    }\n.commandList .task > div\n{\npadding-left: 20px;\ndisplay: inline-flex;\nalign-items: flex-start;\nflex-wrap: wrap;\ngap: 15px;\nwidth: 100%;\nmax-width: 100%!important;\npadding-top: 8px;\npadding-bottom: 8px;\nline-height: 25px;\n}\n.task span\n{\ncolor: rgb(136, 136, 136);\nfont-family: monospace;\nline-height: 25px;\nfont-size:12px;\n}\n.task p\n{\n    text-transform: capitalize;\n}\n.commandList .task > div > div\n{\ncolor: rgb(114, 153, 153);\nfont-family: monospace;\n}\n.commandList .task > div input\n{\nbackground-color: #535353;\nborder: 0px;\nborder-radius: 3px;\nline-height: 25px;\npadding: 0px 10px;\nfont-family: monospace;\nwidth: auto;\nmax-width: calc(100vh - 150px);\n}\n\n.commandList .task > div > div.filler\n{\nflex-grow: 1;\nflex-shrink: 1;\n}\n.commandList .settings\n{\nposition: relative;\nfloat: right;\npadding-right:10px;\n/*top: -16px;*/\nflex-grow: 0!important;\n}\n.settings :where(i, li){\ncursor: pointer;\n}\n.settings .bulletinMenu{\nz-index: 10;\nright: 12px;\npadding: 5px 0;\nbackground: #757575;\nposition: absolute;\nborder-radius: 4px;\ntransform: scale(0);\ntransform-origin: top right;\nbox-shadow: 0 0 6px rgba(0,0,0,0.15);\ntransition: transform 0.2s ease;\n}\n.commandList .task:last-child:not(:first-child) .bulletinMenu{\nbottom: 20px;\ntransform-origin: bottom right;\n}\n.commandList .task:not(:last-child) .bulletinMenu{\ntop: 20px;\n}\n/*\n.commandList .task:first-child .bulletinMenu{\nbottom: -65px;\ntransform-origin: top right;\n}*/\n.bulletinMenu.show{\ntransform: scale(1);\n}\n.bulletinMenu li{\nheight: 25px;\nfont-size: 12px;\nline-height: 25px;\nmargin-bottom: 2px;\npadding: 0px 10px;\nmin-width: 85px;\ncursor: pointer; list-style-type: none;\n}\n.bulletinMenu li:last-child{\nmargin-bottom: 0;\n}\n.settings li:hover{\nbackground: rgb(128, 128, 128);\n}\n.settings li i{\npadding-right: 8px;\n}",
        "x": 790,
        "y": 160,
        "wires": [
            [
                "a17c13f96787e2b4"
            ]
        ]
    },
    {
        "id": "fc52fed50ca3f697",
        "type": "aedes broker",
        "z": "8ea344595d9a442a",
        "name": "",
        "mqtt_port": 1883,
        "mqtt_ws_bind": "port",
        "mqtt_ws_port": "",
        "mqtt_ws_path": "",
        "cert": "",
        "key": "",
        "certname": "",
        "keyname": "",
        "dburl": "",
        "usetls": false,
        "x": 150,
        "y": 340,
        "wires": [
            [],
            []
        ],
        "info": "## MQTT broker\r\nThe Aedes MQTT broker is started on port 1883 using this custom node module."
    },
    {
        "id": "a5fbe09299aac9f6",
        "type": "mqtt in",
        "z": "8ea344595d9a442a",
        "name": "MQQT Subscriber",
        "topic": "worklet/control",
        "qos": "2",
        "datatype": "auto-detect",
        "broker": "a567f42879c1f449",
        "nl": false,
        "rap": true,
        "rh": 0,
        "inputs": 0,
        "x": 150,
        "y": 220,
        "wires": [
            [
                "35b865b5034d2b0c",
                "becf3086d0307883"
            ]
        ],
        "info": "## MQTT subscriber\r\n\r\nMQTT subscriber which subscribes to the topic `worklet/control`.\r\nWhen a new message is published to this topic, the content of the message is sent as `msg.payload` to the next node in the flow (a switch)."
    },
    {
        "id": "58b31d3473d4badf",
        "type": "mqtt out",
        "z": "8ea344595d9a442a",
        "name": "MQQT Publisher",
        "topic": "worklet/control",
        "qos": "2",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "a567f42879c1f449",
        "x": 410,
        "y": 540,
        "wires": []
    },
    {
        "id": "a1b4d033b16d8369",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "name": "MQQT START Message",
        "props": [
            {
                "p": "payload"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "start",
        "payloadType": "str",
        "x": 190,
        "y": 540,
        "wires": [
            [
                "58b31d3473d4badf"
            ]
        ]
    },
    {
        "id": "df263263b8209084",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Start MQQT broker",
        "info": "",
        "x": 150,
        "y": 300,
        "wires": []
    },
    {
        "id": "27540cca875b8a81",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Robot styreenhed",
        "info": "",
        "x": 150,
        "y": 180,
        "wires": []
    },
    {
        "id": "9057a712327815d2",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Udfr nsket kommando",
        "info": "",
        "x": 410,
        "y": 180,
        "wires": []
    },
    {
        "id": "6129b81103d9980c",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "name": "Global data",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 150,
        "y": 660,
        "wires": [
            [
                "86720377ed4f4477"
            ]
        ]
    },
    {
        "id": "86720377ed4f4477",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::lastRunStartDate",
                "pt": "global",
                "to": "2022-11-16",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::lastRunDate",
                "pt": "global",
                "to": "2022-11-17",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::statusCode",
                "pt": "global",
                "to": "0",
                "tot": "num"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::processedReceipts",
                "pt": "global",
                "to": "[]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 340,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "ee8cf6c18f13350e",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "TEST ST VARIABLER",
        "info": "",
        "x": 170,
        "y": 600,
        "wires": []
    },
    {
        "id": "35b865b5034d2b0c",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "name": "Control switch",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "start",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 1,
        "x": 380,
        "y": 220,
        "wires": [
            [
                "b0fc3381ab70ecfb"
            ]
        ],
        "info": "## Control switch\r\nThis control switch, which immediately follows the MQTT subscriber, is used to determine which flow to run, depending on the message contained in `msg.payload`."
    },
    {
        "id": "e9617e47af67aef2",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "Control Input Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 460,
        "y": 320,
        "wires": []
    },
    {
        "id": "c4d293d507b4dfc1",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Kommando: `start`",
        "info": "",
        "x": 710,
        "y": 100,
        "wires": []
    },
    {
        "id": "c0efbe2a4fc25ff6",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "27007b43e1b2750d",
        "name": "[E] Find ny start- og slutdato ud fra seneste krsel samt dags dato",
        "info": "",
        "x": 1190,
        "y": 80,
        "wires": []
    },
    {
        "id": "e950456d2d900ca2",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "TEST START MQTT",
        "info": "",
        "x": 150,
        "y": 480,
        "wires": []
    },
    {
        "id": "c5b6cf3e5c34a675",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Download kvitteringer",
        "info": "",
        "x": 2600,
        "y": 120,
        "wires": []
    },
    {
        "id": "722a1862e8711423",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "JSON Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 430,
        "y": 280,
        "wires": []
    },
    {
        "id": "f7835ac1742b0168",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "[E] Ls relevant persondata fra KP vedr. de pgldende borgere",
        "info": "",
        "x": 950,
        "y": 560,
        "wires": []
    },
    {
        "id": "6c9c15c3a64af0ef",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "4689d5530a08a735",
        "name": "Transformr data",
        "info": "",
        "x": 2740,
        "y": 280,
        "wires": []
    },
    {
        "id": "0a04261e8f535acc",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Load / KP sager",
        "info": "",
        "x": 2940,
        "y": 280,
        "wires": []
    },
    {
        "id": "39ab3c95c75aefad",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Extract WorkLet + KP",
        "info": "",
        "x": 2600,
        "y": 80,
        "wires": []
    },
    {
        "id": "7e0f0cecea7dfc8b",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "St statusCode = 0",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::statusCode",
                "pt": "global",
                "to": "0",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2980,
        "y": 200,
        "wires": [
            []
        ]
    },
    {
        "id": "9f0a4de690f4ed8f",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "GAMMEL",
        "info": "",
        "x": 2940,
        "y": 160,
        "wires": []
    },
    {
        "id": "2ea70729759d488c",
        "type": "catch",
        "z": "8ea344595d9a442a",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 1820,
        "y": 120,
        "wires": [
            [
                "df0ed618b5194000"
            ]
        ]
    },
    {
        "id": "df0ed618b5194000",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "ERROR DEBUG",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "error",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1930,
        "y": 160,
        "wires": []
    },
    {
        "id": "dbd52891866c7867",
        "type": "http in",
        "z": "8ea344595d9a442a",
        "name": "",
        "url": "/worklet",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 1860,
        "wires": [
            [
                "fb217fc355c8774a"
            ]
        ]
    },
    {
        "id": "3d5f7ca46f492c8b",
        "type": "template",
        "z": "8ea344595d9a442a",
        "name": "CSS",
        "field": "payload.style",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400&family=Roboto:wght@300;400;700;900&display=swap');\n\n*\n{\n    font-family: 'Roboto Slab';\n    font-weight: 300;\n    font-size: 13px;\n    transition: 1000ms;\n    max-height: 100%;\n}\n*:not(#main, body, #body)\n{\n    box-sizing: border-box;\n}\ninput, select\n{\n    border-radius: 3px;\n    background-color: whitesmoke;\n    border: 1px solid #ebebeb;\n    line-height: 35px;\n    min-height: 37px;\n    padding: 0px 10px;\n    font-weight: 400;\n}\ninput\n{\n    background: linear-gradient(whitesmoke, #fafafa);\n    max-width: 150px;\n}\nbutton\n{\n    height: 70px;\n    font-size: 20px;\n    border: 0px;\n    margin: 2px;\n    cursor: pointer;\n    background: linear-gradient(whitesmoke, #fafafa);\n    text-align: left;\n    padding-left: 70px;\n}\nbutton:hover\n{\n    background: linear-gradient(ebebeb, whitesmoke);\n}\n.contentBox.login input\n{\n    width: 100%;\n    max-width: 100%;\n}\nselect\n{\n    background: linear-gradient(whitesmoke, #e8e8e8);\n}\ninput:focus, select:focus\n{\n    outline: 1px solid #FAE100;\n}\ninput:disabled, select:disabled\n{\n    color: #737373!important;\n    opacity: 1!important;\n}\n\nbody\n{\n    padding-left: 50px;\n    padding-bottom: 30px;\n    \n    background-color: #d6d6d6;\n    margin: 0px;\n    \n    flex: content;\n    display: flex;\n    justify-content: center;\n    gap: 10px;\n}\n#body\n{\n    padding-top: 150px;\n}\n    #main\n    {\n        width: 600px;\n        transition-delay: 500ms;\n    }\n\n.contentBox\n{\n    background-color: white;\n    border-radius: 5px;\n    width: 100%;\n    /*width: 600px;*/\n    overflow: hidden;\n}\n\n.hidden \n{\n    max-height: 0px!important;\n    overflow: hidden!important;\n}\n.hidden *\n{\n    max-height: 0px!important;\n    overflow: hidden!important;\n}\n.contentBox *\n{\n    overflow: hidden;\n}\n\n.contentBox:not(.hidden)\n{\n    margin-bottom: 20px;\n}\n.contentBox.locked > div.header\n{\n        background: linear-gradient(#575c65, #666d76)!important;\n}\n.contentBox.locked input, .contentBox.locked select\n{\n    pointer-events:none;\n}\n.contentBox.checked \n{\n    background-color: #7dd25989!important;\n}\n\n    /*.contentBox.rules\n    {\n        width: 30vw;  \n    }*/\n    .contentBox > div.header\n    {\n        width: 100%;\n        background: linear-gradient(#1B365D, #3c506e);\n        /* background-color: #1B365D; /*#3c506e;*/\n        line-height: 70px;\n        color: white;\n        padding-left: 18px;\n        font-size: 20px;\n        font-family: 'Roboto';\n        font-weight: 400;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        border: 2px solid whitesmoke;\n        border-top-left-radius: 5px;\n        border-top-right-radius: 5px;\n        transition-delay: 500ms;\n    }\n    .contentBox > .subheader\n    {\n        width: 100%;\n        padding-left: 20px;\n        padding-right: 20px;\n        line-height: 40px;\n        text-transform: uppercase;\n        font-weight: 300;\n        background: linear-gradient(#737373, #878787);\n        font-family: 'Roboto';\n        color: white;\n        border-left: 2px solid whitesmoke;\n        border-right: 2px solid whitesmoke;\n    }\n    .contentBox .wrapper\n    {\n        width: 100%;\n        display: flex;\n        flex-direction: column;\n        gap: 2px;\n    }\n    .contentBox .actionList\n    {\n        display: flex;\n        flex-direction: column;\n    }\n        .wrapper > div, .actionList > div#wrappedStartButton /* WRAPPER OBJECT PARENT */\n        {\n            width: 100%;\n            display: flex;\n            flex-wrap: wrap;\n            justify-content: space-between;\n            gap: 5px;\n            padding: 15px;\n            line-height: 35px;\n            border-left: 2px solid whitesmoke;\n            border-right: 2px solid whitesmoke;\n        }\n        .wrapper label, .actionList label\n        {\n            padding: 0px;\n            font-size: 18px;\n            line-height: 40px;\n            flex-grow: 2;\n            padding-left: 20px;\n            cursor: pointer;\n        }\n        .wrapper input[type='checkbox'], .actionList input[type='checkbox']\n        {\n            width: 25px;\n            cursor: pointer;\n        }\n        .wrapper:last-child > div:last-child\n        {\n            border-bottom-left-radius: 5px;\n            border-bottom-right-radius: 5px;\n            border-bottom: 2px solid whitesmoke;\n        }\n\n            .contentBox.approve .wrapper > div:first-child\n            {\n                border-top-left-radius: 5px;\n                border-top-right-radius: 5px;\n                border-top: 2px solid whitesmoke;\n            }\n            .wrapper > div > span\n            {\n                flex-grow: 0;\n            }\n            .wrapper span.valuetype\n            {\n                background-color: #95afc0;\n                color: white;\n                border-radius: 3px;\n                padding: 0px 5px;\n                opacity: 0.7;\n            }\n            .wrapper > div > span:first-of-type\n            {\n                font-size: 15px;\n            }\n            .wrapper > div > div > span \n            {\n                font-size: 15px;\n            }\n            .wrapper > div > span.description\n            {\n                background-color: #FAE100;\n                border-radius: 3px;\n                padding: 0px 10px;\n                opacity: 0.7;\n                color: black;\n                font-size: 15px;\n                font-weight: 400;\n                cursor: help;\n            }\n            .wrapper .spacing\n            {\n                flex-grow: 2;\n            }\n\n.no-select {\n    user-select: none; /* supported by Chrome and Opera */\n   -webkit-user-select: none; /* Safari */\n   -khtml-user-select: none; /* Konqueror HTML */\n   -moz-user-select: none; /* Firefox */\n   -ms-user-select: none; /* Internet Explorer/Edge */\n}\n\n\n.w50 {\n    width: 100%;\n    max-width: 45%;\n}\n.w40 {\n    flex-grow: 10;\n    justify-self: flex-start;\n}\n.w20 {\n    flex-grow: 1;\n    justify-self: flex-end;\n    width: 15%;\n}\n\n.disabled {\n    background-color: #c8c8c8!important;\n}\n.disabled input, .disabled select, .disabled label\n{\n    pointer-events: none;\n}\n\n\n\n.column\n{\n    flex-direction: column!important;\n}\n.flex\n{\n    display: flex;\n    justify-content: space-between;\n}\n.floatr\n{\n    float: right;\n    position: relative;\n}\n\n\n\n\n\n\n\n.citizen\n{\n    background-color: #e8e2f7;\n}\n.receipt\n{\n    background-color: #f5f4dd;\n    border-top-left-radius: 8px;\n    border-top-right-radius: 8px;\n}\n.suggestedActions\n{\n    background-color: #e2f7ee;\n    border-bottom-left-radius: 8px;\n    border-bottom-right-radius: 8px;\n    padding-bottom: 7px;\n}\n.actionList > div\n{\n    width: 100%;\n    display: flex;\n    flex-wrap: wrap;\n    justify-content: space-between;\n    gap: 5px;\n    padding: 15px;\n    line-height: 35px;\n    border-left: 2px solid whitesmoke;\n    border-right: 2px solid whitesmoke;\n}\n\n\n    .receipt .flex > div:not(:first-of-type)\n    {\n        text-align: right;\n    }\n    \n    .receipt .flex:last-child,\n    .citizen .flex:last-child,\n    .suggestedActions .flex:last-child\n    {\n        padding-bottom: 3px;\n    }\n    .receipt > div,\n    .citizen > div,\n    .suggestedActions > div\n    {\n        padding-left: 20px;\n        padding-right: 20px;\n        line-height: 35px;\n    }\n    .receipt .header,\n    .citizen .header,\n    .suggestedActions .header\n    {\n        text-transform: uppercase;\n        font-family: 'Roboto';\n        font-weight: 400;\n        font-size: 14px;\n        line-height: 45px;\n        background-color: #00000009;\n    }\n    .receipt .subheader,\n    .citizen .subheader,\n    .suggestedActions .subheader\n    {\n        background-color: #00000009;\n        text-transform: uppercase;\n        font-weight: 900;\n        line-height: 20px;\n        padding-bottom: 8px;\n    }\n        .receipt .subheader *,\n        .citizen .subheader *,\n        .suggestedActions .subheader *\n        {\n            font-size: 11px;\n            font-family: 'Roboto';\n            font-weight: 300;\n            align-self: flex-end;\n        }\n        .receipt .fakturanr\n        {\n            font-size: 12px;\n            padding-left: 20px;\n            color: #95afc0;\n        }\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n/* RESULTS */\n@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400&family=Roboto:wght@300;400;500;600;700;900&display=swap');\n\n*\n{\n    box-sizing: border-box;\n}\na\n{\n    text-decoration: none;\n    color: rgb(59, 59, 59);\n}\nbody\n{\n    max-width: 100vw;\n    margin: 0px;\n    scrollbar-gutter: stable;\n}\n.results\n{\n    position: absolute;\n    left: 0px;\n    right: 0px;\n    bottom: 0px;\n\n    background-color: #a8a8a8;\n    width: 100%;\n    max-height: 0px;\n    min-height: 100vh;\n    scrollbar-gutter: stable;\n\n    display: flex;\n    overflow-x: hidden;\n    justify-content: center;\n\n    font-family: 'Roboto Slab';\n    font-weight: 400;\n    font-size: 13px;\n    color: rgb(59, 59, 59);\n\n    transition-duration: 1200ms;\n}\n  \n    .results:not(.visible)\n    {\n        min-height: 0vh;\n    }\n    .results > div.main\n    {\n        max-width: 1700px;\n        min-width: 900px;\n\n        margin-top: 170px;\n    }\n\n/* MENU / KATEGORIER */\n.menu\n{\n    position: fixed;\n    z-index: 2;\n    \n    display: flex;\n    justify-content: center;\n    gap: 27px;\n\n    padding-top: 50px;\n    padding-bottom: 18px;\n    background-color: #999999ee;\n\n    left: 18px;\n    right: 18px;\n}\n    .menu > div\n    {\n        display: flex;\n        height: 60px;\n        transition-duration: 150ms;\n\n        user-select: none; /* supported by Chrome and Opera */\n        -webkit-user-select: none; /* Safari */\n        -khtml-user-select: none; /* Konqueror HTML */\n        -moz-user-select: none; /* Firefox */\n        -ms-user-select: none; /* Internet Explorer/Edge */\n    }\n        .menu > div.selected\n        {\n            margin-top: 12px;\n            border: 5px solid rgba(255, 255, 255, 0.411);\n        }\n        .menu > div.green\n        {\n            background-color: #DAE5D7;\n        }\n        .menu > div.red\n        {\n            background-color: #e5d7d7;\n        }\n        .menu > div.yellow\n        {\n            background-color: #e5e0d7;\n        }\n    .menu > div:hover\n    {\n        scale: 1.05;\n        cursor: pointer;\n    }\n        .menu > div > div\n        {\n            display: flex;\n            flex-direction: column;\n            justify-content: flex-end;\n        }\n        .menu > div > div:first-child\n        {\n            background: rgb(1, 1, 1, 0.08);\n            justify-content: flex-end;\n\n            width: 70px;\n        }\n            .menu > div > div:first-child > div /* Procent-visning af relativt antal faktura i kategori */\n            {\n                display: flex;\n                flex-direction: column;\n            }\n                .menu > div.green > div:first-child > div\n                {\n                    background-color: #80bf80;\n                }\n                .menu > div.red > div:first-child > div\n                {\n                    background-color: #bf8080;\n                }\n                .menu > div.yellow > div:first-child > div\n                {\n                    background-color: #bfb980;\n                }\n            .menu > div > div:first-child > div > span /* Procent ^^ i tekst ovenover boks */\n            {\n                align-self: center;\n                font-size: 9px;\n                font-weight: 600;\n                margin-top: -11.5px;\n            }\n                .menu > div.green > div:first-child > div > span\n                {\n                    color: #639463;\n                }\n                .menu > div.red > div:first-child > div > span\n                {\n                    color: #946363;\n                }\n                .menu > div.yellow > div:first-child > div > span\n                {\n                    color: #948f63;\n                }\n            .menu > div > div:first-child > div > span > span\n            {\n                font-size: 7px;\n            }\n        .menu > div > div:last-child /* Kategori-titel */\n        {\n            padding-left: 20px;\n            justify-content: center;\n\n            width: 170px;\n\n            font-family: 'Roboto';\n            text-transform: uppercase;\n            font-size: 12px;\n            font-weight: 500;\n            letter-spacing: 1px;\n            color: rgb(1, 1, 1, 0.65);\n        }\n    \n\n\n.itemList\n{\n    display: flex;\n    flex-direction: column;\n}\n\n/* LIST ITEM */\n.listItem\n{\n    display: flex;\n    padding-bottom: 35px;\n}\n    .listItem > div\n    {\n        align-self: flex-start;\n    \n        min-width: 270px;\n    }\n        .listItem .header\n        {\n            line-height: 38px;\n            background: rgb(1, 1, 1, 0.08);\n\n            text-transform: uppercase;\n            font-family: 'Roboto';\n            font-weight: 400;\n            font-size: 11px;\n            letter-spacing: 0.45px;\n            color: rgb(1, 1, 1, 0.55);\n\n            padding-left: 14px;\n            padding-right: 14px;\n\n            user-select: none; /* supported by Chrome and Opera */\n            -webkit-user-select: none; /* Safari */\n            -khtml-user-select: none; /* Konqueror HTML */\n            -moz-user-select: none; /* Firefox */\n            -ms-user-select: none; /* Internet Explorer/Edge */\n        }\n            .listItem .header:hover\n            {\n                cursor: grab;\n            }\n            .header > span\n            {\n                position: relative;\n                float: right;\n                margin-right: 3px;\n            }\n            .listItem > div:first-child .header\n            {\n                padding-right: 30px;\n            }\n                #togglePop\n                {\n                    cursor: pointer;\n                }\n                span > .popmenu\n                {\n                    position: absolute;\n                    float: left;\n                    top: 20px;\n                    right: 18px;\n                    width: 150px;\n\n                    font-size: 10px;\n                    line-height: 32px;\n\n                    background-color: rgb(255, 255, 255, 1);\n                    box-shadow: 0px 0px 30px -10px grey;\n\n                    display: flex;\n                    flex-direction: column;\n\n                    max-height: 0vh;\n                    max-width: 0vh;\n                    overflow: hidden;\n                    white-space: nowrap;\n                    text-overflow: ellipsis;\n\n                    transition-duration: 100ms;\n                }\n                    #togglePop.show > .popmenu\n                    {\n                        max-height: 30vh;\n                        max-width: 100vh;\n\n                        transition-duration: 1000ms;\n                    }\n                    .popmenu > a\n                    {\n                        padding: 0px 10px;\n                    }\n                    .popmenu > a:hover\n                    {\n                        background-color: rgb(240, 240, 240, 1); \n                    }\n\n    /* Borger */\n    .listItem > div:first-child\n    {\n        flex-grow: 0;\n        background-color: #DDDEFE;\n        padding-bottom: 8px;\n    }\n        .listItem > div:first-child > .cpr\n        {\n            padding: 15px 18px;\n            font-size: 17px;\n            font-weight: 400;\n            letter-spacing: 0.3px;\n        }\n        .listItem > div:first-child > .sag\n        {\n            padding: 4px 14px;\n            background: rgb(1, 1, 1, 0.04);\n            margin-bottom: 2px;\n\n            text-transform: uppercase;\n            font-family: 'Roboto';\n            line-height: 18px;\n            font-size: 10px;\n            letter-spacing: 0.45px;\n        }\n            .sag > span\n            {\n                font-size: 17px;\n            }\n            .sag.findes\n            {\n                color: #46a114;\n                font-weight: 400;\n            }\n            .sag.findes-ikke\n            {\n                color: #a15814;\n                font-weight: 400;\n            }\n        .listItem > div:first-child > .persondata\n        {\n            display: flex;\n            flex-wrap: wrap;\n            justify-content: space-evenly;\n\n            padding: 9px 0px;\n            width: 98%;\n        }\n            .listItem > div:first-child > .persondata > div\n            {\n                text-align: center;\n                min-width: 30%;\n                font-family: 'Roboto';\n            }\n    \n\n    /* Faktura + Handlinger */\n    .listItem > div:last-child\n    {\n        flex-grow: 1;\n        justify-self: stretch;\n\n        display: flex;\n        flex-direction: column;\n\n        min-width: 600px;\n    }\n\n        .listItem > div:last-child > .faktura\n        {\n            background-color: #FEFEF3;\n\n            margin-left: -18px;\n            margin-top: -5px;\n            margin-right: -5px;\n\n            padding-bottom: 8px;\n\n            border: 5px solid #a8a8a8;\n        }\n            .listItem > div:last-child > .faktura > div:not(.header)\n            {\n                padding: 8px 14px;\n            }\n            .listItem > div:last-child > .faktura > .ydelse\n            {\n                display: flex;\n                align-items: flex-end;\n                gap: 10px;\n            }\n                /* Sm overskrifter */\n                .listItem > div:last-child > .faktura > .ydelse span, .listItem > div:first-child > .persondata > div > span\n                {\n                    text-transform: uppercase;\n                    font-family: 'Roboto';\n                    font-size: 9px;\n                    color: rgb(159, 159, 159);\n                }\n                .listItem > div:last-child > .faktura > .ydelse > .titel\n                {\n                    flex-grow: 1;\n                }\n                .listItem > div:last-child > .faktura > .ydelse > div:not(.titel)\n                {\n                    text-align: right;\n                }\n                    .listItem > div:last-child > .faktura > .ydelse > div > div\n                    {\n                        margin-top: 8px;\n                    }\n\n        .listItem > div:last-child > .handling\n        {\n            background-color: #F9E1DD;\n            display: flex;\n\n            margin-bottom: 5px;\n            border-left: 5px solid #a8a8a8;\n            margin-right: 18px;\n        }\n            .listItem > div:last-child > .handling > div:not(.header)\n            {\n                line-height: 38px;\n                padding-left: 12px;\n            }\n\n/* Ghost */\n.ghost\n{\n    position: absolute;\n    pointer-events: none;\n    z-index: 10;\n\n    opacity: 0;\n    scale: 0.8;\n}\n.ghost.visible \n{\n    opacity: 0.65;\n}",
        "x": 1250,
        "y": 1840,
        "wires": [
            [
                "5939609dd7538821"
            ]
        ]
    },
    {
        "id": "b78999fe15906d87",
        "type": "template",
        "z": "8ea344595d9a442a",
        "name": "Rules JS",
        "field": "payload.scripts.rules",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "plain",
        "template": "const ruleWrapper_system = document.querySelector(\".ruleWrapper_system\");\nconst ruleWrapper_user = document.querySelector(\".ruleWrapper_user\");\n\nconst rules = _rules != null ? _rules : []; // Rules are defined in change node previous to this\n\nconst operators = [\n    {\n        \"name\": \"= Skal vre lig med\",\n        \"value\": \"==\"\n    },\n    {\n        \"name\": \" M ikke vre lig med\",\n        \"value\": \"!=\"\n    },\n    {\n        \"name\": \"< Skal vre mindre end\",\n        \"value\": \"<\"\n    },\n    {\n        \"name\": \"> Skal vre strre end\",\n        \"value\": \">\"\n    },\n    {\n        \"name\": \"{?} Indeholder\",\n        \"value\": \"contains\"\n    },\n    {\n        \"name\": \"{!} Indeholder ikke\",\n        \"value\": \"!contains\"\n    },\n    {\n        \"name\": \"[o] Skal vre oplyst\",\n        \"value\": \"!null\"\n    }\n]\n\n\nfunction newSelector(selectedValue) {\n    return `\n    `;\n}\n\nfunction newInputField(index) {\n    const obj = rules[index];\n    let returnHTML = `\n        <div${obj.systemrule == true ? \" class=\\\"disabled\\\"\" : \"\"}>\n        <span>${obj.name}:</span>\n        <div class=\"spacing\">&nbsp;</div>\n        <div>    \n            <select id=\"input_${index}_operator\"${obj.systemrule == true ? \" disabled=\\\"disabled\\\"\" : \"\"}>\n        `;\n\n    for (let i = 0; i < operators.length; i++) {\n        let isSelected = obj.operator == operators[i].value;\n        //console.log(\"Checking '\" + obj.operator + \"' against '\" + operators[i].value + \"' = \" + isSelected);\n        returnHTML += `<option value=\"${operators[i].value}\"${isSelected ? \" selected\" : \"\"}>${operators[i].name}</option>`;\n    }\n\n    let valueType = obj.type == \"number\" || obj.type == \"text\" ? `<span class=\"valuetype\">${obj.type == \"number\" ? \"tal\" : obj.type == \"text\" ? \"tekst\" : \"\"}</span>` : ``;\n    returnHTML += `\n            </select>\n        </div>\n        <div>\n            <input id=\"input_${index}_value\" value=\"${obj.value}\"${obj.systemrule == true ? \" disabled=\\\"disabled\\\"\" : \"\"} />\n        </div>\n        ${valueType}\n        <span class=\"description\" title=\"${obj.description}\">?</span>\n        </div>\n    `;\n    return returnHTML;\n}\n\n///\n// Instantiate input fields\n\nfor (let i = 0; i < rules.length; i++)\n    if (rules[i][\"systemrule\"] != null && rules[i][\"systemrule\"] == true)\n        ruleWrapper_system.innerHTML += newInputField(i);\n    else\n        ruleWrapper_user.innerHTML += newInputField(i);\n\n///\n// Dynamically add event listeners \n\nfor (let i = 0; i < rules.length; i++) {\n    document.querySelector(\"#input_\" + i + \"_operator\").addEventListener(\"focusout\", () => {\n        UpdateValue(document.querySelector(\"#input_\" + i + \"_operator\"));\n    });\n\n    document.querySelector(\"#input_\" + i + \"_value\").addEventListener(\"focusout\", () => {\n        UpdateValue(document.querySelector(\"#input_\" + i + \"_value\"));\n    });\n\n    document.querySelector(\"#input_\" + i + \"_value\").addEventListener(\"input\", () => {\n        OnInputChange(document.querySelector(\"#input_\" + i + \"_value\"));\n    });\n}\n\n///\n// Update input value\nfunction UpdateValue(inputField) {\n    let id = inputField.id;\n    let sid = id.split(\"_\");\n\n    (rules[parseInt(sid[1])])[sid[2]] = inputField.value;\n\n    const message = rules;\n\n    PublishRules(JSON.stringify(message));\n    console.log(message);\n}\n\n///\n//\nfunction OnInputChange(inputField) {\n    let id = inputField.id;\n    let sid = id.split(\"_\");\n    let type = (rules[parseInt(sid[1])])[\"type\"];\n\n    switch (type) {\n        case \"int\": case \"float\": case \"double\": case \"number\":\n            inputField.value = inputField.value.replace(/[^0-9.]/g, '').replace(/(\\..*?)\\..*/g, '$1');\n            break;\n\n        case \"text\": case \"letters\":\n            inputField.value = inputField.value.replace(/[^A-Za-z ]/g, '');\n            break;\n\n    }\n}\n\n\n\n\n///\n/* WEB SOCKET (node-red)\nvar ws_rules;\nvar wsUri_rules = \"ws:\";\nvar loc_rules = window.location; //console.log(loc);\n\nif (loc_rules.protocol === \"https:\") { wsUri_rules = \"wss:\"; }\n// This needs to point to the web socket in the Node-RED flow\nwsUri_rules += \"//\" + loc_rules.host + loc_rules.pathname.replace(\"worklet\", \"ws/rules\");\n\nfunction wsConnect_rules() {\n\n    console.log(\"Connecting to \", wsUri_rules);\n    ws_rules = new WebSocket(wsUri_rules);\n\n    ws_rules.onmessage = function (msg) {\n\n        // parse the incoming message as a JSON object\n        var data = msg.data;\n        const obj = JSON.parse(data);\n\n        console.log(\"Received WS message: \" + JSON.stringify(obj));\n\n        //ws.send(JSON.stringify({data:data}));\n    }\n\n    ws_rules.onopen = function () {\n        // update the status div with the connection status\n        console.log(\"Connected to ws/rules\");\n    }\n\n    ws_rules.onclose = function () {\n        // update the status div with the connection status\n        console.log(\"ws/rules connection lost\");\n        // in case of lost connection tries to reconnect every 3 secs\n        setTimeout(wsConnect_rules, 3000);\n    }\n}*/\nfunction PublishRules(m) {\n    if (ws) { ws.send(m); }\n}",
        "x": 960,
        "y": 1840,
        "wires": [
            [
                "cd73593a1a17cac8"
            ]
        ]
    },
    {
        "id": "78a498d6a82a151b",
        "type": "http response",
        "z": "8ea344595d9a442a",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1570,
        "y": 1840,
        "wires": []
    },
    {
        "id": "b0e7c0223f35204b",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Set rules from memory or template",
        "info": "",
        "x": 440,
        "y": 1800,
        "wires": []
    },
    {
        "id": "4d5e9b7651bc2abe",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Host website",
        "info": "",
        "x": 130,
        "y": 1820,
        "wires": []
    },
    {
        "id": "e61b9e68a1a9e687",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Set content",
        "info": "",
        "x": 970,
        "y": 1800,
        "wires": []
    },
    {
        "id": "edb26b05b85df72e",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Endpoint",
        "info": "",
        "x": 1580,
        "y": 1800,
        "wires": []
    },
    {
        "id": "3460ad3d4bc402dd",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "New rule template",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "[\t    {\t        \"name\": \"Formue\",\t        \"variable\": \"formue\",\t        \"operator\": \"<\",\t        \"value\": 93000,\t        \"type\": \"number\",\t        \"description\": \"Borgerens formue skal flge denne regel\",\t        \"error\": \"Borgerens formue bryder formue-reglen\"\t    },\t    {\t        \"name\": \"Formue\",\t        \"variable\": \"formue\",\t        \"operator\": \"!null\",\t        \"value\": true,\t        \"type\": \"bool\",\t        \"description\": \"Borgerens formue skal vre oplyst til UDK\",\t        \"systemrule\": true\t    }\t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 550,
        "y": 1880,
        "wires": [
            [
                "576df08c4fd1853c",
                "51ae6e60c6e1e44d"
            ]
        ]
    },
    {
        "id": "9ee6e743efbedf9f",
        "type": "websocket in",
        "z": "8ea344595d9a442a",
        "d": true,
        "name": "",
        "server": "c1ae0d59916344e0",
        "client": "",
        "x": 130,
        "y": 2180,
        "wires": [
            [
                "54ebf542897cb37d"
            ]
        ]
    },
    {
        "id": "576df08c4fd1853c",
        "type": "json",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "payload.rules",
        "action": "str",
        "pretty": false,
        "x": 750,
        "y": 1840,
        "wires": [
            [
                "c404f88972fe3400"
            ]
        ]
    },
    {
        "id": "5dc5bfc86dfa161e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Load rules",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "#:(storeInFile)::rules",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 530,
        "y": 1840,
        "wires": [
            [
                "576df08c4fd1853c"
            ]
        ]
    },
    {
        "id": "54ebf542897cb37d",
        "type": "json",
        "z": "8ea344595d9a442a",
        "d": true,
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 310,
        "y": 2180,
        "wires": [
            [
                "9d2701d9f3f3c610"
            ]
        ]
    },
    {
        "id": "a7100eb3aada3d3c",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::rules",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 720,
        "y": 2180,
        "wires": [
            [
                "68f7f88bbaaedb3a"
            ]
        ]
    },
    {
        "id": "68f7f88bbaaedb3a",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "Rules updated",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 2180,
        "wires": []
    },
    {
        "id": "499cd9ebcec444da",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "#:(storeInFile)::rules",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 350,
        "y": 1860,
        "wires": [
            [
                "5dc5bfc86dfa161e"
            ],
            [
                "3460ad3d4bc402dd"
            ]
        ]
    },
    {
        "id": "9d2701d9f3f3c610",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$|\t{\t    \"value\": \t        type = \"number\" ?\t            value ~> $number() \t            :\t            value  \t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 500,
        "y": 2180,
        "wires": [
            [
                "a7100eb3aada3d3c"
            ]
        ]
    },
    {
        "id": "cd73593a1a17cac8",
        "type": "template",
        "z": "8ea344595d9a442a",
        "name": "UI JS",
        "field": "payload.scripts.ui",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "const checkboxRules = document.querySelector('#acceptRules'),\n      checkboxLogin = document.querySelector('#acceptLogin'),\n\n    startRunButton = document.querySelector('#startRun'),\n\n    acceptRulesLabel = document.querySelector('#acceptRulesLabel'),\n    acceptLoginLabel = document.querySelector('#acceptLoginLabel'),\n    startRunLabel = document.querySelector('#startRunLabel'),\n\n    loginEmail = document.querySelector('#WorkLetEmail'),\n    loginPass = document.querySelector('#WorkLetPass'),\n\n    contentBoxApproveRules = document.querySelector('.contentBox.approve#approveRules'),\n    contentBoxApproveLogin = document.querySelector('.contentBox.approve#approveLogin'),\n\n    wrappedStartButton = document.querySelector('#wrappedStartButton'),\n    actionList = document.querySelector('.actionList'),\n    \n      contentBoxActions = document.querySelector('.contentBox.actions'),\n      contentBoxRules = document.querySelector('.contentBox.rules'),\n      contentBoxLogin = document.querySelector('.contentBox.login'),\n      \n    body = document.querySelector('#body'),\n    main = document.querySelector('#main');\n\n\nvar paddingTop = 150;\nvar paddingAdjustment = 60,\n    paddingMin = 30;\n\n\n// APROVE LOGIN //\n\ncheckboxLogin.addEventListener('change', event => {\n    if (checkboxLogin.checked == true)\n    {\n        // Make checkbox bg green\n        contentBoxApproveLogin.classList.add(\"checked\");\n\n        // Hide this box\n        contentBoxLogin.classList.add(\"hidden\");\n\n        if (checkboxRules.checked != true)\n        {\n            // Show next box\n            contentBoxRules.classList.remove(\"hidden\");\n            contentBoxApproveRules.classList.remove(\"hidden\");\n        }\n\n        // Change approve label\n        acceptLoginLabel.innerHTML = \"Loginoplysninger godkendt\";\n\n        // Send to node-red\n        ApproveWorkLetLogin();\n\n        // Adjust body padding\n        body.style.paddingTop = (paddingTop -= paddingAdjustment) + \"px\";\n        if (paddingTop < paddingMin) body.style.paddingTop = (paddingTop = paddingMin) + \"px\";\n    }\n    else\n    {\n        // Remove green checkbox bg\n        contentBoxApproveLogin.classList.remove(\"checked\");\n\n        // Un-hide this box\n        contentBoxLogin.classList.remove(\"hidden\");\n\n        // Reverse approve label\n        acceptLoginLabel.innerHTML = \"Godkend loginoplysninger\";\n\n        // Adjust body padding\n        body.style.paddingTop = (paddingTop += paddingAdjustment) + \"px\";\n    }\n\n});\n\n\n// APROVE RULES //\n\ncheckboxRules.addEventListener('change', event => {\n    if (checkboxRules.checked == true)\n    {\n        // Make checkbox bg green\n        contentBoxApproveRules.classList.add(\"checked\");\n\n        // Hide this box\n        contentBoxRules.classList.add(\"hidden\");\n\n        // Show next box\n        contentBoxActions.classList.remove(\"hidden\");\n\n        // Change approve label\n        acceptRulesLabel.innerHTML = \"Regelst godkendt\";\n\n        // Adjust body padding\n        body.style.paddingTop = (paddingTop -= paddingAdjustment) + \"px\";\n        if (paddingTop < paddingMin) body.style.paddingTop = (paddingTop = paddingMin) + \"px\";\n    }\n    else\n    {\n        // Remove green checkbox bg\n        contentBoxApproveRules.classList.remove(\"checked\");\n\n        // Un-hide this box\n        contentBoxRules.classList.remove(\"hidden\");\n\n        // Hide next box\n        contentBoxActions.classList.add(\"hidden\");\n        \n        // Reverse approve label\n        acceptRulesLabel.innerHTML = \"Godkend regelst\";\n\n        // Adjust body padding\n        body.style.paddingTop = (paddingTop += paddingAdjustment) + \"px\";\n    }\n\n});\n\n\n// START RUN //\n\nstartRunButton.addEventListener('change', event => {\n    if (startRunButton.checked == true) {\n        // Disable all checkboxes\n        contentBoxActions.classList.add(\"disabled\");\n        contentBoxApproveRules.classList.add(\"disabled\");\n        contentBoxApproveLogin.classList.add(\"disabled\");\n\n        contentBoxApproveRules.classList.remove(\"checked\");\n        contentBoxApproveLogin.classList.remove(\"checked\");\n\n        // Show action list?\n        //contentBoxActions.classList.remove(\"hidden\");\n\n        // Set extra wide main div for actions\n        main.style.width = \"800px\";\n\n        // Change approve label\n        startRunLabel.innerHTML = \"Beregning pbegyndt ... vent venligst ...\";\n\n        // Adjust body padding\n        body.style.paddingTop = (paddingTop -= paddingAdjustment) + \"px\";\n        if (paddingTop < paddingMin) body.style.paddingTop = (paddingTop = paddingMin) + \"px\";\n\n        // Start run\n        StartRun();\n    }\n    else {\n        \n    }\n\n});\n\n\n\n// POPULATE ACTIONS\n\n\nfunction PopulateActions(objList) {\n\n    contentBoxActions.classList.remove(\"disabled\");\n\n    //console.log(\"Obj count: \" + objList.length);\n    //console.log(\"Obj list: \\n\" + objList);\n\n    let html = ``;\n\n    for (let i = 0; i < objList.length;i++)\n    {\n        html += `\n            <div class=\"column\">\n                <div class=\"receipt\">\n\n                    <div class=\"header\">\n                        Faktura\n                        <span class=\"fakturanr\">\n                            Element `+ i +`\n                        </span>\n                        <div class=\"floatr\">\n                            04-10-2022 14:30\n                        </div>\n                    </div>\n\n                    <div class=\"subheader flex\">\n                        <div class=\"w40\">Behandling</div>\n                        <div class=\"w20\">Egenbetaling</div>\n                        <div class=\"w20\">Sygesikring</div>\n                        <div class=\"w20\">Total</div>\n                    </div>\n\n                    <div class=\"flex\">\n                        <div class=\"w40\">Behandling p klinik</div>\n                        <div class=\"w20\">300 kr</div>\n                        <div class=\"w20\">0 kr</div>\n                        <div class=\"w20\">300 kr</div>\n                    </div>\n\n                </div>\n\n                <div class=\"citizen\">\n\n                    <div class=\"header\">\n                        Borger\n                    </div>\n\n                    <div class=\"subheader flex\">\n                        <div class=\"w40\">Alm. helbredstillg</div>\n                        <div class=\"w20\">Udvidet helbredstillg</div>\n                        <div class=\"w20\">Helbredskort</div>\n                        <div class=\"w20\">Bevilget fodpleje</div>\n                        <div class=\"w20\">Formue</div>\n                        <div class=\"w20\">Danmark gruppe</div>\n                        <div class=\"w20\">Tillgsprocent</div>\n                    </div>\n\n                    <div class=\"flex\">\n                        <div class=\"w40\">Data</div>\n                        <div class=\"w20\">Udvidet Data</div>\n                        <div class=\"w20\">Data</div>\n                        <div class=\"w20\">Bevilget Data</div>\n                        <div class=\"w20\">Data</div>\n                        <div class=\"w20\">Danmark Data</div>\n                        <div class=\"w20\">Data</div>\n                    </div>\n\n                </div>\n\n                <div class=\"suggestedActions\">\n\n                    <div class=\"header\">\n                        Handlinger\n                    </div>\n\n                    <div class=\"flex\">\n                        <div>\n                            Her kommer liste over handlinger\n                        </div>\n                    </div>\n\n                </div>\n\n            </div>\n            `;\n    }\n\n    actionList.innerHTML = html;\n\n    actionList.style.maxHeight = \"100%\";\n}\n\n\n\n///\n// WEB SOCKET (node-red)\nvar ws;\nvar wsUri = \"ws:\";\nvar loc = window.location; //console.log(loc);\n\nif (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n// This needs to point to the web socket in the Node-RED flow\nwsUri += \"//\" + loc.host + loc.pathname.replace(\"worklet\", \"ws/worklet\");\n\nfunction wsConnect() {\n\n    console.log(\"Connecting to \", wsUri);\n    ws = new WebSocket(wsUri);\n\n    ws.onmessage = function (msg) {\n\n        // parse the incoming message as a JSON object\n        var data = msg.data;\n        const obj = JSON.parse(data);\n\n        //console.log(\"Received WS message: \" + JSON.stringify(obj));\n\n        //PopulateActions(obj);\n\n        location.reload();\n\n        /*\n        fetch('/worklet', {\n            method: 'POST',\n            headers: {\n                'Accept': 'application/json',\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({ \"id\": 78912 })\n        });*/\n\n        //ws.send(JSON.stringify({data:data}));\n    }\n\n    ws.onopen = function () {\n        // update the status div with the connection status\n        console.log(\"Connected to ws/worklet\");\n    }\n\n    ws.onclose = function () {\n        // update the status div with the connection status\n        console.log(\"ws/worklet connection lost\");\n        // in case of lost connection tries to reconnect every 3 secs\n        setTimeout(wsConnect, 3000);\n    }\n}\n\nfunction ApproveWorkLetLogin() {\n    let loginObj = {\n        \"user\": loginEmail.value,\n        \"pass\": loginPass.value\n    }\n    if (ws){\n        ws.send(JSON.stringify(loginObj));\n        }\n}\n\nfunction StartRun() {\n    let mqttObj = {\n        \"mqtt\": \"start\"\n    }\n    if (ws) {\n        ws.send(JSON.stringify(mqttObj));\n    }\n}\n\n\n\n",
        "output": "str",
        "x": 1110,
        "y": 1840,
        "wires": [
            [
                "3d5f7ca46f492c8b"
            ]
        ]
    },
    {
        "id": "c404f88972fe3400",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.scripts",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 845,
        "y": 1840,
        "wires": [
            [
                "b78999fe15906d87"
            ]
        ],
        "l": false
    },
    {
        "id": "4bbf05574c4eb354",
        "type": "websocket in",
        "z": "8ea344595d9a442a",
        "name": "",
        "server": "13a90a014adf9bc5",
        "client": "",
        "x": 140,
        "y": 2100,
        "wires": [
            [
                "55f7483f97a32598"
            ]
        ]
    },
    {
        "id": "55f7483f97a32598",
        "type": "json",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 310,
        "y": 2100,
        "wires": [
            [
                "963c9893bf47de87",
                "f2e0e544cca45949"
            ]
        ]
    },
    {
        "id": "963c9893bf47de87",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "hask",
                "v": "mqtt",
                "vt": "str"
            },
            {
                "t": "istype",
                "v": "array",
                "vt": "array"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 470,
        "y": 2100,
        "wires": [
            [
                "a7400f24b25c5de2"
            ],
            [
                "9d2701d9f3f3c610"
            ]
        ]
    },
    {
        "id": "1aaa8fade1e8d780",
        "type": "mqtt out",
        "z": "8ea344595d9a442a",
        "name": "MQQT Publisher",
        "topic": "worklet/control",
        "qos": "2",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "a567f42879c1f449",
        "x": 950,
        "y": 2100,
        "wires": []
    },
    {
        "id": "a7400f24b25c5de2",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload.mqtt",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 720,
        "y": 2100,
        "wires": [
            [
                "1aaa8fade1e8d780"
            ]
        ]
    },
    {
        "id": "b1559f9d4a7c3f92",
        "type": "websocket out",
        "z": "8ea344595d9a442a",
        "name": "",
        "server": "13a90a014adf9bc5",
        "client": "",
        "x": 2140,
        "y": 1400,
        "wires": []
    },
    {
        "id": "da966ceeba7b23dd",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Remove CPRs",
        "rules": [
            {
                "t": "set",
                "p": "results",
                "pt": "flow",
                "to": "$.payload ~> |$|\t{\t    \"cpr\": \t           (cpr ~>\t           $split(\"-\"))[0]\t           & \"-XXXX\"\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1680,
        "y": 1400,
        "wires": [
            [
                "ce947c0f871d1233"
            ]
        ]
    },
    {
        "id": "51ae6e60c6e1e44d",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::rules",
                "pt": "global",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1880,
        "wires": [
            []
        ]
    },
    {
        "id": "f2e0e544cca45949",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "debug 9",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 500,
        "y": 2060,
        "wires": []
    },
    {
        "id": "782f6a476e9a630b",
        "type": "template",
        "z": "8ea344595d9a442a",
        "name": "CSS",
        "field": "payload.style",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400&family=Roboto:wght@300;400;500;600;700;900&display=swap');\n\n*\n{\n    box-sizing: border-box;\n}\na\n{\n    text-decoration: none;\n    color: rgb(59, 59, 59);\n}\nbody\n{\n    max-width: 100vw;\n    margin-top: 0px;\n    margin-left: 0px;\n    margin-right: 0px;\n    background-color: #a8a8a8;\n\n    display: flex;\n    overflow-x: hidden;\n    justify-content: center;\n\n    font-family: 'Roboto Slab';\n    font-weight: 400;\n    font-size: 13px;\n    color: rgb(59, 59, 59);\n}\n    body > div.main\n    {\n        max-width: 1700px;\n        min-width: 900px;\n\n        margin-top: 170px;\n    }\n\n/* MENU / KATEGORIER */\n.menu\n{\n    position: fixed;\n    z-index: 5;\n    \n    display: flex;\n    justify-content: center;\n    gap: 27px;\n\n    padding-top: 50px;\n    padding-bottom: 18px;\n    background-color: #999999ee;\n    border-bottom-left-radius: 5px;\n    border-bottom-right-radius: 5px;\n\n    width: 100%;\n}\n    .menu > div\n    {\n        display: flex;\n        height: 60px;\n        transition-duration: 150ms;\n\n        user-select: none; /* supported by Chrome and Opera */\n        -webkit-user-select: none; /* Safari */\n        -khtml-user-select: none; /* Konqueror HTML */\n        -moz-user-select: none; /* Firefox */\n        -ms-user-select: none; /* Internet Explorer/Edge */\n    }\n        .menu > div.selected\n        {\n            margin-top: 12px;\n            border: 5px solid rgba(255, 255, 255, 0.411);\n        }\n        .menu > div.green\n        {\n            background-color: #DAE5D7;\n        }\n        .menu > div.red\n        {\n            background-color: #e5d7d7;\n        }\n        .menu > div.yellow\n        {\n            background-color: #e5e0d7;\n        }\n    .menu > div:hover\n    {\n        scale: 1.05;\n        cursor: pointer;\n    }\n        .menu > div > div\n        {\n            display: flex;\n            flex-direction: column;\n            justify-content: flex-end;\n        }\n        .menu > div > div:first-child\n        {\n            background: rgb(1, 1, 1, 0.08);\n            justify-content: flex-end;\n\n            width: 70px;\n        }\n            .menu > div > div:first-child > div /* Procent-visning af relativt antal faktura i kategori */\n            {\n                display: flex;\n                flex-direction: column;\n            }\n                .menu > div.green > div:first-child > div\n                {\n                    background-color: #80bf80;\n                }\n                .menu > div.red > div:first-child > div\n                {\n                    background-color: #bf8080;\n                }\n                .menu > div.yellow > div:first-child > div\n                {\n                    background-color: #bfb980;\n                }\n            .menu > div > div:first-child > div > span /* Procent ^^ i tekst ovenover boks */\n            {\n                align-self: center;\n                font-size: 9px;\n                font-weight: 600;\n                margin-top: -11.5px;\n            }\n                .menu > div.green > div:first-child > div > span\n                {\n                    color: #639463;\n                }\n                .menu > div.red > div:first-child > div > span\n                {\n                    color: #946363;\n                }\n                .menu > div.yellow > div:first-child > div > span\n                {\n                    color: #948f63;\n                }\n            .menu > div > div:first-child > div > span > span\n            {\n                font-size: 7px;\n            }\n        .menu > div > div:last-child /* Kategori-titel */\n        {\n            padding-left: 20px;\n            justify-content: center;\n\n            width: 170px;\n\n            font-family: 'Roboto';\n            text-transform: uppercase;\n            font-size: 12px;\n            font-weight: 500;\n            letter-spacing: 1px;\n            color: rgb(1, 1, 1, 0.65);\n        }\n    \n\n\n.itemList\n{\n    display: flex;\n    flex-direction: column;\n}\n\n/* LIST ITEM */\n.listItem\n{\n    display: flex;\n    padding-bottom: 35px;\n}\n    .listItem > div\n    {\n        align-self: flex-start;\n    \n        min-width: 270px;\n    }\n        .listItem .header\n        {\n            line-height: 38px;\n            background: rgb(1, 1, 1, 0.08);\n\n            text-transform: uppercase;\n            font-family: 'Roboto';\n            font-weight: 400;\n            font-size: 11px;\n            letter-spacing: 0.45px;\n            color: rgb(1, 1, 1, 0.55);\n\n            padding-left: 14px;\n            padding-right: 14px;\n\n            user-select: none; /* supported by Chrome and Opera */\n            -webkit-user-select: none; /* Safari */\n            -khtml-user-select: none; /* Konqueror HTML */\n            -moz-user-select: none; /* Firefox */\n            -ms-user-select: none; /* Internet Explorer/Edge */\n        }\n            .listItem .header:hover\n            {\n                cursor: grab;\n            }\n            .header > span\n            {\n                position: relative;\n                float: right;\n                margin-right: 3px;\n            }\n            .listItem > div:first-child .header\n            {\n                padding-right: 30px;\n            }\n                #togglePop\n                {\n                    cursor: pointer;\n                }\n                span > .popmenu\n                {\n                    position: absolute;\n                    float: left;\n                    top: 20px;\n                    right: 18px;\n                    width: 150px;\n\n                    font-size: 10px;\n                    line-height: 32px;\n\n                    background-color: rgb(255, 255, 255, 1);\n                    box-shadow: 0px 0px 30px -10px grey;\n\n                    display: flex;\n                    flex-direction: column;\n\n                    max-height: 0vh;\n                    max-width: 0vh;\n                    overflow: hidden;\n                    white-space: nowrap;\n                    text-overflow: ellipsis;\n\n                    transition-duration: 100ms;\n                }\n                    #togglePop.show > .popmenu\n                    {\n                        max-height: 30vh;\n                        max-width: 100vh;\n\n                        transition-duration: 1000ms;\n                    }\n                    .popmenu > a\n                    {\n                        padding: 0px 10px;\n                    }\n                    .popmenu > a:hover\n                    {\n                        background-color: rgb(240, 240, 240, 1); \n                    }\n\n    /* Borger */\n    .listItem > div:first-child\n    {\n        flex-grow: 0;\n        background-color: #DDDEFE;\n        padding-bottom: 8px;\n    }\n        .listItem > div:first-child > .cpr\n        {\n            padding: 15px 18px;\n            font-size: 17px;\n            font-weight: 400;\n            letter-spacing: 0.3px;\n        }\n        .listItem > div:first-child > .sag\n        {\n            padding: 4px 14px;\n            background: rgb(1, 1, 1, 0.04);\n            margin-bottom: 2px;\n\n            text-transform: uppercase;\n            font-family: 'Roboto';\n            line-height: 18px;\n            font-size: 10px;\n            letter-spacing: 0.45px;\n        }\n            .sag > span\n            {\n                font-size: 17px;\n            }\n            .sag.findes\n            {\n                color: #46a114;\n                font-weight: 400;\n            }\n            .sag.findes-ikke\n            {\n                color: #a15814;\n                font-weight: 400;\n            }\n        .listItem > div:first-child > .persondata\n        {\n            display: flex;\n            flex-wrap: wrap;\n            justify-content: space-evenly;\n\n            padding: 9px 0px;\n            width: 98%;\n        }\n            .listItem > div:first-child > .persondata > div\n            {\n                text-align: center;\n                min-width: 30%;\n                font-family: 'Roboto';\n            }\n    \n\n    /* Faktura + Handlinger */\n    .listItem > div:last-child\n    {\n        flex-grow: 1;\n        justify-self: stretch;\n\n        display: flex;\n        flex-direction: column;\n\n        min-width: 600px;\n    }\n\n        .listItem > div:last-child > .faktura\n        {\n            background-color: #FEFEF3;\n\n            margin-left: -18px;\n            margin-top: -5px;\n            margin-right: -5px;\n\n            padding-bottom: 8px;\n\n            border: 5px solid #a8a8a8;\n        }\n            .listItem > div:last-child > .faktura > div:not(.header)\n            {\n                padding: 8px 14px;\n            }\n            .listItem > div:last-child > .faktura > .ydelse\n            {\n                display: flex;\n                align-items: flex-end;\n                gap: 10px;\n            }\n                /* Sm overskrifter */\n                .listItem > div:last-child > .faktura > .ydelse span, .listItem > div:first-child > .persondata > div > span\n                {\n                    text-transform: uppercase;\n                    font-family: 'Roboto';\n                    font-size: 9px;\n                    color: rgb(159, 159, 159);\n                }\n                .listItem > div:last-child > .faktura > .ydelse > .titel\n                {\n                    flex-grow: 1;\n                }\n                .listItem > div:last-child > .faktura > .ydelse > div:not(.titel)\n                {\n                    text-align: right;\n                }\n                    .listItem > div:last-child > .faktura > .ydelse > div > div\n                    {\n                        margin-top: 8px;\n                    }\n\n        .listItem > div:last-child > .handling\n        {\n            background-color: #F9E1DD;\n            display: flex;\n\n            margin-bottom: 5px;\n            border-left: 5px solid #a8a8a8;\n            margin-right: 18px;\n        }\n            .listItem > div:last-child > .handling > div:not(.header)\n            {\n                line-height: 38px;\n                padding-left: 12px;\n            }\n\n/* Ghost */\n.ghost\n{\n    position: absolute;\n    pointer-events: none;\n    z-index: 10;\n\n    opacity: 0;\n    scale: 0.8;\n}\n.ghost.visible \n{\n    opacity: 0.65;\n}",
        "output": "str",
        "x": 870,
        "y": 1940,
        "wires": [
            [
                "995fb8f2b8f0fd58"
            ]
        ]
    },
    {
        "id": "5939609dd7538821",
        "type": "template",
        "z": "8ea344595d9a442a",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\" dir=\"ltr\">\n  <head>\n    <meta charset=\"utf-8\">  \n    <title>Regler</title>\n    <style>{{{payload.style}}}</style>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <!-- Iconscout Link For Icons -->\n    <link rel=\"stylesheet\" href=\"https://unicons.iconscout.com/release/v4.0.0/css/line.css\">\n  </head>\n  <body onload=\"wsConnect();\" onunload=\"ws.disconnect();\" id=\"body\">\n\n    <div id=\"main\">\n\n      <div class=\"contentBox login\">\n        <div class=\"header\">WorkLet login</div>\n        <div class=\"wrapper\">\n          <div>\n            <div class=\"w50\">\n              <span>E-mail adresse</span><br />\n              <input id=\"WorkLetEmail\" />\n            </div>\n            <div class=\"w50\">\n              <span>Kodeord</span><br />\n              <input id=\"WorkLetPass\" type=\"password\" />\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      <div class=\"contentBox approve\" id=\"approveLogin\">\n        <div class=\"wrapper\">\n          <div>\n            <input type=\"checkbox\" id=\"acceptLogin\" name=\"acceptLogin\" value=\"true\">\n            <label for=\"acceptLogin\" class=\"no-select\" id=\"acceptLoginLabel\">Godkend loginoplysninger</label>\n          </div>\n        </div>\n      </div>\n\n\n\n\n      <div class=\"contentBox rules hidden\">\n        <div class=\"header\">Regler</div>\n        <div class=\"subheader\">Systemregler</div>\n        <div class=\"wrapper ruleWrapper_system\"></div>\n        <div class=\"subheader\">Brugerregler</div>\n        <div class=\"wrapper ruleWrapper_user\"></div>\n      </div>\n\n      <div class=\"contentBox approve hidden\" id=\"approveRules\">\n        <div class=\"wrapper\">\n          <div>\n            <input type=\"checkbox\" id=\"acceptRules\" name=\"acceptRules\" value=\"true\">\n            <label for=\"acceptRules\" class=\"no-select\" id=\"acceptRulesLabel\">Godkend regelst</label>\n          </div>\n        </div>\n      </div>\n\n      \n\n\n      <div class=\"contentBox actions hidden\">\n        <div class=\"header\">Tilskudsberegning</div>\n        <div class=\"subheader\">Anbefalede handlinger</div>\n        <div class=\"actionList\">\n          <div id=\"wrappedStartButton\">\n            <input type=\"checkbox\" id=\"startRun\" name=\"startRun\" value=\"true\">\n            <label for=\"startRun\" class=\"no-select\" id=\"startRunLabel\">Start beregning</label>\n          </div>\n        </div>\n      </div>\n\n    </div>\n\n    <script>\n      const _rules = {{{payload.rules}}}\n\n      /* RULES */\n\n      {{{payload.scripts.rules}}}\n\n      /* UI */\n\n      {{{payload.scripts.ui}}}\n    </script>\n\n  </body>\n</html>",
        "x": 1410,
        "y": 1840,
        "wires": [
            [
                "78a498d6a82a151b"
            ]
        ]
    },
    {
        "id": "995fb8f2b8f0fd58",
        "type": "template",
        "z": "8ea344595d9a442a",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\" dir=\"ltr\">\n\n<head>\n  <meta charset=\"utf-8\">\n  <title>Tilskudsberegning</title>\n\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <!-- Iconscout Link For Icons -->\n  <link rel=\"stylesheet\" href=\"https://unicons.iconscout.com/release/v4.0.0/css/line.css\">\n  <link rel=\"stylesheet\" href=\"https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css\">\n  <style>\n    {{{payload.style}}}\n  </style>\n</head>\n\n<body>\n\n  <div class=\"ghost listItem\">\n    <div></div>\n  </div>\n\n  <div class=\"menu\">\n\n    <div class=\"menuItem green selected\" id=\"anbefalede_handlinger\" onmouseup=\"dropZone(this)\">\n      <div>\n        <div style=\"height: 70%;\"><span>70<span>%</span></span></div>\n      </div>\n      <div>Anbefalede<br />handlinger</div>\n    </div>\n\n    <div class=\"menuItem red\" id=\"usikre_handlinger\" onmouseup=\"dropZone(this)\">\n      <div>\n        <div style=\"height: 10%;\"><span>10<span>%</span></span></div>\n      </div>\n      <div>Usikre<br />handlinger</div>\n    </div>\n\n    <div class=\"menuItem yellow\" id=\"manuel_behandling\" onmouseup=\"dropZone(this)\">\n      <div>\n        <div style=\"height: 20%;\"><span>20<span>%</span></span></div>\n      </div>\n      <div>Manuel<br />behandling</div>\n    </div>\n\n  </div><!-- /menu -->\n\n  <div class=\"main\">\n\n    <div class=\"itemList\">\n\n\n    </div><!-- /itemList -->\n\n  </div><!-- /main -->\n\n  <script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js\"></script>\n  <script src=\"https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js\"></script>\n  <script>\n    {{{payload.script}}}\n  </script>\n\n\n</body>\n\n</html>",
        "x": 1030,
        "y": 1940,
        "wires": [
            [
                "114ab13434d5aba2"
            ]
        ]
    },
    {
        "id": "fb217fc355c8774a",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "displayingResults",
        "propertyType": "flow",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 250,
        "y": 1940,
        "wires": [
            [
                "98495774d5f7029f"
            ],
            [
                "499cd9ebcec444da"
            ]
        ]
    },
    {
        "id": "ce947c0f871d1233",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "displayingResults",
                "pt": "flow",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1910,
        "y": 1400,
        "wires": [
            [
                "b1559f9d4a7c3f92"
            ]
        ]
    },
    {
        "id": "105fdc1f39bd2266",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "name": "Reset UI",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 140,
        "y": 720,
        "wires": [
            [
                "832ab7b9a8489a23"
            ]
        ]
    },
    {
        "id": "832ab7b9a8489a23",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "displayingResults",
                "pt": "flow",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 350,
        "y": 720,
        "wires": [
            []
        ]
    },
    {
        "id": "98495774d5f7029f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "results",
                "pt": "msg",
                "to": "results",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 1940,
        "wires": [
            [
                "f62ad6d5da3e6f12"
            ]
        ]
    },
    {
        "id": "f62ad6d5da3e6f12",
        "type": "json",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "results",
        "action": "str",
        "pretty": false,
        "x": 590,
        "y": 1940,
        "wires": [
            [
                "cda18253f37bd8d8"
            ]
        ]
    },
    {
        "id": "cda18253f37bd8d8",
        "type": "template",
        "z": "8ea344595d9a442a",
        "name": "JS",
        "field": "payload.script",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "\n    const results = {{{results}}};\n\n    //const resultObj = JSON.parse(results);\n    var itemList = document.querySelector('.itemList');\n    itemList.innerHTML = \"\";\n\n    for(let i = 0;i < results.length;i++)\n    {\n        itemList.innerHTML += printObject(i);\n    }\n\n    function printObject(index)\n    {        \n        let obj = results[index];\n        \n        let returnStr = `\n        <div class=\"listItem\" id=\"listItem_${index}\">\n        <div>\n\n          <div class=\"header\" onmousedown=\"dragItem('listItem_${index}')\">\n            Borger\n            <span class=\"uil uil-ellipsis-h\" id=\"togglePop\" onclick=\"togglePop(this)\">\n                        <div class=\"popmenu show\">\n                            <a href=\"#\">G til borger i KP</a>\n                        </div>\n                        </span>\n          </div>\n          <div class=\"cpr\">${obj.cpr}</div>\n\n          <div class=\"sag findes${obj.persondata.bevilling ? '' : '-ikke'}\"><span class=\"uil uil-${obj.persondata.bevilling ? 'check' : 'times'}\"></span> Bevilget fodpleje</div>\n          <div class=\"sag findes${obj.persondata.udvidetHelbredstillaeg ? '' : '-ikke'}\"><span class=\"uil uil-${obj.persondata.udvidetHelbredstillaeg ? 'check' : 'times'}\"></span> Udvidet helbredstillg</div>\n          <div class=\"sag findes${obj.persondata.almHelbredstillaeg ? '' : '-ikke'}\"><span class=\"uil uil-${obj.persondata.almHelbredstillaeg ? 'check' : 'times'}\"></span> Alm. helbredstillg</div>\n          <div class=\"sag findes${obj.persondata.helbredskort ? '' : '-ikke'}\"><span class=\"uil uil-${obj.persondata.helbredskort ? 'check' : 'times'}\"></span> Helbredskort</div>\n\n          <div class=\"persondata\">\n            <div>\n              <span>Danmark</span><br />\n              ${obj.persondata.danmarkgruppe != 0 ? ('Gruppe ' + obj.persondata.danmarkgruppe) : 'Ej medlem'}\n            </div>\n\n            <div>\n              <span>Formue</span><br />\n              ${obj.persondata.formue} kr\n            </div>\n\n            <div>\n              <span>Tillgsprocent</span><br />\n              ${obj.persondata.helbredstillaegsprocent[0].tillaegsprocent}%\n            </div>\n          </div>\n\n        </div>\n        <div>\n\n          <div class=\"faktura\">\n\n            <div class=\"header\" onmousedown=\"dragItem('listItem_${index}')\">\n              Faktura\n              <span class=\"uil uil-ellipsis-h\" id=\"togglePop\" onclick=\"togglePop(this)\">\n                            <div class=\"popmenu show\">\n                                <a href=\"#\">Se faktura i WorkLet</a>\n                            </div>\n                            </span>\n            </div>\n\n            <div class=\"ydelse\">\n              <div>\n                <span>#</span>`;\n\n      if (Array.isArray(obj.faktura.behandlinger))\n        for(let i = 0;i < obj.faktura.behandlinger.length;i++)\n          returnStr += `<div>${obj.faktura.behandlinger[i].ydelsesnummer}</div>`;\n      else\n        returnStr += `<div>${obj.faktura.behandlinger.ydelsesnummer}</div>`;\n        \n              \n        returnStr += `\n              </div>\n              <div class=\"titel\">\n                <span>Ydelse</span>`;\n\n      if (Array.isArray(obj.faktura.behandlinger))\n        for (let i = 0; i < obj.faktura.behandlinger.length; i++)\n          returnStr += `<div>${obj.faktura.behandlinger[i].titel}</div>`;\n      else\n        returnStr += `<div>${obj.faktura.behandlinger.titel}</div>`;\n\n        returnStr += `\n              </div>\n              <div>\n                <span>Sygesikringsandel</span>`;\n\n      if (Array.isArray(obj.faktura.behandlinger))\n        for (let i = 0; i < obj.faktura.behandlinger.length; i++)\n          returnStr += `<div>${obj.faktura.behandlinger[i].sygesikringsAndel}</div>`;\n      else\n        returnStr += `<div>${obj.faktura.behandlinger.sygesikringsAndel}</div>`;\n\n        returnStr += `\n              </div>\n              <div>\n                <span>Patientandel</span>`;\n\n      if (Array.isArray(obj.faktura.behandlinger))\n        for (let i = 0; i < obj.faktura.behandlinger.length; i++)\n          returnStr += `<div>${obj.faktura.behandlinger[i].patientAndel}</div>`;\n      else\n        returnStr += `<div>${obj.faktura.behandlinger.patientAndel}</div>`;\n\n        returnStr += `\n              </div>\n              <div>\n                <span>Honorar</span>`;\n\n      if (Array.isArray(obj.faktura.behandlinger))\n        for (let i = 0; i < obj.faktura.behandlinger.length; i++)\n          returnStr += `<div>${obj.faktura.behandlinger[i].pris}</div>`;\n      else\n        returnStr += `<div>${obj.faktura.behandlinger.pris}</div>`;\n\n      returnStr += `\n            </div>\n          </div>\n\n        </div>\n        `;\n\n      if (Array.isArray(obj.handlinger))\n        for (let i = 0; i < obj.handlinger.length; i++)\n        {\n          returnStr += `<div class=\"handling\">\n\n            <div class=\"header\">Handling</div>\n            <div>${obj.handlinger[i].handling}</div>\n\n          </div>`;\n        }\n      else if (typeof obj.handlinger == \"object\")\n      {\n        returnStr += `<div class=\"handling\">\n\n            <div class=\"header\">Handling</div>\n            <div>${obj.handlinger.handling}</div>\n\n          </div>`;\n      }\n\n      returnStr += `\n        </div>\n        </div><!-- /listItem -->\n        `;\n\n        return returnStr;\n\n    }\n\n\n    function togglePop(element)\n    {\n        element.classList.toggle(\"show\");\n    }\n\n\n    const menuElements = document.getElementsByClassName(\"menuItem\");\n    const listElements = document.getElementsByClassName(\"listItem\");\n\n    var currentDraggedElement = null;\n\n    function dragItem(itemId)\n    {\n        var item = document.getElementById(itemId);\n        currentDraggedElement = item;\n\n        let itemX = item.offsetLeft;\n        let itemY = item.offsetTop;\n        //console.log(\"Item pos: [\" + itemX + \", \" + itemY + \"]\");\n        //console.log(\"Mouse pos: [\" + mouseX + \", \" + mouseY + \"]\");\n        //console.log(\"Offset: [\" + (itemX-mouseX) + \", \" + (itemY-mouseY) + \"]\");\n\n        offsetX = (itemX-mouseX);\n        offsetY = (itemY-mouseY) - 25;\n    }\n\n    function dropZone(zone)\n    {\n        if(currentDraggedElement == null)\n            return;\n        \n        console.log(\"Item '\" + currentDraggedElement.id + \"' was dropped into zone '\" + zone.id + \"'\");\n        \n        clearGhost();\n    }\n\n\n\n    var ghostObject = null;\n    const ghost = document.querySelector('.ghost');\n\n    function createGhostObject(item)\n    {\n        ghostObject = item;\n        ghost.innerHTML = ghostObject.innerHTML;\n        ghost.style = ghostObject.style;\n        ghost.style.marginLeft = offsetX + \"px\";\n        ghost.style.marginTop = offsetY + \"px\";\n        ghost.classList.add(\"visible\");\n\n        item.style.opacity = 0.6;\n\n        document.querySelector('body').style.cursor = \"grabbing\";\n    }\n\n    var mouseX, mouseY;\n    var offsetX, offsetY;\n    document.addEventListener('mousemove', function(e)\n    {            \n        let left = mouseX = e.pageX;\n        let top = mouseY = e.pageY;\n\n        if(currentDraggedElement == null)\n            return;\n\n        if(ghostObject == null)\n            createGhostObject(currentDraggedElement);\n\n        ghost.style.left = left + 'px';\n        ghost.style.top = top + 'px';\n    });\n\n    document.addEventListener('mouseup', function(e)\n    {\n        if(currentDraggedElement == null)\n            return;\n        clearGhost();\n    });\n\n    function clearGhost()\n    {\n        currentDraggedElement.style.opacity = 1;\n        currentDraggedElement = null;\n\n        ghostObject = null;            \n        ghost.innerHTML = \"\";\n        ghost.classList.remove(\"visible\");\n\n        document.querySelector('body').style.cursor = \"auto\";\n        //ghost.style = null;\n    }",
        "output": "str",
        "x": 730,
        "y": 1940,
        "wires": [
            [
                "782f6a476e9a630b"
            ]
        ]
    },
    {
        "id": "b0fc3381ab70ecfb",
        "type": "credentials",
        "z": "8ea344595d9a442a",
        "name": "",
        "props": [
            {
                "value": "workletUser",
                "type": "msg"
            },
            {
                "value": "workletPass",
                "type": "msg"
            }
        ],
        "x": 505,
        "y": 220,
        "wires": [
            [
                "9ae5a9e08a7d7dc3"
            ]
        ],
        "l": false
    },
    {
        "id": "99963e2324c780db",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "27007b43e1b2750d",
        "name": "MSG",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1270,
        "y": 220,
        "wires": []
    },
    {
        "id": "9ae5a9e08a7d7dc3",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "7de50fe1369c94a7",
        "name": "Definr tilskudsperioder",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t      \"periode_fra\": \"2022-10-01\",\t      \"periode_til\": \"2023-04-01\",\t      \"satser\": [\t        {\t          \"tilskud_maxdkk\": 24,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Journaloptagelse\"\t        },\t        {\t          \"tilskud_maxdkk\": 24,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Kontrol og/eller eftersyn\"\t        },\t        {\t          \"tilskud_maxdkk\": 111,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandlingsydelse C\"\t        },\t        {\t          \"tilskud_maxdkk\": 81,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Frste fodstatus (nyhenvist patient)\"\t        },\t        {\t          \"tilskud_maxdkk\": 66,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fodstatus\"\t        },\t        {\t          \"tilskud_maxdkk\": 55,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fodstatus ved samtidig anden behandling\"\t        },\t        {\t          \"tilskud_maxdkk\": 25,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Opdatering af fodstatus ved skift i risikogruppe\"\t        },\t        {\t          \"tilskud_maxdkk\": 66,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandlingsydelse A\"\t        },\t        {\t          \"tilskud_maxdkk\": 100,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandlingsydelse B\"\t        },\t        {\t          \"tilskud_maxdkk\": 200,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlg - type 1, enkelt\"\t        },\t        {\t          \"tilskud_maxdkk\": 400,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlg - type 1, par\"\t        },\t        {\t          \"tilskud_maxdkk\": 200,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlg - type 2, enkelt\"\t        },\t        {\t          \"tilskud_maxdkk\": 400,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlg - type 2, par\"\t        },\t        {\t          \"tilskud_maxdkk\": 200,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlg - type 3, enkelt\"\t        },\t        {\t          \"tilskud_maxdkk\": 400,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlg - type 3, par\"\t        },\t        {\t          \"tilskud_maxdkk\": 125,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Tilretning af indlg\"\t        },\t        {\t          \"tilskud_maxdkk\": 24,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandling fr pstning af 1 ny bjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 72,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fremstilling og pstning af 1 ny bjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fremstilling og pstning af bjler udover 1\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Korrektion af 1 bjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 72,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Korrektion af 2 bjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 96,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Korrektion af op til 10 bjler incl.\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Ortheser\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Ortheser fremstilet af sislicone\"\t        },\t        {\t          \"tilskud_maxdkk\": 55,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Srbehandling\"\t        },\t        {\t          \"tilskud_maxdkk\": 44,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Srbehandling ved anden samtidig behandling\"\t        },\t        {\t          \"tilskud_maxdkk\": 100,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Behandling uden tilskud\"\t        },\t        {\t          \"tilskud_maxdkk\": 0,\t          \"tilskud_procent\": 0,\t          \"titel\": \"Afstandstillg uden tilskud\"\t        }\t      ]\t    }",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 710,
        "y": 220,
        "wires": [
            [
                "64156b428449f87a"
            ]
        ],
        "info": "## Define grants from Danmark\r\nThis change node defines an array of relevant grant periods from Health Insurance Danmark.\r\nEach period, contained in a separate object, is structured as such:\r\n\r\n`{\r\n      \"periode_fra\": \"2022-10-01\",\r\n      \"periode_til\": \"2023-04-01\",\r\n      \"satser\": [\r\n        {\r\n          \"tilskud_maxdkk\": 24,\r\n          \"tilskud_procent\": 80,\r\n          \"titel\": \"Journaloptagelse\"\r\n        }\r\n      ]\r\n}`\r\n\r\nCurrent grant rates can be found at https://www.sygeforsikring.dk/tilskud/fodbehandling "
    },
    {
        "id": "64156b428449f87a",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "7de50fe1369c94a7",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "tilskudsInfo",
                "pt": "msg",
                "to": "{\t    \"formuegraense\": 93000,\t    \"max_hjemmebehandling\": 280,\t    \"max_udekoersel\": 300,\t    \"danmark_fratraek_procent\": 50,\t    \"danmark_fratraek_maxdkk\": 100,\t    \"tilskudsperioder\": payload\t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 855,
        "y": 220,
        "wires": [
            [
                "6dfadfada71732b7",
                "33dd3ef7921a86d1"
            ]
        ],
        "l": false,
        "info": "## Set grant info\r\nThis change node defines the remaining relevant grant information, and copies the grant periods set in last node."
    },
    {
        "id": "8b4e8bc5facd8f90",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "7de50fe1369c94a7",
        "name": "St tilskudsperioder fra Danmark",
        "info": "",
        "x": 730,
        "y": 180,
        "wires": []
    },
    {
        "id": "33dd3ef7921a86d1",
        "type": "change",
        "z": "8ea344595d9a442a",
        "d": true,
        "g": "27007b43e1b2750d",
        "name": "Hent datoer",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.lastRunDate",
                "pt": "msg",
                "to": "#:(storeInFile)::lastRunDate",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "payload.lastRunStartDate",
                "pt": "msg",
                "to": "#:(storeInFile)::lastRunStartDate",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1030,
        "y": 180,
        "wires": [
            [
                "a0a742c5ef2820f9"
            ]
        ],
        "info": "## Get dates\r\n\r\nThis change node gets the values for `lastRunDate` and `lastRunStartDate` from their respective global variables stored in file."
    },
    {
        "id": "4d958ad66bc2e40d",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "27007b43e1b2750d",
        "name": "Hent datoer for seneste krsel",
        "info": "",
        "x": 1080,
        "y": 140,
        "wires": []
    },
    {
        "id": "99f176272982a073",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "27007b43e1b2750d",
        "name": "Formatr dato",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$|\t{\t    \t    \"startDate\":\t        lastRunSuccess ? \t            lastRunDate\t            ~> $toMillis()\t            ~> $fromMillis('[D01]/[M01]/[Y0001]')\t        : \t            lastRunStartDate,\t\t    \"endDate\":\t        (( $now()\t        ~> $toMillis() )\t            - 86400000 )\t        ~> $fromMillis('[D01]/[M01]/[Y0001]')\t}\t|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "startDate",
                "pt": "msg",
                "to": "payload.startDate",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "endDate",
                "pt": "msg",
                "to": "payload.endDate",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1300,
        "y": 180,
        "wires": [
            [
                "2c5bfa6b7a2613ab"
            ]
        ],
        "info": "## Format dates\r\n\r\nThis change node utilizes JSONata to determine a new `startDate` and `endDate`. \r\n\r\nThe `startDate` is set depending on the boolean `lastRunSuccess`, and is set to `lastRunDate` if last run was successful. If not, it will set the `startDate` to the starting date of the last run `lastRunStartDate`.\r\nThe `endDate` is always set to yesterdays date - this allows future runs to always use the `lastRunDate` as `startDate`.\r\n\r\nIn both cases, the JSONata functions `$toMillis` and `$fromMillis` are first utilized format the date from `YY/MM/DD` (as stored in files) to `DD/MM/YY` (as used in WorkLet web interface). Then, they are used to calculate yesterdays date by retracting 86400000 miliseconds (24 hours) from todays date (`$now`)."
    },
    {
        "id": "a0a742c5ef2820f9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "27007b43e1b2750d",
        "name": "LastRunSuccess?",
        "rules": [
            {
                "t": "set",
                "p": "payload.lastRunStatusCode",
                "pt": "msg",
                "to": "#:(storeInFile)::statusCode",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "payload.lastRunSuccess",
                "pt": "msg",
                "to": "payload.lastRunStatusCode = 0 ? true : false",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1135,
        "y": 180,
        "wires": [
            [
                "99f176272982a073"
            ]
        ],
        "l": false,
        "info": "## LastRunSuccess?\r\nThis change node checks the global variable `statusCode` and sets the boolean variable `LastRunSuccess` to `true` if the status code is `0`, and otherwise to `false`."
    },
    {
        "id": "2c5bfa6b7a2613ab",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "27007b43e1b2750d",
        "name": "Find filnavn",
        "func": "const splitStartDate = msg.startDate.split(\"/\");\nconst splitEndDate = msg.endDate.split(\"/\");\n\nvar startDate = new Date(splitStartDate[2], splitStartDate[1] - 1, splitStartDate[0]);\nvar endDate = new Date(splitEndDate[2], splitEndDate[1] - 1, splitEndDate[0]);\n\n// define file name\nvar fileName = \"Kvitteringer-\" + startDate.toDateString().replace(splitStartDate[2], \"\").trimEnd()\n    + \"-\" + endDate.toDateString().replace(endDate.getFullYear().toString(), \"\").trimEnd();\n    \nfileName += \".json\";\n\nmsg.fileName = fileName;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1510,
        "y": 180,
        "wires": [
            [
                "99963e2324c780db",
                "28d8ac05e7f0f65f"
            ]
        ],
        "info": "## Define file name\r\nThis JS snippet utilizes the JavaScript date function `toDateString()` as well as some string manipulation to define the name of the JSON file which will be downloaded from Worklet web interface.\r\n\r\nThe name defined is later used to find and read the downloaded file, as the actual file name cannot be set when downloading, nor can it be retrieved as the download is in progress. Therefore, the name must be determined manually to match the naming procedure of Worklet web interface."
    },
    {
        "id": "df4e89fda20fa7db",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "27007b43e1b2750d",
        "name": "Bestem datoer for ny krsel",
        "info": "",
        "x": 1340,
        "y": 140,
        "wires": []
    },
    {
        "id": "6dfadfada71732b7",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "27007b43e1b2750d",
        "name": "TEST DATA",
        "rules": [
            {
                "t": "set",
                "p": "fileName",
                "pt": "msg",
                "to": "Kvitteringer-Thu Nov 17-Sun Nov 20.json",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "startDate",
                "pt": "msg",
                "to": "17/11/2022",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "endDate",
                "pt": "msg",
                "to": "20/11/2022",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1030,
        "y": 220,
        "wires": [
            [
                "99963e2324c780db",
                "28d8ac05e7f0f65f"
            ]
        ]
    },
    {
        "id": "498c7b97ae4b4d58",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Skab JSON filnavn",
        "info": "",
        "x": 2650,
        "y": 540,
        "wires": []
    },
    {
        "id": "28d8ac05e7f0f65f",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Findes filen?",
        "func": "const fs = global.get('fs');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\nmsg.filePath = downloadPath + \"\\\\\" + msg.fileName;\n\nif (fs.existsSync(msg.filePath))\n{\n    msg.payload = true;\n    node.status({ fill: \"green\", shape: \"dot\", text: \"Fil blev fundet\" });\n}\nelse\n{\n    msg.payload = false;\n    node.status({ fill: \"yellow\", shape: \"dot\", text: \"Fil blev ikke fundet!\" });\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 730,
        "y": 440,
        "wires": [
            [
                "bc7b13ac2323540b"
            ]
        ],
        "info": "## Check for file\r\nThis JS snippet utilizes global modules `FS` and `Path` to check if the receipt JSON file already exists, or needs to be downloaded."
    },
    {
        "id": "bc7b13ac2323540b",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 845,
        "y": 440,
        "wires": [
            [
                "144d6812d5213472"
            ],
            [
                "d97f7bbbe0210f54"
            ]
        ],
        "l": false,
        "info": "## Check for file - switch\r\nThis switch, which succeeds the JS snippet which determines receipt file existance, is used to skip the download of receipts if they already exist (they shouldn't!)."
    },
    {
        "id": "4003aad4b2b6a9c8",
        "type": "file in",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Get JSON",
        "filename": "filePath",
        "filenameType": "msg",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 1650,
        "y": 420,
        "wires": [
            [
                "fa861baf7265d3be"
            ]
        ]
    },
    {
        "id": "fa861baf7265d3be",
        "type": "json",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Parse JSON",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 1755,
        "y": 420,
        "wires": [
            [
                "6558b47eb74e6c0c"
            ]
        ],
        "l": false
    },
    {
        "id": "8bc31d06862e8fe2",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Delete JSON",
        "func": "const fs = global.get('fs');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\nmsg.filePath = downloadPath + \"\\\\\" + msg.fileName;\n\nfs.unlinkSync(msg.filePath);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1930,
        "y": 400,
        "wires": [
            []
        ]
    },
    {
        "id": "d5a462980f4852cf",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Tjek om filen eksisterer",
        "info": "",
        "x": 760,
        "y": 400,
        "wires": []
    },
    {
        "id": "07d87534c4e0bbea",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Download fakturaliste",
        "info": "",
        "x": 1420,
        "y": 380,
        "wires": []
    },
    {
        "id": "c931f08e3a54e2f2",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Slet JSON",
        "info": "",
        "x": 1920,
        "y": 360,
        "wires": []
    },
    {
        "id": "6558b47eb74e6c0c",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "receipts",
                "pt": "msg",
                "to": "payload.kvitteringer",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1805,
        "y": 420,
        "wires": [
            [
                "07aa032e7944f93b",
                "d183f106c2e11bce"
            ]
        ],
        "l": false
    },
    {
        "id": "569d9f497b06babc",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Ls fakturaliste",
        "info": "",
        "x": 1660,
        "y": 380,
        "wires": []
    },
    {
        "id": "144d6812d5213472",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "St referencer",
        "rules": [
            {
                "t": "set",
                "p": "selectors",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.worklet",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.worklet.url",
                "pt": "msg",
                "to": "https://workletnew.snapp.dk/auth/sign-in",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.loginUser",
                "pt": "msg",
                "to": "input[name='username']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.loginPass",
                "pt": "msg",
                "to": "input[name='password']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.loginButton",
                "pt": "msg",
                "to": "button",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.datePickerFrom",
                "pt": "msg",
                "to": "[class='react-datepicker__input-container'] > input",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.datePickerActive",
                "pt": "msg",
                "to": "[class='react-datepicker-ignore-onclickoutside']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.datePickerTo",
                "pt": "msg",
                "to": "div:last-child > [class='react-datepicker__input-container'] > input",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.downloadButton",
                "pt": "msg",
                "to": "button[class='btn btn-primary btn-block primary-color']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.header",
                "pt": "msg",
                "to": "h1",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1020,
        "y": 420,
        "wires": [
            [
                "6a7f540f9f08ded4"
            ]
        ],
        "info": "## St referencer\r\n\r\nIn this change node, CSS selectors for Worklet web interface (https://workletnew.snapp.dk/) are set for use in the PupController JSON file."
    },
    {
        "id": "6a7f540f9f08ded4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Set pup commands",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "[\t    {\t        \"action\": \"launch\",\t        \"parameters\":\t        {\t            \"headless\": false,\t            \"slowMo\": 50,\t            \"ignoreHTTPSErrors\": true,\t            \"defaultViewport\": null\t        }\t    },\t\t    {\t        \"action\": \"goto\",\t        \"url\": selectors.worklet.url\t    },\t    \t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.loginUser,\t        \"input\": workletUser\t    },\t\t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.loginPass,\t        \"input\": workletPass\t    },\t    \t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.loginButton\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.datePickerFrom\t    },\t\t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.datePickerActive,\t        \"input\": startDate,\t        \"clear\": true\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.header\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.datePickerTo\t    },\t\t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.datePickerActive,\t        \"input\": endDate,\t        \"clear\": true\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.header\t    },\t\t    {\t        \"action\": \"click\",\t        \"isDownload\": true,\t        \"path\": selectors.worklet.downloadButton\t    },\t    {\t        \"action\": \"close\"\t    }\t    \t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1210,
        "y": 420,
        "wires": [
            [
                "15a1703b4a5286c7"
            ]
        ],
        "info": "## Set pup commands\r\n\r\nThis change node sets the automation flow JSON needed in PupController. The flow is hard-coded with variable references to the CSS selectors defined in the preceeding node."
    },
    {
        "id": "bb143ed21df0febf",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Klargr download af faktura ift. datoer",
        "info": "",
        "x": 1090,
        "y": 380,
        "wires": []
    },
    {
        "id": "07aa032e7944f93b",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "RECEIPTS",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "receipts",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1970,
        "y": 440,
        "wires": []
    },
    {
        "id": "15a1703b4a5286c7",
        "type": "subflow:41d1b8798efe7e15",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "",
        "x": 1420,
        "y": 420,
        "wires": [
            [
                "4003aad4b2b6a9c8"
            ],
            []
        ]
    },
    {
        "id": "bc99d7022f61a990",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Set selectors",
        "rules": [
            {
                "t": "set",
                "p": "selectors.kp",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.kp.url",
                "pt": "msg",
                "to": "https://fagsystem.kommunernespensionssystem.dk/",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.login",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.kp.login.select",
                "pt": "msg",
                "to": "[id=\"SelectedAuthenticationUrl\"]",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.login.button",
                "pt": "msg",
                "to": ".button",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.inputCPR",
                "pt": "msg",
                "to": "#search_box input",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.inputCPR_soegknap",
                "pt": "msg",
                "to": "#search_box button",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.personligtillaegsprocent",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(5) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.helbredstillaegsprocent_aabn",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(6) > td:nth-child(3) > div > div > span > span",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.helbredstillaegsprocent",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(6) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.danmarkgruppe",
                "pt": "msg",
                "to": "#person-oplysninger > tbody > tr:nth-child(6) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.personligtillaegsprocent_aabn",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(5) > td:nth-child(3) > div > div > span > span",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.tillaegsprocent",
                "pt": "msg",
                "to": "#history_table",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.tillaegsprocent_luk",
                "pt": "msg",
                "to": "#person-pension-fakta div.sc-gPEVay.ceKhsN > div.sc-jlyJG.NUpYs > svg",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.formue",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(4) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.sager",
                "pt": "msg",
                "to": "#person_overblik_sager_table",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.lukborger",
                "pt": "msg",
                "to": "svg.svg-inline--fa.fa-times.fa-w-11.fa-1x",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.bevilling",
                "pt": "msg",
                "to": "#app div.tab-content div.tab-content > div > div > div:nth-child(1) > div",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 830,
        "y": 700,
        "wires": [
            [
                "c2df29c07624e5e0"
            ]
        ]
    },
    {
        "id": "d183f106c2e11bce",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "citizens",
                "pt": "msg",
                "to": "$distinct(receipts@$A.(\t[\t    {\t        \"cpr\": $A.patientCPR\t    }\t]))",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 800,
        "y": 660,
        "wires": [
            [
                "bc99d7022f61a990"
            ]
        ]
    },
    {
        "id": "c2df29c07624e5e0",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Set pup commands",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "[\t    {\t        \"action\": \"launch\",\t        \"parameters\":\t        {\t            \"headless\": false,\t            \"slowMo\": 50,\t            \"ignoreHTTPSErrors\": true,\t            \"defaultViewport\": null\t        }\t    },\t   {\t       \"action\": \"goto\",\t       \"url\": \"https://fagsystem.kommunernespensionssystem.dk/\"\t\t},\t   {\t       \"action\": \"select\",\t       \"path\": \"[id=\\\"SelectedAuthenticationUrl\\\"]\",\t       \"input\": \"Randers Kommune\"\t\t},\t   {\t       \"action\": \"click\",\t       \"path\": \".button\"\t\t}\t]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$append(payload, citizens@$A.(\t   [\t       {\t           \"action\": \"type\",\t           \"input\": $A.cpr,\t           \"path\": selectors.kp.inputCPR\t\t},\t       {\t           \"action\": \"click\",\t           \"path\": selectors.kp.inputCPR_soegknap\t\t},\t       {\t           \"action\": \"click\",\t           \"path\": selectors.kp.citizen.personligtillaegsprocent_aabn\t\t},\t       {\t           \"action\": \"get\",\t           \"name\": \"personligtillaegsprocent\",\t           \"path\": selectors.kp.citizen.tillaegsprocent,\t           \"obj\": $A.cpr\t\t},\t       {\t           \"action\": \"click\",\t           \"path\": selectors.kp.citizen.tillaegsprocent_luk\t\t},\t{\t    \"action\": \"click\",\t    \"path\": selectors.kp.citizen.helbredstillaegsprocent_aabn\t\t},\t{\t    \"action\": \"get\",\t    \"name\": \"helbredstillaegsprocent\",\t    \"path\": selectors.kp.citizen.tillaegsprocent,\t    \"obj\": $A.cpr\t\t},\t{\t    \"action\": \"click\",\t    \"path\": selectors.kp.citizen.tillaegsprocent_luk\t\t},\t       {\t           \"action\": \"get\",\t           \"name\": \"bevilling\",\t           \"path\": selectors.kp.citizen.bevilling,\t           \"obj\": $A.cpr\t\t},\t       {\t           \"action\": \"get\",\t           \"name\": \"sager\",\t           \"path\": selectors.kp.citizen.sager,\t           \"obj\": $A.cpr\t\t},\t       {\t           \"action\": \"get\",\t           \"name\": \"danmarkgruppe\",\t           \"path\": selectors.kp.citizen.danmarkgruppe,\t           \"obj\": $A.cpr\t\t},\t       {\t           \"action\": \"get\",\t           \"name\": \"formue\",\t           \"path\": selectors.kp.citizen.formue,\t           \"obj\": $A.cpr\t\t},\t        {\t            \"action\": \"click\",\t            \"path\": selectors.kp.citizen.lukborger\t}\t\t\t]\t))",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$append(payload,\t{\t    \"action\": \"close\"\t}\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1050,
        "y": 660,
        "wires": [
            [
                "c8857f0a61f8c92e",
                "86c8180e0274bc8b"
            ]
        ]
    },
    {
        "id": "c8857f0a61f8c92e",
        "type": "subflow:41d1b8798efe7e15",
        "z": "8ea344595d9a442a",
        "d": true,
        "g": "9c4f3569ebca5f7b",
        "name": "",
        "x": 1360,
        "y": 660,
        "wires": [
            [
                "70ade91971d73d3b"
            ],
            []
        ]
    },
    {
        "id": "0df1e3c807393a69",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Klargr lsning af persondata fra KP",
        "info": "",
        "x": 1110,
        "y": 620,
        "wires": []
    },
    {
        "id": "573bc9a19cb2a144",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Ls CPR fra faktura",
        "info": "",
        "x": 810,
        "y": 620,
        "wires": []
    },
    {
        "id": "70ade91971d73d3b",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "citizens",
                "pt": "msg",
                "to": "pupOutputs",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1620,
        "y": 660,
        "wires": [
            [
                "81a00971b2ea464e",
                "172fe34eeccca8dd"
            ]
        ]
    },
    {
        "id": "81a00971b2ea464e",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Borgerliste debug",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "citizens",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1710,
        "y": 700,
        "wires": []
    },
    {
        "id": "3691fee0bd5cd7bc",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Ls persondata",
        "info": "",
        "x": 1360,
        "y": 620,
        "wires": []
    },
    {
        "id": "5c03893a530479bb",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Gem data i midlertidig hukommelse",
        "info": "",
        "x": 1680,
        "y": 620,
        "wires": []
    },
    {
        "id": "86c8180e0274bc8b",
        "type": "credentials",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "testdata",
        "props": [
            {
                "value": "pupOutputs",
                "type": "msg"
            }
        ],
        "x": 1340,
        "y": 700,
        "wires": [
            [
                "402de4b110655edc"
            ]
        ]
    },
    {
        "id": "402de4b110655edc",
        "type": "json",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "",
        "property": "pupOutputs",
        "action": "",
        "pretty": false,
        "x": 1435,
        "y": 700,
        "wires": [
            [
                "70ade91971d73d3b"
            ]
        ],
        "l": false
    },
    {
        "id": "c9e0c48929946d68",
        "type": "function",
        "z": "8ea344595d9a442a",
        "name": "Hent eller definr liste med behandlede faktura",
        "func": "//msg.payload = [msg.currentReceipt.antalYdelser];\nvar receipts = global.get(\"processedReceipts\", \"storeInFile\");\nif (typeof receipts != undefined && receipts != null)\n    msg.processedReceipts = receipts;\nelse\n    msg.processedReceipts = [];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 860,
        "wires": [
            [
                "4629d4bebfd2768f"
            ]
        ]
    },
    {
        "id": "4629d4bebfd2768f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Sammenst lister",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "/* Laver array med objekt for hver borger, og tilknytter fakturaer */\t\t$keys(citizens)@$k.{\t\t    \"cpr\": $k,\t    \"persondata\": $lookup(citizens, $k),\t    \"faktura\": receipts[$.patientCPR = $k]\t    \t}\t",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1130,
        "y": 860,
        "wires": [
            [
                "b01934ac82f070c3"
            ]
        ],
        "info": "https://try.jsonata.org/wRgtKDrKD"
    },
    {
        "id": "8a3db972f8fb7806",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "Transform debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2070,
        "y": 1060,
        "wires": []
    },
    {
        "id": "aea48540dc37e51c",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Saml borgere og fakturaer",
        "info": "https://try.jsonata.org/wRgtKDrKD",
        "x": 1150,
        "y": 820,
        "wires": []
    },
    {
        "id": "64bc816ed683fb56",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Personlig tillgsprocenter",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|(\t\t$tillaegsprocent_split := personligtillaegsprocent\t    ~> $replace(\"Personlig tillgsprocent\\tGyldig fra\\tGyldig til\\tAjourfringsdato\\n\", \"\")\t    ~> $split(\"\\n\");\t{\t\t\"personligtillaegsprocent\": $tillaegsprocent_split #$i .{\t\t    \"dato_fra\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[1]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"dato_til\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[2]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"tillaegsprocent\": ($t := (($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[0]\t        ~> $replace(\"%\", \"\")\t        ~> $replace(\"Ingen resultater fundet\", \"0\"));\t          ($t = \"\" ? 0 : $number($t)))\t    }\t\t}\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 710,
        "y": 1000,
        "wires": [
            [
                "78c4e4692985e738"
            ]
        ],
        "info": "https://try.jsonata.org/4J8IPRU83"
    },
    {
        "id": "b01934ac82f070c3",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Bevilget tilskud til fodpleje?",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|\t{\t\"bevilling\":\t    bevilling \t    ~> $contains(\"Bevilget tilskud til fodpleje\")\t}|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 720,
        "y": 960,
        "wires": [
            [
                "64bc816ed683fb56"
            ]
        ]
    },
    {
        "id": "31392fe7f3a93ccd",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Gr KP data maskinelt lsbart",
        "info": "",
        "x": 730,
        "y": 920,
        "wires": []
    },
    {
        "id": "141037f73383a9f6",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Tildel unikke behandlings-ID'er",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura |\t({\t\t\"behandlinger\": behandlinger @$b #$i .{\t\t    \"uid\": (id ~> $substring(19,17))\t            & \"-\" & $b.ydelsesnummer\t            & \"-\" & ($i+1),\t\t    \"titel\": $b.titel,\t    \"ydelsesnummer\": $b.ydelsesnummer,\t    \"behandlingsKategory\": $b.behandlingsKategory,\t    \"pris\": $b.pris,\t    \"krteKilometer\": $b.krteKilometer,\t    \"patientAndel\": $b.patientAndel,\t    \"sygesikringsAndel\": $b.sygesikringsAndel\t\t}\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1530,
        "y": 1020,
        "wires": [
            [
                "05096968ae22cc6f"
            ]
        ],
        "info": "https://try.jsonata.org/zbfWKbpM7"
    },
    {
        "id": "78c4e4692985e738",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Helbredstillgsprocenter",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|(\t\t$tillaegsprocent_split := helbredstillaegsprocent\t    ~> $replace(\"Helbredstillgsprocent\\tGyldig fra\\tGyldig til\\tAjourfringsdato\\n\", \"\")\t    ~> $split(\"\\n\");\t{\t\t\"helbredstillaegsprocent\": $tillaegsprocent_split #$i .{\t\t    \"dato_fra\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[1]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"dato_til\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[2]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"tillaegsprocent\": ($t := (($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[0]\t        ~> $replace(\"%\", \"\")\t        ~> $replace(\"Ingen resultater fundet\", \"0\"));\t          ($t = \"\" ? 0 : $number($t)))\t    }\t\t}\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 710,
        "y": 1040,
        "wires": [
            [
                "2cf375bbbada29f9"
            ]
        ],
        "info": "https://try.jsonata.org/4J8IPRU83"
    },
    {
        "id": "2cf375bbbada29f9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Sager",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|(\t\t$sager_split := sager\t    ~> $replace(\"\\n\", \"\")\t    ~> $replace(\"\\t\\t\", \"\\t\")\t    ~> $substringAfter(\"\\t\")\t    ~> $split(\"\\t\");\t{\t    \"sager\": $sager_split #$i .(\t\t        /* Hvis kolonne-antal ndrer sig, breaker denne kode */\t\t        $i % 5 = 0 and $i != 0 ?\t        {\t            \"titel\": $sager_split[$i],\t            \t            \"type\": $sager_split[$i+1],\t\t            \"fra\": $sager_split[$i+2]\t                ~> $toMillis('[D01]-[M01]-[Y0001]')\t                ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t            \"til\": $sager_split[$i+3]\t                ~> $toMillis('[D01]-[M01]-[Y0001]')\t                ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t            \"bevilling\": ($sager_split[$i+4] = \"Bevilget\")\t        })\t\t    }\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 650,
        "y": 1080,
        "wires": [
            [
                "12d9ffdfaf71a523"
            ]
        ],
        "info": "https://try.jsonata.org/4J8IPRU83"
    },
    {
        "id": "12d9ffdfaf71a523",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Formue",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|\t{\t    \"formue\": \t            formue = \"Ikke oplyst\" ?\t                null\t            :\t            formue = \"-\" ?\t                null\t            :\t                (formue\t                ~> $replace(\"-\", \"-1\")\t                ~> $split(\" \"))[0]\t                ~> $replace(\".\", \"\")\t                ~> $replace(\",\", \".\")\t                ~> $number()\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1080,
        "wires": [
            [
                "349a8caa82ed4d5e"
            ]
        ]
    },
    {
        "id": "349a8caa82ed4d5e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Danmark",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|\t(\t{\t    \"danmarkgruppe\": danmarkgruppe\t    ~> $replace(\"Ikke oplyst\", \"0\")\t    ~> $replace(\"Nej\", \"0\")\t    ~> $replace(\"Ja - Gruppe \", \"\")\t    ~> $replace(\"-\", \"0\")\t    ~> $number\t})\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1120,
        "wires": [
            [
                "ac8390885c3e684c"
            ]
        ]
    },
    {
        "id": "011d535e3ab60636",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Transformer faktura data (+ fjern undvendig data)",
        "info": "",
        "x": 1590,
        "y": 900,
        "wires": []
    },
    {
        "id": "71c55498ef71a4c9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Fjern undvendig data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.faktura|\t{},\t[\t    \"behandlerNavn\",\t    \"klinikNavn\",\t    \"klinikCVR\",\t    \"behandlerType\",\t    \"ydernummer\",\t    \"patientTelefon\"\t]\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1500,
        "y": 940,
        "wires": [
            [
                "6afaf8f1c596de67"
            ]
        ]
    },
    {
        "id": "6afaf8f1c596de67",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Fjern tidspunkt fra dato",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.faktura|\t{\t    \"dato\": (dato\t        ~> $split(\"T\"))[0]\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1500,
        "y": 980,
        "wires": [
            [
                "141037f73383a9f6"
            ]
        ]
    },
    {
        "id": "56b08e82f7715cf6",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Opret sager + ydelser",
        "info": "",
        "x": 1960,
        "y": 880,
        "wires": []
    },
    {
        "id": "5fac364d42a49277",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Beregn tilskud",
        "info": "",
        "x": 1990,
        "y": 960,
        "wires": []
    },
    {
        "id": "05096968ae22cc6f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Bestem behandlingstype",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura.behandlinger |\t({\t\t    \"type\": (titel = 'Behandlingipatientsegethjem' or titel = 'Behandlingpklinik') ? 'A' : 'B'\t\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1510,
        "y": 1060,
        "wires": [
            [
                "c3699e52d27c7f43"
            ]
        ],
        "info": "https://try.jsonata.org/zbfWKbpM7"
    },
    {
        "id": "c3699e52d27c7f43",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Tilfj sager + ydelser til handlinger",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$|(\t\t$faktura := faktura;\t\t$harBevilling := function($type)\t{\t    $type = \"A\" ?\t        $.persondata.bevilling\t    :\t        $.persondata.sager [ \t            type ~> $lowercase ~> $contains(\"helbredstillgskort\")\t        ] ?\t            true : false\t};\t\t$sagForeligger := function($type, $dato)\t{\t    $.persondata.sager [\t        $type = 'A' ?\t            type ~> $lowercase ~> $contains(\"udvidet helbred\")\t        and \t            titel ~> $lowercase ~> $contains(\"fod\")\t            :\t            type ~> $lowercase ~> $contains(\"almindeligt helbred\")\t    and\t        ($dato ~> $toMillis) > (fra ~> $toMillis)\t    and\t        (til ? ($dato ~> $toMillis) < (til ~> $toMillis) : true)\t    and\t        bevilling = true\t    ] ?\t        true : false\t};\t\t{\t    \"handlinger\": faktura.behandlinger @$b .(\t        $b := $b;\t\t        $sagForeligger($b.type, $faktura.dato) = false ?\t        $harBevilling($b.type) ? \t\t        [{\t            \"handling\": \"Opret sag\",\t            \"type\": $b.type\t        },\t        {\t            \"handling\": \"Tilfj ydelse\",\t            \"type\": $b.type,\t            \"uid\": $b.uid,\t            \"dato\": $faktura.dato\t        }]\t        : () : \t        {\t            \"handling\": \"Tilfj ydelse\",\t            \"type\": $b.type,\t            \"uid\": $b.uid,\t            \"dato\": $faktura.dato\t        }\t    )\t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2000,
        "y": 920,
        "wires": [
            [
                "422fe2162474cfee"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "422fe2162474cfee",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Beregn tilskud",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$|(\t\t$faktura := faktura;\t\t$tillaegsprocent := function($dato)\t{\t    $.persondata.helbredstillaegsprocent [\t        ($dato ~> $toMillis) > (dato_fra ~> $toMillis)\t    and\t        ($dato ~> $toMillis) < (dato_til ~> $toMillis)\t    ] /* .tillaegsprocent */\t};\t\t{\t    \"handlinger\": handlinger @$h .(\t        $h := $h;\t        {\t            \"handling\": $h.handling,\t            \"type\": $h.type,\t            \"uid\": $h.uid,\t            \"dato\": $h.dato,\t            \"tillaegsprocent\": $aktueltillaeg := $tillaegsprocent($h.dato)\t        }\t    )\t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2000,
        "y": 1000,
        "wires": [
            [
                "8a3db972f8fb7806",
                "da966ceeba7b23dd"
            ]
        ],
        "info": "https://try.jsonata.org/zbfWKbpM7"
    },
    {
        "id": "215c708ef9319356",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Hent regler fra global variabel",
        "rules": [
            {
                "t": "set",
                "p": "rules",
                "pt": "msg",
                "to": "#:(storeInFile)::rules",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1130,
        "y": 1000,
        "wires": [
            [
                "025bb676d906c835",
                "4c51b10755b92b07"
            ]
        ]
    },
    {
        "id": "c68d4ee2f02ada08",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Kontroller data ud fra regelst",
        "info": "",
        "x": 1120,
        "y": 960,
        "wires": []
    },
    {
        "id": "5d7e42be40e46699",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "MSG ERRORS",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "errors",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1420,
        "y": 1180,
        "wires": []
    },
    {
        "id": "025bb676d906c835",
        "type": "change",
        "z": "8ea344595d9a442a",
        "d": true,
        "name": "Tjek alle regler mod borgerdata",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "payload @$p.\t(\t$respectsRule := function($rule, $value)\t{\t    $rule.operator = \"!null\" ?\t        $value != null\t    :\t    $value = null ?\t        false\t    :\t    $rule.operator = \"<\" ?\t        $value < $rule.value\t    :\t    $rule.operator = \">\" ?\t        $value > $rule.value\t    :\t    $rule.operator = \"==\" ?\t        $value = $rule.value\t    :\t    $rule.operator = \"!=\" ?\t        $value != $rule.value\t    :\t    $rule.operator = \"contains\" ?\t        ($contains($string($rule.value), $string($value)))\t    :\t    $rule.operator = \"!contains\" ?\t        ($contains($string($rule.value), $string($value)) ? false : true)\t};\t{\t    \"borger\": $p.cpr,\t\t    \"regelbrud\":\t        rules @$r.\t        (\t            $respectsRule($r, $data := $lookup($p.persondata, $r.variable)) = false ?\t            {\t                \"regel\": $r.name,\t                \"beskrivelse\": $r.description,\t                \"persondata\": $data,\t                \"respekteres\": $respectsRule($r, $data)\t            }\t        ),\t\t    \"regelcheck\":\t        rules @$r.\t        (\t            {\t                \"regel\": $r.name,\t                \"beskrivelse\": $r.description,\t                \"persondata\": $data := $lookup($p.persondata, $r.variable),\t                \"respekteres\": $respectsRule($r, $data)\t            }\t        )\t}\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1130,
        "y": 1080,
        "wires": [
            [
                "5d7e42be40e46699"
            ]
        ]
    },
    {
        "id": "6ff2d0dc61ab8294",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "PAYLOAD",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1410,
        "y": 1280,
        "wires": []
    },
    {
        "id": "4c51b10755b92b07",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Tjek alle regler mod borgerdata",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "payload @$p.\t(\t$respectsRule := function($rule, $value)\t{\t    $rule.operator = \"!null\" ?\t        $value != null\t    :\t    $value = null ?\t        false\t    :\t    $rule.operator = \"<\" ?\t        $value < $rule.value\t    :\t    $rule.operator = \">\" ?\t        $value > $rule.value\t    :\t    $rule.operator = \"==\" ?\t        $value = $rule.value\t    :\t    $rule.operator = \"!=\" ?\t        $value != $rule.value\t    :\t    $rule.operator = \"contains\" ?\t        ($contains($string($rule.value), $string($value)))\t    :\t    $rule.operator = \"!contains\" ?\t        ($contains($string($rule.value), $string($value)) ? false : true)\t};\t{\t    \"borger\": $p.cpr,\t\t    \"regelbrud\":\t        rules @$r.\t        (\t            $respectsRule($r, $data := $lookup($p.persondata, $r.variable)) = false ?\t            {\t                \"regel\": $r.name,\t                \"beskrivelse\": $r.description,\t                \"persondata\": $data,\t                \"respekteres\": $respectsRule($r, $data)\t            }\t        )\t}\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1130,
        "y": 1120,
        "wires": [
            [
                "4e374431cb68ace4"
            ]
        ]
    },
    {
        "id": "4e374431cb68ace4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Find regelbrud",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "errors @$e.\t(\t    $e.regelbrud ~> $boolean ?\t    {\t        \"borger\": $e.borger,\t        \"regelbrud\": $e.regelbrud\t    }\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1080,
        "y": 1160,
        "wires": [
            [
                "5e112e4574f64f9b"
            ]
        ]
    },
    {
        "id": "5e112e4574f64f9b",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Fjern borgere som ikke er berettiget",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload @$p.\t(\t    \t    (errors[borger = $p.cpr] ~> $exists) = false ?\t    {\t        \"cpr\": $p.cpr,\t        \"persondata\": $p.persondata,\t        \"faktura\": $p.faktura\t    }\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1140,
        "y": 1200,
        "wires": [
            [
                "71c55498ef71a4c9"
            ]
        ]
    },
    {
        "id": "ac8390885c3e684c",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Kontroller sager",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|(\t\t$sagForeligger := function($type, $titel)\t{\t\t    sager[$type = 'A' ?\t            type ~> $lowercase ~> $contains($titel)\t        and \t            titel ~> $lowercase ~> $contains(\"fod\")\t            :\t            type ~> $lowercase ~> $contains($titel)] ?\t        true : false\t};\t\t{\t\t    \"udvidetHelbredstillaeg\": $sagForeligger('A', 'udvidet helbredstill'),\t    \"almHelbredstillaeg\": $sagForeligger('B', 'almindeligt helbredstill'),\t    \"helbredskort\": $sagForeligger('B', 'gskort')\t\t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 1200,
        "wires": [
            [
                "215c708ef9319356",
                "6ff2d0dc61ab8294"
            ]
        ]
    },
    {
        "id": "5e6c62c7505cca22",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "[E] Download fakturaer for den bestemte tidsperiode",
        "info": "",
        "x": 850,
        "y": 340,
        "wires": []
    },
    {
        "id": "d9efe549c9e470ea",
        "type": "inject",
        "z": "b5ae94617e862de8",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 180,
        "y": 220,
        "wires": [
            [
                "950036d6bc324dff"
            ]
        ]
    },
    {
        "id": "950036d6bc324dff",
        "type": "exec",
        "z": "b5ae94617e862de8",
        "command": "whoami",
        "addpay": "",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 380,
        "y": 220,
        "wires": [
            [
                "a88aa26fbc2fcca5"
            ],
            [],
            []
        ]
    },
    {
        "id": "a88aa26fbc2fcca5",
        "type": "change",
        "z": "b5ae94617e862de8",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "'chcp 865 && net user ' & (((payload ~> $split (\"\\\\\"))[1]) ~> $trim) & ' /domain' ~> $string",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 620,
        "y": 240,
        "wires": [
            [
                "5797f615d1a26b7c",
                "f68d90dde3e2af12",
                "6af1e24a409a4072"
            ]
        ]
    },
    {
        "id": "5797f615d1a26b7c",
        "type": "debug",
        "z": "b5ae94617e862de8",
        "name": "debug 8",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 940,
        "y": 280,
        "wires": []
    },
    {
        "id": "6af1e24a409a4072",
        "type": "exec",
        "z": "b5ae94617e862de8",
        "d": true,
        "command": "",
        "addpay": "payload",
        "append": "",
        "useSpawn": "false",
        "timer": "",
        "winHide": false,
        "oldrc": false,
        "name": "",
        "x": 610,
        "y": 400,
        "wires": [
            [
                "1453837efcc008b1"
            ],
            [],
            []
        ]
    },
    {
        "id": "1453837efcc008b1",
        "type": "function",
        "z": "b5ae94617e862de8",
        "name": "function 1",
        "func": "///let newBuff = new Buffer('New String');\n//let newbuff2 = Buffer.from(msg.payload);\nmsg.payload = msg.payload.toString();\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 400,
        "wires": [
            [
                "5797f615d1a26b7c"
            ]
        ]
    },
    {
        "id": "0c93a32f0629bfc6",
        "type": "change",
        "z": "b5ae94617e862de8",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "([adsi]\"WinNT://laksen04/dqa8932,user\").fullname",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 640,
        "y": 120,
        "wires": [
            []
        ]
    },
    {
        "id": "ddb7cad89dc8aba6",
        "type": "function",
        "z": "b5ae94617e862de8",
        "name": "function 3",
        "func": "var spawn = childProcess.spawn;\n\n\n//var cp = spawn(process.env.comspec, ['/c', 'command', '-arg1', '-arg2']);\n\n/*cp.stdout.on(\"data\", function(data) {\n    console.log(data.toString());\n});\n\ncp.stderr.on(\"data\", function(data) {\n    console.error(data.toString());\n});\nvar test = function(A)\n{\n    return \"js\";\n}\n\nconst func = childProcess.exec(msg.payload, { 'encoding': 'utf8' }, (err, stdout, stderr) => {\n    msg.payload = stdout;\n});\n\n*/\n\n\nconst func = childProcess.exec(msg.payload, { 'encoding': 'utf8' }, (err, stdout, stderr) => {\n    return stdout;\n});\n\n\nconst retu = childProcess.exec(msg.payload, { 'encoding': 'utf8' });\n\n\nconst newtest = childProcess.exec(\"dir\");\n\nmsg.payload = JSON.stringify(newtest);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "childProcess",
                "module": "child_process"
            }
        ],
        "x": 220,
        "y": 860,
        "wires": [
            []
        ]
    },
    {
        "id": "f68d90dde3e2af12",
        "type": "function",
        "z": "b5ae94617e862de8",
        "name": "RUN CMD",
        "func": "const cmd = global.get(\"cmd\");\n\nvar process = cmd.runSync(msg.payload);\n\nmsg.payload = JSON.stringify(process.data);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 230,
        "y": 300,
        "wires": [
            [
                "d59d7e33e17ac8c1"
            ]
        ]
    },
    {
        "id": "d59d7e33e17ac8c1",
        "type": "json",
        "z": "b5ae94617e862de8",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 490,
        "y": 300,
        "wires": [
            [
                "5797f615d1a26b7c"
            ]
        ]
    },
    {
        "id": "f6306b71f41ac4bc",
        "type": "template",
        "z": "b5ae94617e862de8",
        "name": "UI tekst template",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "[B]Resultat[/B]\n\nEfter gennemgang af godkendte regelst anbefales flgende handlingsplan:\n\n----------\n----------\n----------\n\nnsker du automatisere dette? Godkend herunder-",
        "output": "str",
        "x": 690,
        "y": 920,
        "wires": [
            []
        ]
    },
    {
        "id": "90a7b281bcbe7868",
        "type": "encode-utf16le",
        "z": "b5ae94617e862de8",
        "name": "",
        "x": 660,
        "y": 860,
        "wires": [
            []
        ]
    },
    {
        "id": "d1f496b3b5f1041b",
        "type": "function",
        "z": "b5ae94617e862de8",
        "name": "function 2",
        "func": "//const shell = require('node-powershell');\n\nfunction PowershellNode() {\n    \n    let ps = new shell({\n        executionPolicy: 'Bypass',\n        noProfile: true,\n        pwsh: true\n    });\n\n    ps.addCommand(msg.payload);\n    ps.invoke()\n        .then(output => {\n            msg.payload = output;\n            this.send(msg);\n        })\n        .catch(error => {\n            msg.payload = error;\n            this.error(error, msg);\n        });\n}\n\nmsg.payload = PowershellNode();\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "shell",
                "module": "node-powershell"
            }
        ],
        "x": 420,
        "y": 860,
        "wires": [
            []
        ]
    },
    {
        "id": "46eb8fb7ba338b6c",
        "type": "powershell",
        "z": "b5ae94617e862de8",
        "name": "",
        "x": 430,
        "y": 900,
        "wires": [
            [],
            []
        ]
    }
]
