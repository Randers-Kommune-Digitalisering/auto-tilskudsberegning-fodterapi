[
    {
        "id": "8ea344595d9a442a",
        "type": "tab",
        "label": "Main",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "c28a486ea3e09387",
        "type": "tab",
        "label": "Web Endpoint",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "46a5586ef7af1095",
        "type": "tab",
        "label": "OLD WEB",
        "disabled": true,
        "info": "",
        "env": []
    },
    {
        "id": "4fd74d0002aa2bc4",
        "type": "tab",
        "label": "HTTP",
        "disabled": true,
        "info": "",
        "env": []
    },
    {
        "id": "41d1b8798efe7e15",
        "type": "subflow",
        "name": "PupController",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 220,
                "y": 440,
                "wires": [
                    {
                        "id": "5aa16189aff2b4c3"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1720,
                "y": 340,
                "wires": [
                    {
                        "id": "cb4ea3ccf7541c86",
                        "port": 1
                    }
                ]
            },
            {
                "x": 1920,
                "y": 440,
                "wires": [
                    {
                        "id": "5935cece6c345653",
                        "port": 1
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "43652557380ac3f3",
        "type": "subflow",
        "name": "GetPageContent",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 120,
                "wires": [
                    {
                        "id": "f4ed528cde3cabe7"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 2080,
                "y": 720,
                "wires": [
                    {
                        "id": "193590a736c24869",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "db94b4c117de2f6a",
        "type": "subflow",
        "name": "Get Settings/Rules/Grants",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 100,
                "wires": [
                    {
                        "id": "d074d283a8713b57"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1280,
                "y": 660,
                "wires": [
                    {
                        "id": "6e9984fcc13cbb0d",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "85ff29bdef7c1aea",
        "type": "subflow",
        "name": "StepHistory",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 140,
                "y": 80,
                "wires": [
                    {
                        "id": "792bc1326c300849"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1020,
                "y": 720,
                "wires": [
                    {
                        "id": "c668c88142f35452",
                        "port": 1
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "7de50fe1369c94a7",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "fill": "#ffffbf",
            "label": true,
            "fill-opacity": "0.67"
        },
        "nodes": [
            "64156b428449f87a",
            "8b4e8bc5facd8f90",
            "632aa75f39860780"
        ],
        "x": 334,
        "y": 139,
        "w": 322,
        "h": 122
    },
    {
        "id": "669e09e244099963",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "Extract",
        "style": {
            "stroke": "#777777",
            "label": true,
            "fill": "#bfdbef",
            "fill-opacity": "0.67"
        },
        "nodes": [
            "28d8ac05e7f0f65f",
            "bc7b13ac2323540b",
            "4003aad4b2b6a9c8",
            "fa861baf7265d3be",
            "8bc31d06862e8fe2",
            "d5a462980f4852cf",
            "07d87534c4e0bbea",
            "c931f08e3a54e2f2",
            "6558b47eb74e6c0c",
            "569d9f497b06babc",
            "144d6812d5213472",
            "6a7f540f9f08ded4",
            "bb143ed21df0febf",
            "07aa032e7944f93b",
            "15a1703b4a5286c7",
            "d97f7bbbe0210f54",
            "90acc4726c72125a",
            "d04faa115ea73982",
            "c9cc2e6cd25fdbd6",
            "dd83f023eff10d0a",
            "4424787318323d8e",
            "023477a667bd9144",
            "0051afd9266db397",
            "05c5f046beaa0d7d"
        ],
        "x": 334,
        "y": 279,
        "w": 1512,
        "h": 227
    },
    {
        "id": "6c7a3f8252158db6",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "Transform 2 - Sager og tilskud",
        "style": {
            "fill": "#ffbfbf",
            "fill-opacity": "0.66",
            "label": true
        },
        "nodes": [
            "5d7e42be40e46699",
            "252ef6cdcba02f65",
            "9639c713133c8b4b",
            "c728e9afbea480e9",
            "b5f7952c5718fafd",
            "c23d52373f2634a2",
            "ea041c123c220cca",
            "042534adf7219de9",
            "ebfc3d7f7b71a754",
            "8b251b9d384911a0",
            "363e103b20db6c80",
            "5cfe1b69780c58ab",
            "eea859cc92e89e3f"
        ],
        "x": 374,
        "y": 1359,
        "w": 1172,
        "h": 282
    },
    {
        "id": "380e5c7e0ea3778b",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "Tranform 3 - Klargør til UI",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "fill-opacity": "0.64"
        },
        "nodes": [
            "da966ceeba7b23dd",
            "8a3db972f8fb7806",
            "f5dbef72792b9011",
            "b51fbf12da5aebba",
            "a46e2a0c2cd58d9f",
            "fde5a695bfbd9a7d",
            "df5451114247dbd3",
            "4fa04433812ed133",
            "f811b83fc07bb1cd",
            "5f3a3d3e30d3be55",
            "c7ca8c02a788a41d",
            "78f7e1718ab3f755",
            "8f4d2dcc4c986825",
            "4840de2e1aa54398",
            "1ac2795f481c336e"
        ],
        "x": 374,
        "y": 1679,
        "w": 1092,
        "h": 302
    },
    {
        "id": "31b5ea0c53a9c4fb",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "",
        "style": {
            "fill": "#ffefbf",
            "fill-opacity": "0.62",
            "label": true
        },
        "nodes": [
            "abb73011a817205a",
            "92fc21540237b9c7",
            "984b68b697eb68be",
            "e08bf0d9ec73f87e",
            "77e8a8e7f5259bfb",
            "1c365f175b48167a",
            "53dbe0297b8bd16d",
            "c6d6dc5b8ef2878b",
            "801ba8048f457e32",
            "ec82ecfe41364ced",
            "415336a4f07090e6",
            "69ef811ebe7083c9",
            "492252a377f8d60d",
            "d046f8cb32a0960c",
            "6154c5e7bbc8bc1a",
            "118d9842141d09ca",
            "f6abba6df8ed7611",
            "4c1121ef6377b795",
            "6ebfb594e20f3f75",
            "412dc2399a0183b9"
        ],
        "x": 454,
        "y": 419,
        "w": 1232,
        "h": 502
    },
    {
        "id": "0e177132df886f4e",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "",
        "style": {
            "fill": "#e3f3d3",
            "fill-opacity": "0.64",
            "label": true
        },
        "nodes": [
            "e33624721d9829f0",
            "40c9a409b68d13f1",
            "5c74b689e0aee38b",
            "30b5b930fae41995",
            "e53f459d609aac22",
            "408b2b0cf0a40d41",
            "0a97b8da0c9ceff9",
            "ea3be6d83c70d734",
            "97801c386c197805",
            "164122de385f07b8"
        ],
        "x": 494,
        "y": 939,
        "w": 1192,
        "h": 202
    },
    {
        "id": "e4e7a254403521e9",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "fill-opacity": "0.65",
            "label": true
        },
        "nodes": [
            "f8bf41fc7dd480f1",
            "c888f934919b1eb8",
            "d84057a8cb05b22f",
            "0ff5c26114374820",
            "d6432bd8a487caa0",
            "948eb590f69bd85b",
            "b3ecd3ad79094172",
            "54254a91e943fb50",
            "6226138fabf9a3b8"
        ],
        "x": 494,
        "y": 1159,
        "w": 1192,
        "h": 122
    },
    {
        "id": "0772648cf2b898d4",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "HTTP Request In",
        "style": {
            "fill": "#ffbfbf",
            "fill-opacity": "0.65",
            "label": true
        },
        "nodes": [
            "1d9fe0413cbb430d",
            "6e25160476593670",
            "e76b0758dc45914d",
            "8d172c16f57e9a2b"
        ],
        "x": 14,
        "y": 519,
        "w": 312,
        "h": 264.5
    },
    {
        "id": "dff24743df339ae5",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "",
        "style": {
            "fill": "#bfdbef",
            "fill-opacity": "0.67",
            "label": true
        },
        "nodes": [
            "59e078cd4489c0aa",
            "62bdefaa23262980",
            "b0adba24e19779d2"
        ],
        "x": 534,
        "y": 279,
        "w": 1152,
        "h": 122
    },
    {
        "id": "0d6121cfccf91882",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "Endpoint",
        "style": {
            "fill": "#bfbfbf",
            "fill-opacity": "0.54",
            "label": true
        },
        "nodes": [
            "248d64bf4e74f440",
            "a404b305e8f838e6",
            "fc57c59e7b1b413d",
            "4070528fbaa047ab",
            "55d1d622afec35e2",
            "98d7ea7aa5c93ad4",
            "ac7bdd1609da7c77",
            "ddd0873c9d611a5e",
            "29426a6eb03efe81",
            "a71320aa58eef18a",
            "269002ef959b2b77"
        ],
        "x": 74,
        "y": 59,
        "w": 1612,
        "h": 142
    },
    {
        "id": "287b33b8879cbbbc",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "Transform 1 - Kontrollér data",
        "style": {
            "fill": "#ffefbf",
            "label": true,
            "fill-opacity": "0.66"
        },
        "nodes": [
            "4629d4bebfd2768f",
            "aea48540dc37e51c",
            "64bc816ed683fb56",
            "b01934ac82f070c3",
            "31392fe7f3a93ccd",
            "141037f73383a9f6",
            "78c4e4692985e738",
            "2cf375bbbada29f9",
            "12d9ffdfaf71a523",
            "011d535e3ab60636",
            "71c55498ef71a4c9",
            "6afaf8f1c596de67",
            "05096968ae22cc6f",
            "215c708ef9319356",
            "c68d4ee2f02ada08",
            "4c51b10755b92b07",
            "4e374431cb68ace4",
            "5e112e4574f64f9b",
            "046eb82cefda08d4",
            "6b4df0013a0256a0",
            "7f450a3e484312bd",
            "852046d71f487d02",
            "fa59a67027b60c71",
            "7d7a7bf5a54224e8",
            "015eb190e5565e7d",
            "989112eb96abfdb9",
            "b81c9fcaa9d3e0d1",
            "104d29ffe37f5998",
            "ca6df1c9d056a924",
            "00a9a4712b97560f",
            "1ee2c685a74c09b0",
            "ac26dfbc2efcbb4f",
            "81cc412d0d2170b9"
        ],
        "x": 334,
        "y": 799,
        "w": 1392,
        "h": 522
    },
    {
        "id": "9c4f3569ebca5f7b",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "fill": "#bfc7d7",
            "fill-opacity": "0.67",
            "label": true
        },
        "nodes": [
            "bc99d7022f61a990",
            "d183f106c2e11bce",
            "c2df29c07624e5e0",
            "c8857f0a61f8c92e",
            "0df1e3c807393a69",
            "573bc9a19cb2a144",
            "70ade91971d73d3b",
            "81a00971b2ea464e",
            "3691fee0bd5cd7bc",
            "5c03893a530479bb",
            "172fe34eeccca8dd",
            "f7835ac1742b0168"
        ],
        "x": 334,
        "y": 539,
        "w": 1172,
        "h": 222
    },
    {
        "id": "d97f7bbbe0210f54",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "x": 680,
        "y": 480,
        "wires": [
            [
                "90acc4726c72125a"
            ]
        ]
    },
    {
        "id": "90acc4726c72125a",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "x": 1240,
        "y": 480,
        "wires": [
            [
                "4424787318323d8e"
            ]
        ]
    },
    {
        "id": "53c070f3a6e4c909",
        "type": "junction",
        "z": "4fd74d0002aa2bc4",
        "x": 1760,
        "y": 240,
        "wires": [
            [
                "5053a803d27c1fe2",
                "569cacb45b532605"
            ]
        ]
    },
    {
        "id": "919795f739e39ca4",
        "type": "junction",
        "z": "4fd74d0002aa2bc4",
        "x": 1640,
        "y": 140,
        "wires": [
            [
                "53c070f3a6e4c909"
            ]
        ]
    },
    {
        "id": "62c11658d7cda4de",
        "type": "junction",
        "z": "4fd74d0002aa2bc4",
        "x": 660,
        "y": 700,
        "wires": [
            [
                "ec5733c98c66b003"
            ]
        ]
    },
    {
        "id": "7f7d6cfa083646fa",
        "type": "junction",
        "z": "46a5586ef7af1095",
        "x": 1500,
        "y": 1320,
        "wires": [
            [
                "f06e5d62ba343557"
            ]
        ]
    },
    {
        "id": "269002ef959b2b77",
        "type": "junction",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "x": 580,
        "y": 100,
        "wires": [
            [
                "a71320aa58eef18a"
            ]
        ]
    },
    {
        "id": "afc6fa2bb250f63c",
        "type": "junction",
        "z": "43652557380ac3f3",
        "x": 1880,
        "y": 460,
        "wires": [
            [
                "1d2a94a05f330839"
            ]
        ]
    },
    {
        "id": "e7b83f0e755d4fdf",
        "type": "junction",
        "z": "c28a486ea3e09387",
        "x": 1800,
        "y": 720,
        "wires": [
            [
                "d4cb17c655b74747"
            ]
        ]
    },
    {
        "id": "bb96674ebd01af04",
        "type": "junction",
        "z": "db94b4c117de2f6a",
        "x": 840,
        "y": 280,
        "wires": [
            [
                "a9d6b94d12b279b8"
            ]
        ]
    },
    {
        "id": "c49b1da1d0ca8a62",
        "type": "junction",
        "z": "db94b4c117de2f6a",
        "x": 840,
        "y": 420,
        "wires": [
            [
                "6f9b01d0e9aeace9"
            ]
        ]
    },
    {
        "id": "c02e24bfe2197802",
        "type": "junction",
        "z": "43652557380ac3f3",
        "x": 640,
        "y": 880,
        "wires": [
            [
                "22c31b5dcd690404"
            ]
        ]
    },
    {
        "id": "12011e480eafdc8f",
        "type": "junction",
        "z": "db94b4c117de2f6a",
        "x": 840,
        "y": 620,
        "wires": [
            [
                "6e9984fcc13cbb0d"
            ]
        ]
    },
    {
        "id": "f7635cfda195117f",
        "type": "junction",
        "z": "db94b4c117de2f6a",
        "x": 480,
        "y": 60,
        "wires": [
            [
                "6ec1d89f4bc267a3"
            ]
        ]
    },
    {
        "id": "97801c386c197805",
        "type": "junction",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "x": 1660,
        "y": 1060,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "b3ecd3ad79094172",
        "type": "junction",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "x": 1660,
        "y": 1240,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "dd83f023eff10d0a",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "x": 360,
        "y": 380,
        "wires": [
            [
                "d04faa115ea73982"
            ]
        ]
    },
    {
        "id": "b840a64a9cf3c187",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 1340,
        "y": 2420,
        "wires": [
            [
                "a2f55ae008b1fee2"
            ]
        ]
    },
    {
        "id": "2833bc30cabd27bb",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 1740,
        "y": 220,
        "wires": [
            [
                "dd83f023eff10d0a",
                "ca4cd4b46c05bb1d"
            ]
        ]
    },
    {
        "id": "6fc6a8b8c6d3b766",
        "type": "junction",
        "z": "43652557380ac3f3",
        "x": 1700,
        "y": 640,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "53d1fb714bf85e85",
        "type": "junction",
        "z": "c28a486ea3e09387",
        "x": 1660,
        "y": 1380,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "7d7a7bf5a54224e8",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "x": 560,
        "y": 1240,
        "wires": [
            [
                "215c708ef9319356"
            ]
        ]
    },
    {
        "id": "4840de2e1aa54398",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "x": 1200,
        "y": 1940,
        "wires": [
            [
                "fde5a695bfbd9a7d"
            ]
        ]
    },
    {
        "id": "3cde6b50323a51ef",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 2040,
        "y": 120,
        "wires": [
            [
                "87437eca4cc7eec9"
            ]
        ]
    },
    {
        "id": "172fe34eeccca8dd",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "x": 1480,
        "y": 680,
        "wires": [
            [
                "c3932c1fbca91f98"
            ]
        ]
    },
    {
        "id": "62ce56e92ec4f29b",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 1960,
        "y": 340,
        "wires": [
            [
                "2359edd9babea1ac",
                "cb1b489418bfa2d8"
            ]
        ]
    },
    {
        "id": "a567f42879c1f449",
        "type": "mqtt-broker",
        "name": "",
        "broker": "localhost",
        "port": "1883",
        "clientid": "",
        "autoConnect": true,
        "usetls": false,
        "protocolVersion": "4",
        "keepalive": "60",
        "cleansession": true,
        "birthTopic": "",
        "birthQos": "0",
        "birthPayload": "",
        "birthMsg": {},
        "closeTopic": "",
        "closeQos": "0",
        "closePayload": "",
        "closeMsg": {},
        "willTopic": "",
        "willQos": "0",
        "willPayload": "",
        "willMsg": {},
        "userProps": "",
        "sessionExpiry": ""
    },
    {
        "id": "6e63b3c396c75d87",
        "type": "websocket-listener",
        "path": "/ws/pup",
        "wholemsg": "true"
    },
    {
        "id": "c1ae0d59916344e0",
        "type": "websocket-listener",
        "path": "ws/rules",
        "wholemsg": "false"
    },
    {
        "id": "13a90a014adf9bc5",
        "type": "websocket-listener",
        "path": "/ws/worklet",
        "wholemsg": "false"
    },
    {
        "id": "b93057423dbab117",
        "type": "http in",
        "z": "41d1b8798efe7e15",
        "name": "",
        "url": "/pup",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 160,
        "wires": [
            [
                "f38a2efe43edd64e"
            ]
        ]
    },
    {
        "id": "5c5841605bcac134",
        "type": "http response",
        "z": "41d1b8798efe7e15",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1130,
        "y": 160,
        "wires": []
    },
    {
        "id": "f8ccfed64d837464",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Set URL",
        "info": "",
        "x": 400,
        "y": 120,
        "wires": []
    },
    {
        "id": "5b841495c9c84c66",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Host website",
        "info": "",
        "x": 150,
        "y": 120,
        "wires": []
    },
    {
        "id": "f38a2efe43edd64e",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "url = /pup",
        "rules": [
            {
                "t": "set",
                "p": "url",
                "pt": "msg",
                "to": "pup",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 400,
        "y": 160,
        "wires": [
            [
                "e271c933dcfb52c5"
            ]
        ]
    },
    {
        "id": "8646ac73ab639fcd",
        "type": "http in",
        "z": "41d1b8798efe7e15",
        "name": "",
        "url": "/puprun",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 340,
        "wires": [
            [
                "0fa8b45a3aec3fd5"
            ]
        ]
    },
    {
        "id": "d68baf48942491dd",
        "type": "switch",
        "z": "41d1b8798efe7e15",
        "name": "browser == null?",
        "property": "pupController.browser",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 340,
        "wires": [
            [
                "274738f45a0d5d5a"
            ],
            [
                "1a32f920705bb1bc"
            ]
        ]
    },
    {
        "id": "274738f45a0d5d5a",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "pupController",
                "pt": "msg",
                "to": "{\t    \"pages\": [],\t    \"commands\": payload\t}",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "pupCount",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1120,
        "y": 320,
        "wires": [
            [
                "1a32f920705bb1bc"
            ]
        ]
    },
    {
        "id": "1a32f920705bb1bc",
        "type": "function",
        "z": "41d1b8798efe7e15",
        "name": "Initialize?",
        "func": "const pup = global.get('puppeteer');\n(async () => {\n\n    var commands = msg.pupController.commands;\n\n    for (let i = 0; i < commands.length; i++)\n    {\n        const e = commands[i];\n\n        if (msg.pupController.browser == null && e.action == \"launch\")\n        {\n            msg.pupController.browser = await pup.launch(e.parameters);\n            msg.pupController.browserWS = await msg.pupController.browser.wsEndpoint();\n            //await NewPage(e.name != null ? e.name : \"main\");\n            await AddInitialPage(e.name != null ? e.name : \"initial\");\n        }\n\n        else if(e.action == \"newtab\")\n            await NewPage(e.name);\n    }\n\n    if(msg.pupController.browser == null)\n    {\n        msg.pupController.browser = await pup.launch({});\n        msg.pupController.browserWS = await msg.pupController.browser.wsEndpoint();\n    }\n\n    msg.pupController.activePage = 0; //((await (msg.pupController.browser.pages()).length) - 1);\n    /*\n    {\n        \"page\": (await msg.pupController.browser.pages())[(await msg.pupController.browser.pages()).length - 1],\n        \"po\":msg.pupController.pages[msg.pupController.pages.length - 1]\n    }*/\n    msg.pupController.totalActions = commands.length;\n\n    node.send(msg);\n})();\n\nasync function NewPage(name) {\n    const newPage = await msg.pupController.browser.newPage();\n    const id = (await msg.pupController.browser.pages()).length - 1;\n    const url = await newPage.url();\n    msg.pupController.pages.push(\n        {\n            \"name\": name,\n            \"id\": id,\n            \"url\": url\n        });\n}\n\nasync function AddInitialPage(name = \"initial\")\n{\n    const page = (await msg.pupController.browser.pages())[0];\n    const url = await page.url();\n    msg.pupController.pages.push(\n        {\n            \"name\": name,\n            \"id\": 0,\n            \"url\": url\n        });\n}\n\n/*\nasync function LaunchBrowser(e)\n{\n    const browser = await pup.launch(e.parameters);\n    return browser.wsEndpoint();\n}\n*/",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 960,
        "y": 440,
        "wires": [
            [
                "ba19f064476425c9"
            ]
        ]
    },
    {
        "id": "580a9e3166314a22",
        "type": "function",
        "z": "41d1b8798efe7e15",
        "name": "Solo Controller",
        "func": "const pup = global.get('puppeteer');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\n\nvar actions = [];\n//var outputs = [];\nvar outputs = {};\n\nconst timeoutMs = 6500;\n\n(async () => {\n\n    const actionList = msg.payload;\n    var actionPerformed;\n\n    for (let i = 0; i < actionList.length; i++) {\n        \n        try {\n            const browser = await pup.connect({ \"browserWSEndpoint\": msg.pupController.browserWS })\n            const page = (await browser.pages())[msg.pupController.activePage];\n\n            page.setDefaultNavigationTimeout(1000); \n            //page.setDefaultNavigationTimeout(10000);\n\n            var ele = actionList[i];\n            const action = ele.action;\n\n            await page.waitForNetworkIdle();\n\n            switch (action)\n            {\n                case \"launch\":\n                case \"newtab\":\n                    break;\n\n                case \"goto\":\n                    if (ele.url != null)\n                        await page.goto(ele.url, { waitUntil: 'load', timeout: timeoutMs });\n                    else\n                        actionPerformed = ReportError(ele, \"Error: URL was lost\");\n                    break;\n\n                case \"click\":\n                    if(ele.isDownload == true || ele.isDownload == \"true\")\n                        setDownloadBehavior(page);\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    await page.click(ele.path, (ele.parameters != null ? ele.parameters : {}));\n                    if (ele.isDownload == true || ele.isDownload == \"true\")\n                        await page.waitForNetworkIdle();\n                    break;\n\n                case \"clickifexists\":\n                    if (ele.isDownload == true || ele.isDownload == \"true\")\n                        setDownloadBehavior(page);\n                    \n                    const exists = !! await page.$(ele.path);\n\n                    //wait page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    if(exists)\n                        await page.click(ele.path, (ele.parameters != null ? ele.parameters : {}));\n\n                    if (ele.isDownload == true || ele.isDownload == \"true\")\n                        await page.waitForNetworkIdle();\n                    break;\n\n                case \"type\":\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    if (ele.clear == true || ele.clearInput == true || ele.clear == \"true\" || ele.clearInput == \"true\")\n                        await page.click(ele.path, { clickCount: 3 });\n                    await page.type(ele.path, ele.input);\n                    break;\n\n                case \"select\":\n                    let elemHandler = await page.$(ele.path);\n                    let properties = await elemHandler.getProperties();\n                    for (const property of properties.values())\n                    {\n                        const element = property.asElement();\n                        if (element)\n                        {\n                            let hText = await element.getProperty(\"text\");\n                            let text = await hText.jsonValue();\n                            if (text === ele.input)\n                            {\n                                let hValue = await element.getProperty(\"value\");\n                                let value = await hValue.jsonValue();\n                                await page.select(ele.path, value); // or use 58730\n                                //console.log(`Selected ${text} which is value ${value}.`);\n                            }\n                        }\n                    }\n                    /*\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    await page.select(ele.path, ele.input);\n                    */\n                    break;\n\n                case \"get\":\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    var content = await page.$eval(ele.path, el => el.innerText);\n                    ele.output = actionList[i].output = content;\n                    break;\n\n                case \"geturl\":\n                    ele.output = actionList[i].output = page.url();\n\n                case \"wait\":\n                    if(ele.ms != null)\n                        await wait(ele.ms);\n                    break;\n\n                case \"close\":\n                    await browser.close();\n                    msg.pupController.browser = null;\n                    msg.pupController.pages = null;\n                    break;\n            }\n\n            ele.succesful = true;\n            actionPerformed = ReportAction(ele);\n            node.send([null, actionPerformed]);\n\n            //if(i == actionList.length-1 && action != \"close\")\n            //    await browser.close();\n            \n            \n        }\n        catch (e)\n        {\n            console.log(\"PupController error: \" + JSON.stringify(e));\n            //node.error(\"Error:\", e);\n            actionList[i].succesful = false;\n            actionPerformed = ReportError(actionList[i], e);\n            \n            node.send([null, actionPerformed]);\n\n            /*if (i == actionList.length - 1 && actionList[i] != \"close\")\n                await pup.connect({ \"browserWSEndpoint\": msg.pupController.browserWS }).then(browser => browser.close());\n                //await browser.close();*/\n        }\n\n    }\n\n\n    msg.pupOutputs = outputs;\n    node.send([msg, null]);\n})();\n\nasync function wait(_ms)\n{\n    let promise = new Promise((resolve, reject) => {\n        setTimeout(() => resolve(\"done!\"), _ms)\n    });\n    let result = await promise; // wait until the promise resolves (*)\n    //alert(result); // \"done!\"\n}\n\nfunction ReportAction(a, s = true)\n{\n    var newAction;\n    actions.push(newAction = {\n        \"action\": a.action,\n        \"succesful\": s,\n        \"obj\": a\n    });\n\n    if(a.output != null)\n    {\n        var outputName = a.name;\n        var outputObj = a.obj;\n\n        if(outputObj != null && outputObj != \"\")\n        {\n            outputs[outputObj] = outputs[outputObj] == null ? {} : outputs[outputObj];\n            outputs[outputObj][outputName] = a.output;\n        }\n        else\n            outputs[outputName] = a.output;\n        /*\n        outputs.push({\n            \"name\": a.name,\n            \"value\": a.output\n        });*/\n    }\n    return newAction;\n}\n\nfunction ReportError(a, e)\n{\n    console.log(e);\n    var newAction;\n    actions.push(newAction = {\n        \"action\": a,\n        \"succesful\": false,\n        \"error\": e,\n        \"obj\": a\n    });\n    return newAction;\n}\n\nasync function setDownloadBehavior(page) {\n    const client = await page.target().createCDPSession();\n    await client.send('Page.setDownloadBehavior', {\n        behavior: 'allow',\n        downloadPath: downloadPath\n    });\n}\n\n\n\n\n\n\n/*\n(async () => {\n    if (msg.command.url != null)\n        try {\n            //const browser = await pup.connect({ \"browserWSEndpoint\": msg.pupController.browserWS })\n            const browser = await pup.connect({ \"browserWSEndpoint\": msg.browserWS })\n            //const page = (await browser.pages())[msg.pupController.activePage];\n            const page = (await browser.pages())[msg.activePage];\n\n            await page.waitForNetworkIdle();\n            await page.goto(msg.command.url);\n            msg.succesful = true;\n\n        }\n        catch (e) {\n            console.log(e);\n            msg.succesful = false;\n            msg.error = e;\n        }\n    else {\n        msg.succesful = false;\n        msg.error = \"Error: URL was null\";\n        console.log(msg.error);\n    }\n\n    node.send(msg);\n})();\n*/",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1340,
        "y": 360,
        "wires": [
            [
                "cb4ea3ccf7541c86",
                "668e1ae3f9c4ccf8"
            ],
            [
                "2fd098a8190ef089"
            ]
        ]
    },
    {
        "id": "fa696e728e31ff49",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Start flow from web",
        "info": "",
        "x": 170,
        "y": 300,
        "wires": []
    },
    {
        "id": "a0f636581c44be9d",
        "type": "debug",
        "z": "41d1b8798efe7e15",
        "name": "Command Executed",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1820,
        "y": 500,
        "wires": []
    },
    {
        "id": "69738f2e4dcc6f63",
        "type": "http response",
        "z": "41d1b8798efe7e15",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1750,
        "y": 300,
        "wires": []
    },
    {
        "id": "668e1ae3f9c4ccf8",
        "type": "debug",
        "z": "41d1b8798efe7e15",
        "name": "All Commands Executed",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1630,
        "y": 240,
        "wires": []
    },
    {
        "id": "2fd098a8190ef089",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "pupid",
                "pt": "msg",
                "to": "pupCount",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "pupCount",
                "pt": "flow",
                "to": "msg.pupid+1",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "totalCount",
                "pt": "msg",
                "to": "totalActionCount",
                "tot": "flow",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1600,
        "y": 420,
        "wires": [
            [
                "5935cece6c345653"
            ]
        ]
    },
    {
        "id": "8020507bdd5939ba",
        "type": "websocket out",
        "z": "41d1b8798efe7e15",
        "name": "",
        "server": "6e63b3c396c75d87",
        "client": "",
        "x": 1970,
        "y": 400,
        "wires": []
    },
    {
        "id": "9da2cdfaa3c63d2e",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Set JavaScript",
        "info": "",
        "x": 650,
        "y": 120,
        "wires": []
    },
    {
        "id": "3d490b929251bc8a",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Start flow from flow",
        "info": "",
        "x": 170,
        "y": 400,
        "wires": []
    },
    {
        "id": "8ce8fe7e4e9fd6a5",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Endpoint",
        "info": "",
        "x": 1140,
        "y": 120,
        "wires": []
    },
    {
        "id": "30cc309628e939bc",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Check instance",
        "info": "",
        "x": 900,
        "y": 300,
        "wires": []
    },
    {
        "id": "6553bd482e86e7cd",
        "type": "function",
        "z": "41d1b8798efe7e15",
        "name": "CSS Selector Parser",
        "func": "for (let i = 0; i < msg.payload.length; i++) {\n    const e = msg.payload[i];\n\n    if(e.element != null)\n        e.path = CreatePath(e.element);\n    //DebugElement(e.element);\n    \n}\n\nfunction DebugElement(element)\n{\n    msg.test.push(element);\n}\n\nfunction CreatePath(element)\n{\n    if(element.path != null)\n        element.path;\n\n    var path = element.type == null ? \"\" : element.type;\n\n    if(element.parent != null && element.within != null)\n        ReportError({\n            \"error\": \"Both parent and within values set for element\",\n            \"element\": element\n        });\n\n    if(element.class != null)\n        path = path + \".\" + element.class;\n\n        if (element.classContains != null)\n            path = path + \"[class*='\" + element.classContains + \"']\";\n\n        if (element.classStartsWith != null)\n            path = path + \"[class^='\" + element.classStartsWith + \"']\";\n\n    if (element.id != null)\n        path = path + \"[id='\" + element.id + \"']\";\n\n        if(element.idContains != null)\n            path = path + \"[id*='\" + element.idContains + \"']\";\n\n        if (element.idStartsWith != null)\n            path = path + \"[id^='\" + element.idStartsWith + \"']\";\n\n    if (element.name != null)\n        path = path + \"[name='\" + element.name + \"']\";\n\n    if (element.src != null)\n        path = path + \"[src='\" + element.src + \"']\";\n\n    if (element.innerHTML != null)\n        path = path + \"[innerHTML='\" + element.innerHTML + \"']\";\n\n    // Check parent + within\n\n    if(element.parent != null)\n        path = CreatePath(element.parent) + \" > \" + path;\n    \n    else if (element.within != null)\n        path = CreatePath(element.within) + \" \" + path;\n\n    return path;\n}\n\nfunction ReportError(error)\n{\n    msg.error = error;\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 340,
        "wires": [
            [
                "d68baf48942491dd"
            ]
        ]
    },
    {
        "id": "5b02768458131405",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Create CSS selectors",
        "info": "",
        "x": 680,
        "y": 300,
        "wires": []
    },
    {
        "id": "0fa8b45a3aec3fd5",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "isWebCommand = true",
        "rules": [
            {
                "t": "set",
                "p": "isWebCommand",
                "pt": "flow",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 380,
        "y": 340,
        "wires": [
            [
                "6553bd482e86e7cd"
            ]
        ]
    },
    {
        "id": "5aa16189aff2b4c3",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "isWebCommand = false",
        "rules": [
            {
                "t": "set",
                "p": "isWebCommand",
                "pt": "flow",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 390,
        "y": 440,
        "wires": [
            [
                "6553bd482e86e7cd"
            ]
        ]
    },
    {
        "id": "5935cece6c345653",
        "type": "switch",
        "z": "41d1b8798efe7e15",
        "name": "",
        "property": "isWebCommand",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "jsonata"
            },
            {
                "t": "eq",
                "v": "false",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1770,
        "y": 420,
        "wires": [
            [
                "8020507bdd5939ba"
            ],
            []
        ]
    },
    {
        "id": "cb4ea3ccf7541c86",
        "type": "switch",
        "z": "41d1b8798efe7e15",
        "name": "",
        "property": "isWebCommand",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "jsonata"
            },
            {
                "t": "eq",
                "v": "false",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1570,
        "y": 320,
        "wires": [
            [
                "69738f2e4dcc6f63"
            ],
            []
        ]
    },
    {
        "id": "9b6f2743d9f9c4c2",
        "type": "catch",
        "z": "41d1b8798efe7e15",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 200,
        "y": 660,
        "wires": [
            [
                "9eb94ead2cba83a2"
            ]
        ]
    },
    {
        "id": "9eb94ead2cba83a2",
        "type": "debug",
        "z": "41d1b8798efe7e15",
        "name": "PupError",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 340,
        "y": 660,
        "wires": []
    },
    {
        "id": "e271c933dcfb52c5",
        "type": "template",
        "z": "41d1b8798efe7e15",
        "name": "Script",
        "field": "payload.script",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "plain",
        "template": "/////////////\n/// #0 : Action definitions\n////////////\n\nfunction actionList() {\n    return [\n        {\n            \"action\": \"launch\",\n            \"parameters\":\n            {\n                \"headless\": false,\n                \"slowMo\": 50,\n                \"ignoreHTTPSErrors\": true,\n                \"defaultViewport\": null\n            }\n        },\n        {\n            \"action\": \"goto\",\n            \"url\": \"\"\n        },\n        {\n            \"action\": \"click\",\n            \"path\": \"\",\n            \"parameters\":\n            {\n                \"clickCount\": 1\n            }\n        },\n        {\n            \"action\": \"type\",\n            \"input\": \"\",\n            \"path\": \"\"\n        },\n        {\n            \"action\": \"select\",\n            \"path\": \"\",\n            \"input\": \"\"\n        },\n        {\n            \"action\": \"get\",\n            \"name\": \"\",\n            \"path\": \"\"\n        },\n        {\n            \"action\": \"geturl\",\n            \"name\": \"\"\n        },\n        {\n            \"action\": \"wait\",\n            \"ms\": 1000\n        },\n        {\n            \"action\": \"close\"\n        }\n    ];\n};\n\n\n/////////////\n/// #1 : Start ()\n////////////\n\nconst commandList = document.querySelector(\".commandList\"),\n    controls = document.querySelector(\".controls\"),\n\n    cmdInput = document.querySelector(\".cmd\"),\n    textarea = document.querySelector('.textarea'),\n    lineNumbers = document.querySelector('.line-numbers');\n\nconst storageName = \"pupControl_JSON_commandGen\";\n\n// Define + get commands from SQLite\n\nlet commands = [];\n\ntry {\n    commands = JSON.parse(localStorage.getItem(storageName));\n}\ncatch {\n    console.log(\"Found command list, but corrupt:\\n\" + localStorage.getItem(storageName));\n}\n\nShowCommandList();\nUpdateJSON();\n\n// Create pseudo enum \"actionKeys\" -> usage to get full object: actionList()[actionKeys[\"launch\"]]\n\nlet _actionKeys = [];\nfor (let i = 0; i < actionList().length; i++)\n    _actionKeys[actionList()[i].action] = i;\n\nconst actionKeys = _actionKeys;\n\n// Function to create IDs for query selection of buttons\n\nfunction GetElementIdFromAction(actionObject) { return \"buttonAdd_\" + actionObject.action.replace(\" \", \"\"); }  // Example ID: buttonAdd_launch\n\n// Dynamically instantiate buttons for action objects\n\nfor (let i = 0; i < actionList().length; i++)\n    controls.innerHTML += `\n        <button class=\"button active\" id=\"${GetElementIdFromAction(actionList()[i])}\">${actionList()[i].action}</button>\n    `;\n\n// Dynamically create query selectors for action object buttons\n\nlet _buttonAdd = [];\nfor (let i = 0; i < actionList().length; i++)\n    _buttonAdd[actionList()[i].action] = document.querySelector(\".button#\" + GetElementIdFromAction(actionList()[i]));\n\nconst buttonAdd = _buttonAdd;\n\n// and add event listeners\n\nfor (let i = 0; i < actionList().length; i++)\n    buttonAdd[actionList()[i].action].addEventListener(\"click\", () => {\n        AddCommand(actionList()[i]);\n    });\n\n\n\n\n\n\n/////////////\n/// #2 : Data manipulation\n////////////\n\n///\n// Add command\n\nlet variableCount = 0;\nfunction AddCommand(actionObject) {\n\n    //console.log(\"Received action object: \\n\" + JSON.stringify(actionObject));\n\n    //console.log(\"Full action list: \" + JSON.stringify(actionList));\n\n    // Check if command is of valid type\n    if (!IsValidType(actionObject.action)) {\n        console.log(\"Failed to add command of unknown type `\" + actionObject.action + \"`\");\n        return;\n    }\n\n    // Check if a command array already exists, otherwise define it\n    commands = !commands ? [] : commands;\n\n    // Create initial command object\n    let clone = {}; // the new empty object\n\n    // let's copy all action properties into it\n    for (let key in actionObject) {\n        clone[key] = actionObject[key];\n    }\n    const command = clone;\n\n    // Push new command to list, and store JSON\n    commands.push(command);\n\n    StoreAndUpdateJSON();\n}\n\n// Function to check if type is valid\nfunction IsValidType(type) {\n    return !(actionKeys[type] == null);\n}\n\n// HTTP encode + add https if missing\nfunction ReturnUrl(url) {\n    var newUrl = encodeURIComponent(url);\n    if (!(url.includes(\"https://\") || url.includes(\"http://\")))\n        newUrl = \"https://\" + newUrl;\n    return newUrl;\n}\n\n// Selector generator from string\nfunction GenerateSelector(parameters) {\n    var multipleParameters = parameters.trim().split(' ');\n    var path = multipleParameters[0];\n    if (multipleParameters.length == 1)\n        return path;\n\n    for (let i = 1; i < multipleParameters.length; i++) {\n        let _c = multipleParameters[i];\n        var insideBrackets = _c.includes('[');\n\n        let attrSplit = _c.split('=');\n        if (!insideBrackets && attrSplit.length == 2) {\n            let attr = (_c.split('='))[0];\n            let value = (_c.split('='))[1];\n            path += '[' + attr + '=\"' + value + '\"]';\n        }\n        else\n            path += \" \" + _c;\n    }\n    return path;\n}\n\n// Receive update variable command from event\nfunction UpdateCommandVar(inputField) {\n\n    // Get ID of input field to determine which value to update\n    let id = inputField.id;\n    let s = id.split('_');\n\n    // Example ID: obj_attr\n    let _id = s[1];\n    var _attr = s[2];\n    if (s.length > 3)\n        _attr += \".\" + s[3];\n\n    UpdateCommandValue(_attr, inputField.value, _id);\n}\n\n// Update and store the change\nfunction UpdateCommandValue(attr, value, commandId) {\n\n    if (attr == \"path\")\n        value = GenerateSelector(value);\n\n    // Parse if float or int (ignore if \"path\" or \"input\")\n    if (attr != \"path\" && attr != \"\") //  <- HARD CODE :(\n    {\n        if (value.includes(\".\") || value.includes(\",\")) {\n            // Is float?\n            let _value = value.replace(\",\", \".\");\n            const parsed = parseFloat(_value);\n            if (!isNaN(parsed))\n                value = parsed;\n        }\n        else {\n            // Is int?\n            const parsed = parseInt(value);\n            if (!isNaN(parsed))\n                value = parsed;\n        }\n\n        // Parse if boolean or null\n        if (value === \"true\") value = true;\n        if (value === \"false\") value = false;\n        if (value === \"null\") value = null;\n    }\n\n\n    if (attr.includes('.')) {\n        let s = attr.split(\".\");\n\n        console.log(\"Updating attr \" + attr + \" from value \" + ((commands[commandId])[s[0]])[s[1]] + \" to value \" + value + \" (id: \" + commandId + \")\");\n\n        //if (((commands[commandId])[s[0]])[s[1]] != undefined)\n        ((commands[commandId])[s[0]])[s[1]] = value;\n\n\n    }\n    else {\n        console.log(\"Updating attr \" + attr + \" from value \" + (commands[commandId])[attr] + \" to value \" + value + \" (id: \" + commandId + \")\");\n\n        //if ((commands[commandId])[attr] != undefined)\n        (commands[commandId])[attr] = value;\n\n    }\n\n    StoreAndUpdateJSON();\n}\n\n// Additional functions\n\nfunction ClearAllCommands() {\n    commands.splice(0, commands.length);\n    StoreAndUpdateJSON();\n}\n\nfunction DeleteCommand(deleteId) {\n    commands.splice(deleteId, 1);\n    StoreAndUpdateJSON();\n}\n\nfunction CopyCommand(copyId) {\n    let command = commands[copyId];\n    commands.push(command);\n    StoreAndUpdateJSON();\n}\n\n///\n// STORE DATA / UPDATE JSON\n\nfunction StoreAndUpdateJSON(_text = null) {\n\n    // Function is used with _text parameter when called from textarea event listener\n    let text = UpdateJSON(_text);\n\n    if (text != null)\n        localStorage.setItem(storageName, text);\n\n    ShowCommandList();\n}\n\nfunction UpdateJSON(_text = null) {\n\n    var text = null;\n\n    if (_text == null) {\n        text = JSON.stringify(commands);\n        SetTextareaText(text);\n    }\n\n    else {\n\n        var _parsed = null;\n        try { _parsed = JSON.parse(_text) }\n        catch { }\n        //console.log(\"Updating JSON from textarea!\");\n        //console.log(_parsed);\n        if (_parsed != null) {\n            commands = _parsed;\n            text = JSON.stringify(commands);\n        }\n\n    }\n\n    SetTextareLineNumbers();\n    return text;\n}\n\n\n\n\n\n\n\n\n\n/////////////\n/// #3 : Visual manipulation\n////////////\n\nfunction ShowCommandList() {\n    let liTag = \"\";\n\n    // Check if command list exists and is populated\n    if (commands) {\n        commands.forEach((command, id) => {\n            liTag += PrintCommand(command, id);\n        });\n    }\n\n    // Base text - if no commands exists\n    commandList.innerHTML = liTag || `<span>Start by adding a <b>Launch</b> command</span>`;\n\n    // Add event listeners to all input fields in tasks\n    var inputFields = document.querySelectorAll('.task input');\n    for (var i = 0; i < inputFields.length; i++) {\n\n        // Update the command that has been changed on focusout, and resize input field to match content\n        inputFields[i].addEventListener('focusout', function (event) {\n            UpdateCommandVar(event.target);\n            ResizeInputToFit(event.target.id);\n        }, false);\n\n        inputFields[i].addEventListener('keyup', function (event) {\n            // Also resize on key-up\n            ResizeInputToFit(event.target.id);\n        }, false);\n\n        // Also resize immediately to match loaded content\n        ResizeInputToFit(inputFields[i].id);\n    }\n}\n\n// Show bulletin menu for each action in list (with copy / delete options)\nfunction ShowBulletinMenu(selectedTask) {\n    let menuDiv = selectedTask.parentElement.lastElementChild;\n    menuDiv.classList.add(\"show\");\n    document.addEventListener(\"click\", e => {\n        if (e.target.tagName != \"I\" || e.target != selectedTask)\n            menuDiv.classList.remove(\"show\");\n    });\n}\n\n///\n// PRINT COMMAND\n///\nfunction PrintCommand(command, id) {\n\n    var commandName = command.action == \"goto\" ? \"go to\" : command.action;\n\n    var returnStr = \"\";\n    returnStr += `\n                <li class=\"task\" id=\"task_${id}\">\n                <div>\n                    <div>\n                        <label for=\"${id}\">\n                            <p>${commandName}</p>\n                        </label>\n                    </div>`;\n\n    // Add input fields for each object variable\n    returnStr += AddInputFields(command, id);\n\n    returnStr += `\n                    <div>\n                    </div>\n                    <div class=\"filler\"></div>\n                    <div class=\"settings\">\n                        <i onclick=\"ShowBulletinMenu(this)\" class=\"uil uil-ellipsis-h\"></i>\n                        <ul class=\"bulletinMenu\">\n                            <li onclick='CopyCommand(${id})'><i class=\"uil uil-trash\"></i>Copy</li>\n                            <li onclick='DeleteCommand(${id})'><i class=\"uil uil-trash\"></i>Delete</li>\n                        </ul>\n                    </div>\n                </div>\n            </li>`;\n\n    return returnStr;\n}\n\n// Add input fields for each command variable\nfunction AddInputFields(command, id, previousKey = null) {\n    var returnStr = \"\";\n    for (const key in command) {\n        var keystr = key;\n        keystr = key.toLocaleLowerCase();\n\n        if (command[key] !== null && typeof command[key] === 'object') {\n            returnStr += \"<span>\" + key + \" {</span>\";\n            returnStr += AddInputFields(command[key], id, key);\n            returnStr += \"<span>}</span>\";\n        }\n\n        else if (keystr != \"action\") {\n            let inputID = \"commandInput_\" + id + \"_\" + (previousKey != null ? previousKey + \"_\" : \"\") + key;\n            //inputIDArray.push(inputID);\n            returnStr += `\n                    <div>\n                    ${keystr}\n                    <input id=\"${inputID}\" value='${command[key]}'/>\n                    </div>\n                        `;\n        }\n\n    }\n    return returnStr;\n}\n\n\nfunction ResizeInputToFit(id) {\n    let _inputField = document.querySelector((\"#\" + id));\n    let width = (40 + (_inputField.value.length * 7.35)) + \"px\";\n    document.querySelector((\"#\" + id)).setAttribute('style', 'width:' + width);\n}\n\nvar lastChar = '';\nvar isNewline = false;\nvar isInsideQuotations = false;\nfunction SetTextareaText(json) {\n    var text = \"\";\n    let count = json.length;\n    var level = 0;\n\n    for (let i = 0; i < count; i++) {\n        let char = json[i];\n\n        switch (char) {\n            case '{': case '[':\n                if (!isInsideQuotations && i != 0 && (json[i - 1] == ',' || json[i - 1] == ':')) text += \"\\n\";\n                if (!isInsideQuotations)\n                    for (let l = 0; l < level; l++)\n                        text += \"\\t\";\n                text += char;\n                if (!isInsideQuotations) {\n                    text += \"\\n\";\n                    level++;\n                    isNewline = true;\n                }\n                break;\n\n            case '}': case ']':\n                if (!isInsideQuotations) {\n                    text += \"\\n\";\n                    level--;\n                    for (let l = 0; l < level; l++)\n                        text += \"\\t\";\n                    isNewline = true;\n                }\n                text += char;\n                break;\n\n            case ',':\n                if (!isInsideQuotations)\n                    isNewline = true;\n                text += char;\n                break;\n\n            case ':':\n                text += char;\n                if (lastChar == \"\\\"\")\n                    text += \" \";\n                break;\n\n            case '\"':\n                isInsideQuotations = !isInsideQuotations;\n\n            default:\n                if (i != 0 && json[i - 1] == ',') { text += \"\\n\"; isNewline = true }\n                if (isNewline)\n                    for (let l = 0; l < level; l++)\n                        text += \"\\t\";\n                text += char;\n                isNewline = false;\n                break;\n        }\n\n        lastChar = char;\n    }\n\n    textarea.value = text;\n}\n\nfunction SetTextareLineNumbers() {\n    /*\n    const lineHeight = 21;\n    var taHeight = textarea.scrollHeight; // Get the scroll height of the textarea\n    const numberOfLines = Math.floor(taHeight/lineHeight);\n    */\n    const numberOfLines = textarea.value.split('\\n').length;\n    lineNumbers.innerHTML = Array(numberOfLines)\n        .fill('<span></span>')\n        .join('');\n}\n\n\n\n\n\n\n\n\n\n\n\n/////////////\n/// #4 : Communication (HTTP Request + Websockets)\n////////////\n\n///\n// HTTP post method (for testing flows using \"nr\"-command)\nasync function SendToNodeRed() {\n    if (commandList.length == 0)\n        return;\n\n    document.getElementById('task_0').classList.add(\"current\");\n\n    fetch('/puprun', {\n\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n        },\n        body: textarea.value\n\n    }).then(response => {\n        if (response.ok) {\n            response.json().then(json => {\n                console.log(json);\n            });\n        }\n    });\n}\n\n///\n// WEB SOCKET (node-red)\nvar ws;\nvar wsUri = \"ws:\";\nvar loc = window.location; //console.log(loc);\n\nif (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n// This needs to point to the web socket in the Node-RED flow\nwsUri += \"//\" + loc.host + loc.pathname.replace(\"pup\", \"ws/pup\");\n\nfunction wsConnect() {\n    console.log(\"Connecting to \", wsUri);\n    ws = new WebSocket(wsUri);\n    //var line = \"\";    // either uncomment this for a building list of messages\n    ws.onmessage = function (msg) {\n        var line = \"\";  // or uncomment this to overwrite the existing message\n\n        // parse the incoming message as a JSON object\n        var data = msg.data;\n        const obj = JSON.parse(data);\n\n        console.log(\"Received WS message ID: \" + obj.pupid);\n\n        // Remove bg from current command box (and set error if error was detected)\n        document.getElementById('task_' + obj.pupid).classList.remove(\"current\")\n        if (!obj.succesful)\n            document.getElementById('task_' + obj.pupid).classList.add(\"error\")\n\n        // Update next command box bg\n        let nextID = obj.pupid + 1;\n        if (commands.length > nextID)\n            document.getElementById('task_' + nextID).classList.add(\"current\");\n\n        //ws.send(JSON.stringify({data:data}));\n    }\n    ws.onopen = function () {\n        // update the status div with the connection status\n        console.log(\"Connected to WS\");\n    }\n    ws.onclose = function () {\n        // update the status div with the connection status\n        console.log(\"WS connection lost\");\n        // in case of lost connection tries to reconnect every 3 secs\n        setTimeout(wsConnect, 3000);\n    }\n}\nfunction PublishWsMessage(m) {\n    if (ws) { ws.send(m); }\n}\n\n\n\n\n\n\n\n\n\n/////////////\n/// #5 : Command line interface\n////////////\n\nfunction RunCommandLineAction(key) {\n    if (key != \"Enter\")\n        return;\n\n    var input = cmdInput.value;\n    input = input.toLowerCase();\n\n    const inputCommand = (input.split(' '))[0];\n\n    var clearInput = true;\n\n    switch (inputCommand) {\n        case \"clear\":\n            ClearAllCommands();\n            break;\n\n        case \"node-red\": case \"nr\":\n            SendToNodeRed();\n            break;\n\n        default:\n            console.log(\"Received unrecognized console command `\" + input + \"`\");\n            clearInput = false;\n            break;\n    }\n\n    if (clearInput)\n        cmdInput.value = \"\";\n}\n\n/*\nfunction AddCommandLineCommand(ic, i) {\n    const parameters = i.replace(ic, '').trim();\n    AddCommand(ic, parameters);\n\n    console.log(\"Received command `\" + ic + \"` with parameters `\" + parameters + \"`\");\n}\n\n*/\n\n\n\n\n\n\n\n/////////////\n/// #6 : Event listeners\n////////////\n\ntextarea.addEventListener('keyup', event => {\n    SetTextareLineNumbers();\n    StoreAndUpdateJSON(textarea.value);\n});\n\ntextarea.addEventListener('keydown', event => {\n    if (event.key === 'Tab') {\n        const start = textarea.selectionStart;\n        //const end = textarea.selectionEnd;\n\n        textarea.value = textarea.value.substring(0, start) + '\\t' + textarea.value.substring(start, textarea.value.length);\n\n        textarea.selectionEnd = start + 1;\n\n        event.preventDefault();\n    }\n});\n\ncmdInput.addEventListener('keyup', event => {\n    RunCommandLineAction(event.key);\n});\n\n/*\nwindow.onresize = SetTextareLineNumbers;\n*/",
        "x": 630,
        "y": 160,
        "wires": [
            [
                "c8f4a55e7618b7e2"
            ]
        ]
    },
    {
        "id": "a17c13f96787e2b4",
        "type": "template",
        "z": "41d1b8798efe7e15",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\" dir=\"ltr\">\n  <head>\n    <meta charset=\"utf-8\">  \n    <title>PupController</title>\n    <style>{{{payload.style}}}</style>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <!-- Iconscout Link For Icons -->\n    <link rel=\"stylesheet\" href=\"https://unicons.iconscout.com/release/v4.0.0/css/line.css\">\n  </head>\n  <body onload=\"wsConnect();\" onunload=\"ws.disconnect();\">\n\n    <div class=\"flex\">\n\n      <div class=\"containerLeft\">\n\n        <div class=\"menu\">\n\n          <div class=\"menupoints\">\n            <div>Documentation</div>\n            <div>GitHub</div>\n          </div>\n\n          <div class=\"controls\"></div>\n\n        </div>\n\n        <ul class=\"commandList\"></ul>\n\n      </div>\n      <div class=\"containerRight\">\n\n        <div class=\"editor\">\n          <div class=\"line-numbers\">\n            <span></span>\n          </div>\n          <textarea class=\"textarea\"></textarea>\n        </div><!-- /editor -->\n\n      </div><!-- /containerRight -->\n    </div><!-- /flex -->\n\n\n\n    <div class=\"commandLine\">\n      <span>></span><input class=\"cmd\" />\n    </div>\n\n\n<script>{{{payload.script}}}</script>\n\n  </body>\n</html>",
        "x": 970,
        "y": 160,
        "wires": [
            [
                "5c5841605bcac134"
            ]
        ]
    },
    {
        "id": "c8f4a55e7618b7e2",
        "type": "template",
        "z": "41d1b8798efe7e15",
        "name": "CSS",
        "field": "payload.style",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "/* Import Google Font - Poppins */\n@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');\n*{\nmargin: 0;\npadding: 0;\nbox-sizing: border-box;\nfont-family: 'Poppins', sans-serif;\ncolor:rgb(204, 204, 204)\n}\n*:focus\n{\noutline: none;\n}\nbody{\nwidth: 100%;\nheight: 100vh;\noverflow: hidden;\ndisplay: flex;\nalign-content: stretch;\nflex-direction: column;\n}\n.flex\n{\nwidth: 100%;\ndisplay: inline-flex;\nflex-grow: 1;\n}\n.containerLeft\n{\nwidth: 55%;\nbackground: #282b2f;\n/*box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);*/\n}\n.containerRight\n{\nheight: calc(100vh - 30px);\nwidth: 45%;\noverflow-y:auto;\nbackground-color: #1d2025;\nborder-left: 4px solid rgb(29, 31, 29);\n}\n\n/* BOTTOM CMD */\n.commandLine\n{\nline-height: 30px;\ncolor:darkslategray;\nwidth:100%;\nbackground-color: #0b0c0c;\npadding-left: 15px;\n}\n.cmd\n{\nwidth: calc(100% - 30px);\nheight: 100%;\nborder:0px;\nbackground-color: #0b0c0c;\npadding-left: 5px;\nfont-family: monospace;\nfont-size: 15px;\n}\n\n/* RIGHT CONTAINER - TEXT AREA\n.containerRight textarea\n{\nbackground: linear-gradient(135deg, #141618, #191c22);\npadding: 10px 20px;\nwidth:100%;\nheight:100vh;\nborder: 0px;\n} */\n.editor {\ndisplay: inline-flex;\nalign-content: stretch;\nline-height: 21px;\nfont-size: 12px;\nbackground: linear-gradient(135deg, #1a1c20, #1d2025);\nwidth:100%;\n}\n\n.textarea {\noverflow-wrap:break-word;\nwhite-space: pre-wrap;\nline-height: 21px;\n/*overflow-y: hidden;\nbackground: #282a3a;\nheight: 100vh;\ncolor: #FFF;*/\nmin-height: calc(100vh - 30px);\noverflow:hidden;\noutline: none;\nresize: none;\nfont-family: monospace;\nflex-grow: 1;\ncolor:rgb(214, 211, 211);\n\nbackground: linear-gradient(135deg, #141618, #191c22);\npadding: 10px 15px;\nborder: 0px;\n}\n.line-numbers {\npadding: 10px 0px;\nmargin-right: 10px;\nwidth: 35px;\ntext-align: right;\nflex-grow: 0;\n}\n\n.line-numbers span {\ncounter-increment: linenumber;\n}\n\n.line-numbers span::before {\ncontent: counter(linenumber);\ndisplay: block;\ncolor: darkslategray;\nfont-family: monospace;\n}\n\n\n\n\n/* LEFT CONTAINER - VISUAL EDITOR */\n.menu\n{\nbox-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);\nbackground: #282b2f;\nbackground: linear-gradient(135deg, rgb(29, 31, 29) 0%, rgb(22, 24, 24) 100%); /* #232626 */\n}\n.menu .menupoints\n{\nfont-size: 12px;\nline-height: 35px;\npadding-left: 12px;\ntext-transform: capitalize;\nbackground: linear-gradient(135deg, rgb(21, 22, 21) 0%, rgb(16, 17, 17) 100%);\n}\n.menupoints div\n{\ndisplay: inline-flex;\npadding: 0px 10px;\n}\n.menupoints div:hover\n{\nbackground: #232626;\ncursor: pointer;\n}\n\n.controls{\npadding: 7px 10px;\npadding-bottom: 14px;\ntext-align: left;\nmax-height: 61px;\noverflow-y: auto;\n}\n.controls div\n{\nfont-size: 12px;\ntext-transform: capitalize;\ncolor:darkslategray;\npadding-left: 3px;\n}\n.controls .button{\nborder: none;\nopacity: 0.4;\noutline: none;\ncolor: #fff;\ncursor: pointer;\nfont-size: 13px;\npadding: 8px 18px;\nmargin-top:4px;\nborder-radius: 3px;\nletter-spacing: 0.3px;\npointer-events: none;\ntransition: transform 0.25s ease;\nbackground: #344b48; /* 343c4b */\ntext-transform: capitalize;\n}\n.controls .button:not(:first-child)\n{\nmargin-left: 3px;\n}\n.button:hover\n{\nbackground: #4d6f6b;\n}\n.button.active{\nopacity: 1;\npointer-events: auto;\n}\n.button:active{\ntransform: scale(0.93);\n}\n\n\n\n\n.commandList\n{\npadding: 10px 8px;\nwidth:100%;\noverflow-y: auto;\nmax-height:calc(100vh - 126px);\nheight: 100%;\noverflow-x: hidden;\n/*background-color: darkslategray;*/\n}\n.commandList span\n{\npadding-left: 7px;\n}\n.commandList.overflow{\noverflow-y: auto;\n}\n*::-webkit-scrollbar{\nwidth: 5px;\n}\n*::-webkit-scrollbar-track{\nbackground: #3f4349;\nborder-radius: 25px;\n}\n*::-webkit-scrollbar-thumb{\nbackground: #6d6d6d;\nborder-radius: 25px;\n}\n\n\n.commandList .task\n{\nlist-style: none;\nfont-size: 15px;\n\nmargin-bottom: 5px;\nborder-radius: 5px;\n\nbox-shadow: 3px 3px 3px rgba(20, 20, 20, 0.05);\nbackground: linear-gradient(135deg, #32363a, #2d3135);\n}\n    .task.current\n    {\n        background: linear-gradient(135deg, #3f2f4f, #4a3859)!important;\n        /*background: linear-gradient(135deg, #99597d, #804b67)!important;*/\n    }\n    .task.error\n    {\n        background: linear-gradient(135deg, #6e4a48, #6b4a46)!important;\n        /*background: linear-gradient(135deg, #9c5c5c, #854e4e)!important;*/\n    }\n.commandList .task > div\n{\npadding-left: 20px;\ndisplay: inline-flex;\nalign-items: flex-start;\nflex-wrap: wrap;\ngap: 15px;\nwidth: 100%;\nmax-width: 100%!important;\npadding-top: 8px;\npadding-bottom: 8px;\nline-height: 25px;\n}\n.task span\n{\ncolor: rgb(136, 136, 136);\nfont-family: monospace;\nline-height: 25px;\nfont-size:12px;\n}\n.task p\n{\n    text-transform: capitalize;\n}\n.commandList .task > div > div\n{\ncolor: rgb(114, 153, 153);\nfont-family: monospace;\n}\n.commandList .task > div input\n{\nbackground-color: #535353;\nborder: 0px;\nborder-radius: 3px;\nline-height: 25px;\npadding: 0px 10px;\nfont-family: monospace;\nwidth: auto;\nmax-width: calc(100vh - 150px);\n}\n\n.commandList .task > div > div.filler\n{\nflex-grow: 1;\nflex-shrink: 1;\n}\n.commandList .settings\n{\nposition: relative;\nfloat: right;\npadding-right:10px;\n/*top: -16px;*/\nflex-grow: 0!important;\n}\n.settings :where(i, li){\ncursor: pointer;\n}\n.settings .bulletinMenu{\nz-index: 10;\nright: 12px;\npadding: 5px 0;\nbackground: #757575;\nposition: absolute;\nborder-radius: 4px;\ntransform: scale(0);\ntransform-origin: top right;\nbox-shadow: 0 0 6px rgba(0,0,0,0.15);\ntransition: transform 0.2s ease;\n}\n.commandList .task:last-child:not(:first-child) .bulletinMenu{\nbottom: 20px;\ntransform-origin: bottom right;\n}\n.commandList .task:not(:last-child) .bulletinMenu{\ntop: 20px;\n}\n/*\n.commandList .task:first-child .bulletinMenu{\nbottom: -65px;\ntransform-origin: top right;\n}*/\n.bulletinMenu.show{\ntransform: scale(1);\n}\n.bulletinMenu li{\nheight: 25px;\nfont-size: 12px;\nline-height: 25px;\nmargin-bottom: 2px;\npadding: 0px 10px;\nmin-width: 85px;\ncursor: pointer; list-style-type: none;\n}\n.bulletinMenu li:last-child{\nmargin-bottom: 0;\n}\n.settings li:hover{\nbackground: rgb(128, 128, 128);\n}\n.settings li i{\npadding-right: 8px;\n}",
        "x": 790,
        "y": 160,
        "wires": [
            [
                "a17c13f96787e2b4"
            ]
        ]
    },
    {
        "id": "b650822ef599b5ff",
        "type": "status",
        "z": "41d1b8798efe7e15",
        "name": "",
        "scope": [],
        "x": 1340,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "ba19f064476425c9",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "totalActionCount",
                "pt": "flow",
                "to": "pupController.totalActions",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1170,
        "y": 440,
        "wires": [
            [
                "580a9e3166314a22"
            ]
        ]
    },
    {
        "id": "357f74e2631da4c9",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.page",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "view-receipts",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "view-nograntreceipts",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "login",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "rules",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "grants",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "run",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "finalized",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "start",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 9,
        "x": 350,
        "y": 440,
        "wires": [
            [
                "13e976910d5e9707"
            ],
            [
                "5ab143a5c04fb163"
            ],
            [
                "d69d99eee8adcbf6"
            ],
            [
                "b24facdd74fa8b50"
            ],
            [
                "16bf0e6580aaf246"
            ],
            [
                "8b06ecbd2e4c4ecf"
            ],
            [
                "381970c176b042aa"
            ],
            [
                "c02e24bfe2197802"
            ],
            [
                "7e1f73ec1d40cafe"
            ]
        ]
    },
    {
        "id": "4c886c495ce2fe9d",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: start",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card-container mb-3\">\n    <!-- card-container -->\n\n    {{{payload.pageElements.lastRunCard}}}\n    \n    {{{payload.pageElements.actionsCard}}}\n    \n    {{{payload.pageElements.newRunCard}}}\n\n    <!-- /card-container -->\n</div>",
        "output": "str",
        "x": 1210,
        "y": 920,
        "wires": [
            [
                "1c7f385619f6a12d"
            ]
        ]
    },
    {
        "id": "66afcd1514727417",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: view-receipts",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"receipt-container\">\n    <!-- receipt-container -->\n\n    <div class=\"receipt-inner\">\n        <!-- receipt-inner -->\n\n        <div class=\"citizen-info\">\n            <!-- citizen-info -->\n\n            <ul class=\"nav nav-tabs\" role=\"tablist\" style=\"padding-bottom: 1.2px;margin-right: 5px;border-bottom:0px\">\n                <li class=\"nav-item\" role=\"presentation\">\n                    <a class=\"nav-link active\" data-bs-toggle=\"tab\" href=\"#overblik\" aria-selected=\"true\" role=\"tab\">Overblik</a>\n                </li>\n\n                <li class=\"nav-item\" role=\"presentation\">\n                    <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#sager\" aria-selected=\"false\" tabindex=\"-1\" role=\"tab\">Alle sager</a>\n                </li>\n            </ul>\n            \n            <div id=\"myTabContent\" class=\"tab-content bg-white p-3\">\n                <div class=\"tab-pane show active\" id=\"overblik\" role=\"tabpanel\">\n\n                    <!-- -->\n                    <h4 class=\"card-title mb-4\">\n                        {{payload.tempData.cpr}}<small class=\"text-secondary\"> - XXXX</small>\n                        <a href=\"https://fagsystem.kommunernespensionssystem.dk/spk-fagsystem/person/{{payload.tempData.persondata.kpurl}}/overblik\" target=\"_blank\">\n                            <span class=\"float-right text-muted\"><i class=\"fas fa-2xs fa-link\"></i></span>\n                        </a>\n                    </h4>\n                    <!-- p class=\"card-text\">Some quick example text to build on the card title and make up the bulk of the card's content.</p -->\n                    \n                    {{{payload.tempData._bevilling}}}\n\n                    <div class=\"d-flex flex-wrap\" style=\"gap: 3px\">\n                        {{{payload.tempData.persondata._sager}}}\n                    </div>\n\n\n                    <div class=\"d-flex justify-stretch mt-4\" style=\"gap: 3px\">\n\n                        <div class=\"card border-light bg-light mb-2 text-center p-1\">\n                            <div class=\"text-secondary fs-10\">FORMUE</div>\n                            {{payload.tempData.persondata._formue}}\n                        </div>\n\n                        <div class=\"card border-light bg-light mb-2 text-center p-1\">\n                            <div class=\"text-secondary fs-10\">DANMARK</div>\n                            {{payload.tempData.persondata._danmark}}\n                        </div>\n                        \n                        <div class=\"card border-light bg-light mb-2 text-center p-1\">\n                            <div class=\"text-secondary fs-10\">TILLÆGSPROCENT</div>\n                            {{payload.tempData.persondata._htillaegsprocent}} %\n                        </div>\n\n                    </div>\n                \n                    <!-- -->\n                    \n                </div>\n\n                <div class=\"tab-pane\" id=\"sager\" role=\"tabpanel\">\n\n                    <table class=\"table fs-11\" style=\"margin-left:-8px;margin-right:0px;\">\n                        <thead class=\"border-none\">\n                            <tr>\n                            <th scope=\"col\"><span class=\"table-header\">Titel</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Sagstype</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Start</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Slut</span></th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            {{#payload.tempData.persondata.sager}}\n                            <tr>\n                                <td>{{titel}}</td>\n                                <th scope=\"row\">{{type}}</th>\n                                <td>{{fra}}</td>\n                                <td>{{til}}</td>\n                            </tr>\n                            {{/payload.tempData.persondata.sager}}\n                        </tbody>\n                    </table>\n                    \n                </div>\n                \n            </div>\n\n            <!-- /citizen-info -->\n        </div>\n\n        <div>\n            \n            \n            {{{payload.tempData._faktura}}}\n\n\n        </div>\n\n        \n        \n\n        <!-- /receipt-inner -->\n    </div>\n    \n\n    <div class=\"pagination-container mt-3\">\n\n        \n        <ul class=\"pagination\">\n            {{{payload.tempData._pagination}}}\n        </ul>\n\n        {{{payload.tempData._archive}}}\n\n        </div>\n\n    <!-- /receiptContainer -->\n</div>",
        "output": "str",
        "x": 1430,
        "y": 260,
        "wires": [
            [
                "ae78e3fc89996dac"
            ]
        ]
    },
    {
        "id": "1c7f385619f6a12d",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 920,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "ae78e3fc89996dac",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Fakturaer",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload.tempData",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.tempDataArray",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1650,
        "y": 260,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "32eb88cfb3101407",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "set full page HTML",
        "field": "payload.pageHTML",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html>\n    <head>\n        <title>AutoWorkLet - Randers Kommune</title>\n        <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css\" rel=\"stylesheet\">\n        <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js\" integrity=\"sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4\" crossorigin=\"anonymous\"></script>\n        <style>{{{css}}}</style>\n    </head>\n    <body>\n<div id=\"fullPage\" style=\"width: 100%;height:100%\">\n<!-- -->\n\n\n{{{payload.pageElements.navbar}}}\n\n<div class=\"progress-container collapsed\">\n\n    <div class=\"uppercase fs-10 fw-500 mb-1\" style=\"width:100%;text-align: center;\">Robotten arbejder ... 56%</div>\n\n    <div class=\"progress bg-dark\">\n        <div class=\"progress-bar progress-bar-striped progress-bar-animated\" role=\"progressbar\" aria-valuenow=\"75\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width: 75%;\"></div>\n    </div>\n\n\n</div>\n\n    \n  \n<div class=\"container site-container mt-3\">\n    <!-- site -->\n\n    <ol class=\"breadcrumb\">\n        <li class=\"breadcrumb-item active\">{{{payload.pageTitle}}}</li>\n    </ol>\n\n    <div id=\"alertParent\">\n        <div class=\"alert alert-dismissible hidden\" id=\"alertBox\">\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\n            <h4 class=\"alert-heading\" id=\"alertBox-heading\">Warning!</h4>\n            <p class=\"mb-0\" id=\"alertBox-body\">Best check yo self, you're not looking too good. Nulla vitae elit libero, a pharetra augue. Praesent commodo cursus magna, <a href=\"#\" class=\"alert-link\">vel scelerisque nisl consectetur et</a>.</p>\n        </div>\n    </div>\n\n    <div id=\"pageContent\">\n        {{{payload.pageContent}}}\n    </div>\n\n    <!-- /site -->\n</div>\n\n\n\n\n\n</div>\n<!-- -->\n\n    <script>{{{js}}}</script>\n    </body>\n</html>",
        "output": "str",
        "x": 2050,
        "y": 580,
        "wires": [
            [
                "193590a736c24869"
            ]
        ]
    },
    {
        "id": "f673e8538a4af3d9",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: login",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">WorkLet loginoplysninger</div>\n    <div class=\"card-body\">\n        <p class=\"card-text\">Før du kan søge efter fakturaer, skal du indtaste kommunens loginoplysninger til WorkLet.</p>\n        \n        <div class=\"form-group\" id=\"form-group\">\n            <input type=\"hidden\" id=\"requestType\" value=\"acceptPage\">\n            <input type=\"hidden\" id=\"pageToAccept\" value=\"login\">\n            <input type=\"hidden\" id=\"toAccept\" value=\"{{payload.pageElements.loginToAccept}}\">\n            \n            <div class=\"form-floating mb-3\">\n            <input type=\"text\" class=\"form-control\" id=\"workletUser\" placeholder=\"name@example.com\" autocomplete=\"off\">\n            <label for=\"workletUser\">Email addresse</label>\n            </div>\n            <div class=\"form-floating\">\n            <input type=\"text\" class=\"form-control\" id=\"workletPass\" placeholder=\"Password\" style=\"font-family: 'password'\">\n            <label for=\"workletPass\">Kodeord</label>\n            </div>\n        </div>\n\n        {{{payload.pageElements.loginButtons}}}\n\n    </div>\n</div>\n\n",
        "output": "str",
        "x": 1330,
        "y": 320,
        "wires": [
            [
                "e36e40cecb56969d"
            ]
        ]
    },
    {
        "id": "e36e40cecb56969d",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Loginoplysninger",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1510,
        "y": 340,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "af684cb65465eef9",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: rules",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">Forretningsregler</div>\n    <div class=\"card-body\">\n        <h6 class=\"card-subtitle mb-2 text-muted\">Sæt kriterier for tilskud</h6>\n        <p class=\"card-text\">Kontrollér/sæt og derefter godkendt forretningsreglerne som robotten benytter som beslutningsgrundlag.</p>\n        \n        <div class=\"form-group\" id=\"form-group\">\n            <div class=\"mt-3 border-bottom\" style=\"padding-left: 15px;padding-right: 15px\">\n                <input type=\"hidden\" id=\"requestType\" value=\"acceptPage\">\n                <input type=\"hidden\" id=\"pageToAccept\" value=\"rules\">\n                <input type=\"hidden\" id=\"toAccept\" value=\"{{payload.pageElements.rulesToAccept}}\">\n            \n                {{{payload.pageElements.ruleList}}}\n\n            </div>\n        </div>\n\n        {{{payload.pageElements.rulesButtons}}}\n\n    </div>\n</div>",
        "output": "str",
        "x": 1510,
        "y": 440,
        "wires": [
            [
                "ec0875277dd56ced"
            ]
        ]
    },
    {
        "id": "ec0875277dd56ced",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Forretningsregler",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1670,
        "y": 440,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "f4ed528cde3cabe7",
        "type": "subflow:db94b4c117de2f6a",
        "z": "43652557380ac3f3",
        "name": "",
        "x": 210,
        "y": 120,
        "wires": [
            [
                "d64936a739a436db"
            ]
        ]
    },
    {
        "id": "1d2a94a05f330839",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: navbar",
        "func": "// Set menu html\n\nvar dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\n\nvar currentRunExists = global.get(\"runHistory\", \"storeInFile\") !== null && global.get(\"runHistory\", \"storeInFile\") !== undefined && (\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ? !(global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]).isFinalized : !(global.get(\"runHistory\", \"storeInFile\")).isFinalized);\n\nvar currentRun = currentRunExists ?\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ?\n        global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]\n        : global.get(\"runHistory\", \"storeInFile\") : null;\n\nconst receiptsAwaiting = currentRunExists ? !currentRun.allReceiptsProcessed : false;\nconst isBeingProcessed = currentRunExists ? !currentRun.isFinalized : false;\n\n\nfunction isActive(pageName)\n{\n    return (msg.payload.webSettings.state.activePage == pageName);\n}\nfunction pageAccepted(pageName)\n{\n    return (msg.payload.webSettings.acceptances[pageName]);\n}\n\nvar html = `<nav class=\"navbar navbar-expand-lg navbar-dark bg-primary\" >\n    <div class=\"container-fluid\">\n        <a class=\"navbar-brand randers-logo\" onclick=\"goToPage('start')\"></a>\n        <a class=\"navbar-brand randers-titel\" onclick=\"goToPage('start')\"></a>\n        <ul class=\"navbar-nav me-auto\">\n            <li class=\"nav-item\">\n                <a id=\"nav_start\" class=\"nav-link`+\n                (isActive('start') ? \" active\" : \"\")\n                +`\" onclick=\"goToPage('start')\">Start</a>\n            </li>\n            <li class=\"nav-item\">\n                <a id=\"nav_login\" class=\"nav-link`+\n                (isActive('login') ? \" active\" : \"\") + \n                (pageAccepted('login') ? \" nav-success\" : \"\")\n                +`\" onclick=\"goToPage('login')\">Loginoplysninger</a>\n            </li>\n            <li class=\"nav-item\">\n                <a id=\"nav_rules\" class=\"nav-link`+\n                (isActive('rules') ? \" active\" : \"\") +\n                (pageAccepted('rules') ? \" nav-success\" : \"\")\n                +`\" onclick=\"goToPage('rules')\">Forretningsregler</a>\n            </li>\n            <li class=\"nav-item\">\n                <a id=\"nav_grants\" class=\"nav-link`+\n                (isActive('grants') ? \" active\" : \"\") +\n                (pageAccepted('grants') ? \" nav-success\" : \"\")\n                +`\" onclick=\"goToPage('grants')\">Tilskudssatser</a>\n            </li>`;\n\n\nvar receiptCount = 0;\n\nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptCount += global.get(\"webData\")[\"citizens-actions\"].length;\n\nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined)\n        receiptCount += global.get(\"webData\")[\"citizens-noactions\"].length;\n\n\nif (msg.payload.webSettings.state.isRunning )\n        html +=\n            `<li class=\"nav-item\">\n            <a id=\"nav_run\" class=\"nav-link`+\n            (isActive('run') ? \" active\" : \"\")\n            + `\" onclick=\"goToPage('run')\">` +\n            `Robotten kører<i class=\"fa-lg fas fa-spinner fa-spin\" style=\"margin-left: 10px\"></i>`\n            + `</a>\n        </li>`;\nelse if ((isBeingProcessed && !dataExists) || (receiptsAwaiting && receiptCount == 0))\n    html +=\n        `<li class=\"nav-item\">\n            <a id=\"nav_run\" class=\"nav-link`+\n            (isActive('run') ? \" active\" : \"\")\n            + `\" onclick=\"goToPage('run')\">Genoptag kørsel</a>\n        </li>`;\n\nelse if (receiptsAwaiting && isBeingProcessed)\n    html +=\n        `<li class=\"nav-item\">\n            <a id=\"nav_view-receipts\" class=\"nav-link`+\n            (isActive('view-receipts') ? \" active\" : \"\")\n            + `\" onclick=\"goToPage('view-receipts')\">Anbefalede handlinger</a>\n        </li>`\n    +  `<li class=\"nav-item\">\n            <a id=\"nav_view-nograntreceipts\" class=\"nav-link`+\n            (isActive('view-nograntreceipts') ? \" active\" : \"\")\n            + `\" onclick=\"goToPage('view-nograntreceipts')\">Borgere uden bevilling</a>\n        </li>`;\n\nelse if (!receiptsAwaiting && isBeingProcessed)\n    html +=\n        `<li class=\"nav-item\">\n            <a id=\"nav_view-receipts\" class=\"nav-link`+\n        (isActive('view-receipts') ? \" active\" : \"\")\n        + `\" onclick=\"goToPage('view-receipts')\">Anbefalede handlinger</a>\n        </li>`\n        + `<li class=\"nav-item\">\n            <a id=\"nav_view-nograntreceipts\" class=\"nav-link`+\n        (isActive('view-nograntreceipts') ? \" active\" : \"\")\n        + `\" onclick=\"goToPage('view-nograntreceipts')\">Borgere uden bevilling</a>\n        </li>`\n        +\n        `<li class=\"nav-item\">\n            <a id=\"nav_run\" class=\"nav-link`+\n            (isActive('run') ? \" active\" : \"\")\n            +`\" onclick=\"goToPage('run')\">Afslut kørsel</a>\n        </li>`;\n\nelse if (pageAccepted('login') && pageAccepted('rules') && pageAccepted('grants'))\n    html +=\n        `<li class=\"nav-item\">\n            <a id=\"nav_run\" class=\"nav-link`+\n            (isActive('run') ? \" active\" : \"\")\n            + `\" onclick=\"goToPage('run')\">` +\n            (msg.payload.webSettings.state.isRunning ? `Robotten kører<i class=\"fa-lg fas fa-spinner fa-spin\" style=\"margin-left: 10px\"></i>` : `Ny kørsel`)\n            + `</a>\n        </li>`;\n\n\n/*\n\n            (receiptsAwaiting && isBeingProcessed ?\n            (`<li class=\"nav-item\">\n                                    <a id=\"nav_view-receipts\" class=\"nav-link`+\n                (isActive('view-receipts') ? \" active\" : \"\")\n                + `\" onclick=\"goToPage('view-receipts')\">Anbefalede handlinger</a>\n                        </li>`)\n            +\n            (`<li class=\"nav-item\">\n                                    <a id=\"nav_view-nograntreceipts\" class=\"nav-link`+\n                (isActive('view-nograntreceipts') ? \" active\" : \"\")\n                + `\" onclick=\"goToPage('view-nograntreceipts')\">Ej berettigede borgere</a>\n                        </li>`) : ``)\n            +\n\n            ((isBeingProcessed && !dataExists) ? \n                ` <li class=\"nav-item\">\n                                    <a id=\"nav_run\" class=\"nav-link`+\n                (isActive('run') ? \" active\" : \"\") +\n                (pageAccepted('grants') ? \" nav-success\" : \"\") +\n                + `\" onclick=\"goToPage('run')\">Genoptag kørsel</a>\n                    </li>`\n                :\n\n\n                ((!receiptsAwaiting && isBeingProcessed) ? \n                ` <li class=\"nav-item\">\n                        <a id=\"nav_run\" class=\"nav-link`+\n                (isActive('run') ? \" active\" : \"\") +\n                +`\" onclick=\"goToPage('run')\">Afslut kørsel</a>\n                    </li>`\n                :\n                \n                ((pageAccepted('login') && pageAccepted('rules') && pageAccepted('grants')) ?\n                `<li class=\"nav-item\">\n                    <a id=\"nav_run\" class=\"nav-link`+\n                    (isActive('run') ? \" active\" : \"\")\n                    +`\" onclick=\"goToPage('run')\">`+\n                    (msg.payload.webSettings.state.isRunning ? `Robotten kører<i class=\"fa-lg fas fa-spinner fa-spin\" style=\"margin-left: 10px\"></i>` : `Ny kørsel`)\n                    +`</a>\n                </li>` : ``))\n            )\n\n*/\nhtml += `\n        </ul>\n    </div>\n</nav >`;\n\nmsg.payload.pageElements['navbar'] = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2040,
        "y": 460,
        "wires": [
            [
                "32eb88cfb3101407"
            ]
        ]
    },
    {
        "id": "647c902f1fdaa12d",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: lastRunCard",
        "field": "payload.pageElements.lastRunCard",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card border-light\">\n    <div class=\"card-header\">Seneste kørsel </div>\n    <div class=\"card-body\">\n        <h4 class=\"card-title\">1 dag siden</h4>\n        <p class=\"card-text\">Robotten kørte sidst i går kl. 14:35.<br />\n                                <div class=\"mt-1\">\n                                <strong>0</strong> fakturaer automatisk behandlet.<br />\n                                <strong>5</strong> fakturaer sat til manuel behandling.</p>\n                            </div>\n    </div>\n</div>",
        "output": "str",
        "x": 1160,
        "y": 820,
        "wires": [
            []
        ]
    },
    {
        "id": "b51ae96408813a15",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageElements",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 265,
        "y": 440,
        "wires": [
            [
                "357f74e2631da4c9"
            ]
        ],
        "l": false
    },
    {
        "id": "e28a947808d42c1c",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: manualProcessingCard",
        "field": "payload.pageElements.manualProcessingCard",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card border-warning\">\n    <div class=\"card-header\">Manuel behandling</div>\n    <div class=\"card-body\">\n        <h4 class=\"card-title\">5 fakturaer afventer</h4>\n        <p class=\"card-text\">Efter seneste kørsel er der 5 fakturaer som afventer din behandling.</p>\n        <div class=\"d-grid\">\n            <button class=\"btn btn-lg btn-light border-light\" type=\"button\" onclick=\"goToPage('view-receipts')\">Se fakturaer</button>\n        </div>\n    </div>\n</div>",
        "output": "str",
        "x": 1210,
        "y": 840,
        "wires": [
            []
        ]
    },
    {
        "id": "e4fc06b7c36a80c5",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: newRunCard",
        "field": "payload.pageElements.newRunCard",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card {{payload.pageElements.newRunCardClasses}}\">\n    <div class=\"card-header\">{{payload.pageElements.newRunCardHeader}}</div>\n    <div class=\"card-body\">\n       {{{payload.pageElements.newRunCardBody}}}\n    </div>\n</div>",
        "output": "str",
        "x": 960,
        "y": 960,
        "wires": [
            [
                "4c886c495ce2fe9d"
            ]
        ]
    },
    {
        "id": "220a6e666845a7aa",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Start",
        "info": "",
        "x": 710,
        "y": 840,
        "wires": []
    },
    {
        "id": "927b1a1a92e941cd",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.webSettings.acceptances.rules",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 440,
        "wires": [
            [
                "8f1889ef41f2b0f2"
            ],
            [
                "ecdf72546c22bbab"
            ]
        ]
    },
    {
        "id": "d87b864a541f79a5",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Rules",
        "info": "",
        "x": 710,
        "y": 400,
        "wires": []
    },
    {
        "id": "ecdf72546c22bbab",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: ruleList",
        "field": "payload.pageElements.ruleList",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{{#payload.rules}}\n    <div class=\"row border-top pb-2 pt-2 \">\n\n\n        <div class=\"col-2 d-flex flex-column justify-content-center\">\n            <span>{{name}}</span>\n        </div>\n\n        <div class=\"form-floating col was-validated\">\n            <select class=\"form-select\" id=\"operator_{{uid}}\" onchange=\"setInputBox('{{uid}}');withdrawPageAccept('rules')\">\n                <option value=\"==\">= Skal være lig med</option>\n                <option value=\"!=\">≠ Må ikke være lig med</option>\n                <option value=\"<\">< Skal være mindre end</option>\n                <option value=\">\">> Skal være større end</option>\n                <option value=\"contains\">{?} Indeholder</option>\n                <option value=\"!contains\">{!} Indeholder ikke</option>\n                <option value=\"!null\">[o] Skal være oplyst</option>\n            </select>\n            <label for=\"operator_{{uid}}\" style=\"padding-left: 27px\">Logisk beregningsmetode</label>\n        </div>\n\n        <div class=\"form-floating col was-validated\" id=\"inputContainer_{{uid}}\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{uid}}\" placeholder=\"0\" value=\"{{value}}\" onchange=\"withdrawPageAccept('rules')\">\n            <label for=\"value_{{uid}}\" style=\"padding-left: 27px\">Værdi</label>\n        </div>\n\n\n    </div>\n{{/payload.rules}}",
        "output": "str",
        "x": 1080,
        "y": 460,
        "wires": [
            [
                "4d85f3207c9d8fa1",
                "88fb35ef462682b4"
            ]
        ]
    },
    {
        "id": "8f1889ef41f2b0f2",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: ruleList",
        "field": "payload.pageElements.ruleList",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{{#payload.rules}}\n    <div class=\"row border-top pb-2 pt-2 \">\n\n\n        <div class=\"col-2 d-flex flex-column justify-content-center\">\n            <span>{{name}}</span>\n        </div>\n\n        <div class=\"form-floating col\">\n            <select class=\"form-select\" id=\"operator_{{uid}}\" onchange=\"setInputBox('{{uid}}');withdrawPageAccept('rules')\">\n                <option value=\"==\">= Skal være lig med</option>\n                <option value=\"!=\">≠ Må ikke være lig med</option>\n                <option value=\"<\">< Skal være mindre end</option>\n                <option value=\">\">> Skal være større end</option>\n                <option value=\"contains\">{?} Indeholder</option>\n                <option value=\"!contains\">{!} Indeholder ikke</option>\n                <option value=\"!null\">[o] Skal være oplyst</option>\n            </select>\n            <label for=\"operator_{{uid}}\" style=\"padding-left: 27px\">Logisk beregningsmetode</label>\n        </div>\n\n        <div class=\"form-floating col\" id=\"inputContainer_{{uid}}\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{uid}}\" placeholder=\"0\" value=\"{{value}}\" onchange=\"withdrawPageAccept('rules')\">\n            <label for=\"value_{{uid}}\" style=\"padding-left: 27px\">Værdi</label>\n        </div>\n\n\n    </div>\n{{/payload.rules}}",
        "output": "str",
        "x": 1080,
        "y": 420,
        "wires": [
            [
                "26a5a4e0e501d7e9"
            ]
        ]
    },
    {
        "id": "26a5a4e0e501d7e9",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: rulesButtons",
        "field": "payload.pageElements.rulesButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-primary\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'ruleUpdates', 'value': appendRules (null {{#payload.rules}}, createRuleObj('{{uid}}') {{/payload.rules}}) } ))\">\n        Godkend forretningsregler\n    </button>\n    \n    <button class=\"btn btn-lg btn-primary ml-2 goNext hidden\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('grants')\">\n        Gå til tilskudssatser\n    </button>\n</div>\n",
        "output": "str",
        "x": 1300,
        "y": 420,
        "wires": [
            [
                "af684cb65465eef9"
            ]
        ]
    },
    {
        "id": "4d85f3207c9d8fa1",
        "type": "template",
        "z": "43652557380ac3f3",
        "d": true,
        "name": "element: rulesButtons",
        "field": "payload.pageElements.rulesButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'ruleUpdates', 'value': appendRules (null {{#payload.rules}}, createRuleObj('{{uid}}') {{/payload.rules}}) } ))\">\n        Forretningsregler godkendt\n    </button>\n\n    <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('grants')\">\n        Gå til tilskudssatser\n    </button>\n</div>\n",
        "output": "str",
        "x": 1300,
        "y": 460,
        "wires": [
            [
                "af684cb65465eef9"
            ]
        ]
    },
    {
        "id": "d5e098f6bd51179b",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "Set ActivePage",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.activePage",
                "pt": "global",
                "to": "payload.page",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.webSettings.state.activePage",
                "pt": "msg",
                "to": "payload.page",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 140,
        "y": 440,
        "wires": [
            [
                "b51ae96408813a15"
            ]
        ]
    },
    {
        "id": "7e1f73ec1d40cafe",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "Set ActivePage",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.activePage",
                "pt": "global",
                "to": "start",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "payload.webSettings.state.activePage",
                "pt": "msg",
                "to": "start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 520,
        "y": 880,
        "wires": [
            [
                "c02e24bfe2197802"
            ]
        ]
    },
    {
        "id": "b24facdd74fa8b50",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "rulesToAccept?",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageElements.rulesToAccept",
                "pt": "msg",
                "to": "payload.webSettings.acceptances.rules = true ? false : true",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 440,
        "wires": [
            [
                "927b1a1a92e941cd"
            ]
        ]
    },
    {
        "id": "64b34f33550bce8e",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Login",
        "info": "",
        "x": 710,
        "y": 300,
        "wires": []
    },
    {
        "id": "d69d99eee8adcbf6",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "loginToAccept?",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageElements.loginToAccept",
                "pt": "msg",
                "to": "payload.webSettings.acceptances.login = true ? false : true",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 340,
        "wires": [
            [
                "d5dda5bcbcb28f81"
            ]
        ]
    },
    {
        "id": "d5dda5bcbcb28f81",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.webSettings.acceptances.login",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 340,
        "wires": [
            [
                "f1b774e14fa10452"
            ],
            [
                "2c36135f9e6b4609",
                "53d7186bbca94b8d"
            ]
        ]
    },
    {
        "id": "f4ff9a7a66ddb884",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: login",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">WorkLet loginoplysninger</div>\n    <div class=\"card-body\">\n        <p class=\"card-text\">Før du kan søge efter fakturaer, skal du indtaste kommunens loginoplysninger til WorkLet.</p>\n        \n        <div class=\"form-group\" id=\"form-group\">\n            <input type=\"hidden\" id=\"requestType\" value=\"acceptPage\">\n            <input type=\"hidden\" id=\"pageToAccept\" value=\"login\">\n            <input type=\"hidden\" id=\"toAccept\" value=\"{{payload.pageElements.loginToAccept}}\">\n            \n            <div class=\"form-floating mb-3 was-validated\">\n            <input type=\"text\" class=\"form-control\" id=\"workletUser\" placeholder=\"name@example.com\" autocomplete=\"off\">\n            <label for=\"workletUser\">Email addresse</label>\n            </div>\n            <div class=\"form-floating  was-validated\">\n            <input type=\"text\" class=\"form-control\" id=\"workletPass\" placeholder=\"Password\" style=\"font-family: 'password'\">\n            <label for=\"workletPass\">Kodeord</label>\n            </div>\n        </div>\n\n        {{{payload.pageElements.loginButtons}}}\n\n    </div>\n</div>\n\n",
        "output": "str",
        "x": 1330,
        "y": 360,
        "wires": [
            [
                "e36e40cecb56969d"
            ]
        ]
    },
    {
        "id": "f1b774e14fa10452",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: loginButtons",
        "field": "payload.pageElements.loginButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-primary\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), document.getElementById('workletUser'), document.getElementById('workletPass') ))\">\n        Godkend loginoplysninger\n    </button>\n    \n    <button class=\"btn btn-lg btn-primary ml-2 goNext hidden\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('rules')\">\n        Gå til forretningsregler\n    </button>\n</div>\n",
        "output": "str",
        "x": 1100,
        "y": 320,
        "wires": [
            [
                "f673e8538a4af3d9"
            ]
        ]
    },
    {
        "id": "2c36135f9e6b4609",
        "type": "template",
        "z": "43652557380ac3f3",
        "d": true,
        "name": "element: loginButtons",
        "field": "payload.pageElements.loginButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept') ))\">\n        Loginoplysninger godkendt\n    </button>\n    \n    <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('rules')\">\n        Gå til forretningsregler\n    </button>\n</div>\n",
        "output": "str",
        "x": 1100,
        "y": 360,
        "wires": [
            [
                "f4ff9a7a66ddb884"
            ]
        ]
    },
    {
        "id": "833c75852163c6a6",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "newRunCard body",
        "func": "// Set menu html\nconst loginAccepted = msg.payload.webSettings.acceptances.login;\nconst rulesAccepted = msg.payload.webSettings.acceptances.rules;\nconst grantsAccepted = msg.payload.webSettings.acceptances.grants;\nconst isRunning = msg.payload.webSettings.state.isRunning;\n\n\nvar dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\n\nvar currentRunExists = global.get(\"runHistory\", \"storeInFile\") !== null && global.get(\"runHistory\", \"storeInFile\") !== undefined && (\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ? !(global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]).isFinalized : !(global.get(\"runHistory\", \"storeInFile\")).isFinalized);\n\nvar currentRun = currentRunExists ?\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ?\n        global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]\n        : global.get(\"runHistory\", \"storeInFile\") : null;\n\nconst receiptsAwaiting = currentRunExists ? !currentRun.allReceiptsProcessed : false;\nconst isBeingProcessed = currentRunExists ? !currentRun.isFinalized : false;\n\n\nvar rejectedCitizenCount = 0; //global.get(\"webData\")[\"citizens-noactions\"] == null ? 0 : global.get(\"webData\")[\"citizens-noactions\"].length;\nvar receiptCount = 0;\n\nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptCount += global.get(\"webData\")[\"citizens-actions\"].length;\n\nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined)\n    {\n        rejectedCitizenCount = global.get(\"webData\")[\"citizens-noactions\"].length;\n        receiptCount += rejectedCitizenCount;\n    }\n\nvar remainingCount = 0;\n\nfor (var i = 0; i < rejectedCitizenCount; i++)\n    if (!(global.get(\"webData\")[\"citizens-noactions\"])[i].archived)\n        remainingCount++;\n\nrejectedCitizenCount = remainingCount;\n\n\n\nvar cardHeader = \"Ny kørsel\";\nvar cardTitle =\"Kør nu\";\nvar cardText = \"Robotten er nu klar til at søge efter nye fakturaer og beregne tilskud!\";\nvar buttonText = \"Kør robot\";\nvar linkhref = \"run\";\nvar border = \"light\";\nvar buttonClasses = \" \";\n\n\n\nif (isRunning) {\n    cardTitle = \"Robotten arbejder ... <i class='float-right fa-md fas fa-spinner fa-spin' style='margin-right: 5px'></i>\";\n    cardText = \"Robotten arbejder på at finde nye fakturaer samt beregne tilskud.\"\n    buttonText = \"Vent venligst\";\n    buttonClasses += \"hidden\";\n    linkhref = \"view-receipts\";\n    border = \"info\";\n}\nelse if ((receiptsAwaiting && isBeingProcessed && !dataExists) || (receiptsAwaiting && receiptCount == 0))\n{\n    cardHeader = \"Genoptag kørsel\";\n    cardTitle = \"Data mangler\";\n    cardText = \"Genoptag kørslen for at hente manglende data.\";\n    linkhref = \"run\";\n    buttonText = \"Genoptag\";\n}\n\nelse if (receiptsAwaiting && rejectedCitizenCount > 0)\n{\n    cardHeader = \"Borgere uden gyldig bevilling\";\n    cardTitle = rejectedCitizenCount == 0 ? \"Ingen fakturaer\" : rejectedCitizenCount + \" borgere afventer\";\n    cardText = \"Efter seneste kørsel er der \" + rejectedCitizenCount + \" borgere uden gyldig bevilling som afventer bekræftelse.\";\n    buttonText = \"Se borgere\";\n    buttonClasses += rejectedCitizenCount == 0 ? \"hidden\" : \"\";\n    linkhref = \"view-nograntreceipts\";\n    border = rejectedCitizenCount > 0 ? \"warning\" : \"light\";\n\n}\nelse if (isBeingProcessed && !receiptsAwaiting)\n{\n    cardHeader = \"Afslut kørsel\";\n    cardTitle = \"Alle borgere behandlet\",\n    cardText = \"Alle anbefalede handlinger samt ej berretigede borgere er bekræftet. Afslut kørslen nu.\"\n    buttonText = \"Afslut kørsel\";\n    border = \"success\";\n}\n\nelse if (receiptsAwaiting && rejectedCitizenCount == 0)\n{\n    cardHeader = \"Afslut kørsel\";\n    cardTitle = \"Alle borgere behandlet\",\n        cardText = \"Alle borgere uden bevilling er bekræftet. Bekræft anbefalede handlinger før du afslutter kørslen.\"\n    buttonText = \"Afslut kørsel\";\n    buttonClasses += \"disabled\";\n}\n\nelse if (!loginAccepted) {\n    cardTitle = \"Godkend login\";\n    cardText = \"Før du kan søge efter nye fakturaer, skal du godkende loginoplysninger.\"\n    buttonText = \"Gå til loginoplysninger\";\n    linkhref = \"login\";\n}\n\nelse if (!rulesAccepted) {\n    cardTitle = \"Godkend regelsæt\";\n    cardText = \"Før du kan søge efter nye fakturaer, skal du godkende forretningsregler.\"\n    buttonText = \"Gå til forretningsregler\";\n    linkhref = \"rules\";\n}\n\nelse if(!grantsAccepted)\n{\n    cardTitle = \"Godkend tilskudssatser\";\n    cardText = \"Før du kan søge efter nye fakturaer, skal du godkende tilskudssatser.\"\n    buttonText = \"Gå til tilskudssatser\";\n    linkhref = \"grants\";\n}\n\n\nvar classes = \"border-\" + border;\n\nvar html = `<h4 class=\"card-title\">`+cardTitle+`</h4>\n        <p class=\"card-text\">`+cardText+`</p>\n        <div class=\"d-grid\">\n            <button class=\"btn btn-lg btn-light border-light`+buttonClasses+`\" onclick=\"goToPage('`+linkhref+`')\">`+buttonText+`</button>\n        </div>`;\n\nmsg.payload.pageElements['newRunCardBody'] = html;\nmsg.payload.pageElements['newRunCardClasses'] = classes;\nmsg.payload.pageElements['newRunCardHeader'] = cardHeader;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 960,
        "wires": [
            [
                "e4fc06b7c36a80c5"
            ]
        ]
    },
    {
        "id": "3ddbdc7f1b2f9ec5",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Receipts",
        "info": "",
        "x": 720,
        "y": 20,
        "wires": []
    },
    {
        "id": "25eef4e978cf76c9",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: grants",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">Tilskudssatser</div>\n    <div class=\"card-body\">\n        <h6 class=\"card-subtitle mb-2 text-muted\">Sæt tilskudssatserne fra Danmark</h6>\n        <p class=\"card-text\">Kontrollér/sæt og derefter godkendt tilskudssatserne som robotten fratrækker tilskudsberegningen såfremt borgeren modtager tilskud fra Sygesikring Danmark.</p>\n        \n        <div class=\"form-group\" id=\"form-group\">\n            <div class=\"mt-3 border-bottom\" style=\"padding-left: 15px;padding-right: 15px\">\n                <input type=\"hidden\" id=\"requestType\" value=\"acceptPage\">\n                <input type=\"hidden\" id=\"pageToAccept\" value=\"grants\">\n                <input type=\"hidden\" id=\"toAccept\" value=\"{{payload.pageElements.grantsToAccept}}\">\n            \n                {{{payload.pageElements.grantList}}}\n\n            </div>\n        </div>\n\n        {{{payload.pageElements.grantButtons}}}\n\n    </div>\n</div>",
        "output": "str",
        "x": 1510,
        "y": 540,
        "wires": [
            [
                "40780cb4bb9bca19"
            ]
        ]
    },
    {
        "id": "40780cb4bb9bca19",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Tilskudssatser",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1670,
        "y": 540,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "6839897d12a405ac",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.webSettings.acceptances.grants",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 540,
        "wires": [
            [
                "08ae4c04ae16a403"
            ],
            [
                "04dafd05828f33bf"
            ]
        ]
    },
    {
        "id": "ad6ebb9c838e1c6c",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Grants",
        "info": "",
        "x": 710,
        "y": 500,
        "wires": []
    },
    {
        "id": "04dafd05828f33bf",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: grantList",
        "field": "payload.pageElements.grantList",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{{#payload.grants.tilskudsperioder.satser}}\n    <div class=\"row border-top pb-2 pt-2 \">\n\n\n        <div class=\"col-2 d-flex flex-column justify-content-center\">\n            <span>{{titel}}</span>\n        </div>\n\n        <div class=\"form-floating col was-validated\" id=\"inputContainer_{{id}}_procent\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{id}}_procent\" placeholder=\"0\" value=\"{{{tilskud_procent}}}\" onchange=\"withdrawPageAccept('grants')\">\n            <label for=\"value_{{id}}_procent\" style=\"padding-left: 27px\">% af egenbetaling</label>\n        </div>\n\n        <div class=\"form-floating col was-validated\" id=\"inputContainer_{{id}}_maxdkk\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{id}}_maxdkk\" placeholder=\"0\" value=\"{{{tilskud_maxdkk}}}\" onchange=\"withdrawPageAccept('grants')\">\n            <label for=\"value_{{id}}_maxdkk\" style=\"padding-left: 27px\">Dog maks kr.</label>\n        </div>\n\n\n    </div>\n{{/payload.grants.tilskudsperioder.satser}}",
        "output": "str",
        "x": 1090,
        "y": 560,
        "wires": [
            [
                "955c894fc9dffd45",
                "6e08782524148718"
            ]
        ]
    },
    {
        "id": "08ae4c04ae16a403",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: grantList",
        "field": "payload.pageElements.grantList",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{{#payload.grants.tilskudsperioder.satser}}\n    <div class=\"row border-top pb-2 pt-2 \">\n\n\n        <div class=\"col-2 d-flex flex-column justify-content-center\">\n            <span>{{titel}}</span>\n        </div>\n\n        <div class=\"form-floating col\" id=\"inputContainer_{{id}}_procent\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{id}}_procent\" placeholder=\"0\" value=\"{{tilskud_procent}}\" onchange=\"withdrawPageAccept('grants')\">\n            <label for=\"value_{{id}}_procent\" style=\"padding-left: 27px\">% af egenudgift</label>\n        </div>\n\n\n        <div class=\"form-floating col\" id=\"inputContainer_{{id}}_maxdkk\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{id}}_maxdkk\" placeholder=\"0\" value=\"{{tilskud_maxdkk}}\" onchange=\"withdrawPageAccept('grants')\">\n            <label for=\"value_{{id}}_maxdkk\" style=\"padding-left: 27px\">Dog maks kr.</label>\n        </div>\n\n    </div>\n{{/payload.grants.tilskudsperioder.satser}}",
        "output": "str",
        "x": 1090,
        "y": 520,
        "wires": [
            [
                "2cc90de707d18884"
            ]
        ]
    },
    {
        "id": "2cc90de707d18884",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: grantButtons",
        "field": "payload.pageElements.grantButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-primary\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'grantUpdates', 'value': appendRules (null {{#payload.grants.tilskudsperioder.satser}}, createGrantObj('{{id}}') {{/payload.grants.tilskudsperioder.satser}}) } ))\">\n        Godkend tilskudssatser\n    </button>\n    \n    <button class=\"btn btn-lg btn-primary ml-2 goNext hidden\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('run')\">\n        Gå til ny kørsel\n    </button>\n</div>\n",
        "output": "str",
        "x": 1300,
        "y": 520,
        "wires": [
            [
                "25eef4e978cf76c9"
            ]
        ]
    },
    {
        "id": "955c894fc9dffd45",
        "type": "template",
        "z": "43652557380ac3f3",
        "d": true,
        "name": "element: grantButtons",
        "field": "payload.pageElements.grantButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'grantUpdates', 'value': appendRules (null {{#payload.grants.tilskudsperioder.satser}}, createGrantObj('{{id}}') {{/payload.grants.tilskudsperioder.satser}}) } ))\">\n        Godkend tilskudssatser\n    </button>\n    \n    <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('run')\">\n        Gå til ny kørsel\n    </button>\n</div>\n",
        "output": "str",
        "x": 1300,
        "y": 560,
        "wires": [
            [
                "25eef4e978cf76c9"
            ]
        ]
    },
    {
        "id": "16bf0e6580aaf246",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "grantsToAccept?",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageElements.grantsToAccept",
                "pt": "msg",
                "to": "payload.webSettings.acceptances.grants = true ? false : true",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 540,
        "wires": [
            [
                "6839897d12a405ac"
            ]
        ]
    },
    {
        "id": "b50802089303913c",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "diff",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "payload.webSettings.settings.idleTimeout",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 210,
        "y": 220,
        "wires": [
            [
                "69aaa1828fd4b85b"
            ],
            [
                "ab622e75bfcfc759"
            ]
        ]
    },
    {
        "id": "ab622e75bfcfc759",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set lastPingMillis",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings.currentSession.lastPingMillis",
                "pt": "msg",
                "to": "$millis()",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.currentSession.lastPingMillis",
                "pt": "global",
                "to": "payload.webSettings.currentSession.lastPingMillis",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 240,
        "wires": [
            [
                "d5e098f6bd51179b"
            ]
        ]
    },
    {
        "id": "d64936a739a436db",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "Check last ping",
        "rules": [
            {
                "t": "set",
                "p": "now",
                "pt": "msg",
                "to": "$millis()",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "diff",
                "pt": "msg",
                "to": "now - payload.webSettings.currentSession.lastPingMillis",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 180,
        "y": 180,
        "wires": [
            [
                "b50802089303913c"
            ]
        ]
    },
    {
        "id": "69aaa1828fd4b85b",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.login",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.rules",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.grants",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings",
                "pt": "global",
                "to": "payload.webSettings",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 200,
        "wires": [
            [
                "ab622e75bfcfc759"
            ]
        ]
    },
    {
        "id": "4a3562049478bf32",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Run",
        "info": "",
        "x": 710,
        "y": 600,
        "wires": []
    },
    {
        "id": "c83fdc0290f77ad3",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Kør robot",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 640,
        "wires": [
            [
                "6fc6a8b8c6d3b766"
            ]
        ]
    },
    {
        "id": "b91122f99171796c",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Finalized",
        "info": "",
        "x": 720,
        "y": 720,
        "wires": []
    },
    {
        "id": "89f051f162c9b4b6",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: finalized",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">Kørslen blev afsluttet</div>\n    <div class=\"card-body\">\n        <p class=\"card-text\">\n\n            Kørslen blev afluttet med success.\n\n            <div class=\"d-flex flex-wrap pb-4\" style=\"gap: 8px\">\n                <div class=\"card border-success mt-1\" style=\"max-width: 20rem;\">\n                    <div class=\"card-body text-center p-3\">\n                        <p class=\"card-text fs-lg\">{{payload.pageElements.receiptCount}}</p>\n                    </div>\n                    <div class=\"card-header border-top no-border-bottom\">Anbefalede handlinger</div>\n                </div>\n\n                <div class=\"card border-danger mt-1\" style=\"max-width: 20rem;\">\n                    <div class=\"card-body text-center p-3\">\n                        <p class=\"card-text fs-lg\">{{payload.pageElements.receiptNoActionCount}}</p>\n                    </div>\n                    <div class=\"card-header border-top no-border-bottom\">Borgere uden bevilling</div>\n                </div>\n            </div>\n\n            ... blev manuelt behandlet under dagens kørsel.\n\n        </p>\n    </div>\n</div>",
        "output": "str",
        "x": 980,
        "y": 760,
        "wires": [
            [
                "163120aa4a431574"
            ]
        ]
    },
    {
        "id": "163120aa4a431574",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Kørsel afsluttet",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 760,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "4f3852df34ce990f",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "page: run",
        "func": "var dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\nvar receiptsAwaiting = msg.currentRun == null ? false : !msg.currentRun.allReceiptsProcessed;\nvar isFinalized = msg.currentRun == null ? true : msg.currentRun.isFinalized;\n\nvar receiptCount = 0;\n\nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptCount += global.get(\"webData\")[\"citizens-actions\"].length;\n        \nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined) \n        receiptCount += global.get(\"webData\")[\"citizens-noactions\"].length;\n\n\nfunction pageAccepted(pageName)\n{\n    return (msg.payload.webSettings.acceptances[pageName]);\n}\nfunction allPagesAccepted()\n{\n    return (pageAccepted(\"login\") && pageAccepted(\"rules\") && pageAccepted(\"grants\"));\n}\n\nvar header = \"Kør robot\";\nvar subheader =\"Start søgning efter nye fakturaer\";\nvar buttonHtml = \"\";\nvar cardtext =\"Robotten henter først fakturaer fra WorkLet, og beregner derefter potientielle tilskud.\";\n\nif (msg.payload.webSettings.state.isRunning) {\n    buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_startRun\" type=\"button\" onclick=\"startRun()\" style=\"width: 300px\" disabled>\n                    <i class=\"fa-lg fas fa-spinner fa-spin\"></i>\n                  </button>`;\n\n}\nelse if((receiptsAwaiting && !dataExists) || (receiptsAwaiting && receiptCount == 0))\n{\n    \n    header = \"Genoptag kørsel\";\n    subheader = \"Genoptag seneste uafsluttede kørsel\";\n    cardtext = \"Da robotten har været lukket siden kørslen først blev startet, er alt persondata for kørslen tabt. Genoptag kørslen for at hente data.\";\n\n    buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_startRun\" type=\"button\" onclick=\"startRun()\" style=\"width: 300px\">\n                        Genoptag kørsel\n                  </button>`;\n\n    \n}\nelse if (receiptsAwaiting && !isFinalized)\n{\n    header = \"Afslut kørsel\";\n    header = \"Afventer bekræftelse af manuel behandling\";\n    cardtext = \"Du kan ikke afslutte kørslen før at du har godkendt manuel behandling af alle borgere med anbefalede handlinger, samt borgere som ikke er tilskudsberrettigede. Gå tilbage til start, og godkend de manglende borgere.\";\n    \n    buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_finalizeRun\" type=\"button\" onclick=\"\" style=\"width: 300px\" disabled>\n                        Afslut kørsel\n                  </button>`;\n\n}\nelse if (!receiptsAwaiting && !isFinalized)\n{\n\n    header =\"Afslut kørsel\";\n    subheader = \"Afslut seneste kørsel\";\n    cardtext = \"Er du sikker på at du vil afslutte seneste kørsel? Du vil ikke være i stand til at se borgeroplysninger eller anbefalede handlinger når kørslen er afsluttet, og en ny kørsel vil først kunne startes i morgen.\";\n\n    buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_finalizeRun\" type=\"button\" onclick=\"postRequest({'requestType': 'finalize'})\" style=\"width: 300px\">\n                        Afslut kørsel\n                  </button>`;\n\n}\nelse if(allPagesAccepted())\n{\n    buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_startRun\" type=\"button\" onclick=\"startRun()\" style=\"width: 300px\">\n                    Start ny kørsel\n                  </button>`;\n\n}\nelse\n    buttonHtml = `<button class=\"btn btn-lg btn-secondary ml-2 btn-lg\" id=\"button_startRun\" type=\"button\" onclick=\"startRun()\" style=\"width: 300px\" disabled>\n                Start ny kørsel\n                </button>\n                <span class=\"text-danger\" style=\"margin-left: 10px\">OBS: Du kan først starte en ny kørsel, efter du har godkendt loginoplysninger, forretningsregler samt tilskudssatser.</span>`;\n\n\n\nvar html =\n    `<div class=\"card mb-2\">\n        <div class=\"card-header\">`+header+`</div>\n        <div class=\"card-body\">\n            <h6 class=\"card-subtitle mb-2 text-muted\">`+subheader+`</h6>\n            <p class=\"card-text\">`+cardtext+`</p>\n        \n            `+buttonHtml+`\n\n            <span class=\"text-info hidden\" id=\"statusText\" style=\"margin-left: 10px\">Status: Starter kørsel</span>\n            \n        </div>\n    </div>`;\n\nmsg.payload.pageContent = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1360,
        "y": 640,
        "wires": [
            [
                "c83fdc0290f77ad3"
            ]
        ]
    },
    {
        "id": "6e08782524148718",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: grantButtons",
        "func": "\n\nfunction pageAccepted(pageName)\n{\n    return (msg.payload.webSettings.acceptances[pageName]);\n}\nfunction allPagesAccepted()\n{\n    return (pageAccepted(\"login\") && pageAccepted(\"rules\") && pageAccepted(\"grants\"));\n}\n\nvar html = \"\";\n\nif(allPagesAccepted())\n\n    html = `<div class=\"float-right mt-2\">\n                <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'grantUpdates', 'value': appendRules (null {{#payload.grants.tilskudsperioder.satser}}, createGrantObj('{{id}}') {{/payload.grants.tilskudsperioder.satser}}) } ))\"`+ ((msg.payload.webSettings.state.isRunning) ? ` disabled` : ``) +`>\n                    Godkend tilskudssatser\n                </button>\n                \n                <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('run')\">\n                    Gå til ny kørsel\n                </button>\n            </div>\n            `;\n\nelse\n\n    html = `<div class=\"float-right mt-2\">\n                <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'grantUpdates', 'value': appendRules (null {{#payload.grants.tilskudsperioder.satser}}, createGrantObj('{{id}}') {{/payload.grants.tilskudsperioder.satser}}) } ))\">\n                    Godkend tilskudssatser\n                </button>\n                \n                <button class=\"btn btn-lg btn-secondary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('run')\" disabled>\n                    Gå til ny kørsel\n                </button>\n            </div>\n            `;\n\n\nmsg.payload.pageElements['grantButtons'] = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 560,
        "wires": [
            [
                "25eef4e978cf76c9"
            ]
        ]
    },
    {
        "id": "88fb35ef462682b4",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: rulesButtons",
        "func": "var html = `<div class=\"float-right mt-2\">\n                <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'ruleUpdates', 'value': appendRules (null {{#payload.rules}}, createRuleObj('{{uid}}') {{/payload.rules}}) } ))\"`+ ((msg.payload.webSettings.state.isRunning) ? ` disabled`:``)+`>\n                    Forretningsregler godkendt\n                </button>\n\n                <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('grants')\">\n                    Gå til tilskudssatser\n                </button>\n            </div>`;\n\nmsg.payload.pageElements['rulesButtons'] = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 460,
        "wires": [
            [
                "af684cb65465eef9"
            ]
        ]
    },
    {
        "id": "53d7186bbca94b8d",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: loginButtons",
        "func": "var html = `<div class=\"float-right mt-2\">\n                <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept') ))\"`+ ((msg.payload.webSettings.state.isRunning) ? ` disabled` : ``) +`>\n                    Loginoplysninger godkendt\n                </button>\n                \n                <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('rules')\">\n                    Gå til forretningsregler\n                </button>\n            </div>\n            `;\n\nmsg.payload.pageElements['loginButtons'] = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 360,
        "wires": [
            [
                "f4ff9a7a66ddb884"
            ]
        ]
    },
    {
        "id": "013043d738c89a03",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: view-receipts",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"receipt-container\">\n    <!-- receipt-container -->\n\n    <div class=\"receipt-inner\">\n        <!-- receipt-inner -->\n\n        <div class=\"citizen-info\">\n            <!-- citizen-info -->\n\n            <ul class=\"nav nav-tabs\" role=\"tablist\" style=\"padding-bottom: 1.2px;margin-right: 5px;border-bottom:0px\">\n                <li class=\"nav-item\" role=\"presentation\">\n                    <a class=\"nav-link active\" data-bs-toggle=\"tab\" href=\"#home\" aria-selected=\"true\" role=\"tab\">Overblik</a>\n                </li>\n\n                <li class=\"nav-item\" role=\"presentation\">\n                    <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#profile\" aria-selected=\"false\" tabindex=\"-1\" role=\"tab\">Alle sager</a>\n                </li>\n            </ul>\n            \n            <div id=\"myTabContent\" class=\"tab-content bg-white p-3\">\n                <div class=\"tab-pane show active\" id=\"home\" role=\"tabpanel\">\n\n                    <!-- -->\n                    <h4 class=\"card-title mb-4\">\n                        240194<small class=\"text-secondary\"> - XXXX</small>\n                        <a href=\"\">\n                            <span class=\"float-right text-muted\"><i class=\"fas fa-2xs fa-link\"></i></span>\n                        </a>\n                    </h4>\n                    <!-- p class=\"card-text\">Some quick example text to build on the card title and make up the bulk of the card's content.</p -->\n                    \n\n                    \n                    <button type=\"button\" class=\"btn btn-light border-success text-black disabled mb-1\">Udvidet helbredstillæg</button>\n                    <button type=\"button\" class=\"btn btn-light border-success text-black disabled mb-1\">Alm. helbredstillæg</button>\n                    <button type=\"button\" class=\"btn btn-light border-danger text-black disabled mb-1\">Udvidet helbredstillæg</button>\n\n\n                    <div class=\"d-flex justify-stretch mt-4\" style=\"gap: 3px\">\n\n                        <div class=\"card border-light bg-light mb-2 text-center p-1\">\n                            <div class=\"text-secondary fs-10\">FORMUE</div>\n                            30 571 kr\n                        </div>\n\n                        <div class=\"card border-light bg-light mb-2 text-center p-1\">\n                            <div class=\"text-secondary fs-10\">DANMARK</div>\n                            Gruppe 1\n                        </div>\n                        \n                        <div class=\"card border-light bg-light mb-2 text-center p-1\">\n                            <div class=\"text-secondary fs-10\">TILLÆGSPROCENT</div>\n                            50 %\n                        </div>\n\n                    </div>\n                \n                    <!-- -->\n                    \n                </div>\n\n                <div class=\"tab-pane\" id=\"profile\" role=\"tabpanel\">\n\n                    <table class=\"table fs-11\">\n                        <thead class=\"border-none\">\n                            <tr>\n                            <th scope=\"col\"><span class=\"table-header\">Titel</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Sagstype</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Start</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Slut</span></th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            <tr>\n                                <td>Fodpleje</td>\n                                <th scope=\"row\">Udvidet helbredstillæg</th>\n                                <td>12-01-2023</td>\n                                <td>31-12-2023</td>\n                            </tr>\n                            <tr>\n                                <td>Alm. helbredstillæg</td>\n                                <th scope=\"row\">Alm. helbredstillæg</th>\n                                <td>12-01-2023</td>\n                                <td>31-12-2023</td>\n                            </tr>\n                            <tr class=\"table-warning\">\n                                <td>Fodpleje</td>\n                                <th scope=\"row\">Udvidet helbredstillæg</th>\n                                <td>12-01-2023</td>\n                                <td>31-12-2023</td>\n                            </tr>\n                        </tbody>\n                    </table>\n                    \n                </div>\n            </div>\n\n            <!-- /citizen-info -->\n        </div>\n\n        <div>\n            \n            \n            <div class=\"card border-light mb-2\">\n                <!-- Faktura  -->\n\n                <div class=\"card-header text-muted fs-10\" style=\"height: 38px\">FAKTURA #1<span class=\"float-right\">15/01-2023</span></div>\n                <div class=\"card-body p-3\" style=\"padding-top: 0px!important;padding-bottom: 0px!important\">\n\n                    <table class=\"table\">\n                        <thead class=\"border-none\">\n                            <tr>\n                            <th scope=\"col\"><span class=\"table-header\">Ydelsesnr.</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Ydelse</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Egenbetaling</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Sygesikring</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Total</span></th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            <tr>\n                                <td>0001</td>\n                                <th scope=\"row\">Behandling i patients eget hjem</th>\n                                <td>390</td>\n                                <td>0</td>\n                                <td>390</td>\n                            </tr>\n                            <tr class=\"table-warning\">\n                                <td>0001</td>\n                                <th scope=\"row\">Behandling uden tilskud</th>\n                                <td>390</td>\n                                <td>0</td>\n                                <td>390</td>\n                            </tr>\n                        </tbody>\n                    </table>\n\n                </div>\n                \n                <!-- /Faktura -->\n            </div>\n\n            \n            <!-- Handlinger -->\n\n            <div class=\"card mb-2 border-light header-left\" style=\"\">\n                <div class=\"card-header header-left text-muted fs-10\" style=\"width:20%;border-right: 1px solid rgba(0,0,0,0.125)\">HANDLING #1</div>\n                <div style=\"align-self: center;padding-left:10px\">Sag oprettes - alm. helbredstillæg</div>\n            </div>\n            <div class=\"card mb-2 border-light header-left\" style=\"\">\n                <div class=\"card-header header-left text-muted fs-10\" style=\"width:20%;border-right: 1px solid rgba(0,0,0,0.125)\">HANDLING #1</div>\n                <div style=\"align-self: center;padding-left:10px\">Sag oprettes - alm. helbredstillæg</div>\n            </div>\n\n            <!-- /Handlinger -->\n\n        </div>\n\n        \n        \n\n        <!-- /receipt-inner -->\n    </div>\n    \n\n    <div class=\"pagination-container mt-3\">\n\n        <ul class=\"pagination\">\n            <li class=\"page-item disabled\">\n            <a class=\"page-link\" href=\"#\">&laquo;</a>\n            </li>\n            <li class=\"page-item active\">\n            <a class=\"page-link\" href=\"#\">1</a>\n            </li>\n            <li class=\"page-item\">\n            <a class=\"page-link\" href=\"#\">2</a>\n            </li>\n            <li class=\"page-item\">\n            <a class=\"page-link\" href=\"#\">3</a>\n            </li>\n            <li class=\"page-item\">\n            <a class=\"page-link\" href=\"#\">4</a>\n            </li>\n            <li class=\"page-item\">\n            <a class=\"page-link\" href=\"#\">5</a>\n            </li>\n            <li class=\"page-item\">\n            <a class=\"page-link\" href=\"#\">&raquo;</a>\n            </li>\n        </ul>\n\n        <button class=\"btn btn-lg btn-light border-light\" type=\"button\">Godkend handlinger</button>\n\n        </div>\n\n    <!-- /receiptContainer -->\n</div>",
        "output": "str",
        "x": 2210,
        "y": 300,
        "wires": [
            []
        ]
    },
    {
        "id": "b07e0dfc01e164a0",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "Specific citizen?",
        "property": "payload.spec",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1240,
        "y": 40,
        "wires": [
            [
                "7a64b3858edfdad8"
            ],
            [
                "93729e19de983eee"
            ]
        ]
    },
    {
        "id": "93729e19de983eee",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.spec",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1460,
        "y": 60,
        "wires": [
            [
                "b32a26dc349f5b07"
            ]
        ]
    },
    {
        "id": "1184056262f02591",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "set temp data obj",
        "func": "msg.payload.tempData = msg.payload.tempDataArray[msg.payload.spec];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2010,
        "y": 60,
        "wires": [
            [
                "92b1925b5327ed30"
            ]
        ]
    },
    {
        "id": "8adb89ea490e9b67",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "tillaegsprocent",
        "rules": [
            {
                "t": "set",
                "p": "payload.tempData.persondata._htillaegsprocent",
                "pt": "msg",
                "to": "payload.tempData.persondata.helbredstillaegsprocent[0].tillaegsprocent",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1480,
        "y": 120,
        "wires": [
            [
                "b0b8bd30f6fdf461"
            ]
        ]
    },
    {
        "id": "92b1925b5327ed30",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.tempData.persondata.helbredstillaegsprocent",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "array",
                "vt": "array"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1310,
        "y": 140,
        "wires": [
            [
                "8adb89ea490e9b67"
            ],
            [
                "5b692df5d4c78b89"
            ]
        ]
    },
    {
        "id": "5b692df5d4c78b89",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "tillaegsprocent",
        "rules": [
            {
                "t": "set",
                "p": "payload.tempData.persondata._htillaegsprocent",
                "pt": "msg",
                "to": "payload.tempData.persondata.helbredstillaegsprocent.tillaegsprocent",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1480,
        "y": 160,
        "wires": [
            [
                "b0b8bd30f6fdf461"
            ]
        ]
    },
    {
        "id": "b0b8bd30f6fdf461",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.tempData.persondata.danmarkgruppe",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1650,
        "y": 140,
        "wires": [
            [
                "1f72e5564103eca8"
            ],
            [
                "1f72e5564103eca8"
            ],
            [
                "5ed1981ab9c124de"
            ]
        ]
    },
    {
        "id": "5ed1981ab9c124de",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "danmark",
        "rules": [
            {
                "t": "set",
                "p": "payload.tempData.persondata._danmark",
                "pt": "msg",
                "to": "\"Gruppe \" & payload.tempData.persondata.danmarkgruppe",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1800,
        "y": 160,
        "wires": [
            [
                "a1bf4b6b1875b569"
            ]
        ]
    },
    {
        "id": "1f72e5564103eca8",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "danmark",
        "rules": [
            {
                "t": "set",
                "p": "payload.tempData.persondata._danmark",
                "pt": "msg",
                "to": "Ej medlem",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1800,
        "y": 120,
        "wires": [
            [
                "a1bf4b6b1875b569"
            ]
        ]
    },
    {
        "id": "a2dc4dcc85327a6d",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Sager",
        "func": "if (msg.payload.tempData == undefined || msg.payload.tempData.persondata.sager == null || !Array.isArray(msg.payload.tempData.persondata.sager))\n    return msg;\n\nvar html = \"\";\nvar almCount = 0, kortCount = 0;\n\nfor(var i = 0; i < msg.payload.tempData.persondata.sager.length; i++)\n{\n\n    const obj = msg.payload.tempData.persondata.sager[i];\n\n    var til = obj.til == null ? \"ukendt udløbsdato\" : obj.til;\n    var alt = obj.aktiv ? \"Gyldig indtil \" + til : \"Gyldighed udløb \" + obj.til;\n\n    var border = obj.aktiv ? \"success\" : \"warning\";\n \n        if (!(obj.titel.toLowerCase()).includes(\"fod\"))\n        {\n            if ((obj.type.toLowerCase()).includes(\"almindeligt helbredstillæg\"))\n            {\n                border = \"info\";\n                if(almCount++ >= 1)\n                    continue;\n            }\n\n            else if (obj.type.toLowerCase().includes(\"helbredstillægskort\"))\n            {\n                border = \"info\";\n                if (kortCount++ >= 1)\n                    continue;\n            }\n            else\n                continue;\n        }\n\n    //html += `<button type=\"button\" class=\"btn btn-light border-` + border + ` text-black\" data-bs-container=\"body\" data-bs-toggle=\"popover\" data-bs-placement=\"left\" data-bs-content=\"Vivamus sagittis lacus vel augue laoreet rutrum faucibus.\" data-bs-original-title=\"Popover Title\">` + obj.type+`</button>`\n    var newTitle = obj.titel.split(\"(\")[0];\n\n    html += `\n        <div class=\"card border-`+border+`\">\n        <div class=\"card-header fs-10 pt-1 text-muted text-center\" style=\"height: 22px;text-transform:uppercase\">`+ newTitle +`</div>\n        <div class=\"card-body p-1 text-center\">\n            <p class=\"card-text fs-13 m-1\">`+ obj.type +`</p>\n        </div>\n        </div>\n    `;\n\n\n}\n\nmsg.payload.tempData.persondata._sager = html;\n\nreturn msg;\n\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1210,
        "y": 200,
        "wires": [
            [
                "9104824190b91e21"
            ]
        ]
    },
    {
        "id": "9104824190b91e21",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Fakturaer + handlinger",
        "func": "if (!Array.isArray(msg.payload.tempData.regelbrud))\n    msg.payload.tempData.regelbrud = [msg.payload.tempData.regelbrud];\n\nvar fejl =\"\";\n    \nif (msg.payload.tempData.regelbrud[0] != null)\n    for (var j = 0; j < msg.payload.tempData.regelbrud.length; j++) {\n        const r_obj = msg.payload.tempData.regelbrud[j];\n\n        var regelbrud = r_obj.rule != null ? r_obj.rule + \": \" + r_obj.description : r_obj; //+ \" (\" + r_obj.objectValue + \" \" + r_obj.operator + \" \" + r_obj.expectedValue + \")\";\n\n        fejl += `<div class=\"card mb-2 border-warning header-left\" style=\"\">\n                    <div class=\"card-header header-left text-muted fs-10\" style=\"width:20%;border-right: 1px solid rgba(0,0,0,0.125)\">REGELBRUD</div>\n                    <div style=\"align-self: center;padding-left:10px\">`+ regelbrud + `</div>\n                </div>`;\n    }\n\nmsg.payload.tempData._faktura = fejl;\n\nif (msg.payload.tempData.faktura == null)\n    return msg;\n\nfunction round(num) {\n    return Math.round((num + Number.EPSILON) * 100) / 100;\n}\n\nvar html = \"\";\n\nif (!Array.isArray(msg.payload.tempData.faktura))\n    msg.payload.tempData.faktura = [msg.payload.tempData.faktura];\n\nfor(var i = 0; i < msg.payload.tempData.faktura.length; i++)\n{\n    const obj = msg.payload.tempData.faktura[i];\n\n    var handlinger = \"\";\n\n    if (!Array.isArray(msg.payload.tempData.handlinger))\n        msg.payload.tempData.handlinger = [msg.payload.tempData.handlinger];\n\n    var k = 0;\n\n    if (msg.payload.tempData.handlinger[0] != null)\n        for(var j = 0; j < msg.payload.tempData.handlinger.length; j++)\n        {\n            const h_obj = msg.payload.tempData.handlinger[j];\n            if(h_obj.fid != obj.id)\n            {\n                k++;\n                continue;\n            }\n\n            var handling;\n            if(h_obj.tilskud != null)\n                handling = h_obj.handling + \" - tilskud gives: \" + round(h_obj.tilskud) + \" kr\";\n            else\n                handling = h_obj.handling + \" - \" + (h_obj.type == \"A\" ? \"udvidet helbredstillæg\" : \"alm. helbredstillæg\");\n\n            handlinger += `\n                <div class=\"card mb-2 border-light header-left\" style=\"\">\n                    <div class=\"card-header header-left text-muted fs-10\" style=\"width:20%;border-right: 1px solid rgba(0,0,0,0.125)\">HANDLING #`+(j+1-k)+`</div>\n                    <div style=\"align-self: center;padding-left:10px\">`+handling+`</div>\n                </div>`;\n        }\n\n\n    if (obj.behandlinger != null)\n        if (!Array.isArray(obj.behandlinger))\n            obj.behandlinger = [obj.behandlinger];\n\n    var behandlinger = \"\";\n\n    if (obj.behandlinger != null)\n        for (var k = 0; k < obj.behandlinger.length; k++)\n        {\n            var b_obj = obj.behandlinger[k];\n            behandlinger += `<tr>\n                                <td>`+ b_obj.ydelsesnummer+`</td>\n                                <th scope=\"row\">`+ b_obj.titel + ` (type ` + b_obj.type +`)</th>\n                                <td>`+ b_obj.patientAndel +`</td>\n                                <td>`+ b_obj.sygesikringsAndel +`</td>\n                                <th  scope=\"row\">`+ round(b_obj.patientAndel + b_obj.sygesikringsAndel) + `</th>\n                            </tr>`;\n        }\n    behandlinger += `<tr class=\"no-border-bottom\">\n                            <td></td>\n                            <th scope=\"row\"></th>\n                            <td></td>\n                            <td></td>\n                            <th scope=\"row\">`+ round(obj.total) + `</th>\n                    </tr>`;\n\n\n    html += `\n    <div class=\"card border-light mb-2\">\n        <!-- Faktura  -->\n\n        <div class=\"card-header text-muted fs-10\" style=\"height: 38px\">FAKTURA #`+(i+1)+`\n            <span class=\"float-right\">\n                `+obj.dato+`\n                <a href=\"http://workletnew.snapp.dk/auth/sign-in/`+obj.id+`\" target=\"_blank\" style=\"padding-left: 10px\">\n                    <span class=\"float-right text-muted\" style=\"margin-top:-1px\"><i class=\"fas fa-sm fa-link\"></i></span>\n                </a>\n            </span>\n        </div>\n        <div class=\"card-body p-3\" style=\"padding-top: 0px!important;padding-bottom: 0px!important\">\n\n            <table class=\"table\">\n                <thead class=\"border-none\">\n                    <tr>\n                        <th scope=\"col\"><span class=\"table-header\">Ydelsesnr.</span></th>\n                        <th scope=\"col\"><span class=\"table-header\">Ydelse</span></th>\n                        <th scope=\"col\"><span class=\"table-header\">Egenbetaling</span></th>\n                        <th scope=\"col\"><span class=\"table-header\">Sygesikring</span></th>\n                        <th scope=\"col\"><span class=\"table-header\">Total</span></th>\n                    </tr>\n                </thead>\n                <tbody>\n                    `+behandlinger+`\n                </tbody>\n            </table>\n\n        </div>\n\n        <!-- /Faktura -->\n    </div>\n    `;\n\n    html += handlinger;\n\n    if ((msg.payload.tempData.faktura.length - 1) == i)\n        html += fejl;\n\n\n}\n\nmsg.payload.tempData._faktura = html;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1400,
        "y": 200,
        "wires": [
            [
                "449ee6323dbb0e10"
            ]
        ]
    },
    {
        "id": "449ee6323dbb0e10",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Pagination",
        "func": "var page = msg.payload.page;\n\nvar maxCount = 8;\nmaxCount = maxCount > (parseInt(msg.payload.tempDataLength)-1) ? (parseInt(msg.payload.tempDataLength)-1) : maxCount;\n\nvar countBeforeActive = msg.payload.spec > 4 ? 4 : msg.payload.spec;\nvar countAfterActive = maxCount - countBeforeActive;\nvar countAfterActive = ((countAfterActive + parseInt(msg.payload.spec)) > (parseInt(msg.payload.tempDataLength) - 1)) ? (msg.payload.tempDataLength - msg.payload.spec -1) : countAfterActive;\n\nif(countAfterActive < 4 && msg.payload.spec > maxCount-countAfterActive)\n    countBeforeActive = maxCount - countAfterActive;\n\n\nfunction isArchived (id)\n{\n    return msg.payload.tempDataArray[id].archived;\n}\n\nvar html = `<ul class=\"pagination\">`;\n\n// Arrow left\nif(countBeforeActive > 0)\n    html += `<li class=\"page-item\">\n             <a class=\"page-link\" onClick=\"goToPage('`+ page +`?spec=`+ (parseInt(msg.payload.spec) - 1) +`')\">&laquo;</a>\n             </li>`;\n\n// previous\nfor (var i = 0; i < countBeforeActive; i++)\n{\n    var id = -(countBeforeActive - parseInt(msg.payload.spec) - i);\n\n    html += `<li class=\"page-item`+(isArchived(id) ? ` archived`:``)+`\">\n            <a class=\"page-link\" onClick=\"goToPage('`+ page +`?spec=`+ id + `')\">` +(parseInt(id) + 1)+`</a>\n            </li> `;\n}\n\n// active\nhtml += `<li class=\"page-item active` + (isArchived(msg.payload.spec) ? ` archived` : ``) +`\">\n            <a class=\"page-link\">`+ (parseInt(msg.payload.spec)+1) + `</a>\n         </li> `;\n\n// after\nfor (var i = 0; i < countAfterActive; i++) {\n    var id = (parseInt(msg.payload.spec) + 1 + i);\n    html += `<li class=\"page-item` + (isArchived(id) ? ` archived` : ``) +`\">\n            <a class=\"page-link\" onClick=\"goToPage('`+ page +`?spec=`+ id + `')\">` + (parseInt(id) + 1)+ `</a>\n            </li> `;\n}\n\n// Arrow right\nif (countAfterActive >= 1)\nhtml += `<li class=\"page-item\">\n            <a class=\"page-link\" onClick=\"goToPage('`+ page +`?spec=`+ (parseInt(msg.payload.spec) + 1) +`')\">&raquo;</a>\n         </li>`;\n\nhtml += `</ul>`;\n\nmsg.payload.tempData._pagination = html;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1610,
        "y": 200,
        "wires": [
            [
                "3f57e4a3850446e6"
            ]
        ]
    },
    {
        "id": "7a64b3858edfdad8",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "set tempDataLength",
        "func": "msg.payload.tempDataLength = msg.payload.tempDataArray.length;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2000,
        "y": 20,
        "wires": [
            [
                "1184056262f02591"
            ]
        ]
    },
    {
        "id": "193590a736c24869",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "set body HTML",
        "field": "payload.bodyHTML",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{{{payload.pageElements.navbar}}}\n\n<!--div class=\"progress-container collapsed\">\n\n    <div class=\"uppercase fs-10 fw-500 mb-1\" style=\"width:100%;text-align: center;\">Robotten arbejder ... 56%</div>\n\n    <div class=\"progress bg-dark\">\n        <div class=\"progress-bar progress-bar-striped progress-bar-animated\" role=\"progressbar\" aria-valuenow=\"75\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width: 75%;\"></div>\n    </div>\n\n\n</div-->\n\n  \n<div class=\"container site-container mt-3\">\n    <!-- site -->\n\n    <ol class=\"breadcrumb\">\n        <li class=\"breadcrumb-item active\">{{{payload.pageTitle}}}</li>\n    </ol>\n\n    <div id=\"alertParent\">\n        <div class=\"alert alert-dismissible hidden\" id=\"alertBox\">\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\n            <h4 class=\"alert-heading\" id=\"alertBox-heading\">Warning!</h4>\n            <p class=\"mb-0\" id=\"alertBox-body\">Best check yo self, you're not looking too good. Nulla vitae elit libero, a pharetra augue. Praesent commodo cursus magna, <a href=\"#\" class=\"alert-link\">vel scelerisque nisl consectetur et</a>.</p>\n        </div>\n    </div>\n\n\n    <div id=\"pageContent\">\n        {{{payload.pageContent}}}\n    </div>\n\n    <!-- /site -->\n</div>",
        "output": "str",
        "x": 2060,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "50420eba13820fd6",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: actionsCard",
        "func": "var receiptCount = 0;\nvar remainingCount = 0;\n\nvar dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\n\nif (dataExists)\n{\n\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n\n        if (!Array.isArray(global.get(\"webData\")[\"citizens-actions\"]))\n        {\n            var webData = global.get(\"webData\");\n            webData[\"citizens-actions\"] = [webData[\"citizens-actions\"]];\n            global.set(\"webData\", webData);\n        }\n            //global.set(\"webData\")[\"citizens-actions\"] = [global.get(\"webData\")[\"citizens-actions\"])];\n\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptCount = global.get(\"webData\")[\"citizens-actions\"].length;\n\n    for (var i = 0; i < receiptCount; i++)\n        if (!((global.get(\"webData\")[\"citizens-actions\"])[i]).archived)\n            remainingCount++;\n}\n\n/*\nif (global.get(\"runHistory\", \"storeInFile\") !== undefined)\n    if (global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length - 1] !== undefined)\n        acceptedReceiptCount = global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length - 1].processedReceipts.length;*/\n\n\n//typeof global.get(\"webData\") == undefined || !Array.isArray(global.get(\"webData\")[\"citizens-actions\"]) ? 0 : global.get(\"webData\")[\"citizens-actions\"].length;\n//var remainingCount = receiptCount - acceptedReceiptCount;\n\n\n//receiptCount = remainingCount;\nvar html = ``;\n\nif (msg.payload.webSettings.state.isRunning)\n{\n    html = `<div class=\"card border-light\">\n    <div class=\"card-header\">Anbefalede handlinger</div>\n    <div class=\"card-body\">\n        <h4 class=\"card-title\">Ingen handlinger</h4>\n        <p class=\"card-text\">Vent venligst på at robotten bliver færdig med at arbejde...</p>\n        </div>\n    </div>`;\n    msg.payload.pageElements.actionsCard = html;\n    return msg;\n}\n\nvar currentRunExists = global.get(\"runHistory\", \"storeInFile\") !== null && global.get(\"runHistory\", \"storeInFile\") !== undefined && ( \n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ? !(global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]).isFinalized : !(global.get(\"runHistory\", \"storeInFile\")).isFinalized);\n\nvar currentRun = currentRunExists ?\n                    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ?\n                        global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]\n                        : global.get(\"runHistory\", \"storeInFile\") : null;\n\n\nconst receiptsAwaiting = currentRunExists ? !currentRun.allReceiptsProcessed : false;\nconst isFinialized = currentRunExists ? currentRun.isFinalized : true;\n\nvar border = (receiptsAwaiting && !dataExists) || (receiptsAwaiting && receiptCount == 0) ? `danger` : receiptsAwaiting && receiptCount > 0 ? `info` : `light`;\nvar title =  (receiptsAwaiting && !dataExists) || (receiptsAwaiting && receiptCount == 0) ? \"Genoptag kørsel\" :\n              receiptsAwaiting ? (remainingCount + ` borgere afventer`) : !isFinialized ? `Afslut kørsel` :`Ingen fakturaer`;\nvar body =   (receiptsAwaiting && !dataExists) || (receiptsAwaiting && remainingCount == 0) ? \"Seneste kørsel blev ikke afsluttet. Genoptag kørslen for at hente manglende data.\" :\n              receiptsAwaiting ? \"Efter seneste kørsel er der \"+remainingCount+\" borgere med anbefalede handlinger som afventer behandling.\" : !isFinialized ? \"Afslut seneste kørsel til højre når du har bekræftet behandlingen af alle borgere.\" : \"Start en ny kørsel for at finde fakturaer som afventer behandling.\";\n\nhtml =\n`<div class=\"card border-`+border+`\">\n    <div class=\"card-header\">Anbefalede handlinger</div>\n    <div class=\"card-body\">\n        <h4 class=\"card-title\">`+title+`</h4>\n        <p class=\"card-text\">`+ body+`</p>\n        `\n        +\n        (remainingCount > 0 ? `<div class=\"d-grid\">\n            <button class=\"btn btn-lg btn-light border-light\" type=\"button\" onclick=\"goToPage('view-receipts')\">Se borgere</button>\n        </div>`\n        : ``)\n        +\n        `\n    </div>\n</div>`;\n\nmsg.payload.pageElements.actionsCard = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 920,
        "wires": [
            [
                "833c75852163c6a6"
            ]
        ]
    },
    {
        "id": "3f57e4a3850446e6",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Archive button",
        "func": "var html;\n\nvar isArchived = msg.payload.tempDataArray[msg.payload.spec].archived;\n\nvar allIsArchived = true;\nfor (var i = 0; i < msg.payload.tempDataArray.length; i++)\n    if (!msg.payload.tempDataArray[i].archived)\n        allIsArchived = false;\n\n/*\nif(msg.payload.webSettings.state.isLocked)\n\n    html =\n        `<button class=\"btn btn-lg btn-light border-info\" type=\"button\" onclick=\"postRequest({'requestType': 'finish'})\">Afslut behandling</button>`;\n\nelse*/\n\nif(allIsArchived)\n    html =\n        `<button class=\"btn btn-lg btn-light border-light\" type=\"button\" onclick=\"goToPage('start')\">Gå til oversigt</button>`;\n\nelse\n    html =\n        `<button class=\"btn btn-lg btn-light border-light` +(isArchived ? ` disabled ` : ``)+`\" type=\"button\" onclick=\"postRequest({'requestType': 'archive', 'id': '`+msg.payload.spec+`'})\">Bekræft manuel behandling</button>`;\n\n\nmsg.payload.tempData._archive = html;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1820,
        "y": 200,
        "wires": [
            [
                "dfef270919197e96"
            ]
        ]
    },
    {
        "id": "7010338c1ded1b8a",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "Data exists?",
        "property": "payload.tempDataArray",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1030,
        "y": 80,
        "wires": [
            [
                "b07e0dfc01e164a0"
            ],
            [
                "7e1f73ec1d40cafe"
            ]
        ]
    },
    {
        "id": "22c31b5dcd690404",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: lastRunCard",
        "func": "var lastRunObj = null;\n\n\n\nvar lastRunExists = global.get(\"runHistory\", \"storeInFile\") !== null && global.get(\"runHistory\", \"storeInFile\") !== undefined && (\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ? (global.get(\"runHistory\", \"storeInFile\")).length > 0 : true);\n\nvar lastRunObj = lastRunExists ?\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ?\n        global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]\n        : global.get(\"runHistory\", \"storeInFile\") : null;\n\n/*\nif (global.get(\"runHistory\", \"storeInFile\") !== undefined)\n    if (global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length-1] !== undefined)\n        lastRunObj = global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length-1];\n\n*/\n\n\n\nvar html = ``;\n/*\nif (msg.payload.webSettings.state.isRunning)\n{\n    html =\n        `<div class=\"card border-light\">\n        <div class=\"card-header\">Seneste kørsel</div>\n        <div class=\"card-body\">\n            <h4 class=\"card-title\">Robotten arbejder lige nu...</h4>\n        </div>\n    </div>`;\n}\n\n\nelse*/ if (lastRunObj === null)\n{\n\n    html =\n    `<div class=\"card border-light\">\n        <div class=\"card-header\">Seneste kørsel</div>\n        <div class=\"card-body\">\n            <h4 class=\"card-title\">Ingen data</h4>\n        </div>\n    </div>`;\n}\n\nelse\n{\n    //var now = new Date(Date.now());\n    //var lastRunDate = new Date(lastRunObj.timestamp);\n    //var daysSinceRun = parseInt((Date.now() - lastRunObj.timestamp) / 86400000);\n\n    var daysSinceRun = Date.now() - lastRunObj.timestamp;\n    daysSinceRun = Math.ceil(daysSinceRun / (1000 * 3600 * 24)) -1;\n\n\n\n    var dayordays = daysSinceRun > 1 ? \"dage\" : \"dag\";\n\n    var lastRun = daysSinceRun == 0 ? \"Tidligere i dag\" : daysSinceRun + \" \" + dayordays + \" siden\";\n\n    html =\n    `<div class=\"card border-light\">\n        <div class=\"card-header\">Seneste kørsel</div>\n        <div class=\"card-body\">\n            <h4 class=\"card-title\">`+ lastRun + `</h4>\n            <p class=\"card-text\">Robotten kørte sidst d. `+ new Date(lastRunObj.timestamp).toLocaleString() + `<br />\n                <!--div class=\"mt-1\">\n                    <strong>0</strong> fakturaer automatisk behandlet.<br />\n                    <strong>5</strong> fakturaer sat til manuel behandling.\n                </div-->\n            </p>\n        </div>\n    </div>`;\n}\n\nmsg.payload.pageElements.lastRunCard = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 880,
        "wires": [
            [
                "50420eba13820fd6"
            ]
        ]
    },
    {
        "id": "13e976910d5e9707",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.tempDataArray",
                "pt": "msg",
                "to": "webData.citizens-actions",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 60,
        "wires": [
            [
                "7010338c1ded1b8a"
            ]
        ]
    },
    {
        "id": "5ab143a5c04fb163",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.tempDataArray",
                "pt": "msg",
                "to": "webData.citizens-noactions",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 100,
        "wires": [
            [
                "7010338c1ded1b8a"
            ]
        ]
    },
    {
        "id": "b32a26dc349f5b07",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Find first un-archived receipt",
        "func": "var receiptCount = 0;\n\nif (msg.payload.tempDataArray !== undefined)\n    receiptCount = msg.payload.tempDataArray.length;\n\nvar anyReceiptsArchived = false;\n\nfor (var i = 0; i < receiptCount; i++)\n    if (!msg.payload.tempDataArray[i].archived)\n    {\n        msg.payload.spec = i;\n        break;\n    }\n    else\n        anyReceiptsArchived = true;\n\nif (anyReceiptsArchived && msg.payload.spec == 0)\n    msg.payload.spec = (receiptCount-1);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1720,
        "y": 60,
        "wires": [
            [
                "7a64b3858edfdad8"
            ]
        ]
    },
    {
        "id": "8b06ecbd2e4c4ecf",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "Get history",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "currentRun",
                "pt": "msg",
                "to": "runHistory[$count(runHistory)-1]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 730,
        "y": 640,
        "wires": [
            [
                "4f3852df34ce990f"
            ]
        ]
    },
    {
        "id": "6a92693b12486425",
        "type": "change",
        "z": "43652557380ac3f3",
        "d": true,
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Afslut kørsel",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 680,
        "wires": [
            [
                "6fc6a8b8c6d3b766"
            ]
        ]
    },
    {
        "id": "ef2a80ca3939f50e",
        "type": "function",
        "z": "43652557380ac3f3",
        "d": true,
        "name": "page: run",
        "func": "var dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\nvar isFinalized = msg.currentRun == null ? true : msg.currentRun.isFinalized;\n\nvar header = \"Kør robot\";\nvar buttonHtml = \"\";\n\nvar html = \"\";\n\nif(isFinalized)\n{\n    html =\n        `<div class=\"card mb-2\">\n        <div class=\"card-header\">Afslut kørsel</div>\n        <div class=\"card-body\">\n            <h6 class=\"card-subtitle mb-2 text-muted\">Kørslen blev afsluttet!</h6>\n            <p class=\"card-text\">Kørslen blev markeret som afsluttet. En ny kørsel vil kunne startes i morgen.</p>\n        \n            <button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_finalizeRun\" type=\"button\" onclick=\"postRequest({'requestType': 'finalize'})\" style=\"width: 300px\" disabled>\n                Afsluttet\n            </button>\n            \n        </div>\n    </div>`;\n}\nelse\n{\n    html =\n    `<div class=\"card mb-2\">\n        <div class=\"card-header\">Afslut kørsel</div>\n        <div class=\"card-body\">\n            <h6 class=\"card-subtitle mb-2 text-muted\">Afslut seneste kørsel</h6>\n            <p class=\"card-text\">Er du sikker på at du vil afslutte seneste kørsel? Du vil ikke være i stand til at se borgeroplysninger eller anbefalede handlinger når kørslen er afsluttet, og en ny kørsel vil først kunne startes i morgen.</p>\n        \n            <button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_finalizeRun\" type=\"button\" onclick=\"postRequest({'requestType': 'finalize'})\" style=\"width: 300px\">\n                Afslut kørsel\n            </button>\n            \n        </div>\n    </div>`;\n}\n\n\nmsg.payload.pageContent = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1360,
        "y": 680,
        "wires": [
            [
                "6a92693b12486425"
            ]
        ]
    },
    {
        "id": "dfef270919197e96",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Bevilling?",
        "func": "msg.payload.tempData._bevilling = msg.payload.tempData.persondata.bevilling ? `<div class=\"mb-3 text-success\"><i class=\"fas fa-check\"></i> Bevilget tilskud til fodpleje</div>` : ``;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1220,
        "y": 260,
        "wires": [
            [
                "66afcd1514727417"
            ]
        ]
    },
    {
        "id": "a1bf4b6b1875b569",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Formue = null?",
        "func": "if (msg.payload.tempData !== null && msg.payload.tempData.persondata !== null )\n    msg.payload.tempData.persondata._formue = msg.payload.tempData.persondata.formue == null ? \"Ikke oplyst\" : msg.payload.tempData.persondata.formue + \" kr\";\n    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1980,
        "y": 140,
        "wires": [
            [
                "a2dc4dcc85327a6d"
            ]
        ]
    },
    {
        "id": "381970c176b042aa",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Count receipts",
        "func": "var dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\n\n\nvar receiptCount = 0;\nvar receiptNoActionCount = 0;\n\n\nif (dataExists)\n{\n\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptCount = global.get(\"webData\")[\"citizens-actions\"].length;\n\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined)\n        receiptNoActionCount = global.get(\"webData\")[\"citizens-noactions\"].length;\n\n}\n\nmsg.payload.pageElements = {};\nmsg.payload.pageElements.receiptCount = receiptCount;\nmsg.payload.pageElements.receiptNoActionCount = receiptNoActionCount;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 760,
        "wires": [
            [
                "89f051f162c9b4b6"
            ]
        ]
    },
    {
        "id": "88e4c1ff6d0333f9",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "New setting template",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings",
                "pt": "msg",
                "to": "{\t    \"settings\": {\t        \"idleTimeout\": 1800000\t    },\t\t    \"acceptances\": {\t        \"login\": false,\t        \"rules\": false,\t        \"grants\": false\t    },\t\t    \"state\": {\t        \"isRunning\": false,\t        \"lastStep\": {},\t        \"lastState\": {}\t    },\t\t    \"currentSession\": {\t        \"isConnected\": \"n/a\",\t        \"lastPingMillis\": 0\t    }\t    \t}",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "webData",
                "pt": "global",
                "to": "\t{\t    \"workletCreds\": {\t        \"workletUser\": \"\",\t        \"workletPass\": \"\"\t    }, \"startedRunThisInstance\": false\t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 560,
        "y": 320,
        "wires": [
            [
                "7e2c077d488fba02"
            ]
        ]
    },
    {
        "id": "a9d6b94d12b279b8",
        "type": "json",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "payload.webSettings",
        "action": "obj",
        "pretty": false,
        "x": 990,
        "y": 320,
        "wires": [
            [
                "54fea94a47d38b83"
            ]
        ]
    },
    {
        "id": "c69a20e302b88549",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "Load settings",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings",
                "pt": "msg",
                "to": "#:(storeInFile)::webSettings",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "payload.webData",
                "pt": "msg",
                "to": "webData",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 530,
        "y": 280,
        "wires": [
            [
                "c7471e96ad8de5e4"
            ]
        ]
    },
    {
        "id": "eae97dc11278dc8c",
        "type": "switch",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "#:(storeInFile)::webSettings",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 300,
        "wires": [
            [
                "c69a20e302b88549"
            ],
            [
                "88e4c1ff6d0333f9"
            ]
        ]
    },
    {
        "id": "7e2c077d488fba02",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings",
                "pt": "global",
                "to": "payload.webSettings",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 320,
        "wires": [
            [
                "a9d6b94d12b279b8"
            ]
        ]
    },
    {
        "id": "13ce2c9a2cb6edf6",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "New rule template",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "[\t    {\t        \"uid\": \"formuegraense\",\t        \"name\": \"Formue\",\t        \"variable\": \"formue\",\t        \"operator\": \"<\",\t        \"value\": 93000,\t        \"type\": \"number\",\t        \"description\": \"Borgerens formue skal være indenfor formuegrænsen\",\t        \"error\": \"Borgerens formue bryder formue-reglen\"\t    },\t    {\t        \"uid\": \"formueoplyst\",\t        \"name\": \"Formue\",\t        \"variable\": \"formue\",\t        \"operator\": \"!null\",\t        \"value\": true,\t        \"type\": \"bool\",\t        \"description\": \"Borgerens formue skal være oplyst til UDK\",\t        \"isSystemRule\": true\t    }\t]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.rulesStr",
                "pt": "msg",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 550,
        "y": 460,
        "wires": [
            [
                "4e9a3b7807bbafd6"
            ]
        ]
    },
    {
        "id": "6f9b01d0e9aeace9",
        "type": "json",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "payload.rules",
        "action": "obj",
        "pretty": false,
        "x": 990,
        "y": 460,
        "wires": [
            [
                "59c7c16b1b5ab941"
            ]
        ]
    },
    {
        "id": "b0485f8f92d2446e",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "Load rules",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "#:(storeInFile)::rules",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "payload.rulesStr",
                "pt": "msg",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 530,
        "y": 420,
        "wires": [
            [
                "c49b1da1d0ca8a62"
            ]
        ]
    },
    {
        "id": "54fea94a47d38b83",
        "type": "switch",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "#:(storeInFile)::rules",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 440,
        "wires": [
            [
                "b0485f8f92d2446e"
            ],
            [
                "13ce2c9a2cb6edf6"
            ]
        ]
    },
    {
        "id": "4e9a3b7807bbafd6",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::rules",
                "pt": "global",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 760,
        "y": 460,
        "wires": [
            [
                "6f9b01d0e9aeace9"
            ]
        ]
    },
    {
        "id": "59c7c16b1b5ab941",
        "type": "json",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "payload.rulesStr",
        "action": "str",
        "pretty": false,
        "x": 1110,
        "y": 460,
        "wires": [
            [
                "f03ed296e7105d6b"
            ]
        ]
    },
    {
        "id": "ae14111b4808cbf3",
        "type": "comment",
        "z": "db94b4c117de2f6a",
        "name": "Load web settings",
        "info": "",
        "x": 370,
        "y": 260,
        "wires": []
    },
    {
        "id": "6069256d57690eba",
        "type": "comment",
        "z": "db94b4c117de2f6a",
        "name": "Load Rules",
        "info": "",
        "x": 350,
        "y": 400,
        "wires": []
    },
    {
        "id": "6aea2a69085ab1fc",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "New grants template",
        "rules": [
            {
                "t": "set",
                "p": "payload.grants",
                "pt": "msg",
                "to": "{\t      \"periode_fra\": \"2023-01-01\",\t      \"periode_til\": \"2023-12-31\",\t      \"satser\": [\t        {\t          \"tilskud_maxdkk\": 24,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Journaloptagelse\"\t        },\t        {\t          \"tilskud_maxdkk\": 24,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Kontrol og/eller eftersyn\"\t        },\t        {\t          \"tilskud_maxdkk\": 111,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandlingsydelse C\"\t        },\t        {\t          \"tilskud_maxdkk\": 81,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Første fodstatus (nyhenvist patient)\"\t        },\t        {\t          \"tilskud_maxdkk\": 66,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fodstatus\"\t        },\t        {\t          \"tilskud_maxdkk\": 55,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fodstatus ved samtidig anden behandling\"\t        },\t        {\t          \"tilskud_maxdkk\": 25,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Opdatering af fodstatus ved skift i risikogruppe\"\t        },\t        {\t          \"tilskud_maxdkk\": 66,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandlingsydelse A\"\t        },\t        {\t          \"tilskud_maxdkk\": 100,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandlingsydelse B\"\t        },\t        {\t          \"tilskud_maxdkk\": 200,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 1, enkelt\"\t        },\t        {\t          \"tilskud_maxdkk\": 400,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 1, par\"\t        },\t        {\t          \"tilskud_maxdkk\": 200,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 2, enkelt\"\t        },\t        {\t          \"tilskud_maxdkk\": 400,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 2, par\"\t        },\t        {\t          \"tilskud_maxdkk\": 200,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 3, enkelt\"\t        },\t        {\t          \"tilskud_maxdkk\": 400,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 3, par\"\t        },\t        {\t          \"tilskud_maxdkk\": 125,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Tilretning af indlæg\"\t        },\t        {\t          \"tilskud_maxdkk\": 24,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandling før påsætning af 1 ny bøjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 72,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fremstilling og påsætning af 1 ny bøjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fremstilling og påsætning af bøjler udover 1\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Korrektion af 1 bøjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 72,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Korrektion af 2 bøjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 96,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Korrektion af op til 10 bøjler incl.\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Ortheser\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Ortheser fremstilet af sislicone\"\t        },\t        {\t          \"tilskud_maxdkk\": 55,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Sårbehandling\"\t        },\t        {\t          \"tilskud_maxdkk\": 44,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Sårbehandling ved anden samtidig behandling\"\t        },\t        {\t          \"tilskud_maxdkk\": 100,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Behandling uden tilskud\"\t        },\t        {\t          \"tilskud_maxdkk\": 0,\t          \"tilskud_procent\": 0,\t          \"titel\": \"Afstandstillæg uden tilskud\"\t        }\t      ]\t    }",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.grants",
                "pt": "msg",
                "to": "$.payload.grants ~> | $.satser |\t(\t{\t    \"wtitel\": titel ~> $replace(\" \", \"\")\t})|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.grants",
                "pt": "msg",
                "to": "{\t    \"max_hjemmebehandling\": 9999999999999999,\t    \"max_udekoersel\": 9999999999999999,\t    \"danmark_fratraek_procent\": 50,\t    \"danmark_fratraek_maxdkk\": 100,\t    \"tilskudsperioder\": payload.grants\t}",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.grants.tilskudsperioder.satser",
                "pt": "msg",
                "to": "payload.grants.tilskudsperioder.satser @ $g #$index.\t{\t    \"id\": $index,\t    \"tilskud_maxdkk\": $g.tilskud_maxdkk,\t    \"tilskud_procent\": $g.tilskud_procent,\t    \"titel\": $g.titel,\t    \"wtitel\": $g.wtitel\t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 560,
        "y": 660,
        "wires": [
            [
                "3f926de50bc6c69f"
            ]
        ]
    },
    {
        "id": "6e9984fcc13cbb0d",
        "type": "json",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "payload.grants",
        "action": "obj",
        "pretty": false,
        "x": 990,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "590ea89e490dce35",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "Load grants",
        "rules": [
            {
                "t": "set",
                "p": "payload.grants",
                "pt": "msg",
                "to": "#:(storeInFile)::grants",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 530,
        "y": 620,
        "wires": [
            [
                "12011e480eafdc8f"
            ]
        ]
    },
    {
        "id": "f03ed296e7105d6b",
        "type": "switch",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "#:(storeInFile)::grants",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 640,
        "wires": [
            [
                "590ea89e490dce35"
            ],
            [
                "6aea2a69085ab1fc"
            ]
        ]
    },
    {
        "id": "3f926de50bc6c69f",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::grants",
                "pt": "global",
                "to": "payload.grants",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 760,
        "y": 660,
        "wires": [
            [
                "6e9984fcc13cbb0d"
            ]
        ]
    },
    {
        "id": "f1a8802eae2b84b5",
        "type": "comment",
        "z": "db94b4c117de2f6a",
        "name": "Load Grants",
        "info": "",
        "x": 350,
        "y": 600,
        "wires": []
    },
    {
        "id": "d074d283a8713b57",
        "type": "switch",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "object",
                "vt": "object"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 210,
        "y": 100,
        "wires": [
            [
                "f7635cfda195117f"
            ],
            [
                "ff29c1cf4e1ad18a"
            ]
        ]
    },
    {
        "id": "ff29c1cf4e1ad18a",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 100,
        "wires": [
            [
                "f7635cfda195117f"
            ]
        ]
    },
    {
        "id": "89596c9e7122fea8",
        "type": "comment",
        "z": "db94b4c117de2f6a",
        "name": "States",
        "info": "",
        "x": 810,
        "y": 80,
        "wires": []
    },
    {
        "id": "6ec1d89f4bc267a3",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "New states",
        "rules": [
            {
                "t": "set",
                "p": "webStates",
                "pt": "global",
                "to": "[\t    {\t        \"title\": \"idle\",\t        \"id\": 0,\t        \"result\": [\"ready\", \"completed\"]\t    },\t    \t    {\t        \"title\": \"running\",\t        \"id\": 1,\t        \"result\": \"busy\"\t    },\t\t    {\t        \"title\": \"unavailable\",\t        \"id\": 2,\t        \"result\": \"no response\"\t    }\t]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "webSteps",
                "pt": "global",
                "to": "[{\"title\":\"initialization\",\"id\":0,\"state\":{},\"lastResult\":null},{\"title\":\"extract-worklet\",\"id\":1,\"state\":{},\"lastResult\":null},{\"title\":\"data-split\",\"id\":2,\"state\":{},\"lastResult\":null},{\"title\":\"extract-kp\",\"id\":3,\"state\":{},\"lastResult\":null},{\"title\":\"transform\",\"id\":4,\"state\":{},\"lastResult\":null},{\"title\":\"load\",\"id\":5,\"state\":{},\"lastResult\":null}]",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.webStates",
                "pt": "msg",
                "to": "webStates",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "payload.webSteps",
                "pt": "msg",
                "to": "webSteps",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 830,
        "y": 120,
        "wires": [
            [
                "eae97dc11278dc8c"
            ]
        ]
    },
    {
        "id": "c7471e96ad8de5e4",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "set isRunning",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.isRunning",
                "pt": "global",
                "to": "$globalContext(\"webData.startedRunThisInstance\")",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 280,
        "wires": [
            [
                "bb96674ebd01af04"
            ]
        ]
    },
    {
        "id": "792bc1326c300849",
        "type": "subflow:db94b4c117de2f6a",
        "z": "85ff29bdef7c1aea",
        "name": "",
        "x": 370,
        "y": 80,
        "wires": [
            [
                "c668c88142f35452"
            ]
        ]
    },
    {
        "id": "fbeec8791e401f92",
        "type": "change",
        "z": "85ff29bdef7c1aea",
        "name": "Add step run history",
        "rules": [
            {
                "t": "set",
                "p": "currentStartDate",
                "pt": "msg",
                "to": "currentStartDate",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "newStep",
                "pt": "msg",
                "to": "payload.webSteps[title = \"extract-worklet\"]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "newStep",
                "pt": "msg",
                "to": "newStep",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "newState",
                "pt": "msg",
                "to": "payload.webStates[title = \"idle\"]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "newState",
                "pt": "msg",
                "to": "newState",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "newState.result",
                "pt": "msg",
                "to": "newState.result[1]",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "newStep.state",
                "pt": "msg",
                "to": "newState",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "newStep.timestamp",
                "pt": "msg",
                "to": "$millis()",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "newStep.lastResult",
                "pt": "msg",
                "to": "newStep.state.result",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := $$.currentStartDate;\t$newStep := $$.newStep;\t\tstartDate = $startDate?\t{\t    \"currentStep\": $newStep,\t    \"stepHistory\": $append(stepHistory, $newStep)\t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1360,
        "y": 120,
        "wires": [
            [
                "f5d7b1d2cde30ea2"
            ]
        ]
    },
    {
        "id": "f5d7b1d2cde30ea2",
        "type": "change",
        "z": "85ff29bdef7c1aea",
        "name": "Update webSettings state",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.lastStep",
                "pt": "global",
                "to": "newStep",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.lastState",
                "pt": "global",
                "to": "newState",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1370,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "c668c88142f35452",
        "type": "switch",
        "z": "85ff29bdef7c1aea",
        "name": "",
        "property": "stepHistoryChange",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 590,
        "y": 80,
        "wires": [
            [
                "6cfb9bed6a24be31"
            ],
            []
        ]
    },
    {
        "id": "6cfb9bed6a24be31",
        "type": "switch",
        "z": "85ff29bdef7c1aea",
        "name": "",
        "property": "stepHistoryChange.newStep",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 790,
        "y": 60,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "14f3b19bf9f1bf91",
        "type": "comment",
        "z": "85ff29bdef7c1aea",
        "name": "New step",
        "info": "",
        "x": 1050,
        "y": 40,
        "wires": []
    },
    {
        "id": "08c0dac0e5eb2d13",
        "type": "comment",
        "z": "85ff29bdef7c1aea",
        "name": "New state",
        "info": "",
        "x": 1060,
        "y": 300,
        "wires": []
    },
    {
        "id": "9057a712327815d2",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Start robot",
        "info": "",
        "x": 160,
        "y": 180,
        "wires": []
    },
    {
        "id": "c0efbe2a4fc25ff6",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "[E] Find ny start- og slutdato ud fra seneste kørsel samt dags dato",
        "info": "",
        "x": 970,
        "y": 100,
        "wires": []
    },
    {
        "id": "2ea70729759d488c",
        "type": "catch",
        "z": "8ea344595d9a442a",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 1620,
        "y": 60,
        "wires": [
            [
                "df0ed618b5194000",
                "bfc8cafe83059f1f"
            ]
        ]
    },
    {
        "id": "df0ed618b5194000",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "ERROR DEBUG",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "error",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1970,
        "y": 40,
        "wires": []
    },
    {
        "id": "da966ceeba7b23dd",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Fjern CPR-numre",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$|\t{\t    \"cpr\": \t           (cpr ~>\t           $split(\"-\"))[0]\t}\t|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.faktura|\t{\t    \"patientCPR\": \t           (patientCPR ~>\t           $split(\"-\"))[0]\t}\t|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$.errors ~> |$|\t{\t    \"cpr\": \t           (cpr ~>\t           $split(\"-\"))[0]\t}\t|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$.errors ~> |$.faktura|\t{\t    \"patientCPR\": \t           (patientCPR ~>\t           $split(\"-\"))[0]\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 490,
        "y": 1760,
        "wires": [
            [
                "a46e2a0c2cd58d9f"
            ]
        ]
    },
    {
        "id": "64156b428449f87a",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "7de50fe1369c94a7",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "tilskudsInfo",
                "pt": "msg",
                "to": "payload.grants",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 615,
        "y": 220,
        "wires": [
            [
                "56f4f81f3f45559e"
            ]
        ],
        "l": false,
        "info": "## Set grant info\r\nThis change node defines the remaining relevant grant information, and copies the grant periods set in last node."
    },
    {
        "id": "8b4e8bc5facd8f90",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "7de50fe1369c94a7",
        "name": "Sæt tilskudsperioder fra Danmark",
        "info": "",
        "x": 490,
        "y": 180,
        "wires": []
    },
    {
        "id": "2c5bfa6b7a2613ab",
        "type": "function",
        "z": "8ea344595d9a442a",
        "name": "Find filnavn",
        "func": "const splitStartDate = msg.currentRun.startDate.split(\"/\");\nconst splitEndDate = msg.currentRun.endDate.split(\"/\");\n\nvar startDate = new Date(splitStartDate[2], splitStartDate[1] - 1, splitStartDate[0]);\nvar endDate = new Date(splitEndDate[2], splitEndDate[1] - 1, splitEndDate[0]);\n\n// define file name\nvar fileName = \"Kvitteringer-\" + startDate.toDateString().replace(splitStartDate[2], \"\").trimEnd()\n    + \"-\" + endDate.toDateString().replace(endDate.getFullYear().toString(), \"\").trimEnd();\n    \nfileName += \".json\";\n\nmsg.fileName = fileName;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1570,
        "y": 220,
        "wires": [
            [
                "6dfadfada71732b7",
                "2833bc30cabd27bb"
            ]
        ],
        "info": "## Define file name\r\nThis JS snippet utilizes the JavaScript date function `toDateString()` as well as some string manipulation to define the name of the JSON file which will be downloaded from Worklet web interface.\r\n\r\nThe name defined is later used to find and read the downloaded file, as the actual file name cannot be set when downloading, nor can it be retrieved as the download is in progress. Therefore, the name must be determined manually to match the naming procedure of Worklet web interface."
    },
    {
        "id": "df4e89fda20fa7db",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Find uafsluttet kørsel eller skab ny",
        "info": "",
        "x": 1240,
        "y": 180,
        "wires": []
    },
    {
        "id": "6dfadfada71732b7",
        "type": "change",
        "z": "8ea344595d9a442a",
        "d": true,
        "name": "TEST DATA",
        "rules": [
            {
                "t": "set",
                "p": "fileName",
                "pt": "msg",
                "to": "Kvitteringer-Thu Nov 17-Sun Nov 20.json",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1570,
        "y": 180,
        "wires": [
            [
                "2833bc30cabd27bb"
            ]
        ]
    },
    {
        "id": "28d8ac05e7f0f65f",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Findes filen?",
        "func": "const fs = global.get('fs');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\nmsg.filePath = downloadPath + \"\\\\\" + msg.fileName;\n\nif (fs.existsSync(msg.filePath))\n{\n    msg.payload = true;\n    node.status({ fill: \"green\", shape: \"dot\", text: \"Fil blev fundet\" });\n}\nelse\n{\n    msg.payload = false;\n    node.status({ fill: \"yellow\", shape: \"dot\", text: \"Fil blev ikke fundet!\" });\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 460,
        "wires": [
            [
                "bc7b13ac2323540b"
            ]
        ],
        "info": "## Check for file\r\nThis JS snippet utilizes global modules `FS` and `Path` to check if the receipt JSON file already exists, or needs to be downloaded."
    },
    {
        "id": "bc7b13ac2323540b",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 585,
        "y": 460,
        "wires": [
            [
                "144d6812d5213472"
            ],
            [
                "d97f7bbbe0210f54"
            ]
        ],
        "l": false,
        "info": "## Check for file - switch\r\nThis switch, which succeeds the JS snippet which determines receipt file existance, is used to skip the download of receipts if they already exist (they shouldn't!)."
    },
    {
        "id": "4003aad4b2b6a9c8",
        "type": "file in",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Læs JSON fil",
        "filename": "filePath",
        "filenameType": "msg",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 1430,
        "y": 440,
        "wires": [
            [
                "fa861baf7265d3be"
            ]
        ]
    },
    {
        "id": "fa861baf7265d3be",
        "type": "json",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Parse JSON",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 1535,
        "y": 440,
        "wires": [
            [
                "6558b47eb74e6c0c"
            ]
        ],
        "l": false
    },
    {
        "id": "8bc31d06862e8fe2",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Slet JSON fil",
        "func": "const fs = global.get('fs');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\nmsg.filePath = downloadPath + \"\\\\\" + msg.fileName;\n\nfs.unlinkSync(msg.filePath);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1730,
        "y": 440,
        "wires": [
            [
                "c7424ba7f15131f6",
                "0f583d6bfaad7d0e",
                "d183f106c2e11bce"
            ]
        ],
        "info": "## Delete JSON file\r\n\r\nThis JS snippet utilizes the FS module to delete the JSON file after it has been read to memory."
    },
    {
        "id": "d5a462980f4852cf",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Tjek om filen eksisterer",
        "info": "",
        "x": 500,
        "y": 420,
        "wires": []
    },
    {
        "id": "07d87534c4e0bbea",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Download fakturaliste",
        "info": "",
        "x": 1180,
        "y": 400,
        "wires": []
    },
    {
        "id": "c931f08e3a54e2f2",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Slet fakturaliste",
        "info": "",
        "x": 1740,
        "y": 400,
        "wires": []
    },
    {
        "id": "6558b47eb74e6c0c",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Sæt msg.receipts",
        "rules": [
            {
                "t": "set",
                "p": "receipts",
                "pt": "msg",
                "to": "payload.kvitteringer",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1585,
        "y": 440,
        "wires": [
            [
                "07aa032e7944f93b",
                "8bc31d06862e8fe2"
            ]
        ],
        "l": false,
        "info": "## Set msg.receipts\r\n\r\nThis change node sets msg.receipts = payload.kvitteringer (which contains an array of receipts), and deletes the payload afterwards."
    },
    {
        "id": "569d9f497b06babc",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Læs fakturaliste",
        "info": "",
        "x": 1440,
        "y": 400,
        "wires": []
    },
    {
        "id": "144d6812d5213472",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Sæt selectors",
        "rules": [
            {
                "t": "set",
                "p": "selectors",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.worklet",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.worklet.url",
                "pt": "msg",
                "to": "https://workletnew.snapp.dk/auth/sign-in",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.loginUser",
                "pt": "msg",
                "to": "input[name='username']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.loginPass",
                "pt": "msg",
                "to": "input[name='password']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.loginButton",
                "pt": "msg",
                "to": "button",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.datePickerFrom",
                "pt": "msg",
                "to": "[class='react-datepicker__input-container'] > input",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.datePickerActive",
                "pt": "msg",
                "to": "[class='react-datepicker-ignore-onclickoutside']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.datePickerTo",
                "pt": "msg",
                "to": "div:last-child > [class='react-datepicker__input-container'] > input",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.downloadButton",
                "pt": "msg",
                "to": "button[class='btn btn-primary btn-block primary-color']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.header",
                "pt": "msg",
                "to": "h1",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 760,
        "y": 440,
        "wires": [
            [
                "6a7f540f9f08ded4"
            ]
        ],
        "info": "## Sæt referencer\r\n\r\nIn this change node, CSS selectors for Worklet web interface (https://workletnew.snapp.dk/) are set for use in the PupController JSON file."
    },
    {
        "id": "6a7f540f9f08ded4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Set pup commands",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "[\t    {\t        \"action\": \"launch\",\t        \"parameters\":\t        {\t            \"headless\": true,\t            \"slowMo\": 50,\t            \"ignoreHTTPSErrors\": true,\t            \"defaultViewport\": null\t        }\t    },\t\t    {\t        \"action\": \"goto\",\t        \"url\": selectors.worklet.url\t    },\t    \t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.loginUser,\t        \"input\": workletUser\t    },\t\t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.loginPass,\t        \"input\": workletPass\t    },\t    \t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.loginButton\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.datePickerFrom\t    },\t\t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.datePickerActive,\t        \"input\": currentRun.startDate,\t        \"clear\": true\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.header\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.datePickerTo\t    },\t\t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.datePickerActive,\t        \"input\": currentRun.endDate,\t        \"clear\": true\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.header\t    },\t\t    {\t        \"action\": \"click\",\t        \"isDownload\": true,\t        \"path\": selectors.worklet.downloadButton\t    },\t    {\t        \"action\": \"close\"\t    }\t    \t]",
                "tot": "jsonata"
            },
            {
                "t": "delete",
                "p": "workletUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "workletPass",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 950,
        "y": 440,
        "wires": [
            [
                "15a1703b4a5286c7"
            ]
        ],
        "info": "## Set pup commands\r\n\r\nThis change node sets the automation flow JSON needed in PupController API. The flow is hard-coded with variable references to the CSS selectors defined in the preceeding node."
    },
    {
        "id": "bb143ed21df0febf",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Klargør download af faktura ift. datoer",
        "info": "",
        "x": 830,
        "y": 400,
        "wires": []
    },
    {
        "id": "07aa032e7944f93b",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "RECEIPTS",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "receipts",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1730,
        "y": 360,
        "wires": []
    },
    {
        "id": "15a1703b4a5286c7",
        "type": "subflow:41d1b8798efe7e15",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "",
        "x": 1160,
        "y": 440,
        "wires": [
            [
                "4424787318323d8e"
            ],
            []
        ]
    },
    {
        "id": "8a3db972f8fb7806",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Transform debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 970,
        "y": 1760,
        "wires": []
    },
    {
        "id": "5d7e42be40e46699",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "MSG ERRORS",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "errors",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 900,
        "y": 1600,
        "wires": []
    },
    {
        "id": "252ef6cdcba02f65",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Tilføj sager + ydelser til handlinger",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$|(\t\t$faktura := faktura;\t\t{\t    \"handlinger\": faktura.behandlinger @$b .(\t        $b := $b;\t\t        $b.sag ~> $boolean ?\t        {\t            \"handling\": \"Tilføj ydelse\",\t            \"type\": $b.type,\t            \"uid\": $b.uid,\t            \"fid\": $b.fid,\t            \"dato\": $faktura.dato\t        }\t        : $b.bevilget ?\t        [{\t            \"handling\": \"Opret sag\",\t            \"type\": $b.type,\t            \"uid\": $b.uid,\t            \"fid\": $b.fid\t        },\t        {\t            \"handling\": \"Tilføj ydelse\",\t            \"type\": $b.type,\t            \"fid\": $b.fid,\t            \"uid\": $b.uid,\t            \"dato\": $faktura.dato\t        }]\t        \t    )\t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 540,
        "y": 1440,
        "wires": [
            [
                "eea859cc92e89e3f"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "9639c713133c8b4b",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Opret sager / ydelser",
        "info": "",
        "x": 500,
        "y": 1400,
        "wires": []
    },
    {
        "id": "c728e9afbea480e9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Sæt tilskud = pris",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.handlinger|(\t\t$uid := uid;\t$behandling := $$.payload.faktura.behandlinger[uid = $uid];\t$fid := $behandling.fid;\t$faktura := $$.payload.faktura[id = $fid];\t$borger := $$.payload[cpr = $faktura.patientCPR];\t\thandling = \"Opret sag\" ? {} : \t{\t    \"tilskud\": $behandling.pris\t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1130,
        "y": 1440,
        "wires": [
            [
                "ebfc3d7f7b71a754"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "603f9dfeda911a10",
        "type": "link in",
        "z": "8ea344595d9a442a",
        "name": "Link in START",
        "links": [
            "48787abb96e28b68",
            "30b5b930fae41995"
        ],
        "x": 115,
        "y": 220,
        "wires": [
            [
                "632aa75f39860780"
            ]
        ]
    },
    {
        "id": "f5dbef72792b9011",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "START response out",
        "mode": "link",
        "links": [
            "5c74b689e0aee38b"
        ],
        "x": 1425,
        "y": 1840,
        "wires": []
    },
    {
        "id": "b51fbf12da5aebba",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Klargør data til UI",
        "info": "",
        "x": 480,
        "y": 1720,
        "wires": []
    },
    {
        "id": "a46e2a0c2cd58d9f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Beautify behandlingstitler",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura.behandlinger |\t( $t := titel;\t{\t    \"titel\": (titel = \"Behandlingpåklinik\") ? \"Behandling på klinik\"\t    :        (titel = \"Behandlingipatientsegethjem\") ? \"Behandling i patients eget hjem\"\t    :         $$.tilskudsInfo.tilskudsperioder.satser[wtitel = $t].titel\t})|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$.errors ~> | $.faktura.behandlinger |\t( $t := titel;\t{\t    \"titel\": (titel = \"Behandlingpåklinik\") ? \"Behandling på klinik\"\t    :        (titel = \"Behandlingipatientsegethjem\") ? \"Behandling i patients eget hjem\"\t    :         $$.tilskudsInfo.tilskudsperioder.satser[wtitel = $t].titel\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 710,
        "y": 1760,
        "wires": [
            [
                "4fa04433812ed133",
                "8a3db972f8fb7806"
            ]
        ]
    },
    {
        "id": "b5f7952c5718fafd",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Fjern borgere som ikke har en sag / bevilling",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload @$p.\t(\t    ($p.handlinger ~> $exists) ?\t    {\t        \"cpr\": $p.cpr,\t        \"persondata\": $p.persondata,\t        \"faktura\": $p.faktura,\t        \"handlinger\": $p.handlinger\t    }\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 570,
        "y": 1600,
        "wires": [
            [
                "c728e9afbea480e9",
                "5d7e42be40e46699"
            ]
        ]
    },
    {
        "id": "c23d52373f2634a2",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Find borgere som ikke har en sag / bevilling",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$append(errors, payload @$p.\t(\t    ($p.handlinger ~> $exists) = false ?\t    {\t        \"cpr\": $p.cpr,\t        \"regelbrud\": \"Ingen gyldig sag blev fundet til behandlingstypen\",\t        \"persondata\": $p.persondata,\t        \"faktura\": $p.faktura\t    }\t)\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 570,
        "y": 1560,
        "wires": [
            [
                "b5f7952c5718fafd"
            ]
        ]
    },
    {
        "id": "ea041c123c220cca",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Flyt borgere som ikke har handlinger til \"errors\"",
        "info": "",
        "x": 580,
        "y": 1520,
        "wires": []
    },
    {
        "id": "042534adf7219de9",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Beregn tilskud",
        "info": "",
        "x": 1110,
        "y": 1400,
        "wires": []
    },
    {
        "id": "ebfc3d7f7b71a754",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Fratræk ydelsesbestemt tillæg fra Danmark (type B + Danmark 1/2)",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.handlinger|(\t\t$uid := uid;\t$behandling := $$.payload.faktura.behandlinger[uid = $uid];\t$fid := $behandling.fid;\t$faktura := $$.payload.faktura[id = $fid];\t$borger := $$.payload[cpr = $faktura.patientCPR];\t$danmark := $borger.persondata.danmarkgruppe;\t\t$danmarkSats := $$.tilskudsInfo.tilskudsperioder.satser[wtitel = $behandling.titel];\t$danmarkProcent := tilskud * ($danmarkSats.tilskud_procent / 100);\t$danmarkMax := $danmarkSats.tilskud_maxdkk;\t\t$danmarkTilskud := $danmarkProcent > $danmarkMax ? $danmarkMax : $danmarkProcent;\t\t\t$behandling.type = \"B\" and ($danmark = 1 or $danmark = 2) ?\t{\t\t    \"tilskud\": tilskud - ($danmarkProcent > $danmarkMax ? $danmarkMax : $danmarkProcent)\t    \t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1280,
        "y": 1480,
        "wires": [
            [
                "8b251b9d384911a0"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "8b251b9d384911a0",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Fratræk 50% (maks 100) ved type A",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.handlinger|(\t\t$uid := uid;\t$behandling := $$.payload.faktura.behandlinger[uid = $uid];\t$fid := $behandling.fid;\t$faktura := $$.payload.faktura[id = $fid];\t$borger := $$.payload[cpr = $faktura.patientCPR];\t$danmark := $borger.persondata.danmarkgruppe;\t\t$tilskud_maxdkk := $$.tilskudsInfo.danmark_fratraek_maxdkk;\t$tilskud_procent := $$.tilskudsInfo.danmark_fratraek_procent;\t$danmarkProcent := tilskud * ($tilskud_procent / 100);\t$danmarkMax := $tilskud_maxdkk;\t\t$danmarkTilskud := $danmarkProcent > $danmarkMax ? $danmarkMax : $danmarkProcent;\t\t\t$behandling.type = \"A\" and ($danmark = 1 or $danmark = 2) and $faktura.ydernummer != \"ydernummermangler\" ?\t{\t\t    \"tilskud\": tilskud - ($danmarkProcent > $danmarkMax ? $danmarkMax : $danmarkProcent)\t    \t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1190,
        "y": 1520,
        "wires": [
            [
                "363e103b20db6c80"
            ]
        ],
        "info": "Hvis fodterapeut har ydernr (er statsautoriseret) og behandlingen er udført i Danmark, og borger er gruppe 1 og 2, fratrækkes et ydelsesbestemt tilskud på 50% fra Danmark (maks. 100 kr)."
    },
    {
        "id": "363e103b20db6c80",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Begræns tilskud der overstiger prisgrænse ved type A",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.handlinger|(\t\t$uid := uid;\t$behandling := $$.payload.faktura.behandlinger[uid = $uid];\t$fid := $behandling.fid;\t$faktura := $$.payload.faktura[id = $fid];\t$borger := $$.payload[cpr = $faktura.patientCPR];\t$danmark := $borger.persondata.danmarkgruppe;\t\t$tilskud_max_hjemme := $$.tilskudsInfo.max_hjemmebehandling;\t$tilskud_max_ude := $$.tilskudsInfo.max_udekoersel;\t\t$behandling.type = \"A\" ?\t{\t\t    \"tilskud\": (titel = \"Behandlingipatientsegethjem\") ?\t                    (tilskud > $tilskud_max_hjemme ? $tilskud_max_hjemme : tilskud)\t                    :\t                    (tilskud > $tilskud_max_ude ? $tilskud_max_ude : tilskud)\t    \t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1240,
        "y": 1560,
        "wires": [
            [
                "5cfe1b69780c58ab"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "5cfe1b69780c58ab",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Gang med tillægsprocent",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.handlinger|(\t\t$uid := uid;\t$behandling := $$.payload.faktura.behandlinger[uid = $uid];\t$fid := $behandling.fid;\t$faktura := $$.payload.faktura[id = $fid];\t$borger := $$.payload[cpr = $faktura.patientCPR];\t\t{\t    \"tilskud\": tilskud * ($faktura._helbredstillaegsprocent.tillaegsprocent / 100)\t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1150,
        "y": 1600,
        "wires": [
            [
                "da966ceeba7b23dd",
                "ac2d9ca641a094e8"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "632aa75f39860780",
        "type": "subflow:db94b4c117de2f6a",
        "z": "8ea344595d9a442a",
        "g": "7de50fe1369c94a7",
        "name": "",
        "x": 470,
        "y": 220,
        "wires": [
            [
                "64156b428449f87a"
            ]
        ]
    },
    {
        "id": "fde5a695bfbd9a7d",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Clean MSG",
        "rules": [
            {
                "t": "delete",
                "p": "workletUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "workletPass",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "tilskudsInfo",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "filename",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "filePath",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "receipts",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "citizens",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "selectors",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "pupOutputs",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "rules",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 950,
        "y": 1840,
        "wires": [
            [
                "1ac2795f481c336e"
            ]
        ]
    },
    {
        "id": "df5451114247dbd3",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Clean alt unødvendig data fra msg objekt",
        "info": "",
        "x": 1040,
        "y": 1800,
        "wires": []
    },
    {
        "id": "4fa04433812ed133",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Definér states (archived / recommended)",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $ |\t(\t    $fid := faktura[0].id;\t    {\t\t    \"recommended\": true,\t    \"archived\": $$.currentRun.processedReceipts[$ = $fid] ~> $exists()\t\t})|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$.errors ~> | $ |\t(\t    $fid := faktura[0].id;\t    {\t\t    \"recommended\": true,\t    \"archived\": $$.currentRun.processedReceipts[$ = $fid] ~> $exists()\t\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 640,
        "y": 1800,
        "wires": [
            [
                "5f3a3d3e30d3be55"
            ]
        ]
    },
    {
        "id": "230dad52a43f6b19",
        "type": "link in",
        "z": "8ea344595d9a442a",
        "name": "Archive receipt link in",
        "links": [
            "d84057a8cb05b22f",
            "87d1c73c93e5b9f7"
        ],
        "x": 395,
        "y": 2260,
        "wires": [
            [
                "135dfd2c3c6f4850"
            ]
        ]
    },
    {
        "id": "c6c8addcda828038",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Get current receipt ID",
        "rules": [
            {
                "t": "set",
                "p": "tempData",
                "pt": "msg",
                "to": "(\t    $num := payload.id ~> $number();\t    tempDataArray[$num].faktura.id\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1190,
        "y": 2260,
        "wires": [
            [
                "6c4f0dadb67f015e"
            ]
        ]
    },
    {
        "id": "135dfd2c3c6f4850",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Get history",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "currentRun",
                "pt": "msg",
                "to": "runHistory[$count(runHistory)-1]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 580,
        "y": 2260,
        "wires": [
            [
                "f3622da5b8c6dd11"
            ]
        ]
    },
    {
        "id": "6c4f0dadb67f015e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Set as processed",
        "rules": [
            {
                "t": "set",
                "p": "currentRun.processedReceipts",
                "pt": "msg",
                "to": "$distinct($append(currentRun.processedReceipts, tempData))",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := currentRun.startDate;\t$endDate := currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t\t    \"processedReceipts\": currentRun.processedReceipts\t    \t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1200,
        "y": 2300,
        "wires": [
            [
                "0fb1a45baf4dcc7c"
            ]
        ]
    },
    {
        "id": "a2f55ae008b1fee2",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "Is archived link out",
        "mode": "link",
        "links": [
            "0ff5c26114374820",
            "e0949865938522b8"
        ],
        "x": 1395,
        "y": 2420,
        "wires": []
    },
    {
        "id": "8b757888b921f031",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Arkivering af individuelle faktura",
        "info": "",
        "x": 510,
        "y": 2220,
        "wires": []
    },
    {
        "id": "45a7f796cd6e87c3",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Kontrol om alle fakturaer er arkiveret",
        "info": "",
        "x": 720,
        "y": 2360,
        "wires": []
    },
    {
        "id": "fc1053d3105b2cd0",
        "type": "function",
        "z": "8ea344595d9a442a",
        "name": "Check if all is archived",
        "func": "var isAllArchived = true;\n\nvar receiptsActions = [];\nvar receiptsNoActions = [];\n\n/*\nif (global.get(\"webData\") !== undefined)\n{\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptsActions += global.get(\"webData\")[\"citizens-actions\"];\n\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined)\n        receiptsNoActions += global.get(\"webData\")[\"citizens-noactions\"];\n\n    if (!Array.isArray(receiptsActions)) receiptsActions = [receiptsActions];\n    if (!Array.isArray(receiptsNoActions)) receiptsNoActions = [receiptsNoActions];\n}\n\nvar allReceipts = [];\n//allReceipts = allReceipts.concat(receiptsActions, receiptsNoActions);\nfor (var i = 0; i < receiptsActions.length; i++)\n    allReceipts.push(receiptsActions[i]);\n    \nfor (var i = 0; i < receiptsNoActions.length; i++)\n    allReceipts.push(receiptsNoActions[i]);\n    \nvar acceptedReceipts;\n\nglobal.set(\"tempTest\", allReceipts);\n*/\nvar acceptedReceipts = msg.currentRun.processedReceipts;\nvar allReceipts = msg.tempData;\n\n/*\nif (global.get(\"runHistory\", \"storeInFile\") !== undefined)\n    if (global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length - 1] !== undefined)\n        acceptedReceipts = global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length - 1].processedReceipts;\n*/\n\n//typeof global.get(\"webData\") == undefined || !Array.isArray(global.get(\"webData\")[\"citizens-actions\"]) ? 0 : global.get(\"webData\")[\"citizens-actions\"].length;\nvar remainingCount = allReceipts.length - acceptedReceipts.length;\n\nfor (var i = 0; i < allReceipts.length; i++)\n{\n\n    if (allReceipts[i].faktura === null || allReceipts[i].faktura === undefined)\n        continue;\n\n    var fakturaer = Array.isArray(allReceipts[i].faktura) ? allReceipts[i].faktura : [allReceipts[i].faktura];\n\n    for(var j = 0; j < fakturaer.length; j++)\n        if (!acceptedReceipts.includes(fakturaer[j].id))\n            isAllArchived = false;\n}\n\nmsg.isArchived = isAllArchived;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 2440,
        "wires": [
            [
                "62b82381ac8d827c"
            ]
        ]
    },
    {
        "id": "d04faa115ea73982",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "WorkLet login",
        "rules": [
            {
                "t": "set",
                "p": "workletUser",
                "pt": "msg",
                "to": "webData.workletCreds.workletUser",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "workletPass",
                "pt": "msg",
                "to": "webData.workletCreds.workletPass",
                "tot": "global",
                "dc": true
            },
            {
                "t": "delete",
                "p": "webData.workletCreds.workletUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "webData.workletCreds.workletPass",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 480,
        "y": 380,
        "wires": [
            [
                "28d8ac05e7f0f65f"
            ]
        ]
    },
    {
        "id": "c9cc2e6cd25fdbd6",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "[E] Download fakturaer for den bestemte tidsperiode",
        "info": "",
        "x": 590,
        "y": 340,
        "wires": []
    },
    {
        "id": "62b82381ac8d827c",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "isArchived",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 870,
        "y": 2420,
        "wires": [
            [
                "fb02e28cd75e69e8"
            ],
            [
                "b840a64a9cf3c187"
            ]
        ]
    },
    {
        "id": "d426a3d9a5cc587d",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "[]",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 880,
        "y": 260,
        "wires": [
            [
                "61d78c9d39ac193c"
            ]
        ]
    },
    {
        "id": "421ea3a3d1ce558a",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "#:(storeInFile)::runHistory",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 790,
        "y": 200,
        "wires": [
            [
                "619dc0bbb1fdf120"
            ],
            [
                "d426a3d9a5cc587d"
            ]
        ]
    },
    {
        "id": "61d78c9d39ac193c",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "currentRun",
                "pt": "msg",
                "to": "(\t$lastRun :=     runHistory[$count(runHistory)-1]\t ~> $exists() ? runHistory[$count(runHistory)-1];\t\t$lastRunWasToday := $lastRun ~> $exists ? ( $fromMillis($millis(), '[M01]/[D01]/[Y0001]') = $fromMillis($lastRun.timestamp, '[M01]/[D01]/[Y0001]') ) : false;\t\trunHistory[isFinalized = false] ~> $exists() ?\t    runHistory[isFinalized = false]\t:\t$lastRunWasToday ?\t    $lastRun\t:\t{\t    \"startDate\": $lastRun ~> $exists() ?\t                    $lastRun.timestamp ~> $fromMillis('[D01]/[M01]/[Y0001]')\t                        : \t                    presetStartDate,\t    \"endDate\":  ($millis() - 86400000) ~> $fromMillis('[D01]/[M01]/[Y0001]'), /* 86400000 ms = 1 day */\t    \"timestamp\": $millis(),\t    \t    \"processedReceipts\": [],\t\t    \"allReceiptsProcessed\": false,\t    \"isFinalized\": false,\t\t    \"currentStep\": {},\t    \"stepHistory\": [],\t    \"userName\": \"\"\t}\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1190,
        "y": 220,
        "wires": [
            [
                "0315b599de1a9914"
            ]
        ]
    },
    {
        "id": "a87343abb1f1ad70",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Set currentRun object",
        "info": "",
        "x": 1200,
        "y": 140,
        "wires": []
    },
    {
        "id": "172fd055f45774ea",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Hent runHistory",
        "info": "",
        "x": 820,
        "y": 160,
        "wires": []
    },
    {
        "id": "0fb1a45baf4dcc7c",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "tempData1",
                "pt": "msg",
                "to": "webData[\"citizens-actions\"]",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "tempData2",
                "pt": "msg",
                "to": "webData[\"citizens-noactions\"]",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "tempData",
                "pt": "msg",
                "to": "$append(tempData1, tempData2)",
                "tot": "jsonata"
            },
            {
                "t": "delete",
                "p": "tempData1",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "tempData2",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 660,
        "y": 2400,
        "wires": [
            [
                "fc1053d3105b2cd0"
            ]
        ]
    },
    {
        "id": "f3622da5b8c6dd11",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "payload.webSettings.state.activePage",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "view-nograntreceipts",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "view-receipts",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 740,
        "y": 2260,
        "wires": [
            [
                "d521a5aad7378097"
            ],
            [
                "609b3d8d3bfd669e"
            ]
        ]
    },
    {
        "id": "d521a5aad7378097",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "tempDataArray",
                "pt": "msg",
                "to": "webData.citizens-noactions",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 940,
        "y": 2240,
        "wires": [
            [
                "c6c8addcda828038"
            ]
        ]
    },
    {
        "id": "609b3d8d3bfd669e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "tempDataArray",
                "pt": "msg",
                "to": "webData.citizens-actions",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 940,
        "y": 2280,
        "wires": [
            [
                "c6c8addcda828038"
            ]
        ]
    },
    {
        "id": "fb02e28cd75e69e8",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Set allReceiptsProcessed = true",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := $$.currentRun.startDate;\t$endDate := $$.currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t    \"allReceiptsProcessed\": true\t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1090,
        "y": 2400,
        "wires": [
            [
                "b840a64a9cf3c187"
            ]
        ]
    },
    {
        "id": "619dc0bbb1fdf120",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "get runHistory",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 960,
        "y": 200,
        "wires": [
            [
                "61d78c9d39ac193c"
            ]
        ]
    },
    {
        "id": "56f4f81f3f45559e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "presetStartDate",
                "pt": "msg",
                "to": "08/02/2023",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 695,
        "y": 200,
        "wires": [
            [
                "421ea3a3d1ce558a"
            ]
        ],
        "l": false,
        "info": "## Set grant info\r\nThis change node defines the remaining relevant grant information, and copies the grant periods set in last node."
    },
    {
        "id": "0315b599de1a9914",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "update runHistory",
        "rules": [
            {
                "t": "set",
                "p": "currentRun.isFinalized",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "(\t    $startDate := currentRun.startDate;\t    $endDate := currentRun.endDate;\t\t    (runHistory[startDate = $startDate and endDate = $endDate] ~> $exists()) = false ?\t\t    $append(runHistory, currentRun)\t    :\t    runHistory\t)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1390,
        "y": 220,
        "wires": [
            [
                "2c5bfa6b7a2613ab"
            ]
        ]
    },
    {
        "id": "c04211aaccb15e0a",
        "type": "link in",
        "z": "8ea344595d9a442a",
        "name": "Finalize run in",
        "links": [
            "f202f5cad72d049b",
            "2fbf1e644fc53a26"
        ],
        "x": 395,
        "y": 2660,
        "wires": [
            [
                "cb15176764c11180"
            ]
        ]
    },
    {
        "id": "3f4a10860acd5500",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Finalize run",
        "info": "",
        "x": 450,
        "y": 2620,
        "wires": []
    },
    {
        "id": "cb15176764c11180",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Get history",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "currentRun",
                "pt": "msg",
                "to": "runHistory[$count(runHistory)-1]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 570,
        "y": 2660,
        "wires": [
            [
                "72afce271d46b8f9"
            ]
        ]
    },
    {
        "id": "72afce271d46b8f9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "set isFinalized = true",
        "rules": [
            {
                "t": "set",
                "p": "currentRun.isFinalized",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := currentRun.startDate;\t$endDate := currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t\t    \"isFinalized\": true\t    \t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "webSettings.state.isRunning",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 2660,
        "wires": [
            [
                "25f140a78f720950"
            ]
        ]
    },
    {
        "id": "25f140a78f720950",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "Is archived link out",
        "mode": "link",
        "links": [
            "23a573cb9952c0ef"
        ],
        "x": 1105,
        "y": 2660,
        "wires": []
    },
    {
        "id": "eea859cc92e89e3f",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Fjern duplicates (af Tilføj sag-handlinger)",
        "func": "if(msg.payload == null)\n    return msg;\n\nif(!Array.isArray(msg.payload))\n    msg.payload = [msg.payload];\n\nfor (var i = 0; i < msg.payload.length; i++) {\n    var obj = msg.payload[i];\n\n    var createTypeA = false;\n    var createTypeB = false;\n    //var tempHandlinger = [];\n\n    // Tjek hver borgers handlinger\n\n    if (obj.handlinger !== null && obj.handlinger !== undefined) {\n\n        if (!Array.isArray(obj.handlinger))\n            obj.handlinger = [obj.handlinger];\n\n        for (var j = 0; j < obj.handlinger.length; j++) {\n            if (obj.handlinger[j].handling == \"Opret sag\") {\n                if (obj.handlinger[j].type = \"A\") {\n                    if (createTypeA) {\n                        //console.log(\"Another A already exists for receipt \" + obj.handlinger[j].fid);\n                        obj.handlinger.splice(j, 1);\n                        continue;\n                    }\n                    createTypeA = true;\n                    //tempHandlinger.push(msg.payload.handlinger[j]);\n                }\n\n                else if (obj.handlinger[j].type = \"B\") {\n                    if (createTypeB) {\n                        //console.log(\"Another B already exists for receipt \" + obj.handlinger[j].fid);\n                        obj.handlinger.splice(j, 1);\n                        continue;\n                    }\n                    createTypeB = true;\n                    //tempHandlinger.push(msg.payload.handlinger[j]);\n                }\n            }\n        }\n\n\n        msg.payload[i] = obj;\n\n    }\n\n\n\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 1480,
        "wires": [
            [
                "c23d52373f2634a2"
            ]
        ]
    },
    {
        "id": "87437eca4cc7eec9",
        "type": "websocket out",
        "z": "8ea344595d9a442a",
        "name": "WorkLet WebSocket",
        "server": "13a90a014adf9bc5",
        "client": "",
        "x": 2120,
        "y": 180,
        "wires": []
    },
    {
        "id": "966a912086c08955",
        "type": "subflow:85ff29bdef7c1aea",
        "z": "8ea344595d9a442a",
        "name": "",
        "x": 1970,
        "y": 580,
        "wires": [
            []
        ]
    },
    {
        "id": "21aa70c86addca5a",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Add step run history",
        "rules": [
            {
                "t": "set",
                "p": "stepHistoryChange",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "stepHistoryChange.newStep",
                "pt": "msg",
                "to": "extract-worklet",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "stepHistoryChange.newState",
                "pt": "msg",
                "to": "running",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2000,
        "y": 540,
        "wires": [
            [
                "966a912086c08955"
            ]
        ]
    },
    {
        "id": "72df366e32bdb61f",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 160,
        "y": 80,
        "wires": [
            [
                "e14341e7aef81e59"
            ]
        ]
    },
    {
        "id": "e14341e7aef81e59",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "delete",
                "p": "#:(storeInFile)::grants",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "#:(storeInFile)::rules",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "#:(storeInFile)::webSettings",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "webStates",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "webSteps",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "webData",
                "pt": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "4424787318323d8e",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Findes filen?",
        "func": "const fs = global.get('fs');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\nmsg.filePath = downloadPath + \"\\\\\" + msg.fileName;\n\nif (fs.existsSync(msg.filePath))\n{\n    msg.fileExists = true;\n    node.status({ fill: \"green\", shape: \"dot\", text: \"Fil blev fundet\" });\n}\nelse\n{\n    msg.fileExists = false;\n    node.status({ fill: \"yellow\", shape: \"dot\", text: \"Fil blev ikke fundet!\" });\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1430,
        "y": 340,
        "wires": [
            [
                "023477a667bd9144"
            ]
        ],
        "info": "## Check for file\r\nThis JS snippet utilizes global modules `FS` and `Path` to check if the receipt JSON file already exists, or needs to be downloaded."
    },
    {
        "id": "023477a667bd9144",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "",
        "property": "fileExists",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1535,
        "y": 340,
        "wires": [
            [
                "62ce56e92ec4f29b"
            ],
            [
                "4003aad4b2b6a9c8"
            ]
        ],
        "l": false
    },
    {
        "id": "0051afd9266db397",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Fil blev ikke downloaded",
        "info": "",
        "x": 1680,
        "y": 320,
        "wires": []
    },
    {
        "id": "4629d4bebfd2768f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Sammensæt lister",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "/* Laver array med objekt for hver borger, og tilknytter fakturaer */\t\t$keys(citizens)@$k.{\t\t    \"cpr\": $k,\t    \"persondata\": $lookup(citizens, $k),\t    \"faktura\": receipts[$.patientCPR = $k]\t    \t}\t",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 450,
        "y": 920,
        "wires": [
            [
                "00a9a4712b97560f"
            ]
        ],
        "info": "https://try.jsonata.org/wRgtKDrKD"
    },
    {
        "id": "aea48540dc37e51c",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Saml borgere og fakturaer",
        "info": "",
        "x": 470,
        "y": 880,
        "wires": []
    },
    {
        "id": "64bc816ed683fb56",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Personlig tillægsprocenter",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|(\t\t$tillaegsprocent_split := personligtillaegsprocent\t    ~> $replace(\"Personlig tillægsprocent\\tGyldig fra\\tGyldig til\\tAjourføringsdato\\n\", \"\")\t    ~> $split(\"\\n\");\t{\t\t\"personligtillaegsprocent\": $tillaegsprocent_split #$i .{\t\t    \"dato_fra\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[1]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"dato_til\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[2]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"tillaegsprocent\": ($t := (($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[0]\t        ~> $replace(\"%\", \"\")\t        ~> $replace(\"Ingen resultater fundet\", \"0\"));\t          ($t = \"\" ? 0 : $number($t)))\t    }\t\t}\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 470,
        "y": 1040,
        "wires": [
            [
                "78c4e4692985e738"
            ]
        ],
        "info": "https://try.jsonata.org/4J8IPRU83"
    },
    {
        "id": "b01934ac82f070c3",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Bevilget tilskud til fodpleje?",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|\t{\t\"bevilling\":\t    bevilling \t    ~> $contains(\"fodpleje\")\t}|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 480,
        "y": 1000,
        "wires": [
            [
                "64bc816ed683fb56"
            ]
        ]
    },
    {
        "id": "31392fe7f3a93ccd",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Gør KP data maskinelt læsbart",
        "info": "",
        "x": 490,
        "y": 960,
        "wires": []
    },
    {
        "id": "141037f73383a9f6",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Tildel unikke behandlings-ID'er",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura |\t({\t\t\"behandlinger\": behandlinger @$b #$i .{\t\t    \"uid\": (id ~> $substring(19,17))\t            & \"-\" & $b.ydelsesnummer\t            & \"-\" & ($i+1),\t\t    \"fid\": id,\t\t    \"titel\": $b.titel,\t    \"ydelsesnummer\": $b.ydelsesnummer,\t    \"ydernummer\": $b.ydernummer,\t    \"behandlingsKategory\": $b.behandlingsKategory,\t    \"pris\": $b.pris,\t    \"kørteKilometer\": $b.kørteKilometer,\t    \"patientAndel\": $b.patientAndel,\t    \"sygesikringsAndel\": $b.sygesikringsAndel\t\t}\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1190,
        "y": 1080,
        "wires": [
            [
                "7f450a3e484312bd"
            ]
        ],
        "info": "https://try.jsonata.org/zbfWKbpM7"
    },
    {
        "id": "78c4e4692985e738",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Helbredstillægsprocenter",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|(\t\t$tillaegsprocent_split := helbredstillaegsprocent\t    ~> $replace(\"Helbredstillægsprocent\\tGyldig fra\\tGyldig til\\tAjourføringsdato\\n\", \"\")\t    ~> $split(\"\\n\");\t{\t\t\"helbredstillaegsprocent\": $tillaegsprocent_split #$i .{\t\t    \"dato_fra\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[1]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"dato_til\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[2]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"tillaegsprocent\": ($t := (($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[0]\t        ~> $replace(\"%\", \"\")\t        ~> $replace(\"Ingen resultater fundet\", \"0\"));\t          ($t = \"\" ? 0 : $number($t)))\t    }\t\t}\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 470,
        "y": 1080,
        "wires": [
            [
                "2cf375bbbada29f9"
            ]
        ],
        "info": "https://try.jsonata.org/4J8IPRU83"
    },
    {
        "id": "2cf375bbbada29f9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Sager",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|(\t\t$sager_split := sager\t    ~> $replace(\"\\n\", \"\")\t    ~> $replace(\"\\t\\t\", \"\\t\")\t    ~> $substringAfter(\"\\t\")\t    ~> $split(\"\\t\");\t{\t    \"sager\": $sager_split #$i .(\t\t        /* Hvis kolonne-antal ændrer sig, breaker denne kode */\t\t        $i % 5 = 0 and $i != 0 ?\t        {\t            \"titel\": $sager_split[$i],\t            \t            \"type\": $sager_split[$i+1],\t\t            \"fra\": $sager_split[$i+2]\t                ~> $toMillis('[D01]-[M01]-[Y0001]')\t                ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t            \"til\": $til := ($sager_split[$i+3]\t                ~> $toMillis('[D01]-[M01]-[Y0001]')\t                ~> $fromMillis('[Y0001]-[M01]-[D01]')),\t\t            \"aktiv\": ($til ~> $boolean()) ? ( $til ~> $toMillis() > $millis() ? true : false ) : true,\t\t            \"bevilling\": ($sager_split[$i+4] = \"Bevilget\")\t        })\t\t    }\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 410,
        "y": 1120,
        "wires": [
            [
                "12d9ffdfaf71a523"
            ]
        ],
        "info": "https://try.jsonata.org/4J8IPRU83"
    },
    {
        "id": "12d9ffdfaf71a523",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Formue",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|\t{\t    \"formue\": \t            formue = \"Ikke oplyst\" ?\t                null\t            :\t            formue = \"-\" ?\t                null\t            :\t                (formue\t                ~> $replace(\"-\", \"-1\")\t                ~> $split(\" \"))[0]\t                ~> $replace(\".\", \"\")\t                ~> $replace(\",\", \".\")\t                ~> $number()\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 1160,
        "wires": [
            [
                "ca6df1c9d056a924"
            ]
        ]
    },
    {
        "id": "011d535e3ab60636",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Transformer faktura data (+ fjern unødvendig data)",
        "info": "",
        "x": 1250,
        "y": 960,
        "wires": []
    },
    {
        "id": "71c55498ef71a4c9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Fjern unødvendig data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.faktura|\t{},\t[\t    \"behandlerNavn\",\t    \"klinikNavn\",\t    \"klinikCVR\",\t    \"behandlerType\",\t    \"patientTelefon\"\t]\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1160,
        "y": 1000,
        "wires": [
            [
                "6afaf8f1c596de67"
            ]
        ]
    },
    {
        "id": "6afaf8f1c596de67",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Fjern tidspunkt fra dato",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.faktura|\t{\t    \"dato\": (dato\t        ~> $split(\"T\"))[0]\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1160,
        "y": 1040,
        "wires": [
            [
                "141037f73383a9f6"
            ]
        ]
    },
    {
        "id": "05096968ae22cc6f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Bestem behandlingstype",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura.behandlinger |\t({\t\t    \"type\": (titel = 'Behandlingipatientsegethjem' or\t             titel = 'Behandlingpåklinik' or\t             titel = \"Behandlingudentilskud\") ?\t                'A' : 'B'\t\t})|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$.errors ~> | $.faktura.behandlinger |\t({\t\t    \"type\": (titel = 'Behandlingipatientsegethjem' or\t             titel = 'Behandlingpåklinik' or\t             titel = \"Behandlingudentilskud\") ?\t                'A' : 'B'\t\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1170,
        "y": 1240,
        "wires": [
            [
                "046eb82cefda08d4"
            ]
        ],
        "info": "https://try.jsonata.org/zbfWKbpM7"
    },
    {
        "id": "215c708ef9319356",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Hent regler fra global variabel",
        "rules": [
            {
                "t": "set",
                "p": "rules",
                "pt": "msg",
                "to": "#:(storeInFile)::rules",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 810,
        "y": 1020,
        "wires": [
            [
                "4c51b10755b92b07"
            ]
        ]
    },
    {
        "id": "c68d4ee2f02ada08",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Kontroller KP data ud fra regelsæt",
        "info": "",
        "x": 820,
        "y": 980,
        "wires": []
    },
    {
        "id": "4c51b10755b92b07",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Tjek alle regler mod borgerdata",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "payload @$p.\t(\t$respectsRule := function($rule, $value)\t{\t    $rule.operator = \"!null\" ?\t        $value != null\t    :\t    $value = null ?\t        false\t    :\t    $rule.operator = \"<\" ?\t        $value < $rule.value\t    :\t    $rule.operator = \">\" ?\t        $value > $rule.value\t    :\t    $rule.operator = \"==\" ?\t        $value = $rule.value\t    :\t    $rule.operator = \"!=\" ?\t        $value != $rule.value\t    :\t    $rule.operator = \"contains\" ?\t        ($contains($string($rule.value), $string($value)))\t    :\t    $rule.operator = \"!contains\" ?\t        ($contains($string($rule.value), $string($value)) ? false : true)\t};\t{\t    \"cpr\": $p.cpr,\t    \"persondata\": $p.persondata,\t    \"faktura\": $p.faktura,\t\t    \"regelbrud\":\t        rules @$r.\t        (\t            $respectsRule($r, $data := $lookup($p.persondata, $r.variable)) = false ?\t            {\t                \"rule\": $r.name,\t                \"description\": $r.description,\t                \"objectValue\": $data,\t                \"operator\": $r.operator,\t                \"expectedValue\": $r.value,\t                \"isRespected\": $respectsRule($r, $data)\t            }\t        )\t}\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 810,
        "y": 1060,
        "wires": [
            [
                "4e374431cb68ace4"
            ]
        ]
    },
    {
        "id": "4e374431cb68ace4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find regelbrud",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "errors @$e.\t(\t    $e.regelbrud ~> $boolean ?\t    {\t        \"cpr\": $e.cpr,\t        \"persondata\": $e.persondata,\t        \"faktura\": $e.faktura,\t        \"regelbrud\": $e.regelbrud\t    }\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 760,
        "y": 1100,
        "wires": [
            [
                "5e112e4574f64f9b"
            ]
        ]
    },
    {
        "id": "5e112e4574f64f9b",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Fjern borgere som ikke er berettiget",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload @$p.\t(\t    \t    (errors[cpr = $p.cpr] ~> $exists) = false ?\t    {\t        \"cpr\": $p.cpr,\t        \"persondata\": $p.persondata,\t        \"faktura\": $p.faktura\t    }\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 1140,
        "wires": [
            [
                "ac26dfbc2efcbb4f"
            ]
        ]
    },
    {
        "id": "046eb82cefda08d4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find bevilling + sag gældende for hver behandling",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura.behandlinger |\t(\t\t    $uid := uid;\t    $fid := fid;\t    $faktura := $$.payload.faktura[id = $fid];\t    $borger := $$.payload[cpr = $faktura.patientCPR];\t    $type := type;\t\t{\t    \"bevilget\": type = 'A' ?\t                    ($borger.persondata.bevilling ?\t                        true : $borger.persondata.sager\t                                [   \t                                    titel ~> $lowercase ~> $contains(\"fod\")\t                                and\t                                    (type ~> $lowercase ~> $contains(\"udvidet helbredstill\"))\t                                and\t                                    ($faktura.dato ~> $toMillis) > (fra ~> $toMillis)\t                                and\t                                    (til ? ($faktura.dato ~> $toMillis) < (til ~> $toMillis) : true)\t                                and\t                                    bevilling = true\t                                ]\t                                    ~> $exists ? true : false)\t                :\t                    ($borger.persondata.sager\t                        [\t                            (type ~> $lowercase ~> $contains(\"almindeligt helbred\")\t                        or\t                            type ~> $lowercase ~> $contains(\"gskort\"))\t                        and\t                            ($faktura.dato ~> $toMillis) > (fra ~> $toMillis)\t                        and\t                            (til ? ($faktura.dato ~> $toMillis) < (til ~> $toMillis) : true)\t                        and\t                            bevilling = true\t                        ]\t                            ~> $exists ? true : false),\t                                \t    \"sag\": $borger.persondata.sager\t                [\t                    titel ~> $lowercase ~> $contains(\"fod\")\t                and\t                    ($type = 'A' ?\t                        (type ~> $lowercase ~> $contains(\"udvidet helbred\"))\t                    :\t                        (type ~> $lowercase ~> $contains(\"almindeligt helbredstill\")\t                    or\t                        type ~> $lowercase ~> $contains(\"gskort\")))\t                and\t                    ($faktura.dato ~> $toMillis) > (fra ~> $toMillis)\t                and\t                    (til ? ($faktura.dato ~> $toMillis) < (til ~> $toMillis) : true)\t                and\t                    bevilling = true\t                ]\t\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1250,
        "y": 1280,
        "wires": [
            [
                "252ef6cdcba02f65",
                "dc943787affd67f4",
                "978e5ad5accb9ada"
            ]
        ]
    },
    {
        "id": "6b4df0013a0256a0",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find relevant data for hver behandling på faktura",
        "info": "",
        "x": 1240,
        "y": 1200,
        "wires": []
    },
    {
        "id": "7f450a3e484312bd",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find tillægsprocent gældende for hver faktura",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura |\t(\t\t    $id := id;\t    /*$borger := $$.payload[faktura.id = $id];*/\t    $borger := $$.payload[$id in faktura.id];\t    $dato := dato;\t\t{\t\t    \"_personligtillaegsprocent\": $borger.persondata.personligtillaegsprocent [\t        ($dato ~> $toMillis) > (dato_fra ~> $toMillis)\t    and\t        (dato_til ~> $boolean ? (($dato ~> $toMillis) < (dato_til ~> $toMillis)) : true)\t    ],\t\t    \"_helbredstillaegsprocent\": $borger.persondata.helbredstillaegsprocent [\t        ($dato ~> $toMillis) > (dato_fra ~> $toMillis)\t    and\t        (dato_til ~> $boolean ? (($dato ~> $toMillis) < (dato_til ~> $toMillis)) : true)\t    ]\t\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1230,
        "y": 1160,
        "wires": [
            [
                "05096968ae22cc6f"
            ]
        ]
    },
    {
        "id": "852046d71f487d02",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find relevant data for hver faktura",
        "info": "",
        "x": 1190,
        "y": 1120,
        "wires": []
    },
    {
        "id": "fa59a67027b60c71",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Fjern borgere som ikke har gyldig tillægsprocent?",
        "info": "",
        "x": 1520,
        "y": 1120,
        "wires": []
    },
    {
        "id": "015eb190e5565e7d",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "[T] Transformér data, beregn tilskud",
        "info": "",
        "x": 500,
        "y": 840,
        "wires": []
    },
    {
        "id": "989112eb96abfdb9",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Fjern faktura / behandlinger på faktura som allerede er behandlet",
        "info": "https://try.jsonata.org/wRgtKDrKD",
        "x": 1290,
        "y": 860,
        "wires": []
    },
    {
        "id": "b81c9fcaa9d3e0d1",
        "type": "change",
        "z": "8ea344595d9a442a",
        "d": true,
        "g": "287b33b8879cbbbc",
        "name": "Fjern allerede behanlede faktura",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload @$p .(\t\t{\t    \"test\": $$.runHistory.processedReceipts[fid = $p.faktura.id],\t    \"cpr\": $p.cpr,\t    \"persondata\": $p.persondata,\t    \"faktura\": $p.faktura\t}) ",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1190,
        "y": 900,
        "wires": [
            []
        ],
        "info": "https://try.jsonata.org/wRgtKDrKD"
    },
    {
        "id": "104d29ffe37f5998",
        "type": "change",
        "z": "8ea344595d9a442a",
        "d": true,
        "g": "287b33b8879cbbbc",
        "name": "Fjern behandlinger som allerede er bearbejdet",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.faktura|\t{\t    \"behandlinger\": behandlinger @$b . (\t        ( $b.uid in $$.runHistory.processedReceiptss[id = $b.fid].uid ) = false ?\t            $b )\t}|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1520,
        "y": 900,
        "wires": [
            []
        ],
        "info": "https://try.jsonata.org/wRgtKDrKD"
    },
    {
        "id": "ca6df1c9d056a924",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Danmark",
        "func": "if(msg.payload == null)\n    return;\n\nif(!Array.isArray(msg.payload))\n    msg.payload = [msg.payload];\n    \nfor(var i = 0; i < msg.payload.length; i++)\n\n{\n    const obj = msg.payload[i].persondata;\n\n    var danmarkNum;\n\n    if(obj == null || obj.danmarkgruppe == null)\n        continue;\n\n    if (obj.danmarkgruppe.toLowerCase().includes(\"ja\") && obj.danmarkgruppe.includes(\"1\"))\n        danmarkNum = 1;\n    else if (obj.danmarkgruppe.toLowerCase().includes(\"ja\") && obj.danmarkgruppe.includes(\"2\"))\n        danmarkNum = 2;\n    else if (obj.danmarkgruppe.toLowerCase().includes(\"ja\") && obj.danmarkgruppe.includes(\"5\"))\n        danmarkNum = 5;\n    else\n        danmarkNum = 0;\n\n    obj.danmarkgruppe = danmarkNum;\n    \n\n    /*\n    $.payload ~> |$.persondata|\n(\n{\n    \"danmarkgruppe\": danmarkgruppe\n    ~> $replace(\"Ikke oplyst\", \"0\")\n    ~> $replace(\"Nej\", \"0\")\n    ~> $replace(\"Ja - Gruppe \", \"\")\n    ~> $replace(\"-\", \"0\")\n    ~> $number\n})\n|\n*/\n\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1200,
        "wires": [
            [
                "81cc412d0d2170b9"
            ]
        ]
    },
    {
        "id": "00a9a4712b97560f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "missingData",
                "pt": "msg",
                "to": "receipts @$r.\t(\t    payload[cpr = $r.patientCPR] ~> $exists() = false ?\t    {\t        \"cpr\": $r.patientCPR,\t        \"faktura\": $r,\t        \"regelbrud\": \"Borger-data blev ikke indsamlet korrekt\"\t    }\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 900,
        "wires": [
            [
                "b01934ac82f070c3"
            ]
        ]
    },
    {
        "id": "1ee2c685a74c09b0",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Mangler borgere?",
        "info": "",
        "x": 730,
        "y": 860,
        "wires": []
    },
    {
        "id": "ac26dfbc2efcbb4f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Saml errors og missingData lister",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$append(errors, missingData)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 1180,
        "wires": [
            [
                "71c55498ef71a4c9"
            ]
        ]
    },
    {
        "id": "81cc412d0d2170b9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "URL",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|\t{\t    \"kpurl\": \t            kpurl ~> $contains(\"overblik?pId=\") ?\t                (kpurl ~> $split(\"overblik?pId=\"))[1]\t            :\t            (((kpurl ~> $split(\"/person/\"))[1]) ~> $split(\"/overblik\"))[0]\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 410,
        "y": 1240,
        "wires": [
            [
                "7d7a7bf5a54224e8",
                "978e5ad5accb9ada"
            ]
        ]
    },
    {
        "id": "c3932c1fbca91f98",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Set userName in runHistory",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := currentRun.startDate;\t$endDate := currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t\t    \"userName\": $$.brugernavn\t    \t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "currentRun.userName",
                "pt": "msg",
                "to": "brugernavn",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1660,
        "y": 680,
        "wires": [
            [
                "19bdc53204115899",
                "6f70a9263a101b22"
            ]
        ]
    },
    {
        "id": "f811b83fc07bb1cd",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Kontrol om alle fakturaer er arkiveret",
        "info": "",
        "x": 580,
        "y": 1860,
        "wires": []
    },
    {
        "id": "c7ca8c02a788a41d",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Check if all is archived",
        "func": "var isAllArchived = true;\n\nvar receiptsActions = [];\nvar receiptsNoActions = [];\n\n/*\nif (global.get(\"webData\") !== undefined)\n{\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptsActions += global.get(\"webData\")[\"citizens-actions\"];\n\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined)\n        receiptsNoActions += global.get(\"webData\")[\"citizens-noactions\"];\n\n    if (!Array.isArray(receiptsActions)) receiptsActions = [receiptsActions];\n    if (!Array.isArray(receiptsNoActions)) receiptsNoActions = [receiptsNoActions];\n}\n\nvar allReceipts = [];\n//allReceipts = allReceipts.concat(receiptsActions, receiptsNoActions);\nfor (var i = 0; i < receiptsActions.length; i++)\n    allReceipts.push(receiptsActions[i]);\n    \nfor (var i = 0; i < receiptsNoActions.length; i++)\n    allReceipts.push(receiptsNoActions[i]);\n    \nvar acceptedReceipts;\n\nglobal.set(\"tempTest\", allReceipts);\n*/\nvar acceptedReceipts = msg.currentRun.processedReceipts;\nvar allReceipts = msg.tempData;\n\nif(!Array.isArray(allReceipts))\n    allReceipts = [allReceipts];\n\nif (allReceipts.length == 0 || allReceipts == null)\n{\n    console.log(\"Length = 0 or null is happening!\");\n    msg.isArchived = true;\n    return msg;\n}\n\n/*\nif (global.get(\"runHistory\", \"storeInFile\") !== undefined)\n    if (global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length - 1] !== undefined)\n        acceptedReceipts = global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length - 1].processedReceipts;\n*/\n\n//typeof global.get(\"webData\") == undefined || !Array.isArray(global.get(\"webData\")[\"citizens-actions\"]) ? 0 : global.get(\"webData\")[\"citizens-actions\"].length;\nvar remainingCount = allReceipts.length - acceptedReceipts.length;\n\nfor (var i = 0; i < allReceipts.length; i++)\n{\n\n    if (allReceipts[i].faktura === null || allReceipts[i].faktura === undefined)\n        continue;\n\n    var fakturaer = Array.isArray(allReceipts[i].faktura) ? allReceipts[i].faktura : [allReceipts[i].faktura];\n\n    for(var j = 0; j < fakturaer.length; j++)\n        if (!acceptedReceipts.includes(fakturaer[j].id))\n            isAllArchived = false;\n}\n\nmsg.isArchived = isAllArchived;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 1940,
        "wires": [
            [
                "8f4d2dcc4c986825"
            ]
        ]
    },
    {
        "id": "8f4d2dcc4c986825",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "",
        "property": "isArchived",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 750,
        "y": 1940,
        "wires": [
            [
                "78f7e1718ab3f755"
            ],
            [
                "4840de2e1aa54398"
            ]
        ]
    },
    {
        "id": "5f3a3d3e30d3be55",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "tempData1",
                "pt": "msg",
                "to": "payload",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "tempData2",
                "pt": "msg",
                "to": "errors",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "tempData",
                "pt": "msg",
                "to": "$append(tempData1, tempData2)",
                "tot": "jsonata"
            },
            {
                "t": "delete",
                "p": "tempData1",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "tempData2",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 520,
        "y": 1900,
        "wires": [
            [
                "c7ca8c02a788a41d"
            ]
        ]
    },
    {
        "id": "78f7e1718ab3f755",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Set allReceiptsProcessed = true",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := $$.currentRun.startDate;\t$endDate := $$.currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t    \"allReceiptsProcessed\": true\t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 970,
        "y": 1920,
        "wires": [
            [
                "4840de2e1aa54398"
            ]
        ]
    },
    {
        "id": "f55297e5ed366346",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "name": "",
        "props": [
            {
                "p": "message",
                "v": "Der opstod en test fejl!",
                "vt": "str"
            },
            {
                "p": "title",
                "v": "Test fejl!!",
                "vt": "str"
            },
            {
                "p": "type",
                "v": "alert",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1810,
        "y": 80,
        "wires": [
            [
                "ce2b8af41ddd37a2"
            ]
        ]
    },
    {
        "id": "1ac2795f481c336e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "webSettings.state.isRunning",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1230,
        "y": 1840,
        "wires": [
            [
                "f5dbef72792b9011"
            ]
        ]
    },
    {
        "id": "c9559b185b3f221b",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "RESET ALT",
        "info": "",
        "x": 170,
        "y": 40,
        "wires": []
    },
    {
        "id": "5d845493f726cf42",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "name": "",
        "props": [
            {
                "p": "message",
                "v": "Henter fakturaer fra WorkLet ...",
                "vt": "str"
            },
            {
                "p": "type",
                "v": "update",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 1710,
        "y": 120,
        "wires": [
            [
                "c7424ba7f15131f6"
            ]
        ]
    },
    {
        "id": "63ec872a76a39ffb",
        "type": "link in",
        "z": "8ea344595d9a442a",
        "name": "WS IN",
        "links": [
            "427c8a1a563502c8",
            "5b599232bb01d1d2",
            "5ee0ef61ccdcafac",
            "75f1aaf5a21e12a8",
            "f1884a7421b13391",
            "181615f06b564d1e",
            "7e0e36d833794733"
        ],
        "x": 1825,
        "y": 180,
        "wires": [
            [
                "d8fce4eadecd4493"
            ]
        ]
    },
    {
        "id": "96c62bac832126e6",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "RunHistory WiP",
        "info": "",
        "x": 1980,
        "y": 520,
        "wires": []
    },
    {
        "id": "0f583d6bfaad7d0e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Henter persondata fra KP ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1930,
        "y": 460,
        "wires": [
            [
                "427c8a1a563502c8"
            ]
        ]
    },
    {
        "id": "427c8a1a563502c8",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "link out 2",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 2045,
        "y": 460,
        "wires": []
    },
    {
        "id": "ca4cd4b46c05bb1d",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Henter fakturaer fra WorkLet ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1890,
        "y": 240,
        "wires": [
            [
                "5b599232bb01d1d2"
            ]
        ]
    },
    {
        "id": "5b599232bb01d1d2",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "link out 1",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 1985,
        "y": 240,
        "wires": []
    },
    {
        "id": "19bdc53204115899",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Bearbejder data ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1930,
        "y": 700,
        "wires": [
            [
                "75f1aaf5a21e12a8"
            ]
        ]
    },
    {
        "id": "75f1aaf5a21e12a8",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "link out 3",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 2025,
        "y": 700,
        "wires": []
    },
    {
        "id": "dc943787affd67f4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Beregner tilskud ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1890,
        "y": 1300,
        "wires": [
            [
                "5ee0ef61ccdcafac"
            ]
        ]
    },
    {
        "id": "5ee0ef61ccdcafac",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "link out 4",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 1985,
        "y": 1300,
        "wires": []
    },
    {
        "id": "ac2d9ca641a094e8",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Færdiggører ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1710,
        "y": 1620,
        "wires": [
            [
                "f1884a7421b13391"
            ]
        ]
    },
    {
        "id": "f1884a7421b13391",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "link out 5",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 1805,
        "y": 1620,
        "wires": []
    },
    {
        "id": "bfc8cafe83059f1f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "d": true,
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "title",
                "pt": "msg",
                "to": "Systemfejl",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "alert",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "msg",
                "pt": "msg",
                "to": "error.message & \" at \" & error.source.type & \" (name: \" & error.source.name & \", id: \" & error.source.id & \")\"",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1720,
        "y": 20,
        "wires": [
            []
        ]
    },
    {
        "id": "c7424ba7f15131f6",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Henter persondata fra KP ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1890,
        "y": 120,
        "wires": [
            [
                "3cde6b50323a51ef"
            ]
        ]
    },
    {
        "id": "ce2b8af41ddd37a2",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t\"message\": message, \"type\": \"update\"    \t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1950,
        "y": 80,
        "wires": [
            [
                "3cde6b50323a51ef"
            ]
        ]
    },
    {
        "id": "d8fce4eadecd4493",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t\"message\": message, \"type\": \"update\"    \t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1930,
        "y": 180,
        "wires": [
            [
                "87437eca4cc7eec9"
            ]
        ]
    },
    {
        "id": "978e5ad5accb9ada",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "debug 31",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1850,
        "y": 1220,
        "wires": []
    },
    {
        "id": "6f70a9263a101b22",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "citizens",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 170,
        "y": 900,
        "wires": [
            [
                "4629d4bebfd2768f"
            ],
            [
                "f462cfb8de682697"
            ]
        ]
    },
    {
        "id": "f462cfb8de682697",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.isRunning",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "currentRun.allReceiptsProcessed",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := $$.currentRun.startDate;\t$endDate := $$.currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t    \"allReceiptsProcessed\": true, \"isFinalized\": false\t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 145,
        "y": 940,
        "wires": [
            [
                "42e8d0e6b5e55314"
            ]
        ],
        "l": false
    },
    {
        "id": "42e8d0e6b5e55314",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "START response out",
        "mode": "link",
        "links": [
            "5c74b689e0aee38b"
        ],
        "x": 195,
        "y": 940,
        "wires": []
    },
    {
        "id": "30f14b6f815a98ef",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "\"Henter persondata fra KP ... \" & percentage & \"%\"",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1370,
        "y": 780,
        "wires": [
            [
                "181615f06b564d1e"
            ]
        ]
    },
    {
        "id": "181615f06b564d1e",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "link out 6",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 1475,
        "y": 780,
        "wires": []
    },
    {
        "id": "70a379ce2563656b",
        "type": "function",
        "z": "8ea344595d9a442a",
        "name": "Calc %",
        "func": "var percentage = msg.pupid / msg.totalCount * 100;\npercentage = parseInt(percentage);\n\nmsg.percentage = percentage;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1220,
        "y": 780,
        "wires": [
            [
                "30f14b6f815a98ef"
            ]
        ]
    },
    {
        "id": "6e042d4222a1a115",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Tjek om fakturaliste er tom",
        "info": "",
        "x": 170,
        "y": 860,
        "wires": []
    },
    {
        "id": "bc99d7022f61a990",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Set selectors",
        "rules": [
            {
                "t": "set",
                "p": "selectors.kp",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.kp.url",
                "pt": "msg",
                "to": "https://fagsystem.kommunernespensionssystem.dk/",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.login",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.kp.login.select",
                "pt": "msg",
                "to": "[id=\"SelectedAuthenticationUrl\"]",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.login.button",
                "pt": "msg",
                "to": ".button",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.inputCPR",
                "pt": "msg",
                "to": "#search_box input",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.inputCPR_soegknap",
                "pt": "msg",
                "to": "#search_box button",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.personligtillaegsprocent",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(5) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.helbredstillaegsprocent_aabn",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(6) > td:nth-child(3) > div > div > span > span",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.helbredstillaegsprocent",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(6) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.danmarkgruppe",
                "pt": "msg",
                "to": "#person-oplysninger > tbody > tr:nth-child(6) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.personligtillaegsprocent_aabn",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(5) > td:nth-child(3) > div > div > span > span",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.tillaegsprocent",
                "pt": "msg",
                "to": "#history_table",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.tillaegsprocent_luk",
                "pt": "msg",
                "to": "#person-pension-fakta div.sc-gPEVay.ceKhsN > div.sc-jlyJG.NUpYs > svg",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.formue",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(4) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.sager",
                "pt": "msg",
                "to": "#person_overblik_sager_table",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.lukborger",
                "pt": "msg",
                "to": "svg.svg-inline--fa.fa-times.fa-w-11.fa-1x",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.bevilling",
                "pt": "msg",
                "to": "#app div.tab-content div.tab-content > div > div > div:nth-child(1) > div",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 470,
        "y": 720,
        "wires": [
            [
                "c2df29c07624e5e0"
            ]
        ]
    },
    {
        "id": "d183f106c2e11bce",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "citizens",
                "pt": "msg",
                "to": "$distinct(receipts@$A.(\t[\t    {\t        \"cpr\": $A.patientCPR\t    }\t]))",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 440,
        "y": 680,
        "wires": [
            [
                "bc99d7022f61a990"
            ]
        ]
    },
    {
        "id": "c2df29c07624e5e0",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Set pup commands",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "[\t    {\t        \"action\": \"launch\",\t        \"parameters\":\t        {\t            \"headless\": true,\t            \"slowMo\": 30,\t            \"ignoreHTTPSErrors\": true,\t            \"defaultViewport\": null\t        }\t    },\t   {\t       \"action\": \"goto\",\t       \"url\": \"https://fagsystem.kommunernespensionssystem.dk/\"\t\t},\t   {\t       \"action\": \"select\",\t       \"path\": \"[id=\\\"SelectedAuthenticationUrl\\\"]\",\t       \"input\": \"Randers Kommune\"\t\t},\t   {\t       \"action\": \"click\",\t       \"path\": \".button\"\t\t},\t\t{\t\t\t\"action\": \"get\",\t\t\t\"name\": \"navn\",\t\t\t\"path\": \"div[class=\\\"sc-iwsKbI sc-gqjmRU yImXU\\\"]\"\t\t}\t]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$append(payload, citizens@$A.(\t    [\t        {\t           \"action\": \"type\",\t           \"input\": $A.cpr,\t           \"path\": selectors.kp.inputCPR\t\t        },\t        {\t           \"action\": \"click\",\t           \"path\": selectors.kp.inputCPR_soegknap\t\t        },\t        {\t            \"action\": \"geturl\",\t            \"name\": \"kpurl\",\t            \"obj\": $A.cpr\t        },\t        {\t            \"action\": \"clickifexists\",\t            \"path\": 'div[class=\"sc-jKVCRD CUfQJ\"]'\t        },\t        {\t           \"action\": \"click\",\t           \"path\": selectors.kp.citizen.personligtillaegsprocent_aabn\t\t        },\t        {\t           \"action\": \"get\",\t           \"name\": \"personligtillaegsprocent\",\t           \"path\": selectors.kp.citizen.tillaegsprocent,\t           \"obj\": $A.cpr\t\t        },\t        {\t           \"action\": \"click\",\t           \"path\": selectors.kp.citizen.tillaegsprocent_luk\t\t        },\t        {\t            \"action\": \"click\",\t            \"path\": selectors.kp.citizen.helbredstillaegsprocent_aabn\t\t        },\t        {\t            \"action\": \"get\",\t            \"name\": \"helbredstillaegsprocent\",\t            \"path\": selectors.kp.citizen.tillaegsprocent,\t            \"obj\": $A.cpr\t\t        },\t        {\t            \"action\": \"click\",\t            \"path\": selectors.kp.citizen.tillaegsprocent_luk\t\t        },\t        {\t            \"action\": \"get\",\t            \"name\": \"bevilling\",\t            \"path\": selectors.kp.citizen.bevilling,\t            \"obj\": $A.cpr\t\t        },\t        {\t           \"action\": \"get\",\t           \"name\": \"sager\",\t           \"path\": selectors.kp.citizen.sager,\t           \"obj\": $A.cpr\t\t        },\t        {\t           \"action\": \"get\",\t           \"name\": \"danmarkgruppe\",\t           \"path\": selectors.kp.citizen.danmarkgruppe,\t           \"obj\": $A.cpr\t\t        },\t        {\t           \"action\": \"get\",\t           \"name\": \"formue\",\t           \"path\": selectors.kp.citizen.formue,\t           \"obj\": $A.cpr\t\t        },\t        {\t            \"action\": \"click\",\t            \"path\": selectors.kp.citizen.lukborger\t        }\t    ]\t))",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$append(payload,\t{\t    \"action\": \"close\"\t}\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 690,
        "y": 680,
        "wires": [
            [
                "c8857f0a61f8c92e"
            ]
        ]
    },
    {
        "id": "c8857f0a61f8c92e",
        "type": "subflow:41d1b8798efe7e15",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "",
        "x": 1000,
        "y": 680,
        "wires": [
            [
                "70ade91971d73d3b"
            ],
            [
                "70a379ce2563656b"
            ]
        ]
    },
    {
        "id": "0df1e3c807393a69",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Klargør læsning af persondata fra KP",
        "info": "",
        "x": 750,
        "y": 640,
        "wires": []
    },
    {
        "id": "573bc9a19cb2a144",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Læs CPR fra faktura",
        "info": "",
        "x": 450,
        "y": 640,
        "wires": []
    },
    {
        "id": "70ade91971d73d3b",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "pupOutputs.navn",
                "pt": "msg",
                "to": "brugernavn",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "citizens",
                "pt": "msg",
                "to": "pupOutputs",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1260,
        "y": 680,
        "wires": [
            [
                "81a00971b2ea464e",
                "172fe34eeccca8dd"
            ]
        ]
    },
    {
        "id": "81a00971b2ea464e",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Borgerliste debug",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "citizens",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1350,
        "y": 720,
        "wires": []
    },
    {
        "id": "3691fee0bd5cd7bc",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Læs persondata",
        "info": "",
        "x": 1000,
        "y": 640,
        "wires": []
    },
    {
        "id": "5c03893a530479bb",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Gem data i midlertidig hukommelse",
        "info": "",
        "x": 1320,
        "y": 640,
        "wires": []
    },
    {
        "id": "f7835ac1742b0168",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "[E] Læs relevant persondata fra KP vedr. de pågældende borgere",
        "info": "",
        "x": 590,
        "y": 580,
        "wires": []
    },
    {
        "id": "7e0e36d833794733",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "link out 7",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 2265,
        "y": 400,
        "wires": []
    },
    {
        "id": "2359edd9babea1ac",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.isRunning",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "currentRun.allReceiptsProcessed",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := $$.currentRun.startDate;\t$endDate := $$.currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t    \"allReceiptsProcessed\": true, \"isFinalized\": false\t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2055,
        "y": 360,
        "wires": [
            [
                "08f36899ebeff27b"
            ]
        ],
        "l": false
    },
    {
        "id": "08f36899ebeff27b",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "START response out",
        "mode": "link",
        "links": [
            "5c74b689e0aee38b"
        ],
        "x": 2135,
        "y": 360,
        "wires": []
    },
    {
        "id": "cb1b489418bfa2d8",
        "type": "delay",
        "z": "8ea344595d9a442a",
        "name": "",
        "pauseType": "delay",
        "timeout": "4",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 1960,
        "y": 400,
        "wires": [
            [
                "0af59de1688c9df4"
            ]
        ]
    },
    {
        "id": "0af59de1688c9df4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Loginoplysninger er muligvis forkerte, ellers fungerer WorkLet webinterface ikke som det skal.",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "alert",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "title",
                "pt": "msg",
                "to": "Fejl ved hentning af WorkLet fakturaer",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 2130,
        "y": 400,
        "wires": [
            [
                "7e0e36d833794733"
            ]
        ]
    },
    {
        "id": "248d64bf4e74f440",
        "type": "http in",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "url": "/worklet",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 100,
        "wires": [
            [
                "fc57c59e7b1b413d"
            ]
        ]
    },
    {
        "id": "a404b305e8f838e6",
        "type": "http in",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "url": "/:page",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 140,
        "wires": [
            [
                "4070528fbaa047ab"
            ]
        ]
    },
    {
        "id": "1d9fe0413cbb430d",
        "type": "http in",
        "z": "c28a486ea3e09387",
        "g": "0772648cf2b898d4",
        "name": "",
        "url": "/worklet/http",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 560,
        "wires": [
            [
                "8d172c16f57e9a2b"
            ]
        ]
    },
    {
        "id": "6e25160476593670",
        "type": "switch",
        "z": "c28a486ea3e09387",
        "g": "0772648cf2b898d4",
        "name": "",
        "property": "payload.requestType",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "getPageContent",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "acceptPage",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "startRun",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "archive",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "finalize",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 5,
        "x": 250,
        "y": 720,
        "wires": [
            [
                "59e078cd4489c0aa"
            ],
            [
                "415336a4f07090e6"
            ],
            [
                "40c9a409b68d13f1"
            ],
            [
                "6226138fabf9a3b8"
            ],
            [
                "f202f5cad72d049b"
            ]
        ]
    },
    {
        "id": "f6100bedf21eaf46",
        "type": "http response",
        "z": "c28a486ea3e09387",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1970,
        "y": 760,
        "wires": []
    },
    {
        "id": "fc57c59e7b1b413d",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 100,
        "wires": [
            [
                "269002ef959b2b77"
            ]
        ]
    },
    {
        "id": "4070528fbaa047ab",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "req.params.page",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 140,
        "wires": [
            [
                "269002ef959b2b77"
            ]
        ]
    },
    {
        "id": "59e078cd4489c0aa",
        "type": "subflow:43652557380ac3f3",
        "z": "c28a486ea3e09387",
        "g": "dff24743df339ae5",
        "name": "",
        "x": 650,
        "y": 360,
        "wires": [
            [
                "62bdefaa23262980"
            ]
        ]
    },
    {
        "id": "edf7c7526a420888",
        "type": "debug",
        "z": "c28a486ea3e09387",
        "name": "POST OUTPUT",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1980,
        "y": 620,
        "wires": []
    },
    {
        "id": "62bdefaa23262980",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "dff24743df339ae5",
        "name": "Set response",
        "rules": [
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "{ \"url\": payload.page }",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.page.html",
                "pt": "msg",
                "to": "payload.bodyHTML",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.page.title",
                "pt": "msg",
                "to": "payload.pageTitle",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 360,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "abb73011a817205a",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set response",
        "rules": [
            {
                "t": "delete",
                "p": "payload.workletUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.workletPass",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 500,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "92fc21540237b9c7",
        "type": "switch",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "property": "payload.pageToAccept",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "login",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "rules",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "grants",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 670,
        "y": 580,
        "wires": [
            [
                "c6d6dc5b8ef2878b"
            ],
            [
                "801ba8048f457e32"
            ],
            [
                "118d9842141d09ca"
            ]
        ]
    },
    {
        "id": "e76b0758dc45914d",
        "type": "debug",
        "z": "c28a486ea3e09387",
        "g": "0772648cf2b898d4",
        "name": "POST INPUT",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 160,
        "y": 640,
        "wires": []
    },
    {
        "id": "b0adba24e19779d2",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "dff24743df339ae5",
        "name": "GetPageContent",
        "info": "",
        "x": 640,
        "y": 320,
        "wires": []
    },
    {
        "id": "984b68b697eb68be",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "AcceptPage",
        "info": "",
        "x": 630,
        "y": 480,
        "wires": []
    },
    {
        "id": "55d1d622afec35e2",
        "type": "http response",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1610,
        "y": 160,
        "wires": []
    },
    {
        "id": "98d7ea7aa5c93ad4",
        "type": "template",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "CSS",
        "field": "css",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "@import url(\"https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css\"); /* Bootstrap */\n@import url(\"https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/sandstone/bootstrap.min.css\"); /* Bootswatch template */\n@font-face {\n  font-family: 'password';\n  font-style: normal;\n  font-weight: 400;\n  src: url(https://jsbin-user-assets.s3.amazonaws.com/rafaelcastrocouto/password.ttf);\n}\n\na:hover\n{\n    cursor: pointer;\n}\n\n/* Changes to Boostrap CSS */\n.bg-primary {\n    background-color: #325d88!important;\n}\n.border-light\n{\n    border-color: lightgray!important;\n}\n.tab-content\n{\n    border: 1px solid lightgray;\n    border-bottom-left-radius: 5px;\n    border-bottom-right-radius: 5px;\n    border-top-right-radius: 5px;\n}\n.nav-link \n{\n    padding-left: 20px;\n    padding-right: 20px;\n}\n.row\n{\n    display: flex;\n    justify-content: stretch;\n}\n    .row > *\n    {\n        flex-grow: 1;\n    }\n.d-flex.justify-stretch\n{\n    justify-content: stretch;\n}\n.d-flex.justify-stretch > *{\n    flex-grow: 1;\n}\n.page-item.archived .page-link {\n    background-color: #E9F3DB!important;\n}\n.page-item.archived.active .page-link {\n    background-color: #D8E1CB!important;\n}\n\n\nbody\n{\n    background-color: whitesmoke;\n}\n\n\n\n/* Randers design */ \n.randers-logo {\n    background-image: url('https://www.randers.dk/static/logo.svg');\n    background-position: 5px 5px;\n    background-size: 85%;\n    background-repeat: no-repeat;\n    width: 200px;\n    height: 50px;\n}\n\n\n/* Custom style classes */\n.nav-success \n{\n    color: #71b355!important;\n}\n.nav-success:hover\n{\n    color: #a6d151!important;\n}\n.nav-success.active\n{\n    color: #a6d151!important;\n}\n.uppercase\n{\n    text-transform: uppercase;\n}\n.fs-10\n{\n    font-size: 10px;\n}\n.fs-11\n{\n    font-size: 11px;\n}\n.fs-12\n{\n    font-size: 12px;\n}\n.fs-13\n{\n    font-size: 13px;\n}\n.fs-lg\n{\n    font-size: 24px;\n}\n.fw-500\n{\n    font-weight: 500;\n}\n.border-none, .border-none *\n{\n    border: 0px!important;\n}\n.hidden\n{\n    display: none;\n}\n.no-border-bottom\n{\n    border-bottom: 0px!important;\n}\n.no-border-bottom *\n{\n    border-bottom: 0px!important;\n}\n\n/* Custom elements */\n.progress-container\n{\n    background-color: lightgray;\n    padding: 15px 25px;\n}\n.progress-container.collapsed\n{\n    max-height: 0px;\n    overflow: hidden;\n    padding: 0px;\n}\n/*\n.site-container\n{\n}\n*/\n.card-container\n{\n    display: flex;\n    justify-content: stretch;\n    gap: 10px;\n}\n    .card-container .card\n    {\n        flex: 1;\n    }\n.receipt-inner\n{\n    display: flex;\n    gap: 10px;\n    min-height: 40vh;\n}\n    .receipt-inner > *\n    {\n        flex-grow: 1;\n    }\n    .receipt-inner > .citizen-info\n    {\n        max-width: 25rem;\n    }\n.pagination-container\n{\n    display: flex;\n    justify-content: center;\n    gap: 10px;\n}\n    .pagination-container > button\n    {\n        height: 38px;\n    }\n.table-header\n{\n    font-size: 10px;\n    text-transform: uppercase;\n    font-weight: 500;\n}\n.card.header-left\n{\n    margin-left: 20px;display:flex;flex-direction:row;\n}\n.card-header.header-left\n{\n    border-top-right-radius: 0px!important;\n    border-bottom: 0px;\n}",
        "output": "str",
        "x": 1130,
        "y": 100,
        "wires": [
            [
                "29426a6eb03efe81"
            ]
        ]
    },
    {
        "id": "ac7bdd1609da7c77",
        "type": "template",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "JS",
        "field": "js",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//\n/// INITIALIZE\n//\n\nvar rules = {{{payload.rulesStr}}};\n\n//\n/// SET PAGE CONTENT FUNCTION\n//\n\nvar activePage = \"{{payload.webSettings.state.activePage}}\";\n\nfunction goToPage(page)\n{\n    var pageName = \"\";\n    var paramName = \"\";\n    var paramValue = \"\";\n    // Works with 1 param only \n\n    if(page.includes(\"?\"))\n    {\n        var split = page.split(\"?\");\n        pageName = split[0];\n\n        split = split[1].split(\"=\");\n        paramName = split[0];\n        paramValue = split[1];\n    }\n\n    var obj = {};\n\n    if(pageName == \"\")\n        obj = {\"requestType\": \"getPageContent\", \"page\": page};\n\n    else\n    {\n        obj = { \"requestType\": \"getPageContent\", \"page\": pageName };\n        obj[paramName] = paramValue;\n    }\n\n    postRequest(obj);\n}\n\nfunction setPageContent(pageObj, setHistory = true)\n{\n    setInnerHTML(\"fullPage\", pageObj.html);\n    document.title = \"AutoWorkLet - \" + pageObj.title;\n\n    if(setHistory)\n        window.history.pushState({ \"page\": pageObj }, \"\", \"/\" + pageObj.url);\n\n    activePage = pageObj.url;\n\n    //console.log(\"Setting page content using JS\");\n\n    if (loadPageFunc[pageObj.url] != null)\n        loadPageFunc[pageObj.url]();\n\n}\n\nwindow.onpopstate = function (e)\n{\n    if (e.state)\n        setPageContent(e.state.page, false);\n};\n\n\n\n//\n/// NODE-RED INTEGRATION / COMMUNICATION\n//\n\nfunction toJSON(...vars)\n{\n    var obj = {};\n\n    for (let i = 0; i < vars.length; i++)\n        obj[vars[i].id] = vars[i].value;\n\n    return obj;\n}\n\nfunction postRequest(object)\n{\n    //console.log(\"HTTP request: \" + object);\n    fetch('/worklet/http', {\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(object)\n    })\n        .then(response => response.json())\n        .then(response => handlePostResponse(response));\n        //.then(response => console.log(JSON.stringify(response)));\n}\n\n\nfunction handlePostResponse(responseObject)\n{\n    // Call function depending on request type\n\n    if (handleResponseDynamically[responseObject.requestType] != null)\n        handleResponseDynamically[responseObject.requestType](responseObject);\n        \n    return responseObject;\n}\n\nvar handleResponseDynamically = [];\n\n// Dynamic response handling\n\nhandleResponseDynamically['getPageContent'] = function(response)\n{\n    if(response.page != null)\n        setPageContent(response.page);\n}\n\nhandleResponseDynamically['acceptPage'] = function (response)\n{\n    if(activePage == \"rules\")\n        rules = response.rules;\n\n    reloadPage();\n}\n\nhandleResponseDynamically['startRun'] = function (response)\n{\n    //console.log(\"RESPONSE FROM STARTRUN\");\n    goToPage(\"start\");\n}\n\nhandleResponseDynamically['archive'] = function (response)\n{\n    //goToPage(response.page + \"?spec=\"+response.spec);\n    reloadPage();\n}\n\nhandleResponseDynamically['finalize'] = function (response)\n{\n    goToPage(\"finalized\");\n}\n\n\n//\n/// GENERIC FUNCTIONS\n//\n\nfunction setInnerHTML(objectId, content) {\n    var container = document.getElementById(objectId);\n    container.innerHTML = content;\n}\n\nfunction setStyle(objectId, styleVar, styleValue) {\n    var object = document.getElementById(objectId);\n    object.style[styleVar] = styleValue;\n}\n\nfunction toggleHide(objectId)\n{\n    var object = document.getElementById(objectId);\n    object.classList.toggle(\"hidden\");\n}\nfunction hide(objectId) {\n    var object = document.getElementById(objectId);\n    if(!object.classList.contains(\"hidden\"))\n        object.classList.add(\"hidden\");\n}\nfunction reloadPage()\n{\n    goToPage(activePage);\n}\nfunction roundNumber(num)\n{\n    return Math.round((num + Number.EPSILON) * 100) / 100;\n}\n\n//\n// PAGE SPECIFIC\n//\nfunction withdrawPageAccept()\n{\n    var pageTitle = \"\";\n    switch(activePage)\n    {\n        case \"login\": pageTitle = \"loginoplysninger\"; break;\n        case \"rules\": pageTitle = \"forretningsregler\"; break;\n        case \"grants\": pageTitle = \"tilskudssatser\"; break;\n    }\n\n    var elements = document.getElementsByClassName(\"form-floating\");\n    for(var i = 0; i<elements.length;i++)\n        elements[i].classList.remove(\"was-validated\");\n\n    var buttonAccept = document.getElementById(\"button_acceptPage\");\n    buttonAccept.classList.add(\"btn-primary\");\n    buttonAccept.classList.remove(\"btn-success\");\n    buttonAccept.innerHTML = \"Godkend \" + pageTitle;\n\n    document.getElementById(\"toAccept\").value = \"true\";\n\n    hide(\"button_acceptPage_goNext\");\n\n    document.getElementById(\"nav_\" + activePage).classList.remove(\"nav-success\");\n}\n\nfunction startRun()\n{\n    /* Visual */\n\n    var startButton = document.getElementById(\"button_startRun\");\n\n    startButton.disabled = true;\n    startButton.innerHTML = `<i class=\"fa-lg fas fa-spinner fa-spin\"></i>`;\n\n    if (document.getElementById(\"nav_run\") !== null)\n        document.getElementById(\"nav_run\").innerHTML = `Robotten kører<i class=\"fa-lg fas fa-spinner fa-spin\" style=\"margin-left: 10px\"></i>`;\n\n    /* Node-red */\n    postRequest({\"requestType\": \"startRun\"});\n\n}\n\n\n// RULES\n\nfunction appendRules(...objects)\n{\n    var list = [];\n\n    for (let i = 0; i < objects.length; i++)\n        if(objects[i] != null)\n            list.push(objects[i]);\n\n    return list;\n}\n\nfunction createRuleObj(ruleVar)\n{\n    let ruleOperator = document.getElementById(\"operator_\" + ruleVar).value;\n    let ruleValue = document.getElementById(\"value_\" + ruleVar).value;\n    let returnObj = {\n        \"id\": ruleVar,\n        \"operator\": ruleOperator,\n        \"value\": ruleValue\n    }\n    //console.log(\"Return OBJ: \" + JSON.stringify(returnObj));\n    return returnObj;\n}\n\nfunction setInputBox(uid, truefalse = false)\n{\n    let operator = document.getElementById(\"operator_\" + uid).value;\n    var html = \"\";\n\n    if (operator == \"!null\" || truefalse)\n        html = `<select class=\"form-select\" id=\"value_` + uid + `\" onchange=\"withdrawPageAccept('rules')\">\n                        <option value=\"true\">Ja</option>\n                        <option value=\"false\">Nej</option>\n                </select>\n                <label for=\"value_`+ uid + `\" style=\"padding-left: 27px\">Værdi</label>`;\n    else\n        html = `<input type=\"text\" class=\"form-control\" id=\"value_` + uid + `\" placeholder=\"0\" style=\"color: black\" onchange=\"withdrawPageAccept('rules')\">\n                <label for=\"value_`+ uid + `\" style=\"padding-left: 27px\">Værdi</label>`;\n\n    setInnerHTML(\"inputContainer_\" + uid, html);\n}\n\n// Grants\n\nfunction createGrantObj(grantId)\n{\n\n    let grantDkk = document.getElementById(\"value_\" + grantId + \"_maxdkk\").value;\n    let grantProcent = document.getElementById(\"value_\" + grantId + \"_procent\").value;\n\n    return {\n        \"id\": grantId,\n        \"tilskud_maxdkk\": grantDkk,\n        \"tilskud_procent\": grantProcent\n    }\n}\n\n\n\n//\n/// LATE START / INITIALIZATION\n//\n\nvar landingPage = \"{{{payload.page}}}\";\n\n\n//\n/// ON PAGE LOAD FUNCTIONS\n//\n\nvar loadPageFunc = [];\n\nloadPageFunc[\"rules\"] = function ()\n{\n    //console.log(\"Running load func\");\n    // LOAD rules - update each rule\n    for (let index = 0; index < rules.length; index++)\n    {\n        const element = rules[index];\n\n        //console.log(\"Attempting to update value for '\" + \"operator_\" + element.uid + \"'\");\n\n        var operatorInput = document.getElementById(\"operator_\" + element.uid);\n        //var valueInput = document.getElementById(\"value_\" + element.uid);\n\n        if (element.operator == \"!null\")\n        {\n            setInputBox(element.uid, true);\n            var valueInput = document.getElementById(\"value_\" + element.uid);\n            valueInput.value = element.value;\n        }\n\n        operatorInput.value = element.operator;\n        //valueInput.value = element.value;\n    }\n}\n\nif (loadPageFunc[landingPage] != null)\n    loadPageFunc[landingPage]();\n\n\n\n//\n/// WEB SOCKET (node-red)\n//\n\nvar ws;\nvar wsUri = \"ws:\";\nvar loc = window.location; //console.log(loc);\n\nif (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n// This needs to point to the web socket in the Node-RED flow\nwsUri += \"//\" + loc.host + \"/ws/worklet\";\n\nfunction wsConnect()\n{\n    //console.log(\"Connecting to \", wsUri);\n    ws = new WebSocket(wsUri);\n    //var line = \"\";    // either uncomment this for a building list of messages\n    ws.onmessage = function (msg)\n    {\n\n        var data = msg.data;\n        const obj = JSON.parse(data);\n        //const obj = data;\n        \n        displayWsMessage(obj);\n        //console.log(\"Received WS message: \" + JSON.stringify(obj));\n        \n    }\n    ws.onopen = function () {\n        // update the status div with the connection status\n        console.log(\"Connected to WS\");\n    }\n    ws.onclose = function () {\n        // update the status div with the connection status\n        console.log(\"WS connection lost\");\n        // in case of lost connection tries to reconnect every 3 secs\n        setTimeout(wsConnect, 3000);\n    }\n}\nfunction PublishWsMessage(m)\n{\n    if (ws) { ws.send(m); }\n}\n\nwsConnect();\n\n\nfunction displayWsMessage(ws)\n{\n    //console.log(\"Displaying ws object: \" + ws);\n    //console.log(\"Displaying ws object (stringify): \" + JSON.stringify(ws));\n\n    if(ws.type == \"alert\")\n    {\n        var obj = document.getElementById(\"alertBox\");\n\n        if (obj == null) {\n            var html = `\n            <div class=\"alert alert-dismissible alert-warning\" id=\"alertBox\">\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\n                <h4 class=\"alert-heading\" id=\"alertBox-heading\">` + ws.title + `</h4>\n                <p class=\"mb-0\" id=\"alertBox-body\">` + ws.msg + `</p>\n            </div>`;\n            document.getElementById(\"alertParent\").innerHTML = html;\n            return;\n        }\n\n        obj.classList.add(\"alert-warning\");\n        obj.classList.remove(\"hidden\");\n\n        document.getElementById(\"alertBox-heading\").innerHTML = ws.title;\n        document.getElementById(\"alertBox-body\").innerHTML = ws.message;\n    }\n\n    else if(ws.type == \"update\")\n    {\n        var obj = document.getElementById(\"statusText\");\n\n        if(obj != null)\n        {\n            obj.classList.remove(\"hidden\");\n            obj.innerHTML = \"Status: \" + ws.message;\n        }\n\n    }\n\n}",
        "output": "str",
        "x": 990,
        "y": 100,
        "wires": [
            [
                "98d7ea7aa5c93ad4"
            ]
        ]
    },
    {
        "id": "ddd0873c9d611a5e",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "HTML",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload.pageHTML",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1370,
        "y": 160,
        "wires": [
            [
                "55d1d622afec35e2"
            ]
        ]
    },
    {
        "id": "29426a6eb03efe81",
        "type": "subflow:43652557380ac3f3",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "x": 1130,
        "y": 160,
        "wires": [
            [
                "ddd0873c9d611a5e"
            ]
        ]
    },
    {
        "id": "a71320aa58eef18a",
        "type": "subflow:db94b4c117de2f6a",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "x": 770,
        "y": 100,
        "wires": [
            [
                "ac7bdd1609da7c77"
            ]
        ]
    },
    {
        "id": "e08bf0d9ec73f87e",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "UpdateRules",
        "info": "",
        "x": 930,
        "y": 680,
        "wires": []
    },
    {
        "id": "77e8a8e7f5259bfb",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Merge changes",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "$.payload.rules ~> | $ |\t(\t\t\t$ruleChange := $$.ruleUpdates[id = uid];\t/*$lookup($$.ruleChanges, uid);*/\t\t$uid := uid;\t$ruleUpdate :=  $$.payload.ruleUpdates[id = $uid];\t\t{        \t        \"operator\": $ruleUpdate.operator,\t        \"value\": $ruleUpdate.value\t})\t\t|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "payload.rules @$r .(\t\t$getType := function($value, $operator)\t{\t    ($value[$ ~> /^[0-9\\.]{1,}$/m] ~> $boolean) ?\t        \"number\" :\t    ($operator = \"!null\") ? \t        \"bool\"\t};\t\t{\t    \t    \"uid\": $r.uid,\t    \"name\": $r.name,\t    \"variable\": $r.variable,\t    \"operator\": $r.operator,\t    \"value\": $r.value,\t    \"type\": $getType($r.value, $r.operator),\t    \"description\": $r.description\t    \t}\t)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "$.payload.rules ~> | $ |\t{\t    \"value\": \t        type = \"number\" ?\t            value ~> $number() \t            :\t        type = \"bool\" ?\t            (value = \"true\") or (value = true) ? true : false\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1120,
        "y": 700,
        "wires": [
            [
                "1c365f175b48167a"
            ]
        ]
    },
    {
        "id": "1c365f175b48167a",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::rules",
                "pt": "global",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1340,
        "y": 700,
        "wires": [
            [
                "53dbe0297b8bd16d"
            ]
        ]
    },
    {
        "id": "53dbe0297b8bd16d",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set response",
        "rules": [
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "payload.pageToAccept",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload.ruleChanges",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.toAccept",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.pageToAccept",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 640,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "8d172c16f57e9a2b",
        "type": "subflow:db94b4c117de2f6a",
        "z": "c28a486ea3e09387",
        "g": "0772648cf2b898d4",
        "name": "",
        "x": 170,
        "y": 600,
        "wires": [
            [
                "6e25160476593670",
                "e76b0758dc45914d"
            ]
        ]
    },
    {
        "id": "c6d6dc5b8ef2878b",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set login to accepted",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.acceptances.login",
                "pt": "global",
                "to": "payload.toAccept",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.login",
                "pt": "msg",
                "to": "payload.toAccept",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "webData.workletCreds.workletUser",
                "pt": "global",
                "to": "payload.workletUser",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "webData.workletCreds.workletPass",
                "pt": "global",
                "to": "payload.workletPass",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "delete",
                "p": "payload.workletUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.workletPass",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 880,
        "y": 500,
        "wires": [
            [
                "abb73011a817205a"
            ]
        ]
    },
    {
        "id": "801ba8048f457e32",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set rules to accepted",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.acceptances.rules",
                "pt": "global",
                "to": "payload.toAccept",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.rules",
                "pt": "msg",
                "to": "payload.toAccept",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 880,
        "y": 600,
        "wires": [
            [
                "ec82ecfe41364ced"
            ]
        ]
    },
    {
        "id": "ec82ecfe41364ced",
        "type": "switch",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "property": "payload.toAccept",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 930,
        "y": 640,
        "wires": [
            [
                "53dbe0297b8bd16d"
            ],
            [
                "77e8a8e7f5259bfb"
            ]
        ]
    },
    {
        "id": "d4cb17c655b74747",
        "type": "change",
        "z": "c28a486ea3e09387",
        "name": "Clean response object",
        "rules": [
            {
                "t": "delete",
                "p": "payload.pageContent",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.webSettingsStr",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.pageHTML",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.pageTitle",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.pageElements",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1980,
        "y": 720,
        "wires": [
            [
                "f6100bedf21eaf46",
                "edf7c7526a420888"
            ]
        ]
    },
    {
        "id": "415336a4f07090e6",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.toAccept",
                "pt": "msg",
                "to": "(payload.toAccept = \"true\") or (payload.toAccept= true) ? true : false",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 590,
        "y": 520,
        "wires": [
            [
                "92fc21540237b9c7"
            ]
        ]
    },
    {
        "id": "69ef811ebe7083c9",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "UpdateGrants",
        "info": "",
        "x": 930,
        "y": 860,
        "wires": []
    },
    {
        "id": "492252a377f8d60d",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Merge changes",
        "rules": [
            {
                "t": "set",
                "p": "payload.grants.tilskudsperioder.satser",
                "pt": "msg",
                "to": "$.payload.grants.tilskudsperioder.satser ~> | $ |\t(\t\t$uid := id;\t{        \t    \"tilskud_maxdkk\": $$.payload.grantUpdates[$uid].tilskud_maxdkk ~>$number(),\t    \"tilskud_procent\": $$.payload.grantUpdates[$uid].tilskud_procent ~>$number()\t})\t\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1120,
        "y": 880,
        "wires": [
            [
                "d046f8cb32a0960c"
            ]
        ]
    },
    {
        "id": "d046f8cb32a0960c",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::grants",
                "pt": "global",
                "to": "payload.grants",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1340,
        "y": 880,
        "wires": [
            [
                "6154c5e7bbc8bc1a"
            ]
        ]
    },
    {
        "id": "6154c5e7bbc8bc1a",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set response",
        "rules": [
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "payload.pageToAccept",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload.grantChanges",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.toAccept",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.pageToAccept",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 820,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "118d9842141d09ca",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set grants to accepted",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.acceptances.grants",
                "pt": "global",
                "to": "payload.toAccept",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.grants",
                "pt": "msg",
                "to": "payload.toAccept",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 880,
        "y": 780,
        "wires": [
            [
                "f6abba6df8ed7611"
            ]
        ]
    },
    {
        "id": "f6abba6df8ed7611",
        "type": "switch",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "property": "payload.toAccept",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 930,
        "y": 820,
        "wires": [
            [
                "6154c5e7bbc8bc1a"
            ],
            [
                "492252a377f8d60d"
            ]
        ]
    },
    {
        "id": "4c1121ef6377b795",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Grants",
        "info": "",
        "x": 830,
        "y": 740,
        "wires": []
    },
    {
        "id": "6ebfb594e20f3f75",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Rules",
        "info": "",
        "x": 830,
        "y": 560,
        "wires": []
    },
    {
        "id": "412dc2399a0183b9",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Login",
        "info": "",
        "x": 830,
        "y": 460,
        "wires": []
    },
    {
        "id": "e33624721d9829f0",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "StartRun",
        "info": "",
        "x": 580,
        "y": 980,
        "wires": []
    },
    {
        "id": "40c9a409b68d13f1",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "Set isRunning = true",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings.state.isRunning",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.isRunning",
                "pt": "global",
                "to": "payload.webSettings.state.isRunning",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 620,
        "y": 1020,
        "wires": [
            [
                "e53f459d609aac22"
            ]
        ]
    },
    {
        "id": "164122de385f07b8",
        "type": "change",
        "z": "c28a486ea3e09387",
        "d": true,
        "g": "0e177132df886f4e",
        "name": "Set response",
        "rules": [
            {
                "t": "delete",
                "p": "tempPayload",
                "pt": "flow"
            },
            {
                "t": "delete",
                "p": "tempErrors",
                "pt": "flow"
            },
            {
                "t": "delete",
                "p": "tempPayload",
                "pt": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1430,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "5c74b689e0aee38b",
        "type": "link in",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "START response in",
        "links": [
            "f5dbef72792b9011",
            "42e8d0e6b5e55314",
            "08f36899ebeff27b"
        ],
        "x": 1025,
        "y": 1060,
        "wires": [
            [
                "0a97b8da0c9ceff9"
            ]
        ]
    },
    {
        "id": "30b5b930fae41995",
        "type": "link out",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "Link to START",
        "mode": "link",
        "links": [
            "603f9dfeda911a10"
        ],
        "x": 895,
        "y": 1060,
        "wires": []
    },
    {
        "id": "e53f459d609aac22",
        "type": "function",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "Set flow temp MSG object",
        "func": "flow.set(\"tempMsg\", msg);\nflow.set(\"tempPayload\", msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 1060,
        "wires": [
            [
                "30b5b930fae41995"
            ]
        ]
    },
    {
        "id": "408b2b0cf0a40d41",
        "type": "function",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "Get flow temp MSG object",
        "func": "msg = flow.get(\"tempMsg\");\nmsg.payload = flow.get(\"tempPayload\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1370,
        "y": 1060,
        "wires": [
            [
                "164122de385f07b8",
                "ea3be6d83c70d734"
            ]
        ]
    },
    {
        "id": "0a97b8da0c9ceff9",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "set receipts and isRunning",
        "rules": [
            {
                "t": "set",
                "p": "webData.citizens-actions",
                "pt": "global",
                "to": "payload",
                "tot": "jsonata",
                "dc": true
            },
            {
                "t": "set",
                "p": "webData.citizens-noactions",
                "pt": "global",
                "to": "errors",
                "tot": "jsonata",
                "dc": true
            },
            {
                "t": "delete",
                "p": "errors",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.isRunning",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "webSettings.state.isBeingProcessed",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1240,
        "y": 1020,
        "wires": [
            [
                "408b2b0cf0a40d41"
            ]
        ]
    },
    {
        "id": "ea3be6d83c70d734",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.receiptsAwaiting",
                "pt": "global",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "payload.webSettings",
                "pt": "msg",
                "to": "#:(storeInFile)::webSettings",
                "tot": "global",
                "dc": true
            },
            {
                "t": "delete",
                "p": "tempMsg",
                "pt": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1535,
        "y": 1060,
        "wires": [
            [
                "97801c386c197805"
            ]
        ],
        "l": false
    },
    {
        "id": "f8bf41fc7dd480f1",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "Archive receipt",
        "info": "",
        "x": 600,
        "y": 1200,
        "wires": []
    },
    {
        "id": "c888f934919b1eb8",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "set as archived",
        "rules": [
            {
                "t": "set",
                "p": "webData.citizens-noactions[msg.payload.id].archived",
                "pt": "global",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1240,
        "wires": [
            [
                "d84057a8cb05b22f"
            ]
        ]
    },
    {
        "id": "d84057a8cb05b22f",
        "type": "link out",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "Archive receipt link out",
        "mode": "link",
        "links": [
            "230dad52a43f6b19"
        ],
        "x": 895,
        "y": 1240,
        "wires": []
    },
    {
        "id": "0ff5c26114374820",
        "type": "link in",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "Is archived link in",
        "links": [
            "a2f55ae008b1fee2"
        ],
        "x": 1025,
        "y": 1240,
        "wires": [
            [
                "d6432bd8a487caa0",
                "948eb590f69bd85b"
            ]
        ]
    },
    {
        "id": "d6432bd8a487caa0",
        "type": "function",
        "z": "c28a486ea3e09387",
        "d": true,
        "g": "e4e7a254403521e9",
        "name": "Next receipt id?",
        "func": "msg.payload.tempDataLength = msg.tempDataArray.length;\n\nmsg.payload.spec = parseInt(msg.payload.id) >= (msg.tempDataArray.length - 1) ? parseInt(msg.payload.id) : (parseInt(msg.payload.id)+1);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1280,
        "y": 1200,
        "wires": [
            [
                "948eb590f69bd85b"
            ]
        ]
    },
    {
        "id": "948eb590f69bd85b",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "Set response",
        "rules": [
            {
                "t": "delete",
                "p": "payload.tempDataArray",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.tempData",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.tempDataLength",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "payload.webSettings.state.activePage",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1570,
        "y": 1240,
        "wires": [
            [
                "b3ecd3ad79094172"
            ]
        ]
    },
    {
        "id": "54254a91e943fb50",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "set as archived",
        "rules": [
            {
                "t": "set",
                "p": "webData.citizens-actions[msg.payload.id].archived",
                "pt": "global",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1200,
        "wires": [
            [
                "d84057a8cb05b22f"
            ]
        ]
    },
    {
        "id": "6226138fabf9a3b8",
        "type": "switch",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "",
        "property": "payload.webSettings.state.activePage",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "view-receipts",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "view-nograntreceipts",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 570,
        "y": 1240,
        "wires": [
            [
                "54254a91e943fb50"
            ],
            [
                "c888f934919b1eb8"
            ]
        ]
    },
    {
        "id": "cd5218111a9658fb",
        "type": "function",
        "z": "c28a486ea3e09387",
        "name": "Get flow temp MSG object",
        "func": "msg = flow.get(\"tempMsg\");\nmsg.payload = flow.get(\"tempPayload\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1910,
        "y": 1060,
        "wires": [
            []
        ]
    },
    {
        "id": "0edb5029cfe338ce",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "name": "Finalize run",
        "info": "",
        "x": 590,
        "y": 1340,
        "wires": []
    },
    {
        "id": "f202f5cad72d049b",
        "type": "link out",
        "z": "c28a486ea3e09387",
        "name": "Finalize run out",
        "mode": "link",
        "links": [
            "c04211aaccb15e0a"
        ],
        "x": 535,
        "y": 1380,
        "wires": []
    },
    {
        "id": "23a573cb9952c0ef",
        "type": "link in",
        "z": "c28a486ea3e09387",
        "name": "Finalize complete link in",
        "links": [
            "25f140a78f720950"
        ],
        "x": 705,
        "y": 1380,
        "wires": [
            [
                "53d1fb714bf85e85"
            ]
        ]
    },
    {
        "id": "42de3af98b8ce955",
        "type": "http in",
        "z": "46a5586ef7af1095",
        "name": "",
        "url": "/js",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 160,
        "wires": [
            [
                "4ecdb9d3908ce87b"
            ]
        ]
    },
    {
        "id": "809ebd4b83ba8a98",
        "type": "http response",
        "z": "46a5586ef7af1095",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1150,
        "y": 160,
        "wires": []
    },
    {
        "id": "0deb93eb3ab278b1",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html>\n<head>\n    <style>{{{css}}}</style>\n</head>\n<body>\n\n    <div class=\"container\">\n\n        <h1>Post</h1>\n        <p>My first bootstrap post test</p>\n\n        <br /><br />\n\n        <div id=\"responseDiv\"></div>\n\n        <br /><br />\n        <div class=\"form-group\">\n            <label for=\"inputfield\" class=\"form-label mt-4\">Text input</label>\n            <input type=\"text\" class=\"form-control\" id=\"inputfield\" aria-describedby=\"texthelp\" placeholder=\"Enter anything\">\n            <small id=\"textHelp\" class=\"form-text text-muted\">Type anything you can think of</small>\n        </div>\n        <button type=\"submit\" class=\"btn btn-primary\" onclick=\"postRequest(document.getElementById('inputfield').value)\">Submit</button>\n\n    </div>\n\n</body>\n<script>{{{js}}}</script>\n</html>",
        "output": "str",
        "x": 1010,
        "y": 160,
        "wires": [
            [
                "809ebd4b83ba8a98"
            ]
        ]
    },
    {
        "id": "f436be9408463448",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "postdata",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 410,
        "y": 120,
        "wires": [
            [
                "b16d80e9bd2810c9"
            ]
        ]
    },
    {
        "id": "4ecdb9d3908ce87b",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "CSS",
        "field": "css",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "@import url('https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/sandstone/bootstrap.min.css');",
        "output": "str",
        "x": 730,
        "y": 160,
        "wires": [
            [
                "5c3063a86795789a"
            ]
        ]
    },
    {
        "id": "78ca453c89e36b62",
        "type": "http in",
        "z": "46a5586ef7af1095",
        "name": "",
        "url": "/js/post",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 120,
        "wires": [
            [
                "da59dfc69226af2d",
                "f436be9408463448"
            ]
        ]
    },
    {
        "id": "da59dfc69226af2d",
        "type": "debug",
        "z": "46a5586ef7af1095",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload.text",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 380,
        "y": 80,
        "wires": []
    },
    {
        "id": "5c3063a86795789a",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "JS",
        "field": "js",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "function postRequest(text)\n{\n    fetch('/js/post', {\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ \"text\": text })\n    })\n        .then(response => response.json())\n        .then(response => handlePostResponse(response))\n        .then(response => console.log(JSON.stringify(response)));\n}\n\n\nfunction handlePostResponse(responseObject)\n{\n    setInnerHTML(\"responseDiv\", responseObject.text);\n    return responseObject;\n}\n\n\nfunction setInnerHTML(objectName, content) {\n    var container = document.getElementById(objectName);\n    container.innerHTML = content;\n}",
        "output": "str",
        "x": 870,
        "y": 160,
        "wires": [
            [
                "0deb93eb3ab278b1"
            ]
        ]
    },
    {
        "id": "b16d80e9bd2810c9",
        "type": "http response",
        "z": "46a5586ef7af1095",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 610,
        "y": 120,
        "wires": []
    },
    {
        "id": "2282e0713ab105b6",
        "type": "http in",
        "z": "46a5586ef7af1095",
        "name": "",
        "url": "/html",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 280,
        "wires": [
            [
                "bd26b8c29bc95091"
            ]
        ]
    },
    {
        "id": "ec68cbdc8c0561bc",
        "type": "http response",
        "z": "46a5586ef7af1095",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1150,
        "y": 280,
        "wires": []
    },
    {
        "id": "c44c598fefd9fe2d",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html>\n<head>\n    <style>{{{css}}}</style>\n</head>\n<body>\n\n    <div class=\"container\">\n\n        <h1>Post</h1>\n        <p>My first bootstrap post test</p>\n\n        <br /><br />\n\n        <div>{{{postdata}}}</div>\n\n        <br /><br />\n        <form method=\"post\" action=\"/html/post\">\n            <div class=\"form-group\">\n                <label for=\"inputfield\" class=\"form-label mt-4\">Text input</label>\n                <input type=\"text\" class=\"form-control\" name=\"inputField\" id=\"inputfield\" aria-describedby=\"texthelp\" placeholder=\"Enter anything\">\n                <small id=\"textHelp\" class=\"form-text text-muted\">Type anything you can think of</small>\n            </div>\n            <button type=\"submit\" class=\"btn btn-primary\">Submit</button>\n        </form>\n    </div>\n\n</body>\n<script>{{{js}}}</script>\n</html>",
        "output": "str",
        "x": 1010,
        "y": 280,
        "wires": [
            [
                "ec68cbdc8c0561bc"
            ]
        ]
    },
    {
        "id": "13a2ef1e50bd0a26",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "postdata",
                "pt": "msg",
                "to": "payload.inputField",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 410,
        "y": 320,
        "wires": [
            [
                "bd26b8c29bc95091"
            ]
        ]
    },
    {
        "id": "bd26b8c29bc95091",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "CSS",
        "field": "css",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "@import url('https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/sandstone/bootstrap.min.css');",
        "output": "str",
        "x": 730,
        "y": 280,
        "wires": [
            [
                "c44c598fefd9fe2d"
            ]
        ]
    },
    {
        "id": "1d2233855ece37e9",
        "type": "http in",
        "z": "46a5586ef7af1095",
        "name": "",
        "url": "/html/post",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 320,
        "wires": [
            [
                "21070de2348e09f3",
                "13a2ef1e50bd0a26"
            ]
        ]
    },
    {
        "id": "21070de2348e09f3",
        "type": "debug",
        "z": "46a5586ef7af1095",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload.text",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 380,
        "y": 360,
        "wires": []
    },
    {
        "id": "1e8199de114d83a8",
        "type": "comment",
        "z": "46a5586ef7af1095",
        "name": "JS example",
        "info": "",
        "x": 170,
        "y": 80,
        "wires": []
    },
    {
        "id": "aacf002aeefed0be",
        "type": "comment",
        "z": "46a5586ef7af1095",
        "name": "HTML example",
        "info": "",
        "x": 180,
        "y": 240,
        "wires": []
    },
    {
        "id": "0af24f61a615bb39",
        "type": "http in",
        "z": "46a5586ef7af1095",
        "name": "",
        "url": "/ajs",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 820,
        "wires": [
            [
                "40f3f97ef7c2be32"
            ]
        ]
    },
    {
        "id": "c8c124620e0f49cc",
        "type": "http response",
        "z": "46a5586ef7af1095",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1150,
        "y": 820,
        "wires": []
    },
    {
        "id": "997e085d83d42099",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html>\n<head>\n    <style>{{{css}}}</style>\n</head>\n<body>\n\n    <div class=\"container\">\n\n        <h1>Hidden in-memory database</h1>\n        <div id=\"responseDiv\"></div>\n\n        <br /><br />\n        \n        <h2>Get existing variable</h2>\n        <div class=\"form-group\">\n            <label for=\"var\" class=\"form-label mt-4\">Variable name</label>\n            <input type=\"text\" class=\"form-control\" id=\"getvar\" aria-describedby=\"texthelp\" placeholder=\"Variable name\">\n        </div>\n        <button type=\"submit\" class=\"btn btn-primary\" onclick=\"postGetRequest(document.getElementById('getvar').value)\">Submit</button>\n\n        <br /><br />\n        <h2>Set new variable</h2>\n        <div class=\"form-group\">\n            <label for=\"var\" class=\"form-label mt-4\">Variable name</label>\n            <input type=\"text\" class=\"form-control\" id=\"var\" aria-describedby=\"texthelp\" placeholder=\"Variable name\">\n            <label for=\"val\" class=\"form-label mt-4\">Value</label>\n            <input type=\"text\" class=\"form-control\" id=\"val\" aria-describedby=\"texthelp\" placeholder=\"Value\">\n            <small id=\"textHelp\" class=\"form-text text-muted\">Type anything you can think of</small>\n        </div>\n        <button type=\"submit\" class=\"btn btn-primary\" onclick=\"postSetRequest(document.getElementById('var').value, document.getElementById('val').value)\">Submit</button>\n\n    </div>\n\n</body>\n<script>{{{js}}}</script>\n</html>",
        "output": "str",
        "x": 1010,
        "y": 820,
        "wires": [
            [
                "c8c124620e0f49cc"
            ]
        ]
    },
    {
        "id": "40f3f97ef7c2be32",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "CSS",
        "field": "css",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "@import url('https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/sandstone/bootstrap.min.css');",
        "output": "str",
        "x": 430,
        "y": 820,
        "wires": [
            [
                "a2f5b544118ad2c0"
            ]
        ]
    },
    {
        "id": "1dd5501459103eab",
        "type": "http in",
        "z": "46a5586ef7af1095",
        "name": "",
        "url": "/ajs/set",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 680,
        "wires": [
            [
                "33d31599a4a632cb"
            ]
        ]
    },
    {
        "id": "7a9873eb81c90d7d",
        "type": "debug",
        "z": "46a5586ef7af1095",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 440,
        "y": 640,
        "wires": []
    },
    {
        "id": "a2f5b544118ad2c0",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "JS",
        "field": "js",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "function postSetRequest(variable, text)\n{\n    fetch('/ajs/set', {\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ \"variable\": variable, \"value\": text })\n    })\n        .then(response => response.json())\n        .then(response => handlePostResponse(response))\n        .then(response => console.log(JSON.stringify(response)));\n}\n\n/*\ndocument.addEventListener(\"DOMContentLoaded\", function () {\n    postGetRequest(\"placeholder\");\n});\n*/\n\nfunction postGetRequest(variable) {\n    fetch('/ajs/get', {\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n        },\n        body: JSON.stringify({ \"variable\": variable })\n    })\n        .then(response => response.json())\n        .then(response => handlePostResponse(response))\n        .then(response => console.log(JSON.stringify(response)));\n}\n\n\nfunction handlePostResponse(responseObject)\n{\n    setInnerHTML(\"responseDiv\", responseObject.response);\n    return responseObject;\n}\n\n\nfunction setInnerHTML(objectName, content) {\n    content = `<p>` + content + `</p>`;\n    var container = document.getElementById(objectName);\n    container.innerHTML = content;\n}",
        "output": "str",
        "x": 690,
        "y": 820,
        "wires": [
            [
                "997e085d83d42099"
            ]
        ]
    },
    {
        "id": "338e16524a29406e",
        "type": "http response",
        "z": "46a5586ef7af1095",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1150,
        "y": 680,
        "wires": []
    },
    {
        "id": "ba607ddb8cb9c9ed",
        "type": "comment",
        "z": "46a5586ef7af1095",
        "name": "Data stored internally",
        "info": "",
        "x": 200,
        "y": 640,
        "wires": []
    },
    {
        "id": "33d31599a4a632cb",
        "type": "function",
        "z": "46a5586ef7af1095",
        "name": "Set flow var",
        "func": "flow.set(msg.payload.variable, msg.payload.value);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 680,
        "wires": [
            [
                "32d8ba7ed396b23e"
            ]
        ]
    },
    {
        "id": "e61fd36eb5e42628",
        "type": "http in",
        "z": "46a5586ef7af1095",
        "name": "",
        "url": "/ajs/get",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 740,
        "wires": [
            [
                "cc536065bbfc85d0",
                "843194ca33cc07a7"
            ]
        ]
    },
    {
        "id": "63af14d708218f1a",
        "type": "http response",
        "z": "46a5586ef7af1095",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1150,
        "y": 740,
        "wires": []
    },
    {
        "id": "cc536065bbfc85d0",
        "type": "debug",
        "z": "46a5586ef7af1095",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 440,
        "y": 780,
        "wires": []
    },
    {
        "id": "82835d81d6e37909",
        "type": "debug",
        "z": "46a5586ef7af1095",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 700,
        "y": 780,
        "wires": []
    },
    {
        "id": "843194ca33cc07a7",
        "type": "function",
        "z": "46a5586ef7af1095",
        "name": "Get flow var",
        "func": "msg.payload.value = flow.get(msg.payload.variable);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 450,
        "y": 740,
        "wires": [
            [
                "82835d81d6e37909",
                "f86ec0b78063bf66"
            ]
        ]
    },
    {
        "id": "32d8ba7ed396b23e",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.response",
                "pt": "msg",
                "to": "\"Variable <b>\" & payload.variable & \"</b> set to <b>\" & payload.value & \"</b>\"",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 680,
        "wires": [
            [
                "338e16524a29406e"
            ]
        ]
    },
    {
        "id": "f86ec0b78063bf66",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.response",
                "pt": "msg",
                "to": "\"Variable <b>\" & payload.variable & \"</b> contains <b>\" & payload.value & \"</b>\"",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 740,
        "wires": [
            [
                "63af14d708218f1a"
            ]
        ]
    },
    {
        "id": "69a697dc0ef4759b",
        "type": "http in",
        "z": "46a5586ef7af1095",
        "name": "",
        "url": "/worklet",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 190,
        "y": 1240,
        "wires": [
            [
                "10d1ba9b42f9fe4b"
            ]
        ]
    },
    {
        "id": "bb7dcab7531ea684",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "CSS",
        "field": "payload.style",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400&family=Roboto:wght@300;400;700;900&display=swap');\n\n*\n{\n    font-family: 'Roboto Slab';\n    font-weight: 300;\n    font-size: 13px;\n    transition: 1000ms;\n    max-height: 100%;\n}\n*:not(#main, body, #body)\n{\n    box-sizing: border-box;\n}\ninput, select\n{\n    border-radius: 3px;\n    background-color: whitesmoke;\n    border: 1px solid #ebebeb;\n    line-height: 35px;\n    min-height: 37px;\n    padding: 0px 10px;\n    font-weight: 400;\n}\ninput\n{\n    background: linear-gradient(whitesmoke, #fafafa);\n    max-width: 150px;\n}\nbutton\n{\n    height: 70px;\n    font-size: 20px;\n    border: 0px;\n    margin: 2px;\n    cursor: pointer;\n    background: linear-gradient(whitesmoke, #fafafa);\n    text-align: left;\n    padding-left: 70px;\n}\nbutton:hover\n{\n    background: linear-gradient(ebebeb, whitesmoke);\n}\n.contentBox.login input\n{\n    width: 100%;\n    max-width: 100%;\n}\nselect\n{\n    background: linear-gradient(whitesmoke, #e8e8e8);\n}\ninput:focus, select:focus\n{\n    outline: 1px solid #FAE100;\n}\ninput:disabled, select:disabled\n{\n    color: #737373!important;\n    opacity: 1!important;\n}\n\nbody\n{\n    padding-left: 50px;\n    padding-bottom: 30px;\n    \n    background-color: #d6d6d6;\n    margin: 0px;\n    \n    flex: content;\n    display: flex;\n    justify-content: center;\n    gap: 10px;\n}\n#body\n{\n    padding-top: 150px;\n}\n    #main\n    {\n        width: 600px;\n        transition-delay: 500ms;\n    }\n\n.contentBox\n{\n    background-color: white;\n    border-radius: 5px;\n    width: 100%;\n    /*width: 600px;*/\n    overflow: hidden;\n}\n\n.hidden \n{\n    max-height: 0px!important;\n    overflow: hidden!important;\n}\n.hidden *\n{\n    max-height: 0px!important;\n    overflow: hidden!important;\n}\n.contentBox *\n{\n    overflow: hidden;\n}\n\n.contentBox:not(.hidden)\n{\n    margin-bottom: 20px;\n}\n.contentBox.locked > div.header\n{\n        background: linear-gradient(#575c65, #666d76)!important;\n}\n.contentBox.locked input, .contentBox.locked select\n{\n    pointer-events:none;\n}\n.contentBox.checked \n{\n    background-color: #7dd25989!important;\n}\n\n    /*.contentBox.rules\n    {\n        width: 30vw;  \n    }*/\n    .contentBox > div.header\n    {\n        width: 100%;\n        background: linear-gradient(#1B365D, #3c506e);\n        /* background-color: #1B365D; /*#3c506e;*/\n        line-height: 70px;\n        color: white;\n        padding-left: 18px;\n        font-size: 20px;\n        font-family: 'Roboto';\n        font-weight: 400;\n        text-transform: uppercase;\n        letter-spacing: 1px;\n        border: 2px solid whitesmoke;\n        border-top-left-radius: 5px;\n        border-top-right-radius: 5px;\n        transition-delay: 500ms;\n    }\n    .contentBox > .subheader\n    {\n        width: 100%;\n        padding-left: 20px;\n        padding-right: 20px;\n        line-height: 40px;\n        text-transform: uppercase;\n        font-weight: 300;\n        background: linear-gradient(#737373, #878787);\n        font-family: 'Roboto';\n        color: white;\n        border-left: 2px solid whitesmoke;\n        border-right: 2px solid whitesmoke;\n    }\n    .contentBox .wrapper\n    {\n        width: 100%;\n        display: flex;\n        flex-direction: column;\n        gap: 2px;\n    }\n    .contentBox .actionList\n    {\n        display: flex;\n        flex-direction: column;\n    }\n        .wrapper > div, .actionList > div#wrappedStartButton /* WRAPPER OBJECT PARENT */\n        {\n            width: 100%;\n            display: flex;\n            flex-wrap: wrap;\n            justify-content: space-between;\n            gap: 5px;\n            padding: 15px;\n            line-height: 35px;\n            border-left: 2px solid whitesmoke;\n            border-right: 2px solid whitesmoke;\n        }\n        .wrapper label, .actionList label\n        {\n            padding: 0px;\n            font-size: 18px;\n            line-height: 40px;\n            flex-grow: 2;\n            padding-left: 20px;\n            cursor: pointer;\n        }\n        .wrapper input[type='checkbox'], .actionList input[type='checkbox']\n        {\n            width: 25px;\n            cursor: pointer;\n        }\n        .wrapper:last-child > div:last-child\n        {\n            border-bottom-left-radius: 5px;\n            border-bottom-right-radius: 5px;\n            border-bottom: 2px solid whitesmoke;\n        }\n\n            .contentBox.approve .wrapper > div:first-child\n            {\n                border-top-left-radius: 5px;\n                border-top-right-radius: 5px;\n                border-top: 2px solid whitesmoke;\n            }\n            .wrapper > div > span\n            {\n                flex-grow: 0;\n            }\n            .wrapper span.valuetype\n            {\n                background-color: #95afc0;\n                color: white;\n                border-radius: 3px;\n                padding: 0px 5px;\n                opacity: 0.7;\n            }\n            .wrapper > div > span:first-of-type\n            {\n                font-size: 15px;\n            }\n            .wrapper > div > div > span \n            {\n                font-size: 15px;\n            }\n            .wrapper > div > span.description\n            {\n                background-color: #FAE100;\n                border-radius: 3px;\n                padding: 0px 10px;\n                opacity: 0.7;\n                color: black;\n                font-size: 15px;\n                font-weight: 400;\n                cursor: help;\n            }\n            .wrapper .spacing\n            {\n                flex-grow: 2;\n            }\n\n.no-select {\n    user-select: none; /* supported by Chrome and Opera */\n   -webkit-user-select: none; /* Safari */\n   -khtml-user-select: none; /* Konqueror HTML */\n   -moz-user-select: none; /* Firefox */\n   -ms-user-select: none; /* Internet Explorer/Edge */\n}\n\n\n.w50 {\n    width: 100%;\n    max-width: 45%;\n}\n.w40 {\n    flex-grow: 10;\n    justify-self: flex-start;\n}\n.w20 {\n    flex-grow: 1;\n    justify-self: flex-end;\n    width: 15%;\n}\n\n.disabled {\n    background-color: #c8c8c8!important;\n}\n.disabled input, .disabled select, .disabled label\n{\n    pointer-events: none;\n}\n\n\n\n.column\n{\n    flex-direction: column!important;\n}\n.flex\n{\n    display: flex;\n    justify-content: space-between;\n}\n.floatr\n{\n    float: right;\n    position: relative;\n}\n\n\n\n\n\n\n\n.citizen\n{\n    background-color: #e8e2f7;\n}\n.receipt\n{\n    background-color: #f5f4dd;\n    border-top-left-radius: 8px;\n    border-top-right-radius: 8px;\n}\n.suggestedActions\n{\n    background-color: #e2f7ee;\n    border-bottom-left-radius: 8px;\n    border-bottom-right-radius: 8px;\n    padding-bottom: 7px;\n}\n.actionList > div\n{\n    width: 100%;\n    display: flex;\n    flex-wrap: wrap;\n    justify-content: space-between;\n    gap: 5px;\n    padding: 15px;\n    line-height: 35px;\n    border-left: 2px solid whitesmoke;\n    border-right: 2px solid whitesmoke;\n}\n\n\n    .receipt .flex > div:not(:first-of-type)\n    {\n        text-align: right;\n    }\n    \n    .receipt .flex:last-child,\n    .citizen .flex:last-child,\n    .suggestedActions .flex:last-child\n    {\n        padding-bottom: 3px;\n    }\n    .receipt > div,\n    .citizen > div,\n    .suggestedActions > div\n    {\n        padding-left: 20px;\n        padding-right: 20px;\n        line-height: 35px;\n    }\n    .receipt .header,\n    .citizen .header,\n    .suggestedActions .header\n    {\n        text-transform: uppercase;\n        font-family: 'Roboto';\n        font-weight: 400;\n        font-size: 14px;\n        line-height: 45px;\n        background-color: #00000009;\n    }\n    .receipt .subheader,\n    .citizen .subheader,\n    .suggestedActions .subheader\n    {\n        background-color: #00000009;\n        text-transform: uppercase;\n        font-weight: 900;\n        line-height: 20px;\n        padding-bottom: 8px;\n    }\n        .receipt .subheader *,\n        .citizen .subheader *,\n        .suggestedActions .subheader *\n        {\n            font-size: 11px;\n            font-family: 'Roboto';\n            font-weight: 300;\n            align-self: flex-end;\n        }\n        .receipt .fakturanr\n        {\n            font-size: 12px;\n            padding-left: 20px;\n            color: #95afc0;\n        }\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n/* RESULTS */\n@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400&family=Roboto:wght@300;400;500;600;700;900&display=swap');\n\n*\n{\n    box-sizing: border-box;\n}\na\n{\n    text-decoration: none;\n    color: rgb(59, 59, 59);\n}\nbody\n{\n    max-width: 100vw;\n    margin: 0px;\n    scrollbar-gutter: stable;\n}\n.results\n{\n    position: absolute;\n    left: 0px;\n    right: 0px;\n    bottom: 0px;\n\n    background-color: #a8a8a8;\n    width: 100%;\n    max-height: 0px;\n    min-height: 100vh;\n    scrollbar-gutter: stable;\n\n    display: flex;\n    overflow-x: hidden;\n    justify-content: center;\n\n    font-family: 'Roboto Slab';\n    font-weight: 400;\n    font-size: 13px;\n    color: rgb(59, 59, 59);\n\n    transition-duration: 1200ms;\n}\n  \n    .results:not(.visible)\n    {\n        min-height: 0vh;\n    }\n    .results > div.main\n    {\n        max-width: 1700px;\n        min-width: 900px;\n\n        margin-top: 170px;\n    }\n\n/* MENU / KATEGORIER */\n.menu\n{\n    position: fixed;\n    z-index: 2;\n    \n    display: flex;\n    justify-content: center;\n    gap: 27px;\n\n    padding-top: 50px;\n    padding-bottom: 18px;\n    background-color: #999999ee;\n\n    left: 18px;\n    right: 18px;\n}\n    .menu > div\n    {\n        display: flex;\n        height: 60px;\n        transition-duration: 150ms;\n\n        user-select: none; /* supported by Chrome and Opera */\n        -webkit-user-select: none; /* Safari */\n        -khtml-user-select: none; /* Konqueror HTML */\n        -moz-user-select: none; /* Firefox */\n        -ms-user-select: none; /* Internet Explorer/Edge */\n    }\n        .menu > div.selected\n        {\n            margin-top: 12px;\n            border: 5px solid rgba(255, 255, 255, 0.411);\n        }\n        .menu > div.green\n        {\n            background-color: #DAE5D7;\n        }\n        .menu > div.red\n        {\n            background-color: #e5d7d7;\n        }\n        .menu > div.yellow\n        {\n            background-color: #e5e0d7;\n        }\n    .menu > div:hover\n    {\n        scale: 1.05;\n        cursor: pointer;\n    }\n        .menu > div > div\n        {\n            display: flex;\n            flex-direction: column;\n            justify-content: flex-end;\n        }\n        .menu > div > div:first-child\n        {\n            background: rgb(1, 1, 1, 0.08);\n            justify-content: flex-end;\n\n            width: 70px;\n        }\n            .menu > div > div:first-child > div /* Procent-visning af relativt antal faktura i kategori */\n            {\n                display: flex;\n                flex-direction: column;\n            }\n                .menu > div.green > div:first-child > div\n                {\n                    background-color: #80bf80;\n                }\n                .menu > div.red > div:first-child > div\n                {\n                    background-color: #bf8080;\n                }\n                .menu > div.yellow > div:first-child > div\n                {\n                    background-color: #bfb980;\n                }\n            .menu > div > div:first-child > div > span /* Procent ^^ i tekst ovenover boks */\n            {\n                align-self: center;\n                font-size: 9px;\n                font-weight: 600;\n                margin-top: -11.5px;\n            }\n                .menu > div.green > div:first-child > div > span\n                {\n                    color: #639463;\n                }\n                .menu > div.red > div:first-child > div > span\n                {\n                    color: #946363;\n                }\n                .menu > div.yellow > div:first-child > div > span\n                {\n                    color: #948f63;\n                }\n            .menu > div > div:first-child > div > span > span\n            {\n                font-size: 7px;\n            }\n        .menu > div > div:last-child /* Kategori-titel */\n        {\n            padding-left: 20px;\n            justify-content: center;\n\n            width: 170px;\n\n            font-family: 'Roboto';\n            text-transform: uppercase;\n            font-size: 12px;\n            font-weight: 500;\n            letter-spacing: 1px;\n            color: rgb(1, 1, 1, 0.65);\n        }\n    \n\n\n.itemList\n{\n    display: flex;\n    flex-direction: column;\n}\n\n/* LIST ITEM */\n.listItem\n{\n    display: flex;\n    padding-bottom: 35px;\n}\n    .listItem > div\n    {\n        align-self: flex-start;\n    \n        min-width: 270px;\n    }\n        .listItem .header\n        {\n            line-height: 38px;\n            background: rgb(1, 1, 1, 0.08);\n\n            text-transform: uppercase;\n            font-family: 'Roboto';\n            font-weight: 400;\n            font-size: 11px;\n            letter-spacing: 0.45px;\n            color: rgb(1, 1, 1, 0.55);\n\n            padding-left: 14px;\n            padding-right: 14px;\n\n            user-select: none; /* supported by Chrome and Opera */\n            -webkit-user-select: none; /* Safari */\n            -khtml-user-select: none; /* Konqueror HTML */\n            -moz-user-select: none; /* Firefox */\n            -ms-user-select: none; /* Internet Explorer/Edge */\n        }\n            .listItem .header:hover\n            {\n                cursor: grab;\n            }\n            .header > span\n            {\n                position: relative;\n                float: right;\n                margin-right: 3px;\n            }\n            .listItem > div:first-child .header\n            {\n                padding-right: 30px;\n            }\n                #togglePop\n                {\n                    cursor: pointer;\n                }\n                span > .popmenu\n                {\n                    position: absolute;\n                    float: left;\n                    top: 20px;\n                    right: 18px;\n                    width: 150px;\n\n                    font-size: 10px;\n                    line-height: 32px;\n\n                    background-color: rgb(255, 255, 255, 1);\n                    box-shadow: 0px 0px 30px -10px grey;\n\n                    display: flex;\n                    flex-direction: column;\n\n                    max-height: 0vh;\n                    max-width: 0vh;\n                    overflow: hidden;\n                    white-space: nowrap;\n                    text-overflow: ellipsis;\n\n                    transition-duration: 100ms;\n                }\n                    #togglePop.show > .popmenu\n                    {\n                        max-height: 30vh;\n                        max-width: 100vh;\n\n                        transition-duration: 1000ms;\n                    }\n                    .popmenu > a\n                    {\n                        padding: 0px 10px;\n                    }\n                    .popmenu > a:hover\n                    {\n                        background-color: rgb(240, 240, 240, 1); \n                    }\n\n    /* Borger */\n    .listItem > div:first-child\n    {\n        flex-grow: 0;\n        background-color: #DDDEFE;\n        padding-bottom: 8px;\n    }\n        .listItem > div:first-child > .cpr\n        {\n            padding: 15px 18px;\n            font-size: 17px;\n            font-weight: 400;\n            letter-spacing: 0.3px;\n        }\n        .listItem > div:first-child > .sag\n        {\n            padding: 4px 14px;\n            background: rgb(1, 1, 1, 0.04);\n            margin-bottom: 2px;\n\n            text-transform: uppercase;\n            font-family: 'Roboto';\n            line-height: 18px;\n            font-size: 10px;\n            letter-spacing: 0.45px;\n        }\n            .sag > span\n            {\n                font-size: 17px;\n            }\n            .sag.findes\n            {\n                color: #46a114;\n                font-weight: 400;\n            }\n            .sag.findes-ikke\n            {\n                color: #a15814;\n                font-weight: 400;\n            }\n        .listItem > div:first-child > .persondata\n        {\n            display: flex;\n            flex-wrap: wrap;\n            justify-content: space-evenly;\n\n            padding: 9px 0px;\n            width: 98%;\n        }\n            .listItem > div:first-child > .persondata > div\n            {\n                text-align: center;\n                min-width: 30%;\n                font-family: 'Roboto';\n            }\n    \n\n    /* Faktura + Handlinger */\n    .listItem > div:last-child\n    {\n        flex-grow: 1;\n        justify-self: stretch;\n\n        display: flex;\n        flex-direction: column;\n\n        min-width: 600px;\n    }\n\n        .listItem > div:last-child > .faktura\n        {\n            background-color: #FEFEF3;\n\n            margin-left: -18px;\n            margin-top: -5px;\n            margin-right: -5px;\n\n            padding-bottom: 8px;\n\n            border: 5px solid #a8a8a8;\n        }\n            .listItem > div:last-child > .faktura > div:not(.header)\n            {\n                padding: 8px 14px;\n            }\n            .listItem > div:last-child > .faktura > .ydelse\n            {\n                display: flex;\n                align-items: flex-end;\n                gap: 10px;\n            }\n                /* Små overskrifter */\n                .listItem > div:last-child > .faktura > .ydelse span, .listItem > div:first-child > .persondata > div > span\n                {\n                    text-transform: uppercase;\n                    font-family: 'Roboto';\n                    font-size: 9px;\n                    color: rgb(159, 159, 159);\n                }\n                .listItem > div:last-child > .faktura > .ydelse > .titel\n                {\n                    flex-grow: 1;\n                }\n                .listItem > div:last-child > .faktura > .ydelse > div:not(.titel)\n                {\n                    text-align: right;\n                }\n                    .listItem > div:last-child > .faktura > .ydelse > div > div\n                    {\n                        margin-top: 8px;\n                    }\n\n        .listItem > div:last-child > .handling\n        {\n            background-color: #F9E1DD;\n            display: flex;\n\n            margin-bottom: 5px;\n            border-left: 5px solid #a8a8a8;\n            margin-right: 18px;\n        }\n            .listItem > div:last-child > .handling > div:not(.header)\n            {\n                line-height: 38px;\n                padding-left: 12px;\n            }\n\n/* Ghost */\n.ghost\n{\n    position: absolute;\n    pointer-events: none;\n    z-index: 10;\n\n    opacity: 0;\n    scale: 0.8;\n}\n.ghost.visible \n{\n    opacity: 0.65;\n}",
        "x": 1310,
        "y": 1220,
        "wires": [
            [
                "133b8b46b364e917"
            ]
        ]
    },
    {
        "id": "bff36cd6014cf7c5",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "Rules JS",
        "field": "payload.scripts.rules",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "plain",
        "template": "const ruleWrapper_system = document.querySelector(\".ruleWrapper_system\");\nconst ruleWrapper_user = document.querySelector(\".ruleWrapper_user\");\n\nconst rules = _rules != null ? _rules : []; // Rules are defined in change node previous to this\n\nconst operators = [\n    {\n        \"name\": \"= Skal være lig med\",\n        \"value\": \"==\"\n    },\n    {\n        \"name\": \"≠ Må ikke være lig med\",\n        \"value\": \"!=\"\n    },\n    {\n        \"name\": \"< Skal være mindre end\",\n        \"value\": \"<\"\n    },\n    {\n        \"name\": \"> Skal være større end\",\n        \"value\": \">\"\n    },\n    {\n        \"name\": \"{?} Indeholder\",\n        \"value\": \"contains\"\n    },\n    {\n        \"name\": \"{!} Indeholder ikke\",\n        \"value\": \"!contains\"\n    },\n    {\n        \"name\": \"[o] Skal være oplyst\",\n        \"value\": \"!null\"\n    }\n]\n\n\nfunction newSelector(selectedValue) {\n    return `\n    `;\n}\n\nfunction newInputField(index) {\n    const obj = rules[index];\n    let returnHTML = `\n        <div${obj.systemrule == true ? \" class=\\\"disabled\\\"\" : \"\"}>\n        <span>${obj.name}:</span>\n        <div class=\"spacing\">&nbsp;</div>\n        <div>    \n            <select id=\"input_${index}_operator\"${obj.systemrule == true ? \" disabled=\\\"disabled\\\"\" : \"\"}>\n        `;\n\n    for (let i = 0; i < operators.length; i++) {\n        let isSelected = obj.operator == operators[i].value;\n        //console.log(\"Checking '\" + obj.operator + \"' against '\" + operators[i].value + \"' = \" + isSelected);\n        returnHTML += `<option value=\"${operators[i].value}\"${isSelected ? \" selected\" : \"\"}>${operators[i].name}</option>`;\n    }\n\n    let valueType = obj.type == \"number\" || obj.type == \"text\" ? `<span class=\"valuetype\">${obj.type == \"number\" ? \"tal\" : obj.type == \"text\" ? \"tekst\" : \"\"}</span>` : ``;\n    returnHTML += `\n            </select>\n        </div>\n        <div>\n            <input id=\"input_${index}_value\" value=\"${obj.value}\"${obj.systemrule == true ? \" disabled=\\\"disabled\\\"\" : \"\"} />\n        </div>\n        ${valueType}\n        <span class=\"description\" title=\"${obj.description}\">?</span>\n        </div>\n    `;\n    return returnHTML;\n}\n\n///\n// Instantiate input fields\n\nfor (let i = 0; i < rules.length; i++)\n    if (rules[i][\"systemrule\"] != null && rules[i][\"systemrule\"] == true)\n        ruleWrapper_system.innerHTML += newInputField(i);\n    else\n        ruleWrapper_user.innerHTML += newInputField(i);\n\n///\n// Dynamically add event listeners \n\nfor (let i = 0; i < rules.length; i++) {\n    document.querySelector(\"#input_\" + i + \"_operator\").addEventListener(\"focusout\", () => {\n        UpdateValue(document.querySelector(\"#input_\" + i + \"_operator\"));\n    });\n\n    document.querySelector(\"#input_\" + i + \"_value\").addEventListener(\"focusout\", () => {\n        UpdateValue(document.querySelector(\"#input_\" + i + \"_value\"));\n    });\n\n    document.querySelector(\"#input_\" + i + \"_value\").addEventListener(\"input\", () => {\n        OnInputChange(document.querySelector(\"#input_\" + i + \"_value\"));\n    });\n}\n\n///\n// Update input value\nfunction UpdateValue(inputField) {\n    let id = inputField.id;\n    let sid = id.split(\"_\");\n\n    (rules[parseInt(sid[1])])[sid[2]] = inputField.value;\n\n    const message = rules;\n\n    PublishRules(JSON.stringify(message));\n    console.log(message);\n}\n\n///\n//\nfunction OnInputChange(inputField) {\n    let id = inputField.id;\n    let sid = id.split(\"_\");\n    let type = (rules[parseInt(sid[1])])[\"type\"];\n\n    switch (type) {\n        case \"int\": case \"float\": case \"double\": case \"number\":\n            inputField.value = inputField.value.replace(/[^0-9.]/g, '').replace(/(\\..*?)\\..*/g, '$1');\n            break;\n\n        case \"text\": case \"letters\":\n            inputField.value = inputField.value.replace(/[^A-Za-z ]/g, '');\n            break;\n\n    }\n}\n\n\n\n\n///\n/* WEB SOCKET (node-red)\nvar ws_rules;\nvar wsUri_rules = \"ws:\";\nvar loc_rules = window.location; //console.log(loc);\n\nif (loc_rules.protocol === \"https:\") { wsUri_rules = \"wss:\"; }\n// This needs to point to the web socket in the Node-RED flow\nwsUri_rules += \"//\" + loc_rules.host + loc_rules.pathname.replace(\"worklet\", \"ws/rules\");\n\nfunction wsConnect_rules() {\n\n    console.log(\"Connecting to \", wsUri_rules);\n    ws_rules = new WebSocket(wsUri_rules);\n\n    ws_rules.onmessage = function (msg) {\n\n        // parse the incoming message as a JSON object\n        var data = msg.data;\n        const obj = JSON.parse(data);\n\n        console.log(\"Received WS message: \" + JSON.stringify(obj));\n\n        //ws.send(JSON.stringify({data:data}));\n    }\n\n    ws_rules.onopen = function () {\n        // update the status div with the connection status\n        console.log(\"Connected to ws/rules\");\n    }\n\n    ws_rules.onclose = function () {\n        // update the status div with the connection status\n        console.log(\"ws/rules connection lost\");\n        // in case of lost connection tries to reconnect every 3 secs\n        setTimeout(wsConnect_rules, 3000);\n    }\n}*/\nfunction PublishRules(m) {\n    if (ws) { ws.send(m); }\n}",
        "x": 1020,
        "y": 1220,
        "wires": [
            [
                "a20bbd734e8db1dd"
            ]
        ]
    },
    {
        "id": "f06e5d62ba343557",
        "type": "http response",
        "z": "46a5586ef7af1095",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1630,
        "y": 1220,
        "wires": []
    },
    {
        "id": "9405e95ff9d4307d",
        "type": "comment",
        "z": "46a5586ef7af1095",
        "name": "Set rules from memory or template",
        "info": "",
        "x": 500,
        "y": 1180,
        "wires": []
    },
    {
        "id": "e0b3f784c02f0690",
        "type": "comment",
        "z": "46a5586ef7af1095",
        "name": "Host website",
        "info": "",
        "x": 190,
        "y": 1200,
        "wires": []
    },
    {
        "id": "5e779a55048ef720",
        "type": "comment",
        "z": "46a5586ef7af1095",
        "name": "Set content",
        "info": "",
        "x": 1030,
        "y": 1180,
        "wires": []
    },
    {
        "id": "15dd627e8042ec3b",
        "type": "comment",
        "z": "46a5586ef7af1095",
        "name": "Endpoint",
        "info": "",
        "x": 1640,
        "y": 1180,
        "wires": []
    },
    {
        "id": "caedb05ff325269f",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "New rule template",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "[\t    {\t        \"name\": \"Formue\",\t        \"variable\": \"formue\",\t        \"operator\": \"<\",\t        \"value\": 93000,\t        \"type\": \"number\",\t        \"description\": \"Borgerens formue skal følge denne regel\",\t        \"error\": \"Borgerens formue bryder formue-reglen\"\t    },\t    {\t        \"name\": \"Formue\",\t        \"variable\": \"formue\",\t        \"operator\": \"!null\",\t        \"value\": true,\t        \"type\": \"bool\",\t        \"description\": \"Borgerens formue skal være oplyst til UDK\",\t        \"systemrule\": true\t    }\t]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 610,
        "y": 1260,
        "wires": [
            [
                "aadd0cae5075d248",
                "baeb82a6a342e924"
            ]
        ]
    },
    {
        "id": "e96e7625efe2f002",
        "type": "websocket in",
        "z": "46a5586ef7af1095",
        "d": true,
        "name": "",
        "server": "c1ae0d59916344e0",
        "client": "",
        "x": 190,
        "y": 1560,
        "wires": [
            [
                "bd1a487231f62db2"
            ]
        ]
    },
    {
        "id": "aadd0cae5075d248",
        "type": "json",
        "z": "46a5586ef7af1095",
        "name": "",
        "property": "payload.rules",
        "action": "str",
        "pretty": false,
        "x": 810,
        "y": 1220,
        "wires": [
            [
                "d6122c45845a9250"
            ]
        ]
    },
    {
        "id": "7d0d9e6cacf1354c",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "Load rules",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "#:(storeInFile)::rules",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 590,
        "y": 1220,
        "wires": [
            [
                "aadd0cae5075d248"
            ]
        ]
    },
    {
        "id": "bd1a487231f62db2",
        "type": "json",
        "z": "46a5586ef7af1095",
        "d": true,
        "name": "",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 370,
        "y": 1560,
        "wires": [
            [
                "ed6fdaa88b12a8d2"
            ]
        ]
    },
    {
        "id": "53ac9f1969b4a819",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::rules",
                "pt": "global",
                "to": "payload",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1560,
        "wires": [
            [
                "773d2be741c9fa81"
            ]
        ]
    },
    {
        "id": "773d2be741c9fa81",
        "type": "debug",
        "z": "46a5586ef7af1095",
        "name": "Rules updated",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1000,
        "y": 1560,
        "wires": []
    },
    {
        "id": "89a0e6fb99adacdb",
        "type": "switch",
        "z": "46a5586ef7af1095",
        "name": "",
        "property": "#:(storeInFile)::rules",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 410,
        "y": 1240,
        "wires": [
            [
                "7d0d9e6cacf1354c"
            ],
            [
                "caedb05ff325269f"
            ]
        ]
    },
    {
        "id": "ed6fdaa88b12a8d2",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$|\t{\t    \"value\": \t        type = \"number\" ?\t            value ~> $number() \t            :\t            value  \t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 560,
        "y": 1560,
        "wires": [
            [
                "53ac9f1969b4a819"
            ]
        ]
    },
    {
        "id": "a20bbd734e8db1dd",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "UI JS",
        "field": "payload.scripts.ui",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "const checkboxRules = document.querySelector('#acceptRules'),\n      checkboxLogin = document.querySelector('#acceptLogin'),\n\n    startRunButton = document.querySelector('#startRun'),\n\n    acceptRulesLabel = document.querySelector('#acceptRulesLabel'),\n    acceptLoginLabel = document.querySelector('#acceptLoginLabel'),\n    startRunLabel = document.querySelector('#startRunLabel'),\n\n    loginEmail = document.querySelector('#WorkLetEmail'),\n    loginPass = document.querySelector('#WorkLetPass'),\n\n    contentBoxApproveRules = document.querySelector('.contentBox.approve#approveRules'),\n    contentBoxApproveLogin = document.querySelector('.contentBox.approve#approveLogin'),\n\n    wrappedStartButton = document.querySelector('#wrappedStartButton'),\n    actionList = document.querySelector('.actionList'),\n    \n      contentBoxActions = document.querySelector('.contentBox.actions'),\n      contentBoxRules = document.querySelector('.contentBox.rules'),\n      contentBoxLogin = document.querySelector('.contentBox.login'),\n      \n    body = document.querySelector('#body'),\n    main = document.querySelector('#main');\n\n\nvar paddingTop = 150;\nvar paddingAdjustment = 60,\n    paddingMin = 30;\n\n\n// APROVE LOGIN //\n\ncheckboxLogin.addEventListener('change', event => {\n    if (checkboxLogin.checked == true)\n    {\n        // Make checkbox bg green\n        contentBoxApproveLogin.classList.add(\"checked\");\n\n        // Hide this box\n        contentBoxLogin.classList.add(\"hidden\");\n\n        if (checkboxRules.checked != true)\n        {\n            // Show next box\n            contentBoxRules.classList.remove(\"hidden\");\n            contentBoxApproveRules.classList.remove(\"hidden\");\n        }\n\n        // Change approve label\n        acceptLoginLabel.innerHTML = \"Loginoplysninger godkendt\";\n\n        // Send to node-red\n        ApproveWorkLetLogin();\n\n        // Adjust body padding\n        body.style.paddingTop = (paddingTop -= paddingAdjustment) + \"px\";\n        if (paddingTop < paddingMin) body.style.paddingTop = (paddingTop = paddingMin) + \"px\";\n    }\n    else\n    {\n        // Remove green checkbox bg\n        contentBoxApproveLogin.classList.remove(\"checked\");\n\n        // Un-hide this box\n        contentBoxLogin.classList.remove(\"hidden\");\n\n        // Reverse approve label\n        acceptLoginLabel.innerHTML = \"Godkend loginoplysninger\";\n\n        // Adjust body padding\n        body.style.paddingTop = (paddingTop += paddingAdjustment) + \"px\";\n    }\n\n});\n\n\n// APROVE RULES //\n\ncheckboxRules.addEventListener('change', event => {\n    if (checkboxRules.checked == true)\n    {\n        // Make checkbox bg green\n        contentBoxApproveRules.classList.add(\"checked\");\n\n        // Hide this box\n        contentBoxRules.classList.add(\"hidden\");\n\n        // Show next box\n        contentBoxActions.classList.remove(\"hidden\");\n\n        // Change approve label\n        acceptRulesLabel.innerHTML = \"Regelsæt godkendt\";\n\n        // Adjust body padding\n        body.style.paddingTop = (paddingTop -= paddingAdjustment) + \"px\";\n        if (paddingTop < paddingMin) body.style.paddingTop = (paddingTop = paddingMin) + \"px\";\n    }\n    else\n    {\n        // Remove green checkbox bg\n        contentBoxApproveRules.classList.remove(\"checked\");\n\n        // Un-hide this box\n        contentBoxRules.classList.remove(\"hidden\");\n\n        // Hide next box\n        contentBoxActions.classList.add(\"hidden\");\n        \n        // Reverse approve label\n        acceptRulesLabel.innerHTML = \"Godkend regelsæt\";\n\n        // Adjust body padding\n        body.style.paddingTop = (paddingTop += paddingAdjustment) + \"px\";\n    }\n\n});\n\n\n// START RUN //\n\nstartRunButton.addEventListener('change', event => {\n    if (startRunButton.checked == true) {\n        // Disable all checkboxes\n        contentBoxActions.classList.add(\"disabled\");\n        contentBoxApproveRules.classList.add(\"disabled\");\n        contentBoxApproveLogin.classList.add(\"disabled\");\n\n        contentBoxApproveRules.classList.remove(\"checked\");\n        contentBoxApproveLogin.classList.remove(\"checked\");\n\n        // Show action list?\n        //contentBoxActions.classList.remove(\"hidden\");\n\n        // Set extra wide main div for actions\n        main.style.width = \"800px\";\n\n        // Change approve label\n        startRunLabel.innerHTML = \"Beregning påbegyndt ... vent venligst ...\";\n\n        // Adjust body padding\n        body.style.paddingTop = (paddingTop -= paddingAdjustment) + \"px\";\n        if (paddingTop < paddingMin) body.style.paddingTop = (paddingTop = paddingMin) + \"px\";\n\n        // Start run\n        StartRun();\n    }\n    else {\n        \n    }\n\n});\n\n\n\n// POPULATE ACTIONS\n\n\nfunction PopulateActions(objList) {\n\n    contentBoxActions.classList.remove(\"disabled\");\n\n    //console.log(\"Obj count: \" + objList.length);\n    //console.log(\"Obj list: \\n\" + objList);\n\n    let html = ``;\n\n    for (let i = 0; i < objList.length;i++)\n    {\n        html += `\n            <div class=\"column\">\n                <div class=\"receipt\">\n\n                    <div class=\"header\">\n                        Faktura\n                        <span class=\"fakturanr\">\n                            Element `+ i +`\n                        </span>\n                        <div class=\"floatr\">\n                            04-10-2022 14:30\n                        </div>\n                    </div>\n\n                    <div class=\"subheader flex\">\n                        <div class=\"w40\">Behandling</div>\n                        <div class=\"w20\">Egenbetaling</div>\n                        <div class=\"w20\">Sygesikring</div>\n                        <div class=\"w20\">Total</div>\n                    </div>\n\n                    <div class=\"flex\">\n                        <div class=\"w40\">Behandling på klinik</div>\n                        <div class=\"w20\">300 kr</div>\n                        <div class=\"w20\">0 kr</div>\n                        <div class=\"w20\">300 kr</div>\n                    </div>\n\n                </div>\n\n                <div class=\"citizen\">\n\n                    <div class=\"header\">\n                        Borger\n                    </div>\n\n                    <div class=\"subheader flex\">\n                        <div class=\"w40\">Alm. helbredstillæg</div>\n                        <div class=\"w20\">Udvidet helbredstillæg</div>\n                        <div class=\"w20\">Helbredskort</div>\n                        <div class=\"w20\">Bevilget fodpleje</div>\n                        <div class=\"w20\">Formue</div>\n                        <div class=\"w20\">Danmark gruppe</div>\n                        <div class=\"w20\">Tillægsprocent</div>\n                    </div>\n\n                    <div class=\"flex\">\n                        <div class=\"w40\">Data</div>\n                        <div class=\"w20\">Udvidet Data</div>\n                        <div class=\"w20\">Data</div>\n                        <div class=\"w20\">Bevilget Data</div>\n                        <div class=\"w20\">Data</div>\n                        <div class=\"w20\">Danmark Data</div>\n                        <div class=\"w20\">Data</div>\n                    </div>\n\n                </div>\n\n                <div class=\"suggestedActions\">\n\n                    <div class=\"header\">\n                        Handlinger\n                    </div>\n\n                    <div class=\"flex\">\n                        <div>\n                            Her kommer liste over handlinger\n                        </div>\n                    </div>\n\n                </div>\n\n            </div>\n            `;\n    }\n\n    actionList.innerHTML = html;\n\n    actionList.style.maxHeight = \"100%\";\n}\n\n\n\n///\n// WEB SOCKET (node-red)\nvar ws;\nvar wsUri = \"ws:\";\nvar loc = window.location; //console.log(loc);\n\nif (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n// This needs to point to the web socket in the Node-RED flow\nwsUri += \"//\" + loc.host + loc.pathname.replace(\"worklet\", \"ws/worklet\");\n\nfunction wsConnect() {\n\n    console.log(\"Connecting to \", wsUri);\n    ws = new WebSocket(wsUri);\n\n    ws.onmessage = function (msg) {\n\n        // parse the incoming message as a JSON object\n        var data = msg.data;\n        const obj = JSON.parse(data);\n\n        //console.log(\"Received WS message: \" + JSON.stringify(obj));\n\n        //PopulateActions(obj);\n\n        location.reload();\n\n        /*\n        fetch('/worklet', {\n            method: 'POST',\n            headers: {\n                'Accept': 'application/json',\n                'Content-Type': 'application/json'\n            },\n            body: JSON.stringify({ \"id\": 78912 })\n        });*/\n\n        //ws.send(JSON.stringify({data:data}));\n    }\n\n    ws.onopen = function () {\n        // update the status div with the connection status\n        console.log(\"Connected to ws/worklet\");\n    }\n\n    ws.onclose = function () {\n        // update the status div with the connection status\n        console.log(\"ws/worklet connection lost\");\n        // in case of lost connection tries to reconnect every 3 secs\n        setTimeout(wsConnect, 3000);\n    }\n}\n\nfunction ApproveWorkLetLogin() {\n    let loginObj = {\n        \"user\": loginEmail.value,\n        \"pass\": loginPass.value\n    }\n    if (ws){\n        ws.send(JSON.stringify(loginObj));\n        }\n}\n\nfunction StartRun() {\n    let mqttObj = {\n        \"mqtt\": \"start\"\n    }\n    if (ws) {\n        ws.send(JSON.stringify(mqttObj));\n    }\n}\n\n\n\n",
        "output": "str",
        "x": 1170,
        "y": 1220,
        "wires": [
            [
                "bb7dcab7531ea684"
            ]
        ]
    },
    {
        "id": "d6122c45845a9250",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.scripts",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 905,
        "y": 1220,
        "wires": [
            [
                "bff36cd6014cf7c5"
            ]
        ],
        "l": false
    },
    {
        "id": "a620ffc5c7ed5ec7",
        "type": "websocket in",
        "z": "46a5586ef7af1095",
        "name": "",
        "server": "13a90a014adf9bc5",
        "client": "",
        "x": 200,
        "y": 1480,
        "wires": [
            [
                "5175932af1ceb7cd"
            ]
        ]
    },
    {
        "id": "5175932af1ceb7cd",
        "type": "json",
        "z": "46a5586ef7af1095",
        "name": "",
        "property": "payload",
        "action": "",
        "pretty": false,
        "x": 370,
        "y": 1480,
        "wires": [
            [
                "acb874e9073f9e95",
                "d3030bf8371e27fb"
            ]
        ]
    },
    {
        "id": "acb874e9073f9e95",
        "type": "switch",
        "z": "46a5586ef7af1095",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "hask",
                "v": "mqtt",
                "vt": "str"
            },
            {
                "t": "istype",
                "v": "array",
                "vt": "array"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 530,
        "y": 1480,
        "wires": [
            [
                "cd272d540ca72b75"
            ],
            [
                "ed6fdaa88b12a8d2"
            ]
        ]
    },
    {
        "id": "e6cfc8a15818c2d7",
        "type": "mqtt out",
        "z": "46a5586ef7af1095",
        "name": "MQQT Publisher",
        "topic": "worklet/control",
        "qos": "2",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "a567f42879c1f449",
        "x": 1010,
        "y": 1480,
        "wires": []
    },
    {
        "id": "cd272d540ca72b75",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload.mqtt",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1480,
        "wires": [
            [
                "e6cfc8a15818c2d7"
            ]
        ]
    },
    {
        "id": "baeb82a6a342e924",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::rules",
                "pt": "global",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 840,
        "y": 1260,
        "wires": [
            []
        ]
    },
    {
        "id": "d3030bf8371e27fb",
        "type": "debug",
        "z": "46a5586ef7af1095",
        "name": "debug 12",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "false",
        "statusVal": "",
        "statusType": "auto",
        "x": 560,
        "y": 1440,
        "wires": []
    },
    {
        "id": "4cf35494f2aa0134",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "CSS",
        "field": "payload.style",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "@import url('https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@300;400&family=Roboto:wght@300;400;500;600;700;900&display=swap');\n\n*\n{\n    box-sizing: border-box;\n}\na\n{\n    text-decoration: none;\n    color: rgb(59, 59, 59);\n}\nbody\n{\n    max-width: 100vw;\n    margin-top: 0px;\n    margin-left: 0px;\n    margin-right: 0px;\n    background-color: #a8a8a8;\n\n    display: flex;\n    overflow-x: hidden;\n    justify-content: center;\n\n    font-family: 'Roboto Slab';\n    font-weight: 400;\n    font-size: 13px;\n    color: rgb(59, 59, 59);\n}\n    body > div.main\n    {\n        max-width: 1700px;\n        min-width: 900px;\n\n        margin-top: 170px;\n    }\n\n/* MENU / KATEGORIER */\n.menu\n{\n    position: fixed;\n    z-index: 5;\n    \n    display: flex;\n    justify-content: center;\n    gap: 27px;\n\n    padding-top: 50px;\n    padding-bottom: 18px;\n    background-color: #999999ee;\n    border-bottom-left-radius: 5px;\n    border-bottom-right-radius: 5px;\n\n    width: 100%;\n}\n    .menu > div\n    {\n        display: flex;\n        height: 60px;\n        transition-duration: 150ms;\n\n        user-select: none; /* supported by Chrome and Opera */\n        -webkit-user-select: none; /* Safari */\n        -khtml-user-select: none; /* Konqueror HTML */\n        -moz-user-select: none; /* Firefox */\n        -ms-user-select: none; /* Internet Explorer/Edge */\n    }\n        .menu > div.selected\n        {\n            margin-top: 12px;\n            border: 5px solid rgba(255, 255, 255, 0.411);\n        }\n        .menu > div.green\n        {\n            background-color: #DAE5D7;\n        }\n        .menu > div.red\n        {\n            background-color: #e5d7d7;\n        }\n        .menu > div.yellow\n        {\n            background-color: #e5e0d7;\n        }\n    .menu > div:hover\n    {\n        scale: 1.05;\n        cursor: pointer;\n    }\n        .menu > div > div\n        {\n            display: flex;\n            flex-direction: column;\n            justify-content: flex-end;\n        }\n        .menu > div > div:first-child\n        {\n            background: rgb(1, 1, 1, 0.08);\n            justify-content: flex-end;\n\n            width: 70px;\n        }\n            .menu > div > div:first-child > div /* Procent-visning af relativt antal faktura i kategori */\n            {\n                display: flex;\n                flex-direction: column;\n            }\n                .menu > div.green > div:first-child > div\n                {\n                    background-color: #80bf80;\n                }\n                .menu > div.red > div:first-child > div\n                {\n                    background-color: #bf8080;\n                }\n                .menu > div.yellow > div:first-child > div\n                {\n                    background-color: #bfb980;\n                }\n            .menu > div > div:first-child > div > span /* Procent ^^ i tekst ovenover boks */\n            {\n                align-self: center;\n                font-size: 9px;\n                font-weight: 600;\n                margin-top: -11.5px;\n            }\n                .menu > div.green > div:first-child > div > span\n                {\n                    color: #639463;\n                }\n                .menu > div.red > div:first-child > div > span\n                {\n                    color: #946363;\n                }\n                .menu > div.yellow > div:first-child > div > span\n                {\n                    color: #948f63;\n                }\n            .menu > div > div:first-child > div > span > span\n            {\n                font-size: 7px;\n            }\n        .menu > div > div:last-child /* Kategori-titel */\n        {\n            padding-left: 20px;\n            justify-content: center;\n\n            width: 170px;\n\n            font-family: 'Roboto';\n            text-transform: uppercase;\n            font-size: 12px;\n            font-weight: 500;\n            letter-spacing: 1px;\n            color: rgb(1, 1, 1, 0.65);\n        }\n    \n\n\n.itemList\n{\n    display: flex;\n    flex-direction: column;\n}\n\n/* LIST ITEM */\n.listItem\n{\n    display: flex;\n    padding-bottom: 35px;\n}\n    .listItem > div\n    {\n        align-self: flex-start;\n    \n        min-width: 270px;\n    }\n        .listItem .header\n        {\n            line-height: 38px;\n            background: rgb(1, 1, 1, 0.08);\n\n            text-transform: uppercase;\n            font-family: 'Roboto';\n            font-weight: 400;\n            font-size: 11px;\n            letter-spacing: 0.45px;\n            color: rgb(1, 1, 1, 0.55);\n\n            padding-left: 14px;\n            padding-right: 14px;\n\n            user-select: none; /* supported by Chrome and Opera */\n            -webkit-user-select: none; /* Safari */\n            -khtml-user-select: none; /* Konqueror HTML */\n            -moz-user-select: none; /* Firefox */\n            -ms-user-select: none; /* Internet Explorer/Edge */\n        }\n            .listItem .header:hover\n            {\n                cursor: grab;\n            }\n            .header > span\n            {\n                position: relative;\n                float: right;\n                margin-right: 3px;\n            }\n            .listItem > div:first-child .header\n            {\n                padding-right: 30px;\n            }\n                #togglePop\n                {\n                    cursor: pointer;\n                }\n                span > .popmenu\n                {\n                    position: absolute;\n                    float: left;\n                    top: 20px;\n                    right: 18px;\n                    width: 150px;\n\n                    font-size: 10px;\n                    line-height: 32px;\n\n                    background-color: rgb(255, 255, 255, 1);\n                    box-shadow: 0px 0px 30px -10px grey;\n\n                    display: flex;\n                    flex-direction: column;\n\n                    max-height: 0vh;\n                    max-width: 0vh;\n                    overflow: hidden;\n                    white-space: nowrap;\n                    text-overflow: ellipsis;\n\n                    transition-duration: 100ms;\n                }\n                    #togglePop.show > .popmenu\n                    {\n                        max-height: 30vh;\n                        max-width: 100vh;\n\n                        transition-duration: 1000ms;\n                    }\n                    .popmenu > a\n                    {\n                        padding: 0px 10px;\n                    }\n                    .popmenu > a:hover\n                    {\n                        background-color: rgb(240, 240, 240, 1); \n                    }\n\n    /* Borger */\n    .listItem > div:first-child\n    {\n        flex-grow: 0;\n        background-color: #DDDEFE;\n        padding-bottom: 8px;\n    }\n        .listItem > div:first-child > .cpr\n        {\n            padding: 15px 18px;\n            font-size: 17px;\n            font-weight: 400;\n            letter-spacing: 0.3px;\n        }\n        .listItem > div:first-child > .sag\n        {\n            padding: 4px 14px;\n            background: rgb(1, 1, 1, 0.04);\n            margin-bottom: 2px;\n\n            text-transform: uppercase;\n            font-family: 'Roboto';\n            line-height: 18px;\n            font-size: 10px;\n            letter-spacing: 0.45px;\n        }\n            .sag > span\n            {\n                font-size: 17px;\n            }\n            .sag.findes\n            {\n                color: #46a114;\n                font-weight: 400;\n            }\n            .sag.findes-ikke\n            {\n                color: #a15814;\n                font-weight: 400;\n            }\n        .listItem > div:first-child > .persondata\n        {\n            display: flex;\n            flex-wrap: wrap;\n            justify-content: space-evenly;\n\n            padding: 9px 0px;\n            width: 98%;\n        }\n            .listItem > div:first-child > .persondata > div\n            {\n                text-align: center;\n                min-width: 30%;\n                font-family: 'Roboto';\n            }\n    \n\n    /* Faktura + Handlinger */\n    .listItem > div:last-child\n    {\n        flex-grow: 1;\n        justify-self: stretch;\n\n        display: flex;\n        flex-direction: column;\n\n        min-width: 600px;\n    }\n\n        .listItem > div:last-child > .faktura\n        {\n            background-color: #FEFEF3;\n\n            margin-left: -18px;\n            margin-top: -5px;\n            margin-right: -5px;\n\n            padding-bottom: 8px;\n\n            border: 5px solid #a8a8a8;\n        }\n            .listItem > div:last-child > .faktura > div:not(.header)\n            {\n                padding: 8px 14px;\n            }\n            .listItem > div:last-child > .faktura > .ydelse\n            {\n                display: flex;\n                align-items: flex-end;\n                gap: 10px;\n            }\n                /* Små overskrifter */\n                .listItem > div:last-child > .faktura > .ydelse span, .listItem > div:first-child > .persondata > div > span\n                {\n                    text-transform: uppercase;\n                    font-family: 'Roboto';\n                    font-size: 9px;\n                    color: rgb(159, 159, 159);\n                }\n                .listItem > div:last-child > .faktura > .ydelse > .titel\n                {\n                    flex-grow: 1;\n                }\n                .listItem > div:last-child > .faktura > .ydelse > div:not(.titel)\n                {\n                    text-align: right;\n                }\n                    .listItem > div:last-child > .faktura > .ydelse > div > div\n                    {\n                        margin-top: 8px;\n                    }\n\n        .listItem > div:last-child > .handling\n        {\n            background-color: #F9E1DD;\n            display: flex;\n\n            margin-bottom: 5px;\n            border-left: 5px solid #a8a8a8;\n            margin-right: 18px;\n        }\n            .listItem > div:last-child > .handling > div:not(.header)\n            {\n                line-height: 38px;\n                padding-left: 12px;\n            }\n\n/* Ghost */\n.ghost\n{\n    position: absolute;\n    pointer-events: none;\n    z-index: 10;\n\n    opacity: 0;\n    scale: 0.8;\n}\n.ghost.visible \n{\n    opacity: 0.65;\n}",
        "output": "str",
        "x": 930,
        "y": 1320,
        "wires": [
            [
                "d31b67a59d19e7dc"
            ]
        ]
    },
    {
        "id": "133b8b46b364e917",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\" dir=\"ltr\">\n  <head>\n    <meta charset=\"utf-8\">  \n    <title>Regler</title>\n    <style>{{{payload.style}}}</style>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <!-- Iconscout Link For Icons -->\n    <link rel=\"stylesheet\" href=\"https://unicons.iconscout.com/release/v4.0.0/css/line.css\">\n  </head>\n  <body onload=\"wsConnect();\" onunload=\"ws.disconnect();\" id=\"body\">\n\n    <div id=\"main\">\n\n      <div class=\"contentBox login\">\n        <div class=\"header\">WorkLet login</div>\n        <div class=\"wrapper\">\n          <div>\n            <div class=\"w50\">\n              <span>E-mail adresse</span><br />\n              <input id=\"WorkLetEmail\" />\n            </div>\n            <div class=\"w50\">\n              <span>Kodeord</span><br />\n              <input id=\"WorkLetPass\" type=\"password\" />\n            </div>\n          </div>\n        </div>\n      </div>\n      \n      <div class=\"contentBox approve\" id=\"approveLogin\">\n        <div class=\"wrapper\">\n          <div>\n            <input type=\"checkbox\" id=\"acceptLogin\" name=\"acceptLogin\" value=\"true\">\n            <label for=\"acceptLogin\" class=\"no-select\" id=\"acceptLoginLabel\">Godkend loginoplysninger</label>\n          </div>\n        </div>\n      </div>\n\n\n\n\n      <div class=\"contentBox rules hidden\">\n        <div class=\"header\">Regler</div>\n        <div class=\"subheader\">Systemregler</div>\n        <div class=\"wrapper ruleWrapper_system\"></div>\n        <div class=\"subheader\">Brugerregler</div>\n        <div class=\"wrapper ruleWrapper_user\"></div>\n      </div>\n\n      <div class=\"contentBox approve hidden\" id=\"approveRules\">\n        <div class=\"wrapper\">\n          <div>\n            <input type=\"checkbox\" id=\"acceptRules\" name=\"acceptRules\" value=\"true\">\n            <label for=\"acceptRules\" class=\"no-select\" id=\"acceptRulesLabel\">Godkend regelsæt</label>\n          </div>\n        </div>\n      </div>\n\n      \n\n\n      <div class=\"contentBox actions hidden\">\n        <div class=\"header\">Tilskudsberegning</div>\n        <div class=\"subheader\">Anbefalede handlinger</div>\n        <div class=\"actionList\">\n          <div id=\"wrappedStartButton\">\n            <input type=\"checkbox\" id=\"startRun\" name=\"startRun\" value=\"true\">\n            <label for=\"startRun\" class=\"no-select\" id=\"startRunLabel\">Start beregning</label>\n          </div>\n        </div>\n      </div>\n\n    </div>\n\n    <script>\n      const _rules = {{{payload.rules}}}\n\n      /* RULES */\n\n      {{{payload.scripts.rules}}}\n\n      /* UI */\n\n      {{{payload.scripts.ui}}}\n    </script>\n\n  </body>\n</html>",
        "x": 1470,
        "y": 1220,
        "wires": [
            [
                "f06e5d62ba343557"
            ]
        ]
    },
    {
        "id": "d31b67a59d19e7dc",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\" dir=\"ltr\">\n\n<head>\n  <meta charset=\"utf-8\">\n  <title>Tilskudsberegning</title>\n\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <!-- Iconscout Link For Icons -->\n  <link rel=\"stylesheet\" href=\"https://unicons.iconscout.com/release/v4.0.0/css/line.css\">\n  <link rel=\"stylesheet\" href=\"https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/themes/smoothness/jquery-ui.css\">\n  <style>\n    {{{payload.style}}}\n  </style>\n</head>\n\n<body>\n\n  <div class=\"ghost listItem\">\n    <div></div>\n  </div>\n\n  <div class=\"menu\">\n\n    <div class=\"menuItem green selected\" id=\"anbefalede_handlinger\" onmouseup=\"dropZone(this)\">\n      <div>\n        <div style=\"height: 70%;\"><span>70<span>%</span></span></div>\n      </div>\n      <div>Anbefalede<br />handlinger</div>\n    </div>\n\n    <div class=\"menuItem red\" id=\"usikre_handlinger\" onmouseup=\"dropZone(this)\">\n      <div>\n        <div style=\"height: 10%;\"><span>10<span>%</span></span></div>\n      </div>\n      <div>Usikre<br />handlinger</div>\n    </div>\n\n    <div class=\"menuItem yellow\" id=\"manuel_behandling\" onmouseup=\"dropZone(this)\">\n      <div>\n        <div style=\"height: 20%;\"><span>20<span>%</span></span></div>\n      </div>\n      <div>Manuel<br />behandling</div>\n    </div>\n\n  </div><!-- /menu -->\n\n  <div class=\"main\">\n\n    <div class=\"itemList\">\n\n\n    </div><!-- /itemList -->\n\n  </div><!-- /main -->\n\n  <script src=\"https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js\"></script>\n  <script src=\"https://ajax.googleapis.com/ajax/libs/jqueryui/1.13.2/jquery-ui.min.js\"></script>\n  <script>\n    {{{payload.script}}}\n  </script>\n\n\n</body>\n\n</html>",
        "x": 1090,
        "y": 1320,
        "wires": [
            [
                "7f7d6cfa083646fa"
            ]
        ]
    },
    {
        "id": "10d1ba9b42f9fe4b",
        "type": "switch",
        "z": "46a5586ef7af1095",
        "name": "",
        "property": "displayingResults",
        "propertyType": "flow",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 310,
        "y": 1320,
        "wires": [
            [
                "403fb6de982e18b2"
            ],
            [
                "89a0e6fb99adacdb"
            ]
        ]
    },
    {
        "id": "403fb6de982e18b2",
        "type": "change",
        "z": "46a5586ef7af1095",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "results",
                "pt": "msg",
                "to": "results",
                "tot": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 480,
        "y": 1320,
        "wires": [
            [
                "e15bc58133fad095"
            ]
        ]
    },
    {
        "id": "e15bc58133fad095",
        "type": "json",
        "z": "46a5586ef7af1095",
        "name": "",
        "property": "results",
        "action": "str",
        "pretty": false,
        "x": 650,
        "y": 1320,
        "wires": [
            [
                "104a8254af268edb"
            ]
        ]
    },
    {
        "id": "104a8254af268edb",
        "type": "template",
        "z": "46a5586ef7af1095",
        "name": "JS",
        "field": "payload.script",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "\n    const results = {{{results}}};\n\n    //const resultObj = JSON.parse(results);\n    var itemList = document.querySelector('.itemList');\n    itemList.innerHTML = \"\";\n\n    for(let i = 0;i < results.length;i++)\n    {\n        itemList.innerHTML += printObject(i);\n    }\n\n    function printObject(index)\n    {        \n        let obj = results[index];\n        \n        let returnStr = `\n        <div class=\"listItem\" id=\"listItem_${index}\">\n        <div>\n\n          <div class=\"header\" onmousedown=\"dragItem('listItem_${index}')\">\n            Borger\n            <span class=\"uil uil-ellipsis-h\" id=\"togglePop\" onclick=\"togglePop(this)\">\n                        <div class=\"popmenu show\">\n                            <a href=\"#\">Gå til borger i KP</a>\n                        </div>\n                        </span>\n          </div>\n          <div class=\"cpr\">${obj.cpr}</div>\n\n          <div class=\"sag findes${obj.persondata.bevilling ? '' : '-ikke'}\"><span class=\"uil uil-${obj.persondata.bevilling ? 'check' : 'times'}\"></span> Bevilget fodpleje</div>\n          <div class=\"sag findes${obj.persondata.udvidetHelbredstillaeg ? '' : '-ikke'}\"><span class=\"uil uil-${obj.persondata.udvidetHelbredstillaeg ? 'check' : 'times'}\"></span> Udvidet helbredstillæg</div>\n          <div class=\"sag findes${obj.persondata.almHelbredstillaeg ? '' : '-ikke'}\"><span class=\"uil uil-${obj.persondata.almHelbredstillaeg ? 'check' : 'times'}\"></span> Alm. helbredstillæg</div>\n          <div class=\"sag findes${obj.persondata.helbredskort ? '' : '-ikke'}\"><span class=\"uil uil-${obj.persondata.helbredskort ? 'check' : 'times'}\"></span> Helbredskort</div>\n\n          <div class=\"persondata\">\n            <div>\n              <span>Danmark</span><br />\n              ${obj.persondata.danmarkgruppe != 0 ? ('Gruppe ' + obj.persondata.danmarkgruppe) : 'Ej medlem'}\n            </div>\n\n            <div>\n              <span>Formue</span><br />\n              ${obj.persondata.formue} kr\n            </div>\n\n            <div>\n              <span>Tillægsprocent</span><br />\n              ${obj.persondata.helbredstillaegsprocent[0].tillaegsprocent}%\n            </div>\n          </div>\n\n        </div>\n        <div>\n\n          <div class=\"faktura\">\n\n            <div class=\"header\" onmousedown=\"dragItem('listItem_${index}')\">\n              Faktura\n              <span class=\"uil uil-ellipsis-h\" id=\"togglePop\" onclick=\"togglePop(this)\">\n                            <div class=\"popmenu show\">\n                                <a href=\"#\">Se faktura i WorkLet</a>\n                            </div>\n                            </span>\n            </div>\n\n            <div class=\"ydelse\">\n              <div>\n                <span>#</span>`;\n\n      if (Array.isArray(obj.faktura.behandlinger))\n        for(let i = 0;i < obj.faktura.behandlinger.length;i++)\n          returnStr += `<div>${obj.faktura.behandlinger[i].ydelsesnummer}</div>`;\n      else\n        returnStr += `<div>${obj.faktura.behandlinger.ydelsesnummer}</div>`;\n        \n              \n        returnStr += `\n              </div>\n              <div class=\"titel\">\n                <span>Ydelse</span>`;\n\n      if (Array.isArray(obj.faktura.behandlinger))\n        for (let i = 0; i < obj.faktura.behandlinger.length; i++)\n          returnStr += `<div>${obj.faktura.behandlinger[i].titel}</div>`;\n      else\n        returnStr += `<div>${obj.faktura.behandlinger.titel}</div>`;\n\n        returnStr += `\n              </div>\n              <div>\n                <span>Sygesikringsandel</span>`;\n\n      if (Array.isArray(obj.faktura.behandlinger))\n        for (let i = 0; i < obj.faktura.behandlinger.length; i++)\n          returnStr += `<div>${obj.faktura.behandlinger[i].sygesikringsAndel}</div>`;\n      else\n        returnStr += `<div>${obj.faktura.behandlinger.sygesikringsAndel}</div>`;\n\n        returnStr += `\n              </div>\n              <div>\n                <span>Patientandel</span>`;\n\n      if (Array.isArray(obj.faktura.behandlinger))\n        for (let i = 0; i < obj.faktura.behandlinger.length; i++)\n          returnStr += `<div>${obj.faktura.behandlinger[i].patientAndel}</div>`;\n      else\n        returnStr += `<div>${obj.faktura.behandlinger.patientAndel}</div>`;\n\n        returnStr += `\n              </div>\n              <div>\n                <span>Honorar</span>`;\n\n      if (Array.isArray(obj.faktura.behandlinger))\n        for (let i = 0; i < obj.faktura.behandlinger.length; i++)\n          returnStr += `<div>${obj.faktura.behandlinger[i].pris}</div>`;\n      else\n        returnStr += `<div>${obj.faktura.behandlinger.pris}</div>`;\n\n      returnStr += `\n            </div>\n          </div>\n\n        </div>\n        `;\n\n      if (Array.isArray(obj.handlinger))\n        for (let i = 0; i < obj.handlinger.length; i++)\n        {\n          returnStr += `<div class=\"handling\">\n\n            <div class=\"header\">Handling</div>\n            <div>${obj.handlinger[i].handling}</div>\n\n          </div>`;\n        }\n      else if (typeof obj.handlinger == \"object\")\n      {\n        returnStr += `<div class=\"handling\">\n\n            <div class=\"header\">Handling</div>\n            <div>${obj.handlinger.handling}</div>\n\n          </div>`;\n      }\n\n      returnStr += `\n        </div>\n        </div><!-- /listItem -->\n        `;\n\n        return returnStr;\n\n    }\n\n\n    function togglePop(element)\n    {\n        element.classList.toggle(\"show\");\n    }\n\n\n    const menuElements = document.getElementsByClassName(\"menuItem\");\n    const listElements = document.getElementsByClassName(\"listItem\");\n\n    var currentDraggedElement = null;\n\n    function dragItem(itemId)\n    {\n        var item = document.getElementById(itemId);\n        currentDraggedElement = item;\n\n        let itemX = item.offsetLeft;\n        let itemY = item.offsetTop;\n        //console.log(\"Item pos: [\" + itemX + \", \" + itemY + \"]\");\n        //console.log(\"Mouse pos: [\" + mouseX + \", \" + mouseY + \"]\");\n        //console.log(\"Offset: [\" + (itemX-mouseX) + \", \" + (itemY-mouseY) + \"]\");\n\n        offsetX = (itemX-mouseX);\n        offsetY = (itemY-mouseY) - 25;\n    }\n\n    function dropZone(zone)\n    {\n        if(currentDraggedElement == null)\n            return;\n        \n        console.log(\"Item '\" + currentDraggedElement.id + \"' was dropped into zone '\" + zone.id + \"'\");\n        \n        clearGhost();\n    }\n\n\n\n    var ghostObject = null;\n    const ghost = document.querySelector('.ghost');\n\n    function createGhostObject(item)\n    {\n        ghostObject = item;\n        ghost.innerHTML = ghostObject.innerHTML;\n        ghost.style = ghostObject.style;\n        ghost.style.marginLeft = offsetX + \"px\";\n        ghost.style.marginTop = offsetY + \"px\";\n        ghost.classList.add(\"visible\");\n\n        item.style.opacity = 0.6;\n\n        document.querySelector('body').style.cursor = \"grabbing\";\n    }\n\n    var mouseX, mouseY;\n    var offsetX, offsetY;\n    document.addEventListener('mousemove', function(e)\n    {            \n        let left = mouseX = e.pageX;\n        let top = mouseY = e.pageY;\n\n        if(currentDraggedElement == null)\n            return;\n\n        if(ghostObject == null)\n            createGhostObject(currentDraggedElement);\n\n        ghost.style.left = left + 'px';\n        ghost.style.top = top + 'px';\n    });\n\n    document.addEventListener('mouseup', function(e)\n    {\n        if(currentDraggedElement == null)\n            return;\n        clearGhost();\n    });\n\n    function clearGhost()\n    {\n        currentDraggedElement.style.opacity = 1;\n        currentDraggedElement = null;\n\n        ghostObject = null;            \n        ghost.innerHTML = \"\";\n        ghost.classList.remove(\"visible\");\n\n        document.querySelector('body').style.cursor = \"auto\";\n        //ghost.style = null;\n    }",
        "output": "str",
        "x": 790,
        "y": 1320,
        "wires": [
            [
                "4cf35494f2aa0134"
            ]
        ]
    },
    {
        "id": "d6b0b912a9e8fabc",
        "type": "http in",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "url": "/fod",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 580,
        "wires": [
            [
                "a583e16fda76e4d4"
            ]
        ]
    },
    {
        "id": "fadd69372798f56d",
        "type": "http response",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 990,
        "y": 920,
        "wires": []
    },
    {
        "id": "ccfd8a36c9eed804",
        "type": "template",
        "z": "4fd74d0002aa2bc4",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html>\n<head>\n    <script src=\"https://code.jquery.com/jquery-3.6.3.slim.min.js\"></script>\n    <!--script src=\"https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js\"></script-->\n    <script src=\"https://unpkg.com/@popperjs/core@2.11.6/dist/umd/popper.min.js\"></script>\n    <script src=\"https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/js/bootstrap.min.js\"></script>\n    <style>{{{css}}}</style>\n    <meta name=\"theme-color\" content=\"#7952b3\">\n</head>\n<body>\n\n<div class=\"d-flex flex-column align-items-stretch flex-shrink-0\" id=\"sideMenu\">\n\n  <a class=\"d-flex align-items-center flex-shrink-0 p-3 link-primary text-decoration-none\">\n    <svg class=\"bi me-2\" width=\"30\" height=\"24\"><use xlink:href=\"#bootstrap\"></use></svg>\n    <span class=\"fs-5 fw-semibold\">Auto<small class=\"text-muted\" style=\"padding-left: 3px\">WorkLet</small></span>\n  </a>\n\n  <div class=\"container\" style=\"margin-top: 20px;margin-bottom: 8px\">\n    <ul class=\"nav nav-pills flex-column\">\n\n      <li class=\"nav-item\">\n        <a class=\"nav-link mb-1 text-primary\" aria-current=\"page\" onclick=\"setPageContent('login')\" id=\"menu_login\">\n          <i class=\"fa fa-lock\" aria-hidden=\"true\"></i>\n          Loginoplysninger\n        </a>\n      </li>\n\n      <li>\n        <a class=\"nav-link mb-1 text-primary\" onclick=\"setPageContent('rules')\" id=\"menu_rules\">\n          <i class=\"fa fa-briefcase\" aria-hidden=\"true\"></i>\n          Forretningsregler\n        </a>\n      </li>\n\n      <li>\n        <a class=\"nav-link mb-1 text-primary\" onclick=\"setPageContent('grants')\" id=\"menu_grants\">\n          <i class=\"fa fa-book\" aria-hidden=\"true\"></i>\n          Tilskudssatser\n        </a>\n      </li>\n\n      <li>\n        <a class=\"nav-link text-primary\" style=\"margin-top: 40px\" onclick=\"setPageContent('receipts')\" id=\"menu_receipts\">\n          <i class=\"fa fa-book\" aria-hidden=\"true\"></i>\n          Fakturaer\n        </a>\n      </li>\n\n    </ul>\n  </div>\n\n  <div class=\"list-group list-group-flush scrollarea border-top border-bottom\">\n\n\n    <a class=\"list-group-item list-group-item-action py-3 lh-tight text-primary disabled\" onclick=\"setPageContent('receipts-manual')\" id=\"menu_receipts-manual\">\n      <div class=\"d-flex w-100 align-items-center justify-content-between\">\n        <strong class=\"mb-1\">Manuel behandling</strong>\n        <small class=\"text-muted\" id=\"menu_receipts-manual-num\">0</small>\n      </div>\n      <div class=\"col-10 mb-1 small\" id=\"menu_receipts-manual-sub\">Der er 0 borgere med ubehandlede fakturaer, som kræver manuel behandling.</div>\n    </a>\n\n    <a class=\"list-group-item list-group-item-action py-3 lh-tight text-primary disabled\" id=\"menu_receipts-recommended\" aria-current=\"true\" onclick=\"setPageContent('receipts-recommended')\">\n      <div class=\"d-flex w-100 align-items-center justify-content-between\">\n        <strong class=\"mb-1\">Anbefalede handlinger</strong>\n        <small id=\"menu_receipts-recommended-num\">0</small>\n      </div>\n      <div class=\"col-10 mb-1 small\" id=\"menu_receipts-recommended-sub\">Der er 0 borgere med fakturaer, som har anbefalede handlinger.</div>\n    </a>\n\n\n    <!--a class=\"list-group-item list-group-item-action py-3 lh-tight text-primary\">\n      <div class=\"d-flex w-100 align-items-center justify-content-between\">\n        <strong class=\"mb-1\">Usikre handlinger</strong>\n        <small class=\"text-muted\">0</small>\n      </div>\n      <div class=\"col-10 mb-1 small\">Usikre handlinger vises i denne kategori, når robotten har søgt efter fakturaer.</div>\n    </a-->\n\n\n\n  </div>\n</div><!-- /sideMenu -->\n\n<div id=\"pageContent\">\n  <div class=\"container\" id=\"mainContent\">\n  \n\n  </div>\n</div>\n\n</body>\n<script>{{{js}}}</script>\n</html>",
        "output": "str",
        "x": 790,
        "y": 920,
        "wires": [
            [
                "fadd69372798f56d"
            ]
        ]
    },
    {
        "id": "75be0ea8650cbce8",
        "type": "template",
        "z": "4fd74d0002aa2bc4",
        "name": "CSS",
        "field": "css",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "@import url('https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css');\n/*@import url('https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/sandstone/bootstrap.min.css');\n@import url('https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/zephyr/bootstrap.min.css');*/\n@import url('https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/flatly/bootstrap.min.css');\n\n@import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css');\n\n@font-face {\n  font-family: 'password';\n  font-style: normal;\n  font-weight: 400;\n  src: url(https://jsbin-user-assets.s3.amazonaws.com/rafaelcastrocouto/password.ttf);\n}\n\n\nbody\n{\n    margin: 0px;\n}\n\na:hover\n{\n    cursor: pointer;\n}\n\n\n\n\n#sideMenu\n{\n    width: 20vw;\n    height: 100vh;\n    position: fixed;\n\n    transition: 500ms cubic-bezier(0.075, 0.82, 0.165, 1);\n\n    user-select: none; /* supported by Chrome and Opera */\n    -webkit-user-select: none; /* Safari */\n    -khtml-user-select: none; /* Konqueror HTML */\n    -moz-user-select: none; /* Firefox */\n    -ms-user-select: none; /* Internet Explorer/Edge */\n}\n\n        .nav-link:hover, .list-group-item-action:hover\n        {\n            background-color: aliceblue;\n        }\n        .nav-link.selected, .list-group-item-action.selected\n        {\n            pointer-events: none;\n        }\n        \n\n    .nav-link.success.selected\n    {\n        background-color: #5CB89C!important;\n    }\n    .nav-link.success:not(.selected)\n    {\n        color: #5CB89C!important;\n    }\n\n        .nav-link.success.selected:hover\n        {\n            background-color: #4A9780!important;\n        }       \n        \n        .nav-link.success:not(.selected):hover\n        {\n            background-color: rgb(240, 255, 245)!important;\n        }       \n\n        .nav-link > .fa\n        {\n            margin-left: -5px;\n            margin-right: 10px;\n        }\n\ndiv.form-floating input\n{\n    color: black!important;\n}\n\n\n.list-group-item-action\n{\n    transition: 500ms cubic-bezier(0.075, 0.82, 0.165, 1);\n}\n\n\n\n\n.citizenCard\n{\n    overflow-x: hidden!important;\n    text-overflow: ellipsis;\n}\n\n\n#pageContent\n{\n    min-height: 100vh;\n\n    margin-left: 20vw;\n    padding-left: 40px;\n    padding-top: 78px;\n    padding-right: 20px;\n    \n    background-color: rgb(221, 228, 231);\n    \n    transition: 500ms cubic-bezier(0.075, 0.82, 0.165, 1);\n}\n    #pageContent > .container\n    {\n        margin-left: 0px;\n    \n        transition: 500ms cubic-bezier(0.075, 0.82, 0.165, 1);\n    }\n\n\n.receiptContainer\n{\n    display: flex;\n    justify-content: space-between;\n    align-items: flex-start;\n    width: 100%;\n    gap: 5px;\n    margin-bottom: 45px;\n}\n\n\n\n@media only screen and (max-width: 1600px)\n{\n    #sideMenu\n    {\n        width: 25vw;\n    }\n    #pageContent\n    {\n        margin-left: 25vw;\n    }\n}\n@media only screen and (max-width: 1200px)\n{\n    #sideMenu\n    {\n        width: 30vw;\n    }\n    #pageContent\n    {\n        margin-left: 30vw;\n        padding-left: 15px;\n        padding-right: 10px;\n    }\n}\n@media only screen and (max-width: 768px)\n{\n    #sideMenu\n    {\n        width: 40vw;\n    }\n    #pageContent\n    {\n        margin-left: 40vw;\n        padding-left: 0px;\n        padding-top: 15px;\n        padding-right: 0px;\n    }\n}\n\n@media only screen and (max-width: 576px)\n{\n    #sideMenu\n    {\n        width: 45vw;\n    }\n    #pageContent\n    {\n        margin-left: 45vw;\n    }\n}\n\n\n\n\n\n\n\n\n.disabled\n{\n    opacity: 0.65;\n    background-color: rgb(242, 251, 251)!important;\n}\n\n\n\n.tooltip\n{\n    font-size: 11px!important;\n}\n.tooltip.show\n{\n    opacity: 0.8;\n}\n\n\n\n\n\nbutton\n{\n    padding-left: 25px!important;\n    padding-right: 25px!important;\n\n    transition: 1000ms cubic-bezier(0.075, 0.82, 0.165, 1)!important;\n}\n\nbutton .goNext\n{\n    max-height: 70px!important;\n}\n\nbutton.goNext.collapsed\n{\n    opacity: 0;\n    pointer-events: none;\n}\n\n\n\n.no-border-bottom\n{\n    border-bottom: 0px!important;\n}\n.no-border\n{\n    border: 0px!important;\n}\n.no-border *\n{\n    border: 0px!important;\n}\n\n.accordion-item\n{\n    margin: 0px!important;\n    transition: 1000ms cubic-bezier(0.075, 0.82, 0.165, 1)!important;\n}\n\n\n\n.badge\n{\n    padding: 8px 10px;\n}\n.badge.text-dark\n{\n    color: #7A8587!important;\n}\n.badge.text-dark:hover\n{\n    color: black!important;\n}\n\n\n\n.floatr\n{\n    position: relative;\n    float: right;\n}\n\n\n\n#togglePop\n                {\n                    cursor: pointer;\n                }\n                span > .popmenu\n                {\n                    position: absolute;\n                    float: left;\n                    top: 20px;\n                    right: 10px;\n                    width: 150px;\n\n                    font-size: 11px;\n                    line-height: 32px;\n\n                    background-color: rgb(255, 255, 255, 1);\n                    box-shadow: 0px 0px 30px -10px grey;\n\n                    display: flex;\n                    flex-direction: column;\n\n                    max-height: 0vh;\n                    max-width: 0vh;\n                    overflow: hidden;\n                    white-space: nowrap;\n                    text-overflow: ellipsis;\n\n                    transition-duration: 100ms;\n                }\n                    #togglePop.show > .popmenu\n                    {\n                        max-height: 30vh;\n                        max-width: 100vh;\n\n                        transition-duration: 1000ms;\n                    }\n                    .popmenu > a\n                    {\n                        padding: 0px 10px;\n                        text-decoration: none;\n                        color: black;\n                    }\n                    .popmenu > a:hover\n                    {\n                        background-color: rgb(240, 240, 240, 1); \n                    }",
        "output": "str",
        "x": 670,
        "y": 920,
        "wires": [
            [
                "ccfd8a36c9eed804"
            ]
        ]
    },
    {
        "id": "418b8a6997ee31c9",
        "type": "http in",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "url": "/fod/post",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 180,
        "y": 160,
        "wires": [
            [
                "6ab92f730d3b3707",
                "9dbc32c65601cf69"
            ]
        ]
    },
    {
        "id": "0e3b36c1a5093b41",
        "type": "template",
        "z": "4fd74d0002aa2bc4",
        "name": "JS",
        "field": "js",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "// Bootstrap initialize\n\n$(function () {\n    $('[data-toggle=\"tooltip\"]').tooltip()\n});\n\n// INITIALIZE\n\nvar pages = {{{payload.pages}}};\nvar landingPage = \"{{{payload.landingPage}}}\";\nvar initialLoad = true;\n\nvar rules = {{{payload.rulesStr}}};\n\n\nvar citizenList = [];\nvar _citizenList = `{{{flow.citizenList}}}`;\nif (_citizenList != \"\")\n    citizenList = JSON.parse(_citizenList);\n\n\n//\n/// UI STATE VARS + FUNCTIONS\n//\n\nvar isWorking = false;\nvar hasWorked = false;\n    \nvar pageAccepted = [];\npageAccepted['login'] = false;\npageAccepted['rules'] = false;\npageAccepted['grants'] = false;\n\nvar _loginAccepted = \"{{{flow.loginAccepted}}}\"; if (_loginAccepted == \"true\") togglePageAccept(\"login\");\nvar _rulesAccepted = \"{{{flow.rulesAccepted}}}\"; if (_rulesAccepted == \"true\") togglePageAccept(\"rules\");\nvar _grantsAccepted = \"{{{flow.grantsAccepted}}}\"; if (_grantsAccepted == \"true\") togglePageAccept(\"grants\");\n\nfunction togglePageAccept(page, setAccept = true)\n{\n    var title;\n    switch (page) {\n        case \"login\": title = \"Loginoplysninger\"; break;\n        case \"rules\": title = \"Forretningsregler\"; break;\n        case \"grants\": title = \"Tilskudssatser\"; break;\n    }\n\n    if (setAccept)\n        pageAccepted[page] = !pageAccepted[page];\n\n    if (pageAccepted[page]) {\n        setMenuItemGreen(\"menu_\" + page);\n\n        if (activePage != page)\n            return;\n\n        let pageCap = page.charAt(0).toUpperCase() + page.slice(1);\n        setInnerHTML(\"button\" + pageCap, title + \" godkendt\");\n        setButtonGreen(\"button\" + pageCap);\n        enableGoNext(\"button\" + pageCap + \"_goNext\");\n        document.getElementById(\"toAccept\").value = \"false\";\n    }\n    else {\n        setMenuItemNormal(\"menu_\" + page);\n\n        if (activePage != page)\n            return;\n\n        let pageCap = page.charAt(0).toUpperCase() + page.slice(1);\n        setInnerHTML(\"button\" + pageCap, \"Godkend \" + title.toLowerCase());\n        setButtonNormal(\"button\" + pageCap);\n        disableGoNext(\"button\" + pageCap + \"_goNext\");\n        document.getElementById(\"toAccept\").value = \"true\";\n    }\n}\n\nfunction withdrawPageAccept(page) {\n    if (pageAccepted[page])\n        togglePageAccept(page);\n}\n\n\n\n\n//\n/// ON PAGE LOAD FUNCTIONS\n//\n\nvar loadPageFunc = [];\n\nloadPageFunc[\"rules\"] = function ()\n{    \n    // LOAD rules - update each rule\n    for (let index = 0; index < rules.length; index++)\n    {\n        const element = rules[index];\n\n        const operatorInput = document.getElementById(\"operator_\" + element.uid);\n        var valueInput = document.getElementById(\"value_\" + element.uid);\n        \n        if (element.operator == \"!null\")\n        {\n            setInputBox(element.uid, true);\n            valueInput = document.getElementById(\"value_\" + element.uid);\n        }\n\n        operatorInput.value = element.operator;\n        valueInput.value = element.value;\n    }\n}\n\nloadPageFunc[\"receipts\"] = function ()\n{\n    if(isWorking)\n        visualizeWorkingState();\n\n    else if(hasWorked || citizenList.length > 0)\n        visualizeFinishedState();\n\n    else if (pageAccepted[\"login\"] && pageAccepted[\"rules\"] && pageAccepted[\"grants\"])\n        document.getElementById(\"buttonReceipts\").disabled = false;\n}\n\nloadPageFunc[\"receipts-recommended\"] = function ()\n{\n    if(citizenList.length > 0)\n        loadReceipts();\n}\n\n//\n/// SET PAGE CONTENT FUNCTION\n//\n\nvar activePage = null;\nfunction setPageContent(page, setHistory = true)\n{\n    //console.log(\"Setting page content to page: \" + page);\n    \n    if (pages[page] == null)\n    {\n        setPageContent(\"404\", false);\n        return;\n    }\n    else if (activePage == page)\n        return;\n\n    let menuItem = document.getElementById(\"menu_\" + activePage);\n    menuItem?.classList.remove(\"selected\");\n    menuItem?.classList.remove(\"bg-dark\");\n    menuItem?.classList.add(\"text-primary\");\n    menuItem?.classList.remove(\"text-white\");\n\n    menuItem = document.getElementById(\"menu_\" + page);\n    menuItem?.classList.add(\"selected\");\n    menuItem?.classList.add(\"bg-dark\");\n    menuItem?.classList.remove(\"text-primary\");\n    menuItem?.classList.add(\"text-white\");\n\n    setInnerHTML(\"mainContent\", pages[page]);\n    document.title = \"AutoWorkLet - \" + page;\n\n    if(setHistory)\n        window.history.pushState({ \"page\": page }, \"\", \"/\" + page);\n\n    activePage = page;\n\n    if (page == \"login\" || page == \"rules\" || page == \"grants\")\n        togglePageAccept(page, false);\n\n    if(loadPageFunc[page] != null)\n        loadPageFunc[page]();\n        \n    initialLoad = false;\n\n}\n\n// START / ON LOAD\n\nsetPageContent(landingPage);\n\nwindow.onpopstate = function (e)\n{\n    if (e.state)\n        setPageContent(e.state.page, false);\n};\n\n\n\n//\n/// NODE-RED INTEGRATION / COMMUNICATION\n//\n\nfunction toJSON(...vars)\n{\n    var obj = {};\n\n    for (let i = 0; i < vars.length; i++)\n        obj[vars[i].id] = vars[i].value;\n\n    return obj;\n}\n\nfunction postRequest(object)\n{\n    fetch('/fod/post', {\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(object)\n    })\n        .then(response => response.json())\n        .then(response => handlePostResponse(response))\n        .then(response => console.log(JSON.stringify(response)));\n}\n\n/*\nfunction postIfRequired(object)\n{\n    if (!(object.requestType == \"login\" || object.requestType == \"rules\" || object.requestType == \"grants\"))\n        return;\n\n    if (pageAccepted[object.requestType])\n    {\n        withdrawPageAccept(object.requestType);\n        postRequest({\"requestType\": object.requestType, \"\"})\n    }\n    else \n        postRequest(object);\n}\n*/\nfunction handlePostResponse(responseObject)\n{\n    //console.log(\"Attempting to call response function \" + responseObject.responseFunction);\n    //console.log(\"Function: \" + handleResponseDynamically[responseObject.responseFunction]);\n\n\n    if (handleResponseDynamically[responseObject.responseFunction] != null)\n        handleResponseDynamically[responseObject.responseFunction](responseObject);\n        \n    return responseObject;\n}\n\nvar handleResponseDynamically = [];\n\nhandleResponseDynamically['login'] = function (responseObj)\n{\n    if (responseObj.response)\n        togglePageAccept(\"login\");\n}\n\nhandleResponseDynamically['rules'] = function (responseObj)\n{\n    if (!responseObj.response)\n        return;\n\n    togglePageAccept(\"rules\");\n\n    if(responseObj.rules == null)\n        return;\n        \n    rules = responseObj.rules;\n}\n\nhandleResponseDynamically['grants'] = function (responseObj) {\n    if (responseObj.response)\n        togglePageAccept(\"grants\");\n}\n\nhandleResponseDynamically['receipts'] = function (responseObj) {\n\n\n    citizenList = JSON.parse(responseObj.responseData);\n\n    visualizeWorkingState();\n    isWorking = false;\n\n    /*if (responseObj.responseData != null || citizenList.length <= 0)\n    {\n        // No receipts found\n        return;\n    }*/\n\n    hasWorked = true;\n    visualizeFinishedState();\n\n    //if (responseObj.response)\n    //    console.log(\"Response obj: \" + JSON.stringify(responseObj));\n}\n\n\n//\n/// GENERIC FUNCTIONS\n//\n\nfunction setInnerHTML(objectId, content) {\n    var container = document.getElementById(objectId);\n    container.innerHTML = content;\n}\n\nfunction setStyle(objectId, styleVar, styleValue) {\n    var object = document.getElementById(objectId);\n    object.style[styleVar] = styleValue;\n}\n\n\n\n//\n// PAGE SPECIFIC\n//\n\n// RULES\n\nfunction createRuleJSON(ruleVar)\n{\n    let ruleOperator = document.getElementById(\"operator_\" + ruleVar).value;\n    let ruleValue = document.getElementById(\"value_\" + ruleVar).value;\n    let returnObj = {\n        \"operator\": ruleOperator,\n        \"value\": ruleValue\n    }\n    //console.log(\"Return OBJ: \" + JSON.stringify(returnObj));\n    return returnObj;\n}\n\nfunction setInputBox(uid, truefalse = false)\n{\n    let operator = document.getElementById(\"operator_\" + uid).value;\n    var html = \"\";\n\n    if(operator == \"!null\" || truefalse)\n        html = `<select class=\"form-select\" id=\"value_` + uid +`\" onchange=\"withdrawPageAccept('rules')\">\n                        <option value=\"true\">Ja</option>\n                        <option value=\"false\">Nej</option>\n                </select>\n                <label for=\"value_`+ uid +`\" style=\"padding-left: 27px\">Værdi</label>`;\n    else\n        html = `<input type=\"text\" class=\"form-control\" id=\"value_` + uid +`\" placeholder=\"0\" style=\"color: black\" onchange=\"withdrawPageAccept('rules')\">\n                <label for=\"value_`+ uid +`\" style=\"padding-left: 27px\">Værdi</label>`;\n\n    setInnerHTML(\"inputContainer_\" + uid, html);\n}\n\n// RECEIPTS SEARCH\n\nfunction startSearch()\n{\n    isWorking = true;\n    visualizeWorkingState();\n}\n\nfunction visualizeWorkingState()\n{\n\n    if(activePage = \"receipts\")\n    {\n        var searchButton = document.getElementById(\"buttonReceipts\");\n        searchButton.disabled = true;\n        searchButton.innerHTML = isWorking ? `Søger efter fakturaer &nbsp;<i class=\"fas fa-spinner fa-spin\"></i>` : \n                                             `Søg efter ubehandlede fakturaer`;\n    }\n\n    var receiptsMenuPoint = document.getElementById(\"menu_receipts\");\n    receiptsMenuPoint.innerHTML = isWorking ? `<i class=\"fa fa-book\" aria-hidden=\"true\"></i> Fakturaer &nbsp;<i class=\"fas fa-spinner fa-spin\" style=\"float:right;margin-top:3px\"></i>` :\n                                              `<i class=\"fa fa-book\" aria-hidden=\"true\"></i> Fakturaer`;\n}\n\nfunction visualizeFinishedState()\n{\n    // Update menu visuals\n    //document.getElementById(\"menu_receipts-manual\").classList.remove(\"disabled\");\n    document.getElementById(\"menu_receipts-recommended\").classList.remove(\"disabled\");\n\n    var menu_r_count = citizenList.length;\n\n    //document.getElementById(\"menu_receipts-manual-sub\").innerHTML = \"Der er 0 borgere med fakturaer, som kræver manuel behandling.\";\n    document.getElementById(\"menu_receipts-recommended-sub\").innerHTML = \"Der er \" + menu_r_count + \" borgere med fakturaer, som har anbefalede handlinger. Godkend handlingsplanen for at fortsætte.\";\n\n    document.getElementById(\"menu_receipts-recommended-num\").innerHTML = menu_r_count;\n    //\n\n    var receiptsMenuPoint = document.getElementById(\"menu_receipts\");\n    receiptsMenuPoint.innerHTML = `<i class=\"fa fa-book\" aria-hidden=\"true\"></i> Fakturaer`;\n    \n\n    if(activePage != \"receipts\")\n        return;\n\n    setButtonGreen(\"buttonReceipts\");\n    document.getElementById(\"buttonReceipts\").innerHTML = \"Nye fakturaer blev fundet\";\n\n    enableGoNext(\"buttonReceipts_goNext1\");\n    enableGoNext(\"buttonReceipts_goNext2\");\n}\n\n// RECEIPTS LIST\n\nfunction loadReceipts()\n{\n    if(citizenList.length == 0)\n    {\n        // No receipts found\n        return;\n    }\n\n    var citizenListElement = document.getElementById(\"citizenList\");\n\n    var toPrint = \"\";\n\n    for(var i = 0; i < citizenList.length; i++)\n    {\n        toPrint += citizenObjToHTML(citizenList[i], i);\n    }\n\n    citizenListElement.innerHTML = toPrint;\n    \n}\n\nfunction citizenObjToHTML(citizenObject, count = 0)\n{\n\n    if (!Array.isArray(citizenObject.faktura))\n        citizenObject.faktura = [citizenObject.faktura];\n\n\n    if (!Array.isArray(citizenObject.handlinger))\n        citizenObject.handlinger = [citizenObject.handlinger];\n\n\n\n    /*var tillaegsprocent = Array.isArray(citizenObject.faktura) ?\n                citizenObject.faktura[0]._helbredstillaegsprocent?.tillaegsprocent :\n                citizenObject.faktura._helbredstillaegsprocent?.tillaegsprocent;*/\n\n    var tillaegsprocent = citizenObject.faktura[0]._helbredstillaegsprocent?.tillaegsprocent;\n\n    var returnHTML = `\n    <div class=\"receiptContainer\">\n        <div class=\"card bg-dark text-white citizenCard\" style=\"width: 20rem;\">\n        <div class=\"card-header\">\n            Borger <span style=\"color: lightgray\">#`+ count +`</span>\n\n            <span id=\"togglePop\" onclick=\"togglePop(this)\" class=\"floatr\">\n            <i class=\"fa fa-ellipsis\" aria-hidden=\"true\"></i>\n            <div class=\"popmenu show\">\n                <a href=\"#\">Gå til borger i KP</a>\n            </div>\n            </span>\n\n        </div>\n\n        <div class=\"card-body\">\n            <h4 class=\"card-title\">` + citizenObject.cpr + `<small class=\"text-light\"> - XXXX</small></h4>\n            <!-- p class=\"card-text\">Some quick example text to build on the card title and make up the bulk of the card's content.</p -->\n        \n\n            <table class=\"table no-border\">\n            <tbody>\n    `;\n\n\n    returnHTML += `\n        <tr class=\"table\" style=\"border-top: 1px solid #6E787A!important;\">\n            <th scope=\"row\" class=\"badge\" style=\"text-transform: uppercase` + (!citizenObject.persondata.bevilling ? `;color: lightgray` : ``) + `\"><i class=\"fa fa-` + (citizenObject.persondata.bevilling ? `check` : `x`) + `\" aria-hidden=\"true\" style=\"padding-right: 10px\"></i>\n                <a data-toggle=\"tooltip\" title=\"Borgeren er ` + (!citizenObject.persondata.bevilling ? `IKKE ` : ``) + `bevilget tilskud til fodpleje\" style=\"cursor:default!important\">\n                Bevilget fodpleje\n                </a>\n            </th>\n        </tr>\n        `;\n        \n    for (var i = 0;i < citizenObject.persondata.sager.length;i++)\n    {\n        var isRelevant = false;\n        var isActive = citizenObject.persondata.sager[i].aktiv;\n        switch (citizenObject.persondata.sager[i].type)\n        {\n\n            case \"Udvidet helbredstillæg\":\n\n                if (!(citizenObject.persondata.sager[i].titel.toLowerCase()).includes(\"fod\"))\n                    isActive = false;\n\n            case \"Almindeligt helbredstillæg\":\n            case \"Helbredstillægskort\":\n\n                    isRelevant = true;\n\n                break;\n        }\n\n        if(!isRelevant)\n            continue;\n\n        if (citizenObject.persondata.sager[i].til == undefined)\n            citizenObject.persondata.sager[i].til = \"nu\";\n            \n        returnHTML += `\n        <tr class=\"table\" style=\"border-top: 1px solid #6E787A!important;\">\n            <th scope=\"row\" class=\"badge\" style=\"text-transform: uppercase` + (!isActive ? `;color: lightgray` : ``) + `\"><i class=\"fa fa-` + (isActive ? `check` : `x`) + `\" aria-hidden=\"true\" style=\"padding-right: 10px\"></i>\n                <a data-toggle=\"tooltip\" title=\"` + citizenObject.persondata.sager[i].titel.split(\"(\")[0] + ` (` + citizenObject.persondata.sager[i].fra + ` - ` + citizenObject.persondata.sager[i].til + `)\" style=\"cursor:default!important\">\n                ` + citizenObject.persondata.sager[i].type + `\n                </a>\n            </th>\n        </tr>\n        `;\n    }\n                \n    returnHTML += `\n            </tbody>\n            </table>\n\n            \n            <div style=\"display:flex;gap:10px;justify-content:space-around\">\n\n            <div style=\"display:flex;flex-direction:column;\">\n\n                <span class=\"badge\">FORMUE</span>\n                <span style=\"text-align:center\">\n                <a data-toggle=\"tooltip\" style=\"cursor:default!important\">\n                    ` + citizenObject.persondata.formue + ` kr\n                </a>\n                </span>\n\n            </div>\n            <div style=\"display:flex;flex-direction:column;\">\n\n                <span class=\"badge\">DANMARK</span>\n                <span style=\"text-align:center\">\n                <a data-toggle=\"tooltip\" style=\"cursor:default!important\">\n                    ` + (citizenObject.persondata.danmarkgruppe == 0 ? `Ikke medlem` : `Gruppe ` + citizenObject.persondata.danmarkgruppe) + `\n                </a>\n                </span>\n\n            </div>\n            <div style=\"display:flex;flex-direction:column;\">\n\n                <span class=\"badge\">TILLÆG</span>\n                <span style=\"text-align:center\">\n                <a data-toggle=\"tooltip\" style=\"cursor:default!important\">\n                    ` + tillaegsprocent + `%\n                </a>\n                </span>\n\n            </div>\n            </div>\n\n\n        </div>\n        </div>\n\n        <div style=\"flex-grow: 2\">`;\n\n\n        for (var i = 0; i < citizenObject.faktura.length; i++)\n        {\n            \n            if (!Array.isArray(citizenObject.faktura[i].behandlinger))\n                citizenObject.faktura[i].behandlinger = [citizenObject.faktura[i].behandlinger];\n\n            returnHTML += `\n            <div class=\"card border-secondary mb-1\">\n                <div class=\"card-header\">\n                Faktura <span class=\"text-muted\">#` + (i+1) + `</span>\n                <span id=\"togglePop\" onclick=\"togglePop(this)\" class=\"floatr\">\n                    <i class=\"fa fa-ellipsis\" aria-hidden=\"true\"></i>\n                    <div class=\"popmenu show\">\n                        <a href=\"https://workletnew.snapp.dk/receipts/` + citizenObject.faktura[i].id + `\" target=\"_blank\">Åbn faktura i WorkLet</a>\n                    </div>\n                </span>\n                </div>\n                <div class=\"card-body\" style=\"padding-top: 0px!important;padding-bottom: 0px!important\">\n                \n                <table class=\"table\">\n                    <thead class=\"no-border\">\n                    <tr>\n                        <th><span class=\"badge text-dark\">#</span></th>\n                        <th style=\"width: 40%\"><span class=\"badge text-dark\">YDELSE</span></th>\n                        <th><span class=\"badge text-dark\" style=\"text-align: right\">SYGESIKRINGSANDEL</span></th>\n                        <th><span class=\"badge text-dark\" style=\"text-align: right\">PATIENTANDEL</span></th>\n                        <th><span class=\"badge text-dark\" style=\"text-align: right\">HONORAR</span></th>\n                    </tr>\n                    </thead>\n                    <tbody>\n                    `;\n\n                for (var j = 0; j < citizenObject.faktura[i].behandlinger.length; j++)\n                {\n                    returnHTML += `\n                    <tr>\n                        <th>` + citizenObject.faktura[i].behandlinger[j].ydelsesnummer + `</th>\n                        <td>` + citizenObject.faktura[i].behandlinger[j].titel + `</td>\n                        <td style=\"text-align: right\">` + citizenObject.faktura[i].behandlinger[j].sygesikringsAndel + ` kr</td>\n                        <td style=\"text-align: right\">` + citizenObject.faktura[i].behandlinger[j].patientAndel + ` kr</td>\n                        <td style=\"text-align: right\"><strong>` + citizenObject.faktura[i].behandlinger[j].pris + ` kr</strong></td>\n                    </tr>\n                    `;\n                }\n                    \n            returnHTML +=\n                    `\n                    </tbody>\n                </table>\n\n                </div>\n            </div>`;\n\n            for (var k = 0; k < citizenObject.handlinger.length; k++)\n            {\n                if (citizenObject.handlinger[k] != undefined && citizenObject.faktura[i].id == citizenObject.handlinger[k].fid)\n                    returnHTML += `<div class=\"card mb-2 text-white bg-info\" style=\"margin-left: 20px;display:flex;flex-direction:row\">\n                        <div class=\"card-header no-border-bottom\" style=\"width:20%;border-right: 1px solid rgba(0,0,0,0.125)\">Handling  <span style=\"color:lightgray\">#` + (k + 1) + `</span></div>\n                        <div style=\"align-self: center;padding-left:10px\">` + citizenObject.handlinger[k].handling +\n                            (citizenObject.handlinger[k].tilskud != null ? ` - tilskud gives: ` + citizenObject.handlinger[k].tilskud + ` kr` :\n                                                                           ` - type ` + citizenObject.handlinger[k].type ) + `</div>\n                    </div>`;\n\n            }\n        }\n        \n        returnHTML += `\n                \n            </div>\n        </div><!-- /receiptContainer -->`;\n\n    return returnHTML;\n}\n\n\n\n//\n// VISUAL\n//\n\nfunction enableGoNext(objectId)\n{\n    var button = document.getElementById(objectId);\n\n    if (!button.classList.contains(\"collapsed\"))\n        return;\n\n    button.classList.remove(\"collapsed\");\n}\nfunction disableGoNext(objectId)\n{\n    var button = document.getElementById(objectId);\n\n    if (button.classList.contains(\"collapsed\"))\n        return;\n\n    button.classList.add(\"collapsed\");\n}\n\nfunction setButtonGreen(objectId)\n{\n    var button = document.getElementById(objectId);\n\n    if (button.classList.contains(\"btn-success\"))\n        return;\n    \n    button.classList.remove(\"btn-primary\");\n    button.classList.add(\"btn-success\");\n}\n\nfunction setButtonNormal(objectId)\n{\n    var button = document.getElementById(objectId);\n\n    if (button.classList.contains(\"btn-primary\"))\n        return;\n\n    button.classList.remove(\"btn-success\");\n    button.classList.add(\"btn-primary\");\n}\n\nfunction setMenuItemGreen(objectId)\n{\n    var menuItem = document.getElementById(objectId);\n\n    if(menuItem.classList.contains(\"success\"))\n        return;\n\n    menuItem.classList.add(\"success\");\n\n}\nfunction setMenuItemNormal(objectId)\n{\n    var menuItem = document.getElementById(objectId);\n\n    if (!menuItem.classList.contains(\"success\"))\n        return;\n\n    menuItem.classList.remove(\"success\");\n}\n\nfunction toggleListItemActive(objectId)\n{\n    var listItem = document.getElementById(objectId);\n    listItem.classList.toggle(\"text-primary\");\n    listItem.classList.toggle(\"disabled\");\n}\n\n\n\n\nfunction togglePop(element) {\n    element.classList.toggle(\"show\");\n}\n\n\n\n//\n/// BS functions\n//\nfunction toggleCollapse(objectId)\n{\n    var obj = document.getElementById(objectId);\n\n    if(obj.classList.contains(\"collapse\"))\n        obj.classList.toggle(\"show\");\n\n}\n\n\n\n// LATE START / INITIALIZATION\n\nif (citizenList.length > 0)\n    hasWorked = true;\n\nif (hasWorked)\n    visualizeFinishedState();",
        "output": "str",
        "x": 550,
        "y": 920,
        "wires": [
            [
                "75be0ea8650cbce8"
            ]
        ]
    },
    {
        "id": "5053a803d27c1fe2",
        "type": "http response",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1890,
        "y": 260,
        "wires": []
    },
    {
        "id": "1780f86ded366e2b",
        "type": "comment",
        "z": "4fd74d0002aa2bc4",
        "name": "POST requests",
        "info": "",
        "x": 180,
        "y": 120,
        "wires": []
    },
    {
        "id": "6ab92f730d3b3707",
        "type": "debug",
        "z": "4fd74d0002aa2bc4",
        "name": "POST Obj",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 170,
        "y": 60,
        "wires": []
    },
    {
        "id": "123e842d49d96b66",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "Set response",
        "rules": [
            {
                "t": "set",
                "p": "tempVar",
                "pt": "msg",
                "to": "payload.requestType",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.responseFunction",
                "pt": "msg",
                "to": "tempVar",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.response",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "delete",
                "p": "tempVar",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 990,
        "y": 140,
        "wires": [
            [
                "919795f739e39ca4"
            ]
        ]
    },
    {
        "id": "9dbc32c65601cf69",
        "type": "switch",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "property": "payload.requestType",
        "propertyType": "msg",
        "rules": [
            {
                "t": "regex",
                "v": "login|grants",
                "vt": "str",
                "case": false
            },
            {
                "t": "eq",
                "v": "rules",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "receipts",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 3,
        "x": 430,
        "y": 180,
        "wires": [
            [
                "5e4531e07ede8e9b"
            ],
            [
                "87f274742c5ed818"
            ],
            [
                "d22d69bd6285aa94"
            ]
        ]
    },
    {
        "id": "5e45632260383910",
        "type": "comment",
        "z": "4fd74d0002aa2bc4",
        "name": "Switch on type of request",
        "info": "",
        "x": 490,
        "y": 120,
        "wires": []
    },
    {
        "id": "569cacb45b532605",
        "type": "debug",
        "z": "4fd74d0002aa2bc4",
        "name": "Response Obj",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1920,
        "y": 200,
        "wires": []
    },
    {
        "id": "6c7dc7757cce4e94",
        "type": "template",
        "z": "4fd74d0002aa2bc4",
        "name": "Login",
        "field": "payload.pages.login",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">Loginoplysninger</div>\n    <div class=\"card-body\">\n        <h6 class=\"card-subtitle mb-2 text-muted\">WorkLet loginoplysninger</h6>\n        <p class=\"card-text\">Før du kan søge efter fakturaer, skal du indtaste kommunens loginoplysninger til WorkLet.</p>\n        \n        <div class=\"form-group\">\n            <input type=\"hidden\" id=\"requestType\" value=\"login\">\n            <input type=\"hidden\" id=\"toAccept\" value=\"true\">\n            \n            <div class=\"form-floating mb-3\">\n            <input type=\"text\" class=\"form-control\" id=\"workletUser\" placeholder=\"name@example.com\" onchange=\"withdrawPageAccept('login')\" autocomplete=\"off\">\n            <label for=\"workletUser\">Email addresse</label>\n            </div>\n            <div class=\"form-floating\">\n            <input type=\"text\" class=\"form-control\" id=\"workletPass\" placeholder=\"Password\" onchange=\"withdrawPageAccept('login')\" style=\"font-family: 'password'\">\n            <label for=\"workletPass\">Kodeord</label>\n            </div>\n            \n        </div>\n\n    </div>\n</div>\n\n\n<button class=\"btn btn-lg btn-primary\" id=\"buttonLogin\" type=\"button\" onload=\"checkIfAccepted('login')\" onclick=\"postRequest(toJSON(document.getElementById('requestType'), document.getElementById('toAccept'), document.getElementById('workletUser'), document.getElementById('workletPass')))\">\n    Godkend loginoplysninger\n</button>\n\n<button class=\"btn btn-lg btn-primary ml-2 goNext collapsed\" id=\"buttonLogin_goNext\" type=\"button\" onclick=\"setPageContent('rules')\">\n    Gå til forretningsregler\n</button>",
        "output": "str",
        "x": 150,
        "y": 860,
        "wires": [
            [
                "4512dee0f4799a12"
            ]
        ]
    },
    {
        "id": "324ded5420115899",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.pages",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 635,
        "y": 620,
        "wires": [
            [
                "02571a4fc1c6d917"
            ]
        ],
        "l": false
    },
    {
        "id": "025f9d87a38e0ab0",
        "type": "json",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "property": "payload.pages",
        "action": "str",
        "pretty": false,
        "x": 430,
        "y": 920,
        "wires": [
            [
                "0e3b36c1a5093b41"
            ]
        ]
    },
    {
        "id": "4512dee0f4799a12",
        "type": "template",
        "z": "4fd74d0002aa2bc4",
        "name": "Forretningsregler",
        "field": "payload.pages.rules",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">Forretningsregler</div>\n    <div class=\"card-body\">\n        <h6 class=\"card-subtitle mb-2 text-muted\">Sæt kriterier for tilskud</h6>\n        <p class=\"card-text\">Kontrollér/sæt og derefter godkendt forretningsreglerne som robotten benytter som beslutningsgrundlag.</p>\n\n        <div class=\"mt-3 border-bottom\" style=\"padding-left: 15px;padding-right: 15px\">\n            <input type=\"hidden\" id=\"requestType\" value=\"rules\">\n            <input type=\"hidden\" id=\"toAccept\" value=\"true\">\n            \n            {{#payload.rules}}\n            <div class=\"row border-top pb-2 pt-2 \">\n\n\n                <div class=\"col-2 d-flex flex-column justify-content-center\">\n                    <span>{{name}}</span>\n                </div>\n\n                <div class=\"form-floating col\">\n                    <select class=\"form-select\" id=\"operator_{{uid}}\" onchange=\"setInputBox('{{uid}}');withdrawPageAccept('rules')\">\n                        <option value=\"==\">= Skal være lig med</option>\n                        <option value=\"!=\">≠ Må ikke være lig med</option>\n                        <option value=\"<\">< Skal være mindre end</option>\n                        <option value=\">\">> Skal være større end</option>\n                        <option value=\"contains\">{?} Indeholder</option>\n                        <option value=\"!contains\">{!} Indeholder ikke</option>\n                        <option value=\"!null\">[o] Skal være oplyst</option>\n                    </select>\n                    <label for=\"operator_{{uid}}\" style=\"padding-left: 27px\">Logisk beregningsmetode</label>\n                </div>\n\n                <div class=\"form-floating col\" id=\"inputContainer_{{uid}}\">\n                    <input type=\"text\" class=\"form-control\" id=\"value_{{uid}}\" placeholder=\"0\" value=\"{{value}}\" onchange=\"withdrawPageAccept('rules')\">\n                    <label for=\"value_{{uid}}\" style=\"padding-left: 27px\">Værdi</label>\n                </div>\n\n\n            </div>\n            {{/payload.rules}}\n\n        </div>\n\n    </div>\n</div>\n\n<button class=\"btn btn-lg btn-primary\" id=\"buttonRules\" type=\"button\" onclick=\"postRequest(toJSON(document.getElementById('requestType'),document.getElementById('toAccept'){{#payload.rules}},{ 'id': '{{uid}}', 'value': createRuleJSON('{{uid}}') }{{/payload.rules}}))\">\n    Godkend forretningsregler\n</button>\n\n<button class=\"btn btn-lg btn-primary ml-2 goNext collapsed\" id=\"buttonRules_goNext\" type=\"button\" onclick=\"setPageContent('grants')\">\n    Gå til tilskudssatser\n</button>",
        "output": "str",
        "x": 190,
        "y": 900,
        "wires": [
            [
                "106319be762a8105"
            ]
        ]
    },
    {
        "id": "0fb56661e01c4c8a",
        "type": "http in",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "url": "/:page",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 620,
        "wires": [
            [
                "7f0f53a5ddc0b562"
            ]
        ]
    },
    {
        "id": "7f0f53a5ddc0b562",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.landingPage",
                "pt": "msg",
                "to": "req.params.page",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 390,
        "y": 620,
        "wires": [
            [
                "324ded5420115899"
            ]
        ]
    },
    {
        "id": "a583e16fda76e4d4",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.landingPage",
                "pt": "msg",
                "to": "login",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 390,
        "y": 580,
        "wires": [
            [
                "324ded5420115899"
            ]
        ]
    },
    {
        "id": "b81345536857260d",
        "type": "template",
        "z": "4fd74d0002aa2bc4",
        "name": "404",
        "field": "payload.pages.404",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<h4>Siden blev ikke fundet</h4>",
        "output": "str",
        "x": 150,
        "y": 820,
        "wires": [
            [
                "6c7dc7757cce4e94"
            ]
        ]
    },
    {
        "id": "106319be762a8105",
        "type": "template",
        "z": "4fd74d0002aa2bc4",
        "name": "Tilskudssatser",
        "field": "payload.pages.grants",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n  <div class=\"card-header\">Tilskudssatser</div>\n  <div class=\"card-body\">\n      <h6 class=\"card-subtitle mb-2 text-muted\">Sæt tilskudssatser fra Danmark</h6>\n      <p class=\"card-text\">Kontrollér/sæt og derefter godkendt tilskudssatserne som robotten fratrækker under tilskudsberegningen.</p>\n      \n        <div class=\"mt-3 border-bottom\" style=\"padding-left: 15px;padding-right: 15px\">\n            <input type=\"hidden\" id=\"requestType\" value=\"grants\">\n            <input type=\"hidden\" id=\"toAccept\" value=\"true\">\n\n        </div>\n\n  </div>\n</div>\n\n<button class=\"btn btn-lg btn-primary\" id=\"buttonGrants\" type=\"button\" onclick=\"postRequest(toJSON(document.getElementById('requestType'),document.getElementById('toAccept')))\">\n    Godkend tilskudssatser\n</button>\n\n<button class=\"btn btn-lg btn-primary ml-2 goNext collapsed\" id=\"buttonGrants_goNext\" type=\"button\" onclick=\"setPageContent('receipts')\">\n    Gå til fakturaer\n</button>",
        "output": "str",
        "x": 180,
        "y": 940,
        "wires": [
            [
                "f90cdacea6132c58"
            ]
        ]
    },
    {
        "id": "0a70d4edc004c19f",
        "type": "template",
        "z": "4fd74d0002aa2bc4",
        "name": "Rules JS",
        "field": "payload.scripts.rules",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "plain",
        "template": "const ruleWrapper_system = document.querySelector(\".ruleWrapper_system\");\nconst ruleWrapper_user = document.querySelector(\".ruleWrapper_user\");\n\nconst rules = _rules != null ? _rules : []; // Rules are defined in change node previous to this\n\nconst operators = [\n    {\n        \"name\": \"= Skal være lig med\",\n        \"value\": \"==\"\n    },\n    {\n        \"name\": \"≠ Må ikke være lig med\",\n        \"value\": \"!=\"\n    },\n    {\n        \"name\": \"< Skal være mindre end\",\n        \"value\": \"<\"\n    },\n    {\n        \"name\": \"> Skal være større end\",\n        \"value\": \">\"\n    },\n    {\n        \"name\": \"{?} Indeholder\",\n        \"value\": \"contains\"\n    },\n    {\n        \"name\": \"{!} Indeholder ikke\",\n        \"value\": \"!contains\"\n    },\n    {\n        \"name\": \"[o] Skal være oplyst\",\n        \"value\": \"!null\"\n    }\n]\n\n\nfunction newSelector(selectedValue) {\n    return `\n    `;\n}\n\nfunction newInputField(index) {\n    const obj = rules[index];\n    let returnHTML = `\n        <div${obj.systemrule == true ? \" class=\\\"disabled\\\"\" : \"\"}>\n        <span>${obj.name}:</span>\n        <div class=\"spacing\">&nbsp;</div>\n        <div>    \n            <select id=\"input_${index}_operator\"${obj.systemrule == true ? \" disabled=\\\"disabled\\\"\" : \"\"}>\n        `;\n\n    for (let i = 0; i < operators.length; i++) {\n        let isSelected = obj.operator == operators[i].value;\n        //console.log(\"Checking '\" + obj.operator + \"' against '\" + operators[i].value + \"' = \" + isSelected);\n        returnHTML += `<option value=\"${operators[i].value}\"${isSelected ? \" selected\" : \"\"}>${operators[i].name}</option>`;\n    }\n\n    let valueType = obj.type == \"number\" || obj.type == \"text\" ? `<span class=\"valuetype\">${obj.type == \"number\" ? \"tal\" : obj.type == \"text\" ? \"tekst\" : \"\"}</span>` : ``;\n    returnHTML += `\n            </select>\n        </div>\n        <div>\n            <input id=\"input_${index}_value\" value=\"${obj.value}\"${obj.systemrule == true ? \" disabled=\\\"disabled\\\"\" : \"\"} />\n        </div>\n        ${valueType}\n        <span class=\"description\" title=\"${obj.description}\">?</span>\n        </div>\n    `;\n    return returnHTML;\n}\n\n///\n// Instantiate input fields\n\nfor (let i = 0; i < rules.length; i++)\n    if (rules[i][\"systemrule\"] != null && rules[i][\"systemrule\"] == true)\n        ruleWrapper_system.innerHTML += newInputField(i);\n    else\n        ruleWrapper_user.innerHTML += newInputField(i);\n\n///\n// Dynamically add event listeners \n\nfor (let i = 0; i < rules.length; i++) {\n    document.querySelector(\"#input_\" + i + \"_operator\").addEventListener(\"focusout\", () => {\n        UpdateValue(document.querySelector(\"#input_\" + i + \"_operator\"));\n    });\n\n    document.querySelector(\"#input_\" + i + \"_value\").addEventListener(\"focusout\", () => {\n        UpdateValue(document.querySelector(\"#input_\" + i + \"_value\"));\n    });\n\n    document.querySelector(\"#input_\" + i + \"_value\").addEventListener(\"input\", () => {\n        OnInputChange(document.querySelector(\"#input_\" + i + \"_value\"));\n    });\n}\n\n///\n// Update input value\nfunction UpdateValue(inputField) {\n    let id = inputField.id;\n    let sid = id.split(\"_\");\n\n    (rules[parseInt(sid[1])])[sid[2]] = inputField.value;\n\n    const message = rules;\n\n    //PublishRules(JSON.stringify(message));\n    //console.log(message);\n}\n\n///\n//\nfunction OnInputChange(inputField) {\n    let id = inputField.id;\n    let sid = id.split(\"_\");\n    let type = (rules[parseInt(sid[1])])[\"type\"];\n\n    switch (type) {\n        case \"int\": case \"float\": case \"double\": case \"number\":\n            inputField.value = inputField.value.replace(/[^0-9.]/g, '').replace(/(\\..*?)\\..*/g, '$1');\n            break;\n\n        case \"text\": case \"letters\":\n            inputField.value = inputField.value.replace(/[^A-Za-z ]/g, '');\n            break;\n\n    }\n}",
        "x": 1380,
        "y": 320,
        "wires": [
            []
        ]
    },
    {
        "id": "aa9a520ddc5d35af",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "New rule template",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "[\t    {\t        \"uid\": \"formuegraense\",\t        \"name\": \"Formue\",\t        \"variable\": \"formue\",\t        \"operator\": \"<\",\t        \"value\": 93000,\t        \"type\": \"number\",\t        \"description\": \"Borgerens formue skal følge denne regel\",\t        \"error\": \"Borgerens formue bryder formue-reglen\"\t    },\t    {\t        \"uid\": \"formueoplyst\",\t        \"name\": \"Formue\",\t        \"variable\": \"formue\",\t        \"operator\": \"!null\",\t        \"value\": true,\t        \"type\": \"bool\",\t        \"description\": \"Borgerens formue skal være oplyst til UDK\",\t        \"isSystemRule\": true\t    }\t]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.rulesStr",
                "pt": "msg",
                "to": "rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 370,
        "y": 740,
        "wires": [
            [
                "10143527a5849a63"
            ]
        ]
    },
    {
        "id": "ec5733c98c66b003",
        "type": "json",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "property": "payload.rules",
        "action": "obj",
        "pretty": false,
        "x": 810,
        "y": 740,
        "wires": [
            [
                "237d8785c07228e9"
            ]
        ]
    },
    {
        "id": "f32b827c0ca8c057",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "Load rules",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "#:(storeInFile)::rules",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "payload.rulesStr",
                "pt": "msg",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 350,
        "y": 700,
        "wires": [
            [
                "62c11658d7cda4de"
            ]
        ]
    },
    {
        "id": "02571a4fc1c6d917",
        "type": "switch",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "property": "#:(storeInFile)::rules",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 150,
        "y": 720,
        "wires": [
            [
                "f32b827c0ca8c057"
            ],
            [
                "aa9a520ddc5d35af"
            ]
        ]
    },
    {
        "id": "10143527a5849a63",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::rules",
                "pt": "global",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 580,
        "y": 740,
        "wires": [
            [
                "ec5733c98c66b003"
            ]
        ]
    },
    {
        "id": "cfcc85731bd7e8ce",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "Set flow boolean",
        "rules": [
            {
                "t": "set",
                "p": "loginAccepted",
                "pt": "flow",
                "to": "payload.toAccept",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1010,
        "y": 180,
        "wires": [
            []
        ]
    },
    {
        "id": "387947d728b54cb7",
        "type": "comment",
        "z": "4fd74d0002aa2bc4",
        "name": "Accept login / grants",
        "info": "",
        "x": 790,
        "y": 100,
        "wires": []
    },
    {
        "id": "9a5d069ee493df33",
        "type": "comment",
        "z": "4fd74d0002aa2bc4",
        "name": "(set) rules",
        "info": "",
        "x": 760,
        "y": 240,
        "wires": []
    },
    {
        "id": "87f274742c5ed818",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "Set flow boolean",
        "rules": [
            {
                "t": "set",
                "p": "rulesAccepted",
                "pt": "flow",
                "to": "payload.toAccept",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 280,
        "wires": [
            [
                "893b4a053c83de51"
            ]
        ]
    },
    {
        "id": "893b4a053c83de51",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "Load rules",
        "rules": [
            {
                "t": "delete",
                "p": "payload.requestType",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "tempPayload",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.ruleChanges",
                "pt": "msg",
                "to": "tempPayload",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "tempPayload",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "#:(storeInFile)::rules",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 990,
        "y": 280,
        "wires": [
            [
                "fcffca3de5c4448e"
            ]
        ]
    },
    {
        "id": "fcffca3de5c4448e",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "Merge changes",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "$.payload.rules ~> | $ |\t(\t\t\t$ruleChange := $lookup($$.payload.ruleChanges, uid);\t\t{\t        \"operator\": $ruleChange.operator,\t        \"value\": $ruleChange.value\t})\t\t|",
                "tot": "jsonata"
            },
            {
                "t": "delete",
                "p": "payload.ruleChanges",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "payload.rules @$r .(\t\t$getType := function($value, $operator)\t{\t    ($value[$ ~> /^[0-9\\.]{1,}$/m] ~> $boolean) ?\t        \"number\" :\t    ($operator = \"!null\") ? \t        \"bool\"\t};\t\t{\t    \t    \"uid\": $r.uid,\t    \"name\": $r.name,\t    \"variable\": $r.variable,\t    \"operator\": $r.operator,\t    \"value\": $r.value,\t    \"type\": $getType($r.value, $r.operator),\t    \"description\": $r.description,\t    \"isSystemRule\": $r.isSystemRule\t    \t}\t)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "$.payload.rules ~> | $ |\t{\t    \"value\": \t        type = \"number\" ?\t            value ~> $number() \t            :\t            value  \t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1180,
        "y": 280,
        "wires": [
            [
                "38e171811e1f3b86"
            ]
        ]
    },
    {
        "id": "38e171811e1f3b86",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::rules",
                "pt": "global",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1380,
        "y": 280,
        "wires": [
            [
                "396555b6e31f5624"
            ]
        ]
    },
    {
        "id": "396555b6e31f5624",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "Set response",
        "rules": [
            {
                "t": "set",
                "p": "payload.responseFunction",
                "pt": "msg",
                "to": "rules",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "payload.response",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "delete",
                "p": "payload.ruleChanges",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1570,
        "y": 280,
        "wires": [
            [
                "53c070f3a6e4c909"
            ]
        ]
    },
    {
        "id": "237d8785c07228e9",
        "type": "json",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "property": "payload.rulesStr",
        "action": "str",
        "pretty": false,
        "x": 930,
        "y": 740,
        "wires": [
            [
                "b81345536857260d"
            ]
        ]
    },
    {
        "id": "5e4531e07ede8e9b",
        "type": "function",
        "z": "4fd74d0002aa2bc4",
        "name": "Set flow boolean",
        "func": "flow.set(msg.payload.requestType + \"Accepted\", msg.payload.toAccept);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 140,
        "wires": [
            [
                "123e842d49d96b66"
            ]
        ]
    },
    {
        "id": "f90cdacea6132c58",
        "type": "template",
        "z": "4fd74d0002aa2bc4",
        "name": "Fakturaer",
        "field": "payload.pages.receipts",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">Fakturaer</div>\n    <div class=\"card-body\">\n        <h6 class=\"card-subtitle mb-2 text-muted\">Automatiseret behandling af WorkLet fakturaer</h6>\n        <p class=\"card-text\">Efter at have godkendt loginoplysninger, forretningsregler samt tilskudssatser, kan du her søge efter ubehandlede fakturaer. Robotten henter automatisk fakturaer fra WorkLet og beregner anbefalede handlinger baseret på forretningsreglerne samt tilskudssatserne fra Danmark.</p>\n\n    </div>\n</div>\n            \n<input type=\"hidden\" id=\"requestType\" value=\"receipts\">\n\n<button class=\"btn btn-lg btn-primary\" id=\"buttonReceipts\" type=\"button\" onclick=\"postRequest(toJSON(document.getElementById('requestType')));startSearch();\" disabled>\n    Søg efter ubehandlede fakturaer\n</button>\n\n<button class=\"btn btn-lg btn-primary ml-2 goNext collapsed\" id=\"buttonReceipts_goNext1\" type=\"button\" onclick=\"setPageContent('receipts-manual')\">\n    Gå til manuel behandling\n</button>\n\n<button class=\"btn btn-lg btn-primary ml-2 goNext collapsed\" id=\"buttonReceipts_goNext2\" type=\"button\" onclick=\"setPageContent('receipts-recommended')\">\n    Gå til anbefalede handlinger\n</button>",
        "output": "str",
        "x": 160,
        "y": 980,
        "wires": [
            [
                "4e5fef131ac617bb"
            ]
        ]
    },
    {
        "id": "4e5fef131ac617bb",
        "type": "template",
        "z": "4fd74d0002aa2bc4",
        "name": "Fakturaer - Anbefalede handlinger",
        "field": "payload.pages.receipts-recommended",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header no-border-bottom\">Fakturaer - Anbefalede handlinger</div>\n</div>\n\n<div id=\"citizenList\">\n\n<div class=\"receiptContainer\">\n  \n      <div class=\"card bg-dark text-white citizenCard\" style=\"width: 20rem;\">\n        <div class=\"card-header\">\n          Borger\n\n          <span id=\"togglePop\" onclick=\"togglePop(this)\" class=\"floatr\">\n            <i class=\"fa fa-ellipsis\" aria-hidden=\"true\"></i>\n            <div class=\"popmenu show\">\n                <a href=\"#\">Gå til borger i KP</a>\n            </div>\n          </span>\n\n        </div>\n\n        <div class=\"card-body\">\n          <h4 class=\"card-title\">240194<small class=\"text-light\"> - XXXX</small></h4>\n          <!-- p class=\"card-text\">Some quick example text to build on the card title and make up the bulk of the card's content.</p -->\n        \n\n          <table class=\"table no-border\">\n            <tbody>\n\n              <tr class=\"table\" style=\"border-top: 1px solid #6E787A!important;\">\n                <th scope=\"row\" class=\"badge\" style=\"text-transform: uppercase\"><i class=\"fa fa-check\" aria-hidden=\"true\" style=\"padding-right: 10px\"></i>\n                  <a data-toggle=\"tooltip\" title=\"Borgeren er bevilget tilskud til fodpleje\" style=\"cursor:default!important\">\n                    Bevilget fodpleje\n                  </a>\n                </th>\n              </tr>\n\n              <tr class=\"table\" style=\"border-top: 1px solid #6E787A!important;\">\n                <th scope=\"row\" class=\"badge\" style=\"text-transform: uppercase;color:lightgray\"><i class=\"fa fa-x\" aria-hidden=\"true\" style=\"padding-right: 10px\"></i>\n                  <a data-toggle=\"tooltip\" title=\"Ingen gyldig sag foreligger\" style=\"cursor:default!important\">\n                    Udvidet helbredstillæg\n                  </a>\n                </th>\n              </tr>\n\n              <tr class=\"table\" style=\"border-top: 1px solid #6E787A!important;\">\n                <th scope=\"row\" class=\"badge\" style=\"text-transform: uppercase\"><i class=\"fa fa-check\" aria-hidden=\"true\" style=\"padding-right: 10px\"></i>\n                  <a data-toggle=\"tooltip\" title=\"20-06/2022 - 19-06/2023\" style=\"cursor:default!important\">\n                    Alm. helbredstillæg\n                  </a>\n                </th>\n              </tr>\n\n              <tr class=\"table\" style=\"border-top: 1px solid #6E787A!important;border-bottom: 1px solid #6E787A!important\">\n                <th scope=\"row\" class=\"badge\" style=\"text-transform: uppercase\"><i class=\"fa fa-check\" aria-hidden=\"true\" style=\"padding-right: 10px\"></i>\n                  <a data-toggle=\"tooltip\" title=\"20-06/2022 - 19-06/2023\" style=\"cursor:default!important\">\n                    Helbredskort\n                  </a>\n                </th>\n              </tr>\n\n            </tbody>\n          </table>\n\n          \n          <div style=\"display:flex;gap:10px;justify-content:space-around\">\n\n            <div style=\"display:flex;flex-direction:column;\">\n\n              <span class=\"badge\">FORMUE</span>\n              <span style=\"text-align:center\">\n                <a data-toggle=\"tooltip\" title=\"20-10/2022\" style=\"cursor:default!important\">\n                  27.345 kr\n                </a>\n              </span>\n\n            </div>\n            <div style=\"display:flex;flex-direction:column;\">\n\n              <span class=\"badge\">DANMARK</span>\n              <span style=\"text-align:center\">\n                <a data-toggle=\"tooltip\" title=\"20-10/2022\" style=\"cursor:default!important\">\n                  Gruppe 5\n                </a>\n              </span>\n\n            </div>\n            <div style=\"display:flex;flex-direction:column;\">\n\n              <span class=\"badge\">TILLÆG</span>\n              <span style=\"text-align:center\">\n                <a data-toggle=\"tooltip\" title=\"20-10/2022\" style=\"cursor:default!important\">\n                  85%\n                </a>\n              </span>\n\n            </div>\n          </div>\n\n\n        </div>\n      </div>\n\n      <div style=\"flex-grow: 2;height:500px\">\n\n        <div class=\"card border-secondary mb-1\">\n          <div class=\"card-header\">\n            Faktura\n            <span id=\"togglePop\" onclick=\"togglePop(this)\" class=\"floatr\">\n              <i class=\"fa fa-ellipsis\" aria-hidden=\"true\"></i>\n              <div class=\"popmenu show\">\n                  <a href=\"#\">Åbn faktura i WorkLet</a>\n              </div>\n            </span>\n            </div>\n          <div class=\"card-body\" style=\"padding-top: 0px!important;padding-bottom: 0px!important\">\n            \n            <table class=\"table\">\n              <thead class=\"no-border\">\n                <tr>\n                  <th><span class=\"badge text-dark\">#</span></th>\n                  <th style=\"width: 40%\"><span class=\"badge text-dark\">YDELSE</span></th>\n                  <th><span class=\"badge text-dark\" style=\"text-align: right\">SYGESIKRINGSANDEL</span></th>\n                  <th><span class=\"badge text-dark\" style=\"text-align: right\">PATIENTANDEL</span></th>\n                  <th><span class=\"badge text-dark\" style=\"text-align: right\">HONORAR</span></th>\n                </tr>\n              </thead>\n              <tbody>\n                <tr>\n                  <th>001</th>\n                  <td>Behandling i patientens eget hjem</td>\n                  <td style=\"text-align: right\">0 kr</td>\n                  <td style=\"text-align: right\">450 kr</td>\n                  <td style=\"text-align: right\"><strong>450 kr</strong></td>\n                </tr>\n              </tbody>\n            </table>\n\n          </div>\n        </div>\n\n        <div class=\"card mb-2 text-white bg-info\" style=\"margin-left: 20px;display:flex;flex-direction:row\">\n          <div class=\"card-header no-border-bottom\" style=\"width:20%;border-right: 1px solid rgba(0,0,0,0.125)\">Handling</div>\n          <div style=\"align-self: center;padding-left:10px\">Sag oprettes - alm. helbredstillæg</div>\n        </div>\n        \n      </div>\n\n</div><!-- /receiptContainer -->\n\n\n</div>",
        "output": "str",
        "x": 240,
        "y": 1020,
        "wires": [
            [
                "025f9d87a38e0ab0"
            ]
        ]
    },
    {
        "id": "4e2fa08087409208",
        "type": "comment",
        "z": "4fd74d0002aa2bc4",
        "name": "(start) receipts",
        "info": "",
        "x": 770,
        "y": 380,
        "wires": []
    },
    {
        "id": "e152e2c43b245425",
        "type": "mqtt out",
        "z": "4fd74d0002aa2bc4",
        "name": "MQQT Publisher",
        "topic": "worklet/control",
        "qos": "2",
        "retain": "",
        "respTopic": "",
        "contentType": "",
        "userProps": "",
        "correl": "",
        "expiry": "",
        "broker": "a567f42879c1f449",
        "x": 1150,
        "y": 400,
        "wires": []
    },
    {
        "id": "d22d69bd6285aa94",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "Set payload = start for MQTT",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 420,
        "wires": [
            [
                "b57f4c8935cf7360"
            ]
        ]
    },
    {
        "id": "1e21a5454f3e5f22",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "Set response",
        "rules": [
            {
                "t": "set",
                "p": "tempPayload",
                "pt": "msg",
                "to": "payload",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.responseFunction",
                "pt": "msg",
                "to": "receipts",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "payload.response",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "payload.responseData",
                "pt": "msg",
                "to": "tempPayload",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "tempPayload",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "tempMsg",
                "pt": "flow"
            },
            {
                "t": "delete",
                "p": "tempPayload",
                "pt": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1550,
        "y": 440,
        "wires": [
            [
                "7ff59f1e0afd6a94"
            ]
        ]
    },
    {
        "id": "b0930cae840c8734",
        "type": "debug",
        "z": "4fd74d0002aa2bc4",
        "name": "debug 11",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1240,
        "y": 580,
        "wires": []
    },
    {
        "id": "208bcfa9f6ff7750",
        "type": "link in",
        "z": "4fd74d0002aa2bc4",
        "name": "START response",
        "links": [],
        "x": 1175,
        "y": 440,
        "wires": [
            [
                "35246c2a103d75c5"
            ]
        ]
    },
    {
        "id": "48787abb96e28b68",
        "type": "link out",
        "z": "4fd74d0002aa2bc4",
        "name": "Link to START",
        "mode": "link",
        "links": [
            "603f9dfeda911a10"
        ],
        "x": 1085,
        "y": 360,
        "wires": []
    },
    {
        "id": "b57f4c8935cf7360",
        "type": "function",
        "z": "4fd74d0002aa2bc4",
        "name": "Set flow temp MSG object",
        "func": "flow.set(\"tempMsg\", msg);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 870,
        "y": 460,
        "wires": [
            [
                "48787abb96e28b68"
            ]
        ]
    },
    {
        "id": "35246c2a103d75c5",
        "type": "function",
        "z": "4fd74d0002aa2bc4",
        "name": "Get flow temp MSG object",
        "func": "flow.set(\"tempPayload\", msg.payload);\nmsg = flow.get(\"tempMsg\");\nmsg.payload = flow.get(\"tempPayload\");\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1330,
        "y": 440,
        "wires": [
            [
                "1e21a5454f3e5f22"
            ]
        ]
    },
    {
        "id": "d5f3a70199c3b629",
        "type": "change",
        "z": "4fd74d0002aa2bc4",
        "name": "Set flow var = responseData",
        "rules": [
            {
                "t": "set",
                "p": "citizenList",
                "pt": "flow",
                "to": "payload.responseData",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1520,
        "y": 520,
        "wires": [
            [
                "53c070f3a6e4c909"
            ]
        ]
    },
    {
        "id": "7ff59f1e0afd6a94",
        "type": "json",
        "z": "4fd74d0002aa2bc4",
        "name": "",
        "property": "payload.responseData",
        "action": "str",
        "pretty": false,
        "x": 1530,
        "y": 480,
        "wires": [
            [
                "d5f3a70199c3b629"
            ]
        ]
    }
]