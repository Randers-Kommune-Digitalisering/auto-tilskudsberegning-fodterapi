[
    {
        "id": "8ea344595d9a442a",
        "type": "tab",
        "label": "Main",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "c28a486ea3e09387",
        "type": "tab",
        "label": "Web Endpoint",
        "disabled": false,
        "info": "",
        "env": []
    },
    {
        "id": "41d1b8798efe7e15",
        "type": "subflow",
        "name": "PupController",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 220,
                "y": 440,
                "wires": [
                    {
                        "id": "5aa16189aff2b4c3"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1720,
                "y": 340,
                "wires": [
                    {
                        "id": "cb4ea3ccf7541c86",
                        "port": 1
                    }
                ]
            },
            {
                "x": 1920,
                "y": 440,
                "wires": [
                    {
                        "id": "5935cece6c345653",
                        "port": 1
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "43652557380ac3f3",
        "type": "subflow",
        "name": "GetPageContent",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 240,
                "wires": [
                    {
                        "id": "f4ed528cde3cabe7"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 2080,
                "y": 840,
                "wires": [
                    {
                        "id": "193590a736c24869",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "db94b4c117de2f6a",
        "type": "subflow",
        "name": "Get Settings/Rules/Grants",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 60,
                "y": 100,
                "wires": [
                    {
                        "id": "d074d283a8713b57"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1280,
                "y": 660,
                "wires": [
                    {
                        "id": "6e9984fcc13cbb0d",
                        "port": 0
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "85ff29bdef7c1aea",
        "type": "subflow",
        "name": "StepHistory",
        "info": "",
        "category": "",
        "in": [
            {
                "x": 140,
                "y": 80,
                "wires": [
                    {
                        "id": "792bc1326c300849"
                    }
                ]
            }
        ],
        "out": [
            {
                "x": 1020,
                "y": 720,
                "wires": [
                    {
                        "id": "c668c88142f35452",
                        "port": 1
                    }
                ]
            }
        ],
        "env": [],
        "meta": {},
        "color": "#DDAA99"
    },
    {
        "id": "7de50fe1369c94a7",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "fill": "#ffffbf",
            "label": true,
            "fill-opacity": "0.67"
        },
        "nodes": [
            "64156b428449f87a",
            "8b4e8bc5facd8f90",
            "632aa75f39860780"
        ],
        "x": 334,
        "y": 259,
        "w": 322,
        "h": 122
    },
    {
        "id": "669e09e244099963",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "Extract",
        "style": {
            "stroke": "#777777",
            "label": true,
            "fill": "#bfdbef",
            "fill-opacity": "0.67"
        },
        "nodes": [
            "28d8ac05e7f0f65f",
            "bc7b13ac2323540b",
            "4003aad4b2b6a9c8",
            "fa861baf7265d3be",
            "8bc31d06862e8fe2",
            "d5a462980f4852cf",
            "07d87534c4e0bbea",
            "c931f08e3a54e2f2",
            "6558b47eb74e6c0c",
            "569d9f497b06babc",
            "144d6812d5213472",
            "6a7f540f9f08ded4",
            "bb143ed21df0febf",
            "07aa032e7944f93b",
            "15a1703b4a5286c7",
            "d97f7bbbe0210f54",
            "90acc4726c72125a",
            "d04faa115ea73982",
            "c9cc2e6cd25fdbd6",
            "dd83f023eff10d0a",
            "4424787318323d8e",
            "023477a667bd9144"
        ],
        "x": 334,
        "y": 439,
        "w": 1512,
        "h": 207
    },
    {
        "id": "6c7a3f8252158db6",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "Transform 2 - Sager og tilskud",
        "style": {
            "fill": "#ffbfbf",
            "fill-opacity": "0.66",
            "label": true
        },
        "nodes": [
            "5d7e42be40e46699",
            "252ef6cdcba02f65",
            "9639c713133c8b4b",
            "c728e9afbea480e9",
            "b5f7952c5718fafd",
            "c23d52373f2634a2",
            "ea041c123c220cca",
            "042534adf7219de9",
            "ebfc3d7f7b71a754",
            "8b251b9d384911a0",
            "363e103b20db6c80",
            "5cfe1b69780c58ab",
            "eea859cc92e89e3f"
        ],
        "x": 374,
        "y": 1659,
        "w": 1232,
        "h": 282
    },
    {
        "id": "380e5c7e0ea3778b",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "Tranform 3 - Klargør til UI",
        "style": {
            "fill": "#dbcbe7",
            "label": true,
            "fill-opacity": "0.64"
        },
        "nodes": [
            "da966ceeba7b23dd",
            "8a3db972f8fb7806",
            "f5dbef72792b9011",
            "b51fbf12da5aebba",
            "a46e2a0c2cd58d9f",
            "fde5a695bfbd9a7d",
            "df5451114247dbd3",
            "4fa04433812ed133",
            "f811b83fc07bb1cd",
            "c7ca8c02a788a41d",
            "78f7e1718ab3f755",
            "8f4d2dcc4c986825",
            "4840de2e1aa54398"
        ],
        "x": 374,
        "y": 1979,
        "w": 852,
        "h": 402
    },
    {
        "id": "31b5ea0c53a9c4fb",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "",
        "style": {
            "fill": "#ffefbf",
            "fill-opacity": "0.62",
            "label": true
        },
        "nodes": [
            "abb73011a817205a",
            "92fc21540237b9c7",
            "984b68b697eb68be",
            "e08bf0d9ec73f87e",
            "77e8a8e7f5259bfb",
            "1c365f175b48167a",
            "53dbe0297b8bd16d",
            "c6d6dc5b8ef2878b",
            "801ba8048f457e32",
            "ec82ecfe41364ced",
            "415336a4f07090e6",
            "69ef811ebe7083c9",
            "492252a377f8d60d",
            "d046f8cb32a0960c",
            "6154c5e7bbc8bc1a",
            "118d9842141d09ca",
            "f6abba6df8ed7611",
            "4c1121ef6377b795",
            "6ebfb594e20f3f75",
            "412dc2399a0183b9"
        ],
        "x": 454,
        "y": 419,
        "w": 1232,
        "h": 502
    },
    {
        "id": "0e177132df886f4e",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "",
        "style": {
            "fill": "#e3f3d3",
            "fill-opacity": "0.64",
            "label": true
        },
        "nodes": [
            "e33624721d9829f0",
            "40c9a409b68d13f1",
            "5c74b689e0aee38b",
            "30b5b930fae41995",
            "e53f459d609aac22",
            "408b2b0cf0a40d41",
            "0a97b8da0c9ceff9",
            "ea3be6d83c70d734",
            "97801c386c197805",
            "164122de385f07b8"
        ],
        "x": 494,
        "y": 939,
        "w": 1192,
        "h": 202
    },
    {
        "id": "e4e7a254403521e9",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "",
        "style": {
            "fill": "#dbcbe7",
            "fill-opacity": "0.65",
            "label": true
        },
        "nodes": [
            "f8bf41fc7dd480f1",
            "c888f934919b1eb8",
            "d84057a8cb05b22f",
            "0ff5c26114374820",
            "d6432bd8a487caa0",
            "948eb590f69bd85b",
            "b3ecd3ad79094172",
            "54254a91e943fb50",
            "6226138fabf9a3b8",
            "f23aa08410fc8960",
            "419b7ad31525a3a3"
        ],
        "x": 494,
        "y": 1159,
        "w": 1192,
        "h": 122
    },
    {
        "id": "0772648cf2b898d4",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "HTTP Request In",
        "style": {
            "fill": "#ffbfbf",
            "fill-opacity": "0.65",
            "label": true
        },
        "nodes": [
            "1d9fe0413cbb430d",
            "6e25160476593670",
            "e76b0758dc45914d",
            "8d172c16f57e9a2b"
        ],
        "x": 14,
        "y": 519,
        "w": 312,
        "h": 264.5
    },
    {
        "id": "dff24743df339ae5",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "",
        "style": {
            "fill": "#bfdbef",
            "fill-opacity": "0.67",
            "label": true
        },
        "nodes": [
            "59e078cd4489c0aa",
            "62bdefaa23262980",
            "b0adba24e19779d2"
        ],
        "x": 534,
        "y": 279,
        "w": 1152,
        "h": 122
    },
    {
        "id": "0d6121cfccf91882",
        "type": "group",
        "z": "c28a486ea3e09387",
        "name": "Endpoint",
        "style": {
            "fill": "#bfbfbf",
            "fill-opacity": "0.54",
            "label": true
        },
        "nodes": [
            "248d64bf4e74f440",
            "a404b305e8f838e6",
            "fc57c59e7b1b413d",
            "4070528fbaa047ab",
            "55d1d622afec35e2",
            "98d7ea7aa5c93ad4",
            "ac7bdd1609da7c77",
            "ddd0873c9d611a5e",
            "29426a6eb03efe81",
            "a71320aa58eef18a",
            "269002ef959b2b77"
        ],
        "x": 74,
        "y": 59,
        "w": 1612,
        "h": 142
    },
    {
        "id": "287b33b8879cbbbc",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "Transform 1 - Kontrollér data",
        "style": {
            "fill": "#ffefbf",
            "label": true,
            "fill-opacity": "0.66"
        },
        "nodes": [
            "4629d4bebfd2768f",
            "aea48540dc37e51c",
            "64bc816ed683fb56",
            "b01934ac82f070c3",
            "31392fe7f3a93ccd",
            "141037f73383a9f6",
            "78c4e4692985e738",
            "2cf375bbbada29f9",
            "12d9ffdfaf71a523",
            "011d535e3ab60636",
            "71c55498ef71a4c9",
            "6afaf8f1c596de67",
            "05096968ae22cc6f",
            "215c708ef9319356",
            "c68d4ee2f02ada08",
            "4c51b10755b92b07",
            "4e374431cb68ace4",
            "5e112e4574f64f9b",
            "046eb82cefda08d4",
            "6b4df0013a0256a0",
            "7f450a3e484312bd",
            "852046d71f487d02",
            "7d7a7bf5a54224e8",
            "015eb190e5565e7d",
            "ca6df1c9d056a924",
            "00a9a4712b97560f",
            "1ee2c685a74c09b0",
            "ac26dfbc2efcbb4f",
            "81cc412d0d2170b9",
            "6cfa59d7c02c8c82"
        ],
        "x": 334,
        "y": 1099,
        "w": 1142,
        "h": 522
    },
    {
        "id": "9c4f3569ebca5f7b",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "fill": "#bfc7d7",
            "fill-opacity": "0.67",
            "label": true
        },
        "nodes": [
            "bc99d7022f61a990",
            "d183f106c2e11bce",
            "c2df29c07624e5e0",
            "c8857f0a61f8c92e",
            "0df1e3c807393a69",
            "573bc9a19cb2a144",
            "70ade91971d73d3b",
            "81a00971b2ea464e",
            "3691fee0bd5cd7bc",
            "5c03893a530479bb",
            "172fe34eeccca8dd",
            "f7835ac1742b0168"
        ],
        "x": 334,
        "y": 679,
        "w": 1172,
        "h": 222
    },
    {
        "id": "00256f937180f75a",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "stroke": "#ff0000",
            "label": true
        },
        "nodes": [
            "2ea70729759d488c",
            "df0ed618b5194000"
        ],
        "x": 1794,
        "y": 59,
        "w": 412,
        "h": 82
    },
    {
        "id": "44e7408f9fee1e77",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "label": true,
            "color": "#777777",
            "stroke": "#777777",
            "fill": "#ffff7f",
            "fill-opacity": "0.63"
        },
        "nodes": [
            "c0efbe2a4fc25ff6",
            "2c5bfa6b7a2613ab",
            "df4e89fda20fa7db",
            "d426a3d9a5cc587d",
            "421ea3a3d1ce558a",
            "a87343abb1f1ad70",
            "172fd055f45774ea",
            "619dc0bbb1fdf120",
            "0315b599de1a9914",
            "35e66215df68100f"
        ],
        "x": 714,
        "y": 139,
        "w": 952,
        "h": 242
    },
    {
        "id": "0b13e46f82eeff1c",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "stroke": "#0070c0",
            "label": true
        },
        "nodes": [
            "d8fce4eadecd4493",
            "63ec872a76a39ffb",
            "87437eca4cc7eec9"
        ],
        "x": 1724,
        "y": 159,
        "w": 482,
        "h": 82
    },
    {
        "id": "e1dc720ff59cd15f",
        "type": "group",
        "z": "8ea344595d9a442a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "ca4cd4b46c05bb1d",
            "5b599232bb01d1d2"
        ],
        "x": 1874,
        "y": 259,
        "w": 262,
        "h": 82
    },
    {
        "id": "20ed2134d81b57c8",
        "type": "group",
        "z": "8ea344595d9a442a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "7e0e36d833794733",
            "2359edd9babea1ac",
            "08f36899ebeff27b",
            "0af59de1688c9df4",
            "2c999012fa2d0842"
        ],
        "x": 1874,
        "y": 359,
        "w": 272,
        "h": 162
    },
    {
        "id": "a95d2f4df03e969c",
        "type": "group",
        "z": "8ea344595d9a442a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "0f583d6bfaad7d0e",
            "427c8a1a563502c8"
        ],
        "x": 1874,
        "y": 539,
        "w": 262,
        "h": 82
    },
    {
        "id": "9354c79c8ad83b63",
        "type": "group",
        "z": "8ea344595d9a442a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "19bdc53204115899",
            "75f1aaf5a21e12a8"
        ],
        "x": 1874,
        "y": 779,
        "w": 262,
        "h": 82
    },
    {
        "id": "8f09bd47d22cbe66",
        "type": "group",
        "z": "8ea344595d9a442a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "dc943787affd67f4",
            "5ee0ef61ccdcafac"
        ],
        "x": 1874,
        "y": 1539,
        "w": 262,
        "h": 82
    },
    {
        "id": "b95a594cf23c004f",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "label": true,
            "stroke": "#d1d1d1",
            "fill": "#d1d1d1",
            "fill-opacity": "0.63"
        },
        "nodes": [
            "966a912086c08955",
            "21aa70c86addca5a",
            "96c62bac832126e6"
        ],
        "x": 1714,
        "y": 1039,
        "w": 252,
        "h": 142
    },
    {
        "id": "0c2baa05bdc8cb3c",
        "type": "group",
        "z": "8ea344595d9a442a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "ac2d9ca641a094e8",
            "f1884a7421b13391"
        ],
        "x": 1874,
        "y": 1859,
        "w": 262,
        "h": 82
    },
    {
        "id": "954337fe9fd2e7cc",
        "type": "group",
        "z": "8ea344595d9a442a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "230dad52a43f6b19",
            "c6c8addcda828038",
            "135dfd2c3c6f4850",
            "6c4f0dadb67f015e",
            "a2f55ae008b1fee2",
            "8b757888b921f031",
            "45a7f796cd6e87c3",
            "fc1053d3105b2cd0",
            "62b82381ac8d827c",
            "0fb1a45baf4dcc7c",
            "f3622da5b8c6dd11",
            "d521a5aad7378097",
            "609b3d8d3bfd669e",
            "fb02e28cd75e69e8",
            "b840a64a9cf3c187",
            "cbd06ead16ce268d"
        ],
        "x": 354,
        "y": 2559,
        "w": 1032,
        "h": 302
    },
    {
        "id": "59d040b48f8f3dda",
        "type": "group",
        "z": "8ea344595d9a442a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "c04211aaccb15e0a",
            "3f4a10860acd5500",
            "cb15176764c11180",
            "72afce271d46b8f9",
            "25f140a78f720950"
        ],
        "x": 354,
        "y": 2879,
        "w": 792,
        "h": 122
    },
    {
        "id": "13424c114a577170",
        "type": "group",
        "z": "8ea344595d9a442a",
        "style": {
            "stroke": "#999999",
            "stroke-opacity": "1",
            "fill": "none",
            "fill-opacity": "1",
            "label": true,
            "label-position": "nw",
            "color": "#a4a4a4"
        },
        "nodes": [
            "f462cfb8de682697",
            "42e8d0e6b5e55314",
            "d0db0a27f5e322ae",
            "812e5235b331e002",
            "d0ec6e3e02665e27"
        ],
        "x": 4,
        "y": 1019,
        "w": 262,
        "h": 162
    },
    {
        "id": "3fd0647603ec528e",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "Udviklerværktøj",
        "style": {
            "stroke": "#ffC000",
            "label": true
        },
        "nodes": [
            "72df366e32bdb61f",
            "e14341e7aef81e59",
            "c9559b185b3f221b",
            "2d3128d22fb1c532",
            "40785040f06925f6",
            "e1a765292dfcc859",
            "b5badb44837098f9"
        ],
        "x": 14,
        "y": 439,
        "w": 232,
        "h": 222
    },
    {
        "id": "bb5f1c24606d30f1",
        "type": "group",
        "z": "8ea344595d9a442a",
        "name": "",
        "style": {
            "fill": "#ff0000",
            "fill-opacity": "0.5",
            "label": true
        },
        "nodes": [
            "058dd19a1031a295",
            "ba775987982c42fc",
            "53225eb49fe0ac22",
            "5f4c45329970fab2",
            "1dce62fb28ae79dd",
            "1ff45df4387920c6",
            "8d14dd9c7f3d7896",
            "a89a3d18c7ac4270",
            "fa1612c70b1b3ea7",
            "c8ade2cefd45991f",
            "84370f778b40a70d"
        ],
        "x": 74,
        "y": 39,
        "w": 582,
        "h": 162
    },
    {
        "id": "d97f7bbbe0210f54",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "x": 680,
        "y": 620,
        "wires": [
            [
                "90acc4726c72125a"
            ]
        ]
    },
    {
        "id": "90acc4726c72125a",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "x": 1240,
        "y": 620,
        "wires": [
            [
                "4424787318323d8e"
            ]
        ]
    },
    {
        "id": "269002ef959b2b77",
        "type": "junction",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "x": 580,
        "y": 100,
        "wires": [
            [
                "a71320aa58eef18a"
            ]
        ]
    },
    {
        "id": "afc6fa2bb250f63c",
        "type": "junction",
        "z": "43652557380ac3f3",
        "x": 1880,
        "y": 580,
        "wires": [
            [
                "1d2a94a05f330839"
            ]
        ]
    },
    {
        "id": "e7b83f0e755d4fdf",
        "type": "junction",
        "z": "c28a486ea3e09387",
        "x": 1800,
        "y": 720,
        "wires": [
            [
                "d4cb17c655b74747"
            ]
        ]
    },
    {
        "id": "bb96674ebd01af04",
        "type": "junction",
        "z": "db94b4c117de2f6a",
        "x": 840,
        "y": 280,
        "wires": [
            [
                "a9d6b94d12b279b8"
            ]
        ]
    },
    {
        "id": "c49b1da1d0ca8a62",
        "type": "junction",
        "z": "db94b4c117de2f6a",
        "x": 840,
        "y": 420,
        "wires": [
            [
                "6f9b01d0e9aeace9"
            ]
        ]
    },
    {
        "id": "c02e24bfe2197802",
        "type": "junction",
        "z": "43652557380ac3f3",
        "x": 640,
        "y": 1000,
        "wires": [
            [
                "22c31b5dcd690404"
            ]
        ]
    },
    {
        "id": "12011e480eafdc8f",
        "type": "junction",
        "z": "db94b4c117de2f6a",
        "x": 840,
        "y": 620,
        "wires": [
            [
                "6e9984fcc13cbb0d"
            ]
        ]
    },
    {
        "id": "f7635cfda195117f",
        "type": "junction",
        "z": "db94b4c117de2f6a",
        "x": 480,
        "y": 60,
        "wires": [
            [
                "6ec1d89f4bc267a3"
            ]
        ]
    },
    {
        "id": "97801c386c197805",
        "type": "junction",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "x": 1660,
        "y": 1060,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "b3ecd3ad79094172",
        "type": "junction",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "x": 1660,
        "y": 1240,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "dd83f023eff10d0a",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "x": 360,
        "y": 520,
        "wires": [
            [
                "d04faa115ea73982"
            ]
        ]
    },
    {
        "id": "b840a64a9cf3c187",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "x": 1280,
        "y": 2820,
        "wires": [
            [
                "a2f55ae008b1fee2",
                "d2046b01f19e1166"
            ]
        ]
    },
    {
        "id": "2833bc30cabd27bb",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 1740,
        "y": 300,
        "wires": [
            [
                "ca4cd4b46c05bb1d"
            ]
        ]
    },
    {
        "id": "6fc6a8b8c6d3b766",
        "type": "junction",
        "z": "43652557380ac3f3",
        "x": 1700,
        "y": 760,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "53d1fb714bf85e85",
        "type": "junction",
        "z": "c28a486ea3e09387",
        "x": 1660,
        "y": 1380,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "7d7a7bf5a54224e8",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "x": 560,
        "y": 1540,
        "wires": [
            [
                "215c708ef9319356"
            ]
        ]
    },
    {
        "id": "4840de2e1aa54398",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "x": 1200,
        "y": 2240,
        "wires": [
            [
                "fde5a695bfbd9a7d",
                "e3a48c9fa5b8b4d4"
            ]
        ]
    },
    {
        "id": "172fe34eeccca8dd",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "x": 1480,
        "y": 820,
        "wires": [
            [
                "c3932c1fbca91f98"
            ]
        ]
    },
    {
        "id": "a534a873bebc25b6",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 1720,
        "y": 380,
        "wires": [
            [
                "79b58433839fe40a"
            ]
        ]
    },
    {
        "id": "79b58433839fe40a",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 280,
        "y": 420,
        "wires": [
            [
                "dd83f023eff10d0a"
            ]
        ]
    },
    {
        "id": "26de970dcfce1beb",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 1900,
        "y": 640,
        "wires": [
            [
                "bcdc17ee1f8d6c4b"
            ]
        ]
    },
    {
        "id": "bcdc17ee1f8d6c4b",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 280,
        "y": 680,
        "wires": [
            [
                "d183f106c2e11bce"
            ]
        ]
    },
    {
        "id": "763d5d3a56706a02",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 1660,
        "y": 940,
        "wires": [
            [
                "125f7071b2eb302c"
            ]
        ]
    },
    {
        "id": "125f7071b2eb302c",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 280,
        "y": 980,
        "wires": [
            [
                "6f70a9263a101b22"
            ]
        ]
    },
    {
        "id": "96eacaac34db6202",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 540,
        "y": 1060,
        "wires": [
            [
                "ea475d83f62dd34b"
            ]
        ]
    },
    {
        "id": "ea475d83f62dd34b",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 280,
        "y": 1100,
        "wires": [
            [
                "4629d4bebfd2768f"
            ]
        ]
    },
    {
        "id": "e1e1f0e8189c47e5",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 1520,
        "y": 1620,
        "wires": [
            [
                "3c3ead5abc0c6168"
            ]
        ]
    },
    {
        "id": "3c3ead5abc0c6168",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 320,
        "y": 1660,
        "wires": [
            [
                "252ef6cdcba02f65"
            ]
        ]
    },
    {
        "id": "04b177707c5e0edc",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 1580,
        "y": 1940,
        "wires": [
            [
                "92b00035cd1abc44",
                "97b819954a422102"
            ]
        ]
    },
    {
        "id": "92b00035cd1abc44",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "x": 320,
        "y": 1980,
        "wires": [
            [
                "da966ceeba7b23dd"
            ]
        ]
    },
    {
        "id": "cbd06ead16ce268d",
        "type": "junction",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "x": 500,
        "y": 2740,
        "wires": [
            [
                "0fb1a45baf4dcc7c"
            ]
        ]
    },
    {
        "id": "6e63b3c396c75d87",
        "type": "websocket-listener",
        "path": "/ws/pup",
        "wholemsg": "true"
    },
    {
        "id": "13a90a014adf9bc5",
        "type": "websocket-listener",
        "path": "/ws/worklet",
        "wholemsg": "false"
    },
    {
        "id": "b93057423dbab117",
        "type": "http in",
        "z": "41d1b8798efe7e15",
        "name": "",
        "url": "/pup",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 160,
        "wires": [
            [
                "f38a2efe43edd64e"
            ]
        ]
    },
    {
        "id": "5c5841605bcac134",
        "type": "http response",
        "z": "41d1b8798efe7e15",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1130,
        "y": 160,
        "wires": []
    },
    {
        "id": "f8ccfed64d837464",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Set URL",
        "info": "",
        "x": 400,
        "y": 120,
        "wires": []
    },
    {
        "id": "5b841495c9c84c66",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Host website",
        "info": "",
        "x": 150,
        "y": 120,
        "wires": []
    },
    {
        "id": "f38a2efe43edd64e",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "url = /pup",
        "rules": [
            {
                "t": "set",
                "p": "url",
                "pt": "msg",
                "to": "pup",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 400,
        "y": 160,
        "wires": [
            [
                "e271c933dcfb52c5"
            ]
        ]
    },
    {
        "id": "8646ac73ab639fcd",
        "type": "http in",
        "z": "41d1b8798efe7e15",
        "name": "",
        "url": "/puprun",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 340,
        "wires": [
            [
                "0fa8b45a3aec3fd5"
            ]
        ]
    },
    {
        "id": "d68baf48942491dd",
        "type": "switch",
        "z": "41d1b8798efe7e15",
        "name": "browser == null?",
        "property": "pupController.browser",
        "propertyType": "msg",
        "rules": [
            {
                "t": "null"
            },
            {
                "t": "nnull"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 340,
        "wires": [
            [
                "274738f45a0d5d5a"
            ],
            [
                "1a32f920705bb1bc"
            ]
        ]
    },
    {
        "id": "274738f45a0d5d5a",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "pupController",
                "pt": "msg",
                "to": "{\t    \"pages\": [],\t    \"commands\": payload\t}",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "pupCount",
                "pt": "flow",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1120,
        "y": 320,
        "wires": [
            [
                "1a32f920705bb1bc"
            ]
        ]
    },
    {
        "id": "1a32f920705bb1bc",
        "type": "function",
        "z": "41d1b8798efe7e15",
        "name": "Initialize?",
        "func": "//const pup = global.get('puppeteer');\n(async () => {\n\n    var commands = msg.pupController.commands;\n\n    for (let i = 0; i < commands.length; i++)\n    {\n        const e = commands[i];\n\n        if (msg.pupController.browser == null && e.action == \"launch\")\n        {\n            msg.pupController.browser = await pup.launch(e.parameters);\n            msg.pupController.browserWS = await msg.pupController.browser.wsEndpoint();\n            //await NewPage(e.name != null ? e.name : \"main\");\n            await AddInitialPage(e.name != null ? e.name : \"initial\");\n        }\n\n        else if(e.action == \"newtab\")\n            await NewPage(e.name);\n    }\n\n    if(msg.pupController.browser == null)\n    {\n        msg.pupController.browser = await pup.launch({});\n        msg.pupController.browserWS = await msg.pupController.browser.wsEndpoint();\n    }\n\n    msg.pupController.activePage = 0; //((await (msg.pupController.browser.pages()).length) - 1);\n    /*\n    {\n        \"page\": (await msg.pupController.browser.pages())[(await msg.pupController.browser.pages()).length - 1],\n        \"po\":msg.pupController.pages[msg.pupController.pages.length - 1]\n    }*/\n    msg.pupController.totalActions = commands.length;\n\n    node.send(msg);\n})();\n\nasync function NewPage(name) {\n    const newPage = await msg.pupController.browser.newPage();\n    const id = (await msg.pupController.browser.pages()).length - 1;\n    const url = await newPage.url();\n    msg.pupController.pages.push(\n        {\n            \"name\": name,\n            \"id\": id,\n            \"url\": url\n        });\n}\n\nasync function AddInitialPage(name = \"initial\")\n{\n    const page = (await msg.pupController.browser.pages())[0];\n    const url = await page.url();\n    msg.pupController.pages.push(\n        {\n            \"name\": name,\n            \"id\": 0,\n            \"url\": url\n        });\n}\n\n/*\nasync function LaunchBrowser(e)\n{\n    const browser = await pup.launch(e.parameters);\n    return browser.wsEndpoint();\n}\n*/",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "puppeteer",
                "module": "puppeteer"
            }
        ],
        "x": 960,
        "y": 440,
        "wires": [
            [
                "ba19f064476425c9"
            ]
        ]
    },
    {
        "id": "580a9e3166314a22",
        "type": "function",
        "z": "41d1b8798efe7e15",
        "name": "Solo Controller",
        "func": "const pup = global.get('puppeteer');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\n\nvar actions = [];\n//var outputs = [];\nvar outputs = {};\n\nconst timeoutMs = 6500;\n\n(async () => {\n\n    const actionList = msg.payload;\n    var actionPerformed;\n\n    for (let i = 0; i < actionList.length; i++) {\n\n        try {\n            const browser = await pup.connect({ \"browserWSEndpoint\": msg.pupController.browserWS })\n            const page = (await browser.pages())[msg.pupController.activePage];\n\n            page.setDefaultNavigationTimeout(1000);\n            //page.setDefaultNavigationTimeout(10000);\n\n            var ele = actionList[i];\n            const action = ele.action;\n\n            await page.waitForNetworkIdle();\n\n            switch (action) {\n                case \"launch\":\n                case \"newtab\":\n                    break;\n\n                case \"goto\":\n                    if (ele.url != null)\n                        await page.goto(ele.url, { waitUntil: 'load', timeout: timeoutMs });\n                    else\n                        actionPerformed = ReportError(ele, \"Error: URL was lost\");\n                    break;\n\n                case \"click\":\n                    if (ele.isDownload == true || ele.isDownload == \"true\")\n                        setDownloadBehavior(page);\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    await page.click(ele.path, (ele.parameters != null ? ele.parameters : {}));\n                    if (ele.isDownload == true || ele.isDownload == \"true\")\n                        await page.waitForNetworkIdle();\n                    break;\n\n                case \"clickifexists\":\n                    if (ele.isDownload == true || ele.isDownload == \"true\")\n                        setDownloadBehavior(page);\n\n                    const exists = !! await page.$(ele.path);\n\n                    //wait page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    if (exists)\n                        await page.click(ele.path, (ele.parameters != null ? ele.parameters : {}));\n\n                    if (ele.isDownload == true || ele.isDownload == \"true\")\n                        await page.waitForNetworkIdle();\n                    break;\n\n                case \"type\":\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    if (ele.clear == true || ele.clearInput == true || ele.clear == \"true\" || ele.clearInput == \"true\")\n                        await page.click(ele.path, { clickCount: 3 });\n                    await page.type(ele.path, ele.input);\n                    break;\n\n                case \"select\":\n                    //let elemHandler = await page.$(ele.path).then(x => console.log(\n                    //console.log(\"ELEMENT HANDLE FOUND: \" + x)));\n                    let properties = await page.$(ele.path).then(elemHandler => elemHandler.getProperties());\n                    for (const property of properties.values()) {\n                        const element = property.asElement();\n                        if (element) {\n                            let hText = await element.getProperty(\"text\");\n                            let text = await hText.jsonValue();\n                            if (text === ele.input) {\n                                let hValue = await element.getProperty(\"value\");\n                                let value = await hValue.jsonValue();\n                                await page.select(ele.path, value); // or use 58730\n                                //console.log(`Selected ${text} which is value ${value}.`);\n                            }\n                        }\n                    }\n                    /*\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    await page.select(ele.path, ele.input);\n                    */\n                    break;\n\n                case \"get\":\n                    await page.waitForSelector(ele.path, { waitUntil: 'domcontentloaded', timeout: timeoutMs });\n                    var content = await page.$eval(ele.path, el => el.innerText);\n                    ele.output = actionList[i].output = content;\n                    break;\n\n                case \"geturl\":\n                    ele.output = actionList[i].output = page.url();\n                    break;\n\n                case \"authenticate\":\n                    var login_username = ele.username;\n                    var login_password = ele.password;\n                    await page.authenticate({ 'username': login_username, 'password': login_password });\n                    break;\n\n                case \"wait\":\n                    if (ele.ms != null)\n                        await wait(ele.ms);\n                    break;\n\n                case \"close\":\n                    await browser.close();\n                    msg.pupController.browser = null;\n                    msg.pupController.pages = null;\n                    break;\n            }\n\n            ele.succesful = true;\n            actionPerformed = ReportAction(ele);\n            node.send([null, actionPerformed]);\n\n            //if(i == actionList.length-1 && action != \"close\")\n            //    await browser.close();\n\n\n        }\n        catch (e) {\n            console.log(\"PupController error: \" + JSON.stringify(e));\n            //node.error(\"Error:\", e);\n            actionList[i].succesful = false;\n            actionPerformed = ReportError(actionList[i], e);\n\n            node.send([null, actionPerformed]);\n\n            /*if (i == actionList.length - 1 && actionList[i] != \"close\")\n                await pup.connect({ \"browserWSEndpoint\": msg.pupController.browserWS }).then(browser => browser.close());\n                //await browser.close();*/\n        }\n\n    }\n\n\n    msg.pupOutputs = outputs;\n    node.send([msg, null]);\n})();\n\nasync function wait(_ms) {\n    let promise = new Promise((resolve, reject) => {\n        setTimeout(() => resolve(\"done!\"), _ms)\n    });\n    let result = await promise; // wait until the promise resolves (*)\n    //alert(result); // \"done!\"\n}\n\nfunction ReportAction(a, s = true) {\n    var newAction;\n    actions.push(newAction = {\n        \"action\": a.action,\n        \"succesful\": s,\n        \"obj\": a\n    });\n\n    if (a.output != null) {\n        var outputName = a.name;\n        var outputObj = a.obj;\n\n        if (outputObj != null && outputObj != \"\") {\n            outputs[outputObj] = outputs[outputObj] == null ? {} : outputs[outputObj];\n            outputs[outputObj][outputName] = a.output;\n        }\n        else\n            outputs[outputName] = a.output;\n        /*\n        outputs.push({\n            \"name\": a.name,\n            \"value\": a.output\n        });*/\n    }\n    return newAction;\n}\n\nfunction ReportError(a, e) {\n    console.log(e);\n    var newAction;\n    actions.push(newAction = {\n        \"action\": a,\n        \"succesful\": false,\n        \"error\": e,\n        \"obj\": a\n    });\n    return newAction;\n}\n\nasync function setDownloadBehavior(page) {\n    const client = await page.target().createCDPSession();\n    await client.send('Page.setDownloadBehavior', {\n        behavior: 'allow',\n        downloadPath: downloadPath\n    });\n}",
        "outputs": 2,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1340,
        "y": 360,
        "wires": [
            [
                "cb4ea3ccf7541c86",
                "668e1ae3f9c4ccf8"
            ],
            [
                "2fd098a8190ef089"
            ]
        ]
    },
    {
        "id": "fa696e728e31ff49",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Start flow from web",
        "info": "",
        "x": 170,
        "y": 300,
        "wires": []
    },
    {
        "id": "a0f636581c44be9d",
        "type": "debug",
        "z": "41d1b8798efe7e15",
        "name": "Command Executed",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1820,
        "y": 500,
        "wires": []
    },
    {
        "id": "69738f2e4dcc6f63",
        "type": "http response",
        "z": "41d1b8798efe7e15",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1750,
        "y": 300,
        "wires": []
    },
    {
        "id": "668e1ae3f9c4ccf8",
        "type": "debug",
        "z": "41d1b8798efe7e15",
        "name": "All Commands Executed",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1630,
        "y": 240,
        "wires": []
    },
    {
        "id": "2fd098a8190ef089",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "pupid",
                "pt": "msg",
                "to": "pupCount",
                "tot": "flow"
            },
            {
                "t": "set",
                "p": "pupCount",
                "pt": "flow",
                "to": "msg.pupid+1",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "totalCount",
                "pt": "msg",
                "to": "totalActionCount",
                "tot": "flow",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1600,
        "y": 420,
        "wires": [
            [
                "5935cece6c345653"
            ]
        ]
    },
    {
        "id": "8020507bdd5939ba",
        "type": "websocket out",
        "z": "41d1b8798efe7e15",
        "name": "",
        "server": "6e63b3c396c75d87",
        "client": "",
        "x": 1970,
        "y": 400,
        "wires": []
    },
    {
        "id": "9da2cdfaa3c63d2e",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Set JavaScript",
        "info": "",
        "x": 650,
        "y": 120,
        "wires": []
    },
    {
        "id": "3d490b929251bc8a",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Start flow from flow",
        "info": "",
        "x": 170,
        "y": 400,
        "wires": []
    },
    {
        "id": "8ce8fe7e4e9fd6a5",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Endpoint",
        "info": "",
        "x": 1140,
        "y": 120,
        "wires": []
    },
    {
        "id": "30cc309628e939bc",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Check instance",
        "info": "",
        "x": 900,
        "y": 300,
        "wires": []
    },
    {
        "id": "6553bd482e86e7cd",
        "type": "function",
        "z": "41d1b8798efe7e15",
        "name": "CSS Selector Parser",
        "func": "for (let i = 0; i < msg.payload.length; i++) {\n    const e = msg.payload[i];\n\n    if(e.element != null)\n        e.path = CreatePath(e.element);\n    //DebugElement(e.element);\n    \n}\n\nfunction DebugElement(element)\n{\n    msg.test.push(element);\n}\n\nfunction CreatePath(element)\n{\n    if(element.path != null)\n        element.path;\n\n    var path = element.type == null ? \"\" : element.type;\n\n    if(element.parent != null && element.within != null)\n        ReportError({\n            \"error\": \"Both parent and within values set for element\",\n            \"element\": element\n        });\n\n    if(element.class != null)\n        path = path + \".\" + element.class;\n\n        if (element.classContains != null)\n            path = path + \"[class*='\" + element.classContains + \"']\";\n\n        if (element.classStartsWith != null)\n            path = path + \"[class^='\" + element.classStartsWith + \"']\";\n\n    if (element.id != null)\n        path = path + \"[id='\" + element.id + \"']\";\n\n        if(element.idContains != null)\n            path = path + \"[id*='\" + element.idContains + \"']\";\n\n        if (element.idStartsWith != null)\n            path = path + \"[id^='\" + element.idStartsWith + \"']\";\n\n    if (element.name != null)\n        path = path + \"[name='\" + element.name + \"']\";\n\n    if (element.src != null)\n        path = path + \"[src='\" + element.src + \"']\";\n\n    if (element.innerHTML != null)\n        path = path + \"[innerHTML='\" + element.innerHTML + \"']\";\n\n    // Check parent + within\n\n    if(element.parent != null)\n        path = CreatePath(element.parent) + \" > \" + path;\n    \n    else if (element.within != null)\n        path = CreatePath(element.within) + \" \" + path;\n\n    return path;\n}\n\nfunction ReportError(error)\n{\n    msg.error = error;\n}\n\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 340,
        "wires": [
            [
                "d68baf48942491dd"
            ]
        ]
    },
    {
        "id": "5b02768458131405",
        "type": "comment",
        "z": "41d1b8798efe7e15",
        "name": "Create CSS selectors",
        "info": "",
        "x": 680,
        "y": 300,
        "wires": []
    },
    {
        "id": "0fa8b45a3aec3fd5",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "isWebCommand = true",
        "rules": [
            {
                "t": "set",
                "p": "isWebCommand",
                "pt": "flow",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 380,
        "y": 340,
        "wires": [
            [
                "6553bd482e86e7cd"
            ]
        ]
    },
    {
        "id": "5aa16189aff2b4c3",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "isWebCommand = false",
        "rules": [
            {
                "t": "set",
                "p": "isWebCommand",
                "pt": "flow",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 390,
        "y": 440,
        "wires": [
            [
                "6553bd482e86e7cd"
            ]
        ]
    },
    {
        "id": "5935cece6c345653",
        "type": "switch",
        "z": "41d1b8798efe7e15",
        "name": "",
        "property": "isWebCommand",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "jsonata"
            },
            {
                "t": "eq",
                "v": "false",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1770,
        "y": 420,
        "wires": [
            [
                "8020507bdd5939ba"
            ],
            []
        ]
    },
    {
        "id": "cb4ea3ccf7541c86",
        "type": "switch",
        "z": "41d1b8798efe7e15",
        "name": "",
        "property": "isWebCommand",
        "propertyType": "flow",
        "rules": [
            {
                "t": "eq",
                "v": "true",
                "vt": "jsonata"
            },
            {
                "t": "eq",
                "v": "false",
                "vt": "jsonata"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1570,
        "y": 320,
        "wires": [
            [
                "69738f2e4dcc6f63"
            ],
            []
        ]
    },
    {
        "id": "9b6f2743d9f9c4c2",
        "type": "catch",
        "z": "41d1b8798efe7e15",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 200,
        "y": 660,
        "wires": [
            [
                "9eb94ead2cba83a2"
            ]
        ]
    },
    {
        "id": "9eb94ead2cba83a2",
        "type": "debug",
        "z": "41d1b8798efe7e15",
        "name": "PupError",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 340,
        "y": 660,
        "wires": []
    },
    {
        "id": "e271c933dcfb52c5",
        "type": "template",
        "z": "41d1b8798efe7e15",
        "name": "Script",
        "field": "payload.script",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "plain",
        "template": "/////////////\n/// #0 : Action definitions\n////////////\n\nfunction actionList() {\n    return [\n        {\n            \"action\": \"launch\",\n            \"parameters\":\n            {\n                \"headless\": false,\n                \"slowMo\": 50,\n                \"ignoreHTTPSErrors\": true,\n                \"defaultViewport\": null\n            }\n        },\n        {\n            \"action\": \"goto\",\n            \"url\": \"\"\n        },\n        {\n            \"action\": \"click\",\n            \"path\": \"\",\n            \"parameters\":\n            {\n                \"clickCount\": 1\n            }\n        },\n        {\n            \"action\": \"type\",\n            \"input\": \"\",\n            \"path\": \"\"\n        },\n        {\n            \"action\": \"select\",\n            \"path\": \"\",\n            \"input\": \"\"\n        },\n        {\n            \"action\": \"get\",\n            \"name\": \"\",\n            \"path\": \"\"\n        },\n        {\n            \"action\": \"geturl\",\n            \"name\": \"\"\n        },\n        {\n            \"action\": \"authenticate\",\n            \"username\": \"\",\n            \"password\": \"\"\n        },\n        {\n            \"action\": \"wait\",\n            \"ms\": 1000\n        },\n        {\n            \"action\": \"close\"\n        }\n    ];\n};\n\n\n\n/////////////\n/// #1 : Start ()\n////////////\n\nconst commandList = document.querySelector(\".commandList\"),\n    controls = document.querySelector(\".controls\"),\n\n    cmdInput = document.querySelector(\".cmd\"),\n    textarea = document.querySelector('.textarea'),\n    lineNumbers = document.querySelector('.line-numbers');\n\nconst storageName = \"pupControl_JSON_commandGen\";\n\n// Define + get commands from SQLite\n\nlet commands = [];\n\ntry {\n    commands = JSON.parse(localStorage.getItem(storageName));\n}\ncatch {\n    console.log(\"Found command list, but corrupt:\\n\" + localStorage.getItem(storageName));\n    commands = [];\n}\n\nShowCommandList();\nUpdateJSON();\n\n// Create pseudo enum \"actionKeys\" -> usage to get full object: actionList()[actionKeys[\"launch\"]]\n\nlet _actionKeys = [];\nfor (let i = 0; i < actionList().length; i++)\n    _actionKeys[actionList()[i].action] = i;\n\nconst actionKeys = _actionKeys;\n\n// Function to create IDs for query selection of buttons\n\nfunction GetElementIdFromAction(actionObject) { return \"buttonAdd_\" + actionObject.action.replace(\" \", \"\"); }  // Example ID: buttonAdd_launch\n\n// Dynamically instantiate buttons for action objects\n\nfor (let i = 0; i < actionList().length; i++)\n    controls.innerHTML += `\n        <button class=\"button active\" id=\"${GetElementIdFromAction(actionList()[i])}\">${actionList()[i].action}</button>\n    `;\n\n// Dynamically create query selectors for action object buttons\n\nlet _buttonAdd = [];\nfor (let i = 0; i < actionList().length; i++)\n    _buttonAdd[actionList()[i].action] = document.querySelector(\".button#\" + GetElementIdFromAction(actionList()[i]));\n\nconst buttonAdd = _buttonAdd;\n\n// and add event listeners\n\nfor (let i = 0; i < actionList().length; i++)\n    buttonAdd[actionList()[i].action].addEventListener(\"click\", () => {\n        AddCommand(actionList()[i]);\n    });\n\n\n\n/////////////\n/// #2 : Data manipulation\n////////////\n\n///\n// Add command\n\nlet variableCount = 0;\nfunction AddCommand(actionObject) {\n\n    //console.log(\"Received action object: \\n\" + JSON.stringify(actionObject));\n    //console.log(\"Full action list: \" + JSON.stringify(actionList));\n\n    // Check if command is of valid type\n    if (!IsValidType(actionObject.action)) {\n        console.log(\"Failed to add command of unknown type `\" + actionObject.action + \"`\");\n        return;\n    }\n\n    // Check if a command array already exists, otherwise define it\n    commands = !commands ? [] : commands;\n\n    // Create initial command object\n    let clone = {}; // the new empty object\n\n    // let's copy all action properties into it\n    for (let key in actionObject) {\n        clone[key] = actionObject[key];\n    }\n    const command = clone;\n\n    // Push new command to list, and store JSON\n    commands.push(command);\n\n    StoreAndUpdateJSON();\n}\n\n// Function to check if type is valid\nfunction IsValidType(type) {\n    return !(actionKeys[type] == null);\n}\n\n// HTTP encode + add https if missing\nfunction ReturnUrl(url) {\n    var newUrl = encodeURIComponent(url);\n    if (!(url.includes(\"https://\") || url.includes(\"http://\")))\n        newUrl = \"https://\" + newUrl;\n    return newUrl;\n}\n\n// Selector generator from string\nfunction GenerateSelector(parameters) {\n    var multipleParameters = parameters.trim().split(' ');\n    var path = multipleParameters[0];\n    if (multipleParameters.length == 1)\n        return path;\n\n    for (let i = 1; i < multipleParameters.length; i++) {\n        let _c = multipleParameters[i];\n        var insideBrackets = _c.includes('[');\n\n        let attrSplit = _c.split('=');\n        if (!insideBrackets && attrSplit.length == 2) {\n            let attr = (_c.split('='))[0];\n            let value = (_c.split('='))[1];\n            path += '[' + attr + '=\"' + value + '\"]';\n        }\n        else\n            path += \" \" + _c;\n    }\n    return path;\n}\n\n// Receive update variable command from event\nfunction UpdateCommandVar(inputField) {\n\n    console.log(\"InputField: \" + inputField.id);\n\n    // Get ID of input field to determine which value to update\n    let id = inputField.id;\n    let s = id.split('_');\n    let value = (inputField.value).replace(\"\\\"\", \"'\");\n\n    // Example ID: commandInput_id_attr [or] commandInput_id_obj_attr (theoretically indefinite objs)\n    let _id = s[1];\n    var _attr = s[2];\n    if (s.length >= 3)\n        for (var i = 3; i < s.length; i++)\n            _attr += \".\" + s[i];\n\n    UpdateCommandValue(_attr, value, _id);\n}\n\n// Update and store the change\nfunction UpdateCommandValue(attr, value, commandId) {\n    if (attr == \"path\")\n        value = GenerateSelector(value);\n\n    // Parse if float or int (ignore if \"path\" or \"input\")\n    if (attr != \"path\" && attr != \"input\") //  <- HARD CODE :(\n    {\n        if (value.includes(\".\") || value.includes(\",\")) {\n            // Is float?\n            let _value = value.replace(\",\", \".\");\n            const parsed = parseFloat(_value);\n            if (!isNaN(parsed))\n                value = parsed;\n        }\n        else {\n            // Is int?\n            const parsed = parseInt(value);\n            if (!isNaN(parsed))\n                value = parsed;\n        }\n\n        // Parse if boolean or null\n        if (value === \"true\") value = true;\n        if (value === \"false\") value = false;\n        if (value === \"null\") value = null;\n    }\n\n\n    if (!attr.includes('.')) {\n        (commands[commandId])[attr] = value;\n    }\n    else {\n        console.log(\"Attributes: \" + attr);\n\n        let keys = attr.split(\".\");\n        let toEval = \"(commands[\" + commandId + \"]).\" + (keys.slice(0, keys.length - 1).join('.'));\n        let obj = eval(toEval);\n\n        console.log(\"ToEval:\" + toEval);\n        console.log(\"EvalObj: \" + JSON.stringify(obj));\n\n        obj[keys[keys.length - 1]] = value;\n\n\n        /*\n                let keys = attr.split(\".\")\n                let tmpobj = {},\n                    prevobj = {};\n        \n                for (let x = keys.length; x > 0; x--)\n                {\n                    if (x == 0)\n                    {\n                        commands[keys[0]] = tmpobj;\n                    }\n                    else\n                    {\n                        let toeval = 'commands[' + commandId + '].' + keys.slice(0, x).join('.');\n                        console.log(\"Evaluating \" + toeval);\n        \n                        prevobj = {\n                            ...tmpobj\n                        }\n        \n                        tmpobj = eval(toeval);\n        \n                        console.log(\"TmpObj: \" + tmpobj + \" (\" + JSON.stringify(tmpobj) + \")\");\n        \n                        if (x == keys.length -1)\n                            tmpobj[keys[x]] = value;\n        \n                        else\n                        {\n                            tmpobj[keys[x]] = prevobj;\n                        }\n                    }\n                }\n                */\n    }\n\n    StoreAndUpdateJSON();\n}\n\n// Additional functions\n\nfunction ClearAllCommands() {\n    commands.splice(0, commands.length);\n    StoreAndUpdateJSON();\n}\n\nfunction DeleteCommand(deleteId) {\n    commands.splice(deleteId, 1);\n    StoreAndUpdateJSON();\n}\n\nfunction CopyCommand(copyId) {\n    let command = commands[copyId];\n    commands.push(command);\n    StoreAndUpdateJSON();\n}\n\n///\n// STORE DATA / UPDATE JSON\n\nfunction StoreAndUpdateJSON(_text = null) {\n\n    // Function is used with _text parameter when called from textarea event listener\n    let text = UpdateJSON(_text);\n\n    if (text != null)\n        localStorage.setItem(storageName, text);\n\n    ShowCommandList();\n}\n\nfunction UpdateJSON(_text = null) {\n\n    var text = null;\n\n    if (_text == null) {\n        text = JSON.stringify(commands);\n        SetTextareaText(text);\n    }\n\n    else {\n\n        var _parsed = null;\n        try { _parsed = JSON.parse(_text) }\n        catch { }\n        //console.log(\"Updating JSON from textarea!\");\n        //console.log(_parsed);\n        if (_parsed != null) {\n            commands = _parsed;\n            text = JSON.stringify(commands);\n        }\n\n    }\n\n    SetTextareaLineNumbers();\n    return text;\n}\n\n\n\n/////////////\n/// #3 : Visual manipulation\n////////////\n\nfunction ShowCommandList() {\n    let liTag = \"\";\n\n    // Check if command list exists and is populated\n    if (commands) {\n        commands.forEach((command, id) => {\n            liTag += PrintCommand(command, id);\n        });\n    }\n\n    // Base text - if no commands exists\n    commandList.innerHTML = liTag || `<span>Start by adding a <b>Launch</b> command</span>`;\n\n    // Add event listeners to all input fields in tasks\n    var inputFields = document.querySelectorAll('.task input');\n    for (var i = 0; i < inputFields.length; i++) {\n\n        // Update the command that has been changed on focusout, and resize input field to match content\n        inputFields[i].addEventListener('focusout', function (event) {\n            UpdateCommandVar(event.target);\n            ResizeInputToFit(event.target.id);\n        }, false);\n\n        inputFields[i].addEventListener('keyup', function (event) {\n            // Also resize on key-up\n            ResizeInputToFit(event.target.id);\n        }, false);\n\n        // Also resize immediately to match loaded content\n        ResizeInputToFit(inputFields[i].id);\n    }\n}\n\n// Show bulletin menu for each action in list (with copy / delete options)\nfunction ShowBulletinMenu(selectedTask) {\n    let menuDiv = selectedTask.parentElement.lastElementChild;\n    menuDiv.classList.add(\"show\");\n    document.addEventListener(\"click\", e => {\n        if (e.target.tagName != \"I\" || e.target != selectedTask)\n            menuDiv.classList.remove(\"show\");\n    });\n}\n\n///\n// PRINT COMMAND\n///\nfunction PrintCommand(command, id) {\n\n    var commandName = command.action == \"goto\" ? \"go to\" : command.action;\n\n    var returnStr = \"\";\n    returnStr += `\n                <li class=\"task\" id=\"task_${id}\">\n                <div>\n                    <div>\n                        <label for=\"${id}\">\n                            <p>${commandName}</p>\n                        </label>\n                    </div>`;\n\n    // Add input fields for each object variable\n    returnStr += AddInputFields(command, id);\n\n    returnStr += `\n                    <div>\n                    </div>\n                    <div class=\"filler\"></div>\n                    <div class=\"settings\">\n                        <i onclick=\"ShowBulletinMenu(this)\" class=\"uil uil-ellipsis-h\"></i>\n                        <ul class=\"bulletinMenu\">\n                            <li onclick='CopyCommand(${id})'><i class=\"uil uil-trash\"></i>Copy</li>\n                            <li onclick='DeleteCommand(${id})'><i class=\"uil uil-trash\"></i>Delete</li>\n                        </ul>\n                    </div>\n                </div>\n            </li>`;\n\n    return returnStr;\n}\n\n// Add input fields for each command variable\nfunction AddInputFields(command, id, previousKey = null) {\n    console.log(\"Adding input field for command \" + command.action + \" with id \" + id + \" and previousKey \" + previousKey);\n    var returnStr = \"\";\n    for (const key in command) {\n        var keystr = key;\n        keystr = key.toLocaleLowerCase();\n\n        if (command[key] !== null && typeof command[key] === 'object') {\n            var newPreviousKey = key;\n            if (previousKey != null)\n                newPreviousKey = previousKey + \"_\" + key;\n\n            returnStr += \"<span>\" + key + \" {</span>\";\n            returnStr += AddInputFields(command[key], id, newPreviousKey);\n            returnStr += \"<span>}</span>\";\n        }\n\n        else if (keystr != \"action\") {\n            let inputID = \"commandInput_\" + id + \"_\" + (previousKey != null ? previousKey + \"_\" : \"\") + key;\n            //inputIDArray.push(inputID);\n            returnStr += `\n                    <div>\n                    ${keystr}\n                    <input id=\"${inputID}\" value='${command[key]}'/>\n                    </div>\n                        `;\n        }\n\n    }\n    return returnStr;\n}\n\n\nfunction ResizeInputToFit(id) {\n    let _inputField = document.querySelector((\"#\" + id));\n    let width = (40 + (_inputField.value.length * 7.35)) + \"px\";\n    document.querySelector((\"#\" + id)).setAttribute('style', 'width:' + width);\n}\n\nvar lastChar = '';\nvar isNewline = false;\nvar isInsideQuotations = false;\nfunction SetTextareaText(json) {\n    var text = \"\";\n    let count = json.length;\n    var level = 0;\n\n    for (let i = 0; i < count; i++) {\n        let char = json[i];\n\n        switch (char) {\n            case '{': case '[':\n                if (!isInsideQuotations && i != 0 && (json[i - 1] == ',' || json[i - 1] == ':')) text += \"\\n\";\n                if (!isInsideQuotations)\n                    for (let l = 0; l < level; l++)\n                        text += \"\\t\";\n                text += char;\n                if (!isInsideQuotations) {\n                    text += \"\\n\";\n                    level++;\n                    isNewline = true;\n                }\n                break;\n\n            case '}': case ']':\n                if (!isInsideQuotations) {\n                    text += \"\\n\";\n                    level--;\n                    for (let l = 0; l < level; l++)\n                        text += \"\\t\";\n                    isNewline = true;\n                }\n                text += char;\n                break;\n\n            case ',':\n                if (!isInsideQuotations)\n                    isNewline = true;\n                text += char;\n                break;\n\n            case ':':\n                text += char;\n                if (lastChar == \"\\\"\")\n                    text += \" \";\n                break;\n\n            case '\"':\n                isInsideQuotations = !isInsideQuotations;\n\n            default:\n                if (i != 0 && json[i - 1] == ',') { text += \"\\n\"; isNewline = true }\n                if (isNewline)\n                    for (let l = 0; l < level; l++)\n                        text += \"\\t\";\n                text += char;\n                isNewline = false;\n                break;\n        }\n\n        lastChar = char;\n    }\n\n    textarea.value = text;\n}\n\nfunction SetTextareaLineNumbers() {\n    /*\n    const lineHeight = 21;\n    var taHeight = textarea.scrollHeight; // Get the scroll height of the textarea\n    const numberOfLines = Math.floor(taHeight/lineHeight);\n    */\n    const numberOfLines = textarea.value.split('\\n').length;\n    lineNumbers.innerHTML = Array(numberOfLines)\n        .fill('<span></span>')\n        .join('');\n}\n\n\n\n\n\n\n\n\n\n\n\n/////////////\n/// #4 : Communication (HTTP Request + Websockets)\n////////////\n\n///\n// HTTP post method (for testing flows using \"nr\"-command)\nasync function SendToNodeRed() {\n    if (commandList.length == 0)\n        return;\n\n    document.getElementById('task_0').classList.add(\"current\");\n\n    fetch('/puprun', {\n\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n        },\n        body: textarea.value\n\n    }).then(response => {\n        if (response.ok) {\n            response.json().then(json => {\n                console.log(json);\n            });\n        }\n    });\n}\n\n///\n// WEB SOCKET (node-red)\nvar ws;\nvar wsUri = \"ws:\";\nvar loc = window.location; //console.log(loc);\n\nif (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n// This needs to point to the web socket in the Node-RED flow\nwsUri += \"//\" + loc.host + loc.pathname.replace(\"pup\", \"ws/pup\");\n\nfunction wsConnect() {\n    console.log(\"Connecting to \", wsUri);\n    ws = new WebSocket(wsUri);\n    //var line = \"\";    // either uncomment this for a building list of messages\n    ws.onmessage = function (msg) {\n        var line = \"\";  // or uncomment this to overwrite the existing message\n\n        console.log(\"Received WS message!\");\n\n        // parse the incoming message as a JSON object\n        var data = msg.data;\n        const obj = JSON.parse(data);\n\n        console.log(\"Received WS message ID: \" + obj.pupid);\n\n        // Remove bg from current command box (and set error if error was detected)\n        document.getElementById('task_' + obj.pupid).classList.remove(\"current\")\n        if (!obj.succesful)\n            document.getElementById('task_' + obj.pupid).classList.add(\"error\")\n\n        // Update next command box bg\n        let nextID = obj.pupid + 1;\n        if (commands.length > nextID)\n            document.getElementById('task_' + nextID).classList.add(\"current\");\n\n        //ws.send(JSON.stringify({data:data}));\n    }\n    ws.onopen = function () {\n        // update the status div with the connection status\n        console.log(\"Connected to WS\");\n    }\n    ws.onclose = function () {\n        // update the status div with the connection status\n        console.log(\"WS connection lost\");\n        // in case of lost connection tries to reconnect every 3 secs\n        setTimeout(wsConnect, 3000);\n    }\n}\nfunction PublishWsMessage(m) {\n    if (ws) { ws.send(m); }\n}\n\n\n\n\n\n\n\n\n\n/////////////\n/// #5 : Command line interface\n////////////\n\nfunction RunCommandLineAction(key) {\n    if (key != \"Enter\")\n        return;\n\n    var input = cmdInput.value;\n    input = input.toLowerCase();\n\n    const inputCommand = (input.split(' '))[0];\n\n    var clearInput = true;\n\n    switch (inputCommand) {\n        case \"clear\":\n            ClearAllCommands();\n            break;\n\n        case \"node-red\": case \"nr\":\n            SendToNodeRed();\n            break;\n\n        default:\n            console.log(\"Received unrecognized console command `\" + input + \"`\");\n            clearInput = false;\n            break;\n    }\n\n    if (clearInput)\n        cmdInput.value = \"\";\n}\n\n/*\nfunction AddCommandLineCommand(ic, i) {\n    const parameters = i.replace(ic, '').trim();\n    AddCommand(ic, parameters);\n\n    console.log(\"Received command `\" + ic + \"` with parameters `\" + parameters + \"`\");\n}\n\n*/\n\n\n\n\n\n\n\n/////////////\n/// #6 : Event listeners\n////////////\n\ntextarea.addEventListener('keyup', event => {\n    SetTextareaLineNumbers();\n    StoreAndUpdateJSON(textarea.value);\n});\n\ntextarea.addEventListener('keydown', event => {\n    if (event.key === 'Tab') {\n        const start = textarea.selectionStart;\n        //const end = textarea.selectionEnd;\n\n        textarea.value = textarea.value.substring(0, start) + '\\t' + textarea.value.substring(start, textarea.value.length);\n\n        textarea.selectionEnd = start + 1;\n\n        event.preventDefault();\n    }\n});\n\ncmdInput.addEventListener('keyup', event => {\n    RunCommandLineAction(event.key);\n});\n\n/*\nwindow.onresize = SetTextareaLineNumbers;\n*/",
        "x": 630,
        "y": 160,
        "wires": [
            [
                "c8f4a55e7618b7e2"
            ]
        ]
    },
    {
        "id": "a17c13f96787e2b4",
        "type": "template",
        "z": "41d1b8798efe7e15",
        "name": "HTML",
        "field": "payload",
        "fieldType": "msg",
        "format": "html",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html lang=\"en\" dir=\"ltr\">\n  <head>\n    <meta charset=\"utf-8\">  \n    <title>PupController</title>\n    <style>{{{payload.style}}}</style>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <!-- Iconscout Link For Icons -->\n    <link rel=\"stylesheet\" href=\"https://unicons.iconscout.com/release/v4.0.0/css/line.css\">\n  </head>\n  <body onload=\"wsConnect();\" onunload=\"ws.disconnect();\">\n\n    <div class=\"flex\">\n\n      <div class=\"containerLeft\">\n\n        <div class=\"menu\">\n\n          <div class=\"menupoints\">\n            <div>Documentation</div>\n            <div>GitHub</div>\n          </div>\n\n          <div class=\"controls\"></div>\n\n        </div>\n\n        <ul class=\"commandList\"></ul>\n\n      </div>\n      <div class=\"containerRight\">\n\n        <div class=\"editor\">\n          <div class=\"line-numbers\">\n            <span></span>\n          </div>\n          <textarea class=\"textarea\"></textarea>\n        </div><!-- /editor -->\n\n      </div><!-- /containerRight -->\n    </div><!-- /flex -->\n\n\n\n    <div class=\"commandLine\">\n      <span>></span><input class=\"cmd\" />\n    </div>\n\n\n<script>{{{payload.script}}}</script>\n\n  </body>\n</html>",
        "x": 970,
        "y": 160,
        "wires": [
            [
                "5c5841605bcac134"
            ]
        ]
    },
    {
        "id": "c8f4a55e7618b7e2",
        "type": "template",
        "z": "41d1b8798efe7e15",
        "name": "CSS",
        "field": "payload.style",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "/* Import Google Font - Poppins */\n@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');\n*{\nmargin: 0;\npadding: 0;\nbox-sizing: border-box;\nfont-family: 'Poppins', sans-serif;\ncolor:rgb(204, 204, 204)\n}\n*:focus\n{\noutline: none;\n}\nbody{\nwidth: 100%;\nheight: 100vh;\noverflow: hidden;\ndisplay: flex;\nalign-content: stretch;\nflex-direction: column;\n}\n.flex\n{\nwidth: 100%;\ndisplay: inline-flex;\nflex-grow: 1;\n}\n.containerLeft\n{\nwidth: 55%;\nbackground: #282b2f;\n/*box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);*/\n}\n.containerRight\n{\nheight: calc(100vh - 30px);\nwidth: 45%;\noverflow-y:auto;\nbackground-color: #1d2025;\nborder-left: 4px solid rgb(29, 31, 29);\n}\n\n/* BOTTOM CMD */\n.commandLine\n{\nline-height: 30px;\ncolor:darkslategray;\nwidth:100%;\nbackground-color: #0b0c0c;\npadding-left: 15px;\n}\n.cmd\n{\nwidth: calc(100% - 30px);\nheight: 100%;\nborder:0px;\nbackground-color: #0b0c0c;\npadding-left: 5px;\nfont-family: monospace;\nfont-size: 15px;\n}\n\n/* RIGHT CONTAINER - TEXT AREA\n.containerRight textarea\n{\nbackground: linear-gradient(135deg, #141618, #191c22);\npadding: 10px 20px;\nwidth:100%;\nheight:100vh;\nborder: 0px;\n} */\n.editor {\ndisplay: inline-flex;\nalign-content: stretch;\nline-height: 21px;\nfont-size: 12px;\nbackground: linear-gradient(135deg, #1a1c20, #1d2025);\nwidth:100%;\n}\n\n.textarea {\noverflow-wrap:break-word;\nwhite-space: pre-wrap;\nline-height: 21px;\n/*overflow-y: hidden;\nbackground: #282a3a;\nheight: 100vh;\ncolor: #FFF;*/\nmin-height: calc(100vh - 30px);\noverflow:hidden;\noutline: none;\nresize: none;\nfont-family: monospace;\nflex-grow: 1;\ncolor:rgb(214, 211, 211);\n\nbackground: linear-gradient(135deg, #141618, #191c22);\npadding: 10px 15px;\nborder: 0px;\n}\n.line-numbers {\npadding: 10px 0px;\nmargin-right: 10px;\nwidth: 35px;\ntext-align: right;\nflex-grow: 0;\n}\n\n.line-numbers span {\ncounter-increment: linenumber;\n}\n\n.line-numbers span::before {\ncontent: counter(linenumber);\ndisplay: block;\ncolor: darkslategray;\nfont-family: monospace;\n}\n\n\n\n\n/* LEFT CONTAINER - VISUAL EDITOR */\n.menu\n{\nbox-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);\nbackground: #282b2f;\nbackground: linear-gradient(135deg, rgb(29, 31, 29) 0%, rgb(22, 24, 24) 100%); /* #232626 */\n}\n.menu .menupoints\n{\nfont-size: 12px;\nline-height: 35px;\npadding-left: 12px;\ntext-transform: capitalize;\nbackground: linear-gradient(135deg, rgb(21, 22, 21) 0%, rgb(16, 17, 17) 100%);\n}\n.menupoints div\n{\ndisplay: inline-flex;\npadding: 0px 10px;\n}\n.menupoints div:hover\n{\nbackground: #232626;\ncursor: pointer;\n}\n\n.controls{\npadding: 7px 10px;\npadding-bottom: 14px;\ntext-align: left;\nmax-height: 61px;\noverflow-y: auto;\n}\n.controls div\n{\nfont-size: 12px;\ntext-transform: capitalize;\ncolor:darkslategray;\npadding-left: 3px;\n}\n.controls .button{\nborder: none;\nopacity: 0.4;\noutline: none;\ncolor: #fff;\ncursor: pointer;\nfont-size: 13px;\npadding: 8px 18px;\nmargin-top:4px;\nborder-radius: 3px;\nletter-spacing: 0.3px;\npointer-events: none;\ntransition: transform 0.25s ease;\nbackground: #344b48; /* 343c4b */\ntext-transform: capitalize;\n}\n.controls .button:not(:first-child)\n{\nmargin-left: 3px;\n}\n.button:hover\n{\nbackground: #4d6f6b;\n}\n.button.active{\nopacity: 1;\npointer-events: auto;\n}\n.button:active{\ntransform: scale(0.93);\n}\n\n\n\n\n.commandList\n{\npadding: 10px 8px;\nwidth:100%;\noverflow-y: auto;\nmax-height:calc(100vh - 126px);\nheight: 100%;\noverflow-x: hidden;\n/*background-color: darkslategray;*/\n}\n.commandList span\n{\npadding-left: 7px;\n}\n.commandList.overflow{\noverflow-y: auto;\n}\n*::-webkit-scrollbar{\nwidth: 5px;\n}\n*::-webkit-scrollbar-track{\nbackground: #3f4349;\nborder-radius: 25px;\n}\n*::-webkit-scrollbar-thumb{\nbackground: #6d6d6d;\nborder-radius: 25px;\n}\n\n\n.commandList .task\n{\nlist-style: none;\nfont-size: 15px;\n\nmargin-bottom: 5px;\nborder-radius: 5px;\n\nbox-shadow: 3px 3px 3px rgba(20, 20, 20, 0.05);\nbackground: linear-gradient(135deg, #32363a, #2d3135);\n}\n    .task.current\n    {\n        background: linear-gradient(135deg, #3f2f4f, #4a3859)!important;\n        /*background: linear-gradient(135deg, #99597d, #804b67)!important;*/\n    }\n    .task.error\n    {\n        background: linear-gradient(135deg, #6e4a48, #6b4a46)!important;\n        /*background: linear-gradient(135deg, #9c5c5c, #854e4e)!important;*/\n    }\n.commandList .task > div\n{\npadding-left: 20px;\ndisplay: inline-flex;\nalign-items: flex-start;\nflex-wrap: wrap;\ngap: 15px;\nwidth: 100%;\nmax-width: 100%!important;\npadding-top: 8px;\npadding-bottom: 8px;\nline-height: 25px;\n}\n.task span\n{\ncolor: rgb(136, 136, 136);\nfont-family: monospace;\nline-height: 25px;\nfont-size:12px;\n}\n.task p\n{\n    text-transform: capitalize;\n}\n.commandList .task > div > div\n{\ncolor: rgb(114, 153, 153);\nfont-family: monospace;\n}\n.commandList .task > div input\n{\nbackground-color: #535353;\nborder: 0px;\nborder-radius: 3px;\nline-height: 25px;\npadding: 0px 10px;\nfont-family: monospace;\nwidth: auto;\nmax-width: calc(100vh - 150px);\n}\n\n.commandList .task > div > div.filler\n{\nflex-grow: 1;\nflex-shrink: 1;\n}\n.commandList .settings\n{\nposition: relative;\nfloat: right;\npadding-right:10px;\n/*top: -16px;*/\nflex-grow: 0!important;\n}\n.settings :where(i, li){\ncursor: pointer;\n}\n.settings .bulletinMenu{\nz-index: 10;\nright: 12px;\npadding: 5px 0;\nbackground: #757575;\nposition: absolute;\nborder-radius: 4px;\ntransform: scale(0);\ntransform-origin: top right;\nbox-shadow: 0 0 6px rgba(0,0,0,0.15);\ntransition: transform 0.2s ease;\n}\n.commandList .task:last-child:not(:first-child) .bulletinMenu{\nbottom: 20px;\ntransform-origin: bottom right;\n}\n.commandList .task:not(:last-child) .bulletinMenu{\ntop: 20px;\n}\n/*\n.commandList .task:first-child .bulletinMenu{\nbottom: -65px;\ntransform-origin: top right;\n}*/\n.bulletinMenu.show{\ntransform: scale(1);\n}\n.bulletinMenu li{\nheight: 25px;\nfont-size: 12px;\nline-height: 25px;\nmargin-bottom: 2px;\npadding: 0px 10px;\nmin-width: 85px;\ncursor: pointer; list-style-type: none;\n}\n.bulletinMenu li:last-child{\nmargin-bottom: 0;\n}\n.settings li:hover{\nbackground: rgb(128, 128, 128);\n}\n.settings li i{\npadding-right: 8px;\n}",
        "x": 790,
        "y": 160,
        "wires": [
            [
                "a17c13f96787e2b4"
            ]
        ]
    },
    {
        "id": "b650822ef599b5ff",
        "type": "status",
        "z": "41d1b8798efe7e15",
        "name": "",
        "scope": [],
        "x": 1340,
        "y": 80,
        "wires": [
            []
        ]
    },
    {
        "id": "ba19f064476425c9",
        "type": "change",
        "z": "41d1b8798efe7e15",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "totalActionCount",
                "pt": "flow",
                "to": "pupController.totalActions",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1170,
        "y": 440,
        "wires": [
            [
                "580a9e3166314a22"
            ]
        ]
    },
    {
        "id": "357f74e2631da4c9",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.page",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "view-receipts",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "view-nograntreceipts",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "login",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "rules",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "grants",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "run",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "finalized",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "start",
                "vt": "str"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 9,
        "x": 350,
        "y": 560,
        "wires": [
            [
                "13e976910d5e9707"
            ],
            [
                "5ab143a5c04fb163"
            ],
            [
                "d69d99eee8adcbf6"
            ],
            [
                "b24facdd74fa8b50"
            ],
            [
                "16bf0e6580aaf246"
            ],
            [
                "8b06ecbd2e4c4ecf"
            ],
            [
                "381970c176b042aa"
            ],
            [
                "c02e24bfe2197802"
            ],
            [
                "7e1f73ec1d40cafe"
            ]
        ]
    },
    {
        "id": "4c886c495ce2fe9d",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: start",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card-container mb-3\">\n    <!-- card-container -->\n\n    {{{payload.pageElements.lastRunCard}}}\n    \n    {{{payload.pageElements.actionsCard}}}\n    \n    {{{payload.pageElements.newRunCard}}}\n\n    <!-- /card-container -->\n</div>",
        "output": "str",
        "x": 1210,
        "y": 1040,
        "wires": [
            [
                "1c7f385619f6a12d"
            ]
        ]
    },
    {
        "id": "66afcd1514727417",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: view-receipts",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"receipt-container\">\n    <!-- receipt-container -->\n\n    <div class=\"receipt-inner\">\n        <!-- receipt-inner -->\n\n        <div class=\"citizen-info\">\n            <!-- citizen-info -->\n\n            <ul class=\"nav nav-tabs\" role=\"tablist\" style=\"padding-bottom: 1.2px;margin-right: 5px;border-bottom:0px\">\n                <li class=\"nav-item\" role=\"presentation\">\n                    <a class=\"nav-link active\" data-bs-toggle=\"tab\" href=\"#overblik\" aria-selected=\"true\" role=\"tab\">Overblik</a>\n                </li>\n\n                <li class=\"nav-item\" role=\"presentation\">\n                    <a class=\"nav-link\" data-bs-toggle=\"tab\" href=\"#sager\" aria-selected=\"false\" tabindex=\"-1\" role=\"tab\">Alle sager</a>\n                </li>\n            </ul>\n            \n            <div id=\"myTabContent\" class=\"tab-content bg-white p-3\">\n                <div class=\"tab-pane show active\" id=\"overblik\" role=\"tabpanel\">\n\n                    <!-- -->\n                    <h4 class=\"card-title mb-4\">\n                        {{payload.tempData.cpr}}<small class=\"text-secondary\"> - XXXX</small>\n                        <a href=\"https://fagsystem.kommunernespensionssystem.dk/spk-fagsystem/person/{{payload.tempData.persondata.kpurl}}/overblik\" target=\"_blank\">\n                            <span class=\"float-right text-muted\"><i class=\"fas fa-2xs fa-link\"></i></span>\n                        </a>\n                    </h4>\n                    <!-- p class=\"card-text\">Some quick example text to build on the card title and make up the bulk of the card's content.</p -->\n                    \n                    {{{payload.tempData._bevilling}}}\n\n                    <div class=\"d-flex flex-wrap\" style=\"gap: 3px\">\n                        {{{payload.tempData.persondata._sager}}}\n                    </div>\n\n\n                    <div class=\"d-flex justify-stretch mt-4\" style=\"gap: 3px\">\n\n                        <div class=\"card border-light bg-light mb-2 text-center p-1\">\n                            <div class=\"text-secondary fs-10\">FORMUE</div>\n                            {{payload.tempData.persondata._formue}}\n                        </div>\n\n                        <div class=\"card border-light bg-light mb-2 text-center p-1\">\n                            <div class=\"text-secondary fs-10\">DANMARK</div>\n                            {{payload.tempData.persondata._danmark}}\n                        </div>\n                        \n                        <div class=\"card border-light bg-light mb-2 text-center p-1\">\n                            <div class=\"text-secondary fs-10\">TILLÆGSPROCENT</div>\n                            {{payload.tempData.persondata._htillaegsprocent}} %\n                        </div>\n\n                    </div>\n                \n                    <!-- -->\n                    \n                </div>\n\n                <div class=\"tab-pane\" id=\"sager\" role=\"tabpanel\">\n\n                    <table class=\"table fs-11\" style=\"margin-left:-8px;margin-right:0px;\">\n                        <thead class=\"border-none\">\n                            <tr>\n                            <th scope=\"col\"><span class=\"table-header\">Titel</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Sagstype</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Start</span></th>\n                            <th scope=\"col\"><span class=\"table-header\">Slut</span></th>\n                            </tr>\n                        </thead>\n                        <tbody>\n                            {{#payload.tempData.persondata.sager}}\n                            <tr>\n                                <td>{{titel}}</td>\n                                <th scope=\"row\">{{type}}</th>\n                                <td>{{fra}}</td>\n                                <td>{{til}}</td>\n                            </tr>\n                            {{/payload.tempData.persondata.sager}}\n                        </tbody>\n                    </table>\n                    \n                </div>\n                \n            </div>\n\n            <!-- /citizen-info -->\n        </div>\n\n        <div>\n            \n            \n            {{{payload.tempData._faktura}}}\n\n\n        </div>\n\n        \n        \n\n        <!-- /receipt-inner -->\n    </div>\n    \n\n    <div class=\"pagination-container mt-3\">\n\n        \n        <ul class=\"pagination\">\n            {{{payload.tempData._pagination}}}\n        </ul>\n\n        {{{payload.tempData._archive}}}\n\n        </div>\n\n    <!-- /receiptContainer -->\n</div>",
        "output": "str",
        "x": 1450,
        "y": 320,
        "wires": [
            [
                "ae78e3fc89996dac"
            ]
        ]
    },
    {
        "id": "1c7f385619f6a12d",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 1040,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "ae78e3fc89996dac",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Fakturaer",
                "tot": "str"
            },
            {
                "t": "delete",
                "p": "payload.tempData",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.tempDataArray",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1670,
        "y": 320,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "32eb88cfb3101407",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "set full page HTML",
        "field": "payload.pageHTML",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<!DOCTYPE html>\n<html>\n    <head>\n        <title>AutoWorkLet - Randers Kommune</title>\n        <link href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.1/css/all.min.css\" rel=\"stylesheet\">\n        <script src=\"https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js\" integrity=\"sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4\" crossorigin=\"anonymous\"></script>\n        <style>{{{css}}}</style>\n    </head>\n    <body>\n<div id=\"fullPage\" style=\"width: 100%;height:100%\">\n<!-- -->\n\n\n{{{payload.pageElements.navbar}}}\n\n<div class=\"progress-container collapsed\">\n\n    <div class=\"uppercase fs-10 fw-500 mb-1\" style=\"width:100%;text-align: center;\">Robotten arbejder ... 56%</div>\n\n    <div class=\"progress bg-dark\">\n        <div class=\"progress-bar progress-bar-striped progress-bar-animated\" role=\"progressbar\" aria-valuenow=\"75\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width: 75%;\"></div>\n    </div>\n\n\n</div>\n\n    \n  \n<div class=\"container site-container mt-3\">\n    <!-- site -->\n\n    <ol class=\"breadcrumb\">\n        <li class=\"breadcrumb-item active\">{{{payload.pageTitle}}}</li>\n    </ol>\n\n    <div id=\"alertParent\">\n        <div class=\"alert alert-dismissible hidden\" id=\"alertBox\">\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\n            <h4 class=\"alert-heading\" id=\"alertBox-heading\">Warning!</h4>\n            <p class=\"mb-0\" id=\"alertBox-body\">Best check yo self, you're not looking too good. Nulla vitae elit libero, a pharetra augue. Praesent commodo cursus magna, <a href=\"#\" class=\"alert-link\">vel scelerisque nisl consectetur et</a>.</p>\n        </div>\n    </div>\n\n    <div id=\"pageContent\">\n        {{{payload.pageContent}}}\n    </div>\n\n    <!-- /site -->\n</div>\n\n\n\n\n\n</div>\n<!-- -->\n\n    <script>{{{js}}}</script>\n    </body>\n</html>",
        "output": "str",
        "x": 2050,
        "y": 700,
        "wires": [
            [
                "193590a736c24869"
            ]
        ]
    },
    {
        "id": "f673e8538a4af3d9",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: login",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<form onsubmit=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), document.getElementById('workletUser'), document.getElementById('workletPass'), document.getElementById('dqUser'), document.getElementById('dqPass')  ))\">\n<div class=\"card mb-2\">\n    <div class=\"card-header\">DQ loginoplysninger</div>\n    <div class=\"card-body\">\n        <p class=\"card-text\">Før du kan søge efter fakturaer, skal du indtaste dine kommunale loginoplysninger.</p>\n        \n        <div class=\"form-group\" id=\"form-group\">\n            <input type=\"hidden\" id=\"requestType\" value=\"acceptPage\">\n            <input type=\"hidden\" id=\"pageToAccept\" value=\"login\">\n            <input type=\"hidden\" id=\"toAccept\" value=\"{{payload.pageElements.loginToAccept}}\">\n            \n            <div class=\"form-floating mb-3\">\n            <input type=\"text\" class=\"form-control\" id=\"dqUser\" placeholder=\"DQ0000\" autocomplete=\"off\" required>\n            <label for=\"dqUser\">DQ-nr.</label>\n            </div>\n            <div class=\"form-floating\">\n            <input type=\"password\" class=\"form-control\" id=\"dqPass\" placeholder=\"Password\" style=\"font-family: 'password'\" required>\n            <label for=\"dqPass\">Kodeord</label>\n            </div>\n        </div>\n\n    </div>\n</div>\n<div class=\"card mb-2\">\n    <div class=\"card-header\">WorkLet loginoplysninger</div>\n    <div class=\"card-body\">\n        <p class=\"card-text\">Her skal du indtaste kommunens loginoplysninger til WorkLet.</p>\n        \n        <div class=\"form-group\" id=\"form-group\">\n            <input type=\"hidden\" id=\"requestType\" value=\"acceptPage\">\n            <input type=\"hidden\" id=\"pageToAccept\" value=\"login\">\n            <input type=\"hidden\" id=\"toAccept\" value=\"{{payload.pageElements.loginToAccept}}\">\n            \n            <div class=\"form-floating mb-3\">\n            <input type=\"text\" class=\"form-control\" id=\"workletUser\" placeholder=\"name@example.com\" autocomplete=\"off\" required>\n            <label for=\"workletUser\">Email addresse</label>\n            </div>\n            <div class=\"form-floating\">\n            <input type=\"password\" class=\"form-control\" id=\"workletPass\" placeholder=\"Password\" style=\"font-family: 'password'\" required>\n            <label for=\"workletPass\">Kodeord</label>\n            </div>\n        </div>\n\n        {{{payload.pageElements.loginButtons}}}\n\n    </div>\n</div>\n</form>\n\n",
        "output": "str",
        "x": 1330,
        "y": 440,
        "wires": [
            [
                "e36e40cecb56969d"
            ]
        ]
    },
    {
        "id": "e36e40cecb56969d",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Loginoplysninger",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1510,
        "y": 460,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "af684cb65465eef9",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: rules",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">Forretningsregler</div>\n    <div class=\"card-body\">\n        <h6 class=\"card-subtitle mb-2 text-muted\">Sæt kriterier for tilskud</h6>\n        <p class=\"card-text\">Kontrollér/sæt og derefter godkendt forretningsreglerne som robotten benytter som beslutningsgrundlag.</p>\n        \n        <div class=\"form-group\" id=\"form-group\">\n            <div class=\"mt-3 border-bottom\" style=\"padding-left: 15px;padding-right: 15px\">\n                <input type=\"hidden\" id=\"requestType\" value=\"acceptPage\">\n                <input type=\"hidden\" id=\"pageToAccept\" value=\"rules\">\n                <input type=\"hidden\" id=\"toAccept\" value=\"{{payload.pageElements.rulesToAccept}}\">\n            \n                {{{payload.pageElements.ruleList}}}\n\n            </div>\n        </div>\n\n        {{{payload.pageElements.rulesButtons}}}\n\n    </div>\n</div>",
        "output": "str",
        "x": 1510,
        "y": 560,
        "wires": [
            [
                "ec0875277dd56ced"
            ]
        ]
    },
    {
        "id": "ec0875277dd56ced",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Forretningsregler",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1670,
        "y": 560,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "f4ed528cde3cabe7",
        "type": "subflow:db94b4c117de2f6a",
        "z": "43652557380ac3f3",
        "name": "",
        "x": 210,
        "y": 240,
        "wires": [
            [
                "d64936a739a436db"
            ]
        ]
    },
    {
        "id": "1d2a94a05f330839",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: navbar",
        "func": "// Set menu html\n\nvar dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\n\nvar currentRunExists = global.get(\"runHistory\", \"storeInFile\") !== null && global.get(\"runHistory\", \"storeInFile\") !== undefined && (\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ? !(global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]).isFinalized : !(global.get(\"runHistory\", \"storeInFile\")).isFinalized);\n\nvar currentRun = currentRunExists ?\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ?\n        global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]\n        : global.get(\"runHistory\", \"storeInFile\") : null;\n\nconst receiptsAwaiting = currentRunExists ? !currentRun.allReceiptsProcessed : false;\nconst isBeingProcessed = currentRunExists ? !currentRun.isFinalized : false;\n\n\nfunction isActive(pageName)\n{\n    return (msg.payload.webSettings.state.activePage == pageName);\n}\nfunction pageAccepted(pageName)\n{\n    return (msg.payload.webSettings.acceptances[pageName]);\n}\n\nvar html = `<nav class=\"navbar navbar-expand-lg navbar-dark bg-primary\" >\n    <div class=\"container-fluid\">\n        <a class=\"navbar-brand randers-logo\" onclick=\"goToPage('start')\"></a>\n        <a class=\"navbar-brand randers-titel\" onclick=\"goToPage('start')\"></a>\n        <ul class=\"navbar-nav me-auto\">\n            <li class=\"nav-item\">\n                <a id=\"nav_start\" class=\"nav-link`+\n                (isActive('start') ? \" active\" : \"\")\n                +`\" onclick=\"goToPage('start')\">Start</a>\n            </li>\n            <li class=\"nav-item\">\n                <a id=\"nav_login\" class=\"nav-link`+\n                (isActive('login') ? \" active\" : \"\") + \n                (pageAccepted('login') ? \" nav-success\" : \"\")\n                +`\" onclick=\"goToPage('login')\">Loginoplysninger</a>\n            </li>\n            <li class=\"nav-item\">\n                <a id=\"nav_rules\" class=\"nav-link`+\n                (isActive('rules') ? \" active\" : \"\") +\n                (pageAccepted('rules') ? \" nav-success\" : \"\")\n                +`\" onclick=\"goToPage('rules')\">Forretningsregler</a>\n            </li>\n            <li class=\"nav-item\">\n                <a id=\"nav_grants\" class=\"nav-link`+\n                (isActive('grants') ? \" active\" : \"\") +\n                (pageAccepted('grants') ? \" nav-success\" : \"\")\n                +`\" onclick=\"goToPage('grants')\">Tilskudssatser</a>\n            </li>`;\n\n\nvar receiptCount = 0;\n\nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptCount += global.get(\"webData\")[\"citizens-actions\"].length;\n\nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined)\n        receiptCount += global.get(\"webData\")[\"citizens-noactions\"].length;\n\n\nif (msg.payload.webSettings.state.isRunning )\n        html +=\n            `<li class=\"nav-item\">\n            <a id=\"nav_run\" class=\"nav-link`+\n            (isActive('run') ? \" active\" : \"\")\n            + `\" onclick=\"goToPage('run')\">` +\n            `Robotten kører<i class=\"fa-lg fas fa-spinner fa-spin\" style=\"margin-left: 10px\"></i>`\n            + `</a>\n        </li>`;\nelse if ((isBeingProcessed && !dataExists) || (receiptsAwaiting && receiptCount == 0))\n    html +=\n        `<li class=\"nav-item\">\n            <a id=\"nav_run\" class=\"nav-link`+\n            (isActive('run') ? \" active\" : \"\")\n            + `\" onclick=\"goToPage('run')\">Genoptag kørsel</a>\n        </li>`;\n\nelse if (receiptsAwaiting && isBeingProcessed)\n    html +=\n        `<li class=\"nav-item\">\n            <a id=\"nav_view-receipts\" class=\"nav-link`+\n            (isActive('view-receipts') ? \" active\" : \"\")\n            + `\" onclick=\"goToPage('view-receipts')\">Anbefalede handlinger</a>\n        </li>`\n    +  `<li class=\"nav-item\">\n            <a id=\"nav_view-nograntreceipts\" class=\"nav-link`+\n            (isActive('view-nograntreceipts') ? \" active\" : \"\")\n            + `\" onclick=\"goToPage('view-nograntreceipts')\">Borgere uden bevilling</a>\n        </li>`;\n\nelse if (!receiptsAwaiting && isBeingProcessed)\n    html +=\n        `<li class=\"nav-item\">\n            <a id=\"nav_view-receipts\" class=\"nav-link`+\n        (isActive('view-receipts') ? \" active\" : \"\")\n        + `\" onclick=\"goToPage('view-receipts')\">Anbefalede handlinger</a>\n        </li>`\n        + `<li class=\"nav-item\">\n            <a id=\"nav_view-nograntreceipts\" class=\"nav-link`+\n        (isActive('view-nograntreceipts') ? \" active\" : \"\")\n        + `\" onclick=\"goToPage('view-nograntreceipts')\">Borgere uden bevilling</a>\n        </li>`\n        +\n        `<li class=\"nav-item\">\n            <a id=\"nav_run\" class=\"nav-link`+\n            (isActive('run') ? \" active\" : \"\")\n            +`\" onclick=\"goToPage('run')\">Afslut kørsel</a>\n        </li>`;\n\nelse if (pageAccepted('login') && pageAccepted('rules') && pageAccepted('grants'))\n    html +=\n        `<li class=\"nav-item\">\n            <a id=\"nav_run\" class=\"nav-link`+\n            (isActive('run') ? \" active\" : \"\")\n            + `\" onclick=\"goToPage('run')\">` +\n            (msg.payload.webSettings.state.isRunning ? `Robotten kører<i class=\"fa-lg fas fa-spinner fa-spin\" style=\"margin-left: 10px\"></i>` : `Ny kørsel`)\n            + `</a>\n        </li>`;\n\n\n/*\n\n            (receiptsAwaiting && isBeingProcessed ?\n            (`<li class=\"nav-item\">\n                                    <a id=\"nav_view-receipts\" class=\"nav-link`+\n                (isActive('view-receipts') ? \" active\" : \"\")\n                + `\" onclick=\"goToPage('view-receipts')\">Anbefalede handlinger</a>\n                        </li>`)\n            +\n            (`<li class=\"nav-item\">\n                                    <a id=\"nav_view-nograntreceipts\" class=\"nav-link`+\n                (isActive('view-nograntreceipts') ? \" active\" : \"\")\n                + `\" onclick=\"goToPage('view-nograntreceipts')\">Ej berettigede borgere</a>\n                        </li>`) : ``)\n            +\n\n            ((isBeingProcessed && !dataExists) ? \n                ` <li class=\"nav-item\">\n                                    <a id=\"nav_run\" class=\"nav-link`+\n                (isActive('run') ? \" active\" : \"\") +\n                (pageAccepted('grants') ? \" nav-success\" : \"\") +\n                + `\" onclick=\"goToPage('run')\">Genoptag kørsel</a>\n                    </li>`\n                :\n\n\n                ((!receiptsAwaiting && isBeingProcessed) ? \n                ` <li class=\"nav-item\">\n                        <a id=\"nav_run\" class=\"nav-link`+\n                (isActive('run') ? \" active\" : \"\") +\n                +`\" onclick=\"goToPage('run')\">Afslut kørsel</a>\n                    </li>`\n                :\n                \n                ((pageAccepted('login') && pageAccepted('rules') && pageAccepted('grants')) ?\n                `<li class=\"nav-item\">\n                    <a id=\"nav_run\" class=\"nav-link`+\n                    (isActive('run') ? \" active\" : \"\")\n                    +`\" onclick=\"goToPage('run')\">`+\n                    (msg.payload.webSettings.state.isRunning ? `Robotten kører<i class=\"fa-lg fas fa-spinner fa-spin\" style=\"margin-left: 10px\"></i>` : `Ny kørsel`)\n                    +`</a>\n                </li>` : ``))\n            )\n\n*/\nhtml += `\n        </ul>\n    </div>\n</nav >`;\n\nmsg.payload.pageElements['navbar'] = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2040,
        "y": 580,
        "wires": [
            [
                "32eb88cfb3101407"
            ]
        ]
    },
    {
        "id": "b51ae96408813a15",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageElements",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 265,
        "y": 560,
        "wires": [
            [
                "357f74e2631da4c9"
            ]
        ],
        "l": false
    },
    {
        "id": "e4fc06b7c36a80c5",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: newRunCard",
        "field": "payload.pageElements.newRunCard",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card {{payload.pageElements.newRunCardClasses}}\">\n    <div class=\"card-header\">{{payload.pageElements.newRunCardHeader}}</div>\n    <div class=\"card-body\">\n       {{{payload.pageElements.newRunCardBody}}}\n    </div>\n</div>",
        "output": "str",
        "x": 960,
        "y": 1080,
        "wires": [
            [
                "4c886c495ce2fe9d"
            ]
        ]
    },
    {
        "id": "220a6e666845a7aa",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Start",
        "info": "",
        "x": 710,
        "y": 960,
        "wires": []
    },
    {
        "id": "927b1a1a92e941cd",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.webSettings.acceptances.rules",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 560,
        "wires": [
            [
                "8f1889ef41f2b0f2"
            ],
            [
                "ecdf72546c22bbab"
            ]
        ]
    },
    {
        "id": "d87b864a541f79a5",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Rules",
        "info": "",
        "x": 710,
        "y": 520,
        "wires": []
    },
    {
        "id": "ecdf72546c22bbab",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: ruleList",
        "field": "payload.pageElements.ruleList",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{{#payload.rules}}\n    <div class=\"row border-top pb-2 pt-2 \">\n\n\n        <div class=\"col-2 d-flex flex-column justify-content-center\">\n            <span>{{name}}</span>\n        </div>\n\n        <div class=\"form-floating col was-validated\">\n            <select class=\"form-select\" id=\"operator_{{uid}}\" onchange=\"setInputBox('{{uid}}')\" disabled>\n                <option value=\"==\">= Skal være lig med</option>\n                <option value=\"!=\">≠ Må ikke være lig med</option>\n                <option value=\"<\">< Skal være mindre end</option>\n                <option value=\">\">> Skal være større end</option>\n                <option value=\"contains\">{?} Indeholder</option>\n                <option value=\"!contains\">{!} Indeholder ikke</option>\n                <option value=\"!null\">[o] Skal være oplyst</option>\n            </select>\n            <label for=\"operator_{{uid}}\" style=\"padding-left: 27px\">Logisk beregningsmetode</label>\n        </div>\n\n        <div class=\"form-floating col was-validated\" id=\"inputContainer_{{uid}}\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{uid}}\" placeholder=\"0\" value=\"{{value}}\" disabled>\n            <label for=\"value_{{uid}}\" style=\"padding-left: 27px\">Værdi</label>\n        </div>\n\n\n    </div>\n{{/payload.rules}}",
        "output": "str",
        "x": 1080,
        "y": 580,
        "wires": [
            [
                "4d85f3207c9d8fa1",
                "88fb35ef462682b4"
            ]
        ]
    },
    {
        "id": "8f1889ef41f2b0f2",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: ruleList",
        "field": "payload.pageElements.ruleList",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{{#payload.rules}}\n    <div class=\"row border-top pb-2 pt-2 \">\n\n\n        <div class=\"col-2 d-flex flex-column justify-content-center\">\n            <span>{{name}}</span>\n        </div>\n\n        <div class=\"form-floating col\">\n            <select class=\"form-select\" id=\"operator_{{uid}}\" onchange=\"setInputBox('{{uid}}');\">\n                <option value=\"==\">= Skal være lig med</option>\n                <option value=\"!=\">≠ Må ikke være lig med</option>\n                <option value=\"<\">< Skal være mindre end</option>\n                <option value=\">\">> Skal være større end</option>\n                <option value=\"contains\">{?} Indeholder</option>\n                <option value=\"!contains\">{!} Indeholder ikke</option>\n                <option value=\"!null\">[o] Skal være oplyst</option>\n            </select>\n            <label for=\"operator_{{uid}}\" style=\"padding-left: 27px\">Logisk beregningsmetode</label>\n        </div>\n\n        <div class=\"form-floating col\" id=\"inputContainer_{{uid}}\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{uid}}\" placeholder=\"0\" value=\"{{value}}\">\n            <label for=\"value_{{uid}}\" style=\"padding-left: 27px\">Værdi</label>\n        </div>\n\n\n    </div>\n{{/payload.rules}}",
        "output": "str",
        "x": 1080,
        "y": 540,
        "wires": [
            [
                "26a5a4e0e501d7e9"
            ]
        ]
    },
    {
        "id": "26a5a4e0e501d7e9",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: rulesButtons",
        "field": "payload.pageElements.rulesButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-primary\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'ruleUpdates', 'value': appendRules (null {{#payload.rules}}, createRuleObj('{{uid}}') {{/payload.rules}}) } ))\">\n        Godkend forretningsregler\n    </button>\n    \n    <button class=\"btn btn-lg btn-primary ml-2 goNext hidden\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('grants')\">\n        Gå til tilskudssatser\n    </button>\n</div>\n",
        "output": "str",
        "x": 1300,
        "y": 540,
        "wires": [
            [
                "af684cb65465eef9"
            ]
        ]
    },
    {
        "id": "4d85f3207c9d8fa1",
        "type": "template",
        "z": "43652557380ac3f3",
        "d": true,
        "name": "element: rulesButtons",
        "field": "payload.pageElements.rulesButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'ruleUpdates', 'value': appendRules (null {{#payload.rules}}, createRuleObj('{{uid}}') {{/payload.rules}}) } ))\">\n        Forretningsregler godkendt\n    </button>\n\n    <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('grants')\">\n        Gå til tilskudssatser\n    </button>\n</div>\n",
        "output": "str",
        "x": 1300,
        "y": 580,
        "wires": [
            [
                "af684cb65465eef9"
            ]
        ]
    },
    {
        "id": "d5e098f6bd51179b",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "Set ActivePage",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.activePage",
                "pt": "global",
                "to": "payload.page",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.webSettings.state.activePage",
                "pt": "msg",
                "to": "payload.page",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 140,
        "y": 560,
        "wires": [
            [
                "b51ae96408813a15"
            ]
        ]
    },
    {
        "id": "7e1f73ec1d40cafe",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "Set ActivePage",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.activePage",
                "pt": "global",
                "to": "start",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "payload.webSettings.state.activePage",
                "pt": "msg",
                "to": "start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 520,
        "y": 1000,
        "wires": [
            [
                "c02e24bfe2197802"
            ]
        ]
    },
    {
        "id": "b24facdd74fa8b50",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "rulesToAccept?",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageElements.rulesToAccept",
                "pt": "msg",
                "to": "payload.webSettings.acceptances.rules = true ? false : true",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 560,
        "wires": [
            [
                "927b1a1a92e941cd"
            ]
        ]
    },
    {
        "id": "64b34f33550bce8e",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Login",
        "info": "",
        "x": 710,
        "y": 420,
        "wires": []
    },
    {
        "id": "d69d99eee8adcbf6",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "loginToAccept?",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageElements.loginToAccept",
                "pt": "msg",
                "to": "payload.webSettings.acceptances.login = true ? false : true",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 460,
        "wires": [
            [
                "d5dda5bcbcb28f81"
            ]
        ]
    },
    {
        "id": "d5dda5bcbcb28f81",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.webSettings.acceptances.login",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 460,
        "wires": [
            [
                "f1b774e14fa10452"
            ],
            [
                "2c36135f9e6b4609",
                "53d7186bbca94b8d"
            ]
        ]
    },
    {
        "id": "f4ff9a7a66ddb884",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: login",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">DQ loginoplysninger</div>\n    <div class=\"card-body\">\n        <p class=\"card-text\">Før du kan søge efter fakturaer, skal du indtaste dine kommunale loginoplysninger.</p>\n        \n        <div class=\"form-group\" id=\"form-group\">\n            <input type=\"hidden\" id=\"requestType\" value=\"acceptPage\">\n            <input type=\"hidden\" id=\"pageToAccept\" value=\"login\">\n            <input type=\"hidden\" id=\"toAccept\" value=\"{{payload.pageElements.loginToAccept}}\">\n            \n            <div class=\"form-floating mb-3 was-validated\">\n            <input type=\"text\" class=\"form-control\" id=\"dqUser\" placeholder=\"{{payload.webData.dqCreds.dqUser}}\" autocomplete=\"off\" disabled>\n            <label for=\"dqUser\">{{payload.webData.dqCreds.dqUser}}</label>\n            </div>\n            <div class=\"form-floating  was-validated\">\n            <input type=\"password\" class=\"form-control\" id=\"dqPass\" placeholder=\"Password\" style=\"font-family: 'password'\" disabled>\n            <label for=\"dqPass\" style=\"font-family: 'password'\">Kodeord</label>\n            </div>\n        </div>\n\n    </div>\n</div>\n<div class=\"card mb-2\">\n    <div class=\"card-header\">WorkLet loginoplysninger</div>\n    <div class=\"card-body\">\n        <p class=\"card-text\">Her skal du indtaste kommunens loginoplysninger til WorkLet.</p>\n        \n        <div class=\"form-group\" id=\"form-group\">\n            <input type=\"hidden\" id=\"requestType\" value=\"acceptPage\">\n            <input type=\"hidden\" id=\"pageToAccept\" value=\"login\">\n            <input type=\"hidden\" id=\"toAccept\" value=\"{{payload.pageElements.loginToAccept}}\">\n            \n            <div class=\"form-floating mb-3 was-validated\">\n            <input type=\"text\" class=\"form-control\" id=\"workletUser\" placeholder=\"{{payload.webData.workletCreds.workletUser}}\" autocomplete=\"off\" disabled>\n            <label for=\"workletUser\">{{payload.webData.workletCreds.workletUser}}</label>\n            </div>\n            <div class=\"form-floating  was-validated\">\n            <input type=\"password\" class=\"form-control\" id=\"workletPass\" placeholder=\"Password\" style=\"font-family: 'password'\" disabled>\n            <label for=\"workletPass\" style=\"font-family: 'password'\">Kodeord</label>\n            </div>\n        </div>\n\n        {{{payload.pageElements.loginButtons}}}\n\n    </div>\n</div>\n\n\n",
        "output": "str",
        "x": 1330,
        "y": 480,
        "wires": [
            [
                "e36e40cecb56969d"
            ]
        ]
    },
    {
        "id": "f1b774e14fa10452",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: loginButtons",
        "field": "payload.pageElements.loginButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-primary\" id=\"button_acceptPage\" type=\"submit\" onclick=\"\">\n        Godkend loginoplysninger\n    </button>\n    \n    <button class=\"btn btn-lg btn-primary ml-2 goNext hidden\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('rules')\">\n        Gå til forretningsregler\n    </button>\n</div>\n",
        "output": "str",
        "x": 1100,
        "y": 440,
        "wires": [
            [
                "f673e8538a4af3d9"
            ]
        ]
    },
    {
        "id": "2c36135f9e6b4609",
        "type": "template",
        "z": "43652557380ac3f3",
        "d": true,
        "name": "element: loginButtons",
        "field": "payload.pageElements.loginButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept') ))\">\n        Loginoplysninger godkendt\n    </button>\n    \n    <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('rules')\">\n        Gå til forretningsregler\n    </button>\n</div>\n",
        "output": "str",
        "x": 1100,
        "y": 480,
        "wires": [
            [
                "f4ff9a7a66ddb884"
            ]
        ]
    },
    {
        "id": "833c75852163c6a6",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "newRunCard body",
        "func": "// Set menu html\nconst loginAccepted = msg.payload.webSettings.acceptances.login;\nconst rulesAccepted = msg.payload.webSettings.acceptances.rules;\nconst grantsAccepted = msg.payload.webSettings.acceptances.grants;\nconst isRunning = msg.payload.webSettings.state.isRunning;\n\nvar dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\n\nvar currentRunExists = global.get(\"runHistory\", \"storeInFile\") !== null && global.get(\"runHistory\", \"storeInFile\") !== undefined && (\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ? !(global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]).isFinalized : !(global.get(\"runHistory\", \"storeInFile\")).isFinalized);\n\nvar currentRun = currentRunExists ?\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ?\n        global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]\n        : global.get(\"runHistory\", \"storeInFile\") : null;\n\nconst receiptsAwaiting = currentRunExists ? !currentRun.allReceiptsProcessed : false;\nconst isBeingProcessed = currentRunExists ? !currentRun.isFinalized : false;\n\n\nvar rejectedCitizenCount = 0; //global.get(\"webData\")[\"citizens-noactions\"] == null ? 0 : global.get(\"webData\")[\"citizens-noactions\"].length;\nvar receiptCount = 0;\n\nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n    {\n        if (!Array.isArray(global.get(\"webData\")[\"citizens-actions\"]))\n        {\n            var tempWebData = global.get(\"webData\");\n            tempWebData[\"citizens-actions\"] = [tempWebData[\"citizens-actions\"]];\n            global.set(\"webData\", tempWebData);\n        }\n\n        receiptCount += global.get(\"webData\")[\"citizens-actions\"].length;\n    }\n\nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined)\n    {\n        if (!Array.isArray(global.get(\"webData\")[\"citizens-noactions\"])) {\n            var tempWebData = global.get(\"webData\");\n            tempWebData[\"citizens-noactions\"] = [tempWebData[\"citizens-noactions\"]];\n            global.set(\"webData\", tempWebData);\n        }\n\n        rejectedCitizenCount = global.get(\"webData\")[\"citizens-noactions\"].length;\n        receiptCount += rejectedCitizenCount;\n    }\n\nvar remainingCount = 0;\n\nfor (var i = 0; i < rejectedCitizenCount; i++)\n    if (!(global.get(\"webData\")[\"citizens-noactions\"])[i].archived)\n        remainingCount++;\n\nrejectedCitizenCount = remainingCount;\n\n\n\nvar cardHeader = \"Ny kørsel\";\nvar cardTitle =\"Kør nu\";\nvar cardText = \"Robotten er nu klar til at søge efter nye fakturaer og beregne tilskud!\";\nvar buttonText = \"Kør robot\";\nvar linkhref = \"run\";\nvar border = \"light\";\nvar buttonClasses = \" \";\n\n\n\nif (isRunning) {\n    cardTitle = \"Robotten arbejder ... <i class='float-right fa-md fas fa-spinner fa-spin' style='margin-right: 5px'></i>\";\n    cardText = \"Robotten arbejder på at finde nye fakturaer samt beregne tilskud.\"\n    buttonText = \"Vent venligst\";\n    buttonClasses += \"hidden\";\n    linkhref = \"view-receipts\";\n    border = \"info\";\n}\nelse if ((receiptsAwaiting && isBeingProcessed && !dataExists) || (receiptsAwaiting && receiptCount == 0))\n{\n    cardHeader = \"Genoptag kørsel\";\n    cardTitle = \"Data mangler\";\n    cardText = \"Genoptag kørslen for at hente manglende data.\";\n    linkhref = \"run\";\n    buttonText = \"Genoptag\";\n}\n\nelse if (receiptsAwaiting && rejectedCitizenCount > 0)\n{\n    cardHeader = \"Borgere uden gyldig bevilling\";\n    cardTitle = rejectedCitizenCount == 0 ? \"Ingen fakturaer\" : rejectedCitizenCount + \" borgere afventer\";\n    cardText = \"Efter seneste kørsel er der \" + rejectedCitizenCount + \" borgere uden gyldig bevilling som afventer bekræftelse.\";\n    buttonText = \"Se borgere\";\n    buttonClasses += rejectedCitizenCount == 0 ? \"hidden\" : \"\";\n    linkhref = \"view-nograntreceipts\";\n    border = rejectedCitizenCount > 0 ? \"warning\" : \"light\";\n\n}\nelse if (isBeingProcessed && !receiptsAwaiting)\n{\n    cardHeader = \"Afslut kørsel\";\n    cardTitle = \"Alle borgere behandlet\",\n    cardText = \"Alle anbefalede handlinger samt ej berretigede borgere er bekræftet. Afslut kørslen nu.\"\n    buttonText = \"Afslut kørsel\";\n    border = \"success\";\n}\n\nelse if (receiptsAwaiting && rejectedCitizenCount == 0)\n{\n    cardHeader = \"Afslut kørsel\";\n    cardTitle = \"Alle borgere behandlet\",\n        cardText = \"Alle borgere uden bevilling er bekræftet. Bekræft anbefalede handlinger før du afslutter kørslen.\"\n    buttonText = \"Afslut kørsel\";\n    buttonClasses += \"disabled\";\n}\n\nelse if (!loginAccepted) {\n    cardTitle = \"Godkend login\";\n    cardText = \"Før du kan søge efter nye fakturaer, skal du godkende loginoplysninger.\"\n    buttonText = \"Gå til loginoplysninger\";\n    linkhref = \"login\";\n}\n\nelse if (!rulesAccepted) {\n    cardTitle = \"Godkend regelsæt\";\n    cardText = \"Før du kan søge efter nye fakturaer, skal du godkende forretningsregler.\"\n    buttonText = \"Gå til forretningsregler\";\n    linkhref = \"rules\";\n}\n\nelse if(!grantsAccepted)\n{\n    cardTitle = \"Godkend tilskudssatser\";\n    cardText = \"Før du kan søge efter nye fakturaer, skal du godkende tilskudssatser.\"\n    buttonText = \"Gå til tilskudssatser\";\n    linkhref = \"grants\";\n}\n\n\nvar classes = \"border-\" + border;\n\nvar html = `<h4 class=\"card-title\">`+cardTitle+`</h4>\n        <p class=\"card-text\">`+cardText+`</p>\n        <div class=\"d-grid\">\n            <button class=\"btn btn-lg btn-light border-light`+buttonClasses+`\" onclick=\"goToPage('`+linkhref+`')\">`+buttonText+`</button>\n        </div>`;\n\nmsg.payload.pageElements['newRunCardBody'] = html;\nmsg.payload.pageElements['newRunCardClasses'] = classes;\nmsg.payload.pageElements['newRunCardHeader'] = cardHeader;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 750,
        "y": 1080,
        "wires": [
            [
                "e4fc06b7c36a80c5"
            ]
        ]
    },
    {
        "id": "3ddbdc7f1b2f9ec5",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Receipts",
        "info": "",
        "x": 720,
        "y": 80,
        "wires": []
    },
    {
        "id": "25eef4e978cf76c9",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: grants",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">Tilskudssatser</div>\n    <div class=\"card-body\">\n        <h6 class=\"card-subtitle mb-2 text-muted\">Sæt tilskudssatserne fra Danmark</h6>\n        <p class=\"card-text\">Kontrollér/sæt og derefter godkendt tilskudssatserne som robotten fratrækker tilskudsberegningen såfremt borgeren modtager tilskud fra Sygesikring Danmark.</p>\n        \n        <div class=\"form-group\" id=\"form-group\">\n            <div class=\"mt-3 border-bottom\" style=\"padding-left: 15px;padding-right: 15px\">\n                <input type=\"hidden\" id=\"requestType\" value=\"acceptPage\">\n                <input type=\"hidden\" id=\"pageToAccept\" value=\"grants\">\n                <input type=\"hidden\" id=\"toAccept\" value=\"{{payload.pageElements.grantsToAccept}}\">\n            \n                {{{payload.pageElements.grantList}}}\n\n            </div>\n        </div>\n\n        {{{payload.pageElements.grantButtons}}}\n\n    </div>\n</div>",
        "output": "str",
        "x": 1510,
        "y": 660,
        "wires": [
            [
                "40780cb4bb9bca19"
            ]
        ]
    },
    {
        "id": "40780cb4bb9bca19",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Tilskudssatser",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1670,
        "y": 660,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "6839897d12a405ac",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.webSettings.acceptances.grants",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 910,
        "y": 660,
        "wires": [
            [
                "08ae4c04ae16a403"
            ],
            [
                "04dafd05828f33bf"
            ]
        ]
    },
    {
        "id": "ad6ebb9c838e1c6c",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Grants",
        "info": "",
        "x": 710,
        "y": 620,
        "wires": []
    },
    {
        "id": "04dafd05828f33bf",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: grantList",
        "field": "payload.pageElements.grantList",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{{#payload.grants.tilskudsperioder.satser}}\n    <div class=\"row border-top pb-2 pt-2 \">\n\n\n        <div class=\"col-2 d-flex flex-column justify-content-center\">\n            <span>{{titel}}</span>\n        </div>\n\n        <div class=\"form-floating col was-validated\" id=\"inputContainer_{{id}}_procent\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{id}}_procent\" placeholder=\"0\" value=\"{{{tilskud_procent}}}\" disabled>\n            <label for=\"value_{{id}}_procent\" style=\"padding-left: 27px\">% af egenbetaling</label>\n        </div>\n\n        <div class=\"form-floating col was-validated\" id=\"inputContainer_{{id}}_maxdkk\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{id}}_maxdkk\" placeholder=\"0\" value=\"{{{tilskud_maxdkk}}}\" disabled>\n            <label for=\"value_{{id}}_maxdkk\" style=\"padding-left: 27px\">Dog maks kr.</label>\n        </div>\n\n\n    </div>\n{{/payload.grants.tilskudsperioder.satser}}",
        "output": "str",
        "x": 1090,
        "y": 680,
        "wires": [
            [
                "955c894fc9dffd45",
                "6e08782524148718"
            ]
        ]
    },
    {
        "id": "08ae4c04ae16a403",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: grantList",
        "field": "payload.pageElements.grantList",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{{#payload.grants.tilskudsperioder.satser}}\n    <div class=\"row border-top pb-2 pt-2 \">\n\n\n        <div class=\"col-2 d-flex flex-column justify-content-center\">\n            <span>{{titel}}</span>\n        </div>\n\n        <div class=\"form-floating col\" id=\"inputContainer_{{id}}_procent\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{id}}_procent\" placeholder=\"0\" value=\"{{tilskud_procent}}\">\n            <label for=\"value_{{id}}_procent\" style=\"padding-left: 27px\">% af egenudgift</label>\n        </div>\n\n\n        <div class=\"form-floating col\" id=\"inputContainer_{{id}}_maxdkk\">\n            <input type=\"text\" class=\"form-control\" id=\"value_{{id}}_maxdkk\" placeholder=\"0\" value=\"{{tilskud_maxdkk}}\">\n            <label for=\"value_{{id}}_maxdkk\" style=\"padding-left: 27px\">Dog maks kr.</label>\n        </div>\n\n    </div>\n{{/payload.grants.tilskudsperioder.satser}}",
        "output": "str",
        "x": 1090,
        "y": 640,
        "wires": [
            [
                "2cc90de707d18884"
            ]
        ]
    },
    {
        "id": "2cc90de707d18884",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "element: grantButtons",
        "field": "payload.pageElements.grantButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-primary\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'grantUpdates', 'value': appendRules (null {{#payload.grants.tilskudsperioder.satser}}, createGrantObj('{{id}}') {{/payload.grants.tilskudsperioder.satser}}) } ))\">\n        Godkend tilskudssatser\n    </button>\n    \n    <button class=\"btn btn-lg btn-primary ml-2 goNext hidden\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('run')\">\n        Gå til ny kørsel\n    </button>\n</div>\n",
        "output": "str",
        "x": 1300,
        "y": 640,
        "wires": [
            [
                "25eef4e978cf76c9"
            ]
        ]
    },
    {
        "id": "955c894fc9dffd45",
        "type": "template",
        "z": "43652557380ac3f3",
        "d": true,
        "name": "element: grantButtons",
        "field": "payload.pageElements.grantButtons",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"float-right mt-2\">\n    <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'grantUpdates', 'value': appendRules (null {{#payload.grants.tilskudsperioder.satser}}, createGrantObj('{{id}}') {{/payload.grants.tilskudsperioder.satser}}) } ))\">\n        Godkend tilskudssatser\n    </button>\n    \n    <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('run')\">\n        Gå til ny kørsel\n    </button>\n</div>\n",
        "output": "str",
        "x": 1300,
        "y": 680,
        "wires": [
            [
                "25eef4e978cf76c9"
            ]
        ]
    },
    {
        "id": "16bf0e6580aaf246",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "grantsToAccept?",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageElements.grantsToAccept",
                "pt": "msg",
                "to": "payload.webSettings.acceptances.grants = true ? false : true",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 750,
        "y": 660,
        "wires": [
            [
                "6839897d12a405ac"
            ]
        ]
    },
    {
        "id": "b50802089303913c",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "diff",
        "propertyType": "msg",
        "rules": [
            {
                "t": "gt",
                "v": "payload.webSettings.settings.idleTimeout",
                "vt": "msg"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 210,
        "y": 340,
        "wires": [
            [
                "69aaa1828fd4b85b"
            ],
            [
                "ab622e75bfcfc759"
            ]
        ]
    },
    {
        "id": "ab622e75bfcfc759",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set lastPingMillis",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings.currentSession.lastPingMillis",
                "pt": "msg",
                "to": "$millis()",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.currentSession.lastPingMillis",
                "pt": "global",
                "to": "payload.webSettings.currentSession.lastPingMillis",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 360,
        "wires": [
            [
                "d5e098f6bd51179b"
            ]
        ]
    },
    {
        "id": "d64936a739a436db",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "Check last ping",
        "rules": [
            {
                "t": "set",
                "p": "now",
                "pt": "msg",
                "to": "$millis()",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "diff",
                "pt": "msg",
                "to": "now - payload.webSettings.currentSession.lastPingMillis",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 180,
        "y": 300,
        "wires": [
            [
                "b50802089303913c"
            ]
        ]
    },
    {
        "id": "69aaa1828fd4b85b",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.login",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.rules",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.grants",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings",
                "pt": "global",
                "to": "payload.webSettings",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 320,
        "wires": [
            [
                "ab622e75bfcfc759"
            ]
        ]
    },
    {
        "id": "4a3562049478bf32",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Run",
        "info": "",
        "x": 710,
        "y": 720,
        "wires": []
    },
    {
        "id": "c83fdc0290f77ad3",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Kør robot",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 760,
        "wires": [
            [
                "6fc6a8b8c6d3b766"
            ]
        ]
    },
    {
        "id": "b91122f99171796c",
        "type": "comment",
        "z": "43652557380ac3f3",
        "name": "Finalized",
        "info": "",
        "x": 720,
        "y": 840,
        "wires": []
    },
    {
        "id": "89f051f162c9b4b6",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "page: finalized",
        "field": "payload.pageContent",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "<div class=\"card mb-2\">\n    <div class=\"card-header\">Kørslen blev afsluttet</div>\n    <div class=\"card-body\">\n        <p class=\"card-text\">\n\n            Kørslen blev afluttet med success.\n\n            <div class=\"d-flex flex-wrap pb-4\" style=\"gap: 8px\">\n                <div class=\"card border-success mt-1\" style=\"max-width: 20rem;\">\n                    <div class=\"card-body text-center p-3\">\n                        <p class=\"card-text fs-lg\">{{payload.pageElements.receiptCount}}</p>\n                    </div>\n                    <div class=\"card-header border-top no-border-bottom\">Anbefalede handlinger</div>\n                </div>\n\n                <div class=\"card border-danger mt-1\" style=\"max-width: 20rem;\">\n                    <div class=\"card-body text-center p-3\">\n                        <p class=\"card-text fs-lg\">{{payload.pageElements.receiptNoActionCount}}</p>\n                    </div>\n                    <div class=\"card-header border-top no-border-bottom\">Borgere uden bevilling</div>\n                </div>\n            </div>\n\n            ... blev manuelt behandlet under dagens kørsel.\n\n        </p>\n    </div>\n</div>",
        "output": "str",
        "x": 980,
        "y": 880,
        "wires": [
            [
                "163120aa4a431574"
            ]
        ]
    },
    {
        "id": "163120aa4a431574",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "set page title",
        "rules": [
            {
                "t": "set",
                "p": "payload.pageTitle",
                "pt": "msg",
                "to": "Kørsel afsluttet",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 880,
        "wires": [
            [
                "afc6fa2bb250f63c"
            ]
        ]
    },
    {
        "id": "4f3852df34ce990f",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "page: run",
        "func": "var dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\nvar receiptsAwaiting = msg.currentRun == null ? false : !msg.currentRun.allReceiptsProcessed;\nvar isFinalized = msg.currentRun == null ? true : msg.currentRun.isFinalized;\n\nvar receiptCount = 0;\n\nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptCount += global.get(\"webData\")[\"citizens-actions\"].length;\n        \nif (global.get(\"webData\") !== undefined)\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined) \n        receiptCount += global.get(\"webData\")[\"citizens-noactions\"].length;\n\n\nfunction pageAccepted(pageName)\n{\n    return (msg.payload.webSettings.acceptances[pageName]);\n}\nfunction allPagesAccepted()\n{\n    return (pageAccepted(\"login\") && pageAccepted(\"rules\") && pageAccepted(\"grants\"));\n}\n\nvar header = \"Kør robot\";\nvar subheader =\"Start søgning efter nye fakturaer\";\nvar buttonHtml = \"\";\nvar cardtext =\"Robotten henter først fakturaer fra WorkLet, og beregner derefter potientielle tilskud.\";\n\nif (msg.payload.webSettings.state.isRunning) {\n    buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_startRun\" type=\"button\" onclick=\"startRun()\" style=\"width: 300px\" disabled>\n                    <i class=\"fa-lg fas fa-spinner fa-spin\"></i>\n                  </button>`;\n\n}\nelse if((receiptsAwaiting && !dataExists) || (receiptsAwaiting && receiptCount == 0))\n{\n    \n    header = \"Genoptag kørsel\";\n    subheader = \"Genoptag seneste uafsluttede kørsel\";\n    cardtext = \"Da robotten har været lukket siden kørslen først blev startet, er alt persondata for kørslen tabt. Genoptag kørslen for at hente data.\";\n\n    if (allPagesAccepted())\n        buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_startRun\" type=\"button\" onclick=\"startRun()\" style=\"width: 300px\">\n                            Genoptag kørsel\n                    </button>`;\n    else\n        buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_startRun\" type=\"button\" onclick=\"startRun()\" style=\"width: 300px\" disabled>\n                            Genoptag kørsel\n                    </button>`;\n\n\n    \n}\nelse if (receiptsAwaiting && !isFinalized)\n{\n    header = \"Afslut kørsel\";\n    header = \"Afventer bekræftelse af manuel behandling\";\n    cardtext = \"Du kan ikke afslutte kørslen før at du har godkendt manuel behandling af alle borgere med anbefalede handlinger, samt borgere som ikke er tilskudsberrettigede. Gå tilbage til start, og godkend de manglende borgere.\";\n    \n    buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_finalizeRun\" type=\"button\" onclick=\"\" style=\"width: 300px\" disabled>\n                        Afslut kørsel\n                  </button>`;\n\n}\nelse if (!receiptsAwaiting && !isFinalized)\n{\n\n    header =\"Afslut kørsel\";\n    subheader = \"Afslut seneste kørsel\";\n    cardtext = \"Er du sikker på at du vil afslutte seneste kørsel? Du vil ikke være i stand til at se borgeroplysninger eller anbefalede handlinger når kørslen er afsluttet, og en ny kørsel vil først kunne startes i morgen.\";\n\n    buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_finalizeRun\" type=\"button\" onclick=\"postRequest({'requestType': 'finalize'})\" style=\"width: 300px\">\n                        Afslut kørsel\n                  </button>`;\n\n}\nelse if(allPagesAccepted())\n{\n    buttonHtml = `<button class=\"btn btn-lg btn-primary ml-2 btn-lg\" id=\"button_startRun\" type=\"button\" onclick=\"startRun()\" style=\"width: 300px\">\n                    Start ny kørsel\n                  </button>`;\n\n}\nelse\n    buttonHtml = `<button class=\"btn btn-lg btn-secondary ml-2 btn-lg\" id=\"button_startRun\" type=\"button\" onclick=\"startRun()\" style=\"width: 300px\" disabled>\n                Start ny kørsel\n                </button>\n                <span class=\"text-danger\" style=\"margin-left: 10px\">OBS: Du kan først starte en ny kørsel, efter du har godkendt loginoplysninger, forretningsregler samt tilskudssatser.</span>`;\n\n\n\nvar html =\n    `<div class=\"card mb-2\">\n        <div class=\"card-header\">`+header+`</div>\n        <div class=\"card-body\">\n            <h6 class=\"card-subtitle mb-2 text-muted\">`+subheader+`</h6>\n            <p class=\"card-text\">`+cardtext+`</p>\n        \n            `+buttonHtml+`\n\n            <span class=\"text-info hidden\" id=\"statusText\" style=\"margin-left: 10px\">Status: Starter kørsel</span>\n            \n        </div>\n    </div>`;\n\nmsg.payload.pageContent = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1360,
        "y": 760,
        "wires": [
            [
                "c83fdc0290f77ad3"
            ]
        ]
    },
    {
        "id": "6e08782524148718",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: grantButtons",
        "func": "var html = `<div class=\"float-right mt-2\">\n                <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept') ))\"`+ ((msg.payload.webSettings.state.isRunning) ? ` disabled` : ``) + `>\n                    Tilskudssatser godkendt\n                </button>\n\n                <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('grants')\">\n                    Gå til ny kørsel\n                </button>\n            </div>`;\n\nmsg.payload.pageElements['grantButtons'] = html;\nreturn msg;\n\n/*\n\nfunction pageAccepted(pageName)\n{\n    return (msg.payload.webSettings.acceptances[pageName]);\n}\nfunction allPagesAccepted()\n{\n    return (pageAccepted(\"login\") && pageAccepted(\"rules\") && pageAccepted(\"grants\"));\n}\n\nvar html = \"\";\n\nif(allPagesAccepted())\n\n    html = `<div class=\"float-right mt-2\">\n                <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept') ))\"`+ ((msg.payload.webSettings.state.isRunning) ? ` disabled` : ``) +`>\n                    Godkend tilskudssatser\n                </button>\n                \n                <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('run')\">\n                    Gå til ny kørsel\n                </button>\n            </div>\n            `;\n\nelse\n\n    html = `<div class=\"float-right mt-2\">\n                <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept'), { 'id': 'grantUpdates', 'value': appendRules (null {{#payload.grants.tilskudsperioder.satser}}, createGrantObj('{{id}}') {{/payload.grants.tilskudsperioder.satser}}) } ))\">\n                    Tilskudssatser godkendt\n                </button>\n                \n                <button class=\"btn btn-lg btn-secondary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('run')\" disabled>\n                    Gå til ny kørsel\n                </button>\n            </div>\n            `;\n\n\nmsg.payload.pageElements['grantButtons'] = html;\nreturn msg;\n*/",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 680,
        "wires": [
            [
                "25eef4e978cf76c9"
            ]
        ]
    },
    {
        "id": "88fb35ef462682b4",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: rulesButtons",
        "func": "var html = `<div class=\"float-right mt-2\">\n                <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept') ))\"`+ ((msg.payload.webSettings.state.isRunning) ? ` disabled` : ``) +`>\n                    Forretningsregler godkendt\n                </button>\n\n                <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('grants')\">\n                    Gå til tilskudssatser\n                </button>\n            </div>`;\n\nmsg.payload.pageElements['rulesButtons'] = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1300,
        "y": 580,
        "wires": [
            [
                "af684cb65465eef9"
            ]
        ]
    },
    {
        "id": "53d7186bbca94b8d",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: loginButtons",
        "func": "var html = `<div class=\"float-right mt-2\">\n                <button class=\"btn btn-lg btn-success\" id=\"button_acceptPage\" type=\"button\" onclick=\"postRequest( toJSON( document.getElementById('requestType'), document.getElementById('pageToAccept'), document.getElementById('toAccept') ))\"`+ ((msg.payload.webSettings.state.isRunning) ? ` disabled` : ``) +`>\n                    Loginoplysninger godkendt\n                </button>\n                \n                <button class=\"btn btn-lg btn-primary ml-2 goNext\" id=\"button_acceptPage_goNext\" type=\"button\" onclick=\"goToPage('rules')\">\n                    Gå til forretningsregler\n                </button>\n            </div>\n            `;\n\nmsg.payload.pageElements['loginButtons'] = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 480,
        "wires": [
            [
                "f4ff9a7a66ddb884"
            ]
        ]
    },
    {
        "id": "b07e0dfc01e164a0",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "Specific citizen?",
        "property": "payload.spec",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1240,
        "y": 100,
        "wires": [
            [
                "7a64b3858edfdad8"
            ],
            [
                "93729e19de983eee"
            ]
        ]
    },
    {
        "id": "93729e19de983eee",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.spec",
                "pt": "msg",
                "to": "0",
                "tot": "num"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1460,
        "y": 120,
        "wires": [
            [
                "b32a26dc349f5b07"
            ]
        ]
    },
    {
        "id": "1184056262f02591",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "set temp data obj",
        "func": "/*\nif (!Array.isArray(msg.payload.tempDataArray))\n{\n    msg.payload.tempData = msg.payload.tempDataArray;\n    msg.payload.tempDataArray = [msg.payload.tempDataArray];\n}\nelse*/\n    msg.payload.tempData = msg.payload.tempDataArray[msg.payload.spec];\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2010,
        "y": 120,
        "wires": [
            [
                "d4601eb0c82d44dc"
            ]
        ]
    },
    {
        "id": "b0b8bd30f6fdf461",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "",
        "property": "payload.tempData.persondata.danmarkgruppe",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "0",
                "vt": "num"
            },
            {
                "t": "null"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 1490,
        "y": 200,
        "wires": [
            [
                "1f72e5564103eca8"
            ],
            [
                "a1bf4b6b1875b569"
            ],
            [
                "5ed1981ab9c124de"
            ]
        ]
    },
    {
        "id": "5ed1981ab9c124de",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "danmark",
        "rules": [
            {
                "t": "set",
                "p": "payload.tempData.persondata._danmark",
                "pt": "msg",
                "to": "\"Gruppe \" & payload.tempData.persondata.danmarkgruppe",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1640,
        "y": 220,
        "wires": [
            [
                "a1bf4b6b1875b569"
            ]
        ]
    },
    {
        "id": "1f72e5564103eca8",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "danmark",
        "rules": [
            {
                "t": "set",
                "p": "payload.tempData.persondata._danmark",
                "pt": "msg",
                "to": "Ej medlem",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1640,
        "y": 180,
        "wires": [
            [
                "a1bf4b6b1875b569"
            ]
        ]
    },
    {
        "id": "a2dc4dcc85327a6d",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Sager",
        "func": "if (msg.payload.tempData == undefined || msg.payload.tempData.persondata.sager == null || !Array.isArray(msg.payload.tempData.persondata.sager))\n    return msg;\n\nvar html = \"\";\nvar almCount = 0, kortCount = 0;\n\nfor(var i = 0; i < msg.payload.tempData.persondata.sager.length; i++)\n{\n\n    const obj = msg.payload.tempData.persondata.sager[i];\n\n    var til = obj.til == null ? \"ukendt udløbsdato\" : obj.til;\n    var alt = obj.aktiv ? \"Gyldig indtil \" + til : \"Gyldighed udløb \" + obj.til;\n\n    var border = obj.aktiv ? \"success\" : \"warning\";\n \n        if (!(obj.titel.toLowerCase()).includes(\"fod\"))\n        {\n            if ((obj.type.toLowerCase()).includes(\"almindeligt helbredstillæg\"))\n            {\n                border = \"info\";\n                if(almCount++ >= 1)\n                    continue;\n            }\n\n            else if (obj.type.toLowerCase().includes(\"helbredstillægskort\"))\n            {\n                border = \"info\";\n                if (kortCount++ >= 1)\n                    continue;\n            }\n            else\n                continue;\n        }\n\n    //html += `<button type=\"button\" class=\"btn btn-light border-` + border + ` text-black\" data-bs-container=\"body\" data-bs-toggle=\"popover\" data-bs-placement=\"left\" data-bs-content=\"Vivamus sagittis lacus vel augue laoreet rutrum faucibus.\" data-bs-original-title=\"Popover Title\">` + obj.type+`</button>`\n    var newTitle = obj.titel.split(\"(\")[0];\n\n    html += `\n        <div class=\"card border-`+border+`\">\n        <div class=\"card-header fs-10 pt-1 text-muted text-center\" style=\"height: 22px;text-transform:uppercase\">`+ newTitle +`</div>\n        <div class=\"card-body p-1 text-center\">\n            <p class=\"card-text fs-13 m-1\">`+ obj.type +`</p>\n        </div>\n        </div>\n    `;\n\n\n}\n\nmsg.payload.tempData.persondata._sager = html;\n\nreturn msg;\n\n\n\n",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1230,
        "y": 260,
        "wires": [
            [
                "9104824190b91e21"
            ]
        ]
    },
    {
        "id": "9104824190b91e21",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Fakturaer + handlinger",
        "func": "\nif (msg.payload.tempData == null || msg.payload.tempData == undefined)\n    return msg;\n\nif (!Array.isArray(msg.payload.tempData.regelbrud))\n    msg.payload.tempData.regelbrud = [msg.payload.tempData.regelbrud];\n\nvar fejl =\"\";\n    \nif (msg.payload.tempData.regelbrud[0] != null)\n    for (var j = 0; j < msg.payload.tempData.regelbrud.length; j++) {\n        const r_obj = msg.payload.tempData.regelbrud[j];\n\n        var regelbrud = r_obj.rule != null ? r_obj.rule + \": \" + r_obj.description : r_obj; //+ \" (\" + r_obj.objectValue + \" \" + r_obj.operator + \" \" + r_obj.expectedValue + \")\";\n\n        fejl += `<div class=\"card mb-2 border-warning header-left\" style=\"\">\n                    <div class=\"card-header header-left text-muted fs-10\" style=\"width:20%;border-right: 1px solid rgba(0,0,0,0.125)\">REGELBRUD</div>\n                    <div style=\"align-self: center;padding-left:10px\">`+ regelbrud + `</div>\n                </div>`;\n    }\n\nmsg.payload.tempData._faktura = fejl;\n\nif (msg.payload.tempData.faktura == null)\n    return msg;\n\nfunction round(num) {\n    return Math.round((num + Number.EPSILON) * 100) / 100;\n}\n\nvar html = \"\";\n\nif (!Array.isArray(msg.payload.tempData.faktura))\n    msg.payload.tempData.faktura = [msg.payload.tempData.faktura];\n\nfor(var i = 0; i < msg.payload.tempData.faktura.length; i++)\n{\n    const obj = msg.payload.tempData.faktura[i];\n\n    var handlinger = \"\";\n\n    if (!Array.isArray(msg.payload.tempData.handlinger))\n        msg.payload.tempData.handlinger = [msg.payload.tempData.handlinger];\n\n    var k = 0;\n    var total = 0;\n\n    if (msg.payload.tempData.handlinger[0] != null)\n        for(var j = 0; j < msg.payload.tempData.handlinger.length; j++)\n        {\n\n            const h_obj = msg.payload.tempData.handlinger[j];\n            if(h_obj.fid != obj.id)\n            {\n                k++;\n                continue;\n            }\n\n            var handling;\n            if(h_obj.tilskud != null)\n            {\n                var nyttilskud = round(h_obj.tilskud);\n                total += nyttilskud;\n                total = round(total);\n                handling = h_obj.handling + \" - tilskud gives: \" + nyttilskud + \" kr\"\n                    + ((total > nyttilskud) ? \" <span class='text-muted'>(total: \" + total + \" kr)</span>\" : \"\");\n            }\n            else\n                handling = h_obj.handling + \" - \" + (h_obj.type == \"A\" ? \"udvidet helbredstillæg\" : \"alm. helbredstillæg\");\n\n            handlinger += `\n                <div class=\"card mb-2 border-light header-left\" style=\"\">\n                    <div class=\"card-header header-left text-muted fs-10\" style=\"width:20%;border-right: 1px solid rgba(0,0,0,0.125)\">HANDLING #`+(j+1-k)+`</div>\n                    <div style=\"align-self: center;padding-left:10px\">`+handling+`</div>\n                </div>`;\n        }\n\n\n    if (obj.behandlinger != null)\n        if (!Array.isArray(obj.behandlinger))\n            obj.behandlinger = [obj.behandlinger];\n\n    var behandlinger = \"\";\n\n    if (obj.behandlinger != null)\n        for (var k = 0; k < obj.behandlinger.length; k++)\n        {\n            var b_obj = obj.behandlinger[k];\n            behandlinger += `<tr>\n                                <td>`+ b_obj.ydelsesnummer+`</td>\n                                <th scope=\"row\">`+ b_obj.titel + ` (type ` + b_obj.type +`)</th>\n                                <td>`+ b_obj.patientAndel +`</td>\n                                <td>`+ b_obj.sygesikringsAndel +`</td>\n                                <th  scope=\"row\">`+ round(b_obj.patientAndel + b_obj.sygesikringsAndel) + `</th>\n                            </tr>`;\n        }\n    behandlinger += `<tr class=\"no-border-bottom\">\n                            <td></td>\n                            <th scope=\"row\"></th>\n                            <td></td>\n                            <td></td>\n                            <th scope=\"row\">`+ round(obj.total) + `</th>\n                    </tr>`;\n\n\n    if(obj.ydernummer == null || obj.ydernummer == \"ydernummermangler\")\n        html += `<div class=\"card border-warning mb-2 p-1\">\n            <span class=\"pl-2 fs-13\"><b>OBS</b>: Behandler har IKKE oplyst ydernummer</span>\n        </div>`;\n\n    html += `\n    <div class=\"card border-light mb-2\">\n        <!-- Faktura  -->\n\n        <div class=\"card-header text-muted fs-10\" style=\"height: 38px\">FAKTURA #`+(i+1)+`\n            <span class=\"float-center\">\n            </span>\n            <span class=\"float-right\">\n                `+obj.dato+`\n                <a href=\"http://workletnew.snapp.dk/auth/sign-in/`+obj.id+`\" target=\"_blank\" style=\"padding-left: 10px\">\n                    <span class=\"float-right text-muted\" style=\"margin-top:-1px\"><i class=\"fas fa-sm fa-link\"></i></span>\n                </a>\n            </span>\n        </div>\n        <div class=\"card-body p-3\" style=\"padding-top: 0px!important;padding-bottom: 0px!important\">\n\n            <table class=\"table\">\n                <thead class=\"border-none\">\n                    <tr>\n                        <th scope=\"col\"><span class=\"table-header\">Ydelsesnr.</span></th>\n                        <th scope=\"col\"><span class=\"table-header\">Ydelse</span></th>\n                        <th scope=\"col\"><span class=\"table-header\">Egenbetaling</span></th>\n                        <th scope=\"col\"><span class=\"table-header\">Sygesikring</span></th>\n                        <th scope=\"col\"><span class=\"table-header\">Total</span></th>\n                    </tr>\n                </thead>\n                <tbody>\n                    `+behandlinger+`\n                </tbody>\n            </table>\n\n        </div>\n\n        <!-- /Faktura -->\n    </div>\n    `;\n\n    html += handlinger;\n\n    if ((msg.payload.tempData.faktura.length - 1) == i)\n        html += fejl;\n\n\n}\n\nmsg.payload.tempData._faktura = html;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1420,
        "y": 260,
        "wires": [
            [
                "449ee6323dbb0e10"
            ]
        ]
    },
    {
        "id": "449ee6323dbb0e10",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Pagination",
        "func": "var page = msg.payload.page;\n\nvar maxCount = 8;\nmaxCount = maxCount > (parseInt(msg.payload.tempDataLength)-1) ? (parseInt(msg.payload.tempDataLength)-1) : maxCount;\n\nvar countBeforeActive = msg.payload.spec > 4 ? 4 : msg.payload.spec;\nvar countAfterActive = maxCount - countBeforeActive;\nvar countAfterActive = ((countAfterActive + parseInt(msg.payload.spec)) > (parseInt(msg.payload.tempDataLength) - 1)) ? (msg.payload.tempDataLength - msg.payload.spec -1) : countAfterActive;\n\nif(countAfterActive < 4 && msg.payload.spec > maxCount-countAfterActive)\n    countBeforeActive = maxCount - countAfterActive;\n\n\nfunction isArchived (id)\n{\n    if (msg.payload.tempDataArray[id] != null && msg.payload.tempDataArray[id] != undefined)\n        return msg.payload.tempDataArray[id].archived;\n    else return false;\n}\n\nvar html = `<ul class=\"pagination\">`;\n\n// Arrow left\nif(countBeforeActive > 0)\n    html += `<li class=\"page-item\">\n             <a class=\"page-link\" onClick=\"goToPage('`+ page +`?spec=`+ (parseInt(msg.payload.spec) - 1) +`')\">&laquo;</a>\n             </li>`;\n\n// previous\nfor (var i = 0; i < countBeforeActive; i++)\n{\n    var id = -(countBeforeActive - parseInt(msg.payload.spec) - i);\n\n    html += `<li class=\"page-item`+(isArchived(id) ? ` archived`:``)+`\">\n            <a class=\"page-link\" onClick=\"goToPage('`+ page +`?spec=`+ id + `')\">` +(parseInt(id) + 1)+`</a>\n            </li> `;\n}\n\n// active\nhtml += `<li class=\"page-item active` + (isArchived(msg.payload.spec) ? ` archived` : ``) +`\">\n            <a class=\"page-link\">`+ (parseInt(msg.payload.spec)+1) + `</a>\n         </li> `;\n\n// after\nfor (var i = 0; i < countAfterActive; i++) {\n    var id = (parseInt(msg.payload.spec) + 1 + i);\n    html += `<li class=\"page-item` + (isArchived(id) ? ` archived` : ``) +`\">\n            <a class=\"page-link\" onClick=\"goToPage('`+ page +`?spec=`+ id + `')\">` + (parseInt(id) + 1)+ `</a>\n            </li> `;\n}\n\n// Arrow right\nif (countAfterActive >= 1)\nhtml += `<li class=\"page-item\">\n            <a class=\"page-link\" onClick=\"goToPage('`+ page +`?spec=`+ (parseInt(msg.payload.spec) + 1) +`')\">&raquo;</a>\n         </li>`;\n\nhtml += `</ul>`;\n\nmsg.payload.tempData._pagination = html;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1630,
        "y": 260,
        "wires": [
            [
                "3f57e4a3850446e6"
            ]
        ]
    },
    {
        "id": "7a64b3858edfdad8",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "set tempDataLength",
        "func": "if (!Array.isArray(msg.payload.tempDataArray))\n{\n    msg.payload.tempDataArray = [msg.payload.tempDataArray];\n}\n\nmsg.payload.tempDataLength = msg.payload.tempDataArray.length;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 2000,
        "y": 80,
        "wires": [
            [
                "1184056262f02591"
            ]
        ]
    },
    {
        "id": "193590a736c24869",
        "type": "template",
        "z": "43652557380ac3f3",
        "name": "set body HTML",
        "field": "payload.bodyHTML",
        "fieldType": "msg",
        "format": "handlebars",
        "syntax": "mustache",
        "template": "{{{payload.pageElements.navbar}}}\n\n<!--div class=\"progress-container collapsed\">\n\n    <div class=\"uppercase fs-10 fw-500 mb-1\" style=\"width:100%;text-align: center;\">Robotten arbejder ... 56%</div>\n\n    <div class=\"progress bg-dark\">\n        <div class=\"progress-bar progress-bar-striped progress-bar-animated\" role=\"progressbar\" aria-valuenow=\"75\" aria-valuemin=\"0\" aria-valuemax=\"100\" style=\"width: 75%;\"></div>\n    </div>\n\n\n</div-->\n\n  \n<div class=\"container site-container mt-3\">\n    <!-- site -->\n\n    <ol class=\"breadcrumb\">\n        <li class=\"breadcrumb-item active\">{{{payload.pageTitle}}}</li>\n    </ol>\n\n    <div id=\"alertParent\">\n        <div class=\"alert alert-dismissible hidden\" id=\"alertBox\">\n            <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\n            <h4 class=\"alert-heading\" id=\"alertBox-heading\">Warning!</h4>\n            <p class=\"mb-0\" id=\"alertBox-body\">Best check yo self, you're not looking too good. Nulla vitae elit libero, a pharetra augue. Praesent commodo cursus magna, <a href=\"#\" class=\"alert-link\">vel scelerisque nisl consectetur et</a>.</p>\n        </div>\n    </div>\n\n\n    <div id=\"pageContent\">\n        {{{payload.pageContent}}}\n    </div>\n\n    <!-- /site -->\n</div>",
        "output": "str",
        "x": 2060,
        "y": 740,
        "wires": [
            []
        ]
    },
    {
        "id": "50420eba13820fd6",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: actionsCard",
        "func": "var receiptCount = 0;\nvar totalReceiptCount = 0;\nvar remainingCount = 0;\n\nvar dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\n\nif (dataExists)\n{\n\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n\n        if (!Array.isArray(global.get(\"webData\")[\"citizens-actions\"]))\n        {\n            var webData = global.get(\"webData\");\n            webData[\"citizens-actions\"] = [webData[\"citizens-actions\"]];\n            global.set(\"webData\", webData);\n        }\n            //global.set(\"webData\")[\"citizens-actions\"] = [global.get(\"webData\")[\"citizens-actions\"])];\n\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptCount = global.get(\"webData\")[\"citizens-actions\"].length;\n\n\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined)\n        totalReceiptCount = receiptCount + global.get(\"webData\")[\"citizens-noactions\"].length;\n\n    for (var i = 0; i < receiptCount; i++)\n        if (!((global.get(\"webData\")[\"citizens-actions\"])[i]).archived)\n            remainingCount++;\n}\n\n/*\nif (global.get(\"runHistory\", \"storeInFile\") !== undefined)\n    if (global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length - 1] !== undefined)\n        acceptedReceiptCount = global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length - 1].processedReceipts.length;*/\n\n\n//typeof global.get(\"webData\") == undefined || !Array.isArray(global.get(\"webData\")[\"citizens-actions\"]) ? 0 : global.get(\"webData\")[\"citizens-actions\"].length;\n//var remainingCount = receiptCount - acceptedReceiptCount;\n\n\n//receiptCount = remainingCount;\nvar html = ``;\n\nif (msg.payload.webSettings.state.isRunning)\n{\n    html = `<div class=\"card border-light\">\n    <div class=\"card-header\">Anbefalede handlinger</div>\n    <div class=\"card-body\">\n        <h4 class=\"card-title\">Ingen handlinger</h4>\n        <p class=\"card-text\">Vent venligst på at robotten bliver færdig med at arbejde...</p>\n        </div>\n    </div>`;\n    msg.payload.pageElements.actionsCard = html;\n    return msg;\n}\n\nvar currentRunExists = global.get(\"runHistory\", \"storeInFile\") !== null && global.get(\"runHistory\", \"storeInFile\") !== undefined && ( \n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ? !(global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]).isFinalized : !(global.get(\"runHistory\", \"storeInFile\")).isFinalized);\n\nvar currentRun = currentRunExists ?\n                    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ?\n                        global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]\n                        : global.get(\"runHistory\", \"storeInFile\") : null;\n\n\nconst receiptsAwaiting = currentRunExists ? !currentRun.allReceiptsProcessed : false;\nconst isFinialized = currentRunExists ? currentRun.isFinalized : true;\n\nvar border = (receiptsAwaiting && !dataExists) || (receiptsAwaiting && totalReceiptCount == 0) ? `danger` : receiptsAwaiting && receiptCount > 0 ? `info` : `light`;\nvar title =  (receiptsAwaiting && !dataExists) || (receiptsAwaiting && totalReceiptCount == 0) ? \"Genoptag kørsel\" :\n              receiptsAwaiting ? (remainingCount + ` borgere afventer`) : !isFinialized ? `Afslut kørsel` :`Ingen fakturaer`;\nvar body = (receiptsAwaiting && !dataExists) || (receiptsAwaiting && totalReceiptCount == 0) ? \"Seneste kørsel blev ikke afsluttet. Genoptag kørslen for at hente manglende data.\" :\n              receiptsAwaiting ? \"Efter seneste kørsel er der \"+remainingCount+\" borgere med anbefalede handlinger som afventer behandling.\" : !isFinialized ? \"Afslut seneste kørsel til højre når du har bekræftet behandlingen af alle borgere.\" : \"Start en ny kørsel for at finde fakturaer som afventer behandling.\";\n\nhtml =\n`<div class=\"card border-`+border+`\">\n    <div class=\"card-header\">Anbefalede handlinger</div>\n    <div class=\"card-body\">\n        <h4 class=\"card-title\">`+title+`</h4>\n        <p class=\"card-text\">`+ body+`</p>\n        `\n        +\n        (remainingCount > 0 ? `<div class=\"d-grid\">\n            <button class=\"btn btn-lg btn-light border-light\" type=\"button\" onclick=\"goToPage('view-receipts')\">Se borgere</button>\n        </div>`\n        : ``)\n        +\n        `\n    </div>\n</div>`;\n\nmsg.payload.pageElements.actionsCard = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 1040,
        "wires": [
            [
                "833c75852163c6a6"
            ]
        ]
    },
    {
        "id": "3f57e4a3850446e6",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Archive button",
        "func": "var html;\n\nvar isArchived = msg.payload.tempDataArray[msg.payload.spec].archived;\n\nvar allIsArchived = true;\nfor (var i = 0; i < msg.payload.tempDataArray.length; i++)\n    if (!msg.payload.tempDataArray[i].archived)\n        allIsArchived = false;\n\n/*\nif(msg.payload.webSettings.state.isLocked)\n\n    html =\n        `<button class=\"btn btn-lg btn-light border-info\" type=\"button\" onclick=\"postRequest({'requestType': 'finish'})\">Afslut behandling</button>`;\n\nelse*/\n\nif(allIsArchived)\n    html =\n        `<button class=\"btn btn-lg btn-light border-light\" type=\"button\" onclick=\"goToPage('start')\">Gå til oversigt</button>`;\n\nelse\n    html =\n        `<button class=\"btn btn-lg btn-light border-light` +(isArchived ? ` disabled ` : ``)+`\" type=\"button\" onclick=\"postRequest({'requestType': 'archive', 'id': '`+msg.payload.spec+`'})\">Bekræft manuel behandling</button>`;\n\n\nmsg.payload.tempData._archive = html;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1840,
        "y": 260,
        "wires": [
            [
                "dfef270919197e96"
            ]
        ]
    },
    {
        "id": "7010338c1ded1b8a",
        "type": "switch",
        "z": "43652557380ac3f3",
        "name": "Data exists?",
        "property": "payload.tempDataArray",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1030,
        "y": 140,
        "wires": [
            [
                "b07e0dfc01e164a0"
            ],
            [
                "7e1f73ec1d40cafe"
            ]
        ]
    },
    {
        "id": "22c31b5dcd690404",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "element: lastRunCard",
        "func": "var lastRunObj = null;\n\n\n\nvar lastRunExists = global.get(\"runHistory\", \"storeInFile\") !== null && global.get(\"runHistory\", \"storeInFile\") !== undefined && (\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ? (global.get(\"runHistory\", \"storeInFile\")).length > 0 : true);\n\nvar lastRunObj = lastRunExists ?\n    Array.isArray(global.get(\"runHistory\", \"storeInFile\")) ?\n        global.get(\"runHistory\", \"storeInFile\")[(global.get(\"runHistory\", \"storeInFile\")).length - 1]\n        : global.get(\"runHistory\", \"storeInFile\") : null;\n\n/*\nif (global.get(\"runHistory\", \"storeInFile\") !== undefined)\n    if (global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length-1] !== undefined)\n        lastRunObj = global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length-1];\n\n*/\n\n\n\nvar html = ``;\n/*\nif (msg.payload.webSettings.state.isRunning)\n{\n    html =\n        `<div class=\"card border-light\">\n        <div class=\"card-header\">Seneste kørsel</div>\n        <div class=\"card-body\">\n            <h4 class=\"card-title\">Robotten arbejder lige nu...</h4>\n        </div>\n    </div>`;\n}\n\n\nelse*/ if (lastRunObj === null)\n{\n\n    html =\n    `<div class=\"card border-light\">\n        <div class=\"card-header\">Seneste kørsel</div>\n        <div class=\"card-body\">\n            <h4 class=\"card-title\">Ingen data</h4>\n        </div>\n    </div>`;\n}\n\nelse\n{\n    //var now = new Date(Date.now());\n    //var lastRunDate = new Date(lastRunObj.timestamp);\n    //var daysSinceRun = parseInt((Date.now() - lastRunObj.timestamp) / 86400000);\n\n    var daysSinceRun = Date.now() - lastRunObj.timestamp;\n    daysSinceRun = Math.ceil(daysSinceRun / (1000 * 3600 * 24)) -1;\n\n\n\n    var dayordays = daysSinceRun > 1 ? \"dage\" : \"dag\";\n\n    var lastRun = daysSinceRun == 0 ? \"Tidligere i dag\" : daysSinceRun + \" \" + dayordays + \" siden\";\n\n    html =\n    `<div class=\"card border-light\">\n        <div class=\"card-header\">Seneste kørsel</div>\n        <div class=\"card-body\">\n            <h4 class=\"card-title\">`+ lastRun + `</h4>\n            <p class=\"card-text\">Robotten kørte sidst d. `+ new Date(lastRunObj.timestamp).toLocaleString() + `<br />\n                <!--div class=\"mt-1\">\n                    <strong>0</strong> fakturaer automatisk behandlet.<br />\n                    <strong>5</strong> fakturaer sat til manuel behandling.\n                </div-->\n            </p>\n        </div>\n    </div>`;\n}\n\nmsg.payload.pageElements.lastRunCard = html;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 1000,
        "wires": [
            [
                "50420eba13820fd6"
            ]
        ]
    },
    {
        "id": "13e976910d5e9707",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.tempDataArray",
                "pt": "msg",
                "to": "webData.citizens-actions",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 120,
        "wires": [
            [
                "7010338c1ded1b8a"
            ]
        ]
    },
    {
        "id": "5ab143a5c04fb163",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.tempDataArray",
                "pt": "msg",
                "to": "webData.citizens-noactions",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 790,
        "y": 160,
        "wires": [
            [
                "7010338c1ded1b8a"
            ]
        ]
    },
    {
        "id": "b32a26dc349f5b07",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Find first un-archived receipt",
        "func": "var receiptCount = 0;\n\nif (msg.payload.tempDataArray !== undefined)\n    receiptCount = msg.payload.tempDataArray.length;\n\nvar anyReceiptsArchived = false;\n\nfor (var i = 0; i < receiptCount; i++)\n    if (!msg.payload.tempDataArray[i].archived)\n    {\n        msg.payload.spec = i;\n        break;\n    }\n    else\n        anyReceiptsArchived = true;\n\nif (anyReceiptsArchived && msg.payload.spec == 0)\n    msg.payload.spec = (receiptCount-1);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1720,
        "y": 120,
        "wires": [
            [
                "7a64b3858edfdad8"
            ]
        ]
    },
    {
        "id": "8b06ecbd2e4c4ecf",
        "type": "change",
        "z": "43652557380ac3f3",
        "name": "Get history",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "currentRun",
                "pt": "msg",
                "to": "runHistory[$count(runHistory)-1]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 730,
        "y": 760,
        "wires": [
            [
                "4f3852df34ce990f"
            ]
        ]
    },
    {
        "id": "dfef270919197e96",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Bevilling?",
        "func": "msg.payload.tempData._bevilling = msg.payload.tempData.persondata.bevilling ? `<div class=\"mb-3 text-success\"><i class=\"fas fa-check\"></i> Bevilget tilskud til fodpleje</div>` : ``;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1240,
        "y": 320,
        "wires": [
            [
                "66afcd1514727417"
            ]
        ]
    },
    {
        "id": "a1bf4b6b1875b569",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Formue = null?",
        "func": "if (msg.payload.tempData !== null && msg.payload.tempData !== undefined && msg.payload.tempData.persondata !== null  && msg.payload.tempData.persondata !== undefined )\n     msg.payload.tempData.persondata._formue = msg.payload.tempData.persondata.formue == null ? \"Ikke oplyst\" : msg.payload.tempData.persondata.formue + \" kr\";\n    \nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1840,
        "y": 200,
        "wires": [
            [
                "a2dc4dcc85327a6d"
            ]
        ]
    },
    {
        "id": "381970c176b042aa",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Count receipts",
        "func": "var dataExists = global.get(\"webData\") !== null && global.get(\"webData\") !== undefined;\n\n\nvar receiptCount = 0;\nvar receiptNoActionCount = 0;\n\n\nif (dataExists)\n{\n\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptCount = global.get(\"webData\")[\"citizens-actions\"].length;\n\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined)\n        receiptNoActionCount = global.get(\"webData\")[\"citizens-noactions\"].length;\n\n}\n\nmsg.payload.pageElements = {};\nmsg.payload.pageElements.receiptCount = receiptCount;\nmsg.payload.pageElements.receiptNoActionCount = receiptNoActionCount;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 880,
        "wires": [
            [
                "89f051f162c9b4b6"
            ]
        ]
    },
    {
        "id": "d4601eb0c82d44dc",
        "type": "function",
        "z": "43652557380ac3f3",
        "name": "Helbredstillægsprocent",
        "func": "// payload.tempData.faktura._helbredstillaegsprocent.tillaegsprocent\n\nif (msg.payload.tempData.faktura == undefined || msg.payload.tempData.persondata == undefined)\n    return msg;\n\n\nvar faktura = Array.isArray(msg.payload.tempData.faktura) ? msg.payload.tempData.faktura[0] : msg.payload.tempData.faktura;\nvar hprocent = 0;\n\nif (faktura._helbredstillaegsprocent != null && faktura._helbredstillaegsprocent != undefined)\n    hprocent = Array.isArray(faktura._helbredstillaegsprocent) ? faktura._helbredstillaegsprocent[0] : faktura._helbredstillaegsprocent;\n    \nelse\n    hprocent = Array.isArray(msg.payload.tempData.persondata.helbredstillaegsprocent) ?\n               msg.payload.tempData.persondata.helbredstillaegsprocent[0] :\n               msg.payload.tempData.persondata.helbredstillaegsprocent;\n\nmsg.payload.tempData.persondata._htillaegsprocent = (hprocent == null || hprocent == undefined) ? 0 : hprocent.tillaegsprocent;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1280,
        "y": 200,
        "wires": [
            [
                "b0b8bd30f6fdf461"
            ]
        ]
    },
    {
        "id": "88e4c1ff6d0333f9",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "New setting template",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings",
                "pt": "msg",
                "to": "{\t    \"settings\": {\t        \"idleTimeout\": 1800000\t    },\t\t    \"acceptances\": {\t        \"login\": false,\t        \"rules\": false,\t        \"grants\": false\t    },\t\t    \"state\": {\t        \"isRunning\": false,\t        \"lastStep\": {},\t        \"lastState\": {}\t    },\t\t    \"currentSession\": {\t        \"isConnected\": \"n/a\",\t        \"lastPingMillis\": 0\t    }\t    \t}",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "webData",
                "pt": "global",
                "to": "\t{\t    \"workletCreds\": {\t        \"workletUser\": \"\",\t        \"workletPass\": \"\"\t    }, \"startedRunThisInstance\": false\t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 560,
        "y": 320,
        "wires": [
            [
                "7e2c077d488fba02"
            ]
        ]
    },
    {
        "id": "a9d6b94d12b279b8",
        "type": "json",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "payload.webSettings",
        "action": "obj",
        "pretty": false,
        "x": 990,
        "y": 320,
        "wires": [
            [
                "54fea94a47d38b83"
            ]
        ]
    },
    {
        "id": "c69a20e302b88549",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "Load settings",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings",
                "pt": "msg",
                "to": "#:(storeInFile)::webSettings",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "payload.webData",
                "pt": "msg",
                "to": "webData",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 530,
        "y": 280,
        "wires": [
            [
                "c7471e96ad8de5e4"
            ]
        ]
    },
    {
        "id": "eae97dc11278dc8c",
        "type": "switch",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "#:(storeInFile)::webSettings",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 300,
        "wires": [
            [
                "c69a20e302b88549"
            ],
            [
                "88e4c1ff6d0333f9"
            ]
        ]
    },
    {
        "id": "7e2c077d488fba02",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings",
                "pt": "global",
                "to": "payload.webSettings",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 320,
        "wires": [
            [
                "a9d6b94d12b279b8"
            ]
        ]
    },
    {
        "id": "13ce2c9a2cb6edf6",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "New rule template",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "[\t    {\t        \"uid\": \"formuegraense\",\t        \"name\": \"Formue\",\t        \"variable\": \"formue\",\t        \"operator\": \"<\",\t        \"value\": 95800,\t        \"type\": \"number\",\t        \"description\": \"Borgerens formue skal være indenfor formuegrænsen\",\t        \"error\": \"Borgerens formue bryder formue-reglen\"\t    },\t    {\t        \"uid\": \"formueoplyst\",\t        \"name\": \"Formue\",\t        \"variable\": \"formue\",\t        \"operator\": \"!null\",\t        \"value\": true,\t        \"type\": \"bool\",\t        \"description\": \"Borgerens formue skal være oplyst til UDK\",\t        \"isSystemRule\": true\t    }\t]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.rulesStr",
                "pt": "msg",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 550,
        "y": 460,
        "wires": [
            [
                "4e9a3b7807bbafd6"
            ]
        ]
    },
    {
        "id": "6f9b01d0e9aeace9",
        "type": "json",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "payload.rules",
        "action": "obj",
        "pretty": false,
        "x": 990,
        "y": 460,
        "wires": [
            [
                "59c7c16b1b5ab941"
            ]
        ]
    },
    {
        "id": "b0485f8f92d2446e",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "Load rules",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "#:(storeInFile)::rules",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "payload.rulesStr",
                "pt": "msg",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 530,
        "y": 420,
        "wires": [
            [
                "c49b1da1d0ca8a62"
            ]
        ]
    },
    {
        "id": "54fea94a47d38b83",
        "type": "switch",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "#:(storeInFile)::rules",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 440,
        "wires": [
            [
                "b0485f8f92d2446e"
            ],
            [
                "13ce2c9a2cb6edf6"
            ]
        ]
    },
    {
        "id": "4e9a3b7807bbafd6",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::rules",
                "pt": "global",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 760,
        "y": 460,
        "wires": [
            [
                "6f9b01d0e9aeace9"
            ]
        ]
    },
    {
        "id": "59c7c16b1b5ab941",
        "type": "json",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "payload.rulesStr",
        "action": "str",
        "pretty": false,
        "x": 1110,
        "y": 460,
        "wires": [
            [
                "f03ed296e7105d6b"
            ]
        ]
    },
    {
        "id": "ae14111b4808cbf3",
        "type": "comment",
        "z": "db94b4c117de2f6a",
        "name": "Load web settings",
        "info": "",
        "x": 370,
        "y": 260,
        "wires": []
    },
    {
        "id": "6069256d57690eba",
        "type": "comment",
        "z": "db94b4c117de2f6a",
        "name": "Load Rules",
        "info": "",
        "x": 350,
        "y": 400,
        "wires": []
    },
    {
        "id": "6aea2a69085ab1fc",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "New grants template",
        "rules": [
            {
                "t": "set",
                "p": "payload.grants",
                "pt": "msg",
                "to": "{\t      \"periode_fra\": \"2023-01-01\",\t      \"periode_til\": \"2023-12-31\",\t      \"satser\": [\t        {\t          \"tilskud_maxdkk\": 24,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Journaloptagelse\"\t        },\t        {\t          \"tilskud_maxdkk\": 24,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Kontrol og/eller eftersyn\"\t        },\t        {\t          \"tilskud_maxdkk\": 111,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandlingsydelse C\"\t        },\t        {\t          \"tilskud_maxdkk\": 81,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Første fodstatus (nyhenvist patient)\"\t        },\t        {\t          \"tilskud_maxdkk\": 66,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fodstatus\"\t        },\t        {\t          \"tilskud_maxdkk\": 55,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fodstatus ved samtidig anden behandling\"\t        },\t        {\t          \"tilskud_maxdkk\": 25,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Opdatering af fodstatus ved skift i risikogruppe\"\t        },\t        {\t          \"tilskud_maxdkk\": 66,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandlingsydelse A\"\t        },\t        {\t          \"tilskud_maxdkk\": 100,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandlingsydelse B\"\t        },\t        {\t          \"tilskud_maxdkk\": 200,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 1, enkelt\"\t        },\t        {\t          \"tilskud_maxdkk\": 400,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 1, par\"\t        },\t        {\t          \"tilskud_maxdkk\": 200,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 2, enkelt\"\t        },\t        {\t          \"tilskud_maxdkk\": 400,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 2, par\"\t        },\t        {\t          \"tilskud_maxdkk\": 200,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 3, enkelt\"\t        },\t        {\t          \"tilskud_maxdkk\": 400,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Indlæg - type 3, par\"\t        },\t        {\t          \"tilskud_maxdkk\": 125,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Tilretning af indlæg\"\t        },\t        {\t          \"tilskud_maxdkk\": 24,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Behandling før påsætning af 1 ny bøjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 72,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fremstilling og påsætning af 1 ny bøjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Fremstilling og påsætning af bøjler udover 1\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Korrektion af 1 bøjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 72,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Korrektion af 2 bøjle\"\t        },\t        {\t          \"tilskud_maxdkk\": 96,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Korrektion af op til 10 bøjler incl.\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Ortheser\"\t        },\t        {\t          \"tilskud_maxdkk\": 48,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Ortheser fremstilet af sislicone\"\t        },\t        {\t          \"tilskud_maxdkk\": 55,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Sårbehandling\"\t        },\t        {\t          \"tilskud_maxdkk\": 44,\t          \"tilskud_procent\": 80,\t          \"titel\": \"Sårbehandling ved anden samtidig behandling\"\t        },\t        {\t          \"tilskud_maxdkk\": 100,\t          \"tilskud_procent\": 50,\t          \"titel\": \"Behandling uden tilskud\"\t        },\t        {\t          \"tilskud_maxdkk\": 0,\t          \"tilskud_procent\": 0,\t          \"titel\": \"Afstandstillæg uden tilskud\"\t        }\t      ]\t    }",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.grants",
                "pt": "msg",
                "to": "$.payload.grants ~> | $.satser |\t(\t{\t    \"wtitel\": titel ~> $replace(\" \", \"\")\t})|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.grants",
                "pt": "msg",
                "to": "{\t    \"max_hjemmebehandling\": 9999999999999999,\t    \"max_udekoersel\": 9999999999999999,\t    \"danmark_fratraek_procent\": 50,\t    \"danmark_fratraek_maxdkk\": 100,\t    \"tilskudsperioder\": payload.grants\t}",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.grants.tilskudsperioder.satser",
                "pt": "msg",
                "to": "payload.grants.tilskudsperioder.satser @ $g #$index.\t{\t    \"id\": $index,\t    \"tilskud_maxdkk\": $g.tilskud_maxdkk,\t    \"tilskud_procent\": $g.tilskud_procent,\t    \"titel\": $g.titel,\t    \"wtitel\": $g.wtitel\t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 560,
        "y": 660,
        "wires": [
            [
                "3f926de50bc6c69f"
            ]
        ]
    },
    {
        "id": "6e9984fcc13cbb0d",
        "type": "json",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "payload.grants",
        "action": "obj",
        "pretty": false,
        "x": 990,
        "y": 660,
        "wires": [
            []
        ]
    },
    {
        "id": "590ea89e490dce35",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "Load grants",
        "rules": [
            {
                "t": "set",
                "p": "payload.grants",
                "pt": "msg",
                "to": "#:(storeInFile)::grants",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 530,
        "y": 620,
        "wires": [
            [
                "12011e480eafdc8f"
            ]
        ]
    },
    {
        "id": "f03ed296e7105d6b",
        "type": "switch",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "#:(storeInFile)::grants",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 330,
        "y": 640,
        "wires": [
            [
                "590ea89e490dce35"
            ],
            [
                "6aea2a69085ab1fc"
            ]
        ]
    },
    {
        "id": "3f926de50bc6c69f",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::grants",
                "pt": "global",
                "to": "payload.grants",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 760,
        "y": 660,
        "wires": [
            [
                "6e9984fcc13cbb0d"
            ]
        ]
    },
    {
        "id": "f1a8802eae2b84b5",
        "type": "comment",
        "z": "db94b4c117de2f6a",
        "name": "Load Grants",
        "info": "",
        "x": 350,
        "y": 600,
        "wires": []
    },
    {
        "id": "d074d283a8713b57",
        "type": "switch",
        "z": "db94b4c117de2f6a",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "istype",
                "v": "object",
                "vt": "object"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 2,
        "x": 210,
        "y": 100,
        "wires": [
            [
                "f7635cfda195117f"
            ],
            [
                "ff29c1cf4e1ad18a"
            ]
        ]
    },
    {
        "id": "ff29c1cf4e1ad18a",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 100,
        "wires": [
            [
                "f7635cfda195117f"
            ]
        ]
    },
    {
        "id": "89596c9e7122fea8",
        "type": "comment",
        "z": "db94b4c117de2f6a",
        "name": "States",
        "info": "",
        "x": 810,
        "y": 80,
        "wires": []
    },
    {
        "id": "6ec1d89f4bc267a3",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "New states",
        "rules": [
            {
                "t": "set",
                "p": "webStates",
                "pt": "global",
                "to": "[\t    {\t        \"title\": \"idle\",\t        \"id\": 0,\t        \"result\": [\"ready\", \"completed\"]\t    },\t    \t    {\t        \"title\": \"running\",\t        \"id\": 1,\t        \"result\": \"busy\"\t    },\t\t    {\t        \"title\": \"unavailable\",\t        \"id\": 2,\t        \"result\": \"no response\"\t    }\t]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "webSteps",
                "pt": "global",
                "to": "[{\"title\":\"initialization\",\"id\":0,\"state\":{},\"lastResult\":null},{\"title\":\"extract-worklet\",\"id\":1,\"state\":{},\"lastResult\":null},{\"title\":\"data-split\",\"id\":2,\"state\":{},\"lastResult\":null},{\"title\":\"extract-kp\",\"id\":3,\"state\":{},\"lastResult\":null},{\"title\":\"transform\",\"id\":4,\"state\":{},\"lastResult\":null},{\"title\":\"load\",\"id\":5,\"state\":{},\"lastResult\":null}]",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "payload.webStates",
                "pt": "msg",
                "to": "webStates",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "payload.webSteps",
                "pt": "msg",
                "to": "webSteps",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 830,
        "y": 120,
        "wires": [
            [
                "eae97dc11278dc8c"
            ]
        ]
    },
    {
        "id": "c7471e96ad8de5e4",
        "type": "change",
        "z": "db94b4c117de2f6a",
        "name": "set isRunning",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.isRunning",
                "pt": "global",
                "to": "$globalContext(\"webSettings.state.isRunning\", \"storeInFile\") = true ?\t$globalContext(\"webData.startedRunThisInstance\") : false",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 280,
        "wires": [
            [
                "bb96674ebd01af04"
            ]
        ]
    },
    {
        "id": "792bc1326c300849",
        "type": "subflow:db94b4c117de2f6a",
        "z": "85ff29bdef7c1aea",
        "name": "",
        "x": 370,
        "y": 80,
        "wires": [
            [
                "c668c88142f35452"
            ]
        ]
    },
    {
        "id": "fbeec8791e401f92",
        "type": "change",
        "z": "85ff29bdef7c1aea",
        "name": "Add step run history",
        "rules": [
            {
                "t": "set",
                "p": "currentStartDate",
                "pt": "msg",
                "to": "currentStartDate",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "newStep",
                "pt": "msg",
                "to": "payload.webSteps[title = \"extract-worklet\"]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "newStep",
                "pt": "msg",
                "to": "newStep",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "newState",
                "pt": "msg",
                "to": "payload.webStates[title = \"idle\"]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "newState",
                "pt": "msg",
                "to": "newState",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "newState.result",
                "pt": "msg",
                "to": "newState.result[1]",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "newStep.state",
                "pt": "msg",
                "to": "newState",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "newStep.timestamp",
                "pt": "msg",
                "to": "$millis()",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "newStep.lastResult",
                "pt": "msg",
                "to": "newStep.state.result",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := $$.currentStartDate;\t$newStep := $$.newStep;\t\tstartDate = $startDate?\t{\t    \"currentStep\": $newStep,\t    \"stepHistory\": $append(stepHistory, $newStep)\t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1360,
        "y": 120,
        "wires": [
            [
                "f5d7b1d2cde30ea2"
            ]
        ]
    },
    {
        "id": "f5d7b1d2cde30ea2",
        "type": "change",
        "z": "85ff29bdef7c1aea",
        "name": "Update webSettings state",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.lastStep",
                "pt": "global",
                "to": "newStep",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.lastState",
                "pt": "global",
                "to": "newState",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1370,
        "y": 160,
        "wires": [
            []
        ]
    },
    {
        "id": "c668c88142f35452",
        "type": "switch",
        "z": "85ff29bdef7c1aea",
        "name": "",
        "property": "stepHistoryChange",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 590,
        "y": 80,
        "wires": [
            [
                "6cfb9bed6a24be31"
            ],
            []
        ]
    },
    {
        "id": "6cfb9bed6a24be31",
        "type": "switch",
        "z": "85ff29bdef7c1aea",
        "name": "",
        "property": "stepHistoryChange.newStep",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 790,
        "y": 60,
        "wires": [
            [],
            []
        ]
    },
    {
        "id": "14f3b19bf9f1bf91",
        "type": "comment",
        "z": "85ff29bdef7c1aea",
        "name": "New step",
        "info": "",
        "x": 1050,
        "y": 40,
        "wires": []
    },
    {
        "id": "08c0dac0e5eb2d13",
        "type": "comment",
        "z": "85ff29bdef7c1aea",
        "name": "New state",
        "info": "",
        "x": 1060,
        "y": 300,
        "wires": []
    },
    {
        "id": "9057a712327815d2",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Start robot",
        "info": "",
        "x": 160,
        "y": 300,
        "wires": []
    },
    {
        "id": "c0efbe2a4fc25ff6",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "44e7408f9fee1e77",
        "name": "[E] Find ny start- og slutdato ud fra seneste kørsel samt dags dato",
        "info": "",
        "x": 970,
        "y": 180,
        "wires": []
    },
    {
        "id": "2ea70729759d488c",
        "type": "catch",
        "z": "8ea344595d9a442a",
        "g": "00256f937180f75a",
        "name": "",
        "scope": null,
        "uncaught": false,
        "x": 1880,
        "y": 100,
        "wires": [
            [
                "df0ed618b5194000"
            ]
        ]
    },
    {
        "id": "df0ed618b5194000",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "00256f937180f75a",
        "name": "ERROR DEBUG",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "error",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 2070,
        "y": 100,
        "wires": []
    },
    {
        "id": "da966ceeba7b23dd",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Fjern CPR-numre",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$|\t{\t    \"cpr\": \t           (cpr ~>\t           $split(\"-\"))[0]\t}\t|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.faktura|\t{\t    \"patientCPR\": \t           (patientCPR ~>\t           $split(\"-\"))[0]\t}\t|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$.errors ~> |$|\t{\t    \"cpr\": \t           (cpr ~>\t           $split(\"-\"))[0]\t}\t|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$.errors ~> |$.faktura|\t{\t    \"patientCPR\": \t           (patientCPR ~>\t           $split(\"-\"))[0]\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 490,
        "y": 2060,
        "wires": [
            [
                "a46e2a0c2cd58d9f"
            ]
        ]
    },
    {
        "id": "64156b428449f87a",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "7de50fe1369c94a7",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "tilskudsInfo",
                "pt": "msg",
                "to": "payload.grants",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 615,
        "y": 340,
        "wires": [
            [
                "56f4f81f3f45559e"
            ]
        ],
        "l": false,
        "info": "## Copy grant info\r\nThis change node copies the grant set from the payload into the msg object as msg.tilskudsInfo."
    },
    {
        "id": "8b4e8bc5facd8f90",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "7de50fe1369c94a7",
        "name": "Sæt tilskudsperioder fra Danmark",
        "info": "",
        "x": 490,
        "y": 300,
        "wires": []
    },
    {
        "id": "2c5bfa6b7a2613ab",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "44e7408f9fee1e77",
        "name": "Find filnavn",
        "func": "const splitStartDate = msg.currentRun.startDate.split(\"/\");\nconst splitEndDate = msg.currentRun.endDate.split(\"/\");\n\nvar startDate = new Date(splitStartDate[2], splitStartDate[1] - 1, splitStartDate[0]);\nvar endDate = new Date(splitEndDate[2], splitEndDate[1] - 1, splitEndDate[0]);\n\n// define file name\nvar fileName = \"Kvitteringer-\" + startDate.toDateString().replace(splitStartDate[2], \"\").trimEnd()\n    + \"-\" + endDate.toDateString().replace(endDate.getFullYear().toString(), \"\").trimEnd();\n    \nfileName += \".json\";\n\nmsg.fileName = fileName;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1570,
        "y": 300,
        "wires": [
            [
                "2833bc30cabd27bb",
                "a534a873bebc25b6",
                "4f8ccb830206b86d"
            ]
        ],
        "info": "## Define file name\r\nThis JS snippet utilizes the JavaScript date function `toDateString()` as well as some string manipulation to define the name of the JSON file which will be downloaded from Worklet web interface.\r\n\r\nThe name defined is later used to find and read the downloaded file, as the actual file name cannot be set when downloading, nor can it be retrieved as the download is in progress. Therefore, the name must be determined manually to match the naming procedure of Worklet web interface."
    },
    {
        "id": "df4e89fda20fa7db",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "44e7408f9fee1e77",
        "name": "Find uafsluttet kørsel eller skab ny",
        "info": "",
        "x": 1240,
        "y": 260,
        "wires": []
    },
    {
        "id": "28d8ac05e7f0f65f",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Findes filen?",
        "func": "const fs = global.get('fs');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\nmsg.filePath = downloadPath + \"\\\\\" + msg.fileName;\n\nif (fs.existsSync(msg.filePath))\n{\n    msg.payload = true;\n    node.status({ fill: \"green\", shape: \"dot\", text: \"Fil blev fundet\" });\n}\nelse\n{\n    msg.payload = false;\n    node.status({ fill: \"yellow\", shape: \"dot\", text: \"Fil blev ikke fundet!\" });\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 470,
        "y": 600,
        "wires": [
            [
                "bc7b13ac2323540b"
            ]
        ],
        "info": "## Check for file\r\nThis JS snippet utilizes global modules `FS` and `Path` to check if the receipt JSON file already exists, or needs to be downloaded."
    },
    {
        "id": "bc7b13ac2323540b",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "",
        "property": "payload",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 585,
        "y": 600,
        "wires": [
            [
                "144d6812d5213472"
            ],
            [
                "d97f7bbbe0210f54"
            ]
        ],
        "l": false,
        "info": "## Check for file - switch\r\nThis switch, which succeeds the JS snippet which determines receipt file existance, is used to skip the download of receipts if they already exist (they shouldn't!)."
    },
    {
        "id": "4003aad4b2b6a9c8",
        "type": "file in",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Læs JSON fil",
        "filename": "filePath",
        "filenameType": "msg",
        "format": "utf8",
        "chunk": false,
        "sendError": false,
        "encoding": "none",
        "allProps": false,
        "x": 1430,
        "y": 580,
        "wires": [
            [
                "fa861baf7265d3be"
            ]
        ]
    },
    {
        "id": "fa861baf7265d3be",
        "type": "json",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Parse JSON",
        "property": "payload",
        "action": "obj",
        "pretty": false,
        "x": 1535,
        "y": 580,
        "wires": [
            [
                "6558b47eb74e6c0c"
            ]
        ],
        "l": false
    },
    {
        "id": "8bc31d06862e8fe2",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Slet JSON fil",
        "func": "const fs = global.get('fs');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\nmsg.filePath = downloadPath + \"\\\\\" + msg.fileName;\n\nfs.unlinkSync(msg.filePath);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1730,
        "y": 580,
        "wires": [
            [
                "0f583d6bfaad7d0e",
                "26de970dcfce1beb",
                "6dacc4751f492eab"
            ]
        ],
        "info": "## Delete JSON file\r\n\r\nThis JS snippet utilizes the FS module to delete the JSON file after it has been read to memory."
    },
    {
        "id": "d5a462980f4852cf",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Tjek om filen eksisterer",
        "info": "",
        "x": 500,
        "y": 560,
        "wires": []
    },
    {
        "id": "07d87534c4e0bbea",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Download fakturaliste",
        "info": "",
        "x": 1180,
        "y": 540,
        "wires": []
    },
    {
        "id": "c931f08e3a54e2f2",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Slet fakturaliste",
        "info": "",
        "x": 1740,
        "y": 540,
        "wires": []
    },
    {
        "id": "6558b47eb74e6c0c",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Sæt msg.receipts",
        "rules": [
            {
                "t": "set",
                "p": "receipts",
                "pt": "msg",
                "to": "payload.kvitteringer",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1585,
        "y": 580,
        "wires": [
            [
                "07aa032e7944f93b",
                "8bc31d06862e8fe2"
            ]
        ],
        "l": false,
        "info": "## Set msg.receipts\r\n\r\nThis change node sets msg.receipts = payload.kvitteringer (which contains an array of receipts), and deletes the payload afterwards."
    },
    {
        "id": "569d9f497b06babc",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Læs fakturaliste",
        "info": "",
        "x": 1440,
        "y": 540,
        "wires": []
    },
    {
        "id": "144d6812d5213472",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Sæt selectors",
        "rules": [
            {
                "t": "set",
                "p": "selectors",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.worklet",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.worklet.url",
                "pt": "msg",
                "to": "https://workletnew.snapp.dk/auth/sign-in",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.loginUser",
                "pt": "msg",
                "to": "input[name='username']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.loginPass",
                "pt": "msg",
                "to": "input[name='password']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.loginButton",
                "pt": "msg",
                "to": "button",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.datePickerFrom",
                "pt": "msg",
                "to": "[class='react-datepicker__input-container'] > input",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.datePickerActive",
                "pt": "msg",
                "to": "[class='react-datepicker-ignore-onclickoutside']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.datePickerTo",
                "pt": "msg",
                "to": "div:last-child > [class='react-datepicker__input-container'] > input",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.downloadButton",
                "pt": "msg",
                "to": "button[class='btn btn-primary btn-block primary-color']",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.worklet.header",
                "pt": "msg",
                "to": "h1",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 760,
        "y": 580,
        "wires": [
            [
                "6a7f540f9f08ded4"
            ]
        ],
        "info": "## Sæt referencer\r\n\r\nIn this change node, CSS selectors for Worklet web interface (https://workletnew.snapp.dk/) are set for use in the PupController JSON file."
    },
    {
        "id": "6a7f540f9f08ded4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Set pup commands",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "[\t    {\t        \"action\": \"launch\",\t        \"parameters\":\t        {\t            \"headless\": true,\t            \"slowMo\": 50,\t            \"ignoreHTTPSErrors\": true,\t            \"defaultViewport\": null\t        }\t    },\t\t    {\t        \"action\": \"goto\",\t        \"url\": selectors.worklet.url\t    },\t\t    {\t        \"action\": \"wait\",\t        \"ms\": 10000\t    },\t    \t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.loginUser,\t        \"input\": workletUser\t    },\t\t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.loginPass,\t        \"input\": workletPass\t    },\t    \t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.loginButton\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.datePickerFrom\t    },\t\t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.datePickerActive,\t        \"input\": currentRun.startDate,\t        \"clear\": true\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.header\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.datePickerTo\t    },\t\t    {\t        \"action\": \"type\",\t        \"path\": selectors.worklet.datePickerActive,\t        \"input\": currentRun.endDate,\t        \"clear\": true\t    },\t\t    {\t        \"action\": \"click\",\t        \"path\": selectors.worklet.header\t    },\t\t    {\t        \"action\": \"click\",\t        \"isDownload\": true,\t        \"path\": selectors.worklet.downloadButton\t    },\t    {\t        \"action\": \"close\"\t    }\t    \t]",
                "tot": "jsonata"
            },
            {
                "t": "delete",
                "p": "workletUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "workletPass",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 950,
        "y": 580,
        "wires": [
            [
                "15a1703b4a5286c7"
            ]
        ],
        "info": "## Set pup commands\r\n\r\nThis change node sets the automation flow JSON needed in PupController API. The flow is hard-coded with variable references to the CSS selectors defined in the preceeding node."
    },
    {
        "id": "bb143ed21df0febf",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Klargør download af faktura ift. datoer",
        "info": "",
        "x": 830,
        "y": 540,
        "wires": []
    },
    {
        "id": "07aa032e7944f93b",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "RECEIPTS",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "receipts",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1730,
        "y": 500,
        "wires": []
    },
    {
        "id": "15a1703b4a5286c7",
        "type": "subflow:41d1b8798efe7e15",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "",
        "x": 1160,
        "y": 580,
        "wires": [
            [
                "4424787318323d8e"
            ],
            []
        ]
    },
    {
        "id": "8a3db972f8fb7806",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Transform debug",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 970,
        "y": 2060,
        "wires": []
    },
    {
        "id": "5d7e42be40e46699",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "MSG ERRORS",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "errors",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 900,
        "y": 1900,
        "wires": []
    },
    {
        "id": "252ef6cdcba02f65",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Tilføj sager + ydelser til handlinger",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$|(\t\t$faktura := faktura;\t\t{\t    \"handlinger\": faktura.behandlinger @$b .(\t        $b := $b;\t\t        $b.sag ~> $boolean ?\t        {\t            \"handling\": \"Tilføj ydelse\",\t            \"type\": $b.type,\t            \"uid\": $b.uid,\t            \"fid\": $b.fid,\t            \"dato\": $faktura.dato\t        }\t        : $b.bevilget ?\t        [{\t            \"handling\": \"Opret sag\",\t            \"type\": $b.type,\t            \"uid\": $b.uid,\t            \"fid\": $b.fid\t        },\t        {\t            \"handling\": \"Tilføj ydelse\",\t            \"type\": $b.type,\t            \"fid\": $b.fid,\t            \"uid\": $b.uid,\t            \"dato\": $faktura.dato\t        }]\t        \t    )\t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 540,
        "y": 1740,
        "wires": [
            [
                "eea859cc92e89e3f"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "9639c713133c8b4b",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Opret sager / ydelser",
        "info": "",
        "x": 500,
        "y": 1700,
        "wires": []
    },
    {
        "id": "c728e9afbea480e9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Sæt tilskud = pris",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.handlinger|(\t\t$uid := uid;\t$behandling := $$.payload.faktura.behandlinger[uid = $uid];\t$fid := $behandling.fid;\t$faktura := $$.payload.faktura[id = $fid];\t$borger := $$.payload[cpr = $faktura.patientCPR];\t\thandling = \"Opret sag\" ? {} : \t\t$behandling.type = \"B\" ?\t{\t    \"tilskud\": $behandling.patientAndel,\t    \"beregning\": ($behandling.patientAndel & \" kr\")\t}\t:\t{\t    \"tilskud\": $behandling.pris,\t    \"beregning\": ($behandling.pris & \" kr\")\t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1130,
        "y": 1740,
        "wires": [
            [
                "ebfc3d7f7b71a754"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "603f9dfeda911a10",
        "type": "link in",
        "z": "8ea344595d9a442a",
        "name": "Link in START",
        "links": [
            "48787abb96e28b68",
            "30b5b930fae41995"
        ],
        "x": 115,
        "y": 340,
        "wires": [
            [
                "632aa75f39860780"
            ]
        ]
    },
    {
        "id": "f5dbef72792b9011",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "START response out",
        "mode": "link",
        "links": [
            "5c74b689e0aee38b"
        ],
        "x": 945,
        "y": 2340,
        "wires": []
    },
    {
        "id": "b51fbf12da5aebba",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Klargør data til UI",
        "info": "",
        "x": 480,
        "y": 2020,
        "wires": []
    },
    {
        "id": "a46e2a0c2cd58d9f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Beautify behandlingstitler",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura.behandlinger |\t( $t := titel;\t{\t    \"titel\": (titel = \"Behandlingpåklinik\") ? \"Behandling på klinik\"\t    :        (titel = \"Behandlingipatientsegethjem\") ? \"Behandling i patients eget hjem\"\t    :         $$.tilskudsInfo.tilskudsperioder.satser[wtitel = $t].titel\t})|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$.errors ~> | $.faktura.behandlinger |\t( $t := titel;\t{\t    \"titel\": (titel = \"Behandlingpåklinik\") ? \"Behandling på klinik\"\t    :        (titel = \"Behandlingipatientsegethjem\") ? \"Behandling i patients eget hjem\"\t    :         $$.tilskudsInfo.tilskudsperioder.satser[wtitel = $t].titel\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 710,
        "y": 2060,
        "wires": [
            [
                "4fa04433812ed133",
                "8a3db972f8fb7806"
            ]
        ]
    },
    {
        "id": "b5f7952c5718fafd",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Fjern borgere som ikke har en sag / bevilling",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload @$p.\t(\t    ($p.handlinger ~> $exists) ?\t    {\t        \"cpr\": $p.cpr,\t        \"persondata\": $p.persondata,\t        \"faktura\": $p.faktura,\t        \"handlinger\": $p.handlinger\t    }\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 570,
        "y": 1900,
        "wires": [
            [
                "c728e9afbea480e9",
                "5d7e42be40e46699"
            ]
        ]
    },
    {
        "id": "c23d52373f2634a2",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Find borgere som ikke har en sag / bevilling",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$append(errors, payload @$p.\t(\t    ($p.handlinger ~> $exists) = false ?\t    {\t        \"cpr\": $p.cpr,\t        \"regelbrud\": \"Ingen gyldig sag blev fundet til behandlingstypen\",\t        \"persondata\": $p.persondata,\t        \"faktura\": $p.faktura\t    }\t)\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 570,
        "y": 1860,
        "wires": [
            [
                "b5f7952c5718fafd"
            ]
        ]
    },
    {
        "id": "ea041c123c220cca",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Flyt borgere som ikke har handlinger til \"errors\"",
        "info": "",
        "x": 580,
        "y": 1820,
        "wires": []
    },
    {
        "id": "042534adf7219de9",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Beregn tilskud",
        "info": "",
        "x": 1110,
        "y": 1700,
        "wires": []
    },
    {
        "id": "ebfc3d7f7b71a754",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Fratræk ydelsesbestemt tillæg fra Danmark (type B + Danmark 1/2)",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.handlinger|(\t\t$uid := uid;\t$behandling := $$.payload.faktura.behandlinger[uid = $uid];\t$fid := $behandling.fid;\t$faktura := $$.payload.faktura[id = $fid];\t$borger := $$.payload[cpr = $faktura.patientCPR];\t$danmark := $borger.persondata.danmarkgruppe;\t\t$danmarkSats := $$.tilskudsInfo.tilskudsperioder.satser[wtitel = $behandling.titel];\t$danmarkProcent := tilskud * ($danmarkSats.tilskud_procent / 100);\t$danmarkMax := $danmarkSats.tilskud_maxdkk;\t\t$danmarkTilskud := $danmarkProcent > $danmarkMax ? $danmarkMax : $danmarkProcent;\t\t\t    $behandling.type = \"B\"\tand ($danmark = 1 or $danmark = 2) ?\t{\t    \t    \"tilskud\": tilskud - ($danmarkProcent > $danmarkMax ? $danmarkMax : $danmarkProcent),\t    \"beregning\": beregning & \" -\" & ($danmarkProcent > $danmarkMax ? $danmarkMax : $danmarkProcent) & \" (Danmark)\"\t    \t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1280,
        "y": 1780,
        "wires": [
            [
                "8b251b9d384911a0"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "8b251b9d384911a0",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Fratræk 50% (maks 100) ved type A + Danmark 1/2",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.handlinger|(\t\t$uid := uid;\t$behandling := $$.payload.faktura.behandlinger[uid = $uid];\t$fid := $behandling.fid;\t$faktura := $$.payload.faktura[id = $fid];\t$borger := $$.payload[cpr = $faktura.patientCPR];\t$danmark := $borger.persondata.danmarkgruppe;\t\t$tilskud_maxdkk := $$.tilskudsInfo.danmark_fratraek_maxdkk;\t$tilskud_procent := $$.tilskudsInfo.danmark_fratraek_procent;\t$danmarkProcent := tilskud * ($tilskud_procent / 100);\t$danmarkMax := $tilskud_maxdkk;\t\t$danmarkTilskud := $danmarkProcent > $danmarkMax ? $danmarkMax : $danmarkProcent;\t\t\t    $behandling.type = \"A\"\tand ($danmark = 1 or $danmark = 2) ?\t{\t\t    \"tilskud\": tilskud - ($danmarkProcent > $danmarkMax ? $danmarkMax : $danmarkProcent),\t    \"beregning\": beregning & \" -\" & ($danmarkProcent > $danmarkMax ? $danmarkMax : $danmarkProcent) & \" (Danmark)\"\t    \t}\t\t)|\t\t\t/*and ($faktura.ydernummer != \"ydernummermangler\" and $faktura.ydernummer != null) ?*/",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1230,
        "y": 1820,
        "wires": [
            [
                "363e103b20db6c80"
            ]
        ],
        "info": "Hvis fodterapeut har ydernr (er statsautoriseret) og behandlingen er udført i Danmark, og borger er gruppe 1 og 2, fratrækkes et ydelsesbestemt tilskud på 50% fra Danmark (maks. 100 kr)."
    },
    {
        "id": "363e103b20db6c80",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Begræns tilskud der overstiger prisgrænse ved type A + uautoriseret type B",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.handlinger|(\t\t$uid := uid;\t$behandling := $$.payload.faktura.behandlinger[uid = $uid];\t$fid := $behandling.fid;\t$faktura := $$.payload.faktura[id = $fid];\t$borger := $$.payload[cpr = $faktura.patientCPR];\t$danmark := $borger.persondata.danmarkgruppe;\t\t$tilskud_max_hjemme := $$.tilskudsInfo.max_hjemmebehandling;\t$tilskud_max_ude := $$.tilskudsInfo.max_udekoersel;\t\t    $behandling.type = \"A\" \tor\t        ($behandling.type = \"B\"\t    and ($faktura.ydernummer != \"ydernummermangler\" and $faktura.ydernummer != null)) ?\t{\t\t    \"tilskud\": (titel = \"Behandlingipatientsegethjem\") ?\t                    (tilskud > $tilskud_max_hjemme ? $tilskud_max_hjemme : tilskud)\t                    :\t                    (tilskud > $tilskud_max_ude ? $tilskud_max_ude : tilskud),\t    \"beregning\": beregning & \" = overstiger takst, derfor nedsat til \" & tilskud\t    \t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1310,
        "y": 1860,
        "wires": [
            [
                "5cfe1b69780c58ab"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "5cfe1b69780c58ab",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Gang med tillægsprocent",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.handlinger|(\t\t$uid := uid;\t$behandling := $$.payload.faktura.behandlinger[uid = $uid];\t$fid := $behandling.fid;\t$faktura := $$.payload.faktura[id = $fid];\t$borger := $$.payload[cpr = $faktura.patientCPR];\t\t{\t    \"tilskud\": tilskud * ($faktura._helbredstillaegsprocent.tillaegsprocent / 100),\t    \"beregning\": beregning & \" * \" & ($faktura._helbredstillaegsprocent.tillaegsprocent / 100) & \" = \" & tilskud & \" kr\"\t}\t\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1150,
        "y": 1900,
        "wires": [
            [
                "ac2d9ca641a094e8",
                "04b177707c5e0edc"
            ]
        ],
        "info": "https://try.jsonata.org/re36DEF4i"
    },
    {
        "id": "632aa75f39860780",
        "type": "subflow:db94b4c117de2f6a",
        "z": "8ea344595d9a442a",
        "g": "7de50fe1369c94a7",
        "name": "",
        "x": 470,
        "y": 340,
        "wires": [
            [
                "64156b428449f87a"
            ]
        ],
        "info": "# Get Settings/Rules/Grants\r\n\r\nGets (or sets) the current ruleset from global context and stores it in the msg object.\r\nIf no existing data is found, new data is created from templates which are found inside the subflow itself.\r\n\r\nSubflow was originially intended to only load a single element into the payload, however to speed up development,\r\nall three elements were merged into a single subflow. This means that the subflow is heavily referenced and loads\r\nunneccessary data in multiple occasions."
    },
    {
        "id": "fde5a695bfbd9a7d",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Clean MSG",
        "rules": [
            {
                "t": "delete",
                "p": "workletUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "workletPass",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "tilskudsInfo",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "filename",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "filePath",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "receipts",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "citizens",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "selectors",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "pupOutputs",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "rules",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 610,
        "y": 2340,
        "wires": [
            [
                "f5dbef72792b9011"
            ]
        ]
    },
    {
        "id": "df5451114247dbd3",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Clean alt unødvendig data fra msg objekt",
        "info": "",
        "x": 700,
        "y": 2300,
        "wires": []
    },
    {
        "id": "4fa04433812ed133",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Definér states (archived / recommended)",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $ |\t(\t    $fid := faktura[0].id;\t    {\t\t    \"recommended\": true,\t    \"archived\": $$.currentRun.processedReceipts[$ = $fid] ~> $exists()\t\t})|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$.errors ~> | $ |\t(\t    $fid := faktura[0].id;\t    {\t\t    \"recommended\": false,\t    \"archived\": $$.currentRun.processedReceipts[$ = $fid] ~> $exists()\t\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 640,
        "y": 2100,
        "wires": [
            [
                "c7ca8c02a788a41d"
            ]
        ]
    },
    {
        "id": "230dad52a43f6b19",
        "type": "link in",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "Archive receipt link in",
        "links": [
            "d84057a8cb05b22f",
            "87d1c73c93e5b9f7"
        ],
        "x": 395,
        "y": 2640,
        "wires": [
            [
                "135dfd2c3c6f4850"
            ]
        ]
    },
    {
        "id": "c6c8addcda828038",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "Get current receipt ID",
        "rules": [
            {
                "t": "set",
                "p": "tempData",
                "pt": "msg",
                "to": "(\t    $num := payload.id ~> $number();\t    tempDataArray[$num].faktura.id\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1190,
        "y": 2640,
        "wires": [
            [
                "6c4f0dadb67f015e"
            ]
        ]
    },
    {
        "id": "135dfd2c3c6f4850",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "Get history",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "currentRun",
                "pt": "msg",
                "to": "runHistory[$count(runHistory)-1]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 580,
        "y": 2640,
        "wires": [
            [
                "f3622da5b8c6dd11"
            ]
        ]
    },
    {
        "id": "6c4f0dadb67f015e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "Set as processed",
        "rules": [
            {
                "t": "set",
                "p": "currentRun.processedReceipts",
                "pt": "msg",
                "to": "$distinct($append(currentRun.processedReceipts, tempData))",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := currentRun.startDate;\t$endDate := currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t\t    \"processedReceipts\": currentRun.processedReceipts\t    \t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1200,
        "y": 2680,
        "wires": [
            [
                "cbd06ead16ce268d"
            ]
        ]
    },
    {
        "id": "a2f55ae008b1fee2",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "Is archived link out",
        "mode": "link",
        "links": [
            "0ff5c26114374820",
            "e0949865938522b8"
        ],
        "x": 1345,
        "y": 2820,
        "wires": []
    },
    {
        "id": "8b757888b921f031",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "Arkivering af individuelle faktura",
        "info": "",
        "x": 510,
        "y": 2600,
        "wires": []
    },
    {
        "id": "45a7f796cd6e87c3",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "Kontrol om alle fakturaer er arkiveret",
        "info": "",
        "x": 720,
        "y": 2740,
        "wires": []
    },
    {
        "id": "fc1053d3105b2cd0",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "Check if all is archived",
        "func": "var isAllArchived = true;\n\nvar receiptsActions = [];\nvar receiptsNoActions = [];\n\n/*\nif (global.get(\"webData\") !== undefined)\n{\n    if (global.get(\"webData\")[\"citizens-actions\"] !== undefined)\n        receiptsActions += global.get(\"webData\")[\"citizens-actions\"];\n\n    if (global.get(\"webData\")[\"citizens-noactions\"] !== undefined)\n        receiptsNoActions += global.get(\"webData\")[\"citizens-noactions\"];\n\n    if (!Array.isArray(receiptsActions)) receiptsActions = [receiptsActions];\n    if (!Array.isArray(receiptsNoActions)) receiptsNoActions = [receiptsNoActions];\n}\n\nvar allReceipts = [];\n//allReceipts = allReceipts.concat(receiptsActions, receiptsNoActions);\nfor (var i = 0; i < receiptsActions.length; i++)\n    allReceipts.push(receiptsActions[i]);\n    \nfor (var i = 0; i < receiptsNoActions.length; i++)\n    allReceipts.push(receiptsNoActions[i]);\n    \nvar acceptedReceipts;\n\nglobal.set(\"tempTest\", allReceipts);\n*/\nvar acceptedReceipts = msg.currentRun.processedReceipts;\nvar allReceipts = msg.tempData;\n\n/*\nif (global.get(\"runHistory\", \"storeInFile\") !== undefined)\n    if (global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length - 1] !== undefined)\n        acceptedReceipts = global.get(\"runHistory\", \"storeInFile\")[global.get(\"runHistory\", \"storeInFile\").length - 1].processedReceipts;\n*/\n\n//typeof global.get(\"webData\") == undefined || !Array.isArray(global.get(\"webData\")[\"citizens-actions\"]) ? 0 : global.get(\"webData\")[\"citizens-actions\"].length;\nvar remainingCount = allReceipts.length - acceptedReceipts.length;\n\nfor (var i = 0; i < allReceipts.length; i++)\n{\n\n    if (allReceipts[i].faktura === null || allReceipts[i].faktura === undefined)\n        continue;\n\n    var fakturaer = Array.isArray(allReceipts[i].faktura) ? allReceipts[i].faktura : [allReceipts[i].faktura];\n\n    for(var j = 0; j < fakturaer.length; j++)\n        if (!acceptedReceipts.includes(fakturaer[j].id))\n            isAllArchived = false;\n}\n\nmsg.isArchived = isAllArchived;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 680,
        "y": 2820,
        "wires": [
            [
                "62b82381ac8d827c"
            ]
        ]
    },
    {
        "id": "d04faa115ea73982",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "WorkLet login",
        "rules": [
            {
                "t": "set",
                "p": "workletUser",
                "pt": "msg",
                "to": "webData.workletCreds.workletUser",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "workletPass",
                "pt": "msg",
                "to": "webData.workletCreds.workletPass",
                "tot": "global",
                "dc": true
            },
            {
                "t": "delete",
                "p": "webData.workletCreds.workletUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "webData.workletCreds.workletPass",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 480,
        "y": 520,
        "wires": [
            [
                "28d8ac05e7f0f65f"
            ]
        ]
    },
    {
        "id": "c9cc2e6cd25fdbd6",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "[E] Download fakturaer for den bestemte tidsperiode",
        "info": "",
        "x": 590,
        "y": 480,
        "wires": []
    },
    {
        "id": "62b82381ac8d827c",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "",
        "property": "isArchived",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 870,
        "y": 2800,
        "wires": [
            [
                "fb02e28cd75e69e8"
            ],
            [
                "b840a64a9cf3c187"
            ]
        ]
    },
    {
        "id": "d426a3d9a5cc587d",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "44e7408f9fee1e77",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "[]",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 880,
        "y": 340,
        "wires": [
            [
                "35e66215df68100f"
            ]
        ],
        "info": "## Set global.runHistory\r\nSets an empty list in global context stored in file."
    },
    {
        "id": "421ea3a3d1ce558a",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "g": "44e7408f9fee1e77",
        "name": "",
        "property": "#:(storeInFile)::runHistory",
        "propertyType": "global",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 790,
        "y": 280,
        "wires": [
            [
                "619dc0bbb1fdf120"
            ],
            [
                "d426a3d9a5cc587d"
            ]
        ],
        "info": "## Get runHistory switch\r\nChecks if there is a run history stored in memory (in global context)."
    },
    {
        "id": "a87343abb1f1ad70",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "44e7408f9fee1e77",
        "name": "Set currentRun object",
        "info": "",
        "x": 1200,
        "y": 220,
        "wires": []
    },
    {
        "id": "172fd055f45774ea",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "44e7408f9fee1e77",
        "name": "Hent runHistory",
        "info": "",
        "x": 820,
        "y": 240,
        "wires": []
    },
    {
        "id": "0fb1a45baf4dcc7c",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "tempData1",
                "pt": "msg",
                "to": "webData[\"citizens-actions\"]",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "tempData2",
                "pt": "msg",
                "to": "webData[\"citizens-noactions\"]",
                "tot": "global"
            },
            {
                "t": "set",
                "p": "tempData",
                "pt": "msg",
                "to": "$append(tempData1, tempData2)",
                "tot": "jsonata"
            },
            {
                "t": "delete",
                "p": "tempData1",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "tempData2",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 660,
        "y": 2780,
        "wires": [
            [
                "fc1053d3105b2cd0"
            ]
        ]
    },
    {
        "id": "f3622da5b8c6dd11",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "",
        "property": "payload.webSettings.state.activePage",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "view-nograntreceipts",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "view-receipts",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 740,
        "y": 2640,
        "wires": [
            [
                "d521a5aad7378097"
            ],
            [
                "609b3d8d3bfd669e"
            ]
        ]
    },
    {
        "id": "d521a5aad7378097",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "tempDataArray",
                "pt": "msg",
                "to": "webData.citizens-noactions",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 940,
        "y": 2620,
        "wires": [
            [
                "c6c8addcda828038"
            ]
        ]
    },
    {
        "id": "609b3d8d3bfd669e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "tempDataArray",
                "pt": "msg",
                "to": "webData.citizens-actions",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 940,
        "y": 2660,
        "wires": [
            [
                "c6c8addcda828038"
            ]
        ]
    },
    {
        "id": "fb02e28cd75e69e8",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "954337fe9fd2e7cc",
        "name": "Set allReceiptsProcessed = true",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := $$.currentRun.startDate;\t$endDate := $$.currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t    \"allReceiptsProcessed\": true\t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1090,
        "y": 2780,
        "wires": [
            [
                "b840a64a9cf3c187"
            ]
        ]
    },
    {
        "id": "619dc0bbb1fdf120",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "44e7408f9fee1e77",
        "name": "get runHistory",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 960,
        "y": 280,
        "wires": [
            [
                "35e66215df68100f"
            ]
        ],
        "info": "## get runHistory\r\nCopies the run history stored in file to msg.runHistory."
    },
    {
        "id": "56f4f81f3f45559e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "presetStartDate",
                "pt": "msg",
                "to": "04/04/2023",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "presetEndDate",
                "pt": "msg",
                "to": "presetStartDate",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 685,
        "y": 300,
        "wires": [
            [
                "421ea3a3d1ce558a"
            ]
        ],
        "l": false,
        "info": "## Custom deployment date\r\nThis change node defines the starting date for a run, if no runs are found in the run history.\r\nIt is used for testing, as well as for running the flow for the first time after deployment."
    },
    {
        "id": "0315b599de1a9914",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "44e7408f9fee1e77",
        "name": "update runHistory",
        "rules": [
            {
                "t": "set",
                "p": "currentRun.isFinalized",
                "pt": "msg",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "(\t    $startDate := currentRun.startDate;\t    $endDate := currentRun.endDate;\t\t    (runHistory[startDate = $startDate and endDate = $endDate] ~> $exists()) = false ?\t\t    $append(runHistory, currentRun)\t    :\t    runHistory\t)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1390,
        "y": 300,
        "wires": [
            [
                "2c5bfa6b7a2613ab"
            ]
        ]
    },
    {
        "id": "c04211aaccb15e0a",
        "type": "link in",
        "z": "8ea344595d9a442a",
        "g": "59d040b48f8f3dda",
        "name": "Finalize run in",
        "links": [
            "f202f5cad72d049b",
            "2fbf1e644fc53a26"
        ],
        "x": 395,
        "y": 2960,
        "wires": [
            [
                "cb15176764c11180"
            ]
        ]
    },
    {
        "id": "3f4a10860acd5500",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "59d040b48f8f3dda",
        "name": "Finalize run",
        "info": "",
        "x": 450,
        "y": 2920,
        "wires": []
    },
    {
        "id": "cb15176764c11180",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "59d040b48f8f3dda",
        "name": "Get history",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "currentRun",
                "pt": "msg",
                "to": "runHistory[$count(runHistory)-1]",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 570,
        "y": 2960,
        "wires": [
            [
                "72afce271d46b8f9"
            ]
        ]
    },
    {
        "id": "72afce271d46b8f9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "59d040b48f8f3dda",
        "name": "set isFinalized = true",
        "rules": [
            {
                "t": "set",
                "p": "currentRun.isFinalized",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := currentRun.startDate;\t$endDate := currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t\t    \"isFinalized\": true\t    \t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "webSettings.state.isRunning",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 2960,
        "wires": [
            [
                "25f140a78f720950"
            ]
        ]
    },
    {
        "id": "25f140a78f720950",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "59d040b48f8f3dda",
        "name": "Is archived link out",
        "mode": "link",
        "links": [
            "23a573cb9952c0ef"
        ],
        "x": 1105,
        "y": 2960,
        "wires": []
    },
    {
        "id": "eea859cc92e89e3f",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "6c7a3f8252158db6",
        "name": "Fjern duplicates (af Tilføj sag-handlinger)",
        "func": "if(msg.payload == null)\n    return msg;\n\nif(!Array.isArray(msg.payload))\n    msg.payload = [msg.payload];\n\nfor (var i = 0; i < msg.payload.length; i++) {\n    var obj = msg.payload[i];\n\n    var createTypeA = false;\n    var createTypeB = false;\n    //var tempHandlinger = [];\n\n    // Tjek hver borgers handlinger\n\n    if (obj.handlinger !== null && obj.handlinger !== undefined) {\n\n        if (!Array.isArray(obj.handlinger))\n            obj.handlinger = [obj.handlinger];\n\n        for (var j = 0; j < obj.handlinger.length; j++) {\n            if (obj.handlinger[j].handling == \"Opret sag\") {\n                if (obj.handlinger[j].type == \"A\") {\n                    if (createTypeA) {\n                        //console.log(\"Another A already exists for receipt \" + obj.handlinger[j].fid);\n                        obj.handlinger.splice(j, 1);\n                        continue;\n                    }\n                    createTypeA = true;\n                    //tempHandlinger.push(msg.payload.handlinger[j]);\n                }\n\n                else if (obj.handlinger[j].type == \"B\") {\n                    if (createTypeB) {\n                        //console.log(\"Another B already exists for receipt \" + obj.handlinger[j].fid);\n                        obj.handlinger.splice(j, 1);\n                        continue;\n                    }\n                    createTypeB = true;\n                    //tempHandlinger.push(msg.payload.handlinger[j]);\n                }\n            }\n        }\n\n\n        msg.payload[i] = obj;\n\n    }\n\n\n\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 560,
        "y": 1780,
        "wires": [
            [
                "c23d52373f2634a2"
            ]
        ]
    },
    {
        "id": "87437eca4cc7eec9",
        "type": "websocket out",
        "z": "8ea344595d9a442a",
        "g": "0b13e46f82eeff1c",
        "name": "WorkLet WebSocket",
        "server": "13a90a014adf9bc5",
        "client": "",
        "x": 2080,
        "y": 200,
        "wires": []
    },
    {
        "id": "966a912086c08955",
        "type": "subflow:85ff29bdef7c1aea",
        "z": "8ea344595d9a442a",
        "g": "b95a594cf23c004f",
        "name": "",
        "x": 1810,
        "y": 1140,
        "wires": [
            []
        ]
    },
    {
        "id": "21aa70c86addca5a",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "b95a594cf23c004f",
        "name": "Add step run history",
        "rules": [
            {
                "t": "set",
                "p": "stepHistoryChange",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "stepHistoryChange.newStep",
                "pt": "msg",
                "to": "extract-worklet",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "stepHistoryChange.newState",
                "pt": "msg",
                "to": "running",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1840,
        "y": 1100,
        "wires": [
            [
                "966a912086c08955"
            ]
        ]
    },
    {
        "id": "4424787318323d8e",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "Findes filen?",
        "func": "const fs = global.get('fs');\nconst path = global.get('path');\nconst downloadPath = path.resolve('./download');\nmsg.filePath = downloadPath + \"\\\\\" + msg.fileName;\n\nif (fs.existsSync(msg.filePath))\n{\n    msg.fileExists = true;\n    node.status({ fill: \"green\", shape: \"dot\", text: \"Fil blev fundet\" });\n}\nelse\n{\n    msg.fileExists = false;\n    node.status({ fill: \"yellow\", shape: \"dot\", text: \"Fil blev ikke fundet!\" });\n}\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1430,
        "y": 480,
        "wires": [
            [
                "023477a667bd9144"
            ]
        ],
        "info": "## Check for file\r\nThis JS snippet utilizes global modules `FS` and `Path` to check if the receipt JSON file already exists, or needs to be downloaded."
    },
    {
        "id": "023477a667bd9144",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "g": "669e09e244099963",
        "name": "",
        "property": "fileExists",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 1535,
        "y": 480,
        "wires": [
            [
                "2359edd9babea1ac"
            ],
            [
                "4003aad4b2b6a9c8"
            ]
        ],
        "l": false
    },
    {
        "id": "4629d4bebfd2768f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Sammensæt lister",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "/* Laver array med objekt for hver borger, og tilknytter fakturaer */\t\t$keys(citizens)@$k.{\t\t    \"cpr\": $k,\t    \"persondata\": $lookup(citizens, $k),\t    \"faktura\": receipts[$.patientCPR = $k]\t    \t}\t",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 450,
        "y": 1220,
        "wires": [
            [
                "00a9a4712b97560f"
            ]
        ],
        "info": "https://try.jsonata.org/wRgtKDrKD"
    },
    {
        "id": "aea48540dc37e51c",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Saml borgere og fakturaer",
        "info": "",
        "x": 470,
        "y": 1180,
        "wires": []
    },
    {
        "id": "64bc816ed683fb56",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Personlig tillægsprocenter",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|(\t\t$tillaegsprocent_split := personligtillaegsprocent\t    ~> $replace(\"Personlig tillægsprocent\\tGyldig fra\\tGyldig til\\tAjourføringsdato\\n\", \"\")\t    ~> $split(\"\\n\");\t{\t\t\"personligtillaegsprocent\": $tillaegsprocent_split #$i .{\t\t    \"dato_fra\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[1]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"dato_til\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[2]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"tillaegsprocent\": ($t := (($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[0]\t        ~> $replace(\"%\", \"\")\t        ~> $replace(\"Ingen resultater fundet\", \"0\"));\t          ($t = \"\" ? 0 : $number($t)))\t    }\t\t}\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 470,
        "y": 1340,
        "wires": [
            [
                "78c4e4692985e738"
            ]
        ],
        "info": "https://try.jsonata.org/4J8IPRU83"
    },
    {
        "id": "b01934ac82f070c3",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Bevilget tilskud til fodpleje?",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|\t{\t\"bevilling\":\t    bevilling \t    ~> $contains(\"fodpleje\")\t}|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 480,
        "y": 1300,
        "wires": [
            [
                "64bc816ed683fb56"
            ]
        ]
    },
    {
        "id": "31392fe7f3a93ccd",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Gør KP data maskinelt læsbart",
        "info": "",
        "x": 490,
        "y": 1260,
        "wires": []
    },
    {
        "id": "141037f73383a9f6",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Tildel unikke behandlings-ID'er",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura |\t({\t\t\"behandlinger\": behandlinger @$b #$i .{\t\t    \"uid\": (id ~> $substring(19,17))\t            & \"-\" & $b.ydelsesnummer\t            & \"-\" & ($i+1),\t\t    \"fid\": id,\t\t    \"titel\": $b.titel,\t    \"ydelsesnummer\": $b.ydelsesnummer,\t    \"ydernummer\": $b.ydernummer,\t    \"behandlingsKategory\": $b.behandlingsKategory,\t    \"pris\": $b.pris,\t    \"kørteKilometer\": $b.kørteKilometer,\t    \"patientAndel\": $b.patientAndel,\t    \"sygesikringsAndel\": $b.sygesikringsAndel\t\t}\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1190,
        "y": 1380,
        "wires": [
            [
                "7f450a3e484312bd"
            ]
        ],
        "info": "https://try.jsonata.org/zbfWKbpM7"
    },
    {
        "id": "78c4e4692985e738",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Helbredstillægsprocenter",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|(\t\t$tillaegsprocent_split := helbredstillaegsprocent\t    ~> $replace(\"Helbredstillægsprocent\\tGyldig fra\\tGyldig til\\tAjourføringsdato\\n\", \"\")\t    ~> $split(\"\\n\");\t{\t\t\"helbredstillaegsprocent\": $tillaegsprocent_split #$i .{\t\t    \"dato_fra\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[1]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"dato_til\": ($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[2]\t        ~> $toMillis('[D01]-[M01]-[Y0001]')\t        ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t    \"tillaegsprocent\": ($t := (($tillaegsprocent_split[$i]\t        ~> $split(\"\\t\"))[0]\t        ~> $replace(\"%\", \"\")\t        ~> $replace(\"Ingen resultater fundet\", \"0\"));\t          ($t = \"\" ? 0 : $number($t)))\t    }\t\t}\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 470,
        "y": 1380,
        "wires": [
            [
                "2cf375bbbada29f9"
            ]
        ],
        "info": "https://try.jsonata.org/4J8IPRU83"
    },
    {
        "id": "2cf375bbbada29f9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Sager",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|(\t\t$sager_split := sager\t    ~> $replace(\"\\n\", \"\")\t    ~> $replace(\"\\t\\t\", \"\\t\")\t    ~> $substringAfter(\"\\t\")\t    ~> $split(\"\\t\");\t{\t    \"sager\": $sager_split #$i .(\t\t        /* Hvis kolonne-antal ændrer sig, breaker denne kode */\t\t        $i % 5 = 0 and $i != 0 ?\t        {\t            \"titel\": $sager_split[$i],\t            \t            \"type\": $sager_split[$i+1],\t\t            \"fra\": $sager_split[$i+2]\t                ~> $toMillis('[D01]-[M01]-[Y0001]')\t                ~> $fromMillis('[Y0001]-[M01]-[D01]'),\t\t            \"til\": $til := ($sager_split[$i+3]\t                ~> $toMillis('[D01]-[M01]-[Y0001]')\t                ~> $fromMillis('[Y0001]-[M01]-[D01]')),\t\t            \"aktiv\": ($til ~> $boolean()) ? ( $til ~> $toMillis() > $millis() ? true : false ) : true,\t\t            \"bevilling\": ($sager_split[$i+4] = \"Bevilget\")\t        })\t\t    }\t)|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 410,
        "y": 1420,
        "wires": [
            [
                "12d9ffdfaf71a523"
            ]
        ],
        "info": "https://try.jsonata.org/4J8IPRU83"
    },
    {
        "id": "12d9ffdfaf71a523",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Formue",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|\t{\t    \"formue\": \t            formue = \"Ikke oplyst\" ?\t                null\t            :\t            formue = \"-\" ?\t                null\t            :\t                (formue\t                ~> $replace(\"-\", \"-1\")\t                ~> $split(\" \"))[0]\t                ~> $replace(\".\", \"\")\t                ~> $replace(\",\", \".\")\t                ~> $number()\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 420,
        "y": 1460,
        "wires": [
            [
                "ca6df1c9d056a924"
            ]
        ]
    },
    {
        "id": "011d535e3ab60636",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Transformer faktura data (+ fjern unødvendig data)",
        "info": "",
        "x": 1250,
        "y": 1260,
        "wires": []
    },
    {
        "id": "71c55498ef71a4c9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Fjern unødvendig data",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.faktura|\t{},\t[\t    \"behandlerNavn\",\t    \"klinikNavn\",\t    \"klinikCVR\",\t    \"behandlerType\",\t    \"patientTelefon\"\t]\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1160,
        "y": 1300,
        "wires": [
            [
                "6afaf8f1c596de67"
            ]
        ]
    },
    {
        "id": "6afaf8f1c596de67",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Fjern tidspunkt fra dato",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.faktura|\t{\t    \"dato\": (dato\t        ~> $split(\"T\"))[0]\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1160,
        "y": 1340,
        "wires": [
            [
                "141037f73383a9f6"
            ]
        ]
    },
    {
        "id": "05096968ae22cc6f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Bestem behandlingstype",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura.behandlinger |\t({\t\t    \"type\": (titel = 'Behandlingipatientsegethjem' or\t             titel = 'Behandlingpåklinik' or\t             titel = \"Behandlingudentilskud\") ?\t                'A' : 'B'\t\t})|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$.errors ~> | $.faktura.behandlinger |\t({\t\t    \"type\": (titel = 'Behandlingipatientsegethjem' or\t             titel = 'Behandlingpåklinik' or\t             titel = \"Behandlingudentilskud\") ?\t                'A' : 'B'\t\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1170,
        "y": 1540,
        "wires": [
            [
                "046eb82cefda08d4"
            ]
        ],
        "info": "https://try.jsonata.org/zbfWKbpM7"
    },
    {
        "id": "215c708ef9319356",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Hent regler fra global variabel",
        "rules": [
            {
                "t": "set",
                "p": "rules",
                "pt": "msg",
                "to": "#:(storeInFile)::rules",
                "tot": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 810,
        "y": 1320,
        "wires": [
            [
                "4c51b10755b92b07"
            ]
        ]
    },
    {
        "id": "c68d4ee2f02ada08",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Kontroller KP data ud fra regelsæt",
        "info": "",
        "x": 820,
        "y": 1280,
        "wires": []
    },
    {
        "id": "4c51b10755b92b07",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Tjek alle regler mod borgerdata",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "payload @$p.\t(\t$respectsRule := function($rule, $value)\t{\t    $rule.operator = \"!null\" ?\t        $value != null\t    :\t    $value = null ?\t        false\t    :\t    $rule.operator = \"<\" ?\t        $value < $rule.value\t    :\t    $rule.operator = \">\" ?\t        $value > $rule.value\t    :\t    $rule.operator = \"==\" ?\t        $value = $rule.value\t    :\t    $rule.operator = \"!=\" ?\t        $value != $rule.value\t    :\t    $rule.operator = \"contains\" ?\t        ($contains($string($rule.value), $string($value)))\t    :\t    $rule.operator = \"!contains\" ?\t        ($contains($string($rule.value), $string($value)) ? false : true)\t};\t{\t    \"cpr\": $p.cpr,\t    \"persondata\": $p.persondata,\t    \"faktura\": $p.faktura,\t\t    \"regelbrud\":\t        rules @$r.\t        (\t            $respectsRule($r, $data := $lookup($p.persondata, $r.variable)) = false ?\t            {\t                \"rule\": $r.name,\t                \"description\": $r.description,\t                \"objectValue\": $data,\t                \"operator\": $r.operator,\t                \"expectedValue\": $r.value,\t                \"isRespected\": $respectsRule($r, $data)\t            }\t        )\t}\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 810,
        "y": 1360,
        "wires": [
            [
                "4e374431cb68ace4"
            ]
        ]
    },
    {
        "id": "4e374431cb68ace4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find regelbrud",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "errors @$e.\t(\t    $e.regelbrud ~> $boolean ?\t    {\t        \"cpr\": $e.cpr,\t        \"persondata\": $e.persondata,\t        \"faktura\": $e.faktura,\t        \"regelbrud\": $e.regelbrud\t    }\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 760,
        "y": 1400,
        "wires": [
            [
                "5e112e4574f64f9b"
            ]
        ]
    },
    {
        "id": "5e112e4574f64f9b",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Fjern borgere som ikke er berettiget",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload @$p.\t(\t    \t    (errors[cpr = $p.cpr] ~> $exists) = false ?\t    {\t        \"cpr\": $p.cpr,\t        \"persondata\": $p.persondata,\t        \"faktura\": $p.faktura\t    }\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 1440,
        "wires": [
            [
                "ac26dfbc2efcbb4f"
            ]
        ]
    },
    {
        "id": "046eb82cefda08d4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find bevilling + sag gældende for hver behandling",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura.behandlinger |\t(\t\t    $uid := uid;\t    $fid := fid;\t    $faktura := $$.payload.faktura[id = $fid];\t    $borger := $$.payload[cpr = $faktura.patientCPR];\t    $type := type;\t\t{\t    \"bevilget\": type = 'A' ?\t                    ($borger.persondata.bevilling ?\t                        true : $borger.persondata.sager\t                                [   \t                                    titel ~> $lowercase ~> $contains(\"fod\")\t                                and\t                                    (type ~> $lowercase ~> $contains(\"udvidet helbredstill\"))\t                                and\t                                    ($faktura.dato ~> $toMillis) > (fra ~> $toMillis)\t                                and\t                                    (til ? ($faktura.dato ~> $toMillis) < (til ~> $toMillis) : true)\t                                and\t                                    bevilling = true\t                                ]\t                                    ~> $exists ? true : false)\t                :\t                    ($borger.persondata.sager\t                        [\t                            (type ~> $lowercase ~> $contains(\"almindeligt helbred\")\t                        or\t                            type ~> $lowercase ~> $contains(\"gskort\"))\t                        and\t                            ($faktura.dato ~> $toMillis) > (fra ~> $toMillis)\t                        and\t                            (til ? ($faktura.dato ~> $toMillis) < (til ~> $toMillis) : true)\t                        and\t                            bevilling = true\t                        ]\t                            ~> $exists ? true : false),\t                                \t    \"sag\": $borger.persondata.sager\t                [\t                    titel ~> $lowercase ~> $contains(\"fod\")\t                and\t                    ($type = 'A' ?\t                        (type ~> $lowercase ~> $contains(\"udvidet helbred\"))\t                    :\t                        (type ~> $lowercase ~> $contains(\"almindeligt helbredstill\")\t                    or\t                        type ~> $lowercase ~> $contains(\"gskort\")))\t                and\t                    ($faktura.dato ~> $toMillis) > (fra ~> $toMillis)\t                and\t                    (til ? ($faktura.dato ~> $toMillis) < (til ~> $toMillis) : true)\t                and\t                    bevilling = true\t                ]\t\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1250,
        "y": 1580,
        "wires": [
            [
                "dc943787affd67f4",
                "e1e1f0e8189c47e5",
                "c4cfcf10fce7bd98"
            ]
        ]
    },
    {
        "id": "6b4df0013a0256a0",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find relevant data for hver behandling på faktura",
        "info": "",
        "x": 1240,
        "y": 1500,
        "wires": []
    },
    {
        "id": "7f450a3e484312bd",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find tillægsprocent gældende for hver faktura",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura |\t(\t\t    $id := id;\t    /*$borger := $$.payload[faktura.id = $id];*/\t    $borger := $$.payload[$id in faktura.id];\t    $dato := dato;\t\t{\t\t    \"_personligtillaegsprocent\": $borger.persondata.personligtillaegsprocent [\t        ($dato ~> $toMillis) > (dato_fra ~> $toMillis)\t    and\t        (dato_til ~> $boolean ? (($dato ~> $toMillis) < (dato_til ~> $toMillis)) : true)\t    ],\t\t    \"_helbredstillaegsprocent\": $borger.persondata.helbredstillaegsprocent [\t        ($dato ~> $toMillis) > (dato_fra ~> $toMillis)\t    and\t        (dato_til ~> $boolean ? (($dato ~> $toMillis) < (dato_til ~> $toMillis)) : true)\t    ]\t\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1230,
        "y": 1460,
        "wires": [
            [
                "6cfa59d7c02c8c82"
            ]
        ]
    },
    {
        "id": "852046d71f487d02",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find relevant data for hver faktura",
        "info": "",
        "x": 1190,
        "y": 1420,
        "wires": []
    },
    {
        "id": "015eb190e5565e7d",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "[T] Transformér data, beregn tilskud",
        "info": "",
        "x": 500,
        "y": 1140,
        "wires": []
    },
    {
        "id": "ca6df1c9d056a924",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Danmark",
        "func": "if(msg.payload == null)\n    return;\n\nif(!Array.isArray(msg.payload))\n    msg.payload = [msg.payload];\n    \nfor(var i = 0; i < msg.payload.length; i++)\n\n{\n    const obj = msg.payload[i].persondata;\n\n    var danmarkNum;\n\n    if(obj == null || obj.danmarkgruppe == null)\n        continue;\n\n    if (obj.danmarkgruppe.toLowerCase().includes(\"ja\") && obj.danmarkgruppe.includes(\"1\"))\n        danmarkNum = 1;\n    else if (obj.danmarkgruppe.toLowerCase().includes(\"ja\") && obj.danmarkgruppe.includes(\"2\"))\n        danmarkNum = 2;\n    else if (obj.danmarkgruppe.toLowerCase().includes(\"ja\") && obj.danmarkgruppe.includes(\"5\"))\n        danmarkNum = 5;\n    else\n        danmarkNum = 0;\n\n    obj.danmarkgruppe = danmarkNum;\n    \n\n    /*\n    $.payload ~> |$.persondata|\n(\n{\n    \"danmarkgruppe\": danmarkgruppe\n    ~> $replace(\"Ikke oplyst\", \"0\")\n    ~> $replace(\"Nej\", \"0\")\n    ~> $replace(\"Ja - Gruppe \", \"\")\n    ~> $replace(\"-\", \"0\")\n    ~> $number\n})\n|\n*/\n\n}\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 1500,
        "wires": [
            [
                "81cc412d0d2170b9"
            ]
        ]
    },
    {
        "id": "00a9a4712b97560f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "missingData",
                "pt": "msg",
                "to": "receipts @$r.\t(\t    payload[cpr = $r.patientCPR] ~> $exists() = false ?\t    {\t        \"cpr\": $r.patientCPR,\t        \"faktura\": $r,\t        \"regelbrud\": \"Borger-data blev ikke indsamlet korrekt\"\t    }\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 740,
        "y": 1200,
        "wires": [
            [
                "b01934ac82f070c3"
            ]
        ]
    },
    {
        "id": "1ee2c685a74c09b0",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Mangler borgere?",
        "info": "",
        "x": 730,
        "y": 1160,
        "wires": []
    },
    {
        "id": "ac26dfbc2efcbb4f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Saml errors og missingData lister",
        "rules": [
            {
                "t": "set",
                "p": "errors",
                "pt": "msg",
                "to": "$append(errors, missingData)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 820,
        "y": 1480,
        "wires": [
            [
                "71c55498ef71a4c9"
            ]
        ]
    },
    {
        "id": "81cc412d0d2170b9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "URL",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> |$.persondata|\t{\t    \"kpurl\": \t            kpurl ~> $contains(\"overblik?pId=\") ?\t                (kpurl ~> $split(\"overblik?pId=\"))[1]\t            :\t            (((kpurl ~> $split(\"/person/\"))[1]) ~> $split(\"/overblik\"))[0]\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 410,
        "y": 1540,
        "wires": [
            [
                "7d7a7bf5a54224e8"
            ]
        ]
    },
    {
        "id": "c3932c1fbca91f98",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Set userName in runHistory",
        "rules": [
            {
                "t": "set",
                "p": "brugernavn",
                "pt": "msg",
                "to": "(((brugernavn ~> $split(\":\"))[1]) ~> $split(\"/\"))[0]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "currentRun.userName",
                "pt": "msg",
                "to": "brugernavn",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := currentRun.startDate;\t$endDate := currentRun.endDate;\t$userName := $$.brugernavn;\t\t/*startDate = $startDate and endDate = $endDate ?*/\t{\t\t    \"userName\": $userName\t    \t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1660,
        "y": 820,
        "wires": [
            [
                "19bdc53204115899",
                "763d5d3a56706a02"
            ]
        ]
    },
    {
        "id": "f811b83fc07bb1cd",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Kontrol om alle fakturaer er arkiveret",
        "info": "",
        "x": 580,
        "y": 2160,
        "wires": []
    },
    {
        "id": "c7ca8c02a788a41d",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Check if all is archived",
        "func": "\nvar acceptedReceipts = msg.currentRun.processedReceipts;\nif(!Array.isArray(acceptedReceipts)) acceptedReceipts = [acceptedReceipts];\n\nvar allReceipts = msg.receipts;\nif (!Array.isArray(allReceipts)) allReceipts = [allReceipts];\n\nvar remainingCount = allReceipts.length - acceptedReceipts.length;\n\nmsg.isArchived = !(remainingCount > 0);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 540,
        "y": 2240,
        "wires": [
            [
                "8f4d2dcc4c986825"
            ]
        ]
    },
    {
        "id": "8f4d2dcc4c986825",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "",
        "property": "isArchived",
        "propertyType": "msg",
        "rules": [
            {
                "t": "true"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 750,
        "y": 2240,
        "wires": [
            [
                "78f7e1718ab3f755"
            ],
            [
                "4840de2e1aa54398"
            ]
        ]
    },
    {
        "id": "78f7e1718ab3f755",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "380e5c7e0ea3778b",
        "name": "Set allReceiptsProcessed = true",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := $$.currentRun.startDate;\t$endDate := $$.currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t    \"allReceiptsProcessed\": true\t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 970,
        "y": 2220,
        "wires": [
            [
                "4840de2e1aa54398"
            ]
        ]
    },
    {
        "id": "63ec872a76a39ffb",
        "type": "link in",
        "z": "8ea344595d9a442a",
        "g": "0b13e46f82eeff1c",
        "name": "WS IN",
        "links": [
            "427c8a1a563502c8",
            "5b599232bb01d1d2",
            "5ee0ef61ccdcafac",
            "75f1aaf5a21e12a8",
            "f1884a7421b13391",
            "181615f06b564d1e",
            "7e0e36d833794733",
            "d0ec6e3e02665e27"
        ],
        "x": 1765,
        "y": 200,
        "wires": [
            [
                "d8fce4eadecd4493",
                "87437eca4cc7eec9"
            ]
        ]
    },
    {
        "id": "96c62bac832126e6",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "b95a594cf23c004f",
        "name": "RunHistory WiP",
        "info": "",
        "x": 1820,
        "y": 1080,
        "wires": []
    },
    {
        "id": "0f583d6bfaad7d0e",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "a95d2f4df03e969c",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Henter persondata fra KP ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1970,
        "y": 580,
        "wires": [
            [
                "427c8a1a563502c8"
            ]
        ]
    },
    {
        "id": "427c8a1a563502c8",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "a95d2f4df03e969c",
        "name": "link out 2",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 2095,
        "y": 580,
        "wires": []
    },
    {
        "id": "ca4cd4b46c05bb1d",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "e1dc720ff59cd15f",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Henter fakturaer fra WorkLet ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1970,
        "y": 300,
        "wires": [
            [
                "5b599232bb01d1d2"
            ]
        ]
    },
    {
        "id": "5b599232bb01d1d2",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "e1dc720ff59cd15f",
        "name": "link out 1",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 2095,
        "y": 300,
        "wires": []
    },
    {
        "id": "19bdc53204115899",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9354c79c8ad83b63",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Bearbejder data ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1970,
        "y": 820,
        "wires": [
            [
                "75f1aaf5a21e12a8"
            ]
        ]
    },
    {
        "id": "75f1aaf5a21e12a8",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "9354c79c8ad83b63",
        "name": "link out 3",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 2095,
        "y": 820,
        "wires": []
    },
    {
        "id": "dc943787affd67f4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "8f09bd47d22cbe66",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Beregner tilskud ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1970,
        "y": 1580,
        "wires": [
            [
                "5ee0ef61ccdcafac"
            ]
        ]
    },
    {
        "id": "5ee0ef61ccdcafac",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "8f09bd47d22cbe66",
        "name": "link out 4",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 2095,
        "y": 1580,
        "wires": []
    },
    {
        "id": "ac2d9ca641a094e8",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "0c2baa05bdc8cb3c",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Færdiggører ...",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1970,
        "y": 1900,
        "wires": [
            [
                "f1884a7421b13391"
            ]
        ]
    },
    {
        "id": "f1884a7421b13391",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "0c2baa05bdc8cb3c",
        "name": "link out 5",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 2095,
        "y": 1900,
        "wires": []
    },
    {
        "id": "d8fce4eadecd4493",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "0b13e46f82eeff1c",
        "name": "Format status",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "{\t\"message\": message, \"type\": type, \"title\": title   \t}",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1880,
        "y": 200,
        "wires": [
            [
                "87437eca4cc7eec9"
            ]
        ]
    },
    {
        "id": "6f70a9263a101b22",
        "type": "switch",
        "z": "8ea344595d9a442a",
        "name": "",
        "property": "citizens",
        "propertyType": "msg",
        "rules": [
            {
                "t": "nempty"
            },
            {
                "t": "else"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 410,
        "y": 1020,
        "wires": [
            [
                "96eacaac34db6202"
            ],
            [
                "f462cfb8de682697"
            ]
        ]
    },
    {
        "id": "f462cfb8de682697",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "13424c114a577170",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.isRunning",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "currentRun.allReceiptsProcessed",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "$.runHistory~> |$|(\t\t$startDate := $$.currentRun.startDate;\t$endDate := $$.currentRun.endDate;\t\tstartDate = $startDate and endDate = $endDate ?\t{\t    \"allReceiptsProcessed\": true, \"isFinalized\": false\t}\t\t)|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 115,
        "y": 1060,
        "wires": [
            [
                "42e8d0e6b5e55314",
                "d0db0a27f5e322ae"
            ]
        ],
        "l": false
    },
    {
        "id": "42e8d0e6b5e55314",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "13424c114a577170",
        "name": "START response out",
        "mode": "link",
        "links": [
            "5c74b689e0aee38b"
        ],
        "x": 195,
        "y": 1060,
        "wires": []
    },
    {
        "id": "30f14b6f815a98ef",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "\"Henter persondata fra KP ... \" & percentage & \"%\"",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "update",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1310,
        "y": 920,
        "wires": [
            [
                "181615f06b564d1e"
            ]
        ]
    },
    {
        "id": "181615f06b564d1e",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "name": "link out 6",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 1415,
        "y": 920,
        "wires": []
    },
    {
        "id": "70a379ce2563656b",
        "type": "function",
        "z": "8ea344595d9a442a",
        "name": "Calc %",
        "func": "var percentage = msg.pupid / msg.totalCount * 100;\npercentage = parseInt(percentage);\n\nmsg.percentage = percentage;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1160,
        "y": 920,
        "wires": [
            [
                "30f14b6f815a98ef"
            ]
        ]
    },
    {
        "id": "6e042d4222a1a115",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "name": "Tjek om fakturaliste er tom",
        "info": "",
        "x": 470,
        "y": 980,
        "wires": []
    },
    {
        "id": "bc99d7022f61a990",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Set selectors",
        "rules": [
            {
                "t": "set",
                "p": "selectors.kp",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.kp.url",
                "pt": "msg",
                "to": "https://fagsystem.kommunernespensionssystem.dk/",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.login",
                "pt": "msg",
                "to": "{}",
                "tot": "json"
            },
            {
                "t": "set",
                "p": "selectors.kp.login.select",
                "pt": "msg",
                "to": "[id=\"SelectedAuthenticationUrl\"]",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.login.button",
                "pt": "msg",
                "to": ".button",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.inputCPR",
                "pt": "msg",
                "to": "#search_box input",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.inputCPR_soegknap",
                "pt": "msg",
                "to": "#search_box button",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.personligtillaegsprocent",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(5) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.helbredstillaegsprocent_aabn",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(6) > td:nth-child(3) > div > div > span > span",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.helbredstillaegsprocent",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(6) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.danmarkgruppe",
                "pt": "msg",
                "to": "#person-oplysninger > tbody > tr:nth-child(6) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.personligtillaegsprocent_aabn",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(5) > td:nth-child(3) > div > div > span > span",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.tillaegsprocent",
                "pt": "msg",
                "to": "#history_table",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.tillaegsprocent_luk",
                "pt": "msg",
                "to": "#person-pension-fakta div.sc-gPEVay.ceKhsN > div.sc-jlyJG.NUpYs > svg",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.formue",
                "pt": "msg",
                "to": "#person-pension-fakta > tbody > tr:nth-child(4) > td:nth-child(2) > div",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.sager",
                "pt": "msg",
                "to": "#person_overblik_sager_table",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.lukborger",
                "pt": "msg",
                "to": "svg.svg-inline--fa.fa-times.fa-w-11.fa-1x",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "selectors.kp.citizen.bevilling",
                "pt": "msg",
                "to": "#app div.tab-content div.tab-content > div > div > div:nth-child(1) > div",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 470,
        "y": 860,
        "wires": [
            [
                "c2df29c07624e5e0"
            ]
        ]
    },
    {
        "id": "d183f106c2e11bce",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "citizens",
                "pt": "msg",
                "to": "$distinct(receipts@$A.(\t[\t    {\t        \"cpr\": $A.patientCPR\t    }\t]))",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 440,
        "y": 820,
        "wires": [
            [
                "bc99d7022f61a990"
            ]
        ]
    },
    {
        "id": "c2df29c07624e5e0",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Set pup commands",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "[\t    {\t       \"action\": \"launch\",\t       \"parameters\":\t        {\t           \"headless\": true,\t           \"slowMo\": 25,\t           \"ignoreHTTPSErrors\": true,\t           \"defaultViewport\": null\t        }\t    },\t\t    {\t       \"action\": \"goto\",\t       \"url\": \"https://fagsystem.kommunernespensionssystem.dk/\"\t\t    },\t    \t    {\t        \"action\": \"wait\",\t        \"ms\": 5000\t    },\t\t    {\t       \"action\": \"select\",\t       \"path\": \"[id=\\\"SelectedAuthenticationUrl\\\"]\",\t       \"input\": \"Randers Kommune\"\t    },\t        \t    {\t        \"action\": \"wait\",\t        \"ms\": 500\t    },\t\t    {\t        \"action\": \"authenticate\",\t        \"username\": payload.webData.dqCreds.dqUser,\t        \"password\": payload.webData.dqCreds.dqPass\t    },\t\t    {\t        \"action\": \"wait\",\t        \"ms\": 500\t    },\t\t\t    {\t       \"action\": \"click\",\t       \"path\": \".button\"\t    },\t\t    {\t       \"action\": \"get\",\t       \"name\": \"navn\",\t       \"path\": \"div[class=\\\"sc-iwsKbI sc-gqjmRU yImXU\\\"]\"\t    }\t]",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$append(payload, citizens@$A.(\t    [\t        {\t           \"action\": \"type\",\t           \"input\": $A.cpr,\t           \"path\": selectors.kp.inputCPR\t\t        },\t        {\t           \"action\": \"click\",\t           \"path\": selectors.kp.inputCPR_soegknap\t\t        },\t        {\t            \"action\": \"geturl\",\t            \"name\": \"kpurl\",\t            \"obj\": $A.cpr\t        },\t        {\t            \"action\": \"clickifexists\",\t            \"path\": 'div[class=\"sc-jKVCRD CUfQJ\"]'\t        },\t        {\t           \"action\": \"click\",\t           \"path\": selectors.kp.citizen.personligtillaegsprocent_aabn\t\t        },\t        {\t           \"action\": \"get\",\t           \"name\": \"personligtillaegsprocent\",\t           \"path\": selectors.kp.citizen.tillaegsprocent,\t           \"obj\": $A.cpr\t\t        },\t        {\t           \"action\": \"click\",\t           \"path\": selectors.kp.citizen.tillaegsprocent_luk\t\t        },\t        {\t            \"action\": \"click\",\t            \"path\": selectors.kp.citizen.helbredstillaegsprocent_aabn\t\t        },\t        {\t            \"action\": \"get\",\t            \"name\": \"helbredstillaegsprocent\",\t            \"path\": selectors.kp.citizen.tillaegsprocent,\t            \"obj\": $A.cpr\t\t        },\t        {\t            \"action\": \"click\",\t            \"path\": selectors.kp.citizen.tillaegsprocent_luk\t\t        },\t        {\t            \"action\": \"get\",\t            \"name\": \"bevilling\",\t            \"path\": selectors.kp.citizen.bevilling,\t            \"obj\": $A.cpr\t\t        },\t        {\t           \"action\": \"get\",\t           \"name\": \"sager\",\t           \"path\": selectors.kp.citizen.sager,\t           \"obj\": $A.cpr\t\t        },\t        {\t           \"action\": \"get\",\t           \"name\": \"danmarkgruppe\",\t           \"path\": selectors.kp.citizen.danmarkgruppe,\t           \"obj\": $A.cpr\t\t        },\t        {\t           \"action\": \"get\",\t           \"name\": \"formue\",\t           \"path\": selectors.kp.citizen.formue,\t           \"obj\": $A.cpr\t\t        },\t        {\t            \"action\": \"click\",\t            \"path\": selectors.kp.citizen.lukborger\t        }\t    ]\t))",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$append(payload,\t{\t    \"action\": \"close\"\t}\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 690,
        "y": 820,
        "wires": [
            [
                "c8857f0a61f8c92e"
            ]
        ]
    },
    {
        "id": "c8857f0a61f8c92e",
        "type": "subflow:41d1b8798efe7e15",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "",
        "x": 1000,
        "y": 820,
        "wires": [
            [
                "70ade91971d73d3b"
            ],
            [
                "70a379ce2563656b"
            ]
        ]
    },
    {
        "id": "0df1e3c807393a69",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Klargør læsning af persondata fra KP",
        "info": "",
        "x": 750,
        "y": 780,
        "wires": []
    },
    {
        "id": "573bc9a19cb2a144",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Læs CPR fra faktura",
        "info": "",
        "x": 450,
        "y": 780,
        "wires": []
    },
    {
        "id": "70ade91971d73d3b",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "",
        "rules": [
            {
                "t": "move",
                "p": "pupOutputs.navn",
                "pt": "msg",
                "to": "brugernavn",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "citizens",
                "pt": "msg",
                "to": "pupOutputs",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1220,
        "y": 820,
        "wires": [
            [
                "81a00971b2ea464e",
                "172fe34eeccca8dd",
                "98bc3b2a3f851a56"
            ]
        ]
    },
    {
        "id": "81a00971b2ea464e",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Borgerliste debug",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "citizens",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1230,
        "y": 860,
        "wires": []
    },
    {
        "id": "3691fee0bd5cd7bc",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Læs persondata",
        "info": "",
        "x": 1000,
        "y": 780,
        "wires": []
    },
    {
        "id": "5c03893a530479bb",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "Gem data i midlertidig hukommelse",
        "info": "",
        "x": 1280,
        "y": 780,
        "wires": []
    },
    {
        "id": "f7835ac1742b0168",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "9c4f3569ebca5f7b",
        "name": "[E] Læs relevant persondata fra KP vedr. de pågældende borgere",
        "info": "",
        "x": 590,
        "y": 720,
        "wires": []
    },
    {
        "id": "7e0e36d833794733",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "20ed2134d81b57c8",
        "name": "link out 7",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 2105,
        "y": 480,
        "wires": []
    },
    {
        "id": "2359edd9babea1ac",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "20ed2134d81b57c8",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.isRunning",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "delete",
                "p": "payload",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1915,
        "y": 440,
        "wires": [
            [
                "2c999012fa2d0842",
                "08f36899ebeff27b"
            ]
        ],
        "l": false
    },
    {
        "id": "08f36899ebeff27b",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "20ed2134d81b57c8",
        "name": "START response out",
        "mode": "link",
        "links": [
            "5c74b689e0aee38b"
        ],
        "x": 2005,
        "y": 400,
        "wires": []
    },
    {
        "id": "0af59de1688c9df4",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "20ed2134d81b57c8",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Loginoplysninger er muligvis forkerte, ellers fungerer WorkLet webinterface ikke som det skal.",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "alert",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "title",
                "pt": "msg",
                "to": "Fejl ved hentning af WorkLet fakturaer",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1990,
        "y": 480,
        "wires": [
            [
                "7e0e36d833794733"
            ]
        ]
    },
    {
        "id": "2c999012fa2d0842",
        "type": "delay",
        "z": "8ea344595d9a442a",
        "g": "20ed2134d81b57c8",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 2030,
        "y": 440,
        "wires": [
            [
                "0af59de1688c9df4"
            ]
        ]
    },
    {
        "id": "d0db0a27f5e322ae",
        "type": "delay",
        "z": "8ea344595d9a442a",
        "g": "13424c114a577170",
        "name": "",
        "pauseType": "delay",
        "timeout": "1",
        "timeoutUnits": "seconds",
        "rate": "1",
        "nbRateUnits": "1",
        "rateUnits": "second",
        "randomFirst": "1",
        "randomLast": "5",
        "randomUnits": "seconds",
        "drop": false,
        "allowrate": false,
        "outputs": 1,
        "x": 90,
        "y": 1100,
        "wires": [
            [
                "812e5235b331e002"
            ]
        ]
    },
    {
        "id": "812e5235b331e002",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "13424c114a577170",
        "name": "Send status",
        "rules": [
            {
                "t": "set",
                "p": "message",
                "pt": "msg",
                "to": "Der blev ikke fundet nogle nye fakturaer ved seneste søgning!",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "type",
                "pt": "msg",
                "to": "alert",
                "tot": "str"
            },
            {
                "t": "set",
                "p": "title",
                "pt": "msg",
                "to": "Ingen nye fakturaer",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 120,
        "y": 1140,
        "wires": [
            [
                "d0ec6e3e02665e27"
            ]
        ]
    },
    {
        "id": "d0ec6e3e02665e27",
        "type": "link out",
        "z": "8ea344595d9a442a",
        "g": "13424c114a577170",
        "name": "link out 8",
        "mode": "link",
        "links": [
            "63ec872a76a39ffb"
        ],
        "x": 225,
        "y": 1140,
        "wires": []
    },
    {
        "id": "6cfa59d7c02c8c82",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "287b33b8879cbbbc",
        "name": "Find helbredstillægsprocent fra personlig tillægsprocent",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "$.payload ~> | $.faktura |\t(\t\t    $id := id;\t    /*$borger := $$.payload[faktura.id = $id];*/\t    $borger := $$.payload[$id in faktura.id];\t    $dato := dato;\t\t{\t\t    \"_helbredstillaegsprocent\": _helbredstillaegsprocent ~> $exists() ? _helbredstillaegsprocent :\t                                _personligtillaegsprocent ~> $exists() ?\t                                {\t                                    \"dato_fra\": _personligtillaegsprocent.dato_fra,\t                                    \"dato_til\": _personligtillaegsprocent.dato_til,\t                                    \"tillaegsprocent\": (_personligtillaegsprocent.tillaegsprocent * 0.85) ~> $floor()\t                                }\t                                : { \"tillaegsprocent\": 0 }\t\t})|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1435,
        "y": 1460,
        "wires": [
            [
                "05096968ae22cc6f"
            ]
        ],
        "l": false
    },
    {
        "id": "35e66215df68100f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "44e7408f9fee1e77",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "currentRun",
                "pt": "msg",
                "to": "(\t$lastRun :=     runHistory[$count(runHistory)-1]\t ~> $exists() ? runHistory[$count(runHistory)-1];\t\t/*$lastRunWasToday := $lastRun ~> $exists ? ( $fromMillis($millis(), '[M01]/[D01]/[Y0001]') = $fromMillis($lastRun.timestamp, '[M01]/[D01]/[Y0001]') ) : false;*/\t\trunHistory[isFinalized = false] ~> $exists() ?\t    runHistory[isFinalized = false]\t/*:\t$lastRunWasToday ?\t    $lastRun*/\t:\t{\t    \"startDate\": $lastRun ~> $exists() ?\t                    (($lastRun.endDate ~> $toMillis('[D01]/[M01]/[Y0001]')) + 86400000) ~> $fromMillis('[D01]/[M01]/[Y0001]')\t                        : \t                    presetStartDate,\t\t    \"endDate\": ($millis() - 86400000) ~> $fromMillis('[D01]/[M01]/[Y0001]'), /* 86400000 ms = 1 day */\t                    \t    \"timestamp\": $millis(),\t    \t    \"processedReceipts\": [],\t\t    \"allReceiptsProcessed\": false,\t    \"isFinalized\": false,\t\t    \"currentStep\": {},\t    \"stepHistory\": [],\t    \"userName\": \"\"\t}\t)",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1190,
        "y": 300,
        "wires": [
            [
                "0315b599de1a9914"
            ]
        ]
    },
    {
        "id": "d2046b01f19e1166",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "## ARCHIVING",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1530,
        "y": 2720,
        "wires": []
    },
    {
        "id": "e3a48c9fa5b8b4d4",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "FINALIZING UI",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1350,
        "y": 2220,
        "wires": []
    },
    {
        "id": "e1a765292dfcc859",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "g": "3fd0647603ec528e",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 620,
        "wires": [
            [
                "b5badb44837098f9"
            ]
        ]
    },
    {
        "id": "b5badb44837098f9",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "3fd0647603ec528e",
        "name": "set runHistory",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "{}",
                "tot": "json"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 140,
        "y": 620,
        "wires": [
            []
        ]
    },
    {
        "id": "72df366e32bdb61f",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "g": "3fd0647603ec528e",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 520,
        "wires": [
            [
                "e14341e7aef81e59"
            ]
        ]
    },
    {
        "id": "e14341e7aef81e59",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "3fd0647603ec528e",
        "name": "Reset ALL",
        "rules": [
            {
                "t": "delete",
                "p": "#:(storeInFile)::grants",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "#:(storeInFile)::rules",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "#:(storeInFile)::webSettings",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "webStates",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "webSteps",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "webData",
                "pt": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 130,
        "y": 520,
        "wires": [
            []
        ]
    },
    {
        "id": "c9559b185b3f221b",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "3fd0647603ec528e",
        "name": "RESET ALT",
        "info": "",
        "x": 130,
        "y": 480,
        "wires": []
    },
    {
        "id": "2d3128d22fb1c532",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "g": "3fd0647603ec528e",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 120,
        "y": 560,
        "wires": [
            [
                "40785040f06925f6"
            ]
        ]
    },
    {
        "id": "40785040f06925f6",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "3fd0647603ec528e",
        "name": "Reset webData",
        "rules": [
            {
                "t": "delete",
                "p": "webStates",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "webSteps",
                "pt": "global"
            },
            {
                "t": "delete",
                "p": "webData",
                "pt": "global"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.acceptances.login",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 140,
        "y": 560,
        "wires": [
            []
        ]
    },
    {
        "id": "058dd19a1031a295",
        "type": "comment",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "RESET robot ved fejl",
        "info": "",
        "x": 210,
        "y": 80,
        "wires": []
    },
    {
        "id": "ba775987982c42fc",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "GENOPTAG SENESTE KØRSEL",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 250,
        "y": 120,
        "wires": [
            [
                "53225eb49fe0ac22"
            ]
        ]
    },
    {
        "id": "53225eb49fe0ac22",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistoryBackup",
                "pt": "global",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.acceptances.login",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "delete",
                "p": "webData",
                "pt": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 475,
        "y": 120,
        "wires": [
            [
                "5f4c45329970fab2"
            ]
        ],
        "l": false
    },
    {
        "id": "5f4c45329970fab2",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "function 2",
        "func": "if(!Array.isArray(msg.runHistory))\n    msg.runHistory = [msg.runHistory];\n\nvar runHistory = msg.runHistory;\n\nrunHistory[runHistory.length - 1].isFinalized = false;\nrunHistory[runHistory.length - 1].allReceiptsProcessed = false;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 515,
        "y": 120,
        "wires": [
            [
                "1dce62fb28ae79dd"
            ]
        ],
        "l": false
    },
    {
        "id": "1dce62fb28ae79dd",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 555,
        "y": 120,
        "wires": [
            [
                "1ff45df4387920c6"
            ]
        ],
        "l": false
    },
    {
        "id": "1ff45df4387920c6",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "Robot RESET",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 595,
        "y": 120,
        "wires": [],
        "l": false
    },
    {
        "id": "aa3ea19c4462cb7e",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 780,
        "y": 60,
        "wires": [
            [
                "ce4f6a48e231c44c"
            ]
        ]
    },
    {
        "id": "ce4f6a48e231c44c",
        "type": "change",
        "z": "8ea344595d9a442a",
        "name": "Retrieve runHistory backup",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "#:(storeInFile)::runHistoryBackup",
                "tot": "global",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1020,
        "y": 60,
        "wires": [
            []
        ]
    },
    {
        "id": "8d14dd9c7f3d7896",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "AFSLUT SENESTE KØRSEL",
        "props": [],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "x": 240,
        "y": 160,
        "wires": [
            [
                "a89a3d18c7ac4270"
            ]
        ]
    },
    {
        "id": "a89a3d18c7ac4270",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistoryBackup",
                "pt": "global",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "runHistory",
                "pt": "msg",
                "to": "#:(storeInFile)::runHistory",
                "tot": "global",
                "dc": true
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.acceptances.login",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "delete",
                "p": "webData",
                "pt": "global"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 475,
        "y": 160,
        "wires": [
            [
                "fa1612c70b1b3ea7"
            ]
        ],
        "l": false
    },
    {
        "id": "fa1612c70b1b3ea7",
        "type": "function",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "function 3",
        "func": "if(!Array.isArray(msg.runHistory))\n    msg.runHistory = [msg.runHistory];\n\nvar runHistory = msg.runHistory;\n\nrunHistory[runHistory.length - 1].isFinalized = true;\nrunHistory[runHistory.length - 1].allReceiptsProcessed = true;\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 515,
        "y": 160,
        "wires": [
            [
                "c8ade2cefd45991f"
            ]
        ],
        "l": false
    },
    {
        "id": "c8ade2cefd45991f",
        "type": "change",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::runHistory",
                "pt": "global",
                "to": "runHistory",
                "tot": "msg",
                "dc": true
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 555,
        "y": 160,
        "wires": [
            [
                "84370f778b40a70d"
            ]
        ],
        "l": false
    },
    {
        "id": "84370f778b40a70d",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "g": "bb5f1c24606d30f1",
        "name": "Robot RESET",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 595,
        "y": 160,
        "wires": [],
        "l": false
    },
    {
        "id": "4f8ccb830206b86d",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "debug 1",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1780,
        "y": 340,
        "wires": []
    },
    {
        "id": "6dacc4751f492eab",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "debug 2",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1930,
        "y": 700,
        "wires": []
    },
    {
        "id": "98bc3b2a3f851a56",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "debug 3",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1590,
        "y": 760,
        "wires": []
    },
    {
        "id": "c4cfcf10fce7bd98",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "debug 4",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1580,
        "y": 1540,
        "wires": []
    },
    {
        "id": "97b819954a422102",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "debug 5",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1740,
        "y": 1960,
        "wires": []
    },
    {
        "id": "aa725c3f161f098b",
        "type": "inject",
        "z": "8ea344595d9a442a",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 500,
        "y": 3220,
        "wires": [
            [
                "894becc51e9c754e"
            ]
        ]
    },
    {
        "id": "894becc51e9c754e",
        "type": "function",
        "z": "8ea344595d9a442a",
        "name": "Puppeteer",
        "func": "//const puppeteer = require(\"puppeteer\");\n\nconst browser = await puppeteer.launch({\n    headless: false,\n    args: [\n        \"--disable-gpu\",\n        \"--disable-dev-shm-usage\",\n        \"--disable-setuid-sandbox\",\n        \"--no-sandbox\",\n    ]\n});\n\nconst page = await browser.newPage();\nawait page.goto(\"https://example.com\");\nconst ss = await page.screenshot({ path: \"/screenshot.png\" });\n\nawait page.close();\nawait browser.close();\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [
            {
                "var": "puppeteer",
                "module": "puppeteer"
            }
        ],
        "x": 830,
        "y": 3220,
        "wires": [
            [
                "c238dfe5c8048e1a"
            ]
        ]
    },
    {
        "id": "c238dfe5c8048e1a",
        "type": "debug",
        "z": "8ea344595d9a442a",
        "name": "Debug",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1020,
        "y": 3220,
        "wires": []
    },
    {
        "id": "248d64bf4e74f440",
        "type": "http in",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "url": "/worklet",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 100,
        "wires": [
            [
                "fc57c59e7b1b413d"
            ]
        ]
    },
    {
        "id": "a404b305e8f838e6",
        "type": "http in",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "url": "/:page",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 140,
        "wires": [
            [
                "4070528fbaa047ab"
            ]
        ]
    },
    {
        "id": "1d9fe0413cbb430d",
        "type": "http in",
        "z": "c28a486ea3e09387",
        "g": "0772648cf2b898d4",
        "name": "",
        "url": "/worklet/http",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 130,
        "y": 560,
        "wires": [
            [
                "8d172c16f57e9a2b"
            ]
        ]
    },
    {
        "id": "6e25160476593670",
        "type": "switch",
        "z": "c28a486ea3e09387",
        "g": "0772648cf2b898d4",
        "name": "",
        "property": "payload.requestType",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "getPageContent",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "acceptPage",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "startRun",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "archive",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "finalize",
                "vt": "str"
            }
        ],
        "checkall": "false",
        "repair": false,
        "outputs": 5,
        "x": 250,
        "y": 720,
        "wires": [
            [
                "59e078cd4489c0aa"
            ],
            [
                "415336a4f07090e6"
            ],
            [
                "40c9a409b68d13f1"
            ],
            [
                "6226138fabf9a3b8"
            ],
            [
                "f202f5cad72d049b"
            ]
        ]
    },
    {
        "id": "f6100bedf21eaf46",
        "type": "http response",
        "z": "c28a486ea3e09387",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1970,
        "y": 760,
        "wires": []
    },
    {
        "id": "fc57c59e7b1b413d",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "start",
                "tot": "str"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 100,
        "wires": [
            [
                "269002ef959b2b77"
            ]
        ]
    },
    {
        "id": "4070528fbaa047ab",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "req.params.page",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 360,
        "y": 140,
        "wires": [
            [
                "269002ef959b2b77"
            ]
        ]
    },
    {
        "id": "59e078cd4489c0aa",
        "type": "subflow:43652557380ac3f3",
        "z": "c28a486ea3e09387",
        "g": "dff24743df339ae5",
        "name": "",
        "x": 650,
        "y": 360,
        "wires": [
            [
                "62bdefaa23262980"
            ]
        ]
    },
    {
        "id": "edf7c7526a420888",
        "type": "debug",
        "z": "c28a486ea3e09387",
        "name": "POST OUTPUT",
        "active": false,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 1980,
        "y": 620,
        "wires": []
    },
    {
        "id": "62bdefaa23262980",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "dff24743df339ae5",
        "name": "Set response",
        "rules": [
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "{ \"url\": payload.page }",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.page.html",
                "pt": "msg",
                "to": "payload.bodyHTML",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.page.title",
                "pt": "msg",
                "to": "payload.pageTitle",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 360,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "abb73011a817205a",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set response",
        "rules": [
            {
                "t": "delete",
                "p": "payload.workletUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.workletPass",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 500,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "92fc21540237b9c7",
        "type": "switch",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "property": "payload.pageToAccept",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "login",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "rules",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "grants",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 3,
        "x": 670,
        "y": 580,
        "wires": [
            [
                "c6d6dc5b8ef2878b"
            ],
            [
                "801ba8048f457e32"
            ],
            [
                "118d9842141d09ca"
            ]
        ]
    },
    {
        "id": "e76b0758dc45914d",
        "type": "debug",
        "z": "c28a486ea3e09387",
        "g": "0772648cf2b898d4",
        "name": "POST INPUT",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "statusVal": "",
        "statusType": "auto",
        "x": 160,
        "y": 640,
        "wires": []
    },
    {
        "id": "b0adba24e19779d2",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "dff24743df339ae5",
        "name": "GetPageContent",
        "info": "",
        "x": 640,
        "y": 320,
        "wires": []
    },
    {
        "id": "984b68b697eb68be",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "AcceptPage",
        "info": "",
        "x": 630,
        "y": 480,
        "wires": []
    },
    {
        "id": "55d1d622afec35e2",
        "type": "http response",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1610,
        "y": 160,
        "wires": []
    },
    {
        "id": "98d7ea7aa5c93ad4",
        "type": "template",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "CSS",
        "field": "css",
        "fieldType": "msg",
        "format": "css",
        "syntax": "mustache",
        "template": "@import url(\"https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css\"); /* Bootstrap */\n@import url(\"https://cdn.jsdelivr.net/npm/bootswatch@4.5.2/dist/sandstone/bootstrap.min.css\"); /* Bootswatch template */\n@font-face {\n  font-family: 'password';\n  font-style: normal;\n  font-weight: 400;\n  src: url(https://jsbin-user-assets.s3.amazonaws.com/rafaelcastrocouto/password.ttf);\n}\n\na:hover\n{\n    cursor: pointer;\n}\n\n/* Changes to Boostrap CSS */\n.bg-primary {\n    background-color: #325d88!important;\n}\n.border-light\n{\n    border-color: lightgray!important;\n}\n.tab-content\n{\n    border: 1px solid lightgray;\n    border-bottom-left-radius: 5px;\n    border-bottom-right-radius: 5px;\n    border-top-right-radius: 5px;\n}\n.nav-link \n{\n    padding-left: 20px;\n    padding-right: 20px;\n}\n.row\n{\n    display: flex;\n    justify-content: stretch;\n}\n    .row > *\n    {\n        flex-grow: 1;\n    }\n.d-flex.justify-stretch\n{\n    justify-content: stretch;\n}\n.d-flex.justify-stretch > *{\n    flex-grow: 1;\n}\n.page-item.archived .page-link {\n    background-color: #E9F3DB!important;\n}\n.page-item.archived.active .page-link {\n    background-color: #D8E1CB!important;\n}\n\n\nbody\n{\n    background-color: whitesmoke;\n}\n\n\n\n/* Randers design */ \n.randers-logo {\n    background-image: url('https://www.randers.dk/static/logo.svg');\n    background-position: 5px 5px;\n    background-size: 85%;\n    background-repeat: no-repeat;\n    width: 200px;\n    height: 50px;\n}\n\n\n/* Custom style classes */\n.nav-success \n{\n    color: #71b355!important;\n}\n.nav-success:hover\n{\n    color: #a6d151!important;\n}\n.nav-success.active\n{\n    color: #a6d151!important;\n}\n.uppercase\n{\n    text-transform: uppercase;\n}\n.fs-10\n{\n    font-size: 10px;\n}\n.fs-11\n{\n    font-size: 11px;\n}\n.fs-12\n{\n    font-size: 12px;\n}\n.fs-13\n{\n    font-size: 13px;\n}\n.fs-lg\n{\n    font-size: 24px;\n}\n.fw-500\n{\n    font-weight: 500;\n}\n.border-none, .border-none *\n{\n    border: 0px!important;\n}\n.hidden\n{\n    display: none;\n}\n.no-border-bottom\n{\n    border-bottom: 0px!important;\n}\n.no-border-bottom *\n{\n    border-bottom: 0px!important;\n}\n\n/* Custom elements */\n.progress-container\n{\n    background-color: lightgray;\n    padding: 15px 25px;\n}\n.progress-container.collapsed\n{\n    max-height: 0px;\n    overflow: hidden;\n    padding: 0px;\n}\n/*\n.site-container\n{\n}\n*/\n.card-container\n{\n    display: flex;\n    justify-content: stretch;\n    gap: 10px;\n}\n    .card-container .card\n    {\n        flex: 1;\n    }\n.receipt-inner\n{\n    display: flex;\n    gap: 10px;\n    min-height: 40vh;\n}\n    .receipt-inner > *\n    {\n        flex-grow: 1;\n    }\n    .receipt-inner > .citizen-info\n    {\n        max-width: 25rem;\n    }\n.pagination-container\n{\n    display: flex;\n    justify-content: center;\n    gap: 10px;\n}\n    .pagination-container > button\n    {\n        height: 38px;\n    }\n.table-header\n{\n    font-size: 10px;\n    text-transform: uppercase;\n    font-weight: 500;\n}\n.card.header-left\n{\n    margin-left: 20px;display:flex;flex-direction:row;\n}\n.card-header.header-left\n{\n    border-top-right-radius: 0px!important;\n    border-bottom: 0px;\n}",
        "output": "str",
        "x": 1130,
        "y": 100,
        "wires": [
            [
                "29426a6eb03efe81"
            ]
        ]
    },
    {
        "id": "ac7bdd1609da7c77",
        "type": "template",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "JS",
        "field": "js",
        "fieldType": "msg",
        "format": "javascript",
        "syntax": "mustache",
        "template": "//\n/// INITIALIZE\n//\n\nvar rules = {{{payload.rulesStr}}};\n\n//\n/// SET PAGE CONTENT FUNCTION\n//\n\nvar activePage = \"{{payload.webSettings.state.activePage}}\";\n\nfunction goToPage(page)\n{\n    var pageName = \"\";\n    var paramName = \"\";\n    var paramValue = \"\";\n    // Works with 1 param only \n\n    if(page.includes(\"?\"))\n    {\n        var split = page.split(\"?\");\n        pageName = split[0];\n\n        split = split[1].split(\"=\");\n        paramName = split[0];\n        paramValue = split[1];\n    }\n\n    var obj = {};\n\n    if(pageName == \"\")\n        obj = {\"requestType\": \"getPageContent\", \"page\": page};\n\n    else\n    {\n        obj = { \"requestType\": \"getPageContent\", \"page\": pageName };\n        obj[paramName] = paramValue;\n    }\n\n    postRequest(obj);\n}\n\nfunction setPageContent(pageObj, setHistory = true)\n{\n    setInnerHTML(\"fullPage\", pageObj.html);\n    document.title = \"AutoWorkLet - \" + pageObj.title;\n\n    if(setHistory)\n        window.history.pushState({ \"page\": pageObj }, \"\", \"/\" + pageObj.url);\n\n    activePage = pageObj.url;\n\n    //console.log(\"Setting page content using JS\");\n\n    if (loadPageFunc[pageObj.url] != null)\n        loadPageFunc[pageObj.url]();\n\n}\n\nwindow.onpopstate = function (e)\n{\n    if (e.state)\n        setPageContent(e.state.page, false);\n};\n\n\n\n//\n/// NODE-RED INTEGRATION / COMMUNICATION\n//\n\nfunction toJSON(...vars)\n{\n    var obj = {};\n\n    for (let i = 0; i < vars.length; i++)\n        obj[vars[i].id] = vars[i].value;\n\n    return obj;\n}\n\nfunction postRequest(object)\n{\n    //console.log(\"HTTP request: \" + object);\n    fetch('/worklet/http', {\n        method: 'POST',\n        headers: {\n            'Accept': 'application/json',\n            'Content-Type': 'application/json'\n        },\n        body: JSON.stringify(object)\n    })\n        .then(response => response.json())\n        .then(response => handlePostResponse(response));\n        //.then(response => console.log(JSON.stringify(response)));\n}\n\n\nfunction handlePostResponse(responseObject)\n{\n    // Call function depending on request type\n\n    if (handleResponseDynamically[responseObject.requestType] != null)\n        handleResponseDynamically[responseObject.requestType](responseObject);\n        \n    return responseObject;\n}\n\nvar handleResponseDynamically = [];\n\n// Dynamic response handling\n\nhandleResponseDynamically['getPageContent'] = function(response)\n{\n    if(response.page != null)\n        setPageContent(response.page);\n}\n\nhandleResponseDynamically['acceptPage'] = function (response)\n{\n    if(activePage == \"rules\")\n        rules = response.rules;\n\n    reloadPage();\n}\n\nhandleResponseDynamically['startRun'] = function (response)\n{\n    //console.log(\"RESPONSE FROM STARTRUN\");\n    goToPage(\"start\");\n}\n\nhandleResponseDynamically['archive'] = function (response)\n{\n    //goToPage(response.page + \"?spec=\"+response.spec);\n    reloadPage();\n}\n\nhandleResponseDynamically['finalize'] = function (response)\n{\n    goToPage(\"finalized\");\n}\n\n\n//\n/// GENERIC FUNCTIONS\n//\n\nfunction setInnerHTML(objectId, content) {\n    var container = document.getElementById(objectId);\n    container.innerHTML = content;\n}\n\nfunction setStyle(objectId, styleVar, styleValue) {\n    var object = document.getElementById(objectId);\n    object.style[styleVar] = styleValue;\n}\n\nfunction toggleHide(objectId)\n{\n    var object = document.getElementById(objectId);\n    object.classList.toggle(\"hidden\");\n}\nfunction hide(objectId) {\n    var object = document.getElementById(objectId);\n    if(!object.classList.contains(\"hidden\"))\n        object.classList.add(\"hidden\");\n}\nfunction reloadPage()\n{\n    goToPage(activePage);\n}\nfunction roundNumber(num)\n{\n    return Math.round((num + Number.EPSILON) * 100) / 100;\n}\n\n//\n// START RUN\n//\n\nfunction startRun()\n{\n    /* Visual */\n\n    var startButton = document.getElementById(\"button_startRun\");\n\n    startButton.disabled = true;\n    startButton.innerHTML = `<i class=\"fa-lg fas fa-spinner fa-spin\"></i>`;\n\n    if (document.getElementById(\"nav_run\") !== null)\n        document.getElementById(\"nav_run\").innerHTML = `Robotten kører<i class=\"fa-lg fas fa-spinner fa-spin\" style=\"margin-left: 10px\"></i>`;\n\n    /* Node-red */\n    postRequest({\"requestType\": \"startRun\"});\n\n}\n\n\n// RULES\n\nfunction appendRules(...objects)\n{\n    var list = [];\n\n    for (let i = 0; i < objects.length; i++)\n        if(objects[i] != null)\n            list.push(objects[i]);\n\n    return list;\n}\n\nfunction createRuleObj(ruleVar)\n{\n    let ruleOperator = document.getElementById(\"operator_\" + ruleVar).value;\n    let ruleValue = document.getElementById(\"value_\" + ruleVar).value;\n    let returnObj = {\n        \"id\": ruleVar,\n        \"operator\": ruleOperator,\n        \"value\": ruleValue\n    }\n    //console.log(\"Return OBJ: \" + JSON.stringify(returnObj));\n    return returnObj;\n}\n\nfunction setInputBox(uid, truefalse = false)\n{\n    let operator = document.getElementById(\"operator_\" + uid).value;\n    let boxDisabled = document.getElementById(\"toAccept\").value !== \"true\";\n    var html = \"\";\n\n    if (operator == \"!null\" || truefalse)\n        html = `<select class=\"form-select\" id=\"value_` + uid + `\"` + (boxDisabled ? ` disabled` : ``) +`>\n                        <option value=\"true\">Ja</option>\n                        <option value=\"false\">Nej</option>\n                </select>\n                <label for=\"value_`+ uid + `\" style=\"padding-left: 27px\">Værdi</label>`;\n    else\n        html = `<input type=\"text\" class=\"form-control\" id=\"value_` + uid + `\" placeholder=\"0\" style=\"color: black\"`+(boxDisabled?` disabled`:``)+`>\n                <label for=\"value_`+ uid + `\" style=\"padding-left: 27px\">Værdi</label>`;\n\n    setInnerHTML(\"inputContainer_\" + uid, html);\n}\n\n// Grants\n\nfunction createGrantObj(grantId)\n{\n\n    let grantDkk = document.getElementById(\"value_\" + grantId + \"_maxdkk\").value;\n    let grantProcent = document.getElementById(\"value_\" + grantId + \"_procent\").value;\n\n    return {\n        \"id\": grantId,\n        \"tilskud_maxdkk\": grantDkk,\n        \"tilskud_procent\": grantProcent\n    }\n}\n\n\n\n//\n/// LATE START / INITIALIZATION\n//\n\nvar landingPage = \"{{{payload.page}}}\";\n\n\n//\n/// ON PAGE LOAD FUNCTIONS\n//\n\nvar loadPageFunc = [];\n\nloadPageFunc[\"rules\"] = function ()\n{\n    //console.log(\"Running load func\");\n    // LOAD rules - update each rule\n    for (let index = 0; index < rules.length; index++)\n    {\n        const element = rules[index];\n\n        //console.log(\"Attempting to update value for '\" + \"operator_\" + element.uid + \"'\");\n\n        var operatorInput = document.getElementById(\"operator_\" + element.uid);\n        //var valueInput = document.getElementById(\"value_\" + element.uid);\n\n        if (element.operator == \"!null\")\n        {\n            setInputBox(element.uid, true);\n            var valueInput = document.getElementById(\"value_\" + element.uid);\n            valueInput.value = element.value;\n        }\n\n        operatorInput.value = element.operator;\n        //valueInput.value = element.value;\n    }\n}\n\nif (loadPageFunc[landingPage] != null)\n    loadPageFunc[landingPage]();\n\n\n\n//\n/// WEB SOCKET (node-red)\n//\n\nvar ws;\nvar wsUri = \"ws:\";\nvar loc = window.location; //console.log(loc);\n\nif (loc.protocol === \"https:\") { wsUri = \"wss:\"; }\n// This needs to point to the web socket in the Node-RED flow\nwsUri += \"//\" + loc.host + \"/ws/worklet\";\n\nfunction wsConnect()\n{\n    //console.log(\"Connecting to \", wsUri);\n    ws = new WebSocket(wsUri);\n    //var line = \"\";    // either uncomment this for a building list of messages\n    ws.onmessage = function (msg)\n    {\n\n        var data = msg.data;\n        const obj = JSON.parse(data);\n        //const obj = data;\n        \n        displayWsMessage(obj);\n        //console.log(\"Received WS message: \" + JSON.stringify(obj));\n        \n    }\n    ws.onopen = function () {\n        // update the status div with the connection status\n        console.log(\"Connected to WS\");\n    }\n    ws.onclose = function () {\n        // update the status div with the connection status\n        console.log(\"WS connection lost\");\n        // in case of lost connection tries to reconnect every 3 secs\n        setTimeout(wsConnect, 3000);\n    }\n}\nfunction PublishWsMessage(m)\n{\n    if (ws) { ws.send(m); }\n}\n\nwsConnect();\n\n\nfunction displayWsMessage(ws)\n{\n    //console.log(\"Displaying ws object: \" + ws);\n    //console.log(\"Displaying ws object (stringify): \" + JSON.stringify(ws));\n\n    if(ws.type == \"alert\")\n    {\n        var obj = document.getElementById(\"alertBox\");\n\n        if (obj == null) {\n            var html = `\n            <div class=\"alert alert-dismissible alert-warning\" id=\"alertBox\">\n                <button type=\"button\" class=\"btn-close\" data-bs-dismiss=\"alert\"></button>\n                <h4 class=\"alert-heading\" id=\"alertBox-heading\">` + ws.title + `</h4>\n                <p class=\"mb-0\" id=\"alertBox-body\">` + ws.msg + `</p>\n            </div>`;\n            document.getElementById(\"alertParent\").innerHTML = html;\n            return;\n        }\n\n        obj.classList.add(\"alert-warning\");\n        obj.classList.remove(\"hidden\");\n\n        document.getElementById(\"alertBox-heading\").innerHTML = ws.title;\n        document.getElementById(\"alertBox-body\").innerHTML = ws.message;\n    }\n\n    else if(ws.type == \"update\")\n    {\n        var obj = document.getElementById(\"statusText\");\n\n        if(obj != null)\n        {\n            obj.classList.remove(\"hidden\");\n            obj.innerHTML = \"Status: \" + ws.message;\n        }\n\n    }\n\n}",
        "output": "str",
        "x": 990,
        "y": 100,
        "wires": [
            [
                "98d7ea7aa5c93ad4"
            ]
        ]
    },
    {
        "id": "ddd0873c9d611a5e",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "HTML",
        "rules": [
            {
                "t": "set",
                "p": "payload",
                "pt": "msg",
                "to": "payload.pageHTML",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1370,
        "y": 160,
        "wires": [
            [
                "55d1d622afec35e2"
            ]
        ]
    },
    {
        "id": "29426a6eb03efe81",
        "type": "subflow:43652557380ac3f3",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "x": 1130,
        "y": 160,
        "wires": [
            [
                "ddd0873c9d611a5e"
            ]
        ]
    },
    {
        "id": "a71320aa58eef18a",
        "type": "subflow:db94b4c117de2f6a",
        "z": "c28a486ea3e09387",
        "g": "0d6121cfccf91882",
        "name": "",
        "x": 770,
        "y": 100,
        "wires": [
            [
                "ac7bdd1609da7c77"
            ]
        ]
    },
    {
        "id": "e08bf0d9ec73f87e",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "UpdateRules",
        "info": "",
        "x": 930,
        "y": 680,
        "wires": []
    },
    {
        "id": "77e8a8e7f5259bfb",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Merge changes",
        "rules": [
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "$.payload.rules ~> | $ |\t(\t\t\t$ruleChange := $$.ruleUpdates[id = uid];\t/*$lookup($$.ruleChanges, uid);*/\t\t$uid := uid;\t$ruleUpdate :=  $$.payload.ruleUpdates[id = $uid];\t\t{        \t        \"operator\": $ruleUpdate.operator,\t        \"value\": $ruleUpdate.value\t})\t\t|",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "payload.rules @$r .(\t\t$getType := function($value, $operator)\t{\t    ($value[$ ~> /^[0-9\\.]{1,}$/m] ~> $boolean) ?\t        \"number\" :\t    ($operator = \"!null\") ? \t        \"bool\"\t};\t\t{\t    \t    \"uid\": $r.uid,\t    \"name\": $r.name,\t    \"variable\": $r.variable,\t    \"operator\": $r.operator,\t    \"value\": $r.value,\t    \"type\": $getType($r.value, $r.operator),\t    \"description\": $r.description\t    \t}\t)",
                "tot": "jsonata"
            },
            {
                "t": "set",
                "p": "payload.rules",
                "pt": "msg",
                "to": "$.payload.rules ~> | $ |\t{\t    \"value\": \t        type = \"number\" ?\t            value ~> $number() \t            :\t        type = \"bool\" ?\t            (value = \"true\") or (value = true) ? true : false\t}\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1120,
        "y": 700,
        "wires": [
            [
                "1c365f175b48167a"
            ]
        ]
    },
    {
        "id": "1c365f175b48167a",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::rules",
                "pt": "global",
                "to": "payload.rules",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1340,
        "y": 700,
        "wires": [
            [
                "53dbe0297b8bd16d"
            ]
        ]
    },
    {
        "id": "53dbe0297b8bd16d",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set response",
        "rules": [
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "payload.pageToAccept",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload.ruleChanges",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.toAccept",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.pageToAccept",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 640,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "8d172c16f57e9a2b",
        "type": "subflow:db94b4c117de2f6a",
        "z": "c28a486ea3e09387",
        "g": "0772648cf2b898d4",
        "name": "",
        "x": 170,
        "y": 600,
        "wires": [
            [
                "6e25160476593670",
                "e76b0758dc45914d"
            ]
        ]
    },
    {
        "id": "c6d6dc5b8ef2878b",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set login to accepted",
        "rules": [
            {
                "t": "set",
                "p": "webSettings.acceptances.login",
                "pt": "global",
                "to": "payload.toAccept",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.login",
                "pt": "msg",
                "to": "payload.toAccept",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "webData.workletCreds.workletUser",
                "pt": "global",
                "to": "payload.workletUser",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "webData.workletCreds.workletPass",
                "pt": "global",
                "to": "payload.workletPass",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "webData.dqCreds.dqUser",
                "pt": "global",
                "to": "payload.dqUser",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "set",
                "p": "webData.dqCreds.dqPass",
                "pt": "global",
                "to": "payload.dqUser",
                "tot": "msg",
                "dc": true
            },
            {
                "t": "delete",
                "p": "payload.workletUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.workletPass",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.dqUser",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.dqPass",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 880,
        "y": 500,
        "wires": [
            [
                "abb73011a817205a"
            ]
        ]
    },
    {
        "id": "801ba8048f457e32",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set rules to accepted",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.acceptances.rules",
                "pt": "global",
                "to": "payload.toAccept",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.rules",
                "pt": "msg",
                "to": "payload.toAccept",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 880,
        "y": 600,
        "wires": [
            [
                "ec82ecfe41364ced"
            ]
        ]
    },
    {
        "id": "ec82ecfe41364ced",
        "type": "switch",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "property": "payload.toAccept",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 930,
        "y": 640,
        "wires": [
            [
                "53dbe0297b8bd16d"
            ],
            [
                "77e8a8e7f5259bfb"
            ]
        ]
    },
    {
        "id": "d4cb17c655b74747",
        "type": "change",
        "z": "c28a486ea3e09387",
        "name": "Clean response object",
        "rules": [
            {
                "t": "delete",
                "p": "payload.pageContent",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.webSettingsStr",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.pageHTML",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.pageTitle",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.pageElements",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1980,
        "y": 720,
        "wires": [
            [
                "f6100bedf21eaf46",
                "edf7c7526a420888"
            ]
        ]
    },
    {
        "id": "415336a4f07090e6",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.toAccept",
                "pt": "msg",
                "to": "(payload.toAccept = \"true\") or (payload.toAccept= true) ? true : false",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 590,
        "y": 520,
        "wires": [
            [
                "92fc21540237b9c7"
            ]
        ]
    },
    {
        "id": "69ef811ebe7083c9",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "UpdateGrants",
        "info": "",
        "x": 930,
        "y": 860,
        "wires": []
    },
    {
        "id": "492252a377f8d60d",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Merge changes",
        "rules": [
            {
                "t": "set",
                "p": "payload.grants.tilskudsperioder.satser",
                "pt": "msg",
                "to": "$.payload.grants.tilskudsperioder.satser ~> | $ |\t(\t\t$uid := id;\t{        \t    \"tilskud_maxdkk\": $$.payload.grantUpdates[$uid].tilskud_maxdkk ~>$number(),\t    \"tilskud_procent\": $$.payload.grantUpdates[$uid].tilskud_procent ~>$number()\t})\t\t|",
                "tot": "jsonata"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1120,
        "y": 880,
        "wires": [
            [
                "d046f8cb32a0960c"
            ]
        ]
    },
    {
        "id": "d046f8cb32a0960c",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::grants",
                "pt": "global",
                "to": "payload.grants",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1340,
        "y": 880,
        "wires": [
            [
                "6154c5e7bbc8bc1a"
            ]
        ]
    },
    {
        "id": "6154c5e7bbc8bc1a",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set response",
        "rules": [
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "payload.pageToAccept",
                "tot": "msg"
            },
            {
                "t": "delete",
                "p": "payload.grantChanges",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.toAccept",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.pageToAccept",
                "pt": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1590,
        "y": 820,
        "wires": [
            [
                "e7b83f0e755d4fdf"
            ]
        ]
    },
    {
        "id": "118d9842141d09ca",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Set grants to accepted",
        "rules": [
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.acceptances.grants",
                "pt": "global",
                "to": "payload.toAccept",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "payload.webSettings.acceptances.grants",
                "pt": "msg",
                "to": "payload.toAccept",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 880,
        "y": 780,
        "wires": [
            [
                "f6abba6df8ed7611"
            ]
        ]
    },
    {
        "id": "f6abba6df8ed7611",
        "type": "switch",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "",
        "property": "payload.toAccept",
        "propertyType": "msg",
        "rules": [
            {
                "t": "false"
            },
            {
                "t": "true"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 930,
        "y": 820,
        "wires": [
            [
                "6154c5e7bbc8bc1a"
            ],
            [
                "492252a377f8d60d"
            ]
        ]
    },
    {
        "id": "4c1121ef6377b795",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Grants",
        "info": "",
        "x": 830,
        "y": 740,
        "wires": []
    },
    {
        "id": "6ebfb594e20f3f75",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Rules",
        "info": "",
        "x": 830,
        "y": 560,
        "wires": []
    },
    {
        "id": "412dc2399a0183b9",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "31b5ea0c53a9c4fb",
        "name": "Login",
        "info": "",
        "x": 830,
        "y": 460,
        "wires": []
    },
    {
        "id": "e33624721d9829f0",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "StartRun",
        "info": "",
        "x": 580,
        "y": 980,
        "wires": []
    },
    {
        "id": "40c9a409b68d13f1",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "Set isRunning = true",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings.state.isRunning",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.isRunning",
                "pt": "global",
                "to": "payload.webSettings.state.isRunning",
                "tot": "msg"
            },
            {
                "t": "set",
                "p": "webData.startedRunThisInstance",
                "pt": "global",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 620,
        "y": 1020,
        "wires": [
            [
                "e53f459d609aac22"
            ]
        ]
    },
    {
        "id": "164122de385f07b8",
        "type": "change",
        "z": "c28a486ea3e09387",
        "d": true,
        "g": "0e177132df886f4e",
        "name": "Set response",
        "rules": [
            {
                "t": "delete",
                "p": "tempPayload",
                "pt": "flow"
            },
            {
                "t": "delete",
                "p": "tempErrors",
                "pt": "flow"
            },
            {
                "t": "delete",
                "p": "tempPayload",
                "pt": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1430,
        "y": 1100,
        "wires": [
            []
        ]
    },
    {
        "id": "5c74b689e0aee38b",
        "type": "link in",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "START response in",
        "links": [
            "f5dbef72792b9011",
            "42e8d0e6b5e55314",
            "08f36899ebeff27b"
        ],
        "x": 1025,
        "y": 1060,
        "wires": [
            [
                "0a97b8da0c9ceff9"
            ]
        ]
    },
    {
        "id": "30b5b930fae41995",
        "type": "link out",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "Link to START",
        "mode": "link",
        "links": [
            "603f9dfeda911a10"
        ],
        "x": 895,
        "y": 1060,
        "wires": []
    },
    {
        "id": "e53f459d609aac22",
        "type": "function",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "Set flow temp MSG object",
        "func": "flow.set(\"tempMsg\", msg);\nflow.set(\"tempPayload\", msg.payload);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 1060,
        "wires": [
            [
                "30b5b930fae41995"
            ]
        ]
    },
    {
        "id": "408b2b0cf0a40d41",
        "type": "function",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "Get flow temp MSG object",
        "func": "msg = flow.get(\"tempMsg\");\nmsg.payload = flow.get(\"tempPayload\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1370,
        "y": 1060,
        "wires": [
            [
                "164122de385f07b8",
                "ea3be6d83c70d734"
            ]
        ]
    },
    {
        "id": "0a97b8da0c9ceff9",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "set receipts and isRunning",
        "rules": [
            {
                "t": "set",
                "p": "webData.citizens-actions",
                "pt": "global",
                "to": "payload",
                "tot": "jsonata",
                "dc": true
            },
            {
                "t": "set",
                "p": "webData.citizens-noactions",
                "pt": "global",
                "to": "errors",
                "tot": "jsonata",
                "dc": true
            },
            {
                "t": "delete",
                "p": "errors",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "#:(storeInFile)::webSettings.state.isRunning",
                "pt": "global",
                "to": "false",
                "tot": "bool"
            },
            {
                "t": "set",
                "p": "webSettings.state.isBeingProcessed",
                "pt": "msg",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1240,
        "y": 1020,
        "wires": [
            [
                "408b2b0cf0a40d41"
            ]
        ]
    },
    {
        "id": "ea3be6d83c70d734",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "0e177132df886f4e",
        "name": "",
        "rules": [
            {
                "t": "set",
                "p": "payload.webSettings",
                "pt": "msg",
                "to": "#:(storeInFile)::webSettings",
                "tot": "global",
                "dc": true
            },
            {
                "t": "delete",
                "p": "tempMsg",
                "pt": "flow"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1535,
        "y": 1060,
        "wires": [
            [
                "97801c386c197805"
            ]
        ],
        "l": false
    },
    {
        "id": "f8bf41fc7dd480f1",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "Archive receipt",
        "info": "",
        "x": 600,
        "y": 1200,
        "wires": []
    },
    {
        "id": "c888f934919b1eb8",
        "type": "change",
        "z": "c28a486ea3e09387",
        "d": true,
        "g": "e4e7a254403521e9",
        "name": "set as archived",
        "rules": [
            {
                "t": "set",
                "p": "webData.citizens-noactions[msg.payload.id].archived",
                "pt": "global",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1240,
        "wires": [
            [
                "d84057a8cb05b22f"
            ]
        ]
    },
    {
        "id": "d84057a8cb05b22f",
        "type": "link out",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "Archive receipt link out",
        "mode": "link",
        "links": [
            "230dad52a43f6b19"
        ],
        "x": 895,
        "y": 1240,
        "wires": []
    },
    {
        "id": "0ff5c26114374820",
        "type": "link in",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "Is archived link in",
        "links": [
            "a2f55ae008b1fee2"
        ],
        "x": 1025,
        "y": 1240,
        "wires": [
            [
                "d6432bd8a487caa0",
                "948eb590f69bd85b"
            ]
        ]
    },
    {
        "id": "d6432bd8a487caa0",
        "type": "function",
        "z": "c28a486ea3e09387",
        "d": true,
        "g": "e4e7a254403521e9",
        "name": "Next receipt id?",
        "func": "msg.payload.tempDataLength = msg.tempDataArray.length;\n\nmsg.payload.spec = parseInt(msg.payload.id) >= (msg.tempDataArray.length - 1) ? parseInt(msg.payload.id) : (parseInt(msg.payload.id)+1);\n\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1280,
        "y": 1200,
        "wires": [
            [
                "948eb590f69bd85b"
            ]
        ]
    },
    {
        "id": "948eb590f69bd85b",
        "type": "change",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "Set response",
        "rules": [
            {
                "t": "delete",
                "p": "payload.tempDataArray",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.tempData",
                "pt": "msg"
            },
            {
                "t": "delete",
                "p": "payload.tempDataLength",
                "pt": "msg"
            },
            {
                "t": "set",
                "p": "payload.page",
                "pt": "msg",
                "to": "payload.webSettings.state.activePage",
                "tot": "msg"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 1570,
        "y": 1240,
        "wires": [
            [
                "b3ecd3ad79094172"
            ]
        ]
    },
    {
        "id": "54254a91e943fb50",
        "type": "change",
        "z": "c28a486ea3e09387",
        "d": true,
        "g": "e4e7a254403521e9",
        "name": "set as archived",
        "rules": [
            {
                "t": "set",
                "p": "webData.citizens-actions[msg.payload.id].archived",
                "pt": "global",
                "to": "true",
                "tot": "bool"
            }
        ],
        "action": "",
        "property": "",
        "from": "",
        "to": "",
        "reg": false,
        "x": 780,
        "y": 1200,
        "wires": [
            [
                "d84057a8cb05b22f"
            ]
        ]
    },
    {
        "id": "6226138fabf9a3b8",
        "type": "switch",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "",
        "property": "payload.webSettings.state.activePage",
        "propertyType": "msg",
        "rules": [
            {
                "t": "eq",
                "v": "view-receipts",
                "vt": "str"
            },
            {
                "t": "eq",
                "v": "view-nograntreceipts",
                "vt": "str"
            }
        ],
        "checkall": "true",
        "repair": false,
        "outputs": 2,
        "x": 570,
        "y": 1240,
        "wires": [
            [
                "54254a91e943fb50",
                "419b7ad31525a3a3"
            ],
            [
                "c888f934919b1eb8",
                "f23aa08410fc8960"
            ]
        ]
    },
    {
        "id": "cd5218111a9658fb",
        "type": "function",
        "z": "c28a486ea3e09387",
        "name": "Get flow temp MSG object",
        "func": "msg = flow.get(\"tempMsg\");\nmsg.payload = flow.get(\"tempPayload\");\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1910,
        "y": 1060,
        "wires": [
            []
        ]
    },
    {
        "id": "0edb5029cfe338ce",
        "type": "comment",
        "z": "c28a486ea3e09387",
        "name": "Finalize run",
        "info": "",
        "x": 590,
        "y": 1340,
        "wires": []
    },
    {
        "id": "f202f5cad72d049b",
        "type": "link out",
        "z": "c28a486ea3e09387",
        "name": "Finalize run out",
        "mode": "link",
        "links": [
            "c04211aaccb15e0a"
        ],
        "x": 535,
        "y": 1380,
        "wires": []
    },
    {
        "id": "23a573cb9952c0ef",
        "type": "link in",
        "z": "c28a486ea3e09387",
        "name": "Finalize complete link in",
        "links": [
            "25f140a78f720950"
        ],
        "x": 705,
        "y": 1380,
        "wires": [
            [
                "53d1fb714bf85e85"
            ]
        ]
    },
    {
        "id": "419b7ad31525a3a3",
        "type": "function",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "set as archived",
        "func": "var webData = global.get(\"webData\");\nif (!Array.isArray(webData[\"citizens-actions\"]))\n    webData[\"citizens-actions\"] = [webData[\"citizens-actions\"]];\n\n(webData[\"citizens-actions\"])[msg.payload.id].archived = true;\nglobal.set(\"webData\", webData);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 1200,
        "wires": [
            [
                "d84057a8cb05b22f"
            ]
        ]
    },
    {
        "id": "f23aa08410fc8960",
        "type": "function",
        "z": "c28a486ea3e09387",
        "g": "e4e7a254403521e9",
        "name": "set as archived",
        "func": "var webData = global.get(\"webData\");\nif (!Array.isArray(webData[\"citizens-noactions\"]))\n    webData[\"citizens-noactions\"] = [webData[\"citizens-noactions\"]];\n\n(webData[\"citizens-noactions\"])[msg.payload.id].archived = true;\nglobal.set(\"webData\", webData);\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 1240,
        "wires": [
            [
                "d84057a8cb05b22f"
            ]
        ]
    }
]